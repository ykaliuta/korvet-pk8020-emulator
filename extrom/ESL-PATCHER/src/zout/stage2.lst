   1:				;**********************************************************************************************
   2:				;*  Загрузчик 2 фазы дискового эмулятора Korvet-Extrom
   3:				;*  Работает только в паре с контроллером Extrom через боковой разъем корвета
   4:				;*
   5:				;*  Загружает в память системные дорожки диска А и передает управление на код инициализации BIOS
   6:				;*   Сборка с помощью кросс-ассемблера z80asm, контрольная сумма рассчитывается утилитой ercs
   7:				;*
   8:				;*   Программа записывается на карту SD контроллера в файл LOADER.BIN
   9:				;**********************************************************************************************
  10:     -	2000          	BASE	EQU	2000H		; База для размещения этого кода
  11:     -	FB08          	PORTA	EQU     0FB08H		; Порт A ВВ55 #3
  12:     -	FB0A          	PORTC	EQU     0FB0AH		; Порт C ВВ55 #3
  13:     -	FC00          	TRAM	EQU	0FC00H		; Начало видеопамяти
  14:				
  15:     -	FA7F          	SYSREG14  EQU	0FA7FH		; регистр карты памяти
  16:     -	FF7F          	SYSREG5C  EQU	0FF7FH		; регистр карты памяти
  17:				; SYSREG6C  EQU	0BF7FH
  18:     -	FF7F          	SYSREG3C  EQU	0FF7FH
  19:				
  20:     -	004C          	PCHDRV	EQU	4Ch		; подпрограмма печати байта через драйвер консоли ОПТС
  21:     -	0049          	CONIN	EQU	49h		; подпрограмма ввода символа через драйвер консоли ОПТС
  22:				
  23:				
  24:				; started in config 14
  25:				; 	14  NDOS   0-1FFF  2000-F7FF                   F800  FA00  FC00  FB00
  26:				
  27:     -	2000          		ORG   	BASE
  28:				
  29:				; Стандартный заголовок внешнего ПЗУ корвета
  30:    0+10	2000  C30820  		JP	START	        ; +0
  31:     -	2003  00      		DB      0		; +3
  32:     -	2004  0820    		DW	START           ; +4 - адрес запуска 
  33:     -	2006  20      		DB	BASE>>8         ; +6 - старшие 8 бит адреса загрузки (младшие всегда 00)
  34:     -	2007  20      		DB	(FTOP-BASE)>>8  ; +7 - количество загружаемых 256-байтовых блоков
  35:				
  36:				
  37:				; Далее идет непосредственный программный код	
  38:     -	2008          	START:
  39:   10+4	2008  F3      		DI
  40:   14+10	2009  3100F7  		LD	SP,0F700h	; рабочий стек, размещаем в области F-макросов драйвера клавиатуры
  41:				
  42:   24+17	200C  CD1A22  		call 	initLUT
  43:				
  44:				; Печать промпта 	
  45:   41+10	200F  21EE22  		LD	HL,HMSG
  46:   51+17	2012  CDC222  		CALL	PSTR
  47:				
  48:   68+17	2015  CDAC24  		call 	hw_test
  49:				; 	halt
  50:				
  51:				
  52:   85+4	2018  AF      		xor 	a
  53:   89+13	2019  32B925  		ld 	(flag_microdos),a
  54:				
  55:  102+13	201C  3A80F8  		ld 	a,(0xf880)
  56:  115+7	201F  E621    		and 	0x21 		;ctrl+shift
  57:  122+7	2021  FE21    		cp 	0x21
  58:				
  59:  129+10	2023  CA2A20  		jp 	z,force_default_bios
  60:  139+4	2026  AF      		xor 	a		;turn off system substitution
  61:  143+10	2027  C38620  		jp 	restart_disable
  62:				
  63:     -	202A          	force_default_bios:
  64:  153+10	202A  21A323  		ld 	hl,msgFORCEDDEFAULTBIOS
  65:  163+17	202D  CDC222  		call 	PSTR
  66:				; 	jp 	set_subst
  67:				
  68:     -	2030          	force_subst:
  69:				; 	ld 	hl,msgFORCEDDEFAULTBIOS
  70:				; 	call 	PSTR
  71:				
  72:  180+10	2030  216F23  		ld 	hl,msgSUBST
  73:  190+17	2033  CDC222  		call 	PSTR
  74:				
  75:  207+13	2036  3AB925  		ld 	a,(flag_microdos)
  76:				
  77:  220+10	2039  216623  		ld 	hl,msgMICRODOS
  78:  230+7	203C  FE01    		cp 	1
  79:  237+10	203E  CA4420  		jp 	z,.print
  80:  247+10	2041  216123  		ld 	hl,msgCPM
  81:     -	2044          	.print:
  82:  257+17	2044  CDC222  		call 	PSTR
  83:				
  84:  274+10	2047  217D23  		ld 	hl,msgASK_SUBST
  85:  284+17	204A  CDC222  		call 	PSTR
  86:				
  87:     -	204D          	WaitKey:
  88:  301+7	204D  3E07    		ld 	a,7
  89:  308+17	204F  CDCC22  		call 	PUTCH
  90:  325+17	2052  CDD722  		call 	GETCH
  91:  342+7	2055  E65F    		and 	0x5F
  92:				
  93:  349+7	2057  FE0D    		cp 	0x0d 	;CR
  94:  356+10	2059  C25E20  		jp 	nz,.printKEY
  95:				
  96:  366+7	205C  3E59    		ld 	a,'Y'
  97:				
  98:     -	205E          	.printKEY:
  99:  373+13	205E  326023  		ld 	(tmpKEY),a
 100:				
 101:  386+7	2061  FE59    		cp 	'Y'
 102:  393+10	2063  CA8220  		jp 	z,set_subst
 103:  403+7	2066  FE44    		cp 	'D'
 104:  410+10	2068  CA8220  		jp 	z,set_subst
 105:				
 106:  420+7	206B  FE43    		cp 	a,'C'
 107:  427+10	206D  C27820  		jp 	nz,.chkM
 108:				
 109:  437+7	2070  3E00    		ld 	a,0
 110:  444+13	2072  32B925  		ld 	(flag_microdos),a
 111:  457+10	2075  C38220  		jp 	set_subst
 112:     -	2078          	.chkM:
 113:  467+7	2078  FE4D    		cp 	'M'
 114:  474+10	207A  C24D20  		jp 	nz,WaitKey
 115:  484+7	207D  3E01    		ld 	a,1	
 116:  491+13	207F  32B925  		ld 	(flag_microdos),a
 117:				
 118:				
 119:     -	2082          	set_subst:
 120:  504+13	2082  3AB925  		ld 	a,(flag_microdos)
 121:  517+4	2085  3C      		inc 	a
 122:				
 123:     -	2086          	restart_disable:
 124:  521+13	2086  32E522  		ld 	(TRK),A
 125:  534+7	2089  3EA0    		ld 	a,0xA0 		;system substitution
 126:  541+13	208B  32E322  		ld 	(CMD),a
 127:  554+4	208E  AF      		xor 	a
 128:  558+13	208F  32E422  		ld 	(DRV),a
 129:  571+17	2092  CD8722  		call 	SENDCMD
 130:				
 131:  588+13	2095  3A6023  		ld 	a,(tmpKEY)
 132:  601+4	2098  B7      		or 	a
 133:  605+10	2099  CAA520  		jp 	z,.noPrintKey
 134:  615+17	209C  CDCC22  		call 	PUTCH
 135:  632+10	209F  215C23  		ld 	hl,HCRLF
 136:  642+17	20A2  CDC222  		call	PSTR 	
 137:				
 138:     -	20A5          	.noPrintKey:
 139:				
 140:				
 141:  659+7	20A5  3E00    		ld 	a,0
 142:  666+13	20A7  32B825  		ld 	(flag_unsupported),a
 143:  679+13	20AA  32B925  		ld 	(flag_microdos),a
 144:  692+10	20AD  210000  		ld 	hl,0
 145:  702+16	20B0  22BB25  		ld 	(msg_warning),hl
 146:				
 147:  718+4	20B3  F3      		DI
 148:  722+10	20B4  3100F7  		LD	SP,0F700h	; рабочий стек, размещаем в области F-макросов драйвера клавиатуры
 149:				
 150:				
 151:				; Загрузка инфосектора
 152:				
 153:  732+7	20B7  3E01    		ld 	a,0x1 		;read
 154:  739+13	20B9  32E322  		ld 	(CMD),a
 155:  752+4	20BC  AF      		xor 	a
 156:  756+13	20BD  32E522  		ld 	(TRK),A
 157:  769+13	20C0  32E622  		ld 	(SEC),A
 158:				
 159:				
 160:  782+17	20C3  CD8722  		CALL	SENDCMD		; отсылаем команду загрузки сектора, параметры уже прописаны в командном блоке
 161:  799+10	20C6  210040  		LD	HL,SECBUF
 162:  809+17	20C9  CDA722  		CALL	GETSEC		; забираем 256 байт сектора 0
 163:				
 164:				; Разбор инфосектора
 165:				;
 166:				; Вынимаем идущие подряд переменные LOADR, RUNADR, COUNT
 167:				;
 168:				
 169:				;TODO: add crc check!!!!!!!!!!!!!!!
 170:				
 171:  826+10	20CC  210040  		LD	HL,SECBUF
 172:  836+10	20CF  11E722  		LD	DE,LOADR	; начало блока переменных в памяти
 173:  846+7	20D2  0E05    		LD	C,5		; всего 5 байтов
 174:     -	20D4          	IL:
 175:  853+7	20D4  7E      		LD	A,(HL)		; копируем блок переменных
 176:  860+7	20D5  12      		LD	(DE),A
 177:  867+6	20D6  23      		INC	HL
 178:  873+6	20D7  13      		INC	DE
 179:  879+4	20D8  0D      		DEC	C
 180:  883+10	20D9  C2D420  		JP	NZ,IL
 181:				
 182:				; Получаем индекс размера сектора
 183:  893+10	20DC  210A40  		LD	HL,SECBUF+10	;  +10 - коэффициент блокирования секторов
 184:  903+7	20DF  7E      		LD	A,(HL)
 185:  910+7	20E0  12      		LD	(DE),A
 186:  917+6	20E1  13      		INC	DE
 187:  923+10	20E2  211040  		LD	HL,SECBUF+16	;  +16 - LSPT
 188:  933+7	20E5  7E      		LD	A,(HL)
 189:  940+7	20E6  12      		LD	(DE),A
 190:				
 191:  947+17	20E7  CD6B21  		call 	CheckBootParams
 192:  964+10	20EA  C23020  		jp 	nz,force_subst
 193:					
 194:  974+13	20ED  3A80F8  		ld 	a,(0xf880)
 195:  987+7	20F0  E601    		and 	0x1
 196:  994+13	20F2  325F23  		ld 	(mute_flag),a
 197: 1007+10	20F5  CAFB20  		jp 	z,skip_msg_1
 198:				
 199: 1017+17	20F8  CDDA21  		call 	ShowBootParams
 200:				
 201:     -	20FB          	skip_msg_1:
 202:						
 203:				; Вычисление числа полных дорожек для загрузки	
 204:					
 205: 1034+10	20FB  21EB22  		LD	HL,SCOUNT	
 206: 1044+7	20FE  5E      		LD	E,(HL)		; число загружаемых физических секторов
 207: 1051+7	20FF  1600    		LD	D,0		; -> DE
 208: 1058+6	2101  23      		INC	HL
 209: 1064+7	2102  4E      		LD	C,(HL)		; индекс размера сектора
 210:				;
 211:				; Индекс размера - очень удобная величина, определяющая коэффициент блокирования секторов, то есть число логических секторов в физическом
 212:				; Размер логического сектора CP/M - всегда 128 байт.
 213:				;
 214:				;  Физ.сектор   SSIZE    коэффициент блокирования
 215:				;----------------------------------------------------
 216:				;     128         0                1
 217:				;     256         1                2
 218:				;     512         2                4
 219:				;     1024        3                8 
 220:				;
 221:				;
 222:				; Далее выполняется операция DE << C, что приводит к умножению числа физических секторов
 223:				; на коэффициент блокирования - получаем число загружаемых логических секторов
 224: 1071+4	2103  EB      		ex 	de,hl
 225: 1075+4	2104  0C      		INC	C		; Коррекция SSIZE, чтобы начинался с 1
 226:     -	2105          	SSL1:	
 227: 1079+4	2105  0D      		DEC	C		; счетчик сдвига--
 228: 1083+10	2106  CA0D21  		JP	Z,SSL2		; сдвиг окончен
 229:				; 	XOR	A		; CF=0
 230:				; 	LD	A,E
 231:				; 	RLA			; сдвигаем младший байт
 232:				; 	LD	E,A
 233:				; 	LD	A,D
 234:				; 	RLA			; сдвигаем старший байт
 235:				; 	LD	D,A
 236: 1093+11	2109  29      		add 	hl,hl
 237: 1104+10	210A  C30521  		JP	SSL1
 238:				;
 239:				;  Выводим на экран число логических секторов
 240:				;
 241:     -	210D          	SSL2:
 242: 1114+4	210D  EB      		ex 	de,hl
 243: 1118+13	210E  3A5F23  		ld 	a,(mute_flag)
 244: 1131+4	2111  B7      		or 	a
 245: 1135+10	2112  CA2921  		jp 	z,skip_msg_2
 246:				
 247: 1145+10	2115  215123  		LD	HL,HMLS
 248: 1155+17	2118  CDC222  		CALL	PSTR
 249: 1172+4	211B  7A      		LD	A,D
 250: 1176+17	211C  CD5D22  		CALL	HEX2
 251: 1193+4	211F  7B      		LD	A,E
 252: 1197+17	2120  CD5D22  		CALL	HEX2
 253:				
 254: 1214+10	2123  215C23  		LD	HL,HCRLF
 255: 1224+17	2126  CDC222  		CALL	PSTR
 256:				
 257:					;de - sectors to load
 258:				
 259:     -	2129          	skip_msg_2:
 260:				
 261:					;DE - sectors to load
 262:				
 263: 1241+4	2129  4B      		ld 	c,e 		; C - sectors to load (up to 32k)
 264: 1245+16	212A  2AE722  		LD	HL,(LOADR)	; HL - указатель позиции загрузки в памяти
 265:				
 266: 1261+4	212D  AF      		xor 	a
 267: 1265+13	212E  32E522  		ld 	(TRK),a
 268:				
 269: 1278+4	2131  0C      		inc 	c
 270:				
 271:     -	2132          	ld_loop_sec0:
 272: 1282+4	2132  AF      		xor 	a
 273: 1286+13	2133  32E622  		ld 	(SEC),a
 274:				
 275:     -	2136          	ld_loop:
 276:				
 277: 1299+4	2136  0D      		dec 	c
 278: 1303+4	2137  79      		ld 	a,c
 279: 1307+4	2138  B7      		or 	a
 280: 1311+10	2139  CA6421  		jp 	z,load_done
 281:				
 282: 1321+13	213C  3A5F23  		ld 	a,(mute_flag)
 283: 1334+4	213F  B7      		or 	a
 284: 1338+10	2140  CA4821  		jp 	z,skip_msg_star
 285:				
 286: 1348+7	2143  3E2A    		LD	A,'*'		; прогресс-бар загружаемых секторов
 287: 1355+17	2145  CDCC22  		CALL	PUTCH
 288:     -	2148          	skip_msg_star:
 289:					
 290:				
 291: 1372+17	2148  CD8722  		CALL	SENDCMD		; отправляем команду
 292: 1389+17	214B  CDA722  		CALL	GETSEC		; получаем и размещаем сектор
 293:				
 294: 1406+11	214E  E5      		PUSH	HL
 295: 1417+10	214F  21E622  		LD	HL,SEC
 296: 1427+11	2152  34      		INC	(HL)		; номер сектора ++
 297:				
 298: 1438+13	2153  3AED22  		ld 	a,(LSPT)
 299: 1451+7	2156  BE      		cp 	(hl)
 300: 1458+10	2157  E1      		POP	HL
 301:				
 302: 1468+10	2158  C23621  		jp 	nz,ld_loop
 303:				
 304: 1478+11	215B  E5      		PUSH	HL
 305: 1489+10	215C  21E522  		LD	HL,TRK
 306: 1499+11	215F  34      		INC	(HL)		; номер сектора ++
 307: 1510+10	2160  E1      		POP	HL
 308: 1520+10	2161  C33221  		jp 	ld_loop_sec0
 309:				
 310:     -	2164          	load_done:
 311:				; 	halt
 312:				
 313:				; Вся системная область диска загружена - можно запускать ОС
 314:				;	
 315:				; 	LD	A,'@'		; Признак окончания загрузки - на экран
 316:				; 	CALL	PUTCH
 317:				
 318: 1530+17	2164  CD5325  		call 	cpm_bios_patcher
 319:				
 320:				; 	LD	HL,SYSREG14	
 321:				; 	LD	(HL),1Ch	; Включаем карту памяти 1С, для CP/M
 322:					
 323:					;start with sysreg=14
 324:				
 325: 1547+16	2167  2AE922  		LD	HL,(RUNADR)
 326: 1563+4	216A  E9      		JP	(HL)		; уходим по адресу запуска
 327:					
 328:     -	216B          	CheckBootParams:
 329:				
 330: 1567+10	216B  21E722  		LD	HL,LOADR
 331: 1577+17	216E  CD8222  		call 	FetchDEfromHL
 332:				
 333: 1594+4	2171  7A      		ld 	a,d
 334: 1598+7	2172  FE22    		cp 	0x22 		; load addr shiould be >0x2200
 335: 1605+10	2174  DA9221  		jp 	c,.BadBootParam
 336:				
 337: 1615+10	2177  21E922  		LD	HL,RUNADR
 338: 1625+17	217A  CD8222  		call 	FetchDEfromHL
 339: 1642+4	217D  7A      		ld 	a,d
 340: 1646+7	217E  FE22    		cp 	0x22 		; run addr shiould be >0x2200
 341: 1653+10	2180  DA9221  		jp 	c,.BadBootParam
 342:				
 343: 1663+10	2183  21EB22  		LD	HL,SCOUNT
 344: 1673+7	2186  7E      		LD	A,(HL)
 345: 1680+4	2187  B7      		or 	a
 346: 1684+10	2188  CA9221  		jp 	z,.BadBootParam
 347: 1694+7	218B  FE30    		cp 	48 		;sectors to load < 48
 348: 1701+10	218D  D29221  		jp 	nc,.BadBootParam
 349:				
 350: 1711+4	2190  AF      		xor 	a
 351: 1715+10	2191  C9      		ret
 352:				
 353:     -	2192          	.BadBootParam:
 354: 1725+17	2192  CDDA21  		call 	ShowBootParams
 355: 1742+10	2195  219E21  		ld 	hl,msgBadBootParam
 356: 1752+17	2198  CDC222  		CALL	PSTR
 357: 1769+4	219B  AF      		xor 	a
 358: 1773+4	219C  3C      		inc 	a
 359: 1777+10	219D  C9      		ret
 360:				
 361:     -	219E          	msgBadBootParam:
 362:     -	219E  0D0A    		db 	0x0d,0x0a
 363:     -	21A0  496E636F		db 	'Incorrect boot parameters detected, fallback to default'
	      72726563
	      7420626F
	      6F742070
	      6172616D
	      65746572
	      73206465
	      74656374
	      65642C20
	      66616C6C
	      6261636B
	      20746F20
	      64656661
	      756C74
 364:     -	21D7  0D0A00  		db 	0x0d,0x0a,0
 365:				
 366:     -	21DA          	ShowBootParams:
 367:					; Вывод параметров загрузки на экран
 368: 1787+10	21DA  212923  		LD	HL,HMBASE
 369: 1797+17	21DD  CDC222  		CALL	PSTR
 370: 1814+10	21E0  21E722  		LD	HL,LOADR
 371: 1824+17	21E3  CD7722  		CALL	HEXW
 372: 1841+10	21E6  212F23  		LD	HL,HMRUN
 373: 1851+17	21E9  CDC222  		CALL	PSTR
 374: 1868+10	21EC  21E922  		LD	HL,RUNADR
 375: 1878+17	21EF  CD7722  		CALL	HEXW
 376: 1895+10	21F2  213723  		LD	HL,HMPS
 377: 1905+17	21F5  CDC222  		CALL	PSTR
 378: 1922+10	21F8  21EB22  		LD	HL,SCOUNT
 379: 1932+7	21FB  7E      		LD	A,(HL)
 380: 1939+17	21FC  CD5D22  		CALL	HEX2
 381: 1956+10	21FF  214223  		LD	HL,HMSS
 382: 1966+17	2202  CDC222  		CALL	PSTR
 383: 1983+10	2205  21EC22  		LD	HL,SSIZE
 384: 1993+7	2208  7E      		LD	A,(HL)
 385: 2000+17	2209  CD5D22  		CALL	HEX2
 386: 2017+10	220C  214A23  		LD	HL,HMSP
 387: 2027+17	220F  CDC222  		CALL	PSTR
 388: 2044+10	2212  21ED22  		LD	HL,LSPT
 389: 2054+7	2215  7E      		LD	A,(HL)
 390: 2061+17	2216  CD5D22  		CALL	HEX2
 391: 2078+10	2219  C9      		ret
 392:				
 393:     -	221A          	initLUT:
 394: 2088+10	221A  21FBFA  		ld      hl, 0xFAFB
 395: 2098+7	221D  3EF8    		ld      a, 0F8h 
 396:				
 397:     -	221F          	.iniLUT:                  
 398: 2105+7	221F  77      		ld      (hl), a         ; F8,F9,FA,FB,FC,FD,FE,FF
 399: 2112+4	2220  3C      		inc     a
 400: 2116+10	2221  C21F22  		jp      nz, .iniLUT      ; F8,F9,FA,FB,FC,FD,FE,FF
 401:					
 402: 2126+10	2224  010811  		ld      bc, 1108h       ; A=0
 403:					
 404:     -	2227          	.iniLUTGRP:                  
 405: 2136+7	2227  77      		ld      (hl), a         ; 00,11,22,33,44,55,66,77
 406: 2143+4	2228  80      		add     a, b
 407: 2147+4	2229  0D      		dec     c
 408: 2151+10	222A  C22722  		jp      nz, .iniLUTGRP   ; 00,11,22,33,44,55,66,77
 409:				
 410: 2161+10	222D  C9      		ret
 411:				
 412:				
 413:				;****************************************
 414:				;*  Прием байта из порта А по стробу    *
 415:				;****************************************
 416:     -	222E          	GETBYTE:
 417: 2171+11	222E  E5      		PUSH	HL
 418: 2182+10	222F  210AFB  		LD	HL,PORTC
 419:     -	2232          	WG:
 420: 2192+7	2232  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 421: 2199+7	2233  E620    		AND	20h		; выделяем сигнал IBF
 422: 2206+10	2235  CA3222  		JP	Z,WG		; IBF=0 - данных еще нет
 423: 2216+4	2238  2D      		DEC	L
 424: 2220+4	2239  2D      		DEC	L
 425: 2224+7	223A  7E      		LD	A,(HL)		; данные поступили - выбираем их из порта А
 426: 2231+10	223B  E1      		POP	HL
 427: 2241+10	223C  C9      		RET
 428:				
 429:				;****************************************
 430:				;*  Отправка байта в порт A             *
 431:				;****************************************
 432:     -	223D          	PUTBYTE:
 433: 2251+11	223D  E5      		PUSH	HL
 434: 2262+11	223E  F5      		PUSH	AF
 435: 2273+10	223F  210AFB  		LD	HL,PORTC
 436:     -	2242          	WP:
 437: 2283+7	2242  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 438: 2290+7	2243  E680    		AND	80h		; выделяем сигнал -OBF
 439: 2297+10	2245  CA4222  		JP	Z,WP		; -OBF=0 - в передатчике сидит незабранный байт
 440: 2307+4	2248  2D      		DEC	L
 441: 2311+4	2249  2D      		DEC	L
 442: 2315+10	224A  F1      		POP	AF
 443: 2325+7	224B  77      		LD	(HL),A		; отправляем данные в порт данных
 444: 2332+10	224C  E1      		POP	HL
 445: 2342+10	224D  C9      		RET
 446:				
 447:				;****************************************
 448:				;*      Печать полубайта в HEX          *
 449:				;****************************************
 450:				
 451:     -	224E          	HEX1:
 452: 2352+7	224E  E60F    		AND	0Fh		; младший полубайт 
 453: 2359+7	2250  C630    		ADD	'0'		; в ASCII
 454: 2366+7	2252  FE3A    		CP	3Ah		; 0-9?
 455: 2373+10	2254  DA5922  		JP	C,H1D		; да
 456: 2383+7	2257  C607    		ADD	7		; коррекция до A-F
 457: 2390+17	2259  CDCC22  	H1D:	CALL	PUTCH		; Печать байта
 458: 2407+10	225C  C9      		RET
 459:				
 460:				;****************************************
 461:				;*      Печать байта в HEX              *
 462:				;****************************************
 463:				
 464: 2417+11	225D  F5      	HEX2:	PUSH	AF
 465: 2428+4	225E  0F      		RRCA
 466: 2432+4	225F  0F      		RRCA			; сдвигаем старший полубайт в младший
 467: 2436+4	2260  0F      		RRCA
 468: 2440+4	2261  0F      		RRCA
 469: 2444+17	2262  CD4E22  		CALL	HEX1		; печатаем его
 470: 2461+10	2265  F1      		POP	AF
 471: 2471+7	2266  E60F    		AND	0Fh		
 472: 2478+17	2268  CD4E22  		CALL	HEX1		; печатаем младший полубайт
 473: 2495+10	226B  C9      		RET
 474:				
 475:     -	226C          	HEX4:
 476: 2505+11	226C  F5      		push 	AF
 477: 2516+4	226D  7C      		ld 	a,h
 478: 2520+17	226E  CD5D22  		call 	HEX2
 479: 2537+4	2271  7D      		ld 	a,l
 480: 2541+17	2272  CD5D22  		call 	HEX2
 481: 2558+10	2275  F1      		pop 	AF
 482: 2568+10	2276  C9      		ret
 483:				;****************************************
 484:				;*  Печать слова (2 байта) из (HL)      *
 485:				;****************************************
 486:     -	2277          	HEXW:
 487: 2578+6	2277  23      		INC	HL
 488: 2584+7	2278  7E      		LD	A,(HL)		; старший байт
 489: 2591+17	2279  CD5D22  		CALL	HEX2
 490: 2608+6	227C  2B      		DEC	HL		; младший байт
 491: 2614+7	227D  7E      		LD	A,(HL)
 492: 2621+17	227E  CD5D22  		CALL	HEX2
 493: 2638+10	2281  C9      		RET
 494:				
 495:     -	2282          	FetchDEfromHL:
 496: 2648+7	2282  5E      		LD	E,(HL)
 497: 2655+6	2283  23      		INC	HL
 498: 2661+7	2284  56      		LD	D,(HL)		; старший байт
 499: 2668+6	2285  2B      		DEC	HL		; младший байт
 500: 2674+10	2286  C9      		RET
 501:					
 502:						
 503:				;****************************************
 504:				;*     Отправка командного пакета       *
 505:				;****************************************
 506:     -	2287          	SENDCMD:
 507: 2684+11	2287  E5      		PUSH	HL
 508: 2695+11	2288  C5      		PUSH	BC
 509: 2706+10	2289  21E322  		LD	HL,CMD
 510: 2716+7	228C  0E04    		LD	C,4		; пакет - 4 байта
 511: 2723+7	228E  0600    		LD	B,0		; заготовка контрольной суммы
 512:     -	2290          	SCL:
 513: 2730+7	2290  7E      		LD	A,(HL)		; очередной байт пакета 
 514: 2737+4	2291  80      		ADD 	B		; добавляем к КС
 515: 2741+4	2292  47      		LD	B,A
 516: 2745+7	2293  7E      		LD	A,(HL)		; очередной байт пакета 
 517: 2752+17	2294  CD3D22  		CALL	PUTBYTE		; - в порт
 518: 2769+6	2297  23      		INC	HL
 519: 2775+4	2298  0D      		DEC	C
 520: 2779+10	2299  C29022  		JP	NZ,SCL
 521: 2789+4	229C  78      		LD	A,B
 522: 2793+4	229D  3D      		DEC 	A		; КС-1
 523: 2797+17	229E  CD3D22  		CALL	PUTBYTE     ; контрольная сумма
 524: 2814+17	22A1  CD2E22  		CALL	GETBYTE	    ; ответ контроллера
 525: 2831+10	22A4  C1      		POP	BC
 526: 2841+10	22A5  E1      		POP	HL
 527: 2851+10	22A6  C9      		RET
 528:					
 529:					
 530:				;*******************************************
 531:				;*      Прием сектора                      *
 532:				;* HL - адрес размещения сектора в памяти  *
 533:				;*  Размер сектора - 128 байт              *
 534:				;*******************************************
 535:     -	22A7          	GETSEC:
 536: 2861+11	22A7  C5      		PUSH	BC
 537: 2872+11	22A8  D5      		PUSH	DE
 538: 2883+7	22A9  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
 539: 2890+4	22AB  EB      		EX	DE,HL		; адрес буфера -> DE
 540: 2894+10	22AC  210AFB  		LD	HL,PORTC
 541:     -	22AF          	GSL:
 542: 2904+7	22AF  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 543: 2911+7	22B0  E620    		AND	20h		; выделяем сигнал IBF
 544: 2918+10	22B2  CAAF22  		JP	Z,GSL		; IBF=0 - данных еще нет
 545: 2928+13	22B5  3A08FB  		LD	A,(PORTA)		; данные поступили - выбираем их из порта А
 546: 2941+7	22B8  12      		LD	(DE),A		; принимаем и размещаем очередной байт
 547: 2948+6	22B9  13      		INC	DE		; указатель буфера ++
 548: 2954+4	22BA  0D      		DEC	C		; принимаем остальные байты
 549: 2958+10	22BB  C2AF22  		JP	NZ,GSL
 550: 2968+4	22BE  EB      		EX	DE,HL		; адрес буфера -> HL
 551: 2972+10	22BF  D1      		POP	DE
 552: 2982+10	22C0  C1      		POP	BC
 553: 2992+10	22C1  C9      		RET
 554:					
 555:					
 556:					
 557:				;****************************************
 558:				;  Печать строки на текстовый экран     *
 559:				;****************************************
 560:     -	22C2          	PSTR:
 561: 3002+7	22C2  7E      		LD	A,(HL)
 562: 3009+6	22C3  23      		INC	HL
 563: 3015+4	22C4  B7      		OR	A		; 0 - конец строки
 564: 3019+5+6	22C5  C8      		RET	Z
 565: 3024+17	22C6  CDCC22  		CALL	PUTCH		; выводим байт через вызов ОПТС
 566: 3041+10	22C9  C3C222  		JP	PSTR
 567:					
 568:				;****************************************
 569:				;   Вывод байта на экран через ОПТС
 570:				;****************************************
 571:     -	22CC          	PUTCH:
 572: 3051+11	22CC  E5      		PUSH	HL
 573: 3062+11	22CD  C5      		PUSH	BC
 574: 3073+11	22CE  D5      		PUSH	DE
 575: 3084+4	22CF  4F      		LD	C,A
 576: 3088+17	22D0  CD4C00  		CALL	PCHDRV
 577: 3105+10	22D3  D1      		POP	DE
 578: 3115+10	22D4  C1      		POP	BC
 579: 3125+10	22D5  E1      		POP	HL
 580: 3135+10	22D6  C9      		RET
 581:				
 582:				;A - chr
 583:     -	22D7          	GETCH:
 584: 3145+4	22D7  FB      		EI
 585: 3149+11	22D8  E5      		PUSH	HL
 586: 3160+11	22D9  C5      		PUSH	BC
 587: 3171+11	22DA  D5      		PUSH	DE
 588: 3182+17	22DB  CD4900  		CALL	CONIN
 589: 3199+10	22DE  D1      		POP	DE
 590: 3209+10	22DF  C1      		POP	BC
 591: 3219+10	22E0  E1      		POP	HL
 592: 3229+4	22E1  F3      		DI
 593: 3233+10	22E2  C9      		RET
 594:				
 595:				
 596:				; Командный пакет	
 597:     -	22E3  01      	CMD:	DB	1		; Команда чтения
 598:     -	22E4  00      	DRV:	DB	0
 599:     -	22E5  00      	TRK:	DB	0
 600:     -	22E6  00      	SEC:	DB	0
 601:				
 602:				; Параметры загрузки из инфосектора
 603:     -	22E7          	LOADR:	DS	2	; адрес загрузки
 604:     -	22E9          	RUNADR:	DS	2	; адрес запуска
 605:     -	22EB          	SCOUNT:	DS	1	; число загружаемых физических секторов
 606:     -	22EC          	SSIZE:	DS	1	; коэффициент размера физического сектора
 607:     -	22ED          	LSPT:	DS	1	; число логических секторов на дорожку
 608:				
 609:				; Текстовые строки для вывода на экран
 610:     -	22EE  1F      	HMSG:   DB	1Fh ; очистка экрана
 611:     -	22EF  2D2D4558		DB	"--EXTROM Stage2 boot version 1.0 by Forh32 & ESL 2014--",0dh,0ah,0	; текстовое сообщение на экран
	      54524F4D
	      20537461
	      67653220
	      626F6F74
	      20766572
	      73696F6E
	      20312E30
	      20627920
	      466F7268
	      33322026
	      2045534C
	      20323031
	      342D2D0D
	      0A00
 612:     -	2329  42415345	HMBASE: DB	"BASE:",0
	      3A00
 613:     -	232F  20535441	HMRUN:  DB	" START:",0
	      52543A00
 614:     -	2337  20505345	HMPS:   DB	" PSECTORS:",0
	      43544F52
	      533A00
 615:     -	2342  20535349	HMSS:   DB	" SSIZE:",0
	      5A453A00
 616:     -	234A  204C5350	HMSP:   DB	" LSPT:",0
	      543A00
 617:     -	2351  204C5345	HMLS:   DB	" LSECTORS:",0
	      43544F52
	      533A00
 618:				; HMTR:   DB	" TRACKS:",0
 619:     -	235C  0D0A00  	HCRLF:	DB	0dh,0ah,0
 620:     -	235F          	mute_flag:
 621:     -	235F  00      		db 	0
 622:     -	2360          	tmpKEY:
 623:     -	2360  00      		db 	0
 624:     -	2361          	msgCPM:
 625:     -	2361  43502F4D	 	db 	'CP/M',0
	      00
 626:     -	2366          	msgMICRODOS:
 627:     -	2366  4D494352		db 	'MICRODOS',0
	      4F444F53
	      00
 628:     -	236F          	msgSUBST:
 629:     -	236F  4C6F6164	 	db 	'Load default ',0 
	      20646566
	      61756C74
	      2000
 630:     -	237D          	msgASK_SUBST:
 631:     -	237D  203F2845		db 	' ?(Enter/Y-yes, C-CP/M, M-microdos) ?',0	
	      6E746572
	      2F592D79
	      65732C20
	      432D4350
	      2F4D2C20
	      4D2D6D69
	      63726F64
	      6F732920
	      3F00
 632:				
 633:     -	23A3          	msgFORCEDDEFAULTBIOS:
 634:     -	23A3  0D0A2121		db 	0dh,0ah,'!! Ctrl+Shift - pressed, forced to use BIOS SUBSTITUTION !!',0dh,0ah,0dh,0ah,0
	      20437472
	      6C2B5368
	      69667420
	      2D207072
	      65737365
	      642C2066
	      6F726365
	      6420746F
	      20757365
	      2042494F
	      53205355
	      42535449
	      54555449
	      4F4E2021
	      210D0A0D
	      0A00
 635:				
 636:					include 	"hw_test.asm"
**** hw_test.asm ****
   1:     -	0001          	_HW_ROM_OPTS1		equ 	1
   2:     -	0002          	_HW_ROM_OPTS2		equ 	2
   3:				
   4:     -	0001          	_HW_ROM_MODEL_OPTS11 	equ 	1
   5:     -	0002          	_HW_ROM_MODEL_OPTS20 	equ 	2
   6:     -	0003          	_HW_ROM_MODEL_KVANT8	equ 	3
   7:				
   8:     -	0001          	_HW_GZU_SIZE_48K 	equ 	1
   9:     -	0002          	_HW_GZU_SIZE_192K 	equ 	2
  10:				
  11:				;0 - undefined
  12:				;1 - OPTS 1.x
  13:				;2 - OPTS 2.x
  14:     -	23E5          	HW_ROM_OPTS_CLASS:
  15:     -	23E5  00      		db 	0 	
  16:				
  17:				
  18:				;0 - undefined
  19:				;1 - ОПТС 1.1
  20:				;2 - ОПТС 2.0
  21:				;3 - КОНТУР
  22:				;4 - КВАНТ-8 - Терминал
  23:				;5 - КВАНТ-8 - Тигрис
  24:				;6 - CPM.ROM
  25:     -	23E6          	HW_ROM_MODEL:
  26:     -	23E6  00      		db 	0
  27:				
  28:				;0 - undefined
  29:				;1 - 48k
  30:				;2 - 192k
  31:     -	23E7  00      	HW_GZU_SIZE:	db 	0
  32:				
  33:				
  34:     -	23E8  00      	HW_FDC_PRESENT:	db 	0
  35:     -	23E9  00      	HW_FDD_DRIVE_A:	db 	0		
  36:     -	23EA  00      	HW_FDD_DRIVE_B:	db 	0		
  37:     -	23EB  00      	HW_FDD_DRIVE_C:	db 	0		
  38:     -	23EC  00      	HW_FDD_DRIVE_D:	db 	0		
  39:				
  40:     -	23ED          	msg_tab8_rom_model:
  41:					;        01234567
  42:     -	23ED  3F3F524F		db 	'??ROM?? '
	      4D3F3F20
  43:     -	23F5  4F505453		db 	'OPTS 1.1'
	      20312E31
  44:     -	23FD  4F505453		db 	'OPTS 2.0'
	      20322E30
  45:     -	2405  4B76616E		db 	'Kvant8  '
	      74382020
  46:				;нет поддержки загрузки EXTROM
  47:				; 	db 	'Kontur  ' 	
  48:				; 	db 	'Kvant8-T'
  49:				; 	db 	'CPM     '
  50:				
  51:     -	240D          	msg_tab8_gzu_size:
  52:					;        01234567
  53:     -	240D  3F3F3F6B		db 	'???k ',0,0,0
	      20000000
  54:     -	2415  34386B20		db 	'48k ',0,0,0,0
	      00000000
  55:     -	241D  3139326B		db 	'192k ',0,0,0
	      20000000
  56:				
  57:     -	2425          	msg_tab16_fdc:
  58:					;        01234  5     6   789012  3     4  5
  59:     -	2425  3130202D		db 	'10 - ',01bh,'6','no FDC',01bh,'7',0
	      201B366E
	      6F204644
	      431B3700
  60:					;        0123456789012345
  61:     -	2435  32302077		db 	'20 with FDC',0
	      69746820
	      46444300
  62:				
  63:     -	2441          	msg_rom_model:
  64:     -	2441  524F4D3A		db 	'ROM: ',0
	      2000
  65:     -	2447          	msg_gzu_size:
  66:     -	2447  207C2047		db 	' | GZU: ',0
	      5A553A20
	      00
  67:     -	2450          	msg_fdc:
  68:     -	2450  207C2050		db 	' | PK80',0
	      4B383000
  69:				
  70:				; CP/M-80  
  71:				; v. 2.2..SHCOMP BIOS Ver. 1.0 1991
  72:				
  73:     -	2458          	putstr16:
  74: 3243+7	2458  0E10    		ld 	c,16
  75: 3250+4	245A  6F      		ld 	l,a
  76: 3254+7	245B  2600    		ld 	h,0
  77: 3261+11	245D  29      		add 	hl,hl 	
  78: 3272+10	245E  C36624  		jp 	putx8
  79:				; a - n
  80:				;DE - base addr
  81:     -	2461          	putstr8:
  82: 3282+7	2461  0E08    		ld 	c,8
  83: 3289+4	2463  6F      		ld 	l,a
  84: 3293+7	2464  2600    		ld 	h,0
  85:     -	2466          	putx8:
  86: 3300+11	2466  29      		add 	hl,hl 	
  87: 3311+11	2467  29      		add 	hl,hl 	
  88: 3322+11	2468  29      		add 	hl,hl 	
  89: 3333+11	2469  19      		add 	hl,de
  90:				
  91:     -	246A          	putstr_:
  92: 3344+4	246A  79      		ld 	a,c
  93: 3348+4	246B  B7      		or 	a
  94: 3352+5+6	246C  C8      		ret 	z
  95: 3357+4	246D  0D      		dec 	c
  96: 3361+7	246E  7E      		LD	A,(HL)
  97: 3368+4	246F  B7      		or 	a
  98: 3372+5+6	2470  C8      		ret 	z
  99:				; 	jp 	nz,.putNoSpc
 100:				; 	ld 	a,'_'
 101:				; 	dec 	hl
 102:     -	2471          	.putNoSpc:
 103: 3377+6	2471  23      		INC	HL
 104: 3383+17	2472  CDCC22  		CALL	PUTCH		
 105: 3400+10	2475  C36A24  		JP	putstr_
 106:				
 107:     -	2478          	show_hardware_info:
 108: 3410+10	2478  214124  		ld 	hl,msg_rom_model
 109: 3420+17	247B  CDC222  		call 	PSTR
 110:				
 111: 3437+13	247E  3AE623  		ld 	a,(HW_ROM_MODEL)
 112: 3450+10	2481  11ED23  		ld 	de,msg_tab8_rom_model
 113: 3460+17	2484  CD6124  		call 	putstr8
 114:				
 115: 3477+10	2487  215024  		ld 	hl,msg_fdc
 116: 3487+17	248A  CDC222  		call 	PSTR
 117:				
 118: 3504+13	248D  3AE823  		ld 	a,(HW_FDC_PRESENT)
 119: 3517+10	2490  112524  		ld 	de,msg_tab16_fdc
 120: 3527+17	2493  CD5824  		call 	putstr16
 121:				
 122:				; 	ld 	a,'/'
 123:				; 	call 	PUTCH
 124:				
 125:				; 	ld 	a,(HW_ROM_OPTS_CLASS)
 126:				; 	call 	HEX2
 127:				
 128: 3544+10	2496  214724  		ld 	hl,msg_gzu_size
 129: 3554+17	2499  CDC222  		call 	PSTR
 130:				
 131: 3571+13	249C  3AE723  		ld 	a,(HW_GZU_SIZE)
 132: 3584+10	249F  110D24  		ld 	de,msg_tab8_gzu_size
 133: 3594+17	24A2  CD6124  		call 	putstr8
 134:				
 135: 3611+10	24A5  215C23  		LD	HL,HCRLF
 136: 3621+17	24A8  CDC222  		CALL	PSTR
 137:				
 138: 3638+10	24AB  C9      		ret
 139:				
 140:				
 141:     -	24AC          	hw_test:
 142: 3648+17	24AC  CD1F25  		call 	hw_check_rom
 143: 3665+17	24AF  CDCC24  		call 	hw_check_gzu_size
 144: 3682+17	24B2  CDB924  		call 	hw_check_floppy
 145: 3699+17	24B5  CD7824  		call 	show_hardware_info
 146:				
 147:				; 	halt
 148: 3716+10	24B8  C9      		ret
 149:				
 150:     -	24B9          	hw_check_floppy:
 151: 3726+7	24B9  3E01    		ld 	a,1
 152: 3733+10	24BB  11E823  		ld 	de,HW_FDC_PRESENT
 153: 3743+7	24BE  12      		ld 	(de),a
 154:				
 155:				; Проверка наличия дисководов
 156: 3750+10	24BF  2119FB  		LD	HL,0FB19H 	; регистр дорожки
 157: 3760+10	24C2  3605    		LD	(HL),5		; записываем образец
 158: 3770+7	24C4  7E      		LD	A,(HL)
 159: 3777+7	24C5  FE05    		CP	5		; проверяем
 160: 3784+5+6	24C7  C8      		RET 	Z		; совпал - FDC у нас есть
 161: 3789+7	24C8  3E00    		ld 	a,0
 162: 3796+7	24CA  12      		ld 	(de),a
 163: 3803+10	24CB  C9      		ret
 164:				; В машине нет FDC
 165:				; 	XOR	A	
 166:				; 	LD	(CPMT02-2),A	; Очищаем маски дисков C и D
 167:				; 	LD	(CPMT03-2),A	; Они становятся эмулируемыми
 168:				; 	RET	ret 
 169:				
 170:     -	FE3A          	NCREG 	equ 	0xFE3A
 171:     -	FFBF          	VIREG 	equ 	0xFFBF
 172:				
 173:     -	24CC          	hw_check_gzu_size:
 174:				; 	проверка ГЗУ, не убивая рамдиск в 1+ страницах
 175:				; 	включаем 0 страницу на доступ
 176:				; 	в последние 3 байта пишем значения
 177:				; 	включаем 3 страницу на доступ
 178:				; 	проверяем содержимое этих байт
 179:				; 	если совпало то 48к (т.к. переключение не проихошло)
 180:				; 	иначе счетаем что 192к
 181:				
 182:				
 183:				;3C  DOSG1          0000-3FFF  4000  8000-FDFF        FF00        FE00
 184: 3813+7	24CC  3E3C    		ld 	a,0x3C
 185: 3820+13	24CE  327FFA  		ld 	(SYSREG14),a
 186:				
 187: 3833+10	24D1  21FF7F  	        ld      hl, 07FFFh 	;last gzu byte
 188:				
 189:					; vireg pointed to RW page 0
 190:				
 191: 3843+7	24D4  3EA4    	        ld      a,0x80 | 4 | 0x20 ;color 2 - green (должен быть не 1)
 192: 3850+13	24D6  32BFFF  	        ld      (VIREG), a
 193:				
 194: 3863+10	24D9  01AA55  	        ld 	bc,0x55aa
 195: 3873+7	24DC  70      	        ld      (hl), b   
 196: 3880+6	24DD  2B      	        dec 	hl
 197: 3886+7	24DE  71      	        ld 	(hl), c
 198: 3893+6	24DF  2B      	        dec 	hl
 199: 3899+7	24E0  75      	        ld 	(hl), l
 200: 3906+6	24E1  23      	        inc 	hl
 201: 3912+6	24E2  23      	        inc 	hl
 202:				
 203: 3918+7	24E3  3EE0    	        ld      a, 0xE0 	;SCR_PAGE0|ATTR_RESET|RW_PAGE3
 204: 3925+13	24E5  323AFE  	        ld      (NCREG), a
 205:				
 206:				        ;читаем инвертированные значения не 0x55aa а 0xaa55
 207: 3938+4	24E8  79      	        ld 	a,c 		
 208: 3942+7	24E9  BE      	        cp 	m
 209: 3949+10	24EA  C20025  	        jp 	nz,.zgu192k
 210: 3959+6	24ED  2B      	        dec 	hl
 211: 3965+4	24EE  78      	        ld 	a,b
 212: 3969+7	24EF  BE      	        cp 	m
 213: 3976+10	24F0  C20025  	        jp 	nz,.zgu192k
 214: 3986+6	24F3  2B      	        dec 	hl
 215: 3992+4	24F4  7D      	        ld 	a,l
 216: 3996+7	24F5  EEFF    	        xor 	0xff
 217: 4003+7	24F7  BE      	        cp 	m
 218: 4010+10	24F8  C20025  	        jp 	nz,.zgu192k
 219:				
 220: 4020+7	24FB  3E01    	        ld 	a,_HW_GZU_SIZE_48K
 221: 4027+10	24FD  C30225  	        jp      .setgzusize 
 222:				
 223:     -	2500          	.zgu192k:
 224: 4037+7	2500  3E02    	        ld 	a,_HW_GZU_SIZE_192K
 225:				
 226:     -	2502          	.setgzusize:
 227: 4044+13	2502  32E723  	        ld      (HW_GZU_SIZE),a
 228:				
 229: 4057+7	2505  3E20    	        ld 	a,0x20		;SCR_PAGE0|ATTR_RESET|RW_PAGE0
 230: 4064+13	2507  323AFE  	        ld      (NCREG),a  	
 231:				
 232:				        ;стереть следы проверки
 233: 4077+7	250A  3E92    	        ld      a,0x80 | 2 | 0x10 ;color 1 - blue
 234: 4084+13	250C  32BFFF  	        ld      (VIREG), a
 235: 4097+10	250F  21FF7F  	        ld 	hl,0x7fff
 236: 4107+7	2512  3EFF    	        ld 	a,0xff
 237: 4114+7	2514  77      	        ld 	(hl),a
 238: 4121+6	2515  2B      	        dec 	hl
 239: 4127+7	2516  77      	        ld 	(hl),a
 240: 4134+6	2517  2B      	        dec 	hl
 241: 4140+7	2518  77      	        ld 	(hl),a
 242:				
 243: 4147+7	2519  3E14    		ld 	a,0x14;
 244: 4154+13	251B  327FFF  		ld 	(SYSREG3C),a
 245:				
 246: 4167+10	251E  C9      		ret
 247:				
 248:     -	251F          	hw_check_rom:
 249: 4177+10	251F  210000  		ld 	hl,0
 250: 4187+7	2522  0E00    		ld 	c,0
 251: 4194+4	2524  3F      		ccf
 252:     -	2525          	.romcrc:
 253: 4198+4	2525  79      		ld 	a,c
 254: 4202+7	2526  8E      		adc 	a,(hl)
 255: 4209+4	2527  4F      		ld 	c,a
 256: 4213+6	2528  23      		inc 	hl
 257: 4219+4	2529  7D      		ld 	a,l
 258: 4223+4	252A  B7      		or 	a
 259: 4227+10	252B  C22525  		jp 	nz,.romcrc
 260: 4237+4	252E  79      		ld 	a,c
 261:				
 262: 4241+7	252F  0601    		ld 	b,_HW_ROM_OPTS1
 263: 4248+7	2531  0E01    		ld 	c,_HW_ROM_MODEL_OPTS11
 264: 4255+7	2533  FE9A    		cp 	0x9A
 265: 4262+10	2535  CA4A25  		jp 	z,.rom_found
 266:				
 267: 4272+7	2538  0E03    		ld 	c,_HW_ROM_MODEL_KVANT8
 268: 4279+7	253A  FE66    		cp 	0x66
 269: 4286+10	253C  CA4A25  		jp 	z,.rom_found
 270:				
 271: 4296+7	253F  0602    		ld 	b,_HW_ROM_OPTS2
 272: 4303+7	2541  0E02    		ld 	c,_HW_ROM_MODEL_OPTS20
 273: 4310+7	2543  FEBB    		cp 	0xBB
 274: 4317+10	2545  CA4A25  		jp 	z,.rom_found
 275:				
 276: 4327+7	2548  0E00    		ld 	c,0
 277:     -	254A          	.rom_found:
 278: 4334+4	254A  78      		ld 	a,b
 279: 4338+13	254B  32E523  		ld 	(HW_ROM_OPTS_CLASS),a
 280: 4351+4	254E  79      		ld 	a,c
 281: 4355+13	254F  32E623  		ld 	(HW_ROM_MODEL),a
 282:				
**** stage2.asm ****
 637: 4368+10	2552  C9      		ret
 638:					include 	"generator/V0/extrom-patcher.asm"
**** generator/V0/extrom-patcher.asm ****
   1:				;по адресу bios_variants табличка ссылок на все известные биосы
   2:				;пробуем выяснить какой биос загружен сейчас.
   3:				;если не нашли - fallback to default forth32 cp/m bios
   4:				;TODO: fallback to microdos if required
   5:				;TODO: ask user about fallback
   6:				
   7:				;алгоритм патчера
   8:				;на момент статрта в памяти уже есть загруженый в свои адреса биос, проверим что это нужный и пропатчим его
   9:				;проход 1, проверка, читаем байткоды (с доп параметрами) и проверяем что "первый параметр" совпадает, 
  10:				;если нет то считаем что это не нужный нам биос, и надо проверять следующий.
  11:				;проход 2, если на превом проходе всё проверки совпали
  12:				;то проходим и записываем занчение из "второго параметра"
  13:				;заодно выставляем флаги.
  14:				;чеки надо ставить в начале цепочки (по идее)
  15:				;последний байт обязательно p_STOP
  16:				;ругаемся на невалидный токен, для отладки.
  17:				
  18:				;токены патчера и их значения
  19:				
  20:     -	0050          	p_STOP 			EQU 	0x50	;должен быть последним токено в цепочке, патчер
  21:									;за ним следует строка с 0 - имя биоса
  22:									; 	db 	p_STOP
  23:									; 	db 	'21_89___wiza',0
  24:     -	0051          	pW_CHK_PATCH 		EQU	0x51 	;проверить значение СЛОВА, записать новое значение, параметры DW ADDR, OLDVALUE, NEWVALUE
  25:									;на этапе чека проверяем 1й параметр, на этапе патча записываем 2й
  26:									; 	db 	pW_CHK_PATCH
  27:									; 	dw 	0xDCBB+1,0xE06E,0xE06E
  28:     -	0052          	pB_CHK_PATCH 		EQU 	0x52 	;проверить значение БАЙТА, записать новое значение, параметры DW ADDR, DB OLDVALUE, NEWVALUE
  29:									;на этапе чека проверяем 1й параметр, на этапе патча записываем 2й
  30:									; 	db 	pB_CHK_PATCH
  31:									; 	dw 	0xE70A
  32:									; 	db	0x77,0x00
  33:     -	0054          	pW_STORE		EQU 	0x54 	;записать значение СЛОВА, параметры DW ADDR, NEWVALUE
  34:									;на этапе чека игнорируется, на этапе патча - применяем
  35:									; 	db 	pW_STORE
  36:									; 	dw 	0xE06E,r_p_SELDSKDRIVER+1	 
  37:     -	0055          	pNotSupported 		EQU 	0x55 	;выставляет флаг что биос не поддерживается
  38:									;используется для биосов которые детектятся но сейчас не поддерживаются
  39:									;на этапе чека игнорируется
  40:									;	db 	pNotSupported
  41:     -	0056          	pSETFLAG_MICRODOS 	EQU 	0x56	;выставляет флаг что биос текущий биос - микродос (по умолчанию считаем что cp/m)
  42:									;на этапе чека игнорируется
  43:									; 	db 	pSETFLAG_MICRODOS
  44:     -	0057          	pREQUIRED_OPTS1 	EQU 	0x57	;проверить версию ROM, если не ОПТС 1 то вывести сообщение и поставить флг Unsupported
  45:									;на этапе чека игнорируется
  46:									;	db 	pREQUIRED_OPTS2
  47:     -	0058          	pREQUIRED_OPTS2 	EQU 	0x58	;проверить версию ROM, если не ОПТС 2 то вывести сообщение и поставить флг Unsupported
  48:									;на этапе чека игнорируется
  49:									;	db 	pREQUIRED_OPTS2
  50:     -	0059          	pB_MAYBE_PATCH 		EQU 	0x59 	;записать новое значение если старое совпадает, параметры DW ADDR, DB OLDVALUE, NEWVALUE
  51:									;на этапе чека не проверяем
  52:									;на этапа патча проверяем 1й параметр и если совпал записываем 2й
  53:									;применяется для патча текстовых строк которые могут быть изменены
  54:									; 	db 	pB_CHK_PATCH
  55:									; 	dw 	0xE70A
  56:									; 	db	0x77,0x00
  57:     -	005A          	pSubBios		EQU 	0x5A	;записывает значение в переменную flag_subbios 
  58:									;используется чтобы указать какой вариант резидента использовать
  59:									; 	db 	pSubBios
  60:									; 	db 	0
  61:				
  62:				
  63:     -	0000          	DEBUG_TRACE_PATCHER	EQU 	0
  64:				
  65:				stop 	macro msg
  66:					db 	p_STOP
  67:					db 	msg
  68:					db 	0
  69:					endm
  70:				
  71:				dbpatch macro addr,oldbyte,newbyte
  72:					db 	pB_CHK_PATCH
  73:					dw 	addr
  74:					db 	oldbyte,newbyte
  75:					endm
  76:				
  77:				dbpatchmaybe macro addr,oldbyte,newbyte
  78:					db 	pB_MAYBE_PATCH
  79:					dw 	addr
  80:					db 	oldbyte,newbyte
  81:					endm
  82:				
  83:				dwpatch macro addr,oldword,newword
  84:					db 	pW_CHK_PATCH
  85:					dw 	addr
  86:					dw 	oldword,newword
  87:					endm
  88:				
  89:				dwstore macro addr,newword
  90:					db 	pW_STORE
  91:					dw 	newword
  92:					dw 	addr
  93:					endm
  94:				
  95:				setCPM 	macro 	
  96:					endm
  97:				
  98:				setSUBBIOS 	macro  id
  99:					db	pSubBios
 100:					db 	id
 101:					endm
 102:				
 103:				setMICRODOS macro
 104:					db 	pSETFLAG_MICRODOS
 105:					endm
 106:				
 107:				setUNSUPPORTED macro
 108:					db 	pNotSupported
 109:					endm
 110:				
 111:				RQ_OPTS1	macro
 112:					db 	pREQUIRED_OPTS1
 113:					endm
 114:				
 115:				RQ_OPTS2	macro
 116:					db 	pREQUIRED_OPTS2
 117:					endm
 118:				
 119:				RQ_OPTS_ANY	macro
 120:					endm
 121:				
 122:				
 123:     -	2553          	cpm_bios_patcher:
 124:				
 125:					;dirty hasck
 126:					;set jp 0 as first jp
 127:					;strange dos behaviour,
 128:					;sometime hangon when dir
 129: 4378+10	2553  210000  		ld 	hl,0
 130: 4388+16	2556  220120  		ld 	(BASE+1),hl 	;
 131:				
 132: 4404+10	2559  21BD25  		ld 	hl,msgPATCHER
 133: 4414+17	255C  CDC222  		call 	PSTR
 134:				
 135:					; mute message for second time (fallback code)
 136: 4431+7	255F  3E00    		ld 	a,0
 137: 4438+13	2561  32BD25  		ld 	(msgPATCHER),a
 138:				
 139:				
 140:				; 	call 	get_rom_version
 141:				
 142: 4451+10	2564  111C2F  		ld 	de,bios_variants
 143:     -	2567          	chk_bios_lp:
 144: 4461+7	2567  1A      		ld 	a,(de)
 145: 4468+4	2568  6F      		ld 	l,a
 146: 4472+6	2569  13      		inc 	de
 147: 4478+7	256A  1A      		ld 	a,(de)
 148: 4485+4	256B  67      		ld 	h,a
 149: 4489+6	256C  13      		inc 	de
 150: 4495+4	256D  B5      		or 	l
 151: 4499+10	256E  CA7C25  		jp 	z,bios_not_found
 152:				
 153: 4509+11	2571  D5      		push 	de
 154: 4520+17	2572  CD7026  		call 	try_bios
 155: 4537+10	2575  D1      		pop 	de
 156:				
 157: 4547+10	2576  CA8525  		jp 	z,bios_found
 158:				
 159: 4557+10	2579  C36725  		jp 	chk_bios_lp
 160:				
 161:				
 162:     -	257C          	bios_not_found:
 163:				
 164: 4567+10	257C  21EC25  		ld 	hl,msgNOTFOUND
 165: 4577+17	257F  CDC222  		call 	PSTR
 166:					
 167:				; 	halt
 168:				
 169: 4594+10	2582  C33020  		jp 	force_subst
 170:				
 171:     -	2585          	bios_found:
 172: 4604+6	2585  2B      		dec 	hl
 173: 4610+7	2586  7E      		ld 	a,(hl)
 174: 4617+6	2587  23      		inc 	hl
 175: 4623+7	2588  FE50    		cp 	p_STOP
 176: 4630+10	258A  CA9425  		jp 	z,.found_cont
 177:				
 178: 4640+10	258D  217728  		ld 	hl,msg_StrangeHLAfterPatch
 179: 4650+17	2590  CDC222  		call 	PSTR
 180: 4667+4	2593  76      		halt
 181:				
 182:     -	2594          	.found_cont:
 183: 4671+11	2594  E5      		push 	hl 		;bios name
 184: 4682+10	2595  21E125  		ld 	hl,msgFOUND
 185: 4692+17	2598  CDC222  		call 	PSTR
 186: 4709+10	259B  E1      		pop 	hl
 187: 4719+17	259C  CDC222  		call 	PSTR
 188: 4736+10	259F  212526  		ld 	hl,msgCRLF
 189: 4746+17	25A2  CDC222  		call 	PSTR
 190:				
 191: 4763+16	25A5  2ABB25  		ld 	hl,(msg_warning)
 192: 4779+4	25A8  7D      		ld 	a,l
 193: 4783+4	25A9  B4      		or 	h
 194: 4787+10+7	25AA  C4C222  		call 	nz,PSTR
 195:				
 196: 4797+13	25AD  3AB825  		ld 	a,(flag_unsupported)
 197: 4810+4	25B0  B7      		or 	a
 198: 4814+10	25B1  C27C25  		jp 	nz,bios_not_found
 199:				
 200: 4824+17	25B4  CDD628  		call 	show_mount_info
 201:				
 202:				; 	halt
 203: 4841+10	25B7  C9      		ret
 204:				
 205:				; get_rom_version:
 206:				; ;opts1.1
 207:				; ; RAM:003B FF                       db 0FFh
 208:				; ;opts2.0
 209:				; ; RAM:003B 02                       db    2
 210:				; ; kontur
 211:				; ; RAM:003B 05                       dec     b
 212:				; ;kvant8 terminal 
 213:				; ; RAM:003B 00                       db    0
 214:				; ;kvant8 - tigris
 215:				; ; RAM:003B FF                       db 0FFh
 216:				
 217:				; ; RAM:050F EF F0 F4+msgOPTS:        text "KOI8-R", 'OPTS  1.1',0
 218:				; ; RAM:051B EF F0 F4+Logo1:          text "KOI8-R", 'OPTS  2.0',0 
 219:				; 	ld 	a,(0x003b)
 220:				; 	cp 	0xff
 221:				; 	jp 	z,.opts1
 222:				
 223:				; 	cp 	2
 224:				; 	jp 	z,.opts2
 225:				
 226:				; .opts1:
 227:				; 	ld 	a,'1'
 228:				; 	db 	0x21
 229:				; .opts2:
 230:				; 	ld 	a,'2'	
 231:				; 	ld 	(rom_version),a
 232:				; 	ret
 233:				
 234:				; rom_version:
 235:				; 	db 	0 	;1 - opts1, 2-opts2
 236:				
 237:				
 238:				
 239:     -	25B8          	flag_unsupported:
 240:     -	25B8  00      		db 	0
 241:     -	25B9          	flag_microdos:
 242:     -	25B9  00      		db 	0	
 243:     -	25BA          	flag_subbios:
 244:     -	25BA  00      		db 	0
 245:     -	25BB          	msg_warning:
 246:     -	25BB  0000    		dw 	0
 247:				
 248:				
 249:     -	25BD          	msgPATCHER:
 250:     -	25BD  0D0A4249		db 	0dh,0ah,'BIOS PATCHER V 1.52 by ESL 2014',0dh,0ah,0
	      4F532050
	      41544348
	      45522056
	      20312E35
	      32206279
	      2045534C
	      20323031
	      340D0A00
 251:     -	25E1          	msgFOUND:
 252:     -	25E1  44657465		db 	'Detected: ',0
	      63746564
	      3A2000
 253:     -	25EC          	msgNOTFOUND:
 254:     -	25EC  42494F53		db 	'BIOS Unsupported or Broken, '
	      20556E73
	      7570706F
	      72746564
	      206F7220
	      42726F6B
	      656E2C20
 255:     -	2608  1B36    		db 	01bh,'6'
 256:     -	260A  66616C6C		db 	'fallback to DEFAULT bios.'
	      6261636B
	      20746F20
	      44454641
	      554C5420
	      62696F73
	      2E
 257:     -	2623  1B37    		db 	01bh,'7'
 258:     -	2625          	msgCRLF:
 259:     -	2625  0D0A00  		db 	0dh,0ah,0
 260:				
 261:     -	2628          	msgREQ_OPTS:
 262:     -	2628  20212120		db 	' !! '
 263:     -	262C  1B36    		db 	01bh,'6'
 264:     -	262E  42494F53		db 	'BIOS require OPTS '
	      20726571
	      75697265
	      204F5054
	      5320
 265:     -	2640          	msgREQ_OPTS_digit:
 266:     -	2640  312E7820		db 	'1.x ROM'
	      524F4D
 267:     -	2647  1B37    		db 	01bh,'7'
 268:     -	2649  20616E64		db 	' and not compatible with current.'
	      206E6F74
	      20636F6D
	      70617469
	      626C6520
	      77697468
	      20637572
	      72656E74
	      2E
 269:     -	266A  0D0A    		db 	0dh,0ah
 270:     -	266C  00      		db 	0
 271:				
 272:     -	266D          	work_ptr:
 273:     -	266D  0000    		dw 	0;
 274:     -	266F          	patch_flag:
 275:     -	266F  00      		db 	0
 276:				
 277:				;проверит совпадает ли биос с табличкой
 278:				;на входе в HL табличка для биоса
 279:				;если совпало то HL укзывает на имя биоса
 280:     -	2670          	try_bios:
 281: 4851+16	2670  226D26  		ld 	(work_ptr),hl
 282:				
 283:					;check
 284: 4867+4	2673  AF      		xor 	a
 285: 4871+16	2674  2A6D26  		ld 	hl,(work_ptr)
 286: 4887+17	2677  CD2927  		call 	do_patch
 287: 4904+5+6	267A  C0      		ret nz
 288:				
 289:				; 	halt
 290:				
 291:					;скопировали резидент в дырку
 292:				
 293:					;preprare to PATCH
 294:				
 295:					;copy resident
 296:				
 297: 4909+13	267B  3AB925  		ld 	a,(flag_microdos)
 298: 4922+4	267E  B7      		or 	a
 299: 4926+10	267F  C2FB26  		jp 	nz,move_microdos_resident
 300:				
 301: 4936+13	2682  3ABA25  		ld 	a,(flag_subbios)
 302: 4949+7	2685  FE01    		cp 	1
 303: 4956+10	2687  CA9A26  		jp 	z,.cpmsubBios1
 304: 4966+7	268A  FE02    		cp 	2
 305: 4973+10	268C  CAAC26  		jp 	z,.cpmsubBios2
 306: 4983+7	268F  FE03    		cp 	3 			;no resident part
 307: 4990+10	2691  CABE26  		jp 	z,.cpmNoResident
 308:				
 309: 5000+10	2694  215428  		ld 	hl,msgUndefindedsubBios
 310: 5010+17	2697  CDC222  		call 	PSTR
 311:				; 	halt
 312:				
 313:				
 314:     -	269A          	.cpmsubBios1:
 315:				
 316: 5027+10	269A  21ACE8  		ld 	hl,_CPM1_res_DRIVE_TAB
 317: 5037+16	269D  22362A  		ld 	(drivetab_mount_info),hl
 318:				
 319: 5053+10	26A0  21DE2A  		ld 	hl,resident_cpm1
 320: 5063+10	26A3  11ACE8  		ld 	de,resident_cpm1_addr
 321: 5073+10	26A6  019701  		ld 	bc,resident_cpm1_len
 322:				
 323: 5083+10	26A9  C3BB26  		jp 	.subBiosldir
 324:				
 325:     -	26AC          	.cpmsubBios2:
 326: 5093+10	26AC  2106EA  		ld 	hl,_CPM2_res_DRIVE_TAB
 327: 5103+16	26AF  22362A  		ld 	(drivetab_mount_info),hl
 328:				
 329: 5119+10	26B2  21752C  		ld 	hl,resident_cpm2
 330: 5129+10	26B5  1106EA  		ld 	de,resident_cpm2_addr
 331: 5139+10	26B8  019701  		ld 	bc,resident_cpm2_len
 332:				
 333:     -	26BB          	.subBiosldir:
 334: 5149+17	26BB  CDCB28  		call	_p_ldir
 335:				
 336:     -	26BE          	.cpmNoResident:
 337: 5166+7	26BE  3E01    		ld 	a,1
 338: 5173+16	26C0  2A6D26  		ld 	hl,(work_ptr)
 339: 5189+17	26C3  CD2927  		call 	do_patch
 340:				
 341:				; 	halt
 342:				
 343: 5206+16	26C6  222727  		ld 	(hl_after_do_patch_patch),hl
 344:				
 345:					;если дисководов нет то диски C и D - эмулируемые
 346: 5222+13	26C9  3AE823  		ld 	a,(HW_FDC_PRESENT)
 347: 5235+4	26CC  B7      		or 	a
 348: 5239+10	26CD  C22227  		jp 	nz,patch_done
 349:				
 350:				
 351: 5249+13	26D0  3ABA25  		ld 	a,(flag_subbios)
 352: 5262+10	26D3  21ACE8  		ld 	hl,_CPM1_res_DRIVE_TAB
 353: 5272+7	26D6  FE01    		cp 	1
 354: 5279+10	26D8  CAE626  		jp 	z,.cpmRemapCD
 355:				
 356: 5289+10	26DB  2106EA  		ld 	hl,_CPM2_res_DRIVE_TAB
 357: 5299+7	26DE  FE02    		cp 	2
 358: 5306+10	26E0  CAE626  		jp 	z,.cpmRemapCD
 359:				
 360: 5316+10	26E3  C32227  		jp 	patch_done 	;no need to patch
 361:				
 362:				
 363:     -	26E6          	.cpmRemapCD:
 364:				
 365:				
 366: 5326+11	26E6  D5      		push 	de
 367: 5337+10	26E7  110400  		ld	de,2*2
 368: 5347+11	26EA  19      		add 	hl,de
 369: 5358+7	26EB  3E00    		ld 	a,0 ;0=use emu
 370:				
 371: 5365+7	26ED  5E      		ld 	e,(hl)
 372: 5372+6	26EE  23      		inc 	hl
 373: 5378+7	26EF  56      		ld 	d,(hl)
 374: 5385+6	26F0  23      		inc 	hl
 375: 5391+7	26F1  12      		ld 	(de),a 	;drive C - emu
 376:				
 377:				
 378: 5398+7	26F2  5E      		ld 	e,(hl)
 379: 5405+6	26F3  23      		inc 	hl
 380: 5411+7	26F4  56      		ld 	d,(hl)
 381: 5418+6	26F5  23      		inc 	hl
 382: 5424+7	26F6  12      		ld 	(de),a	;drive D - emu
 383:				
 384: 5431+10	26F7  D1      		pop 	de
 385:				
 386: 5441+10	26F8  C32227  		jp 	patch_done
 387:				
 388:     -	26FB          	move_microdos_resident:
 389:				
 390:				
 391: 5451+10	26FB  2102FA  		ld 	hl,md_res_DRIVE_TAB
 392: 5461+16	26FE  22362A  		ld 	(drivetab_mount_info),hl
 393:				
 394:					;microdos
 395: 5477+7	2701  3E5C    		ld 	a,0x5c
 396: 5484+13	2703  327FFA  		ld 	(SYSREG14),a
 397:				
 398: 5497+10	2706  210C2E  		ld 	hl,resident_md
 399: 5507+10	2709  1100FA  		ld 	de,resident_md_addr
 400: 5517+10	270C  011001  		ld 	bc,resident_md_len
 401: 5527+17	270F  CDCB28  		call	_p_ldir
 402:				
 403: 5544+7	2712  3E01    		ld 	a,1
 404: 5551+16	2714  2A6D26  		ld 	hl,(work_ptr)
 405: 5567+17	2717  CD2927  		call 	do_patch
 406: 5584+16	271A  222727  		ld 	(hl_after_do_patch_patch),hl
 407:				
 408: 5600+7	271D  3E14    		ld 	a,0x14
 409: 5607+13	271F  327FFF  		ld 	(SYSREG5C),a
 410:				
 411:				
 412:				; 	HALT
 413:     -	2722          	patch_done:
 414: 5620+16	2722  2A2727  		ld 	hl,(hl_after_do_patch_patch)
 415:				
 416: 5636+4	2725  AF      		xor 	a
 417: 5640+10	2726  C9      		ret
 418:     -	2727          	hl_after_do_patch_patch:
 419:     -	2727  0000    		dw 	0
 420:     -	2729          	do_patch:
 421: 5650+13	2729  326F26  		ld 	(patch_flag),a
 422:				
 423:     -	0000          		if DEBUG_TRACE_PATCHER
 451:					endif
 452:				
 453: 5663+7	272C  3E00    		ld 	a,0
 454: 5670+13	272E  32B925  		ld 	(flag_microdos),a
 455: 5683+13	2731  32BA25  		ld 	(flag_subbios),a
 456:				
 457:     -	2734          	patch_loop:
 458:				
 459: 5696+7	2734  7E      		ld 	a,(hl)
 460: 5703+6	2735  23      		inc 	hl
 461:     -	0000          		if DEBUG_TRACE_PATCHER
 474:					endif
 475:				
 476: 5709+7	2736  FE50    		cp 	p_STOP
 477: 5716+5+6	2738  C8      		ret 	z 	;FOUND
 478:				
 479:     -	2739          	B_CHK_PATCH:
 480: 5721+7	2739  FE52    		cp 	pB_CHK_PATCH
 481: 5728+10	273B  C25C27  		jp 	nz,B_CHK_MAYBE
 482:				
 483: 5738+17	273E  CDC628  		call 	fetch_dw_to_bc 	;BC addr
 484: 5755+11	2741  C5      		push 	bc
 485: 5766+17	2742  CDC828  		call 	fetch_db_to_b 	;b
 486:				
 487: 5783+4	2745  EB      		ex 	de,hl
 488: 5787+10	2746  E1      		pop 	hl
 489: 5797+7	2747  7E      		ld 	a,(hl)
 490: 5804+4	2748  EB      		ex 	de,hl 		;de - addr
 491:				
 492: 5808+4	2749  48      		ld 	c,b
 493:				
 494: 5812+17	274A  CDC828  		call 	fetch_db_to_b 	;b store
 495:				
 496: 5829+4	274D  B9      		cp 	c
 497: 5833+5+6	274E  C0      		ret 	nz
 498:				
 499:				
 500: 5838+13	274F  3A6F26  		ld 	a,(patch_flag)
 501: 5851+4	2752  B7      		or 	a
 502: 5855+10	2753  CA3427  		jp 	z,patch_loop
 503:				
 504: 5865+4	2756  EB      		ex 	de,hl
 505: 5869+7	2757  70      		ld 	(hl),b
 506: 5876+4	2758  EB      		ex 	de,hl
 507: 5880+10	2759  C33427  		jp 	patch_loop
 508:				
 509:				
 510:     -	275C          	B_CHK_MAYBE:
 511: 5890+7	275C  FE59    		cp 	pB_MAYBE_PATCH
 512: 5897+10	275E  C27A27  		jp 	nz,l_pW_CHK
 513:				
 514: 5907+17	2761  CDC628  		call 	fetch_dw_to_bc 	;BC addr
 515: 5924+11	2764  C5      		push 	bc
 516: 5935+17	2765  CDC828  		call 	fetch_db_to_b 	;b
 517:				
 518: 5952+4	2768  EB      		ex 	de,hl
 519: 5956+10	2769  E1      		pop 	hl
 520: 5966+7	276A  7E      		ld 	a,(hl)
 521: 5973+4	276B  EB      		ex 	de,hl 		;de - addr
 522:				
 523: 5977+4	276C  48      		ld 	c,b
 524:				
 525: 5981+17	276D  CDC828  		call 	fetch_db_to_b 	;b store
 526:				
 527: 5998+4	2770  B9      		cp 	c
 528: 6002+10	2771  C23427  		jp  	nz,patch_loop
 529:				
 530: 6012+4	2774  EB      		ex 	de,hl
 531: 6016+7	2775  70      		ld 	(hl),b
 532: 6023+4	2776  EB      		ex 	de,hl
 533: 6027+10	2777  C33427  		jp 	patch_loop
 534:				
 535:				
 536:     -	277A          	l_pW_CHK:
 537: 6037+7	277A  FE51    		cp 	pW_CHK_PATCH
 538: 6044+10	277C  C29F27  		jp 	nz,l_pW_STORE
 539:				
 540: 6054+17	277F  CDC628  		call 	fetch_dw_to_bc 	
 541: 6071+17	2782  CDAB28  		call 	store_bc_to_tmp
 542:				
 543: 6088+17	2785  CDC628  		call 	fetch_dw_to_bc 	;BC OLD value
 544:				
 545: 6105+17	2788  CDBD28  		call 	read_de_at_tmp 	;de - value
 546: 6122+17	278B  CDA328  		call 	cp_de_bc
 547:				
 548: 6139+17	278E  CDC628  		call 	fetch_dw_to_bc 	;bc NEW value
 549:				
 550: 6156+5+6	2791  C0      		ret 	nz
 551:				
 552: 6161+13	2792  3A6F26  		ld 	a,(patch_flag)
 553: 6174+4	2795  B7      		or 	a
 554: 6178+10	2796  CA3427  		jp 	z,patch_loop
 555:				
 556: 6188+17	2799  CDB428  		call 	store_bc_at_tmp
 557:				
 558: 6205+10	279C  C33427  		jp 	patch_loop
 559:				
 560:     -	279F          	l_pW_STORE:
 561: 6215+7	279F  FE54    		cp 	pW_STORE
 562: 6222+10	27A1  C2BC27  		jp 	nz,.pNotSupported
 563:				
 564:				
 565: 6232+17	27A4  CDC628  		call 	fetch_dw_to_bc 	;BC value
 566: 6249+11	27A7  C5      		push 	bc
 567:				
 568: 6260+17	27A8  CDC628  		call 	fetch_dw_to_bc 	
 569: 6277+17	27AB  CDAB28  		call 	store_bc_to_tmp
 570:				
 571: 6294+10	27AE  C1      		pop 	bc
 572:				
 573: 6304+13	27AF  3A6F26  		ld 	a,(patch_flag)
 574: 6317+4	27B2  B7      		or 	a
 575: 6321+10	27B3  CA3427  		jp 	z,patch_loop
 576:				
 577: 6331+17	27B6  CDB428  		call 	store_bc_at_tmp
 578:				
 579: 6348+10	27B9  C33427  		jp 	patch_loop
 580:				
 581:     -	27BC          	.pNotSupported:
 582: 6358+7	27BC  FE55    		cp 	pNotSupported
 583: 6365+10	27BE  C2CB27  		jp 	nz,.pSETFLAG_MICRODOS
 584:				
 585:				
 586: 6375+13	27C1  3A6F26  		ld 	a,(patch_flag)
 587: 6388+4	27C4  B7      		or 	a
 588: 6392+10	27C5  CA3427  		jp 	z,patch_loop
 589:				
 590: 6402+10	27C8  C31F28  		jp 	Unsupported	
 591:				
 592:     -	27CB          	.pSETFLAG_MICRODOS:
 593: 6412+7	27CB  FE56    		cp 	pSETFLAG_MICRODOS
 594: 6419+10	27CD  C2D827  		jp 	nz,.pSubBios
 595:				
 596:				; 	ld 	a,(patch_flag)
 597:				; 	or 	a
 598:				; 	jp 	z,patch_loop
 599:				
 600: 6429+7	27D0  3E01    		ld 	a,1
 601: 6436+13	27D2  32B925  		ld 	(flag_microdos),a
 602: 6449+10	27D5  C33427  		jp 	patch_loop
 603:				
 604:     -	27D8          	.pSubBios:
 605: 6459+7	27D8  FE5A    		cp 	pSubBios
 606: 6466+10	27DA  C2E527  		jp 	nz,.pREQUIRED_OPTS1
 607:				
 608: 6476+7	27DD  7E      		ld 	a,(hl)
 609: 6483+6	27DE  23      		inc 	hl
 610: 6489+13	27DF  32BA25  		ld 	(flag_subbios),a
 611: 6502+10	27E2  C33427  		jp 	patch_loop
 612:				
 613:     -	27E5          	.pREQUIRED_OPTS1:
 614: 6512+7	27E5  FE57    		cp 	pREQUIRED_OPTS1
 615: 6519+10	27E7  C2FE27  		jp 	nz,.pREQUIRED_OPTS2
 616:				
 617: 6529+13	27EA  3A6F26  		ld 	a,(patch_flag)
 618: 6542+4	27ED  B7      		or 	a
 619: 6546+10	27EE  CA3427  		jp 	z,patch_loop
 620:				
 621:				; 	ld 	a,(rom_version)
 622: 6556+13	27F1  3AE523  		ld 	a,(HW_ROM_OPTS_CLASS)
 623: 6569+7	27F4  FE01    		cp 	_HW_ROM_OPTS1
 624: 6576+10	27F6  CA3427  		jp 	z,patch_loop
 625:				
 626: 6586+7	27F9  3E31    		ld 	a,'1'
 627: 6593+10	27FB  C31428  		jp 	set_opts_warning
 628:				
 629:				; 	jp 	patch_loop
 630:				
 631:     -	27FE          	.pREQUIRED_OPTS2:
 632: 6603+7	27FE  FE58    		cp 	pREQUIRED_OPTS2
 633: 6610+10	2800  C22728  		jp 	nz,.pHALT
 634:				
 635: 6620+13	2803  3A6F26  		ld 	a,(patch_flag)
 636: 6633+4	2806  B7      		or 	a
 637: 6637+10	2807  CA3427  		jp 	z,patch_loop
 638:				
 639:				; 	ld 	a,(rom_version)
 640: 6647+13	280A  3AE523  		ld 	a,(HW_ROM_OPTS_CLASS)
 641: 6660+7	280D  FE02    		cp 	_HW_ROM_OPTS2
 642: 6667+10	280F  CA3427  		jp 	z,patch_loop
 643:				
 644: 6677+7	2812  3E32    		ld 	a,'2'
 645:				
 646:     -	2814          	set_opts_warning:
 647: 6684+13	2814  324026  		ld 	(msgREQ_OPTS_digit),a
 648:				
 649: 6697+11	2817  E5      		push 	hl
 650: 6708+10	2818  212826  		ld 	hl,msgREQ_OPTS
 651: 6718+16	281B  22BB25  		ld 	(msg_warning),hl
 652: 6734+10	281E  E1      		pop 	hl
 653:				
 654:     -	281F          	Unsupported:
 655: 6744+7	281F  3E01    		ld 	a,1
 656: 6751+13	2821  32B825  		ld 	(flag_unsupported),a
 657: 6764+10	2824  C33427  		jp 	patch_loop
 658:				
 659:     -	2827          	.pHALT:
 660: 6774+10	2827  212F28  		ld 	hl,msg_InvalidPatchCode
 661: 6784+17	282A  CDC222  		call 	PSTR
 662:				
 663: 6801+4	282D  76      		halt
 664:				
 665: 6805+10	282E  C9      		ret
 666:				
 667:     -	282F          	msg_InvalidPatchCode:
 668:     -	282F  496E7661		db 	'Invalid patchcode, check registers',0dh,0ah,0
	      6C696420
	      70617463
	      68636F64
	      652C2063
	      6865636B
	      20726567
	      69737465
	      72730D0A
	      00
 669:     -	2854          	msgUndefindedSubBios:
 670:     -	2854  43502F4D		db 	'CP/M subbios not defined, halted',0dh,0ah,0
	      20737562
	      62696F73
	      206E6F74
	      20646566
	      696E6564
	      2C206861
	      6C746564
	      0D0A00
 671:     -	2877          	msg_StrangeHLAfterPatch:
 672:     -	2877  496E7661		db 	'Invalid HL after patch, no p_STOP before!',0dh,0ah,0
	      6C696420
	      484C2061
	      66746572
	      20706174
	      63682C20
	      6E6F2070
	      5F53544F
	      50206265
	      666F7265
	      210D0A00
 673:     -	28A3          	cp_de_bc:
 674: 6815+4	28A3  7B      		ld 	a,e
 675: 6819+4	28A4  B9      		cp 	c
 676: 6823+5+6	28A5  C0      		ret 	nz
 677: 6828+4	28A6  7A      		ld 	a,d
 678: 6832+4	28A7  B8      		cp 	b
 679: 6836+10	28A8  C9      		ret
 680:				
 681:     -	28A9  0000    	tmp: 	dw 	0
 682:				
 683:				;stor bc to tmp
 684:     -	28AB          	store_bc_to_tmp:
 685: 6846+4	28AB  79      		ld 	a,c
 686: 6850+13	28AC  32A928  		ld 	(tmp),a
 687:				
 688: 6863+4	28AF  78      		ld 	a,b
 689: 6867+13	28B0  32AA28  		ld 	(tmp+1),a
 690: 6880+10	28B3  C9      		ret
 691:				
 692:     -	28B4          	store_bc_at_tmp:
 693: 6890+11	28B4  E5      		push 	hl
 694: 6901+16	28B5  2AA928  		ld 	hl,(tmp)
 695: 6917+7	28B8  71      		ld 	(hl),c
 696: 6924+6	28B9  23      		inc 	hl
 697: 6930+7	28BA  70      		ld 	(hl),b
 698: 6937+10	28BB  E1      		pop 	hl
 699: 6947+10	28BC  C9      		ret
 700:				
 701:				;de - value at (tmp)
 702:     -	28BD          	read_de_at_tmp:
 703: 6957+11	28BD  E5      		push 	hl
 704: 6968+16	28BE  2AA928  		ld 	hl,(tmp)
 705:				
 706: 6984+7	28C1  5E      		ld 	e,(hl)
 707: 6991+6	28C2  23      		inc 	hl
 708: 6997+7	28C3  56      		ld 	d,(hl)
 709:				
 710: 7004+10	28C4  E1      		pop 	hl
 711: 7014+10	28C5  C9      		ret
 712:				
 713:				
 714:     -	28C6          	fetch_dw_to_bc:
 715: 7024+7	28C6  4E      		ld 	c,(hl)
 716: 7031+6	28C7  23      		inc 	hl
 717:     -	28C8          	fetch_db_to_b:
 718: 7037+7	28C8  46      		ld 	b,(hl)
 719: 7044+6	28C9  23      		inc 	hl
 720: 7050+10	28CA  C9      		ret
 721:				
 722:     -	28CB          	_p_ldir:
 723: 7060+7	28CB  7E      		ld 	a,(hl)
 724: 7067+7	28CC  12      		ld 	(de),a
 725: 7074+6	28CD  23      		inc 	hl
 726: 7080+6	28CE  13      		inc 	de
 727: 7086+6	28CF  0B      		dec 	bc
 728: 7092+4	28D0  79      		ld 	a,c
 729: 7096+4	28D1  B0      		or 	b
 730: 7100+10	28D2  C2CB28  		jp 	nz,_p_ldir
 731: 7110+10	28D5  C9      		ret
 732:				
 733:					include 	"mount_info.asm"
**** mount_info.asm ****
   1:     -	0080          	API_GET_MOUNT_NAME	EQU	0x80
   2:     -	0082          	API_GET_MOUNT_STATUS 	EQU	0x82
   3:				
   4:				; x123:
   5:				; 	db 0dh,0ah
   6:				; 	db '0         1         2         3         4         5         6   '
   7:				; 	db '0123456789012345678901234567890123456789012345678901234567890123'
   8:				; 	db 0
   9:     -	28D6          	show_mount_info:
  10:				
  11: 7120+10	28D6  21382A  		ld 	hl,msg_default_mount
  12: 7130+17	28D9  CDC222  		call 	PSTR
  13:					
  14: 7147+7	28DC  3E00    		ld 	a,0
  15: 7154+17	28DE  CDFC28  		call 	show_mount_drive
  16:				
  17: 7171+7	28E1  3E01    		ld 	a,1
  18: 7178+17	28E3  CDFC28  		call 	show_mount_drive
  19:				
  20: 7195+7	28E6  3E02    		ld 	a,2
  21: 7202+17	28E8  CDFC28  		call 	show_mount_drive
  22:				
  23: 7219+7	28EB  3E03    		ld 	a,3
  24: 7226+17	28ED  CDFC28  		call 	show_mount_drive
  25:				
  26:				; 	ld 	hl,mount_crlf
  27:				; 	call 	PSTR
  28:				
  29:					;show info about drive F 	
  30: 7243+13	28F0  3AB925  		ld 	a,(flag_microdos)
  31: 7256+4	28F3  B7      		or 	a
  32: 7260+5+6	28F4  C0      		ret 	nz	
  33:				
  34: 7265+10	28F5  219F2A  		ld 	hl,msgDRIVE_F
  35: 7275+17	28F8  CDC222  		call 	PSTR
  36:				
  37: 7292+10	28FB  C9      		ret
  38:				
  39:     -	28FC          	show_mount_drive:
  40: 7302+13	28FC  32E422  		ld 	(DRV),a
  41:				
  42: 7315+7	28FF  3E00    		ld 	a,0
  43: 7322+13	2901  327E2A  		ld 	(drive_rw_status),a
  44:				
  45: 7335+17	2904  CD8829  		call 	get_drvinfo_ptr
  46: 7352+10	2907  CA5E29  		jp 	z,skip_disk 	;de=0, no drive at all
  47:				
  48: 7362+7	290A  1A      		ld 	a,(de)
  49: 7369+4	290B  B7      		or 	a
  50: 7373+10	290C  C21B29  		jp 	nz,.physical_drive
  51:				
  52: 7383+17	290F  CD1F2A  		call 	get_mount_info
  53: 7400+17	2912  CD5F29  		call 	build_disk_name
  54: 7417+17	2915  CDBD29  		call 	build_emu_name
  55:				
  56: 7434+10	2918  C35329  		jp 	show_disk_info
  57:				
  58:     -	291B          	.physical_drive:
  59:				
  60: 7444+11	291B  F5      		push 	af
  61: 7455+17	291C  CD5F29  		call 	build_disk_name
  62: 7472+10	291F  F1      		pop 	af
  63:				
  64: 7482+7	2920  0E41    		ld 	c,'A'
  65: 7489+7	2922  FE01    		cp 	0001b
  66: 7496+10	2924  CA4229  		jp 	z,fdd_found
  67: 7506+7	2927  0E42    		ld 	c,'B'
  68: 7513+7	2929  FE02    		cp 	0010b
  69: 7520+10	292B  CA4229  		jp 	z,fdd_found
  70: 7530+7	292E  0E43    		ld 	c,'C'
  71: 7537+7	2930  FE04    		cp 	0100b
  72: 7544+10	2932  CA4229  		jp 	z,fdd_found
  73: 7554+7	2935  0E44    		ld 	c,'D'
  74: 7561+7	2937  FE08    		cp 	1000b
  75: 7568+10	2939  CA4229  		jp 	z,fdd_found
  76:				
  77: 7578+10	293C  21742A  		ld 	hl,msg_fdd_err
  78: 7588+10	293F  C34929  		jp 	.cpfddname
  79:				
  80:     -	2942          	fdd_found:
  81: 7598+4	2942  79      		ld 	a,c
  82: 7602+13	2943  32722A  		ld 	(msg_fdd_drv),a
  83:				
  84: 7615+10	2946  216B2A  		ld 	hl,msg_fdd
  85:				
  86:     -	2949          	.cpfddname
  87:				
  88: 7625+10	2949  114A2A  		ld 	de,out_buffer
  89: 7635+7	294C  0E20    		ld 	c,32
  90: 7642+7	294E  060E    		ld 	b,14
  91: 7649+17	2950  CDE029  		call 	append_z
  92:				
  93:     -	2953          	show_disk_info:
  94:				
  95: 7666+10	2953  214A2A  		ld 	hl,out_buffer
  96: 7676+7	2956  0E21    		ld 	c,32+1
  97: 7683+17	2958  CD042A  		call 	fix_width
  98: 7700+17	295B  CDC222  		call 	PSTR
  99:				
 100:				; 	ld 	hl,mount_crlf
 101:				; 	call 	PSTR
 102:				
 103:     -	295E          	skip_disk:
 104: 7717+10	295E  C9      		ret
 105:				
 106:     -	295F          	build_disk_name:
 107: 7727+4	295F  AF      		xor 	a
 108: 7731+13	2960  324A2A  		ld 	(out_buffer+00),a
 109:				; 	ld 	(out_buffer+32),a
 110:				
 111: 7744+13	2963  3AE422  		ld 	a,(DRV)
 112: 7757+7	2966  C641    		add 	a,'A'
 113: 7764+13	2968  32452A  		ld 	(mount_msg_drv),a
 114:				
 115: 7777+10	296B  015257  		ld 	bc,'RW'
 116: 7787+13	296E  3A7E2A  		ld 	a,(drive_rw_status)
 117: 7800+4	2971  B7      		or 	a
 118: 7804+4	2972  79      		ld 	a,c
 119: 7808+10	2973  C27729  		jp 	nz,.rw
 120: 7818+4	2976  78      		ld 	a,b
 121:     -	2977          	.rw:
 122: 7822+13	2977  32472A  		ld 	(mount_msg_rw),a
 123:				
 124:				;--
 125: 7835+10	297A  114A2A  		ld 	de,out_buffer
 126: 7845+10	297D  21452A  		ld 	hl,mount_msg
 127: 7855+7	2980  0E20    		ld 	c,32
 128: 7862+7	2982  060E    		ld 	b,14
 129: 7869+17	2984  CDE029  		call 	append_z
 130:				
 131: 7886+10	2987  C9      		ret
 132:				
 133:				;in (DRV)
 134:				;de - addr
 135:				;z=0 if de=0
 136:     -	2988          	get_drvinfo_ptr:
 137: 7896+11	2988  E5      		push 	hl
 138: 7907+13	2989  3AE422  		ld 	a,(DRV)
 139: 7920+4	298C  87      		add 	a,a
 140: 7924+4	298D  5F      		ld 	e,a
 141: 7928+7	298E  1600    		ld 	d,0
 142: 7935+16	2990  2A362A  		ld 	hl,(drivetab_mount_info)
 143:					
 144: 7951+4	2993  7C      		ld 	a,h
 145: 7955+4	2994  B5      		or 	l
 146: 7959+10	2995  CAA029  		jp 	z,errZeroDrvInfoTab
 147: 7969+11	2998  19      		add 	hl,de
 148: 7980+7	2999  5E      		ld 	e,(hl)
 149: 7987+6	299A  23      		inc 	hl
 150: 7993+7	299B  56      		ld 	d,(hl)
 151: 8000+4	299C  7B      		ld 	a,e
 152: 8004+4	299D  B2      		or 	d
 153: 8008+10	299E  E1      		pop 	hl
 154: 8018+10	299F  C9      		ret
 155:     -	29A0          	errZeroDrvInfoTab:
 156: 8028+10	29A0  21A729  		ld 	hl,msgZeroDrvInfoTab
 157: 8038+17	29A3  CDC222  		call 	PSTR
 158: 8055+4	29A6  76      		halt
 159:     -	29A7          	msgZeroDrvInfoTab:
 160:     -	29A7  53686F77		db 	'ShowInfo: DrvTab=0000',0
	      496E666F
	      3A204472
	      76546162
	      3D303030
	      3000
 161:				
 162:     -	29BD          	build_emu_name:
 163:				
 164: 8059+10	29BD  114A2A  		ld 	de,out_buffer
 165: 8069+7	29C0  0E20    		ld 	c,32
 166: 8076+7	29C2  060E    		ld 	b,14
 167:				
 168: 8083+10	29C4  217F2A  		ld 	hl,mount_info_from_emu+1
 169: 8093+17	29C7  CDE029  		call 	append_z
 170:					
 171: 8110+7	29CA  3E2F    		ld 	a,'/'
 172: 8117+7	29CC  12      		ld 	(de),a
 173: 8124+6	29CD  13      		inc 	de
 174: 8130+4	29CE  AF      		xor 	a
 175: 8134+7	29CF  12      		ld 	(de),a
 176:				
 177:				
 178: 8141+10	29D0  114A2A  		ld 	de,out_buffer
 179: 8151+10	29D3  218D2A  		ld 	hl,mount_info_from_emu+1+14
 180: 8161+7	29D6  0E20    		ld 	c,32
 181: 8168+7	29D8  060E    		ld 	b,14
 182: 8175+17	29DA  CDE029  		call 	append_z
 183:				
 184: 8192+4	29DD  AF      		xor 	a
 185: 8196+7	29DE  12      		ld 	(de),a
 186:				
 187: 8203+10	29DF  C9      		ret
 188:				
 189:				
 190:				
 191:				
 192:				;append (skip all not 0 and then copy_z)
 193:     -	29E0          	append_z:
 194: 8213+4	29E0  79      		ld 	a,c
 195: 8217+4	29E1  B7      		or 	a
 196: 8221+5+6	29E2  C8      		ret 	z
 197:				
 198: 8226+7	29E3  7E      		ld 	a,(hl)
 199: 8233+4	29E4  B7      		or 	a
 200: 8237+5+6	29E5  C8      		ret 	z
 201:				
 202:     -	29E6          	.skipAppend:
 203: 8242+7	29E6  1A      		ld 	a,(de)
 204: 8249+4	29E7  B7      		or 	a
 205: 8253+10	29E8  CAF329  		jp 	z,copy_z
 206: 8263+6	29EB  13      		inc 	de
 207: 8269+4	29EC  0D      		dec 	c
 208: 8273+10	29ED  CAF329  		jp 	z,copy_z	
 209:				
 210: 8283+10	29F0  C3E629  		jp 	.skipAppend
 211:				
 212:				;copy upto C char (or till 0) from HL to DE
 213:				;c - dstbuf sizw
 214:				;b - from buf size
 215:				;hl pointed to NULL terminated string
 216:				
 217:     -	29F3          	copy_z:
 218: 8293+4	29F3  79      		ld 	a,c	;to str size left =0
 219: 8297+4	29F4  B7      		or 	a
 220: 8301+5+6	29F5  C8      		ret 	z
 221:				
 222: 8306+4	29F6  78      		ld 	a,b 	;from str size left =0
 223: 8310+4	29F7  B7      		or 	a
 224: 8314+5+6	29F8  C8      		ret 	z
 225:				
 226: 8319+7	29F9  7E      		ld 	a,(hl)
 227: 8326+7	29FA  12      		ld 	(de),a
 228: 8333+4	29FB  B7      		or 	a
 229: 8337+5+6	29FC  C8      		ret 	z
 230:				; 	jp 	nz,.copy_z_store
 231:				; 	ld 	a,'_'
 232:				; .copy_z_store:
 233: 8342+6	29FD  23      		inc 	hl
 234: 8348+6	29FE  13      		inc 	de
 235: 8354+4	29FF  0D      		dec 	c
 236: 8358+4	2A00  05      		dec 	b
 237: 8362+10	2A01  C3F329  		jp 	copy_z
 238:				
 239:				;hl ptr
 240:				;c  len
 241:				;дополняет хвост строки пробелами делая её длинной len
 242:     -	2A04          	fix_width:
 243: 8372+4	2A04  79      		ld 	a,c
 244: 8376+4	2A05  B7      		or 	a
 245: 8380+5+6	2A06  C8      		ret 	z
 246:				
 247: 8385+11	2A07  E5      		push 	hl
 248:				
 249: 8396+6	2A08  2B      		dec 	hl
 250:     -	2A09          	.skipLP:	
 251: 8402+4	2A09  0D      		dec 	c
 252: 8406+10	2A0A  CA1D2A  		jp 	z,.endfill
 253: 8416+6	2A0D  23      		inc 	hl
 254: 8422+7	2A0E  7E      		ld 	a,(hl)
 255: 8429+4	2A0F  B7      		or 	a
 256: 8433+10	2A10  C2092A  		jp 	nz, .skipLP
 257:				
 258: 8443+7	2A13  3E20    		ld 	a,' '
 259:				
 260:     -	2A15          	.fillLoop:
 261: 8450+7	2A15  77      		ld 	(hl),a
 262: 8457+6	2A16  23      		inc 	hl
 263: 8463+4	2A17  0D      		dec 	c
 264: 8467+10	2A18  C2152A  		jp 	nz,.fillLoop
 265:				
 266: 8477+4	2A1B  AF      		xor 	a
 267: 8481+7	2A1C  77      		ld 	(hl),a 	;0
 268:     -	2A1D          	.endfill:
 269: 8488+10	2A1D  E1      		pop 	hl
 270: 8498+10	2A1E  C9      		ret
 271:				
 272:     -	2A1F          	get_mount_info:
 273: 8508+7	2A1F  3E80    		ld 	a,API_GET_MOUNT_NAME
 274: 8515+13	2A21  32E322  		ld 	(CMD),a
 275: 8528+17	2A24  CD8722  		call 	SENDCMD
 276:				
 277: 8545+7	2A27  0E1D    		ld 	c,29
 278:				
 279:     -	2A29          	receive_c_bytes_to_hl:
 280:				
 281: 8552+10	2A29  217E2A  		ld 	hl,mount_info_from_emu
 282:     -	2A2C          	get_lp:
 283: 8562+17	2A2C  CD2E22  		call 	GETBYTE
 284: 8579+7	2A2F  77      		ld 	(HL),a
 285: 8586+6	2A30  23      		inc 	hl
 286: 8592+4	2A31  0D      		dec 	c
 287: 8596+10	2A32  C22C2A  		jp 	nz,get_lp
 288: 8606+10	2A35  C9      		ret
 289:				
 290:				;GETBYTE:
 291:				; 	PUSH	HL
 292:				; 	LD	HL,PORTC
 293:				; WG:
 294:				; 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 295:				; 	AND	20h		; выделяем сигнал IBF
 296:				; 	JP	Z,WG		; IBF=0 - данных еще нет
 297:				; 	DEC	L
 298:				; 	DEC	L
 299:				; 	LD	A,(HL)		; данные поступили - выбираем их из порта А
 300:				; 	POP	HL
 301:				; 	RET
 302:				
 303:				
 304:     -	2A36          	drivetab_mount_info:
 305:     -	2A36  0000    			dw 	0
 306:				
 307:     -	2A38          	msg_default_mount:
 308:     -	2A38  44726976			db 	'Drive map:',0dh,0ah
	      65206D61
	      703A0D0A
 309:				;		db 	'          1         2         3         4         5         6   '
 310:				;		db 	'0123456789012345678901234567890123456789012345678901234567890123'
 311:     -	2A44  00      			db 	0
 312:     -	2A45          	mount_msg:	
 313:     -	2A45  413A    	mount_msg_drv: 	db 	'A:'
 314:     -	2A47  5720    	mount_msg_rw:	db 	'W '
 315:     -	2A49  00      			db 	0
 316:     -	2A4A          	out_buffer:
 317:     -	2A4A          			ds 	32
 318:     -	2A6A  00      			db 	0
 319:     -	2A6B          	msg_fdd:
 320:     -	2A6B  24464444			db	'$FDD - '
	      202D20
 321:     -	2A72  4100    	msg_fdd_drv:	db 	'A',0
 322:				
 323:     -	2A74          	msg_fdd_err:
 324:     -	2A74  3F3F4552			db 	'??ERROR??',0
	      524F523F
	      3F00
 325:				
 326:     -	2A7E          	mount_info_from_emu: 	
 327:     -	2A7E          	drive_rw_status:
 328:     -	2A7E  00      			db 	0 			;=1 if R/O
 329:     -	2A7F  20202020			db 	'              ' 	;Folder 14 asciiZ 
	      20202020
	      20202020
	      2020
 330:     -	2A8D  20202020			db 	'              ' 	;Name   14 asciiZ
	      20202020
	      20202020
	      2020
 331:     -	2A9B  00      			db 	0
 332:				
 333:     -	2A9C  0D0A00  	mount_crlf: 	db 	0dh,0ah,0	
 334:				
 335:     -	2A9F          	msgDRIVE_F:
 336:     -	2A9F  463A202D			db 	'F: - /EXRTOOLS.KDI with MOUNT and other EXTROM related utils'
	      202F4558
	      52544F4F
	      4C532E4B
	      44492077
	      69746820
	      4D4F554E
	      5420616E
	      64206F74
	      68657220
	      45585452
	      4F4D2072
	      656C6174
	      65642075
	      74696C73
 337:     -	2ADB  0D0A00  			db 	0x0d,0x0a,0
 338:				
 339:				; CMD:	DB	1		; Команда чтения
 340:				; DRV:	DB	0
 341:				; TRK:	DB	0
 342:				; SEC:	DB	0
 343:				
 344:				
 345:				; 80 — получить имя образа
 346:				
 347:				; Команда предназначена для получения имени KDI-файла, смонтированного в данный момент на логическом устройстве A-D.  
 348:				;  Номер устройства задается в поле DRV. Возвращается буфер размером 29 байт, содержащий следующую информацию:
 349:				
 350:				; 1 байт флага разрешение записи (0 — чтение/запись, 1 — только чтение)
 351:				; 14-байтовый буфер с именем каталога, из которого смонтирован файл образа, заканчивающийся 0.
 352:				; 14-байтовый буфер с именем файла, заканчивающийся 0.
 353:				
 354:				; 82 — проверка состояния устройства
 355:				; 	Команда возвращает ответ ОК, если устройство смонтировано, или Fail, если не смонтировано. 
 356:				; Флаг состояния автоматически опускается в случае ошибок ввода-вывода на данном устройстве. 
 357:				; С помощью этой команды можно проверить результат предыдущего вызова mount (81)
**** generator/V0/extrom-patcher.asm ****
 734:					include 	"extrom-patcher-resident-cpm-body.asm"
**** extrom-patcher-resident-cpm-body.asm ****
   1:     -	FB08          	rPORTA	EQU	0FB08H		; Порт Канала A интерфейса расширения
   2:     -	FB0A          	rPORTC	EQU	0FB0AH		; Порт Канала С интерфейса расширения
   3:     -	FB0B          	rPCWR	EQU	0FB0BH		; Порт управляющих команд
   4:				
   5:     -	FFFF          	_DSK 	EQU 	0xFFFF
   6:     -	FFFF          	_OPER 	EQU 	0xFFFF
   7:     -	FFFF          	_TRK 	EQU 	0xFFFF
   8:     -	FFFF          	_SEC 	EQU 	0xFFFF
   9:     -	FFFF          	_DMA 	EQU 	0xFFFF
  10:				
  11:     -	EE00          	_RRBUFF	EQU 	0xEE00
  12:				
  13:				cpm_resident_body 	macro	preffix
  14:				
  15:				;keyhook support removed 2014-10-22
  16:				;больше нет нужды в ней, т.к. есть диск F
  17:				; preffix&kbd_hook_noCtrl_03;
  18:				; 	ld 	(preffix&save_a),a
  19:				; 	cp 	0x03
  20:				; 	jp 	preffix&kbd_hook_noCtrl_chk
  21:				
  22:				; preffix&kbd_hook_noCtrl_33:
  23:				; 	ld 	(preffix&save_a),a
  24:				; 	cp 	0x33
  25:				
  26:				; preffix&kbd_hook_noCtrl_chk:
  27:				; 	jp 	nz,preffix&bios_hook
  28:				
  29:				; 	ld 	a,(0xf880)
  30:				; 	and 	00100001b
  31:				; 	cp 	00100001b
  32:				
  33:				; 	jp 	nz,preffix&bios_hook
  34:				
  35:				; 	jp 	preffix&do_key_action
  36:				
  37:				; preffix&kbd_hook_2133:
  38:				; 	ld 	(preffix&save_a),a
  39:				; 	ld 	a,c
  40:				; 	cp 	0x33 	;stop
  41:				; 	jp 	nz,preffix&bios_hook
  42:				
  43:				; 	ld 	a,b
  44:				; 	cp 	0x21 	;ctrl+stop
  45:				; 	jp 	nz,preffix&bios_hook
  46:				
  47:				; preffix&do_key_action:
  48:				; 	push 	hl
  49:				; 	push 	de
  50:				; 	push 	bc
  51:				; 	ld 	hl,preffix&msg_hook
  52:				; 	ld 	de,0xfc00
  53:				; preffix&.kmlp:	
  54:				; 	ld 	a,(hl)
  55:				; 	or 	a
  56:				; 	jp 	z,preffix&.kmlp_ext
  57:				; 	ld 	(de),a
  58:				; 	inc 	hl
  59:				; 	inc 	de
  60:				; 	jp 	preffix&.kmlp
  61:				
  62:				; preffix&.kmlp_ext:
  63:				; 	pop 	bc
  64:				; 	pop 	de
  65:				; 	pop 	hl
  66:				
  67:				; 	ld 	bc,0 	;simulate no key
  68:				; 	ld 	a,0
  69:				; 	jp 	preffix&old_hook
  70:				; ; 	halt
  71:				
  72:				
  73:				; preffix&bios_hook:
  74:				; 	ld 	a,(preffix&save_a)
  75:				
  76:				; preffix&old_hook:
  77:				; 	jp 	$
  78:				; preffix&save_a:
  79:				; 	db 	0	
  80:				; preffix&msg_hook:
  81:				; 	db 	'CTRL+SHIFT+STOP pressed',0
  82:				
  83:				;ptrs to drive drvreg bytes 
  84:				preffix&res_DRIVE_TAB:
  85:					dw 	0 	;A
  86:					dw 	0 	;B
  87:					dw 	0 	;C
  88:					dw 	0 	;D
  89:					dw 	0 	;E
  90:					dw 	0 	;F
  91:				
  92:				
  93:				preffix&dph_F:
  94:					dw	0	;_XLT:           
  95:					dw	0	;_1:             
  96:					dw	0	;_2:             
  97:					dw	0	;_3:             
  98:					dw	0xFC00	;DirBuf: value store here via patcher 0xfc00 - debug
  99:					dw	preffix&dpb_F	;DPB:   
 100:					dw	0	;CSV: - fixed drive   
 101:					dw	preffix&alw_F	;ALV:   
 102:				
 103:				
 104:				;  ФИЗИЧЕСКИЕ ПАРАМЕТРЫ ДИСКА
 105:				;--------------------------------------
 106:				      DB 50H	;контрольная сумма
 107:				
 108:				      DB 080H ;константа скорости движения головки.
 109:				;	; 3 - 30 мс на шаг, 2 - 20 мс, 1 - 12 мс,
 110:				;	; 0 - 6 мс и 80H - 3 мс.
 111:				      DB 05H  ; число физических секторов на дорожке
 112:				      DB 01H  ; информация о сторонах диска
 113:				;	;( 00 - односторонный диск
 114:				;	;  01 - двухсторонний диск
 115:				      DB 03	; 512 bytes/sector
 116:				;	;( 00 - 128 байт/сектор
 117:				;	;  01 - 256 байт/сектор
 118:				;	;  02 - 512 байт/сектор
 119:				;	;  03 - 1024 байт/сектор
 120:				      DB 0	; номер текущей дорожки.
 121:				      DB 0	; позиционный номер устройства (00000100) - для записи в регистр выбора
 122:				;---------------------------------------------------
 123:				      DB 0	;INFO	; флаг успешного считывания
 124:				
 125:				preffix&dpb_F:
 126:				; kdi params
 127:				      DW 40	;128 байтовых секторов/трек ; SPT
 128:				      DB 4	; размер блока миним.кбайт  ; BSH
 129:				;	; фактор сдвига блока распределения данных
 130:				;	; определяется размером блока данных. Блок 
 131:				;	; данных - минимально возможная частица файла.
 132:				;	; Размер блока - 1, 2, 4, 8 или 16 Кбайт. Если
 133:				;	; блок имеет большой размер, в каждом файле 
 134:				;	; теряется значительное число неиспользуемых
 135:				;	; секторов. При уменьшении размера блока
 136:				;	; увеличивается размер директории, описывающий
 137:				;	; расположение частей файла. BSH = log2[число
 138:				;	; логических секторов в блоке].
 139:				      DB 15	; число логических сек/блок  ; BLM
 140:				;	; маска блока распределения данных.
 141:				;	; BLM = (число логических секторов в блоке)-1.
 142:				      DB 0	; extent mask                ; EXM
 143:				;	; = (BLM+1)*128/1024 - 1 - [DSM/256]. EXM - 
 144:				;	; вспомогательная величина для определения
 145:				;	; номера extent'а.
 146:				;	; extent - часть файла, описываемая одним 
 147:				;	; входом в директорию.
 148:				      DW 394	; обьем диска в блоках-1     ; DSM
 149:				      DW 127	; входов в директорий-1      ; DRM
 150:				      DB 192	; определяет, какие блоки    ; AL0
 151:				;	; зарезервированы
 152:				      DB 0	; alloc 1                    ; AL1
 153:				;	; под директорию. Каждый  бит AL0,AL1, 
 154:				;	; начиная со старшего бита AL0 и кончая 
 155:				;	; младшим битом AL1, значением 1 резервирует
 156:				;	; один блок данных для директории. Нужно
 157:				;	; резервировать необходимое число блоков
 158:				;	; для хранения входов в директорию: 32*DRM/BLS
 159:				      DW 0	; размер вектора контроля директории. ; CKS
 160:				;	; CKS=(DRM+1)/4. Если диск не сменяем, CKS=0.
 161:				      DW 2	; число системных дорожек    ; OFS
 162:				
 163:				
 164:				; preffix&alw_F: 	ds 	50
 165:				preffix&alw_F: 	ds 	50
 166:				
 167:				
 168:				preffix&res_seldsk:
 169:					ld 	a,c
 170:					cp 	0xfe
 171:				preffix&old_seld_dsk:
 172:					jp 	nz,$	
 173:					ld 	hl,preffix&res_DRIVE_TAB
 174:					ret
 175:				
 176:				
 177:				;RAM:DA27 C3 EB DC                 jp      j_READ
 178:				
 179:				;RAM:DCEB          j_READ:                                 ; CODE XREF: RAM:_READj
 180:				;RAM:DCEB                                                  ; RAM:DB84p
 181:				;RAM:DCEB
 182:				;RAM:DCEB          ; FUNCTION CHUNK AT RAM:DDC4 SIZE 0000007B BYTES
 183:				;RAM:DCEB
 184:				;RAM:DCEB 3E 04                    ld      a, 4
 185:				;RAM:DCED 32 66 E0                 ld      (_OPERATION), a
 186:				;RAM:DCF0 3A 64 E0                 ld      a, (_DSK)
 187:				;RAM:DCF3 FE 04                    cp      4
 188:				;RAM:DCF5 CA C4 DD                 jp      z, loc_DDC4
 189:				
 190:				;сюда попадает из биоса JP READ
 191:				;а если не наше то прыгаем на старый read
 192:				preffix&res_READ:
 193:				; 	ld	 A,4	;Режим чтения
 194:				; 	ld  	(_OPER),a
 195:				preffix&r_p_DSK1:
 196:					ld 	a,(_DSK) 	;_DSK
 197:					cp 	4
 198:					jp 	z,preffix&_old_read
 199:				
 200:					cp 	5 		;disk F mapped to EMU drive E
 201:					jp 	nz,preffix&.r_no_drv_dec
 202:					dec 	a
 203:				
 204:				preffix&.r_no_drv_dec:
 205:					LD	(preffix&EXR_DRV),A	; # устройства
 206:				
 207:					push 	hl
 208:				preffix&r_p_SELDSKDRIVER:
 209:					ld 	hl,(0)	;EXR_SELDSK_DRIVE
 210:					ld 	a,(hl)
 211:					pop 	hl
 212:					or 	a
 213:					jp 	nz,preffix&_old_read
 214:				
 215:				preffix&r_p_TRK1:
 216:					LD	A,(_TRK)	
 217:					LD	(preffix&EXR_TRK),A	; дорожка
 218:				preffix&r_p_SEC1:
 219:					LD	A,(_SEC)	; сектор
 220:					DEC	A		; у нас номер сектора начинается с 0
 221:					LD	(preffix&EXR_SEC),A
 222:				
 223:					LD	A,1
 224:					LD	(preffix&EXR_CMD),A	; 1 - команда чтения
 225:				
 226:					CALL	preffix&EXR_SENDCMD	; отсылаем команду
 227:					DEC	A		; ответ, 0 - ошибка, 1 - ОК
 228:					RET	NZ		; 0 - ошибка
 229:				preffix&r_p_DMA1:
 230:					LD	HL,(_DMA)	; адрес буфера для приема данных
 231:					CALL	preffix&EXR_GETSEC	; принимаем данные
 232:					XOR	A		; завершение всегда успешно
 233:					RET
 234:				;
 235:				
 236:				preffix&_old_read:
 237:					jp 	$
 238:				
 239:				preffix&res_WRITE:
 240:				; 	ld	 A,6	;Режим чтения
 241:				; 	ld  	(_OPER),a
 242:				
 243:				preffix&r_p_DSK2:
 244:					ld 	a,(_DSK) 	;_DSK
 245:					cp 	4
 246:					jp 	z,preffix&_old_write
 247:					cp 	5 		;disk F mapped to EMU drive E
 248:					jp 	nz,preffix&.w_no_drv_dec
 249:					dec 	a
 250:				preffix&.w_no_drv_dec:
 251:					LD	(preffix&EXR_DRV),A
 252:				
 253:				
 254:					push 	hl
 255:				preffix&r_p_SELDSKDRIVEW:
 256:					ld 	hl,(0)	;EXR_SELDSK_DRIVE
 257:					ld 	a,(hl)
 258:					pop 	hl
 259:					or 	a
 260:					jp 	nz,preffix&_old_write
 261:				
 262:				preffix&r_p_TRK2:
 263:					LD	A,(_TRK)
 264:					LD	(preffix&EXR_TRK),A
 265:				preffix&r_p_SEC2:
 266:					LD	A,(_SEC)
 267:					DEC	A
 268:					LD	(preffix&EXR_SEC),A
 269:				
 270:					LD	A,2		; 2 - команда записи
 271:					LD	(preffix&EXR_CMD),A
 272:				
 273:					CALL	preffix&EXR_SENDCMD
 274:					DEC	A		; ответ, 0 - ошибка, 1 - ОК
 275:					RET	NZ		; 0 - ошибка
 276:				preffix&r_p_DMA2:
 277:					LD	HL,(_DMA)
 278:					CALL	preffix&EXR_PUTSEC
 279:					XOR	A		; запись успешна
 280:					RET
 281:				
 282:				preffix&_old_write:
 283:					jp 	$
 284:				
 285:				
 286:				preffix&res_GETINFO:
 287:				
 288:					LD 	A,(HL)	; A= маска выбора привода
 289:					or 	a
 290:					jp 	nz,preffix&_old_getinfo 	;=0 if emulated
 291:				
 292:				;
 293:				;  Чтение с эмулируемых дисков A или B
 294:				;
 295:					push 	hl
 296:					CALL	preffix&EXR_READINFO
 297:					DEC	A		; ответ, 0 - ошибка, 1 - ОК
 298:				; 	JP	NZ,0xE6ff	;IERR		; 0 - ошибка
 299:				preffix&_old_getinfo_chkdo:
 300:					JP	$ 		;IERR jnz xxx, CHKDO
 301:				; ;
 302:				preffix&_old_getinfo:
 303:					jp 	$ 		;GETINFO
 304:				
 305:				
 306:				;==================  Драйвер ExtROM-API ====================================
 307:					
 308:					
 309:				;****************************************
 310:				;*  Прием байта из порта А по стробу    *
 311:				;****************************************
 312:				preffix&EXR_GETBYTE:
 313:					PUSH	HL
 314:					LD	HL,rPORTC
 315:				preffix&pWG:
 316:					LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 317:					AND	20h		; выделяем сигнал IBF
 318:					JP	Z,preffix&pWG		; IBF=0 - данных еще нет
 319:					LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
 320:					POP	HL
 321:					RET
 322:				
 323:				;****************************************
 324:				;*  Отправка байта в порт A             *
 325:				;****************************************
 326:				preffix&EXR_PUTBYTE:
 327:					PUSH	HL
 328:					PUSH	AF
 329:					LD	HL,rPORTC
 330:				preffix&pWP:
 331:					LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 332:					AND	80h		; выделяем сигнал -OBF
 333:					JP	Z,preffix&pWP		; -OBF=0 - в передатчике сидит незабранный байт
 334:					POP	AF
 335:					LD	(rPORTA),A		; данные поступили - выбираем их из порта А
 336:					POP	HL
 337:					RET
 338:				
 339:				;*******************************************
 340:				;*      Прием сектора                      *
 341:				;* HL - адрес размещения сектора в памяти  *
 342:				;*  Размер сектора - 128 байт              *
 343:				;*******************************************
 344:				preffix&EXR_GETSEC:
 345:					di
 346:					PUSH	BC
 347:					PUSH	DE
 348:					LD	C,128		; счетчик байтов сектора, всего 128 байт
 349:					EX	DE,HL		; адрес буфера -> DE
 350:					LD	HL,rPORTC
 351:				preffix&pGSL:
 352:					LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 353:					AND	20h		; выделяем сигнал IBF
 354:					JP	Z,preffix&pGSL		; IBF=0 - данных еще нет
 355:					LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
 356:					LD	(DE),A		; принимаем и размещаем очередной байт
 357:					INC	DE		; указатель буфера ++
 358:					DEC	C		; принимаем остальные байты
 359:					JP	NZ,preffix&pGSL
 360:					POP	DE
 361:					POP	BC
 362:				; 	ei - int should be still disabled 
 363:					RET
 364:				
 365:				;*******************************************
 366:				;*      Передача сектора                   *
 367:				;* HL - адрес размещения сектора в памяти  *
 368:				;*  Размер сектора - 128 байт              *
 369:				;*******************************************
 370:				preffix&EXR_PUTSEC:
 371:					di
 372:					PUSH	BC
 373:					PUSH	DE
 374:					LD	C,128		; счетчик байтов сектора, всего 128 байт
 375:					EX	DE,HL		; адрес буфера -> DE
 376:					LD	HL,rPORTC
 377:				preffix&pPSL:
 378:					LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 379:					AND	80h		; выделяем сигнал -OBF
 380:					JP	Z,preffix&pPSL		; -OBF=0 - в передатчике сидит незабранный байт
 381:					LD	A,(DE)		; принимаем и размещаем очередной байт
 382:					LD	(rPORTA),A		; данные поступили - выбираем их из порта А
 383:					INC	DE
 384:					DEC	C		; принимаем остальные байты
 385:					JP	NZ,preffix&pPSL
 386:					POP	DE
 387:					POP	BC
 388:				; 	ei - int should be still disabled 
 389:					RET
 390:				
 391:				;****************************************
 392:				;*     Отправка командного пакета       *
 393:				;****************************************
 394:				preffix&EXR_SENDCMD:
 395:				
 396:					di
 397:					PUSH	HL
 398:					PUSH	BC
 399:					LD	A,0Ch
 400:					LD	(rPCWR),A	; переключаем порт в режим 2
 401:					LD	HL,preffix&EXR_CMD
 402:					LD	C,4		; пакет - 4 байта
 403:					LD	B,0		; заготовка контрольной суммы
 404:				preffix&pSCL:
 405:					LD	A,(HL)		; очередной байт пакета 
 406:					ADD 	B		; добавляем к КС
 407:					LD	B,A
 408:					LD	A,(HL)		; очередной байт пакета 
 409:					CALL	preffix&EXR_PUTBYTE		; - в порт
 410:					INC	HL
 411:					DEC	C
 412:					JP	NZ,preffix&pSCL
 413:					LD	A,B
 414:					DEC 	A		; КС-1
 415:					CALL	preffix&EXR_PUTBYTE     ; контрольная сумма
 416:					CALL	preffix&EXR_GETBYTE	; ответ контроллера
 417:					POP	BC
 418:					POP	HL
 419:				; 	ei - int should be still disabled 
 420:					RET
 421:				
 422:				;*******************************************
 423:				;*  Чтение информационного сектора
 424:				;*******************************************
 425:				preffix&EXR_READINFO:
 426:					LD	HL,preffix&EXR_CMD	; командный пакет
 427:					LD	(HL),1		; команда чтения
 428:					INC	HL
 429:				preffix&r_p_DSK3:
 430:					LD	A,(_DSK)	; вписываем # устройства
 431:					LD	(HL),A
 432:					INC	HL
 433:					LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
 434:					INC	HL
 435:					LD	(HL),0		
 436:					CALL	preffix&EXR_SENDCMD	; отправляем команду
 437:					OR	A
 438:					RET 	Z		; ошибка
 439:					LD	HL,_RRBUFF	; принимаем данные
 440:					CALL	preffix&EXR_GETSEC
 441:					LD	A,1
 442:					RET
 443:				
 444:				
 445:				; Командный пакет интерфейса Extrom-API
 446:				;===============================================
 447:				preffix&EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
 448:				preffix&EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
 449:				preffix&EXR_TRK:	DB	0	; логическая дорожка
 450:				preffix&EXR_SEC:	DB	0	; логический сектор (128b)
 451:				
**** generator/V0/extrom-patcher.asm ****
 735:					endm
 736:					include 	"extrom-patcher-resident-cpm1.asm"
**** extrom-patcher-resident-cpm1.asm ****
   1:					;    12_87_11_niijaf
   2:					;     E8AC-EBA6  = 762 
   3:					;     
   4:				
   5:     -	2ADE          	resident_cpm1	equ $
   6:				
   7:     -	E8AC          		.phase 0xE8AC
   8:				
   9:     -	E8AC          	resident_cpm1_addr 	EQU 	$
  10:				
  11:     -	E8AC          		cpm_resident_body _cpm1_
  11:				
  11:				;keyhook support removed 2014-10-22
  11:				;больше нет нужды в ней, т.к. есть диск F
  11:				; preffix&kbd_hook_noCtrl_03;
  11:				; 	ld 	(preffix&save_a),a
  11:				; 	cp 	0x03
  11:				; 	jp 	preffix&kbd_hook_noCtrl_chk
  11:				
  11:				; preffix&kbd_hook_noCtrl_33:
  11:				; 	ld 	(preffix&save_a),a
  11:				; 	cp 	0x33
  11:				
  11:				; preffix&kbd_hook_noCtrl_chk:
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; 	ld 	a,(0xf880)
  11:				; 	and 	00100001b
  11:				; 	cp 	00100001b
  11:				
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; 	jp 	preffix&do_key_action
  11:				
  11:				; preffix&kbd_hook_2133:
  11:				; 	ld 	(preffix&save_a),a
  11:				; 	ld 	a,c
  11:				; 	cp 	0x33 	;stop
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; 	ld 	a,b
  11:				; 	cp 	0x21 	;ctrl+stop
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; preffix&do_key_action:
  11:				; 	push 	hl
  11:				; 	push 	de
  11:				; 	push 	bc
  11:				; 	ld 	hl,preffix&msg_hook
  11:				; 	ld 	de,0xfc00
  11:				; preffix&.kmlp:	
  11:				; 	ld 	a,(hl)
  11:				; 	or 	a
  11:				; 	jp 	z,preffix&.kmlp_ext
  11:				; 	ld 	(de),a
  11:				; 	inc 	hl
  11:				; 	inc 	de
  11:				; 	jp 	preffix&.kmlp
  11:				
  11:				; preffix&.kmlp_ext:
  11:				; 	pop 	bc
  11:				; 	pop 	de
  11:				; 	pop 	hl
  11:				
  11:				; 	ld 	bc,0 	;simulate no key
  11:				; 	ld 	a,0
  11:				; 	jp 	preffix&old_hook
  11:				; ; 	halt
  11:				
  11:				
  11:				; preffix&bios_hook:
  11:				; 	ld 	a,(preffix&save_a)
  11:				
  11:				; preffix&old_hook:
  11:				; 	jp 	$
  11:				; preffix&save_a:
  11:				; 	db 	0	
  11:				; preffix&msg_hook:
  11:				; 	db 	'CTRL+SHIFT+STOP pressed',0
  11:				
  11:				;ptrs to drive drvreg bytes 
  11:     -	E8AC          	_cpm1_res_DRIVE_TAB:
  11:     -	E8AC  0000    		dw 	0 	;A
  11:     -	E8AE  0000    		dw 	0 	;B
  11:     -	E8B0  0000    		dw 	0 	;C
  11:     -	E8B2  0000    		dw 	0 	;D
  11:     -	E8B4  0000    		dw 	0 	;E
  11:     -	E8B6  0000    		dw 	0 	;F
  11:				
  11:				
  11:     -	E8B8          	_cpm1_dph_F:
  11:     -	E8B8  0000    		dw	0	;_XLT:           
  11:     -	E8BA  0000    		dw	0	;_1:             
  11:     -	E8BC  0000    		dw	0	;_2:             
  11:     -	E8BE  0000    		dw	0	;_3:             
  11:     -	E8C0  00FC    		dw	0xFC00	;DirBuf: value store here via patcher 0xfc00 - debug
  11:     -	E8C2  D0E8    		dw	_cpm1_dpb_F	;DPB:   
  11:     -	E8C4  0000    		dw	0	;CSV: - fixed drive   
  11:     -	E8C6  DFE8    		dw	_cpm1_alw_F	;ALV:   
  11:				
  11:				
  11:				;  ФИЗИЧЕСКИЕ ПАРАМЕТРЫ ДИСКА
  11:				;--------------------------------------
  11:     -	E8C8  50      	      DB 50H	;контрольная сумма
  11:				
  11:     -	E8C9  80      	      DB 080H ;константа скорости движения головки.
  11:				;	; 3 - 30 мс на шаг, 2 - 20 мс, 1 - 12 мс,
  11:				;	; 0 - 6 мс и 80H - 3 мс.
  11:     -	E8CA  05      	      DB 05H  ; число физических секторов на дорожке
  11:     -	E8CB  01      	      DB 01H  ; информация о сторонах диска
  11:				;	;( 00 - односторонный диск
  11:				;	;  01 - двухсторонний диск
  11:     -	E8CC  03      	      DB 03	; 512 bytes/sector
  11:				;	;( 00 - 128 байт/сектор
  11:				;	;  01 - 256 байт/сектор
  11:				;	;  02 - 512 байт/сектор
  11:				;	;  03 - 1024 байт/сектор
  11:     -	E8CD  00      	      DB 0	; номер текущей дорожки.
  11:     -	E8CE  00      	      DB 0	; позиционный номер устройства (00000100) - для записи в регистр выбора
  11:				;---------------------------------------------------
  11:     -	E8CF  00      	      DB 0	;INFO	; флаг успешного считывания
  11:				
  11:     -	E8D0          	_cpm1_dpb_F:
  11:				; kdi params
  11:     -	E8D0  2800    	      DW 40	;128 байтовых секторов/трек ; SPT
  11:     -	E8D2  04      	      DB 4	; размер блока миним.кбайт  ; BSH
  11:				;	; фактор сдвига блока распределения данных
  11:				;	; определяется размером блока данных. Блок 
  11:				;	; данных - минимально возможная частица файла.
  11:				;	; Размер блока - 1, 2, 4, 8 или 16 Кбайт. Если
  11:				;	; блок имеет большой размер, в каждом файле 
  11:				;	; теряется значительное число неиспользуемых
  11:				;	; секторов. При уменьшении размера блока
  11:				;	; увеличивается размер директории, описывающий
  11:				;	; расположение частей файла. BSH = log2[число
  11:				;	; логических секторов в блоке].
  11:     -	E8D3  0F      	      DB 15	; число логических сек/блок  ; BLM
  11:				;	; маска блока распределения данных.
  11:				;	; BLM = (число логических секторов в блоке)-1.
  11:     -	E8D4  00      	      DB 0	; extent mask                ; EXM
  11:				;	; = (BLM+1)*128/1024 - 1 - [DSM/256]. EXM - 
  11:				;	; вспомогательная величина для определения
  11:				;	; номера extent'а.
  11:				;	; extent - часть файла, описываемая одним 
  11:				;	; входом в директорию.
  11:     -	E8D5  8A01    	      DW 394	; обьем диска в блоках-1     ; DSM
  11:     -	E8D7  7F00    	      DW 127	; входов в директорий-1      ; DRM
  11:     -	E8D9  C0      	      DB 192	; определяет, какие блоки    ; AL0
  11:				;	; зарезервированы
  11:     -	E8DA  00      	      DB 0	; alloc 1                    ; AL1
  11:				;	; под директорию. Каждый  бит AL0,AL1, 
  11:				;	; начиная со старшего бита AL0 и кончая 
  11:				;	; младшим битом AL1, значением 1 резервирует
  11:				;	; один блок данных для директории. Нужно
  11:				;	; резервировать необходимое число блоков
  11:				;	; для хранения входов в директорию: 32*DRM/BLS
  11:     -	E8DB  0000    	      DW 0	; размер вектора контроля директории. ; CKS
  11:				;	; CKS=(DRM+1)/4. Если диск не сменяем, CKS=0.
  11:     -	E8DD  0200    	      DW 2	; число системных дорожек    ; OFS
  11:				
  11:				
  11:				; preffix&alw_F: 	ds 	50
  11:     -	E8DF .. E910 00	_cpm1_alw_F: 	ds 	50
  11:				
  11:				
  11:     -	E911          	_cpm1_res_seldsk:
  11: 8616+4	E911  79      		ld 	a,c
  11: 8620+7	E912  FEFE    		cp 	0xfe
  11:     -	E914          	_cpm1_old_seld_dsk:
  11: 8627+10	E914  C214E9  		jp 	nz,$	
  11: 8637+10	E917  21ACE8  		ld 	hl,_cpm1_res_DRIVE_TAB
  11: 8647+10	E91A  C9      		ret
  11:				
  11:				
  11:				;RAM:DA27 C3 EB DC                 jp      j_READ
  11:				
  11:				;RAM:DCEB          j_READ:                                 ; CODE XREF: RAM:_READj
  11:				;RAM:DCEB                                                  ; RAM:DB84p
  11:				;RAM:DCEB
  11:				;RAM:DCEB          ; FUNCTION CHUNK AT RAM:DDC4 SIZE 0000007B BYTES
  11:				;RAM:DCEB
  11:				;RAM:DCEB 3E 04                    ld      a, 4
  11:				;RAM:DCED 32 66 E0                 ld      (_OPERATION), a
  11:				;RAM:DCF0 3A 64 E0                 ld      a, (_DSK)
  11:				;RAM:DCF3 FE 04                    cp      4
  11:				;RAM:DCF5 CA C4 DD                 jp      z, loc_DDC4
  11:				
  11:				;сюда попадает из биоса JP READ
  11:				;а если не наше то прыгаем на старый read
  11:     -	E91B          	_cpm1_res_READ:
  11:				; 	ld	 A,4	;Режим чтения
  11:				; 	ld  	(_OPER),a
  11:     -	E91B          	_cpm1_r_p_DSK1:
  11: 8657+13	E91B  3AFFFF  		ld 	a,(_DSK) 	;_DSK
  11: 8670+7	E91E  FE04    		cp 	4
  11: 8677+10	E920  CA55E9  		jp 	z,_cpm1__old_read
  11:				
  11: 8687+7	E923  FE05    		cp 	5 		;disk F mapped to EMU drive E
  11: 8694+10	E925  C229E9  		jp 	nz,_cpm1_.r_no_drv_dec
  11: 8704+4	E928  3D      		dec 	a
  11:				
  11:     -	E929          	_cpm1_.r_no_drv_dec:
  11: 8708+13	E929  3240EA  		LD	(_cpm1_EXR_DRV),A	; # устройства
  11:				
  11: 8721+11	E92C  E5      		push 	hl
  11:     -	E92D          	_cpm1_r_p_SELDSKDRIVER:
  11: 8732+16	E92D  2A0000  		ld 	hl,(0)	;EXR_SELDSK_DRIVE
  11: 8748+7	E930  7E      		ld 	a,(hl)
  11: 8755+10	E931  E1      		pop 	hl
  11: 8765+4	E932  B7      		or 	a
  11: 8769+10	E933  C255E9  		jp 	nz,_cpm1__old_read
  11:				
  11:     -	E936          	_cpm1_r_p_TRK1:
  11: 8779+13	E936  3AFFFF  		LD	A,(_TRK)	
  11: 8792+13	E939  3241EA  		LD	(_cpm1_EXR_TRK),A	; дорожка
  11:     -	E93C          	_cpm1_r_p_SEC1:
  11: 8805+13	E93C  3AFFFF  		LD	A,(_SEC)	; сектор
  11: 8818+4	E93F  3D      		DEC	A		; у нас номер сектора начинается с 0
  11: 8822+13	E940  3242EA  		LD	(_cpm1_EXR_SEC),A
  11:				
  11: 8835+7	E943  3E01    		LD	A,1
  11: 8842+13	E945  323FEA  		LD	(_cpm1_EXR_CMD),A	; 1 - команда чтения
  11:				
  11: 8855+17	E948  CDFBE9  		CALL	_cpm1_EXR_SENDCMD	; отсылаем команду
  11: 8872+4	E94B  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
  11: 8876+5+6	E94C  C0      		RET	NZ		; 0 - ошибка
  11:     -	E94D          	_cpm1_r_p_DMA1:
  11: 8881+16	E94D  2AFFFF  		LD	HL,(_DMA)	; адрес буфера для приема данных
  11: 8897+17	E950  CDC5E9  		CALL	_cpm1_EXR_GETSEC	; принимаем данные
  11: 8914+4	E953  AF      		XOR	A		; завершение всегда успешно
  11: 8918+10	E954  C9      		RET
  11:				;
  11:				
  11:     -	E955          	_cpm1__old_read:
  11: 8928+10	E955  C355E9  		jp 	$
  11:				
  11:     -	E958          	_cpm1_res_WRITE:
  11:				; 	ld	 A,6	;Режим чтения
  11:				; 	ld  	(_OPER),a
  11:				
  11:     -	E958          	_cpm1_r_p_DSK2:
  11: 8938+13	E958  3AFFFF  		ld 	a,(_DSK) 	;_DSK
  11: 8951+7	E95B  FE04    		cp 	4
  11: 8958+10	E95D  CA92E9  		jp 	z,_cpm1__old_write
  11: 8968+7	E960  FE05    		cp 	5 		;disk F mapped to EMU drive E
  11: 8975+10	E962  C266E9  		jp 	nz,_cpm1_.w_no_drv_dec
  11: 8985+4	E965  3D      		dec 	a
  11:     -	E966          	_cpm1_.w_no_drv_dec:
  11: 8989+13	E966  3240EA  		LD	(_cpm1_EXR_DRV),A
  11:				
  11:				
  11: 9002+11	E969  E5      		push 	hl
  11:     -	E96A          	_cpm1_r_p_SELDSKDRIVEW:
  11: 9013+16	E96A  2A0000  		ld 	hl,(0)	;EXR_SELDSK_DRIVE
  11: 9029+7	E96D  7E      		ld 	a,(hl)
  11: 9036+10	E96E  E1      		pop 	hl
  11: 9046+4	E96F  B7      		or 	a
  11: 9050+10	E970  C292E9  		jp 	nz,_cpm1__old_write
  11:				
  11:     -	E973          	_cpm1_r_p_TRK2:
  11: 9060+13	E973  3AFFFF  		LD	A,(_TRK)
  11: 9073+13	E976  3241EA  		LD	(_cpm1_EXR_TRK),A
  11:     -	E979          	_cpm1_r_p_SEC2:
  11: 9086+13	E979  3AFFFF  		LD	A,(_SEC)
  11: 9099+4	E97C  3D      		DEC	A
  11: 9103+13	E97D  3242EA  		LD	(_cpm1_EXR_SEC),A
  11:				
  11: 9116+7	E980  3E02    		LD	A,2		; 2 - команда записи
  11: 9123+13	E982  323FEA  		LD	(_cpm1_EXR_CMD),A
  11:				
  11: 9136+17	E985  CDFBE9  		CALL	_cpm1_EXR_SENDCMD
  11: 9153+4	E988  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
  11: 9157+5+6	E989  C0      		RET	NZ		; 0 - ошибка
  11:     -	E98A          	_cpm1_r_p_DMA2:
  11: 9162+16	E98A  2AFFFF  		LD	HL,(_DMA)
  11: 9178+17	E98D  CDE0E9  		CALL	_cpm1_EXR_PUTSEC
  11: 9195+4	E990  AF      		XOR	A		; запись успешна
  11: 9199+10	E991  C9      		RET
  11:				
  11:     -	E992          	_cpm1__old_write:
  11: 9209+10	E992  C392E9  		jp 	$
  11:				
  11:				
  11:     -	E995          	_cpm1_res_GETINFO:
  11:				
  11: 9219+7	E995  7E      		LD 	A,(HL)	; A= маска выбора привода
  11: 9226+4	E996  B7      		or 	a
  11: 9230+10	E997  C2A2E9  		jp 	nz,_cpm1__old_getinfo 	;=0 if emulated
  11:				
  11:				;
  11:				;  Чтение с эмулируемых дисков A или B
  11:				;
  11: 9240+11	E99A  E5      		push 	hl
  11: 9251+17	E99B  CD21EA  		CALL	_cpm1_EXR_READINFO
  11: 9268+4	E99E  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
  11:				; 	JP	NZ,0xE6ff	;IERR		; 0 - ошибка
  11:     -	E99F          	_cpm1__old_getinfo_chkdo:
  11: 9272+10	E99F  C39FE9  		JP	$ 		;IERR jnz xxx, CHKDO
  11:				; ;
  11:     -	E9A2          	_cpm1__old_getinfo:
  11: 9282+10	E9A2  C3A2E9  		jp 	$ 		;GETINFO
  11:				
  11:				
  11:				;==================  Драйвер ExtROM-API ====================================
  11:					
  11:					
  11:				;****************************************
  11:				;*  Прием байта из порта А по стробу    *
  11:				;****************************************
  11:     -	E9A5          	_cpm1_EXR_GETBYTE:
  11: 9292+11	E9A5  E5      		PUSH	HL
  11: 9303+10	E9A6  210AFB  		LD	HL,rPORTC
  11:     -	E9A9          	_cpm1_pWG:
  11: 9313+7	E9A9  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11: 9320+7	E9AA  E620    		AND	20h		; выделяем сигнал IBF
  11: 9327+10	E9AC  CAA9E9  		JP	Z,_cpm1_pWG		; IBF=0 - данных еще нет
  11: 9337+13	E9AF  3A08FB  		LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
  11: 9350+10	E9B2  E1      		POP	HL
  11: 9360+10	E9B3  C9      		RET
  11:				
  11:				;****************************************
  11:				;*  Отправка байта в порт A             *
  11:				;****************************************
  11:     -	E9B4          	_cpm1_EXR_PUTBYTE:
  11: 9370+11	E9B4  E5      		PUSH	HL
  11: 9381+11	E9B5  F5      		PUSH	AF
  11: 9392+10	E9B6  210AFB  		LD	HL,rPORTC
  11:     -	E9B9          	_cpm1_pWP:
  11: 9402+7	E9B9  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11: 9409+7	E9BA  E680    		AND	80h		; выделяем сигнал -OBF
  11: 9416+10	E9BC  CAB9E9  		JP	Z,_cpm1_pWP		; -OBF=0 - в передатчике сидит незабранный байт
  11: 9426+10	E9BF  F1      		POP	AF
  11: 9436+13	E9C0  3208FB  		LD	(rPORTA),A		; данные поступили - выбираем их из порта А
  11: 9449+10	E9C3  E1      		POP	HL
  11: 9459+10	E9C4  C9      		RET
  11:				
  11:				;*******************************************
  11:				;*      Прием сектора                      *
  11:				;* HL - адрес размещения сектора в памяти  *
  11:				;*  Размер сектора - 128 байт              *
  11:				;*******************************************
  11:     -	E9C5          	_cpm1_EXR_GETSEC:
  11: 9469+4	E9C5  F3      		di
  11: 9473+11	E9C6  C5      		PUSH	BC
  11: 9484+11	E9C7  D5      		PUSH	DE
  11: 9495+7	E9C8  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
  11: 9502+4	E9CA  EB      		EX	DE,HL		; адрес буфера -> DE
  11: 9506+10	E9CB  210AFB  		LD	HL,rPORTC
  11:     -	E9CE          	_cpm1_pGSL:
  11: 9516+7	E9CE  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11: 9523+7	E9CF  E620    		AND	20h		; выделяем сигнал IBF
  11: 9530+10	E9D1  CACEE9  		JP	Z,_cpm1_pGSL		; IBF=0 - данных еще нет
  11: 9540+13	E9D4  3A08FB  		LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
  11: 9553+7	E9D7  12      		LD	(DE),A		; принимаем и размещаем очередной байт
  11: 9560+6	E9D8  13      		INC	DE		; указатель буфера ++
  11: 9566+4	E9D9  0D      		DEC	C		; принимаем остальные байты
  11: 9570+10	E9DA  C2CEE9  		JP	NZ,_cpm1_pGSL
  11: 9580+10	E9DD  D1      		POP	DE
  11: 9590+10	E9DE  C1      		POP	BC
  11:				; 	ei - int should be still disabled 
  11: 9600+10	E9DF  C9      		RET
  11:				
  11:				;*******************************************
  11:				;*      Передача сектора                   *
  11:				;* HL - адрес размещения сектора в памяти  *
  11:				;*  Размер сектора - 128 байт              *
  11:				;*******************************************
  11:     -	E9E0          	_cpm1_EXR_PUTSEC:
  11: 9610+4	E9E0  F3      		di
  11: 9614+11	E9E1  C5      		PUSH	BC
  11: 9625+11	E9E2  D5      		PUSH	DE
  11: 9636+7	E9E3  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
  11: 9643+4	E9E5  EB      		EX	DE,HL		; адрес буфера -> DE
  11: 9647+10	E9E6  210AFB  		LD	HL,rPORTC
  11:     -	E9E9          	_cpm1_pPSL:
  11: 9657+7	E9E9  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11: 9664+7	E9EA  E680    		AND	80h		; выделяем сигнал -OBF
  11: 9671+10	E9EC  CAE9E9  		JP	Z,_cpm1_pPSL		; -OBF=0 - в передатчике сидит незабранный байт
  11: 9681+7	E9EF  1A      		LD	A,(DE)		; принимаем и размещаем очередной байт
  11: 9688+13	E9F0  3208FB  		LD	(rPORTA),A		; данные поступили - выбираем их из порта А
  11: 9701+6	E9F3  13      		INC	DE
  11: 9707+4	E9F4  0D      		DEC	C		; принимаем остальные байты
  11: 9711+10	E9F5  C2E9E9  		JP	NZ,_cpm1_pPSL
  11: 9721+10	E9F8  D1      		POP	DE
  11: 9731+10	E9F9  C1      		POP	BC
  11:				; 	ei - int should be still disabled 
  11: 9741+10	E9FA  C9      		RET
  11:				
  11:				;****************************************
  11:				;*     Отправка командного пакета       *
  11:				;****************************************
  11:     -	E9FB          	_cpm1_EXR_SENDCMD:
  11:				
  11: 9751+4	E9FB  F3      		di
  11: 9755+11	E9FC  E5      		PUSH	HL
  11: 9766+11	E9FD  C5      		PUSH	BC
  11: 9777+7	E9FE  3E0C    		LD	A,0Ch
  11: 9784+13	EA00  320BFB  		LD	(rPCWR),A	; переключаем порт в режим 2
  11: 9797+10	EA03  213FEA  		LD	HL,_cpm1_EXR_CMD
  11: 9807+7	EA06  0E04    		LD	C,4		; пакет - 4 байта
  11: 9814+7	EA08  0600    		LD	B,0		; заготовка контрольной суммы
  11:     -	EA0A          	_cpm1_pSCL:
  11: 9821+7	EA0A  7E      		LD	A,(HL)		; очередной байт пакета 
  11: 9828+4	EA0B  80      		ADD 	B		; добавляем к КС
  11: 9832+4	EA0C  47      		LD	B,A
  11: 9836+7	EA0D  7E      		LD	A,(HL)		; очередной байт пакета 
  11: 9843+17	EA0E  CDB4E9  		CALL	_cpm1_EXR_PUTBYTE		; - в порт
  11: 9860+6	EA11  23      		INC	HL
  11: 9866+4	EA12  0D      		DEC	C
  11: 9870+10	EA13  C20AEA  		JP	NZ,_cpm1_pSCL
  11: 9880+4	EA16  78      		LD	A,B
  11: 9884+4	EA17  3D      		DEC 	A		; КС-1
  11: 9888+17	EA18  CDB4E9  		CALL	_cpm1_EXR_PUTBYTE     ; контрольная сумма
  11: 9905+17	EA1B  CDA5E9  		CALL	_cpm1_EXR_GETBYTE	; ответ контроллера
  11: 9922+10	EA1E  C1      		POP	BC
  11: 9932+10	EA1F  E1      		POP	HL
  11:				; 	ei - int should be still disabled 
  11: 9942+10	EA20  C9      		RET
  11:				
  11:				;*******************************************
  11:				;*  Чтение информационного сектора
  11:				;*******************************************
  11:     -	EA21          	_cpm1_EXR_READINFO:
  11: 9952+10	EA21  213FEA  		LD	HL,_cpm1_EXR_CMD	; командный пакет
  11: 9962+10	EA24  3601    		LD	(HL),1		; команда чтения
  11: 9972+6	EA26  23      		INC	HL
  11:     -	EA27          	_cpm1_r_p_DSK3:
  11: 9978+13	EA27  3AFFFF  		LD	A,(_DSK)	; вписываем # устройства
  11: 9991+7	EA2A  77      		LD	(HL),A
  11: 9998+6	EA2B  23      		INC	HL
  11:10004+10	EA2C  3600    		LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
  11:10014+6	EA2E  23      		INC	HL
  11:10020+10	EA2F  3600    		LD	(HL),0		
  11:10030+17	EA31  CDFBE9  		CALL	_cpm1_EXR_SENDCMD	; отправляем команду
  11:10047+4	EA34  B7      		OR	A
  11:10051+5+6	EA35  C8      		RET 	Z		; ошибка
  11:10056+10	EA36  2100EE  		LD	HL,_RRBUFF	; принимаем данные
  11:10066+17	EA39  CDC5E9  		CALL	_cpm1_EXR_GETSEC
  11:10083+7	EA3C  3E01    		LD	A,1
  11:10090+10	EA3E  C9      		RET
  11:				
  11:				
  11:				; Командный пакет интерфейса Extrom-API
  11:				;===============================================
  11:     -	EA3F  00      	_cpm1_EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
  11:     -	EA40  00      	_cpm1_EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
  11:     -	EA41  00      	_cpm1_EXR_TRK:	DB	0	; логическая дорожка
  11:     -	EA42  00      	_cpm1_EXR_SEC:	DB	0	; логический сектор (128b)
  11:				
  11:     -	EA43          		endm
  12:				
  13:     -	2C75          		.dephase
  14:				
  15:     -	0197          	resident_cpm1_len 		equ	$-resident_cpm1
  16:				
  17:				; minimum hole_start .. min hole_end
  18:     -	02FA          	max_resident_cpm1_len 	equ 	0xEBA6-0xE8AC ;=762
  19:				
  20:     -	0163          	available_resident_cpm1_len	equ 	max_resident_cpm1_len-resident_cpm1_len
  21:				
  22:     -	0001          		.assert max_resident_cpm1_len>=resident_cpm1_len
**** generator/V0/extrom-patcher.asm ****
 737:					include 	"extrom-patcher-resident-cpm2.asm"
**** extrom-patcher-resident-cpm2.asm ****
   1:					;    12_87_11_niijaf
   2:					;  EA06-EDFD = 1015  
   3:					;
   4:					
   5:     -	2C75          	resident_cpm2	equ $
   6:				
   7:     -	EA06          		.phase 0xea06
   8:				
   9:     -	EA06          	resident_cpm2_addr 	EQU 	$
  10:				
  11:     -	EA06          		cpm_resident_body _cpm2_
  11:				
  11:				;keyhook support removed 2014-10-22
  11:				;больше нет нужды в ней, т.к. есть диск F
  11:				; preffix&kbd_hook_noCtrl_03;
  11:				; 	ld 	(preffix&save_a),a
  11:				; 	cp 	0x03
  11:				; 	jp 	preffix&kbd_hook_noCtrl_chk
  11:				
  11:				; preffix&kbd_hook_noCtrl_33:
  11:				; 	ld 	(preffix&save_a),a
  11:				; 	cp 	0x33
  11:				
  11:				; preffix&kbd_hook_noCtrl_chk:
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; 	ld 	a,(0xf880)
  11:				; 	and 	00100001b
  11:				; 	cp 	00100001b
  11:				
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; 	jp 	preffix&do_key_action
  11:				
  11:				; preffix&kbd_hook_2133:
  11:				; 	ld 	(preffix&save_a),a
  11:				; 	ld 	a,c
  11:				; 	cp 	0x33 	;stop
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; 	ld 	a,b
  11:				; 	cp 	0x21 	;ctrl+stop
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; preffix&do_key_action:
  11:				; 	push 	hl
  11:				; 	push 	de
  11:				; 	push 	bc
  11:				; 	ld 	hl,preffix&msg_hook
  11:				; 	ld 	de,0xfc00
  11:				; preffix&.kmlp:	
  11:				; 	ld 	a,(hl)
  11:				; 	or 	a
  11:				; 	jp 	z,preffix&.kmlp_ext
  11:				; 	ld 	(de),a
  11:				; 	inc 	hl
  11:				; 	inc 	de
  11:				; 	jp 	preffix&.kmlp
  11:				
  11:				; preffix&.kmlp_ext:
  11:				; 	pop 	bc
  11:				; 	pop 	de
  11:				; 	pop 	hl
  11:				
  11:				; 	ld 	bc,0 	;simulate no key
  11:				; 	ld 	a,0
  11:				; 	jp 	preffix&old_hook
  11:				; ; 	halt
  11:				
  11:				
  11:				; preffix&bios_hook:
  11:				; 	ld 	a,(preffix&save_a)
  11:				
  11:				; preffix&old_hook:
  11:				; 	jp 	$
  11:				; preffix&save_a:
  11:				; 	db 	0	
  11:				; preffix&msg_hook:
  11:				; 	db 	'CTRL+SHIFT+STOP pressed',0
  11:				
  11:				;ptrs to drive drvreg bytes 
  11:     -	EA06          	_cpm2_res_DRIVE_TAB:
  11:     -	EA06  0000    		dw 	0 	;A
  11:     -	EA08  0000    		dw 	0 	;B
  11:     -	EA0A  0000    		dw 	0 	;C
  11:     -	EA0C  0000    		dw 	0 	;D
  11:     -	EA0E  0000    		dw 	0 	;E
  11:     -	EA10  0000    		dw 	0 	;F
  11:				
  11:				
  11:     -	EA12          	_cpm2_dph_F:
  11:     -	EA12  0000    		dw	0	;_XLT:           
  11:     -	EA14  0000    		dw	0	;_1:             
  11:     -	EA16  0000    		dw	0	;_2:             
  11:     -	EA18  0000    		dw	0	;_3:             
  11:     -	EA1A  00FC    		dw	0xFC00	;DirBuf: value store here via patcher 0xfc00 - debug
  11:     -	EA1C  2AEA    		dw	_cpm2_dpb_F	;DPB:   
  11:     -	EA1E  0000    		dw	0	;CSV: - fixed drive   
  11:     -	EA20  39EA    		dw	_cpm2_alw_F	;ALV:   
  11:				
  11:				
  11:				;  ФИЗИЧЕСКИЕ ПАРАМЕТРЫ ДИСКА
  11:				;--------------------------------------
  11:     -	EA22  50      	      DB 50H	;контрольная сумма
  11:				
  11:     -	EA23  80      	      DB 080H ;константа скорости движения головки.
  11:				;	; 3 - 30 мс на шаг, 2 - 20 мс, 1 - 12 мс,
  11:				;	; 0 - 6 мс и 80H - 3 мс.
  11:     -	EA24  05      	      DB 05H  ; число физических секторов на дорожке
  11:     -	EA25  01      	      DB 01H  ; информация о сторонах диска
  11:				;	;( 00 - односторонный диск
  11:				;	;  01 - двухсторонний диск
  11:     -	EA26  03      	      DB 03	; 512 bytes/sector
  11:				;	;( 00 - 128 байт/сектор
  11:				;	;  01 - 256 байт/сектор
  11:				;	;  02 - 512 байт/сектор
  11:				;	;  03 - 1024 байт/сектор
  11:     -	EA27  00      	      DB 0	; номер текущей дорожки.
  11:     -	EA28  00      	      DB 0	; позиционный номер устройства (00000100) - для записи в регистр выбора
  11:				;---------------------------------------------------
  11:     -	EA29  00      	      DB 0	;INFO	; флаг успешного считывания
  11:				
  11:     -	EA2A          	_cpm2_dpb_F:
  11:				; kdi params
  11:     -	EA2A  2800    	      DW 40	;128 байтовых секторов/трек ; SPT
  11:     -	EA2C  04      	      DB 4	; размер блока миним.кбайт  ; BSH
  11:				;	; фактор сдвига блока распределения данных
  11:				;	; определяется размером блока данных. Блок 
  11:				;	; данных - минимально возможная частица файла.
  11:				;	; Размер блока - 1, 2, 4, 8 или 16 Кбайт. Если
  11:				;	; блок имеет большой размер, в каждом файле 
  11:				;	; теряется значительное число неиспользуемых
  11:				;	; секторов. При уменьшении размера блока
  11:				;	; увеличивается размер директории, описывающий
  11:				;	; расположение частей файла. BSH = log2[число
  11:				;	; логических секторов в блоке].
  11:     -	EA2D  0F      	      DB 15	; число логических сек/блок  ; BLM
  11:				;	; маска блока распределения данных.
  11:				;	; BLM = (число логических секторов в блоке)-1.
  11:     -	EA2E  00      	      DB 0	; extent mask                ; EXM
  11:				;	; = (BLM+1)*128/1024 - 1 - [DSM/256]. EXM - 
  11:				;	; вспомогательная величина для определения
  11:				;	; номера extent'а.
  11:				;	; extent - часть файла, описываемая одним 
  11:				;	; входом в директорию.
  11:     -	EA2F  8A01    	      DW 394	; обьем диска в блоках-1     ; DSM
  11:     -	EA31  7F00    	      DW 127	; входов в директорий-1      ; DRM
  11:     -	EA33  C0      	      DB 192	; определяет, какие блоки    ; AL0
  11:				;	; зарезервированы
  11:     -	EA34  00      	      DB 0	; alloc 1                    ; AL1
  11:				;	; под директорию. Каждый  бит AL0,AL1, 
  11:				;	; начиная со старшего бита AL0 и кончая 
  11:				;	; младшим битом AL1, значением 1 резервирует
  11:				;	; один блок данных для директории. Нужно
  11:				;	; резервировать необходимое число блоков
  11:				;	; для хранения входов в директорию: 32*DRM/BLS
  11:     -	EA35  0000    	      DW 0	; размер вектора контроля директории. ; CKS
  11:				;	; CKS=(DRM+1)/4. Если диск не сменяем, CKS=0.
  11:     -	EA37  0200    	      DW 2	; число системных дорожек    ; OFS
  11:				
  11:				
  11:				; preffix&alw_F: 	ds 	50
  11:     -	EA39 .. EA6A 00	_cpm2_alw_F: 	ds 	50
  11:				
  11:				
  11:     -	EA6B          	_cpm2_res_seldsk:
  11:10100+4	EA6B  79      		ld 	a,c
  11:10104+7	EA6C  FEFE    		cp 	0xfe
  11:     -	EA6E          	_cpm2_old_seld_dsk:
  11:10111+10	EA6E  C26EEA  		jp 	nz,$	
  11:10121+10	EA71  2106EA  		ld 	hl,_cpm2_res_DRIVE_TAB
  11:10131+10	EA74  C9      		ret
  11:				
  11:				
  11:				;RAM:DA27 C3 EB DC                 jp      j_READ
  11:				
  11:				;RAM:DCEB          j_READ:                                 ; CODE XREF: RAM:_READj
  11:				;RAM:DCEB                                                  ; RAM:DB84p
  11:				;RAM:DCEB
  11:				;RAM:DCEB          ; FUNCTION CHUNK AT RAM:DDC4 SIZE 0000007B BYTES
  11:				;RAM:DCEB
  11:				;RAM:DCEB 3E 04                    ld      a, 4
  11:				;RAM:DCED 32 66 E0                 ld      (_OPERATION), a
  11:				;RAM:DCF0 3A 64 E0                 ld      a, (_DSK)
  11:				;RAM:DCF3 FE 04                    cp      4
  11:				;RAM:DCF5 CA C4 DD                 jp      z, loc_DDC4
  11:				
  11:				;сюда попадает из биоса JP READ
  11:				;а если не наше то прыгаем на старый read
  11:     -	EA75          	_cpm2_res_READ:
  11:				; 	ld	 A,4	;Режим чтения
  11:				; 	ld  	(_OPER),a
  11:     -	EA75          	_cpm2_r_p_DSK1:
  11:10141+13	EA75  3AFFFF  		ld 	a,(_DSK) 	;_DSK
  11:10154+7	EA78  FE04    		cp 	4
  11:10161+10	EA7A  CAAFEA  		jp 	z,_cpm2__old_read
  11:				
  11:10171+7	EA7D  FE05    		cp 	5 		;disk F mapped to EMU drive E
  11:10178+10	EA7F  C283EA  		jp 	nz,_cpm2_.r_no_drv_dec
  11:10188+4	EA82  3D      		dec 	a
  11:				
  11:     -	EA83          	_cpm2_.r_no_drv_dec:
  11:10192+13	EA83  329AEB  		LD	(_cpm2_EXR_DRV),A	; # устройства
  11:				
  11:10205+11	EA86  E5      		push 	hl
  11:     -	EA87          	_cpm2_r_p_SELDSKDRIVER:
  11:10216+16	EA87  2A0000  		ld 	hl,(0)	;EXR_SELDSK_DRIVE
  11:10232+7	EA8A  7E      		ld 	a,(hl)
  11:10239+10	EA8B  E1      		pop 	hl
  11:10249+4	EA8C  B7      		or 	a
  11:10253+10	EA8D  C2AFEA  		jp 	nz,_cpm2__old_read
  11:				
  11:     -	EA90          	_cpm2_r_p_TRK1:
  11:10263+13	EA90  3AFFFF  		LD	A,(_TRK)	
  11:10276+13	EA93  329BEB  		LD	(_cpm2_EXR_TRK),A	; дорожка
  11:     -	EA96          	_cpm2_r_p_SEC1:
  11:10289+13	EA96  3AFFFF  		LD	A,(_SEC)	; сектор
  11:10302+4	EA99  3D      		DEC	A		; у нас номер сектора начинается с 0
  11:10306+13	EA9A  329CEB  		LD	(_cpm2_EXR_SEC),A
  11:				
  11:10319+7	EA9D  3E01    		LD	A,1
  11:10326+13	EA9F  3299EB  		LD	(_cpm2_EXR_CMD),A	; 1 - команда чтения
  11:				
  11:10339+17	EAA2  CD55EB  		CALL	_cpm2_EXR_SENDCMD	; отсылаем команду
  11:10356+4	EAA5  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
  11:10360+5+6	EAA6  C0      		RET	NZ		; 0 - ошибка
  11:     -	EAA7          	_cpm2_r_p_DMA1:
  11:10365+16	EAA7  2AFFFF  		LD	HL,(_DMA)	; адрес буфера для приема данных
  11:10381+17	EAAA  CD1FEB  		CALL	_cpm2_EXR_GETSEC	; принимаем данные
  11:10398+4	EAAD  AF      		XOR	A		; завершение всегда успешно
  11:10402+10	EAAE  C9      		RET
  11:				;
  11:				
  11:     -	EAAF          	_cpm2__old_read:
  11:10412+10	EAAF  C3AFEA  		jp 	$
  11:				
  11:     -	EAB2          	_cpm2_res_WRITE:
  11:				; 	ld	 A,6	;Режим чтения
  11:				; 	ld  	(_OPER),a
  11:				
  11:     -	EAB2          	_cpm2_r_p_DSK2:
  11:10422+13	EAB2  3AFFFF  		ld 	a,(_DSK) 	;_DSK
  11:10435+7	EAB5  FE04    		cp 	4
  11:10442+10	EAB7  CAECEA  		jp 	z,_cpm2__old_write
  11:10452+7	EABA  FE05    		cp 	5 		;disk F mapped to EMU drive E
  11:10459+10	EABC  C2C0EA  		jp 	nz,_cpm2_.w_no_drv_dec
  11:10469+4	EABF  3D      		dec 	a
  11:     -	EAC0          	_cpm2_.w_no_drv_dec:
  11:10473+13	EAC0  329AEB  		LD	(_cpm2_EXR_DRV),A
  11:				
  11:				
  11:10486+11	EAC3  E5      		push 	hl
  11:     -	EAC4          	_cpm2_r_p_SELDSKDRIVEW:
  11:10497+16	EAC4  2A0000  		ld 	hl,(0)	;EXR_SELDSK_DRIVE
  11:10513+7	EAC7  7E      		ld 	a,(hl)
  11:10520+10	EAC8  E1      		pop 	hl
  11:10530+4	EAC9  B7      		or 	a
  11:10534+10	EACA  C2ECEA  		jp 	nz,_cpm2__old_write
  11:				
  11:     -	EACD          	_cpm2_r_p_TRK2:
  11:10544+13	EACD  3AFFFF  		LD	A,(_TRK)
  11:10557+13	EAD0  329BEB  		LD	(_cpm2_EXR_TRK),A
  11:     -	EAD3          	_cpm2_r_p_SEC2:
  11:10570+13	EAD3  3AFFFF  		LD	A,(_SEC)
  11:10583+4	EAD6  3D      		DEC	A
  11:10587+13	EAD7  329CEB  		LD	(_cpm2_EXR_SEC),A
  11:				
  11:10600+7	EADA  3E02    		LD	A,2		; 2 - команда записи
  11:10607+13	EADC  3299EB  		LD	(_cpm2_EXR_CMD),A
  11:				
  11:10620+17	EADF  CD55EB  		CALL	_cpm2_EXR_SENDCMD
  11:10637+4	EAE2  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
  11:10641+5+6	EAE3  C0      		RET	NZ		; 0 - ошибка
  11:     -	EAE4          	_cpm2_r_p_DMA2:
  11:10646+16	EAE4  2AFFFF  		LD	HL,(_DMA)
  11:10662+17	EAE7  CD3AEB  		CALL	_cpm2_EXR_PUTSEC
  11:10679+4	EAEA  AF      		XOR	A		; запись успешна
  11:10683+10	EAEB  C9      		RET
  11:				
  11:     -	EAEC          	_cpm2__old_write:
  11:10693+10	EAEC  C3ECEA  		jp 	$
  11:				
  11:				
  11:     -	EAEF          	_cpm2_res_GETINFO:
  11:				
  11:10703+7	EAEF  7E      		LD 	A,(HL)	; A= маска выбора привода
  11:10710+4	EAF0  B7      		or 	a
  11:10714+10	EAF1  C2FCEA  		jp 	nz,_cpm2__old_getinfo 	;=0 if emulated
  11:				
  11:				;
  11:				;  Чтение с эмулируемых дисков A или B
  11:				;
  11:10724+11	EAF4  E5      		push 	hl
  11:10735+17	EAF5  CD7BEB  		CALL	_cpm2_EXR_READINFO
  11:10752+4	EAF8  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
  11:				; 	JP	NZ,0xE6ff	;IERR		; 0 - ошибка
  11:     -	EAF9          	_cpm2__old_getinfo_chkdo:
  11:10756+10	EAF9  C3F9EA  		JP	$ 		;IERR jnz xxx, CHKDO
  11:				; ;
  11:     -	EAFC          	_cpm2__old_getinfo:
  11:10766+10	EAFC  C3FCEA  		jp 	$ 		;GETINFO
  11:				
  11:				
  11:				;==================  Драйвер ExtROM-API ====================================
  11:					
  11:					
  11:				;****************************************
  11:				;*  Прием байта из порта А по стробу    *
  11:				;****************************************
  11:     -	EAFF          	_cpm2_EXR_GETBYTE:
  11:10776+11	EAFF  E5      		PUSH	HL
  11:10787+10	EB00  210AFB  		LD	HL,rPORTC
  11:     -	EB03          	_cpm2_pWG:
  11:10797+7	EB03  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11:10804+7	EB04  E620    		AND	20h		; выделяем сигнал IBF
  11:10811+10	EB06  CA03EB  		JP	Z,_cpm2_pWG		; IBF=0 - данных еще нет
  11:10821+13	EB09  3A08FB  		LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
  11:10834+10	EB0C  E1      		POP	HL
  11:10844+10	EB0D  C9      		RET
  11:				
  11:				;****************************************
  11:				;*  Отправка байта в порт A             *
  11:				;****************************************
  11:     -	EB0E          	_cpm2_EXR_PUTBYTE:
  11:10854+11	EB0E  E5      		PUSH	HL
  11:10865+11	EB0F  F5      		PUSH	AF
  11:10876+10	EB10  210AFB  		LD	HL,rPORTC
  11:     -	EB13          	_cpm2_pWP:
  11:10886+7	EB13  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11:10893+7	EB14  E680    		AND	80h		; выделяем сигнал -OBF
  11:10900+10	EB16  CA13EB  		JP	Z,_cpm2_pWP		; -OBF=0 - в передатчике сидит незабранный байт
  11:10910+10	EB19  F1      		POP	AF
  11:10920+13	EB1A  3208FB  		LD	(rPORTA),A		; данные поступили - выбираем их из порта А
  11:10933+10	EB1D  E1      		POP	HL
  11:10943+10	EB1E  C9      		RET
  11:				
  11:				;*******************************************
  11:				;*      Прием сектора                      *
  11:				;* HL - адрес размещения сектора в памяти  *
  11:				;*  Размер сектора - 128 байт              *
  11:				;*******************************************
  11:     -	EB1F          	_cpm2_EXR_GETSEC:
  11:10953+4	EB1F  F3      		di
  11:10957+11	EB20  C5      		PUSH	BC
  11:10968+11	EB21  D5      		PUSH	DE
  11:10979+7	EB22  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
  11:10986+4	EB24  EB      		EX	DE,HL		; адрес буфера -> DE
  11:10990+10	EB25  210AFB  		LD	HL,rPORTC
  11:     -	EB28          	_cpm2_pGSL:
  11:11000+7	EB28  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11:11007+7	EB29  E620    		AND	20h		; выделяем сигнал IBF
  11:11014+10	EB2B  CA28EB  		JP	Z,_cpm2_pGSL		; IBF=0 - данных еще нет
  11:11024+13	EB2E  3A08FB  		LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
  11:11037+7	EB31  12      		LD	(DE),A		; принимаем и размещаем очередной байт
  11:11044+6	EB32  13      		INC	DE		; указатель буфера ++
  11:11050+4	EB33  0D      		DEC	C		; принимаем остальные байты
  11:11054+10	EB34  C228EB  		JP	NZ,_cpm2_pGSL
  11:11064+10	EB37  D1      		POP	DE
  11:11074+10	EB38  C1      		POP	BC
  11:				; 	ei - int should be still disabled 
  11:11084+10	EB39  C9      		RET
  11:				
  11:				;*******************************************
  11:				;*      Передача сектора                   *
  11:				;* HL - адрес размещения сектора в памяти  *
  11:				;*  Размер сектора - 128 байт              *
  11:				;*******************************************
  11:     -	EB3A          	_cpm2_EXR_PUTSEC:
  11:11094+4	EB3A  F3      		di
  11:11098+11	EB3B  C5      		PUSH	BC
  11:11109+11	EB3C  D5      		PUSH	DE
  11:11120+7	EB3D  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
  11:11127+4	EB3F  EB      		EX	DE,HL		; адрес буфера -> DE
  11:11131+10	EB40  210AFB  		LD	HL,rPORTC
  11:     -	EB43          	_cpm2_pPSL:
  11:11141+7	EB43  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11:11148+7	EB44  E680    		AND	80h		; выделяем сигнал -OBF
  11:11155+10	EB46  CA43EB  		JP	Z,_cpm2_pPSL		; -OBF=0 - в передатчике сидит незабранный байт
  11:11165+7	EB49  1A      		LD	A,(DE)		; принимаем и размещаем очередной байт
  11:11172+13	EB4A  3208FB  		LD	(rPORTA),A		; данные поступили - выбираем их из порта А
  11:11185+6	EB4D  13      		INC	DE
  11:11191+4	EB4E  0D      		DEC	C		; принимаем остальные байты
  11:11195+10	EB4F  C243EB  		JP	NZ,_cpm2_pPSL
  11:11205+10	EB52  D1      		POP	DE
  11:11215+10	EB53  C1      		POP	BC
  11:				; 	ei - int should be still disabled 
  11:11225+10	EB54  C9      		RET
  11:				
  11:				;****************************************
  11:				;*     Отправка командного пакета       *
  11:				;****************************************
  11:     -	EB55          	_cpm2_EXR_SENDCMD:
  11:				
  11:11235+4	EB55  F3      		di
  11:11239+11	EB56  E5      		PUSH	HL
  11:11250+11	EB57  C5      		PUSH	BC
  11:11261+7	EB58  3E0C    		LD	A,0Ch
  11:11268+13	EB5A  320BFB  		LD	(rPCWR),A	; переключаем порт в режим 2
  11:11281+10	EB5D  2199EB  		LD	HL,_cpm2_EXR_CMD
  11:11291+7	EB60  0E04    		LD	C,4		; пакет - 4 байта
  11:11298+7	EB62  0600    		LD	B,0		; заготовка контрольной суммы
  11:     -	EB64          	_cpm2_pSCL:
  11:11305+7	EB64  7E      		LD	A,(HL)		; очередной байт пакета 
  11:11312+4	EB65  80      		ADD 	B		; добавляем к КС
  11:11316+4	EB66  47      		LD	B,A
  11:11320+7	EB67  7E      		LD	A,(HL)		; очередной байт пакета 
  11:11327+17	EB68  CD0EEB  		CALL	_cpm2_EXR_PUTBYTE		; - в порт
  11:11344+6	EB6B  23      		INC	HL
  11:11350+4	EB6C  0D      		DEC	C
  11:11354+10	EB6D  C264EB  		JP	NZ,_cpm2_pSCL
  11:11364+4	EB70  78      		LD	A,B
  11:11368+4	EB71  3D      		DEC 	A		; КС-1
  11:11372+17	EB72  CD0EEB  		CALL	_cpm2_EXR_PUTBYTE     ; контрольная сумма
  11:11389+17	EB75  CDFFEA  		CALL	_cpm2_EXR_GETBYTE	; ответ контроллера
  11:11406+10	EB78  C1      		POP	BC
  11:11416+10	EB79  E1      		POP	HL
  11:				; 	ei - int should be still disabled 
  11:11426+10	EB7A  C9      		RET
  11:				
  11:				;*******************************************
  11:				;*  Чтение информационного сектора
  11:				;*******************************************
  11:     -	EB7B          	_cpm2_EXR_READINFO:
  11:11436+10	EB7B  2199EB  		LD	HL,_cpm2_EXR_CMD	; командный пакет
  11:11446+10	EB7E  3601    		LD	(HL),1		; команда чтения
  11:11456+6	EB80  23      		INC	HL
  11:     -	EB81          	_cpm2_r_p_DSK3:
  11:11462+13	EB81  3AFFFF  		LD	A,(_DSK)	; вписываем # устройства
  11:11475+7	EB84  77      		LD	(HL),A
  11:11482+6	EB85  23      		INC	HL
  11:11488+10	EB86  3600    		LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
  11:11498+6	EB88  23      		INC	HL
  11:11504+10	EB89  3600    		LD	(HL),0		
  11:11514+17	EB8B  CD55EB  		CALL	_cpm2_EXR_SENDCMD	; отправляем команду
  11:11531+4	EB8E  B7      		OR	A
  11:11535+5+6	EB8F  C8      		RET 	Z		; ошибка
  11:11540+10	EB90  2100EE  		LD	HL,_RRBUFF	; принимаем данные
  11:11550+17	EB93  CD1FEB  		CALL	_cpm2_EXR_GETSEC
  11:11567+7	EB96  3E01    		LD	A,1
  11:11574+10	EB98  C9      		RET
  11:				
  11:				
  11:				; Командный пакет интерфейса Extrom-API
  11:				;===============================================
  11:     -	EB99  00      	_cpm2_EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
  11:     -	EB9A  00      	_cpm2_EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
  11:     -	EB9B  00      	_cpm2_EXR_TRK:	DB	0	; логическая дорожка
  11:     -	EB9C  00      	_cpm2_EXR_SEC:	DB	0	; логический сектор (128b)
  11:				
  11:     -	EB9D          		endm
  12:				
  13:     -	2E0C          		.dephase
  14:				
  15:     -	0197          	resident_cpm2_len 		equ	$-resident_cpm2
  16:				
  17:				; minimum hole_start .. min hole_end
  18:     -	03F7          	max_resident_cpm2_len 	equ 	0xEDFD-0xEA06 ;=1015
  19:				
  20:     -	0260          	available_resident_cpm2_len	equ 	max_resident_cpm2_len-resident_cpm2_len
  21:				
  22:     -	0001          		.assert max_resident_cpm2_len>=resident_cpm2_len
**** generator/V0/extrom-patcher.asm ****
 738:					include 	"extrom-patcher-resident-microdos.asm"
**** extrom-patcher-resident-microdos.asm ****
   1:     -	FE08          	MD_rPORTA	EQU	0FE08H		; Порт Канала A интерфейса расширения
   2:     -	FE0A          	MD_rPORTC	EQU	0FE0AH		; Порт Канала С интерфейса расширения
   3:     -	FE0B          	MD_rPCWR	EQU	0FE0BH		; Порт управляющих команд
   4:				
   5:     -	0000          	MD_RRBUFF 	EQU 	0
   6:				
   7:     -	2E0C          	resident_md:
   8:				
   9:				; 	.phase 	0xFD80
  10:     -	FA00          		.phase 	0xFA00
  11:     -	FA00          	resident_md_addr 	EQU 	$
  12:				
  13:				
  14:				;мы тут в конфигуации 0x5C
  15:				
  16:				;Код Cfg    ПЗУ     ОЗУ        ГЗУ   ОЗУ2       Клав  Рег2  А/Ц   Рег1
  17:				;ID  Name   ROM     RAM        GZU   Ram2       KBD   REGS  ACZU  DEV
  18:				;______________________________________________________________________
  19:				;1C  ODOSA          0000-F7FF                   F800  FA00  FC00  FB00
  20:				;5C  DOSA           0000-FDFF                         FF00        FE00
  21:				
  22:				
  23:				
  24:				;PATCH --------------------------------------------------------------------------
  25:				
  26:				;do_dskIO
  27:				
  28:				; RAM:EAFD FE 04                    cp      4 		
  29:				; RAM:EAFF CA 36 EB                 jp      z, jREAD 		<--- MY write
  30:				; RAM:EB02 FE 06                    cp      6
  31:				; RAM:EB04 CA A0 EB                 jp      z, jWRITE 		<--- MY write
  32:				
  33:				
  34:				; SELDSK:
  35:				; RAM:EC87 CD 14 EE                 call    SEL_DSK_SEEK0       <--- 00 00 00
  36:				; RAM:EC8A CD 1E EE                 call    ReadToRDBUF 	<--- MY read info into F04E. nz if err 
  37:				
  38:				; RAM:EC3A          Flush?:                                 ; CODE XREF: do_DSKIO+6Ap
  39:				; RAM:EC3A                                                  ; do_DSKIO+9Ap ...
  40:				; RAM:EC3A 21 FD EE                 ld      hl, flagWriteReuired?
  41:				; RAM:EC3D 7E                       ld      a, (hl)
  42:				; RAM:EC3E B7                       or      a
  43:				; RAM:EC3F C8                       ret     z  			<--- C9, newer flush
  44:				; RAM:EC42 21 0A EF                 ld      hl, WrBufDiskInfo   <--- or C9 HERE
  45:				
  46:				
  47:				;DISKINFO -----------------------------------------------------------------------
  48:				
  49:				; RAM:EB36          jREAD:                                  ; CODE XREF: do_DSKIO+40j
  50:				; RAM:EB36 2A F8 EE                 ld      hl, (DSC_IO_HL) ; DSCDESCR
  51:				; RAM:EB39 46                       ld      b, (hl)         ; Drive
  52:				; RAM:EB3A 23                       inc     hl
  53:				
  54:				; RAM:EAF1 7E                       ld      a, (hl) 	    ;operation 3-reset?, 4-read,6-write
  55:				; RAM:EAF2 23                       inc     hl
  56:				
  57:				; RAM:EB3C 23                       inc     hl 		    ; ?chword?
  58:				; RAM:EB3D 23                       inc     hl              ; ?NumB?
  59:				
  60:				; RAM:EB3E 4E                       ld      c, (hl)         ; track
  61:				; RAM:EB3F 23                       inc     hl
  62:				
  63:				; RAM:EB40 7E                       ld      a, (hl)         ; sector
  64:				; RAM:EB3F 23                       inc     hl
  65:				
  66:				; RAM:EAF6 5E                       ld      e, (hl)
  67:				; RAM:EAF7 23                       inc     hl
  68:				; RAM:EAF8 56                       ld      d, (hl)
  69:				; RAM:EAF9 EB                       ex      de, hl
  70:				; RAM:EAFA 22 FA EE                 ld      (_DMA??), hl
  71:				;DISKINFO -----------------------------------------------------------------------
  72:     -	FA00          	md_res_DRIVEA:
  73:     -	FA00  00      		db 	0
  74:     -	FA01          	md_res_DRIVEB:
  75:     -	FA01  00      		db 	0
  76:				
  77:     -	FA02          	md_res_DRIVE_TAB:
  78:     -	FA02  00FA    		dw 	md_res_DRIVEA 	;A
  79:     -	FA04  01FA    		dw 	md_res_DRIVEB 	;B
  80:     -	FA06  0000    		dw 	0 	;C
  81:     -	FA08  0000    		dw 	0 	;D
  82:     -	FA0A  0000    		dw 	0 	;E
  83:     -	FA0C  0000    		dw 	0 	;F
  84:				
  85:     -	FA0E          	md_res_seldsk:
  86:11584+4	FA0E  79      		ld 	a,c
  87:11588+7	FA0F  FEFE    		cp 	0xfe
  88:     -	FA11          	md_old_seld_dsk:
  89:11595+10	FA11  C211FA  		jp 	nz,$	
  90:11605+10	FA14  2102FA  		ld 	hl,md_res_DRIVE_TAB
  91:11615+10	FA17  C9      		ret
  92:				
  93:     -	FA18          	md_fetch_params:
  94:				
  95:11625+11	FA18  F5      		push 	af
  96:11636+11	FA19  C5      		push 	bc
  97:11647+11	FA1A  D5      		push 	de
  98:11658+11	FA1B  E5      		push 	hl
  99:				
 100:     -	FA1C          	MD_PARAM2:
 101:11669+16	FA1C  2AF8EE  		ld      hl, (0xEEF8) ; DSCDESCR
 102:11685+7	FA1F  7E      		ld      a, (hl)         ; Drive
 103:11692+6	FA20  23      		inc     hl
 104:11698+13	FA21  320BFB  		ld 	(MD_EXR_DRV),a
 105:				
 106:				; 	ld      a, (hl)		;operation 3-reset?, 4-read,6-write
 107:11711+6	FA24  23      		inc     hl
 108:				
 109:11717+6	FA25  23      		inc     hl		; ?chword?
 110:11723+6	FA26  23      		inc     hl              ; ?NumB?
 111:				
 112:11729+7	FA27  7E      		ld      a, (hl)         ; track
 113:11736+6	FA28  23      		inc     hl
 114:11742+13	FA29  320CFB  		ld 	(MD_EXR_TRK),a
 115:				
 116:11755+7	FA2C  7E      		ld      a, (hl)         ; sector
 117:11762+4	FA2D  3D      		DEC	A
 118:11766+6	FA2E  23      		inc     hl
 119:11772+13	FA2F  320DFB  		ld 	(MD_EXR_SEC),a
 120:				
 121:11785+7	FA32  5E      		ld      e, (hl)
 122:11792+6	FA33  23      		inc     hl
 123:11798+7	FA34  56      		ld      d, (hl)
 124:11805+4	FA35  EB      		ex      de, hl
 125:11809+16	FA36  220EFB  		ld      (MD_DMA), hl
 126:				
 127:11825+10	FA39  E1      		pop 	hl
 128:11835+10	FA3A  D1      		pop 	de
 129:11845+10	FA3B  C1      		pop 	bc
 130:11855+10	FA3C  F1      		pop 	af
 131:				
 132:11865+10	FA3D  C9      		ret
 133:				
 134:     -	FA3E          	MD_READ:
 135:11875+17	FA3E  CD18FA  		call 	md_fetch_params
 136:					
 137:11892+7	FA41  3E01    		LD	A,1
 138:11899+13	FA43  320AFB  		LD	(MD_EXR_CMD),A	; 1 - команда чтения
 139:				
 140:11912+17	FA46  CDC5FA  		CALL	MD_EXR_SENDCMD	; отсылаем команду
 141:11929+4	FA49  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
 142:11933+5+6	FA4A  C0      		RET	NZ		; 0 - ошибка
 143:11938+16	FA4B  2A0EFB  		LD	HL,(MD_DMA)	; адрес буфера для приема данных
 144:11954+17	FA4E  CD8DFA  		CALL	MD_EXR_GETSEC	; принимаем данные
 145:11971+4	FA51  AF      		XOR	A		; завершение всегда успешно
 146:11975+10	FA52  C9      		RET
 147:				
 148:     -	FA53          	MD_WRITE:
 149:11985+17	FA53  CD18FA  		call	md_fetch_params
 150:				
 151:12002+7	FA56  3E02    		LD	A,2		; 2 - команда записи
 152:12009+13	FA58  320AFB  		LD	(MD_EXR_CMD),A
 153:				
 154:12022+17	FA5B  CDC5FA  		CALL	MD_EXR_SENDCMD
 155:12039+4	FA5E  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
 156:12043+5+6	FA5F  C0      		RET	NZ		; 0 - ошибка
 157:12048+16	FA60  2A0EFB  		LD	HL,(MD_DMA)
 158:12064+17	FA63  CDA9FA  		CALL	MD_EXR_PUTSEC
 159:12081+4	FA66  AF      		XOR	A		; запись успешна
 160:12085+10	FA67  C9      		RET
 161:				
 162:     -	FA68          	MD_READ_INFOSECTOR:
 163:12095+17	FA68  CDECFA  		CALL	MD_EXR_READINFO
 164:12112+4	FA6B  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
 165:12116+10	FA6C  C9      		ret
 166:				
 167:				
 168:				;==================  Драйвер ExtROM-API ====================================
 169:					
 170:					
 171:				;****************************************
 172:				;*  Прием байта из порта А по стробу    *
 173:				;****************************************
 174:     -	FA6D          	MD_EXR_GETBYTE:
 175:12126+11	FA6D  E5      		PUSH	HL
 176:12137+10	FA6E  210AFE  		LD	HL,MD_rPORTC
 177:     -	FA71          	MD_pWG:
 178:12147+7	FA71  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 179:12154+7	FA72  E620    		AND	20h		; выделяем сигнал IBF
 180:12161+10	FA74  CA71FA  		JP	Z,MD_pWG		; IBF=0 - данных еще нет
 181:12171+13	FA77  3A08FE  		LD	A,(MD_rPORTA)		; данные поступили - выбираем их из порта А
 182:12184+10	FA7A  E1      		POP	HL
 183:12194+10	FA7B  C9      		RET
 184:				
 185:				;****************************************
 186:				;*  Отправка байта в порт A             *
 187:				;****************************************
 188:     -	FA7C          	MD_EXR_PUTBYTE:
 189:12204+11	FA7C  E5      		PUSH	HL
 190:12215+11	FA7D  F5      		PUSH	AF
 191:12226+10	FA7E  210AFE  		LD	HL,MD_rPORTC
 192:     -	FA81          	MD_pWP:
 193:12236+7	FA81  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 194:12243+7	FA82  E680    		AND	80h		; выделяем сигнал -OBF
 195:12250+10	FA84  CA81FA  		JP	Z,MD_pWP		; -OBF=0 - в передатчике сидит незабранный байт
 196:12260+10	FA87  F1      		POP	AF
 197:12270+13	FA88  3208FE  		LD	(MD_rPORTA),A		; данные поступили - выбираем их из порта А
 198:12283+10	FA8B  E1      		POP	HL
 199:12293+10	FA8C  C9      		RET
 200:				
 201:				;*******************************************
 202:				;*      Прием сектора                      *
 203:				;* HL - адрес размещения сектора в памяти  *
 204:				;*  Размер сектора - 128 байт              *
 205:				;*******************************************
 206:     -	FA8D          	MD_EXR_GETSEC:
 207:12303+4	FA8D  F3      		di
 208:12307+11	FA8E  C5      		PUSH	BC
 209:12318+11	FA8F  D5      		PUSH	DE
 210:12329+7	FA90  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
 211:12336+4	FA92  EB      		EX	DE,HL		; адрес буфера -> DE
 212:12340+10	FA93  210AFE  		LD	HL,MD_rPORTC
 213:     -	FA96          	MD_pGSL:
 214:12350+7	FA96  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 215:12357+7	FA97  E620    		AND	20h		; выделяем сигнал IBF
 216:12364+10	FA99  CA96FA  		JP	Z,MD_pGSL		; IBF=0 - данных еще нет
 217:12374+13	FA9C  3A08FE  		LD	A,(MD_rPORTA)		; данные поступили - выбираем их из порта А
 218:12387+7	FA9F  12      		LD	(DE),A		; принимаем и размещаем очередной байт
 219:12394+6	FAA0  13      		INC	DE		; указатель буфера ++
 220:12400+4	FAA1  0D      		DEC	C		; принимаем остальные байты
 221:12404+10	FAA2  C296FA  		JP	NZ,MD_pGSL
 222:12414+10	FAA5  D1      		POP	DE
 223:12424+10	FAA6  C1      		POP	BC
 224:12434+4	FAA7  FB      		ei 		
 225:12438+10	FAA8  C9      		RET
 226:				
 227:				;*******************************************
 228:				;*      Передача сектора                   *
 229:				;* HL - адрес размещения сектора в памяти  *
 230:				;*  Размер сектора - 128 байт              *
 231:				;*******************************************
 232:     -	FAA9          	MD_EXR_PUTSEC:
 233:12448+4	FAA9  F3      		di
 234:12452+11	FAAA  C5      		PUSH	BC
 235:12463+11	FAAB  D5      		PUSH	DE
 236:12474+7	FAAC  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
 237:12481+4	FAAE  EB      		EX	DE,HL		; адрес буфера -> DE
 238:12485+10	FAAF  210AFE  		LD	HL,MD_rPORTC
 239:     -	FAB2          	MD_pPSL:
 240:12495+7	FAB2  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 241:12502+7	FAB3  E680    		AND	80h		; выделяем сигнал -OBF
 242:12509+10	FAB5  CAB2FA  		JP	Z,MD_pPSL		; -OBF=0 - в передатчике сидит незабранный байт
 243:12519+7	FAB8  1A      		LD	A,(DE)		; принимаем и размещаем очередной байт
 244:12526+13	FAB9  3208FE  		LD	(MD_rPORTA),A		; данные поступили - выбираем их из порта А
 245:12539+6	FABC  13      		INC	DE
 246:12545+4	FABD  0D      		DEC	C		; принимаем остальные байты
 247:12549+10	FABE  C2B2FA  		JP	NZ,MD_pPSL
 248:12559+10	FAC1  D1      		POP	DE
 249:12569+10	FAC2  C1      		POP	BC
 250:12579+4	FAC3  FB      		ei 		
 251:12583+10	FAC4  C9      		RET
 252:				
 253:				;****************************************
 254:				;*     Отправка командного пакета       *
 255:				;****************************************
 256:     -	FAC5          	MD_EXR_SENDCMD:
 257:				
 258:12593+4	FAC5  F3      		di
 259:12597+11	FAC6  E5      		PUSH	HL
 260:12608+11	FAC7  C5      		PUSH	BC
 261:12619+7	FAC8  3E0C    		LD	A,0Ch
 262:12626+13	FACA  320BFE  		LD	(MD_rPCWR),A	; переключаем порт в режим 2
 263:12639+10	FACD  210AFB  		LD	HL,MD_EXR_CMD
 264:12649+7	FAD0  0E04    		LD	C,4		; пакет - 4 байта
 265:12656+7	FAD2  0600    		LD	B,0		; заготовка контрольной суммы
 266:     -	FAD4          	MD_pSCL:
 267:12663+7	FAD4  7E      		LD	A,(HL)		; очередной байт пакета 
 268:12670+4	FAD5  80      		ADD 	B		; добавляем к КС
 269:12674+4	FAD6  47      		LD	B,A
 270:12678+7	FAD7  7E      		LD	A,(HL)		; очередной байт пакета 
 271:12685+17	FAD8  CD7CFA  		CALL	MD_EXR_PUTBYTE		; - в порт
 272:12702+6	FADB  23      		INC	HL
 273:12708+4	FADC  0D      		DEC	C
 274:12712+10	FADD  C2D4FA  		JP	NZ,MD_pSCL
 275:12722+4	FAE0  78      		LD	A,B
 276:12726+4	FAE1  3D      		DEC 	A		; КС-1
 277:12730+17	FAE2  CD7CFA  		CALL	MD_EXR_PUTBYTE     ; контрольная сумма
 278:12747+17	FAE5  CD6DFA  		CALL	MD_EXR_GETBYTE	; ответ контроллера
 279:12764+10	FAE8  C1      		POP	BC
 280:12774+10	FAE9  E1      		POP	HL
 281:12784+4	FAEA  FB      		ei 		
 282:12788+10	FAEB  C9      		RET
 283:				
 284:				;*******************************************
 285:				;*  Чтение информационного сектора
 286:				;*******************************************
 287:     -	FAEC          	MD_EXR_READINFO:
 288:12798+10	FAEC  210AFB  		LD	HL,MD_EXR_CMD	; командный пакет
 289:12808+10	FAEF  3601    		LD	(HL),1		; команда чтения
 290:12818+6	FAF1  23      		INC	HL
 291:     -	FAF2          	MD_DRV2:
 292:12824+13	FAF2  3A06EF  		LD	A,(0xEF06)	; вписываем # устройства
 293:12837+7	FAF5  77      		LD	(HL),A
 294:12844+6	FAF6  23      		INC	HL
 295:12850+10	FAF7  3600    		LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
 296:12860+6	FAF9  23      		INC	HL
 297:12866+10	FAFA  3600    		LD	(HL),0		
 298:12876+17	FAFC  CDC5FA  		CALL	MD_EXR_SENDCMD	; отправляем команду
 299:12893+4	FAFF  B7      		OR	A
 300:12897+5+6	FB00  C8      		RET 	Z		; ошибка
 301:     -	FB01          	MD_RDBUF2:
 302:12902+10	FB01  210000  		LD	HL,MD_RRBUFF	; принимаем данные
 303:12912+17	FB04  CD8DFA  		CALL	MD_EXR_GETSEC
 304:12929+7	FB07  3E01    		LD	A,1
 305:12936+10	FB09  C9      		RET
 306:				
 307:				
 308:				; Командный пакет интерфейса Extrom-API
 309:				;===============================================
 310:     -	FB0A  00      	MD_EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
 311:     -	FB0B  00      	MD_EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
 312:     -	FB0C  00      	MD_EXR_TRK:	DB	0	; логическая дорожка
 313:     -	FB0D  00      	MD_EXR_SEC:	DB	0	; логический сектор (128b)
 314:     -	FB0E  0000    	MD_DMA: 	DW 	0 	; адресс куда/откуда
 315:				
 316:     -	2F1C          		.dephase
 317:     -	0110          	resident_md_len 	equ $-resident_md
 318:				
 319:				
**** generator/V0/extrom-patcher.asm ****
 739:					include 	"out/include-patcher.asm"
**** out/include-patcher.asm ****
   1:     -	2F1C          	bios_variants:
   2:     -	2F1C  5C2F    		dw	_BIOS_CPM_21_EXTROM
   3:     -	2F1E  9C2F    		dw	_BIOS_CPM_12_88_3_alternativa
   4:     -	2F20  8A30    		dw	_BIOS_CPM_12_88_3_niijaf
   5:     -	2F22  6731    		dw	_BIOS_CPM_21_89___wiza
   6:     -	2F24  4932    		dw	_BIOS_MICRODOS_OPTS2_880630
   7:     -	2F26  C932    		dw	_BIOS_CPM_21_89_2_niijaf2
   8:     -	2F28  A733    		dw	_BIOS_CPM_21_89_2_niijaf
   9:     -	2F2A  8434    		dw	_BIOS_MICRODOS_OPTS1_870430
  10:     -	2F2C  FF34    		dw	_BIOS_CPM_1x_89_03_30_RAVI
  11:     -	2F2E  DF35    		dw	_BIOS_MICRODOS_OPTS1_861011
  12:     -	2F30  6436    		dw	_BIOS_CPM_21_91___LAP
  13:     -	2F32  3E37    		dw	_BIOS_CPM_20_88___miks
  14:     -	2F34  1938    		dw	_BIOS_CPM_12_90_5_kontur
  15:     -	2F36  F638    		dw	_BIOS_MICRODOS_OPTS2_900105
  16:     -	2F38  7A39    		dw	_BIOS_CPM_12_87_11_niijaf
  17:     -	2F3A  583A    		dw	_BIOS_CPM_21m_____Shkanov
  18:     -	2F3C  363B    		dw	_BIOS_CPM_12_87_09_NIIJAF
  19:     -	2F3E  143C    		dw	_BIOS_MICRODOS_OPTS1_871220
  20:     -	2F40  943C    		dw	_BIOS_MICRODOS_OPTS1_861115
  21:     -	2F42  193D    		dw	_BIOS_CPM_NET_SFERA1
  22:     -	2F44  623D    		dw	_BIOS_CPM_NET_KORNET_drive_b
  23:     -	2F46  903D    		dw	_BIOS_CPM_NET_KORNET_drive_a
  24:     -	2F48  E13D    		dw	_BIOS_CPM_1x_88_EPSON_V104
  25:     -	2F4A  C13E    		dw	_BIOS_CPM_NET_SFERA2
  26:     -	2F4C  0000    		dw	0
  27:				
  28:     -	2F4E  50415443		db 	"PATCHER DATA>>"
	      48455220
	      44415441
	      3E3E
  29:				
  30:					include "generator/V0/out/patcher-cpm_chk-CPM_21_EXTROM.asm"
**** generator/V0/out/patcher-cpm_chk-CPM_21_EXTROM.asm ****
   1:     -	2F5C          	_BIOS_CPM_21_EXTROM:
   2:     -	2F5C          		setCPM
   2:     -	2F5C          		endm
   3:     -	2F5C          		setSUBBIOS 3
   3:     -	2F5C  5A      		db	pSubBios
   3:     -	2F5D  03      		db 	3
   3:     -	2F5E          		endm
   4:     -	2F5E          		dwstore	drivetab_mount_info	,0xDA3F
   4:     -	2F5E  54      		db 	pW_STORE
   4:     -	2F5F  3FDA    		dw 	0xDA3F
   4:     -	2F61  362A    		dw 	drivetab_mount_info
   4:     -	2F63          		endm
   5:					;custom checkers
   6:     -	2F63          		dwpatch	0xDA33+0	,0x5845 ,0x5845
   6:     -	2F63  51      		db 	pW_CHK_PATCH
   6:     -	2F64  33DA    		dw 	0xDA33+0
   6:     -	2F66  45584558		dw 	0x5845,0x5845
   6:     -	2F6A          		endm
   7:     -	2F6A          		dwpatch	0xDA33+2	,0x5254 ,0x5254
   7:     -	2F6A  51      		db 	pW_CHK_PATCH
   7:     -	2F6B  35DA    		dw 	0xDA33+2
   7:     -	2F6D  54525452		dw 	0x5254,0x5254
   7:     -	2F71          		endm
   8:     -	2F71          		dwpatch	0xDA33+4	,0x4D4F ,0x4D4F
   8:     -	2F71  51      		db 	pW_CHK_PATCH
   8:     -	2F72  37DA    		dw 	0xDA33+4
   8:     -	2F74  4F4D4F4D		dw 	0x4D4F,0x4D4F
   8:     -	2F78          		endm
   9:     -	2F78          		dwpatch	0xDA33+6	,0x4942 ,0x4942
   9:     -	2F78  51      		db 	pW_CHK_PATCH
   9:     -	2F79  39DA    		dw 	0xDA33+6
   9:     -	2F7B  42494249		dw 	0x4942,0x4942
   9:     -	2F7F          		endm
  10:     -	2F7F          		dwpatch	0xDA33+8	,0x534F ,0x534F
  10:     -	2F7F  51      		db 	pW_CHK_PATCH
  10:     -	2F80  3BDA    		dw 	0xDA33+8
  10:     -	2F82  4F534F53		dw 	0x534F,0x534F
  10:     -	2F86          		endm
  11:     -	2F86          		dwpatch	0xDA33+10	,0x3156 ,0x3156
  11:     -	2F86  51      		db 	pW_CHK_PATCH
  11:     -	2F87  3DDA    		dw 	0xDA33+10
  11:     -	2F89  56315631		dw 	0x3156,0x3156
  11:     -	2F8D          		endm
  12:     -	2F8D          		stop 'CPM_21_EXTROM'
  12:     -	2F8D  50      		db 	p_STOP
  12:     -	2F8E  43504D5F		db 	'CPM_21_EXTROM'
	      32315F45
	      5854524F
	      4D
  12:     -	2F9B  00      		db 	0
  12:     -	2F9C          		endm
**** out/include-patcher.asm ****
  31:					include "generator/V0/out/patcher-cpm1-CPM_12_88_3_alternativa.asm"	; 25 images in collection
**** generator/V0/out/patcher-cpm1-CPM_12_88_3_alternativa.asm ****
   1:     -	2F9C          	_BIOS_CPM_12_88_3_alternativa:
   2:     -	2F9C          		setSUBBIOS 1
   2:     -	2F9C  5A      		db	pSubBios
   2:     -	2F9D  01      		db 	1
   2:     -	2F9E          		endm
   3:     -	2F9E          		RQ_OPTS_ANY
   3:     -	2F9E          		endm
   4:     -	2F9E          		setCPM
   4:     -	2F9E          		endm
   5:     -	2F9E          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	2F9E  59      		db 	pB_MAYBE_PATCH
   5:     -	2F9F  EEDA    		dw 	0xDAEE
   5:     -	2FA1  1F0D    		db 	0x1F,0x0d
   5:     -	2FA3          		endm
   6:     -	2FA3          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	2FA3  59      		db 	pB_MAYBE_PATCH
   6:     -	2FA4  F0DA    		dw 	0xDAEE+2
   6:     -	2FA6  0A0D    		db 	0x0a,0x0d
   6:     -	2FA8          		endm
   7:     -	2FA8          		dbpatch	0xE077+1	,0x49	,0xc9
   7:     -	2FA8  52      		db 	pB_CHK_PATCH
   7:     -	2FA9  78E0    		dw 	0xE077+1
   7:     -	2FAB  49C9    		db 	0x49,0xc9
   7:     -	2FAD          		endm
   8:     -	2FAD          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	2FAD  52      		db 	pB_CHK_PATCH
   8:     -	2FAE  88DA    		dw 	0xDA88
   8:     -	2FB0  0100    		db 	0x01,0x00
   8:     -	2FB2          		endm
   9:     -	2FB2          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	2FB2  52      		db 	pB_CHK_PATCH
   9:     -	2FB3  9FDA    		dw 	0xDA9F
   9:     -	2FB5  0200    		db 	0x02,0x00
   9:     -	2FB7          		endm
  10:     -	2FB7          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	2FB7  52      		db 	pB_CHK_PATCH
  10:     -	2FB8  B6DA    		dw 	0xDAB6
  10:     -	2FBA  0401    		db 	0x04,0x01
  10:     -	2FBC          		endm
  11:     -	2FBC          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	2FBC  52      		db 	pB_CHK_PATCH
  11:     -	2FBD  CDDA    		dw 	0xDACD
  11:     -	2FBF  0802    		db 	0x08,0x02
  11:     -	2FC1          		endm
  12:     -	2FC1          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	2FC1  54      		db 	pW_STORE
  12:     -	2FC2  88DA    		dw 	0xDA88
  12:     -	2FC4  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	2FC6          		endm
  13:     -	2FC6          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	2FC6  54      		db 	pW_STORE
  13:     -	2FC7  9FDA    		dw 	0xDA9F
  13:     -	2FC9  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	2FCB          		endm
  14:     -	2FCB          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	2FCB  54      		db 	pW_STORE
  14:     -	2FCC  B6DA    		dw 	0xDAB6
  14:     -	2FCE  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	2FD0          		endm
  15:     -	2FD0          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	2FD0  54      		db 	pW_STORE
  15:     -	2FD1  CDDA    		dw 	0xDACD
  15:     -	2FD3  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	2FD5          		endm
  16:     -	2FD5          		dwpatch 0xDCBF+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	2FD5  51      		db 	pW_CHK_PATCH
  16:     -	2FD6  C9DC    		dw 	0xDCBF+5*2
  16:     -	2FD8  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	2FDC          		endm
  17:     -	2FDC          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	2FDC  54      		db 	pW_STORE
  17:     -	2FDD  A6EB    		dw 	0xEBA6
  17:     -	2FDF  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	2FE1          		endm
  18:     -	2FE1          		dwpatch 0xDA1B+1 	,0xDC7B	,_CPM1_res_seldsk
  18:     -	2FE1  51      		db 	pW_CHK_PATCH
  18:     -	2FE2  1CDA    		dw 	0xDA1B+1
  18:     -	2FE4  7BDC11E9		dw 	0xDC7B,_CPM1_res_seldsk
  18:     -	2FE8          		endm
  19:     -	2FE8          		dwstore	_CPM1_old_seld_dsk+1	,0xDC7B
  19:     -	2FE8  54      		db 	pW_STORE
  19:     -	2FE9  7BDC    		dw 	0xDC7B
  19:     -	2FEB  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	2FED          		endm
  20:     -	2FED          		dbpatch	0xE63E	,0x77	,0x00
  20:     -	2FED  52      		db 	pB_CHK_PATCH
  20:     -	2FEE  3EE6    		dw 	0xE63E
  20:     -	2FF0  7700    		db 	0x77,0x00
  20:     -	2FF2          		endm
  21:     -	2FF2          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDF92
  21:     -	2FF2  54      		db 	pW_STORE
  21:     -	2FF3  92DF    		dw 	0xDF92
  21:     -	2FF5  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	2FF7          		endm
  22:     -	2FF7          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDF92
  22:     -	2FF7  54      		db 	pW_STORE
  22:     -	2FF8  92DF    		dw 	0xDF92
  22:     -	2FFA  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	2FFC          		endm
  23:     -	2FFC          		dwpatch	0xDA27+1	,0xDCDE	,_CPM1_res_READ
  23:     -	2FFC  51      		db 	pW_CHK_PATCH
  23:     -	2FFD  28DA    		dw 	0xDA27+1
  23:     -	2FFF  DEDC1BE9		dw 	0xDCDE,_CPM1_res_READ
  23:     -	3003          		endm
  24:     -	3003          		dwpatch	0xDA2A+1	,0xDE14	,_CPM1_res_WRITE
  24:     -	3003  51      		db 	pW_CHK_PATCH
  24:     -	3004  2BDA    		dw 	0xDA2A+1
  24:     -	3006  14DE58E9		dw 	0xDE14,_CPM1_res_WRITE
  24:     -	300A          		endm
  25:     -	300A          		dwpatch	0xDB74+1	,0xDCDE	,_CPM1_res_READ
  25:     -	300A  51      		db 	pW_CHK_PATCH
  25:     -	300B  75DB    		dw 	0xDB74+1
  25:     -	300D  DEDC1BE9		dw 	0xDCDE,_CPM1_res_READ
  25:     -	3011          		endm
  26:     -	3011          		dwpatch	0xDCAD+1	,0xE574	,_CPM1_res_GETINFO
  26:     -	3011  51      		db 	pW_CHK_PATCH
  26:     -	3012  AEDC    		dw 	0xDCAD+1
  26:     -	3014  74E595E9		dw 	0xE574,_CPM1_res_GETINFO
  26:     -	3018          		endm
  27:     -	3018          		dwstore	_CPM1__old_read+1	,0xDCDE
  27:     -	3018  54      		db 	pW_STORE
  27:     -	3019  DEDC    		dw 	0xDCDE
  27:     -	301B  56E9    		dw 	_CPM1__old_read+1
  27:     -	301D          		endm
  28:     -	301D          		dwstore	_CPM1__old_write+1	,0xDE14
  28:     -	301D  54      		db 	pW_STORE
  28:     -	301E  14DE    		dw 	0xDE14
  28:     -	3020  93E9    		dw 	_CPM1__old_write+1
  28:     -	3022          		endm
  29:     -	3022          		dwstore	_CPM1__old_getinfo+1	,0xE574
  29:     -	3022  54      		db 	pW_STORE
  29:     -	3023  74E5    		dw 	0xE574
  29:     -	3025  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	3027          		endm
  30:     -	3027          		dbpatch	0xE5B4		,0x21	,0x21
  30:     -	3027  52      		db 	pB_CHK_PATCH
  30:     -	3028  B4E5    		dw 	0xE5B4
  30:     -	302A  2121    		db 	0x21,0x21
  30:     -	302C          		endm
  31:     -	302C          		dwpatch	0xE5B4+1 	,0xE5E4	,0xE5E4
  31:     -	302C  51      		db 	pW_CHK_PATCH
  31:     -	302D  B5E5    		dw 	0xE5B4+1
  31:     -	302F  E4E5E4E5		dw 	0xE5E4,0xE5E4
  31:     -	3033          		endm
  32:     -	3033          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE5B4
  32:     -	3033  54      		db 	pW_STORE
  32:     -	3034  B4E5    		dw 	0xE5B4
  32:     -	3036  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	3038          		endm
  33:     -	3038          		dwstore	_CPM1_r_p_DSK1+1	,0xDF88 	;read
  33:     -	3038  54      		db 	pW_STORE
  33:     -	3039  88DF    		dw 	0xDF88
  33:     -	303B  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	303D          		endm
  34:     -	303D          		dwstore	_CPM1_r_p_TRK1+1	,0xDF8C 	
  34:     -	303D  54      		db 	pW_STORE
  34:     -	303E  8CDF    		dw 	0xDF8C
  34:     -	3040  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	3042          		endm
  35:     -	3042          		dwstore	_CPM1_r_p_SEC1+1	,0xDF8D 	
  35:     -	3042  54      		db 	pW_STORE
  35:     -	3043  8DDF    		dw 	0xDF8D
  35:     -	3045  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	3047          		endm
  36:     -	3047          		dwstore	_CPM1_r_p_DMA1+1	,0xDF8E 	
  36:     -	3047  54      		db 	pW_STORE
  36:     -	3048  8EDF    		dw 	0xDF8E
  36:     -	304A  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	304C          		endm
  37:     -	304C          		dwstore	_CPM1_r_p_DSK2+1	,0xDF88 	;write
  37:     -	304C  54      		db 	pW_STORE
  37:     -	304D  88DF    		dw 	0xDF88
  37:     -	304F  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	3051          		endm
  38:     -	3051          		dwstore	_CPM1_r_p_TRK2+1	,0xDF8C 	
  38:     -	3051  54      		db 	pW_STORE
  38:     -	3052  8CDF    		dw 	0xDF8C
  38:     -	3054  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	3056          		endm
  39:     -	3056          		dwstore	_CPM1_r_p_SEC2+1	,0xDF8D 	
  39:     -	3056  54      		db 	pW_STORE
  39:     -	3057  8DDF    		dw 	0xDF8D
  39:     -	3059  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	305B          		endm
  40:     -	305B          		dwstore	_CPM1_r_p_DMA2+1	,0xDF8E 	
  40:     -	305B  54      		db 	pW_STORE
  40:     -	305C  8EDF    		dw 	0xDF8E
  40:     -	305E  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	3060          		endm
  41:     -	3060          		dwstore	_CPM1_r_p_DSK3+1	,0xDF88 	;readinfo
  41:     -	3060  54      		db 	pW_STORE
  41:     -	3061  88DF    		dw 	0xDF88
  41:     -	3063  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	3065          		endm
  42:					;custom checkers
  43:     -	3065          		dbpatch	0xE01D	,0x21 ,0x21
  43:     -	3065  52      		db 	pB_CHK_PATCH
  43:     -	3066  1DE0    		dw 	0xE01D
  43:     -	3068  2121    		db 	0x21,0x21
  43:     -	306A          		endm
  44:     -	306A          		dwpatch	0xE01D+1	,0xFB21 ,0xFB21
  44:     -	306A  51      		db 	pW_CHK_PATCH
  44:     -	306B  1EE0    		dw 	0xE01D+1
  44:     -	306D  21FB21FB		dw 	0xFB21,0xFB21
  44:     -	3071          		endm
  45:     -	3071          		stop 'CPM_12_88_3_alternativa'
  45:     -	3071  50      		db 	p_STOP
  45:     -	3072  43504D5F		db 	'CPM_12_88_3_alternativa'
	      31325F38
	      385F335F
	      616C7465
	      726E6174
	      697661
  45:     -	3089  00      		db 	0
  45:     -	308A          		endm
**** out/include-patcher.asm ****
  32:					include "generator/V0/out/patcher-cpm1-CPM_12_88_3_niijaf.asm"	; 78 images in collection
**** generator/V0/out/patcher-cpm1-CPM_12_88_3_niijaf.asm ****
   1:     -	308A          	_BIOS_CPM_12_88_3_niijaf:
   2:     -	308A          		setSUBBIOS 1
   2:     -	308A  5A      		db	pSubBios
   2:     -	308B  01      		db 	1
   2:     -	308C          		endm
   3:     -	308C          		RQ_OPTS_ANY
   3:     -	308C          		endm
   4:     -	308C          		setCPM
   4:     -	308C          		endm
   5:     -	308C          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	308C  59      		db 	pB_MAYBE_PATCH
   5:     -	308D  EEDA    		dw 	0xDAEE
   5:     -	308F  1F0D    		db 	0x1F,0x0d
   5:     -	3091          		endm
   6:     -	3091          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	3091  59      		db 	pB_MAYBE_PATCH
   6:     -	3092  F0DA    		dw 	0xDAEE+2
   6:     -	3094  0A0D    		db 	0x0a,0x0d
   6:     -	3096          		endm
   7:     -	3096          		dbpatch	0xE077+1	,0x49	,0xc9
   7:     -	3096  52      		db 	pB_CHK_PATCH
   7:     -	3097  78E0    		dw 	0xE077+1
   7:     -	3099  49C9    		db 	0x49,0xc9
   7:     -	309B          		endm
   8:     -	309B          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	309B  52      		db 	pB_CHK_PATCH
   8:     -	309C  88DA    		dw 	0xDA88
   8:     -	309E  0100    		db 	0x01,0x00
   8:     -	30A0          		endm
   9:     -	30A0          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	30A0  52      		db 	pB_CHK_PATCH
   9:     -	30A1  9FDA    		dw 	0xDA9F
   9:     -	30A3  0200    		db 	0x02,0x00
   9:     -	30A5          		endm
  10:     -	30A5          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	30A5  52      		db 	pB_CHK_PATCH
  10:     -	30A6  B6DA    		dw 	0xDAB6
  10:     -	30A8  0401    		db 	0x04,0x01
  10:     -	30AA          		endm
  11:     -	30AA          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	30AA  52      		db 	pB_CHK_PATCH
  11:     -	30AB  CDDA    		dw 	0xDACD
  11:     -	30AD  0802    		db 	0x08,0x02
  11:     -	30AF          		endm
  12:     -	30AF          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	30AF  54      		db 	pW_STORE
  12:     -	30B0  88DA    		dw 	0xDA88
  12:     -	30B2  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	30B4          		endm
  13:     -	30B4          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	30B4  54      		db 	pW_STORE
  13:     -	30B5  9FDA    		dw 	0xDA9F
  13:     -	30B7  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	30B9          		endm
  14:     -	30B9          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	30B9  54      		db 	pW_STORE
  14:     -	30BA  B6DA    		dw 	0xDAB6
  14:     -	30BC  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	30BE          		endm
  15:     -	30BE          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	30BE  54      		db 	pW_STORE
  15:     -	30BF  CDDA    		dw 	0xDACD
  15:     -	30C1  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	30C3          		endm
  16:     -	30C3          		dwpatch 0xDCBF+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	30C3  51      		db 	pW_CHK_PATCH
  16:     -	30C4  C9DC    		dw 	0xDCBF+5*2
  16:     -	30C6  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	30CA          		endm
  17:     -	30CA          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	30CA  54      		db 	pW_STORE
  17:     -	30CB  A6EB    		dw 	0xEBA6
  17:     -	30CD  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	30CF          		endm
  18:     -	30CF          		dwpatch 0xDA1B+1 	,0xDC7B	,_CPM1_res_seldsk
  18:     -	30CF  51      		db 	pW_CHK_PATCH
  18:     -	30D0  1CDA    		dw 	0xDA1B+1
  18:     -	30D2  7BDC11E9		dw 	0xDC7B,_CPM1_res_seldsk
  18:     -	30D6          		endm
  19:     -	30D6          		dwstore	_CPM1_old_seld_dsk+1	,0xDC7B
  19:     -	30D6  54      		db 	pW_STORE
  19:     -	30D7  7BDC    		dw 	0xDC7B
  19:     -	30D9  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	30DB          		endm
  20:     -	30DB          		dbpatch	0xE63E	,0x77	,0x00
  20:     -	30DB  52      		db 	pB_CHK_PATCH
  20:     -	30DC  3EE6    		dw 	0xE63E
  20:     -	30DE  7700    		db 	0x77,0x00
  20:     -	30E0          		endm
  21:     -	30E0          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDF92
  21:     -	30E0  54      		db 	pW_STORE
  21:     -	30E1  92DF    		dw 	0xDF92
  21:     -	30E3  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	30E5          		endm
  22:     -	30E5          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDF92
  22:     -	30E5  54      		db 	pW_STORE
  22:     -	30E6  92DF    		dw 	0xDF92
  22:     -	30E8  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	30EA          		endm
  23:     -	30EA          		dwpatch	0xDA27+1	,0xDCDE	,_CPM1_res_READ
  23:     -	30EA  51      		db 	pW_CHK_PATCH
  23:     -	30EB  28DA    		dw 	0xDA27+1
  23:     -	30ED  DEDC1BE9		dw 	0xDCDE,_CPM1_res_READ
  23:     -	30F1          		endm
  24:     -	30F1          		dwpatch	0xDA2A+1	,0xDE14	,_CPM1_res_WRITE
  24:     -	30F1  51      		db 	pW_CHK_PATCH
  24:     -	30F2  2BDA    		dw 	0xDA2A+1
  24:     -	30F4  14DE58E9		dw 	0xDE14,_CPM1_res_WRITE
  24:     -	30F8          		endm
  25:     -	30F8          		dwpatch	0xDB74+1	,0xDCDE	,_CPM1_res_READ
  25:     -	30F8  51      		db 	pW_CHK_PATCH
  25:     -	30F9  75DB    		dw 	0xDB74+1
  25:     -	30FB  DEDC1BE9		dw 	0xDCDE,_CPM1_res_READ
  25:     -	30FF          		endm
  26:     -	30FF          		dwpatch	0xDCAD+1	,0xE574	,_CPM1_res_GETINFO
  26:     -	30FF  51      		db 	pW_CHK_PATCH
  26:     -	3100  AEDC    		dw 	0xDCAD+1
  26:     -	3102  74E595E9		dw 	0xE574,_CPM1_res_GETINFO
  26:     -	3106          		endm
  27:     -	3106          		dwstore	_CPM1__old_read+1	,0xDCDE
  27:     -	3106  54      		db 	pW_STORE
  27:     -	3107  DEDC    		dw 	0xDCDE
  27:     -	3109  56E9    		dw 	_CPM1__old_read+1
  27:     -	310B          		endm
  28:     -	310B          		dwstore	_CPM1__old_write+1	,0xDE14
  28:     -	310B  54      		db 	pW_STORE
  28:     -	310C  14DE    		dw 	0xDE14
  28:     -	310E  93E9    		dw 	_CPM1__old_write+1
  28:     -	3110          		endm
  29:     -	3110          		dwstore	_CPM1__old_getinfo+1	,0xE574
  29:     -	3110  54      		db 	pW_STORE
  29:     -	3111  74E5    		dw 	0xE574
  29:     -	3113  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	3115          		endm
  30:     -	3115          		dbpatch	0xE5B4		,0x21	,0x21
  30:     -	3115  52      		db 	pB_CHK_PATCH
  30:     -	3116  B4E5    		dw 	0xE5B4
  30:     -	3118  2121    		db 	0x21,0x21
  30:     -	311A          		endm
  31:     -	311A          		dwpatch	0xE5B4+1 	,0xE5E4	,0xE5E4
  31:     -	311A  51      		db 	pW_CHK_PATCH
  31:     -	311B  B5E5    		dw 	0xE5B4+1
  31:     -	311D  E4E5E4E5		dw 	0xE5E4,0xE5E4
  31:     -	3121          		endm
  32:     -	3121          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE5B4
  32:     -	3121  54      		db 	pW_STORE
  32:     -	3122  B4E5    		dw 	0xE5B4
  32:     -	3124  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	3126          		endm
  33:     -	3126          		dwstore	_CPM1_r_p_DSK1+1	,0xDF88 	;read
  33:     -	3126  54      		db 	pW_STORE
  33:     -	3127  88DF    		dw 	0xDF88
  33:     -	3129  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	312B          		endm
  34:     -	312B          		dwstore	_CPM1_r_p_TRK1+1	,0xDF8C 	
  34:     -	312B  54      		db 	pW_STORE
  34:     -	312C  8CDF    		dw 	0xDF8C
  34:     -	312E  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	3130          		endm
  35:     -	3130          		dwstore	_CPM1_r_p_SEC1+1	,0xDF8D 	
  35:     -	3130  54      		db 	pW_STORE
  35:     -	3131  8DDF    		dw 	0xDF8D
  35:     -	3133  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	3135          		endm
  36:     -	3135          		dwstore	_CPM1_r_p_DMA1+1	,0xDF8E 	
  36:     -	3135  54      		db 	pW_STORE
  36:     -	3136  8EDF    		dw 	0xDF8E
  36:     -	3138  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	313A          		endm
  37:     -	313A          		dwstore	_CPM1_r_p_DSK2+1	,0xDF88 	;write
  37:     -	313A  54      		db 	pW_STORE
  37:     -	313B  88DF    		dw 	0xDF88
  37:     -	313D  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	313F          		endm
  38:     -	313F          		dwstore	_CPM1_r_p_TRK2+1	,0xDF8C 	
  38:     -	313F  54      		db 	pW_STORE
  38:     -	3140  8CDF    		dw 	0xDF8C
  38:     -	3142  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	3144          		endm
  39:     -	3144          		dwstore	_CPM1_r_p_SEC2+1	,0xDF8D 	
  39:     -	3144  54      		db 	pW_STORE
  39:     -	3145  8DDF    		dw 	0xDF8D
  39:     -	3147  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	3149          		endm
  40:     -	3149          		dwstore	_CPM1_r_p_DMA2+1	,0xDF8E 	
  40:     -	3149  54      		db 	pW_STORE
  40:     -	314A  8EDF    		dw 	0xDF8E
  40:     -	314C  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	314E          		endm
  41:     -	314E          		dwstore	_CPM1_r_p_DSK3+1	,0xDF88 	;readinfo
  41:     -	314E  54      		db 	pW_STORE
  41:     -	314F  88DF    		dw 	0xDF88
  41:     -	3151  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	3153          		endm
  42:				
  43:     -	3153          		stop 'CPM_12_88_3_niijaf'
  43:     -	3153  50      		db 	p_STOP
  43:     -	3154  43504D5F		db 	'CPM_12_88_3_niijaf'
	      31325F38
	      385F335F
	      6E69696A
	      6166
  43:     -	3166  00      		db 	0
  43:     -	3167          		endm
**** out/include-patcher.asm ****
  33:					include "generator/V0/out/patcher-cpm1-CPM_21_89___wiza.asm"	; 42 images in collection
**** generator/V0/out/patcher-cpm1-CPM_21_89___wiza.asm ****
   1:     -	3167          	_BIOS_CPM_21_89___wiza:
   2:     -	3167          		setSUBBIOS 1
   2:     -	3167  5A      		db	pSubBios
   2:     -	3168  01      		db 	1
   2:     -	3169          		endm
   3:				
   4:					;адресса актуальные для биоса 21_89___wiza
   5:				
   6:					;BIOS_LOGO 		=> "0xDAEE",
   7:					;PPI2C_BIOS_IIT 	=> "0xE49F",
   8:					;DRVREG_A 		=> "0xDAA0",
   9:					;DRVREG_B 		=> "0xDA90",
  10:					;DRVREG_C 		=> "0xDAB7",
  11:					;DRVREG_D 		=> "0xDACE",
  12:					;SELDSK_STOREDRV	=> "0xE70A",
  13:					;SELDSK_ADDR		=> "0xDC8D",
  14:					;CURRENT_DISKPTR   	=> "0xE06E",
  15:					;BIOS_READ 		=> "0xDCEB",
  16:					;BIOS_WRITE 		=> "0xDEAF",
  17:					;SELDSK_GETINO_CALL	=> "0xdcbf",
  18:					;BIOS_GETINFO		=> "0xE648",
  19:					;WBOOT_READ_CLL 	=> "0xDB84",
  20:					;GETINFO_POSTTOM_ADDR 	=> "0xE67F",
  21:					;GETINFO_POSTTOM_CHKW 	=> "0xE6AF",
  22:					;BIOS_VAR_DSK		=> "0xE064",
  23:					;BIOS_VAR_SEC		=> "0xE068",
  24:					;BIOS_VAR_TRK		=> "0xE069",
  25:					;BIOS_VAR_DMA		=> "0xE06A",
  26:					;VINTKBDADDR 		=> "0xe3e3",
  27:					;VINTKBDVALUE		=> "0xdc46",
  28:					;KBD_HOOK_PRO 		=> "kbd_hook_2133",
  29:					;NAME 			=> '21_89___wiza',
  30:				
  31:					;Чекер/Патчер
  32:					;есть три основных комманды
  33:					;dbpatch addr oldbyte newbyte
  34:					;dwpatch addr oldword newword
  35:					;dwstore addr newword
  36:					;и ряд вспомогательных
  37:					;setCPM
  38:					;setMICRODOS
  39:					;checkOPTS1
  40:					;checkOPTS2
  41:					;unsupported
  42:					;pSTOP 'biosname'
  43:				
  44:					;на первом этапе патчер проверяет что в памяти именно этот биос
  45:					;для этого он проходтся по d(b|w)patch и проверяет 
  46:					;что по адрессу addr записано значени old(byte|word)
  47:				
  48:					;если это не так (т.е. на первой же проверке которая не прошла)
  49:					;то считаем что биос не соответсвует проверяемому и надо пробовать следующий
  50:				
  51:					;если же все проверки прошли - то запускается второй проход
  52:					;правим значения в памяти (собственно patch)
  53:					;т.е для d(b|w)patch по addr записывается значение new(byte|word)
  54:					;для dwstore просто по адрессу addr записывается newword
  55:				
  56:					;если old = new - то это просто проверка, т.к. значение не изменяется
  57:				
  58:     -	3169          		RQ_OPTS_ANY
  58:     -	3169          		endm
  59:				
  60:					;
  61:					;ниже описан "TEMPLATE" для поддержки CP/M BIOS
  62:					;все примеры кода ниже взяты для биоса '21_89___wiza'
  63:					;
  64:					;я попробую возле каждого параметра описать откуда он получен
  65:					;если вдруг будет необходимость расширить набор поддерживаемых
  66:					;bios.
  67:					;на сегодня поддерживается 13 уникальных CP/M bios для Корвета
  68:					;под "уникальными" понимается разные биосы, в которых отличается код
  69:					;во времена когда использовали Корвет было нормально править биос прямо на дискете
  70:					;обычно правили функциональные клавиши, таблицы перекодировки принтера
  71:					;и надписи ;)
  72:					;по этой причине разно выглядящие биосы могут быть одинаковыми внутри
  73:					;предварительный анализ позволил выделить 13 уникальных биосов среди сотен дискет
  74:					;что сильно упростило дальнейшую работу.
  75:					;
  76:					;patcher же делает необходимое кол-во проверок и изменений биоса
  77:					;чтобы подготовить его к работе с EXTROM API
  78:					;
  79:					;значения вида CPM_21_89___wiza должны быть заменены на значения
  80:					;соотвествующие конкретному биосу
  81:				
  82:					;Lets go
  83:				
  84:					;установим тип системы CP/M (нужно для случая когда биос опознан но не может быть использован)
  85:					;в случае с cp/m это важно для '1x_88_EPSON_V104'	'1x_89_03_30_RAVI'
  86:					;они работают только с ОПТС 1
  87:					;и по этой причине на ОПТС 2 надо fallback to default CP/M
  88:     -	3169          		setCPM
  88:     -	3169          		endm
  89:				
  90:					;BIOS_LOGO--------------------------------------------------------------
  91:					;косметика,  
  92:					;Биос при старте очищает экран, мы патчим его чтобы он это не делал
  93:					;иначе он затрёт все сообщения патчера, а там много полезной информации
  94:					;выгядит это в коде так
  95:					
  96:					;RAM:DA00          _BOOT:
  97:					;RAM:DA00 C3 42 DB                 jp      j_BOOT
  98:					;....
  99:					;RAM:DB42          j_BOOT:                                 
 100:					;RAM:DB42 F3                       di
 101:					;RAM:DB43 31 80 00                 ld      sp, 80h 
 102:					;RAM:DB46 3E 1C                    ld      a, 1Ch
 103:					;RAM:DB48 32 7F FA                 ld      (_1C_SysReg1C), a
 104:					;...
 105:					;RAM:DB58 21 EE DA                 ld      hl, BIOS_LOGO   ; "\\x1F\\r\\nCP/M-80  vers. 2.2"
 106:					;RAM:DB5B CD 2D E0                 call    putstr
 107:					;...
 108:					;RAM:DAEE 1F 0D 0A+BIOS_LOGO:      text "KOI8-R", '\\x1F\\r\\n'
 109:					;RAM:DAEE 43 50 2F+                text "KOI8-R", 'CP/M-80  vers. 2.2 \\r\\n'
 110:					;RAM:DAEE 4D 2D 38+                text "KOI8-R", 'BIOS  vers.2.1 (c) \\r\\n'
 111:					;RAM:DAEE 30 20 20+                text "KOI8-R", 'МГУ н/п кооп."ВИЗА"\\r\\n'
 112:					;RAM:DAEE 76 65 72+                text "KOI8-R", '   МОСКВА 1989 \\r\\n'
 113:					;RAM:DAEE 73 2E 20+                text "KOI8-R", 0
 114:     -	3169          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
 114:     -	3169  59      		db 	pB_MAYBE_PATCH
 114:     -	316A  EEDA    		dw 	0xDAEE
 114:     -	316C  1F0D    		db 	0x1F,0x0d
 114:     -	316E          		endm
 115:     -	316E          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
 115:     -	316E  59      		db 	pB_MAYBE_PATCH
 115:     -	316F  F0DA    		dw 	0xDAEE+2
 115:     -	3171  0A0D    		db 	0x0a,0x0d
 115:     -	3173          		endm
 116:				
 117:					;PPI2C_BIOS_INIT--------------------------------------------------------
 118:					;Биос при старте производит инициализацию перифирии, разных контроллеров
 119:					;в том числе записывает значение 0x49 в порт PPI2.C 
 120:					;(разрешаем вывод звука, ~SE, ResetForJoy)
 121:					;для нас важно что тут он сбрабсывает PPI2.C.8 (ENABLE EXTROM)
 122:					;без которого наш контроллер не работает.
 123:					;мы модифицируем это значение чтобы бит8 был установлен 0x49 -> 0xC9 
 124:					;выгядит это в коде так
 125:					;нас интересует адресс E49F
 126:				
 127:					;RAM:DA00          _BOOT:
 128:					;RAM:DA00 C3 42 DB                 jp      j_BOOT
 129:					;....
 130:					;RAM:DB42          j_BOOT:                                 
 131:					;RAM:DB42 F3                       di
 132:					;RAM:DB43 31 80 00                 ld      sp, 80h ; 'Ç'
 133:					;RAM:DB46 3E 1C                    ld      a, 1Ch
 134:					;RAM:DB48 32 7F FA                 ld      (_1C_SysReg1C), a
 135:					;RAM:DB4E CD 0A E4                 call    HW_Init
 136:					;...
 137:					;RAM:E40A          HW_Init:                                
 138:					;RAM:E40A                                                  
 139:					;RAM:E40A F3                       di
 140:					;RAM:E40B 11 D1 E3                 ld      de, IntstINTAB
 141:					;RAM:E40E 21 C6 F7                 ld      hl, _xVTRAP
 142:					;RAM:E411 01 3A 00                 ld      bc, 58
 143:					;RAM:E414 CD 3A E0                 call    _LDIR
 144:					;...
 145:					;RAM:E495 3E FF                    ld      a, 0FFh
 146:					;RAM:E497 32 31 F7                 ld      (SndFlag), a    ; flag key click (0 - no click)
 147:					;RAM:E49A 3E 02                    ld      a, 2
 148:					;RAM:E49C 32 2E F7                 ld      (F_Alft), a     ; 0 - russian
 149:					;RAM:E49F 3E 49                    ld      a, 49h ; 'I'
 150:					;RAM:E4A1 32 32 FB                 ld      (_1C_PPI2C_), a
 151:					;RAM:E4A4 C9                       ret
 152:     -	3173          		dbpatch	0xE49F+1	,0x49	,0xc9
 152:     -	3173  52      		db 	pB_CHK_PATCH
 152:     -	3174  A0E4    		dw 	0xE49F+1
 152:     -	3176  49C9    		db 	0x49,0xc9
 152:     -	3178          		endm
 153:				
 154:					;DRVREG_x---------------------------------------------------------------
 155:					;DRVREG_A,DRVREG_B,DRVREG_C,DRVREG_D
 156:					;драйверу дисковода необходимо знать какой логичесской букве соответствует какой диск
 157:					;для этой цели мы используем байт который в оригинальном CP/M BIOS указывает
 158:					;какое значение надо записать в DRVREG чтобы выбрать данный диск
 159:					;это даёт возможность использовать и эмулятор и настоящие диски.
 160:					;в нашем биосе если этот байт =0 то этот диск работает через EXTROM API
 161:					;если же там не 0 то это физичесский диск.
 162:					;эти значения также использует утилита MOUNT которая позволяет изменить это соответсвие
 163:					;и подключить нужный образ диска к нужному дисководу.
 164:					;по умолчанию 
 165:					;при наличии дисковода
 166:					;A: -> эмулятор образ disk/DISKA.KDI
 167:					;B: -> эмулятор образ disk/DISKB.KDI
 168:					;C: -> физичесский дисковод A:
 169:					;D: -> физичесский дисковод B:
 170:					;или при отсутствии дисковода
 171:					;A: -> эмулятор образ disk/DISKA.KDI
 172:					;B: -> эмулятор образ disk/DISKB.KDI
 173:					;C: -> эмулятор образ disk/DISKC.KDI
 174:					;D: -> эмулятор образ disk/DISKD.KDI
 175:				
 176:					;этот адресс можно найти так (это справедливо для всех известных CP/M биосов)
 177:					;для каждого диска в биосе есть таблица DPH (Disk Parameter Header)
 178:					;в этой таблице по смещению +0x0A находится адрес DPB (Disk Parameter Block)
 179:					;интересующий нас байт находится по адрессу DPH-2
 180:					;звучит сложно, но на практике всё просто.
 181:					;найти DPH для всех дисков можно достаточно просто
 182:					;есть вызов биоса SELDSK (0xDA1B)
 183:					;иначе он попытается сделает операцию "Выбор диска" для указанного в регистре C диска
 184:					;а для этого ему надо получить параметры диска для своих целей
 185:					;а мы этим и воспользуемся
 186:					;в коде ниже по адрессу 0xDC99
 187:					;собственно тут нас интересует ссылка на таблицу DPH_TABLE
 188:					;в которой и есть ссылки на DPH для дисков (0xDCCC)
 189:					;A-DA33,B-DA43,etc
 190:					;RAM:DC8D          j_SELDSK:                               
 191:					;RAM:DC8D 79                       ld      a, c
 192:					;RAM:DC8E FE FF                    cp      0FFh
 193:					;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
 194:					;RAM:DC93 C8                       ret     z
 195:					;RAM:DC94 FE 08                    cp      8
 196:					;RAM:DC96 D2 C4 DC                 jp      nc, loc_DCC4
 197:					;RAM:DC99 21 CC DC                 ld      hl, DPH_TABLE
 198:					;RAM:DC9C 32 64 E0                 ld      (_DSK), a
 199:					;....
 200:					;RAM:DCCC 33 DA    DPH_TABLE:      dw dph_a                ; DATA XREF: j_SELDSK+Co
 201:					;RAM:DCCE 43 DA                    dw dph_b
 202:					;RAM:DCD0 53 DA                    dw dph_c
 203:					;RAM:DCD2 63 DA                    dw dph_d
 204:					;RAM:DCD4 73 DA                    dw dph_e
 205:					;RAM:DCD6 00 00                    dw loc_0
 206:					;RAM:DCD8 00 00                    dw loc_0
 207:					;RAM:DCDA 00 00                    dw loc_0
 208:					;...
 209:				
 210:					;DPH             struc ; (sizeof=0x10)
 211:					;_XLT:           dw ?
 212:					;_1:             dw ?
 213:					;_2:             dw ?
 214:					;_3:             dw ?
 215:					;DirBuf:         dw ?                    ; offset (00000000)
 216:					;DPB:            dw ?                    ; offset (00000000)
 217:					;CSV:            dw ?                    ; offset (00000000)
 218:					;ALV:            dw ?                    ; offset (00000000)
 219:					;DPH             ends
 220:				
 221:					;RAM:DA33 00 00 03+dph_a:          DPH <0, 3, 0, 0, dirBUF, dpbA, csvA, alwA>
 222:					;RAM:DA43 00 00 00+dph_b:          DPH <0, 0, 0, 0, dirBUF, dpbB, csvB, alwB>
 223:					;RAM:DA53 00 00 00+dph_c:          DPH <0, 0, 0, 0, dirBUF, dpbC, csvC, alwC>
 224:					;RAM:DA63 00 00 00+dph_d:          DPH <0, 0, 0, 0, dirBUF, dpbD, csvD, alwD>
 225:					;RAM:DA73 00 00 00+dph_e:          DPH <0, 0, 0, 0, dirBUF, dpbE, loc_0, alwE>
 226:					;RAM:DA83 50                       db  50h ; P
 227:					;RAM:DA84 80                       db  80h ; Ç
 228:					;RAM:DA85 05                       db    5
 229:					;RAM:DA86 01                       db    1
 230:					;RAM:DA87 03                       db    3
 231:					;RAM:DA88 01                       db    1
 232:					;RAM:DA89 01       unk_DA89:       db    1                 
 233:					;RAM:DA8A FF       			       db 0FFh                 
 234:					;RAM:DA8B 28 00 04+dpbA:           DPB <28h, 4, 0Fh, 0, 18Ah, 7Fh, 0C0h, 0, 20h, 2>
 235:					;
 236:					;собственно по адрессу DPB_A-2 и находится интересующая нас ячейка для диска A
 237:					;для остальных дисков - аналогично
 238:					;для физичесского дисковода A там значение 1
 239:					;для физичесского дисковода B там значение 2
 240:					;для физичесского дисковода C там значение 4
 241:					;для физичесского дисковода D там значение 8
 242:					;0 будет означать эмуляцию
 243:				
 244:     -	3178          		dbpatch	0xDA89 	,0x01	,0x00
 244:     -	3178  52      		db 	pB_CHK_PATCH
 244:     -	3179  89DA    		dw 	0xDA89
 244:     -	317B  0100    		db 	0x01,0x00
 244:     -	317D          		endm
 245:     -	317D          		dbpatch	0xDAA0 	,0x02	,0x00
 245:     -	317D  52      		db 	pB_CHK_PATCH
 245:     -	317E  A0DA    		dw 	0xDAA0
 245:     -	3180  0200    		db 	0x02,0x00
 245:     -	3182          		endm
 246:     -	3182          		dbpatch	0xDAB7 	,0x04	,0x01
 246:     -	3182  52      		db 	pB_CHK_PATCH
 246:     -	3183  B7DA    		dw 	0xDAB7
 246:     -	3185  0401    		db 	0x04,0x01
 246:     -	3187          		endm
 247:     -	3187          		dbpatch	0xDACE 	,0x08	,0x02
 247:     -	3187  52      		db 	pB_CHK_PATCH
 247:     -	3188  CEDA    		dw 	0xDACE
 247:     -	318A  0802    		db 	0x08,0x02
 247:     -	318C          		endm
 248:				
 249:					;для нормальной работы MOUNT в биос добавлена новая подфункция - получить таблицу
 250:					;адресов DRVREGxx
 251:					;call SELDSK с C=0xFE, которая возвращает указатель на таблицу с адресами DRVTRG_X
 252:					;собтвенно готовим эту таблицу используя уже исзвестные нам данные
 253:					;сохраняя адреса в таблицу внутри кода "резедента".
 254:				
 255:     -	318C          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
 255:     -	318C  54      		db 	pW_STORE
 255:     -	318D  89DA    		dw 	0xDA89
 255:     -	318F  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
 255:     -	3191          		endm
 256:     -	3191          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
 256:     -	3191  54      		db 	pW_STORE
 256:     -	3192  A0DA    		dw 	0xDAA0
 256:     -	3194  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
 256:     -	3196          		endm
 257:     -	3196          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
 257:     -	3196  54      		db 	pW_STORE
 257:     -	3197  B7DA    		dw 	0xDAB7
 257:     -	3199  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
 257:     -	319B          		endm
 258:     -	319B          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
 258:     -	319B  54      		db 	pW_STORE
 258:     -	319C  CEDA    		dw 	0xDACE
 258:     -	319E  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
 258:     -	31A0          		endm
 259:				
 260:				
 261:					;DPH_TABLE-----------------------------------------------------
 262:					;добавляем поддержку диска F - образа с утилитами
 263:					;как найти DPH_TABLE см выше
 264:     -	31A0          		dwpatch 0xDCCC+5*2 	,0x0000 ,_CPM1_dph_F
 264:     -	31A0  51      		db 	pW_CHK_PATCH
 264:     -	31A1  D6DC    		dw 	0xDCCC+5*2
 264:     -	31A3  0000B8E8		dw 	0x0000,_CPM1_dph_F
 264:     -	31A7          		endm
 265:				
 266:     -	31A7          		dwstore _CPM1_dph_F+8	,0xEBA6
 266:     -	31A7  54      		db 	pW_STORE
 266:     -	31A8  A6EB    		dw 	0xEBA6
 266:     -	31AA  C0E8    		dw 	_CPM1_dph_F+8
 266:     -	31AC          		endm
 267:				
 268:					;SELDSK_ADDR------------------------------------------------------------
 269:					;и модифицируем вызов SELDSK чтобы он поддерживал дополнительную проверку
 270:					;модифицируем оригинальный перехо в SELDSK чтобы он переходил на наш код	
 271:					;и сохраняем старый адресс (в данном коде нужный нам адресс 0xDCB6)
 272:					;RAM:DA1B          _SELDSK:                         ; IN: C
 273:					;RAM:DA1B C3 B6 DC          jp      __SELDSK        ; OUT: HL-DPB/0, HL=xVTRAP0 if c=0xff
 274:				
 275:     -	31AC          		dwpatch 0xDA1B+1 	,0xDC8D	,_CPM1_res_seldsk
 275:     -	31AC  51      		db 	pW_CHK_PATCH
 275:     -	31AD  1CDA    		dw 	0xDA1B+1
 275:     -	31AF  8DDC11E9		dw 	0xDC8D,_CPM1_res_seldsk
 275:     -	31B3          		endm
 276:     -	31B3          		dwstore	_CPM1_old_seld_dsk+1	,0xDC8D
 276:     -	31B3  54      		db 	pW_STORE
 276:     -	31B4  8DDC    		dw 	0xDC8D
 276:     -	31B6  15E9    		dw 	_CPM1_old_seld_dsk+1
 276:     -	31B8          		endm
 277:				
 278:					;SELDSK_STORE_DRV-------------------------------------------------------
 279:					;в процессе работы SELDSK биос вызывает функцию GETINFO которая читает параметры диска
 280:					;из первого сектора.
 281:					;в процессе рабты она перезаписывает значение байта DRVREG_x
 282:					;затрём эту комманду 
 283:					;в примере ниже E70A 77 ld (hl), a - записав NOP на ее место.
 284:				
 285:					;RAM:DC8D          j_SELDSK:                               
 286:					;RAM:DC8D                                                  
 287:					;RAM:DC8D 79                       ld      a, c
 288:					;RAM:DC8E FE FF                    cp      0FFh
 289:					;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
 290:					;RAM:DC93 C8                       ret     z
 291:					;...
 292:					;RAM:DCBB 22 6E E0                 ld      (off_E06E), hl
 293:					;RAM:DCBE 3C                       inc     a
 294:					;RAM:DCBF C4 48 E6                 call    nz, GETINFO
 295:					;RAM:DCC2 E1                       pop     hl
 296:					;RAM:DCC3 C8                       ret     z
 297:					;...
 298:					;RAM:E648          GETINFO:                                
 299:					;RAM:E648 E5                       push    hl
 300:					;RAM:E649 CD 4E DF                 call    sub_DF4E
 301:					;RAM:E64C E1                       pop     hl
 302:					;...
 303:					;RAM:E703          loc_E703:                               
 304:					;RAM:E703 E1                       pop     hl
 305:					;RAM:E704 E5                       push    hl
 306:					;RAM:E705 3A 39 FB                 ld      a, (_1C_PPI1B_DrvReg)
 307:					;RAM:E708 E6 CF                    and     ~_SIDE1|_MOTOR
 308:					;RAM:E70A 77                       ld      (hl), a
 309:					;RAM:E70B 23                       inc     hl
 310:					;RAM:E70C 36 FF                    ld      (hl), 0FFh
 311:					;RAM:E70E 23                       inc     hl
 312:				
 313:     -	31B8          		dbpatch	0xE70A	,0x77	,0x00
 313:     -	31B8  52      		db 	pB_CHK_PATCH
 313:     -	31B9  0AE7    		dw 	0xE70A
 313:     -	31BB  7700    		db 	0x77,0x00
 313:     -	31BD          		endm
 314:				
 315:					;CURRENT_DISK_PTR-------------------------------------------------------
 316:					;нашему резиденту для операций чтения и записи нужно знать к какому диску идёт обращение
 317:					;и надо ли подменять обращение к эмулятору
 318:					;у биоса есть переменная которая указывает на DRVREG_x для текушего диска
 319:					;резидент читает из этого адресса и смотрит надо ли эмулировать диск
 320:					;собственно в коде ниже по адрессу 0xDCBB комманда которая сохраняет в нужную нам переменную
 321:					;ld      (off_E06E), hl
 322:					;т.е. нужный нам адресс 0xE06E
 323:				
 324:					;RAM:DC8D          j_SELDSK:                               
 325:					;RAM:DC8D                                                  
 326:					;RAM:DC8D 79                       ld      a, c
 327:					;RAM:DC8E FE FF                    cp      0FFh
 328:					;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
 329:					;RAM:DC93 C8                       ret     z
 330:					;...
 331:					;RAM:DCBB 22 6E E0                 ld      (off_E06E), hl
 332:					;RAM:DCBE 3C                       inc     a
 333:					;RAM:DCBF C4 48 E6                 call    nz, GETINFO
 334:				
 335:     -	31BD          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE06E
 335:     -	31BD  54      		db 	pW_STORE
 335:     -	31BE  6EE0    		dw 	0xE06E
 335:     -	31C0  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
 335:     -	31C2          		endm
 336:     -	31C2          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE06E
 336:     -	31C2  54      		db 	pW_STORE
 336:     -	31C3  6EE0    		dw 	0xE06E
 336:     -	31C5  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
 336:     -	31C7          		endm
 337:				
 338:				
 339:					;CURRENT_DISK_PTR-------------------------------------------------------
 340:					;патчим адресса в основной таблицк BIOS для READ и WRITE
 341:					;теперь они указывают на наш "резидент"
 342:				
 343:					;RAM:DA27          _READ:                                  
 344:					;RAM:DA27 C3 EB DC                 jp      j_READ
 345:					;RAM:DA2A          _WRITE:                                 
 346:					;RAM:DA2A C3 AF DE                 jp      j_WRITE
 347:				
 348:     -	31C7          		dwpatch	0xDA27+1	,0xDCEB	,_CPM1_res_READ
 348:     -	31C7  51      		db 	pW_CHK_PATCH
 348:     -	31C8  28DA    		dw 	0xDA27+1
 348:     -	31CA  EBDC1BE9		dw 	0xDCEB,_CPM1_res_READ
 348:     -	31CE          		endm
 349:     -	31CE          		dwpatch	0xDA2A+1	,0xDEAF	,_CPM1_res_WRITE
 349:     -	31CE  51      		db 	pW_CHK_PATCH
 349:     -	31CF  2BDA    		dw 	0xDA2A+1
 349:     -	31D1  AFDE58E9		dw 	0xDEAF,_CPM1_res_WRITE
 349:     -	31D5          		endm
 350:				
 351:					;WBOOT_READ_CALL--------------------------------------------------------
 352:					;биосовоский wboot напрямую делает вызов READ
 353:					;патчим его тоже
 354:					;RAM:DB5E          j_WBOOT:                                
 355:					;RAM:DB5E                                                  
 356:					;RAM:DB5E F3                       di
 357:					;RAM:DB5F 31 80 00                 ld      sp, 80h ; 'Ç'
 358:					;RAM:DB62 CD 0A E4                 call    HW_Init
 359:					;...
 360:					;RAM:DB80 C5                       push    bc
 361:					;RAM:DB81 CD E5 DC                 call    j_SETDMA
 362:					;RAM:DB84 CD EB DC                 call    j_READ
 363:					;RAM:DB87 B7                       or      a
 364:					;RAM:DB88 C2 5E DB                 jp      nz, j_WBOOT
 365:				
 366:     -	31D5          		dwpatch	0xDB84+1	,0xDCEB	,_CPM1_res_READ
 366:     -	31D5  51      		db 	pW_CHK_PATCH
 366:     -	31D6  85DB    		dw 	0xDB84+1
 366:     -	31D8  EBDC1BE9		dw 	0xDCEB,_CPM1_res_READ
 366:     -	31DC          		endm
 367:				
 368:					;SELDSK_GETINFO_CALL------------------------------------------------------------------------
 369:					;внутри  SELDSK есть вызов GETINFO
 370:					;используется для чтения параметров диска с нового диска
 371:					;мы его перехватываем, и для дисково которые работают через EXTROM API
 372:					;делаем сами его функции (частично)
 373:					;для физичесских дисков работает оригинальный код
 374:					;причина в том, что GETINFO обращается к диску напрямую, а нас это не устраивает
 375:					;в примере ниже это адресс DCBF
 376:				
 377:					;RAM:DC8D          j_SELDSK:                               
 378:					;RAM:DC8D                                                  
 379:					;RAM:DC8D 79                       ld      a, c
 380:					;RAM:DC8E FE FF                    cp      0FFh
 381:					;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
 382:					;RAM:DC93 C8                       ret     z
 383:					;...
 384:					;RAM:DCBB 22 6E E0                 ld      (off_E06E), hl
 385:					;RAM:DCBE 3C                       inc     a
 386:					;RAM:DCBF C4 48 E6                 call    nz, GETINFO
 387:					;RAM:DCC2 E1                       pop     hl
 388:					;RAM:DCC3 C8                       ret     z
 389:				
 390:     -	31DC          		dwpatch	0xdcbf+1	,0xE648	,_CPM1_res_GETINFO
 390:     -	31DC  51      		db 	pW_CHK_PATCH
 390:     -	31DD  C0DC    		dw 	0xdcbf+1
 390:     -	31DF  48E695E9		dw 	0xE648,_CPM1_res_GETINFO
 390:     -	31E3          		endm
 391:				
 392:					;BIOS_xxxx--------------------------------------------------------------
 393:					;сохраняем в "резидет" адреса оригинальных функций
 394:					;они вызываются если идёт обращение к физичесским дискам
 395:				
 396:     -	31E3          		dwstore	_CPM1__old_read+1	,0xDCEB
 396:     -	31E3  54      		db 	pW_STORE
 396:     -	31E4  EBDC    		dw 	0xDCEB
 396:     -	31E6  56E9    		dw 	_CPM1__old_read+1
 396:     -	31E8          		endm
 397:     -	31E8          		dwstore	_CPM1__old_write+1	,0xDEAF
 397:     -	31E8  54      		db 	pW_STORE
 397:     -	31E9  AFDE    		dw 	0xDEAF
 397:     -	31EB  93E9    		dw 	_CPM1__old_write+1
 397:     -	31ED          		endm
 398:     -	31ED          		dwstore	_CPM1__old_getinfo+1	,0xE648
 398:     -	31ED  54      		db 	pW_STORE
 398:     -	31EE  48E6    		dw 	0xE648
 398:     -	31F0  A3E9    		dw 	_CPM1__old_getinfo+1
 398:     -	31F2          		endm
 399:				
 400:					;-------------------------------------------------------------------------------
 401:					;наш эмулятор GETINFO производит чтение первого сектора из образа диска
 402:					;в буфер чтения, остальную работу делает сатарый код
 403:					;т.е. мы читаем сектор в буффер и передаём управление на код который
 404:					;проверяет результат успешности чтения, проверяе контролльную сумму сектора 
 405:					;и готовит сектор к дальнейшей работе
 406:					;в коде ниже это 0xE67F 
 407:				
 408:					;RAM:E648          GETINFO:                                ; CODE XREF: j_SELDSK+32p
 409:					;RAM:E648 E5                       push    hl
 410:					;RAM:E649 CD 4E DF                 call    sub_DF4E
 411:					;RAM:E64C E1                       pop     hl
 412:					;RAM:E64D 22 6E E0                 ld      (off_E06E), hl
 413:					;RAM:E650 E5                       push    hl
 414:					;RAM:E651 7E                       ld      a, (hl)
 415:					;RAM:E652 E6 0F                    and     0Fh
 416:					;RAM:E654 32 70 E0                 ld      (byte_E070), a
 417:					;RAM:E657 AF                       xor     a
 418:					;RAM:E658 32 71 E0                 ld      (byte_E071), a
 419:					;RAM:E65B 3C                       inc     a
 420:					;RAM:E65C 32 72 E0                 ld      (byte_E072), a
 421:					;RAM:E65F 21 6E E0                 ld      hl, off_E06E
 422:					;RAM:E662 CD D3 DF                 call    sub_DFD3
 423:					;RAM:E665 21 00 EE                 ld      hl, RD_BUF
 424:					;RAM:E668 CD 9A E7                 call    DTOM
 425:					;RAM:E66B CA 85 E6                 jp      z, CHKDO
 426:					;RAM:E66E 3A 39 FB                 ld      a, (_1C_PPI1B_DrvReg)
 427:					;RAM:E671 C6 40                    add     a, 40h ; '@'
 428:					;RAM:E673 32 39 FB                 ld      (_1C_PPI1B_DrvReg), a
 429:					;RAM:E676 CD 79 E8                 call    FDD_BREAK
 430:					;RAM:E679 21 00 EE                 ld      hl, RD_BUF
 431:					;RAM:E67C CD 9A E7                 call    DTOM
 432:					;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 433:					;RAM:E67F 21 AF E6                 ld      hl, msgDiskNotRead 
 434:					;RAM:E682 C2 A7 E6                 jp      nz, loc_E6A7
 435:					;RAM:E685
 436:				
 437:					;для надёжности проверим что по этому аддреск находтся то что ожидаем 
 438:				
 439:     -	31F2          		dbpatch	0xE67F		,0x21	,0x21
 439:     -	31F2  52      		db 	pB_CHK_PATCH
 439:     -	31F3  7FE6    		dw 	0xE67F
 439:     -	31F5  2121    		db 	0x21,0x21
 439:     -	31F7          		endm
 440:     -	31F7          		dwpatch	0xE67F+1 	,0xE6AF	,0xE6AF
 440:     -	31F7  51      		db 	pW_CHK_PATCH
 440:     -	31F8  80E6    		dw 	0xE67F+1
 440:     -	31FA  AFE6AFE6		dw 	0xE6AF,0xE6AF
 440:     -	31FE          		endm
 441:				
 442:					;и устанавливаем в наш "резидент" переход на эту точку.
 443:					
 444:     -	31FE          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE67F
 444:     -	31FE  54      		db 	pW_STORE
 444:     -	31FF  7FE6    		dw 	0xE67F
 444:     -	3201  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
 444:     -	3203          		endm
 445:				
 446:					;BIOS_VAR_xxx-----------------------------------------------------------------------
 447:					;BIOS_VAR_DSK,BIOS_VAR_TRK,BIOS_VAR_SEC,BIOS_VAR_DMA
 448:					;системные переменные BIOS которые необходимы "эмулятору" для работы 
 449:					;функций READ/WRITE, т.к. их параметры предварительно записываются именно в
 450:					;эти переменные 
 451:					;сохраняем в эмулятор значения характерные именно для текущего биоса
 452:					;
 453:					;найти их совсем просто
 454:					;
 455:					;в стандартном CPM BIOS есть набор соответсвующих вызовов
 456:					;TRK -> 0xE068 (инструкция по адрессу DC89)
 457:					;SEC -> 0xE069 (инструкция по адрессу DCDD)
 458:					;DMA -> 0xE06A (инструкция по адрессу DCE7)
 459:				
 460:					;RAM:DA1E          _SELTRK:                                
 461:					;RAM:DA1E C3 88 DC                 jp      j_SELTRK
 462:					;RAM:DA21          _SETSEC:                                
 463:					;RAM:DA21 C3 DC DC                 jp      j_SETSEC
 464:					;RAM:DA24          _SETDMA:
 465:					;RAM:DA24 C3 E5 DC                 jp      j_SETDMA
 466:					;
 467:					;RAM:DC88          j_SELTRK:                               
 468:					;RAM:DC88                                                  
 469:					;RAM:DC88 79                       ld      a, c
 470:					;RAM:DC89 32 68 E0                 ld      (_TRK), a
 471:					;RAM:DC8C C9                       ret
 472:					;...
 473:					;RAM:DCDC          j_SETSEC:                               
 474:					;RAM:DCDC                                                  
 475:					;RAM:DCDC 79                       ld      a, c
 476:					;RAM:DCDD 32 69 E0                 ld      (_SEC), a
 477:					;RAM:DCE0 C9                       ret
 478:					;...
 479:					;RAM:DCE5          j_SETDMA:                               
 480:					;RAM:DCE5                                                  
 481:					;RAM:DCE5 69                       ld      l, c
 482:					;RAM:DCE6 60                       ld      h, b
 483:					;RAM:DCE7 22 6A E0                 ld      (_DMA), hl
 484:					;RAM:DCEA C9                       ret
 485:				
 486:					;а с DSK - тоже, многострадальный код SELDSK
 487:					;тут нужная нам число 0xE064 в инструкции по адрессу 0xDC9C
 488:				
 489:					;RAM:DC8D          j_SELDSK:                               
 490:					;RAM:DC8D 79                       ld      a, c
 491:					;RAM:DC8E FE FF                    cp      0FFh
 492:					;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
 493:					;RAM:DC93 C8                       ret     z
 494:					;RAM:DC94 FE 08                    cp      8
 495:					;RAM:DC96 D2 C4 DC                 jp      nc, loc_DCC4
 496:					;RAM:DC99 21 CC DC                 ld      hl, DPH_TABLE
 497:					;RAM:DC9C 32 64 E0                 ld      (_DSK), a
 498:				
 499:     -	3203          		dwstore	_CPM1_r_p_DSK1+1	,0xE064 	;read
 499:     -	3203  54      		db 	pW_STORE
 499:     -	3204  64E0    		dw 	0xE064
 499:     -	3206  1CE9    		dw 	_CPM1_r_p_DSK1+1
 499:     -	3208          		endm
 500:     -	3208          		dwstore	_CPM1_r_p_TRK1+1	,0xE068 	
 500:     -	3208  54      		db 	pW_STORE
 500:     -	3209  68E0    		dw 	0xE068
 500:     -	320B  37E9    		dw 	_CPM1_r_p_TRK1+1
 500:     -	320D          		endm
 501:     -	320D          		dwstore	_CPM1_r_p_SEC1+1	,0xE069 	
 501:     -	320D  54      		db 	pW_STORE
 501:     -	320E  69E0    		dw 	0xE069
 501:     -	3210  3DE9    		dw 	_CPM1_r_p_SEC1+1
 501:     -	3212          		endm
 502:     -	3212          		dwstore	_CPM1_r_p_DMA1+1	,0xE06A 	
 502:     -	3212  54      		db 	pW_STORE
 502:     -	3213  6AE0    		dw 	0xE06A
 502:     -	3215  4EE9    		dw 	_CPM1_r_p_DMA1+1
 502:     -	3217          		endm
 503:				
 504:     -	3217          		dwstore	_CPM1_r_p_DSK2+1	,0xE064 	;write
 504:     -	3217  54      		db 	pW_STORE
 504:     -	3218  64E0    		dw 	0xE064
 504:     -	321A  59E9    		dw 	_CPM1_r_p_DSK2+1
 504:     -	321C          		endm
 505:     -	321C          		dwstore	_CPM1_r_p_TRK2+1	,0xE068 	
 505:     -	321C  54      		db 	pW_STORE
 505:     -	321D  68E0    		dw 	0xE068
 505:     -	321F  74E9    		dw 	_CPM1_r_p_TRK2+1
 505:     -	3221          		endm
 506:     -	3221          		dwstore	_CPM1_r_p_SEC2+1	,0xE069 	
 506:     -	3221  54      		db 	pW_STORE
 506:     -	3222  69E0    		dw 	0xE069
 506:     -	3224  7AE9    		dw 	_CPM1_r_p_SEC2+1
 506:     -	3226          		endm
 507:     -	3226          		dwstore	_CPM1_r_p_DMA2+1	,0xE06A 	
 507:     -	3226  54      		db 	pW_STORE
 507:     -	3227  6AE0    		dw 	0xE06A
 507:     -	3229  8BE9    		dw 	_CPM1_r_p_DMA2+1
 507:     -	322B          		endm
 508:				
 509:     -	322B          		dwstore	_CPM1_r_p_DSK3+1	,0xE064 	;readinfo
 509:     -	322B  54      		db 	pW_STORE
 509:     -	322C  64E0    		dw 	0xE064
 509:     -	322E  28EA    		dw 	_CPM1_r_p_DSK3+1
 509:     -	3230          		endm
 510:				
 511:				
 512:					;KEY_HOOK:---------------------------------------------------------------------------
 513:					;VINTKBDADDR,VINTKBDVALUE,KBD_HOOK_PROC
 514:					;перехватываем нажатие комбинации клавиш CTRL+SHIFT+STOP
 515:					;планируется что по нажатии этой комбинации - содержимое диска E
 516:					;будет перезаписано содержимым на котором записан - 
 517:					;MOUNT и другие служебные утилиты для работы с EXTROM API 
 518:					;к сожадлению нет общего для всех кода
 519:					;точнее самые старые биосы - требуют "особых" отношений
 520:					;там немного по другому драйвер клавиатуры возвращает коды.
 521:					;
 522:					;kbd_hook_noCtrl_03 - '12_87_09_NIIJAF'	и производных от него '1x_88_EPSON_V104','1x_89_03_30_RAVI'
 523:					;kbd_hook_noCtrl_33 - '12_87_11_niijaf'
 524:					;kbd_hook_2133      - все остальные
 525:				
 526:					;по сути, мы подменяем перехватываем обработчик VTRAP8_pseudoKBD
 527:					;как найти 
 528:				
 529:					;в HWINIT есть копирование стандартной таблицы векторов VTRAP в рабочее место
 530:					;вот ее мы и патчим
 531:					;в коде ниже это адрес 0xdc46 и значение 0xdc46
 532:				
 533:					;RAM:DA00          _BOOT:
 534:					;RAM:DA00 C3 42 DB                 jp      j_BOOT
 535:					;...
 536:					;RAM:DB42          j_BOOT:                                 
 537:					;RAM:DB42 F3                       di
 538:					;RAM:DB43 31 80 00                 ld      sp, 80h ; 'Ç'
 539:					;RAM:DB46 3E 1C                    ld      a, 1Ch
 540:					;RAM:DB48 32 7F FA                 ld      (_1C_SysReg1C), a
 541:					;RAM:DB4B 32 03 F7                 ld      (SysCOPY), a
 542:					;RAM:DB4E CD 0A E4                 call    HW_Init
 543:					;....
 544:					;RAM:E40A          HW_Init:                                
 545:					;RAM:E40A                                                  
 546:					;RAM:E40A F3                       di
 547:					;RAM:E40B 11 D1 E3                 ld      de, IntstINTAB
 548:					;RAM:E40E 21 C6 F7                 ld      hl, _xVTRAP
 549:					;RAM:E411 01 3A 00                 ld      bc, 58
 550:					;RAM:E414 CD 3A E0                 call    _LDIR
 551:					;....
 552:					;RAM:E3D1 D3 E3    IntstINTAB:     dw off_E3D3             
 553:					;RAM:E3D3 0C DC    off_E3D3:       dw _EOI                 
 554:					;RAM:E3D3                                                  
 555:					;RAM:E3D5 0C DC                    dw _EOI
 556:					;RAM:E3D7 0C DC                    dw _EOI
 557:					;RAM:E3D9 0C DC                    dw _EOI
 558:					;RAM:E3DB 1C DC                    dw VINT_VBL
 559:					;RAM:E3DD 0C DC                    dw _EOI
 560:					;RAM:E3DF 0C DC                    dw _EOI
 561:					;RAM:E3E1 0C DC                    dw _EOI
 562:					;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 563:					;RAM:E3E3 46 DC                    dw VINT_KBD
 564:					;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 565:					;RAM:E3E5 00 00                    dw 0
 566:					;RAM:E3E7 00 00                    dw 0
 567:					;RAM:E3E9 00 00                    dw 0
 568:					
 569:					;support removed
 570:					;dwpatch	#_CPM1_VINTKBDADDR#	,#_CPM1_VINTKBDVALUE#	,#_CPM1_KBD_HOOK_PROC#
 571:					;dwstore	_CPM1_old_hook+1	,#_CPM1_VINTKBDVALUE#
 572:				
 573:					;custom checkers
 574:     -	3230          		dwpatch	0xDCBB+1	,0xE06E ,0xE06E
 574:     -	3230  51      		db 	pW_CHK_PATCH
 574:     -	3231  BCDC    		dw 	0xDCBB+1
 574:     -	3233  6EE06EE0		dw 	0xE06E,0xE06E
 574:     -	3237          		endm
 575:				
 576:					;STOP-------------------------------------------------------------------------------
 577:     -	3237          		stop 'CPM_21_89___wiza'
 577:     -	3237  50      		db 	p_STOP
 577:     -	3238  43504D5F		db 	'CPM_21_89___wiza'
	      32315F38
	      395F5F5F
	      77697A61
 577:     -	3248  00      		db 	0
 577:     -	3249          		endm
**** out/include-patcher.asm ****
  34:					include "generator/V0/out/patcher-microdos-MICRODOS_OPTS2_880630.asm"	; 42 images in collection
**** generator/V0/out/patcher-microdos-MICRODOS_OPTS2_880630.asm ****
   1:     -	3249          	_BIOS_MICRODOS_OPTS2_880630:
   2:     -	3249          		setMICRODOS
   2:     -	3249  56      		db 	pSETFLAG_MICRODOS
   2:     -	324A          		endm
   3:     -	324A          		RQ_OPTS2
   3:     -	324A  58      		db 	pREQUIRED_OPTS2
   3:     -	324B          		endm
   4:     -	324B          		dbpatchmaybe	0xBEA3	,0x1B	,0x0d
   4:     -	324B  59      		db 	pB_MAYBE_PATCH
   4:     -	324C  A3BE    		dw 	0xBEA3
   4:     -	324E  1B0D    		db 	0x1B,0x0d
   4:     -	3250          		endm
   5:     -	3250          		dbpatchmaybe	0xBEA3+1	,0x45	,0x0d
   5:     -	3250  59      		db 	pB_MAYBE_PATCH
   5:     -	3251  A4BE    		dw 	0xBEA3+1
   5:     -	3253  450D    		db 	0x45,0x0d
   5:     -	3255          		endm
   6:     -	3255          		dwpatch	0xEAFD+1	,0xEB34	,MD_READ			
   6:     -	3255  51      		db 	pW_CHK_PATCH
   6:     -	3256  FEEA    		dw 	0xEAFD+1
   6:     -	3258  34EB3EFA		dw 	0xEB34,MD_READ
   6:     -	325C          		endm
   7:     -	325C          		dwpatch	0xEB02+1	,0xEB9E	,MD_WRITE
   7:     -	325C  51      		db 	pW_CHK_PATCH
   7:     -	325D  03EB    		dw 	0xEB02+1
   7:     -	325F  9EEB53FA		dw 	0xEB9E,MD_WRITE
   7:     -	3263          		endm
   8:     -	3263          		dbpatch	0xEC91	,0xcd	,0x00
   8:     -	3263  52      		db 	pB_CHK_PATCH
   8:     -	3264  91EC    		dw 	0xEC91
   8:     -	3266  CD00    		db 	0xcd,0x00
   8:     -	3268          		endm
   9:     -	3268          		dwpatch	0xEC91+1	,0xee27	,0x0000
   9:     -	3268  51      		db 	pW_CHK_PATCH
   9:     -	3269  92EC    		dw 	0xEC91+1
   9:     -	326B  27EE0000		dw 	0xee27,0x0000
   9:     -	326F          		endm
  10:     -	326F          		dwpatch	0xEC94+1	,0xEE2C	,MD_READ_INFOSECTOR
  10:     -	326F  51      		db 	pW_CHK_PATCH
  10:     -	3270  95EC    		dw 	0xEC94+1
  10:     -	3272  2CEE68FA		dw 	0xEE2C,MD_READ_INFOSECTOR
  10:     -	3276          		endm
  11:     -	3276          		dwstore	MD_DRV2+1,	0xEF23
  11:     -	3276  54      		db 	pW_STORE
  11:     -	3277  23EF    		dw 	0xEF23
  11:     -	3279  F3FA    		dw 	MD_DRV2+1
  11:     -	327B          		endm
  12:     -	327B          		dwstore	MD_RDBUF2+1,	0xEF2B
  12:     -	327B  54      		db 	pW_STORE
  12:     -	327C  2BEF    		dw 	0xEF2B
  12:     -	327E  02FB    		dw 	MD_RDBUF2+1
  12:     -	3280          		endm
  13:     -	3280          		dwstore	MD_PARAM2+1,	0xEF16
  13:     -	3280  54      		db 	pW_STORE
  13:     -	3281  16EF    		dw 	0xEF16
  13:     -	3283  1DFA    		dw 	MD_PARAM2+1
  13:     -	3285          		endm
  14:     -	3285          		dwpatch 0xc01b+1	 ,0xDD88	,md_res_seldsk
  14:     -	3285  51      		db 	pW_CHK_PATCH
  14:     -	3286  1CC0    		dw 	0xc01b+1
  14:     -	3288  88DD0EFA		dw 	0xDD88,md_res_seldsk
  14:     -	328C          		endm
  15:     -	328C          		dwstore md_old_seld_dsk+1,0xDD88	,0xdd4c
  15:     -	328C  54      		db 	pW_STORE
  15:     -	328D  88DD    		dw 	0xDD88
  15:     -	328F  12FA    		dw 	md_old_seld_dsk+1
  15:     -	3291          		endm
  16:					;custom checkers
  17:     -	3291          		dwpatch	0xBD80	,0xBD80 ,0xBD80
  17:     -	3291  51      		db 	pW_CHK_PATCH
  17:     -	3292  80BD    		dw 	0xBD80
  17:     -	3294  80BD80BD		dw 	0xBD80,0xBD80
  17:     -	3298          		endm
  18:     -	3298          		dwpatch	0xBD82	,0xBE00 ,0xBE00
  18:     -	3298  51      		db 	pW_CHK_PATCH
  18:     -	3299  82BD    		dw 	0xBD82
  18:     -	329B  00BE00BE		dw 	0xBE00,0xBE00
  18:     -	329F          		endm
  19:     -	329F          		dwpatch	0xc000+1	,0xC488 ,0xC488
  19:     -	329F  51      		db 	pW_CHK_PATCH
  19:     -	32A0  01C0    		dw 	0xc000+1
  19:     -	32A2  88C488C4		dw 	0xC488,0xC488
  19:     -	32A6          		endm
  20:     -	32A6          		dwpatch	0xc003+1	,0xDBFC ,0xDBFC
  20:     -	32A6  51      		db 	pW_CHK_PATCH
  20:     -	32A7  04C0    		dw 	0xc003+1
  20:     -	32A9  FCDBFCDB		dw 	0xDBFC,0xDBFC
  20:     -	32AD          		endm
  21:     -	32AD          		dbpatch	0xEC4C	,0x21 ,0x21
  21:     -	32AD  52      		db 	pB_CHK_PATCH
  21:     -	32AE  4CEC    		dw 	0xEC4C
  21:     -	32B0  2121    		db 	0x21,0x21
  21:     -	32B2          		endm
  22:     -	32B2          		stop 'MICRODOS_OPTS2_880630'
  22:     -	32B2  50      		db 	p_STOP
  22:     -	32B3  4D494352		db 	'MICRODOS_OPTS2_880630'
	      4F444F53
	      5F4F5054
	      53325F38
	      38303633
	      30
  22:     -	32C8  00      		db 	0
  22:     -	32C9          		endm
**** out/include-patcher.asm ****
  35:					include "generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf2.asm"	; 36 images in collection
**** generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf2.asm ****
   1:     -	32C9          	_BIOS_CPM_21_89_2_niijaf2:
   2:     -	32C9          		setSUBBIOS 1
   2:     -	32C9  5A      		db	pSubBios
   2:     -	32CA  01      		db 	1
   2:     -	32CB          		endm
   3:     -	32CB          		RQ_OPTS_ANY
   3:     -	32CB          		endm
   4:     -	32CB          		setCPM
   4:     -	32CB          		endm
   5:     -	32CB          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	32CB  59      		db 	pB_MAYBE_PATCH
   5:     -	32CC  EEDA    		dw 	0xDAEE
   5:     -	32CE  1F0D    		db 	0x1F,0x0d
   5:     -	32D0          		endm
   6:     -	32D0          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	32D0  59      		db 	pB_MAYBE_PATCH
   6:     -	32D1  F0DA    		dw 	0xDAEE+2
   6:     -	32D3  0A0D    		db 	0x0a,0x0d
   6:     -	32D5          		endm
   7:     -	32D5          		dbpatch	0xE487+1	,0x49	,0xc9
   7:     -	32D5  52      		db 	pB_CHK_PATCH
   7:     -	32D6  88E4    		dw 	0xE487+1
   7:     -	32D8  49C9    		db 	0x49,0xc9
   7:     -	32DA          		endm
   8:     -	32DA          		dbpatch	0xDA89 	,0x01	,0x00
   8:     -	32DA  52      		db 	pB_CHK_PATCH
   8:     -	32DB  89DA    		dw 	0xDA89
   8:     -	32DD  0100    		db 	0x01,0x00
   8:     -	32DF          		endm
   9:     -	32DF          		dbpatch	0xDAA0 	,0x02	,0x00
   9:     -	32DF  52      		db 	pB_CHK_PATCH
   9:     -	32E0  A0DA    		dw 	0xDAA0
   9:     -	32E2  0200    		db 	0x02,0x00
   9:     -	32E4          		endm
  10:     -	32E4          		dbpatch	0xDAB7 	,0x04	,0x01
  10:     -	32E4  52      		db 	pB_CHK_PATCH
  10:     -	32E5  B7DA    		dw 	0xDAB7
  10:     -	32E7  0401    		db 	0x04,0x01
  10:     -	32E9          		endm
  11:     -	32E9          		dbpatch	0xDACE 	,0x08	,0x02
  11:     -	32E9  52      		db 	pB_CHK_PATCH
  11:     -	32EA  CEDA    		dw 	0xDACE
  11:     -	32EC  0802    		db 	0x08,0x02
  11:     -	32EE          		endm
  12:     -	32EE          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
  12:     -	32EE  54      		db 	pW_STORE
  12:     -	32EF  89DA    		dw 	0xDA89
  12:     -	32F1  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	32F3          		endm
  13:     -	32F3          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
  13:     -	32F3  54      		db 	pW_STORE
  13:     -	32F4  A0DA    		dw 	0xDAA0
  13:     -	32F6  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	32F8          		endm
  14:     -	32F8          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
  14:     -	32F8  54      		db 	pW_STORE
  14:     -	32F9  B7DA    		dw 	0xDAB7
  14:     -	32FB  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	32FD          		endm
  15:     -	32FD          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
  15:     -	32FD  54      		db 	pW_STORE
  15:     -	32FE  CEDA    		dw 	0xDACE
  15:     -	3300  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	3302          		endm
  16:     -	3302          		dwpatch 0xDCBB+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	3302  51      		db 	pW_CHK_PATCH
  16:     -	3303  C5DC    		dw 	0xDCBB+5*2
  16:     -	3305  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	3309          		endm
  17:     -	3309          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	3309  54      		db 	pW_STORE
  17:     -	330A  A6EB    		dw 	0xEBA6
  17:     -	330C  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	330E          		endm
  18:     -	330E          		dwpatch 0xDA1B+1 	,0xDC7C	,_CPM1_res_seldsk
  18:     -	330E  51      		db 	pW_CHK_PATCH
  18:     -	330F  1CDA    		dw 	0xDA1B+1
  18:     -	3311  7CDC11E9		dw 	0xDC7C,_CPM1_res_seldsk
  18:     -	3315          		endm
  19:     -	3315          		dwstore	_CPM1_old_seld_dsk+1	,0xDC7C
  19:     -	3315  54      		db 	pW_STORE
  19:     -	3316  7CDC    		dw 	0xDC7C
  19:     -	3318  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	331A          		endm
  20:     -	331A          		dbpatch	0xE6F2	,0x77	,0x00
  20:     -	331A  52      		db 	pB_CHK_PATCH
  20:     -	331B  F2E6    		dw 	0xE6F2
  20:     -	331D  7700    		db 	0x77,0x00
  20:     -	331F          		endm
  21:     -	331F          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE056
  21:     -	331F  54      		db 	pW_STORE
  21:     -	3320  56E0    		dw 	0xE056
  21:     -	3322  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	3324          		endm
  22:     -	3324          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE056
  22:     -	3324  54      		db 	pW_STORE
  22:     -	3325  56E0    		dw 	0xE056
  22:     -	3327  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	3329          		endm
  23:     -	3329          		dwpatch	0xDA27+1	,0xDCDA	,_CPM1_res_READ
  23:     -	3329  51      		db 	pW_CHK_PATCH
  23:     -	332A  28DA    		dw 	0xDA27+1
  23:     -	332C  DADC1BE9		dw 	0xDCDA,_CPM1_res_READ
  23:     -	3330          		endm
  24:     -	3330          		dwpatch	0xDA2A+1	,0xDE97	,_CPM1_res_WRITE
  24:     -	3330  51      		db 	pW_CHK_PATCH
  24:     -	3331  2BDA    		dw 	0xDA2A+1
  24:     -	3333  97DE58E9		dw 	0xDE97,_CPM1_res_WRITE
  24:     -	3337          		endm
  25:     -	3337          		dwpatch	0xDB73+1	,0xDCDA	,_CPM1_res_READ
  25:     -	3337  51      		db 	pW_CHK_PATCH
  25:     -	3338  74DB    		dw 	0xDB73+1
  25:     -	333A  DADC1BE9		dw 	0xDCDA,_CPM1_res_READ
  25:     -	333E          		endm
  26:     -	333E          		dwpatch	0xdcae+1	,0xE630	,_CPM1_res_GETINFO
  26:     -	333E  51      		db 	pW_CHK_PATCH
  26:     -	333F  AFDC    		dw 	0xdcae+1
  26:     -	3341  30E695E9		dw 	0xE630,_CPM1_res_GETINFO
  26:     -	3345          		endm
  27:     -	3345          		dwstore	_CPM1__old_read+1	,0xDCDA
  27:     -	3345  54      		db 	pW_STORE
  27:     -	3346  DADC    		dw 	0xDCDA
  27:     -	3348  56E9    		dw 	_CPM1__old_read+1
  27:     -	334A          		endm
  28:     -	334A          		dwstore	_CPM1__old_write+1	,0xDE97
  28:     -	334A  54      		db 	pW_STORE
  28:     -	334B  97DE    		dw 	0xDE97
  28:     -	334D  93E9    		dw 	_CPM1__old_write+1
  28:     -	334F          		endm
  29:     -	334F          		dwstore	_CPM1__old_getinfo+1	,0xE630
  29:     -	334F  54      		db 	pW_STORE
  29:     -	3350  30E6    		dw 	0xE630
  29:     -	3352  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	3354          		endm
  30:     -	3354          		dbpatch	0xE667		,0x21	,0x21
  30:     -	3354  52      		db 	pB_CHK_PATCH
  30:     -	3355  67E6    		dw 	0xE667
  30:     -	3357  2121    		db 	0x21,0x21
  30:     -	3359          		endm
  31:     -	3359          		dwpatch	0xE667+1 	,0xE697	,0xE697
  31:     -	3359  51      		db 	pW_CHK_PATCH
  31:     -	335A  68E6    		dw 	0xE667+1
  31:     -	335C  97E697E6		dw 	0xE697,0xE697
  31:     -	3360          		endm
  32:     -	3360          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE667
  32:     -	3360  54      		db 	pW_STORE
  32:     -	3361  67E6    		dw 	0xE667
  32:     -	3363  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	3365          		endm
  33:     -	3365          		dwstore	_CPM1_r_p_DSK1+1	,0xE04C 	;read
  33:     -	3365  54      		db 	pW_STORE
  33:     -	3366  4CE0    		dw 	0xE04C
  33:     -	3368  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	336A          		endm
  34:     -	336A          		dwstore	_CPM1_r_p_TRK1+1	,0xE050 	
  34:     -	336A  54      		db 	pW_STORE
  34:     -	336B  50E0    		dw 	0xE050
  34:     -	336D  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	336F          		endm
  35:     -	336F          		dwstore	_CPM1_r_p_SEC1+1	,0xE051 	
  35:     -	336F  54      		db 	pW_STORE
  35:     -	3370  51E0    		dw 	0xE051
  35:     -	3372  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	3374          		endm
  36:     -	3374          		dwstore	_CPM1_r_p_DMA1+1	,0xE052 	
  36:     -	3374  54      		db 	pW_STORE
  36:     -	3375  52E0    		dw 	0xE052
  36:     -	3377  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	3379          		endm
  37:     -	3379          		dwstore	_CPM1_r_p_DSK2+1	,0xE04C 	;write
  37:     -	3379  54      		db 	pW_STORE
  37:     -	337A  4CE0    		dw 	0xE04C
  37:     -	337C  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	337E          		endm
  38:     -	337E          		dwstore	_CPM1_r_p_TRK2+1	,0xE050 	
  38:     -	337E  54      		db 	pW_STORE
  38:     -	337F  50E0    		dw 	0xE050
  38:     -	3381  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	3383          		endm
  39:     -	3383          		dwstore	_CPM1_r_p_SEC2+1	,0xE051 	
  39:     -	3383  54      		db 	pW_STORE
  39:     -	3384  51E0    		dw 	0xE051
  39:     -	3386  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	3388          		endm
  40:     -	3388          		dwstore	_CPM1_r_p_DMA2+1	,0xE052 	
  40:     -	3388  54      		db 	pW_STORE
  40:     -	3389  52E0    		dw 	0xE052
  40:     -	338B  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	338D          		endm
  41:     -	338D          		dwstore	_CPM1_r_p_DSK3+1	,0xE04C 	;readinfo
  41:     -	338D  54      		db 	pW_STORE
  41:     -	338E  4CE0    		dw 	0xE04C
  41:     -	3390  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	3392          		endm
  42:				
  43:     -	3392          		stop 'CPM_21_89_2_niijaf2'
  43:     -	3392  50      		db 	p_STOP
  43:     -	3393  43504D5F		db 	'CPM_21_89_2_niijaf2'
	      32315F38
	      395F325F
	      6E69696A
	      616632
  43:     -	33A6  00      		db 	0
  43:     -	33A7          		endm
**** out/include-patcher.asm ****
  36:					include "generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf.asm"	; 28 images in collection
**** generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf.asm ****
   1:     -	33A7          	_BIOS_CPM_21_89_2_niijaf:
   2:     -	33A7          		setSUBBIOS 1
   2:     -	33A7  5A      		db	pSubBios
   2:     -	33A8  01      		db 	1
   2:     -	33A9          		endm
   3:     -	33A9          		RQ_OPTS_ANY
   3:     -	33A9          		endm
   4:     -	33A9          		setCPM
   4:     -	33A9          		endm
   5:     -	33A9          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	33A9  59      		db 	pB_MAYBE_PATCH
   5:     -	33AA  EEDA    		dw 	0xDAEE
   5:     -	33AC  1F0D    		db 	0x1F,0x0d
   5:     -	33AE          		endm
   6:     -	33AE          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	33AE  59      		db 	pB_MAYBE_PATCH
   6:     -	33AF  F0DA    		dw 	0xDAEE+2
   6:     -	33B1  0A0D    		db 	0x0a,0x0d
   6:     -	33B3          		endm
   7:     -	33B3          		dbpatch	0xE48E+1	,0x49	,0xc9
   7:     -	33B3  52      		db 	pB_CHK_PATCH
   7:     -	33B4  8FE4    		dw 	0xE48E+1
   7:     -	33B6  49C9    		db 	0x49,0xc9
   7:     -	33B8          		endm
   8:     -	33B8          		dbpatch	0xDA89 	,0x01	,0x00
   8:     -	33B8  52      		db 	pB_CHK_PATCH
   8:     -	33B9  89DA    		dw 	0xDA89
   8:     -	33BB  0100    		db 	0x01,0x00
   8:     -	33BD          		endm
   9:     -	33BD          		dbpatch	0xDAA0 	,0x02	,0x00
   9:     -	33BD  52      		db 	pB_CHK_PATCH
   9:     -	33BE  A0DA    		dw 	0xDAA0
   9:     -	33C0  0200    		db 	0x02,0x00
   9:     -	33C2          		endm
  10:     -	33C2          		dbpatch	0xDAB7 	,0x04	,0x01
  10:     -	33C2  52      		db 	pB_CHK_PATCH
  10:     -	33C3  B7DA    		dw 	0xDAB7
  10:     -	33C5  0401    		db 	0x04,0x01
  10:     -	33C7          		endm
  11:     -	33C7          		dbpatch	0xDACE 	,0x08	,0x02
  11:     -	33C7  52      		db 	pB_CHK_PATCH
  11:     -	33C8  CEDA    		dw 	0xDACE
  11:     -	33CA  0802    		db 	0x08,0x02
  11:     -	33CC          		endm
  12:     -	33CC          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
  12:     -	33CC  54      		db 	pW_STORE
  12:     -	33CD  89DA    		dw 	0xDA89
  12:     -	33CF  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	33D1          		endm
  13:     -	33D1          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
  13:     -	33D1  54      		db 	pW_STORE
  13:     -	33D2  A0DA    		dw 	0xDAA0
  13:     -	33D4  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	33D6          		endm
  14:     -	33D6          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
  14:     -	33D6  54      		db 	pW_STORE
  14:     -	33D7  B7DA    		dw 	0xDAB7
  14:     -	33D9  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	33DB          		endm
  15:     -	33DB          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
  15:     -	33DB  54      		db 	pW_STORE
  15:     -	33DC  CEDA    		dw 	0xDACE
  15:     -	33DE  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	33E0          		endm
  16:     -	33E0          		dwpatch 0xDCBB+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	33E0  51      		db 	pW_CHK_PATCH
  16:     -	33E1  C5DC    		dw 	0xDCBB+5*2
  16:     -	33E3  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	33E7          		endm
  17:     -	33E7          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	33E7  54      		db 	pW_STORE
  17:     -	33E8  A6EB    		dw 	0xEBA6
  17:     -	33EA  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	33EC          		endm
  18:     -	33EC          		dwpatch 0xDA1B+1 	,0xDC7C	,_CPM1_res_seldsk
  18:     -	33EC  51      		db 	pW_CHK_PATCH
  18:     -	33ED  1CDA    		dw 	0xDA1B+1
  18:     -	33EF  7CDC11E9		dw 	0xDC7C,_CPM1_res_seldsk
  18:     -	33F3          		endm
  19:     -	33F3          		dwstore	_CPM1_old_seld_dsk+1	,0xDC7C
  19:     -	33F3  54      		db 	pW_STORE
  19:     -	33F4  7CDC    		dw 	0xDC7C
  19:     -	33F6  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	33F8          		endm
  20:     -	33F8          		dbpatch	0xE6F9	,0x77	,0x00
  20:     -	33F8  52      		db 	pB_CHK_PATCH
  20:     -	33F9  F9E6    		dw 	0xE6F9
  20:     -	33FB  7700    		db 	0x77,0x00
  20:     -	33FD          		endm
  21:     -	33FD          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE05D
  21:     -	33FD  54      		db 	pW_STORE
  21:     -	33FE  5DE0    		dw 	0xE05D
  21:     -	3400  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	3402          		endm
  22:     -	3402          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE05D
  22:     -	3402  54      		db 	pW_STORE
  22:     -	3403  5DE0    		dw 	0xE05D
  22:     -	3405  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	3407          		endm
  23:     -	3407          		dwpatch	0xDA27+1	,0xDCDA	,_CPM1_res_READ
  23:     -	3407  51      		db 	pW_CHK_PATCH
  23:     -	3408  28DA    		dw 	0xDA27+1
  23:     -	340A  DADC1BE9		dw 	0xDCDA,_CPM1_res_READ
  23:     -	340E          		endm
  24:     -	340E          		dwpatch	0xDA2A+1	,0xDE9E	,_CPM1_res_WRITE
  24:     -	340E  51      		db 	pW_CHK_PATCH
  24:     -	340F  2BDA    		dw 	0xDA2A+1
  24:     -	3411  9EDE58E9		dw 	0xDE9E,_CPM1_res_WRITE
  24:     -	3415          		endm
  25:     -	3415          		dwpatch	0xDB73+1	,0xDCDA	,_CPM1_res_READ
  25:     -	3415  51      		db 	pW_CHK_PATCH
  25:     -	3416  74DB    		dw 	0xDB73+1
  25:     -	3418  DADC1BE9		dw 	0xDCDA,_CPM1_res_READ
  25:     -	341C          		endm
  26:     -	341C          		dwpatch	0xdcae+1	,0xE637	,_CPM1_res_GETINFO
  26:     -	341C  51      		db 	pW_CHK_PATCH
  26:     -	341D  AFDC    		dw 	0xdcae+1
  26:     -	341F  37E695E9		dw 	0xE637,_CPM1_res_GETINFO
  26:     -	3423          		endm
  27:     -	3423          		dwstore	_CPM1__old_read+1	,0xDCDA
  27:     -	3423  54      		db 	pW_STORE
  27:     -	3424  DADC    		dw 	0xDCDA
  27:     -	3426  56E9    		dw 	_CPM1__old_read+1
  27:     -	3428          		endm
  28:     -	3428          		dwstore	_CPM1__old_write+1	,0xDE9E
  28:     -	3428  54      		db 	pW_STORE
  28:     -	3429  9EDE    		dw 	0xDE9E
  28:     -	342B  93E9    		dw 	_CPM1__old_write+1
  28:     -	342D          		endm
  29:     -	342D          		dwstore	_CPM1__old_getinfo+1	,0xE637
  29:     -	342D  54      		db 	pW_STORE
  29:     -	342E  37E6    		dw 	0xE637
  29:     -	3430  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	3432          		endm
  30:     -	3432          		dbpatch	0xE66E		,0x21	,0x21
  30:     -	3432  52      		db 	pB_CHK_PATCH
  30:     -	3433  6EE6    		dw 	0xE66E
  30:     -	3435  2121    		db 	0x21,0x21
  30:     -	3437          		endm
  31:     -	3437          		dwpatch	0xE66E+1 	,0xE69E	,0xE69E
  31:     -	3437  51      		db 	pW_CHK_PATCH
  31:     -	3438  6FE6    		dw 	0xE66E+1
  31:     -	343A  9EE69EE6		dw 	0xE69E,0xE69E
  31:     -	343E          		endm
  32:     -	343E          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE66E
  32:     -	343E  54      		db 	pW_STORE
  32:     -	343F  6EE6    		dw 	0xE66E
  32:     -	3441  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	3443          		endm
  33:     -	3443          		dwstore	_CPM1_r_p_DSK1+1	,0xE053 	;read
  33:     -	3443  54      		db 	pW_STORE
  33:     -	3444  53E0    		dw 	0xE053
  33:     -	3446  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	3448          		endm
  34:     -	3448          		dwstore	_CPM1_r_p_TRK1+1	,0xE057 	
  34:     -	3448  54      		db 	pW_STORE
  34:     -	3449  57E0    		dw 	0xE057
  34:     -	344B  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	344D          		endm
  35:     -	344D          		dwstore	_CPM1_r_p_SEC1+1	,0xE058 	
  35:     -	344D  54      		db 	pW_STORE
  35:     -	344E  58E0    		dw 	0xE058
  35:     -	3450  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	3452          		endm
  36:     -	3452          		dwstore	_CPM1_r_p_DMA1+1	,0xE059 	
  36:     -	3452  54      		db 	pW_STORE
  36:     -	3453  59E0    		dw 	0xE059
  36:     -	3455  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	3457          		endm
  37:     -	3457          		dwstore	_CPM1_r_p_DSK2+1	,0xE053 	;write
  37:     -	3457  54      		db 	pW_STORE
  37:     -	3458  53E0    		dw 	0xE053
  37:     -	345A  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	345C          		endm
  38:     -	345C          		dwstore	_CPM1_r_p_TRK2+1	,0xE057 	
  38:     -	345C  54      		db 	pW_STORE
  38:     -	345D  57E0    		dw 	0xE057
  38:     -	345F  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	3461          		endm
  39:     -	3461          		dwstore	_CPM1_r_p_SEC2+1	,0xE058 	
  39:     -	3461  54      		db 	pW_STORE
  39:     -	3462  58E0    		dw 	0xE058
  39:     -	3464  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	3466          		endm
  40:     -	3466          		dwstore	_CPM1_r_p_DMA2+1	,0xE059 	
  40:     -	3466  54      		db 	pW_STORE
  40:     -	3467  59E0    		dw 	0xE059
  40:     -	3469  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	346B          		endm
  41:     -	346B          		dwstore	_CPM1_r_p_DSK3+1	,0xE053 	;readinfo
  41:     -	346B  54      		db 	pW_STORE
  41:     -	346C  53E0    		dw 	0xE053
  41:     -	346E  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	3470          		endm
  42:				
  43:     -	3470          		stop 'CPM_21_89_2_niijaf'
  43:     -	3470  50      		db 	p_STOP
  43:     -	3471  43504D5F		db 	'CPM_21_89_2_niijaf'
	      32315F38
	      395F325F
	      6E69696A
	      6166
  43:     -	3483  00      		db 	0
  43:     -	3484          		endm
**** out/include-patcher.asm ****
  37:					include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_870430.asm"	; 28 images in collection
**** generator/V0/out/patcher-microdos-MICRODOS_OPTS1_870430.asm ****
   1:     -	3484          	_BIOS_MICRODOS_OPTS1_870430:
   2:     -	3484          		setMICRODOS
   2:     -	3484  56      		db 	pSETFLAG_MICRODOS
   2:     -	3485          		endm
   3:     -	3485          		RQ_OPTS1
   3:     -	3485  57      		db 	pREQUIRED_OPTS1
   3:     -	3486          		endm
   4:     -	3486          		dbpatchmaybe	0xE5A2	,0x1B	,0x0d
   4:     -	3486  59      		db 	pB_MAYBE_PATCH
   4:     -	3487  A2E5    		dw 	0xE5A2
   4:     -	3489  1B0D    		db 	0x1B,0x0d
   4:     -	348B          		endm
   5:     -	348B          		dbpatchmaybe	0xE5A2+1	,0x45	,0x0d
   5:     -	348B  59      		db 	pB_MAYBE_PATCH
   5:     -	348C  A3E5    		dw 	0xE5A2+1
   5:     -	348E  450D    		db 	0x45,0x0d
   5:     -	3490          		endm
   6:     -	3490          		dwpatch	0xE497+1	,0xE627	,MD_READ			
   6:     -	3490  51      		db 	pW_CHK_PATCH
   6:     -	3491  98E4    		dw 	0xE497+1
   6:     -	3493  27E63EFA		dw 	0xE627,MD_READ
   6:     -	3497          		endm
   7:     -	3497          		dwpatch	0xE4A0+1	,0xE62A	,MD_WRITE
   7:     -	3497  51      		db 	pW_CHK_PATCH
   7:     -	3498  A1E4    		dw 	0xE4A0+1
   7:     -	349A  2AE653FA		dw 	0xE62A,MD_WRITE
   7:     -	349E          		endm
   8:     -	349E          		dbpatch	0xEAAE	,0xcd	,0x00
   8:     -	349E  52      		db 	pB_CHK_PATCH
   8:     -	349F  AEEA    		dw 	0xEAAE
   8:     -	34A1  CD00    		db 	0xcd,0x00
   8:     -	34A3          		endm
   9:     -	34A3          		dwpatch	0xEAAE+1	,0xE9E9	,0x0000
   9:     -	34A3  51      		db 	pW_CHK_PATCH
   9:     -	34A4  AFEA    		dw 	0xEAAE+1
   9:     -	34A6  E9E90000		dw 	0xE9E9,0x0000
   9:     -	34AA          		endm
  10:     -	34AA          		dwpatch	0xEAB4+1	,0xEC5D	,MD_READ_INFOSECTOR
  10:     -	34AA  51      		db 	pW_CHK_PATCH
  10:     -	34AB  B5EA    		dw 	0xEAB4+1
  10:     -	34AD  5DEC68FA		dw 	0xEC5D,MD_READ_INFOSECTOR
  10:     -	34B1          		endm
  11:     -	34B1          		dwstore	MD_DRV2+1,	0xDF5A
  11:     -	34B1  54      		db 	pW_STORE
  11:     -	34B2  5ADF    		dw 	0xDF5A
  11:     -	34B4  F3FA    		dw 	MD_DRV2+1
  11:     -	34B6          		endm
  12:     -	34B6          		dwstore	MD_RDBUF2+1,	0xE09A
  12:     -	34B6  54      		db 	pW_STORE
  12:     -	34B7  9AE0    		dw 	0xE09A
  12:     -	34B9  02FB    		dw 	MD_RDBUF2+1
  12:     -	34BB          		endm
  13:     -	34BB          		dwstore	MD_PARAM2+1,	0xDDC1
  13:     -	34BB  54      		db 	pW_STORE
  13:     -	34BC  C1DD    		dw 	0xDDC1
  13:     -	34BE  1DFA    		dw 	MD_PARAM2+1
  13:     -	34C0          		endm
  14:     -	34C0          		dwpatch 0xc01b+1	 ,0xDD8B	,md_res_seldsk
  14:     -	34C0  51      		db 	pW_CHK_PATCH
  14:     -	34C1  1CC0    		dw 	0xc01b+1
  14:     -	34C3  8BDD0EFA		dw 	0xDD8B,md_res_seldsk
  14:     -	34C7          		endm
  15:     -	34C7          		dwstore md_old_seld_dsk+1,0xDD8B	,0xdd4c
  15:     -	34C7  54      		db 	pW_STORE
  15:     -	34C8  8BDD    		dw 	0xDD8B
  15:     -	34CA  12FA    		dw 	md_old_seld_dsk+1
  15:     -	34CC          		endm
  16:					;custom checkers
  17:     -	34CC          		dwpatch	0xBE80	,0xBE80 ,0xBE80
  17:     -	34CC  51      		db 	pW_CHK_PATCH
  17:     -	34CD  80BE    		dw 	0xBE80
  17:     -	34CF  80BE80BE		dw 	0xBE80,0xBE80
  17:     -	34D3          		endm
  18:     -	34D3          		dwpatch	0xBE82	,0xBF00 ,0xBF00
  18:     -	34D3  51      		db 	pW_CHK_PATCH
  18:     -	34D4  82BE    		dw 	0xBE82
  18:     -	34D6  00BF00BF		dw 	0xBF00,0xBF00
  18:     -	34DA          		endm
  19:     -	34DA          		dwpatch	0xc000+1	,0xC49A ,0xC49A
  19:     -	34DA  51      		db 	pW_CHK_PATCH
  19:     -	34DB  01C0    		dw 	0xc000+1
  19:     -	34DD  9AC49AC4		dw 	0xC49A,0xC49A
  19:     -	34E1          		endm
  20:     -	34E1          		dwpatch	0xc003+1	,0xDBFD ,0xDBFD
  20:     -	34E1  51      		db 	pW_CHK_PATCH
  20:     -	34E2  04C0    		dw 	0xc003+1
  20:     -	34E4  FDDBFDDB		dw 	0xDBFD,0xDBFD
  20:     -	34E8          		endm
  21:     -	34E8          		stop 'MICRODOS_OPTS1_870430'
  21:     -	34E8  50      		db 	p_STOP
  21:     -	34E9  4D494352		db 	'MICRODOS_OPTS1_870430'
	      4F444F53
	      5F4F5054
	      53315F38
	      37303433
	      30
  21:     -	34FE  00      		db 	0
  21:     -	34FF          		endm
**** out/include-patcher.asm ****
  38:					include "generator/V0/out/patcher-cpm2-CPM_1x_89_03_30_RAVI.asm"	; 17 images in collection
**** generator/V0/out/patcher-cpm2-CPM_1x_89_03_30_RAVI.asm ****
   1:     -	34FF          	_BIOS_CPM_1x_89_03_30_RAVI:
   2:     -	34FF          		setSUBBIOS 2
   2:     -	34FF  5A      		db	pSubBios
   2:     -	3500  02      		db 	2
   2:     -	3501          		endm
   3:     -	3501          		RQ_OPTS1
   3:     -	3501  57      		db 	pREQUIRED_OPTS1
   3:     -	3502          		endm
   4:     -	3502          		setCPM
   4:     -	3502          		endm
   5:     -	3502          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	3502  59      		db 	pB_MAYBE_PATCH
   5:     -	3503  EEDA    		dw 	0xDAEE
   5:     -	3505  1F0D    		db 	0x1F,0x0d
   5:     -	3507          		endm
   6:     -	3507          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	3507  59      		db 	pB_MAYBE_PATCH
   6:     -	3508  F0DA    		dw 	0xDAEE+2
   6:     -	350A  0A0D    		db 	0x0a,0x0d
   6:     -	350C          		endm
   7:     -	350C          		dbpatch	0xE8B8+1	,0x49	,0xc9
   7:     -	350C  52      		db 	pB_CHK_PATCH
   7:     -	350D  B9E8    		dw 	0xE8B8+1
   7:     -	350F  49C9    		db 	0x49,0xc9
   7:     -	3511          		endm
   8:     -	3511          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	3511  52      		db 	pB_CHK_PATCH
   8:     -	3512  88DA    		dw 	0xDA88
   8:     -	3514  0100    		db 	0x01,0x00
   8:     -	3516          		endm
   9:     -	3516          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	3516  52      		db 	pB_CHK_PATCH
   9:     -	3517  9FDA    		dw 	0xDA9F
   9:     -	3519  0200    		db 	0x02,0x00
   9:     -	351B          		endm
  10:     -	351B          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	351B  52      		db 	pB_CHK_PATCH
  10:     -	351C  B6DA    		dw 	0xDAB6
  10:     -	351E  0401    		db 	0x04,0x01
  10:     -	3520          		endm
  11:     -	3520          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	3520  52      		db 	pB_CHK_PATCH
  11:     -	3521  CDDA    		dw 	0xDACD
  11:     -	3523  0802    		db 	0x08,0x02
  11:     -	3525          		endm
  12:     -	3525          		dwstore	_CPM2_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	3525  54      		db 	pW_STORE
  12:     -	3526  88DA    		dw 	0xDA88
  12:     -	3528  06EA    		dw 	_CPM2_res_DRIVE_TAB+0*2
  12:     -	352A          		endm
  13:     -	352A          		dwstore	_CPM2_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	352A  54      		db 	pW_STORE
  13:     -	352B  9FDA    		dw 	0xDA9F
  13:     -	352D  08EA    		dw 	_CPM2_res_DRIVE_TAB+1*2
  13:     -	352F          		endm
  14:     -	352F          		dwstore	_CPM2_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	352F  54      		db 	pW_STORE
  14:     -	3530  B6DA    		dw 	0xDAB6
  14:     -	3532  0AEA    		dw 	_CPM2_res_DRIVE_TAB+2*2
  14:     -	3534          		endm
  15:     -	3534          		dwstore	_CPM2_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	3534  54      		db 	pW_STORE
  15:     -	3535  CDDA    		dw 	0xDACD
  15:     -	3537  0CEA    		dw 	_CPM2_res_DRIVE_TAB+3*2
  15:     -	3539          		endm
  16:     -	3539          		dwpatch 0xDEC6+5*2 	,0x0000 ,_CPM2_dph_F
  16:     -	3539  51      		db 	pW_CHK_PATCH
  16:     -	353A  D0DE    		dw 	0xDEC6+5*2
  16:     -	353C  000012EA		dw 	0x0000,_CPM2_dph_F
  16:     -	3540          		endm
  17:     -	3540          		dwstore _CPM2_dph_F+8	,0xE1AB
  17:     -	3540  54      		db 	pW_STORE
  17:     -	3541  ABE1    		dw 	0xE1AB
  17:     -	3543  1AEA    		dw 	_CPM2_dph_F+8
  17:     -	3545          		endm
  18:     -	3545          		dwpatch 0xDA1B+1 	,0xDE82	,_CPM2_res_seldsk
  18:     -	3545  51      		db 	pW_CHK_PATCH
  18:     -	3546  1CDA    		dw 	0xDA1B+1
  18:     -	3548  82DE6BEA		dw 	0xDE82,_CPM2_res_seldsk
  18:     -	354C          		endm
  19:     -	354C          		dwstore	_CPM2_old_seld_dsk+1	,0xDE82
  19:     -	354C  54      		db 	pW_STORE
  19:     -	354D  82DE    		dw 	0xDE82
  19:     -	354F  6FEA    		dw 	_CPM2_old_seld_dsk+1
  19:     -	3551          		endm
  20:     -	3551          		dbpatch	0xE6DF	,0x77	,0x00
  20:     -	3551  52      		db 	pB_CHK_PATCH
  20:     -	3552  DFE6    		dw 	0xE6DF
  20:     -	3554  7700    		db 	0x77,0x00
  20:     -	3556          		endm
  21:     -	3556          		dwstore	_CPM2_r_p_SELDSKDRIVER+1	,0xE199
  21:     -	3556  54      		db 	pW_STORE
  21:     -	3557  99E1    		dw 	0xE199
  21:     -	3559  88EA    		dw 	_CPM2_r_p_SELDSKDRIVER+1
  21:     -	355B          		endm
  22:     -	355B          		dwstore	_CPM2_r_p_SELDSKDRIVEW+1	,0xE199
  22:     -	355B  54      		db 	pW_STORE
  22:     -	355C  99E1    		dw 	0xE199
  22:     -	355E  C5EA    		dw 	_CPM2_r_p_SELDSKDRIVEW+1
  22:     -	3560          		endm
  23:     -	3560          		dwpatch	0xDA27+1	,0xDEE5	,_CPM2_res_READ
  23:     -	3560  51      		db 	pW_CHK_PATCH
  23:     -	3561  28DA    		dw 	0xDA27+1
  23:     -	3563  E5DE75EA		dw 	0xDEE5,_CPM2_res_READ
  23:     -	3567          		endm
  24:     -	3567          		dwpatch	0xDA2A+1	,0xE01B	,_CPM2_res_WRITE
  24:     -	3567  51      		db 	pW_CHK_PATCH
  24:     -	3568  2BDA    		dw 	0xDA2A+1
  24:     -	356A  1BE0B2EA		dw 	0xE01B,_CPM2_res_WRITE
  24:     -	356E          		endm
  25:     -	356E          		dwpatch	0xDBC2+1	,0xDEE5	,_CPM2_res_READ
  25:     -	356E  51      		db 	pW_CHK_PATCH
  25:     -	356F  C3DB    		dw 	0xDBC2+1
  25:     -	3571  E5DE75EA		dw 	0xDEE5,_CPM2_res_READ
  25:     -	3575          		endm
  26:     -	3575          		dwpatch	0xdeb4+1	,0xE615	,_CPM2_res_GETINFO
  26:     -	3575  51      		db 	pW_CHK_PATCH
  26:     -	3576  B5DE    		dw 	0xdeb4+1
  26:     -	3578  15E6EFEA		dw 	0xE615,_CPM2_res_GETINFO
  26:     -	357C          		endm
  27:     -	357C          		dwstore	_CPM2__old_read+1	,0xDEE5
  27:     -	357C  54      		db 	pW_STORE
  27:     -	357D  E5DE    		dw 	0xDEE5
  27:     -	357F  B0EA    		dw 	_CPM2__old_read+1
  27:     -	3581          		endm
  28:     -	3581          		dwstore	_CPM2__old_write+1	,0xE01B
  28:     -	3581  54      		db 	pW_STORE
  28:     -	3582  1BE0    		dw 	0xE01B
  28:     -	3584  EDEA    		dw 	_CPM2__old_write+1
  28:     -	3586          		endm
  29:     -	3586          		dwstore	_CPM2__old_getinfo+1	,0xE615
  29:     -	3586  54      		db 	pW_STORE
  29:     -	3587  15E6    		dw 	0xE615
  29:     -	3589  FDEA    		dw 	_CPM2__old_getinfo+1
  29:     -	358B          		endm
  30:     -	358B          		dbpatch	0xE655		,0x21	,0x21
  30:     -	358B  52      		db 	pB_CHK_PATCH
  30:     -	358C  55E6    		dw 	0xE655
  30:     -	358E  2121    		db 	0x21,0x21
  30:     -	3590          		endm
  31:     -	3590          		dwpatch	0xE655+1 	,0xE685	,0xE685
  31:     -	3590  51      		db 	pW_CHK_PATCH
  31:     -	3591  56E6    		dw 	0xE655+1
  31:     -	3593  85E685E6		dw 	0xE685,0xE685
  31:     -	3597          		endm
  32:     -	3597          		dwstore	_CPM2__old_getinfo_chkdo+1	,0xE655
  32:     -	3597  54      		db 	pW_STORE
  32:     -	3598  55E6    		dw 	0xE655
  32:     -	359A  FAEA    		dw 	_CPM2__old_getinfo_chkdo+1
  32:     -	359C          		endm
  33:     -	359C          		dwstore	_CPM2_r_p_DSK1+1	,0xE18F 	;read
  33:     -	359C  54      		db 	pW_STORE
  33:     -	359D  8FE1    		dw 	0xE18F
  33:     -	359F  76EA    		dw 	_CPM2_r_p_DSK1+1
  33:     -	35A1          		endm
  34:     -	35A1          		dwstore	_CPM2_r_p_TRK1+1	,0xE193 	
  34:     -	35A1  54      		db 	pW_STORE
  34:     -	35A2  93E1    		dw 	0xE193
  34:     -	35A4  91EA    		dw 	_CPM2_r_p_TRK1+1
  34:     -	35A6          		endm
  35:     -	35A6          		dwstore	_CPM2_r_p_SEC1+1	,0xE194 	
  35:     -	35A6  54      		db 	pW_STORE
  35:     -	35A7  94E1    		dw 	0xE194
  35:     -	35A9  97EA    		dw 	_CPM2_r_p_SEC1+1
  35:     -	35AB          		endm
  36:     -	35AB          		dwstore	_CPM2_r_p_DMA1+1	,0xE195 	
  36:     -	35AB  54      		db 	pW_STORE
  36:     -	35AC  95E1    		dw 	0xE195
  36:     -	35AE  A8EA    		dw 	_CPM2_r_p_DMA1+1
  36:     -	35B0          		endm
  37:     -	35B0          		dwstore	_CPM2_r_p_DSK2+1	,0xE18F 	;write
  37:     -	35B0  54      		db 	pW_STORE
  37:     -	35B1  8FE1    		dw 	0xE18F
  37:     -	35B3  B3EA    		dw 	_CPM2_r_p_DSK2+1
  37:     -	35B5          		endm
  38:     -	35B5          		dwstore	_CPM2_r_p_TRK2+1	,0xE193 	
  38:     -	35B5  54      		db 	pW_STORE
  38:     -	35B6  93E1    		dw 	0xE193
  38:     -	35B8  CEEA    		dw 	_CPM2_r_p_TRK2+1
  38:     -	35BA          		endm
  39:     -	35BA          		dwstore	_CPM2_r_p_SEC2+1	,0xE194 	
  39:     -	35BA  54      		db 	pW_STORE
  39:     -	35BB  94E1    		dw 	0xE194
  39:     -	35BD  D4EA    		dw 	_CPM2_r_p_SEC2+1
  39:     -	35BF          		endm
  40:     -	35BF          		dwstore	_CPM2_r_p_DMA2+1	,0xE195 	
  40:     -	35BF  54      		db 	pW_STORE
  40:     -	35C0  95E1    		dw 	0xE195
  40:     -	35C2  E5EA    		dw 	_CPM2_r_p_DMA2+1
  40:     -	35C4          		endm
  41:     -	35C4          		dwstore	_CPM2_r_p_DSK3+1	,0xE18F 	;readinfo
  41:     -	35C4  54      		db 	pW_STORE
  41:     -	35C5  8FE1    		dw 	0xE18F
  41:     -	35C7  82EB    		dw 	_CPM2_r_p_DSK3+1
  41:     -	35C9          		endm
  42:				
  43:     -	35C9          		stop 'CPM_1x_89_03_30_RAVI'
  43:     -	35C9  50      		db 	p_STOP
  43:     -	35CA  43504D5F		db 	'CPM_1x_89_03_30_RAVI'
	      31785F38
	      395F3033
	      5F33305F
	      52415649
  43:     -	35DE  00      		db 	0
  43:     -	35DF          		endm
**** out/include-patcher.asm ****
  39:					include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861011.asm"	;  7 images in collection
**** generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861011.asm ****
   1:     -	35DF          	_BIOS_MICRODOS_OPTS1_861011:
   2:     -	35DF          		setMICRODOS
   2:     -	35DF  56      		db 	pSETFLAG_MICRODOS
   2:     -	35E0          		endm
   3:     -	35E0          		RQ_OPTS1
   3:     -	35E0  57      		db 	pREQUIRED_OPTS1
   3:     -	35E1          		endm
   4:     -	35E1          		dbpatchmaybe	0xE693	,0x1B	,0x0d
   4:     -	35E1  59      		db 	pB_MAYBE_PATCH
   4:     -	35E2  93E6    		dw 	0xE693
   4:     -	35E4  1B0D    		db 	0x1B,0x0d
   4:     -	35E6          		endm
   5:     -	35E6          		dbpatchmaybe	0xE693+1	,0x45	,0x0d
   5:     -	35E6  59      		db 	pB_MAYBE_PATCH
   5:     -	35E7  94E6    		dw 	0xE693+1
   5:     -	35E9  450D    		db 	0x45,0x0d
   5:     -	35EB          		endm
   6:     -	35EB          		dwpatch	0xE497+1	,0xE627	,MD_READ			
   6:     -	35EB  51      		db 	pW_CHK_PATCH
   6:     -	35EC  98E4    		dw 	0xE497+1
   6:     -	35EE  27E63EFA		dw 	0xE627,MD_READ
   6:     -	35F2          		endm
   7:     -	35F2          		dwpatch	0xE4A0+1	,0xE62A	,MD_WRITE
   7:     -	35F2  51      		db 	pW_CHK_PATCH
   7:     -	35F3  A1E4    		dw 	0xE4A0+1
   7:     -	35F5  2AE653FA		dw 	0xE62A,MD_WRITE
   7:     -	35F9          		endm
   8:     -	35F9          		dbpatch	0xEAAE	,0xcd	,0x00
   8:     -	35F9  52      		db 	pB_CHK_PATCH
   8:     -	35FA  AEEA    		dw 	0xEAAE
   8:     -	35FC  CD00    		db 	0xcd,0x00
   8:     -	35FE          		endm
   9:     -	35FE          		dwpatch	0xEAAE+1	,0xE9E9	,0x0000
   9:     -	35FE  51      		db 	pW_CHK_PATCH
   9:     -	35FF  AFEA    		dw 	0xEAAE+1
   9:     -	3601  E9E90000		dw 	0xE9E9,0x0000
   9:     -	3605          		endm
  10:     -	3605          		dwpatch	0xEAB4+1	,0xEC5D	,MD_READ_INFOSECTOR
  10:     -	3605  51      		db 	pW_CHK_PATCH
  10:     -	3606  B5EA    		dw 	0xEAB4+1
  10:     -	3608  5DEC68FA		dw 	0xEC5D,MD_READ_INFOSECTOR
  10:     -	360C          		endm
  11:     -	360C          		dwstore	MD_DRV2+1,	0xDFC8
  11:     -	360C  54      		db 	pW_STORE
  11:     -	360D  C8DF    		dw 	0xDFC8
  11:     -	360F  F3FA    		dw 	MD_DRV2+1
  11:     -	3611          		endm
  12:     -	3611          		dwstore	MD_RDBUF2+1,	0xEEB0
  12:     -	3611  54      		db 	pW_STORE
  12:     -	3612  B0EE    		dw 	0xEEB0
  12:     -	3614  02FB    		dw 	MD_RDBUF2+1
  12:     -	3616          		endm
  13:     -	3616          		dwstore	MD_PARAM2+1,	0xDDBC
  13:     -	3616  54      		db 	pW_STORE
  13:     -	3617  BCDD    		dw 	0xDDBC
  13:     -	3619  1DFA    		dw 	MD_PARAM2+1
  13:     -	361B          		endm
  14:     -	361B          		dwpatch 0xc01b+1	 ,0xDD86	,md_res_seldsk
  14:     -	361B  51      		db 	pW_CHK_PATCH
  14:     -	361C  1CC0    		dw 	0xc01b+1
  14:     -	361E  86DD0EFA		dw 	0xDD86,md_res_seldsk
  14:     -	3622          		endm
  15:     -	3622          		dwstore md_old_seld_dsk+1,0xDD86	,0xdd4c
  15:     -	3622  54      		db 	pW_STORE
  15:     -	3623  86DD    		dw 	0xDD86
  15:     -	3625  12FA    		dw 	md_old_seld_dsk+1
  15:     -	3627          		endm
  16:					;custom checkers
  17:     -	3627          		dwpatch	0xBC80	,0xBC80 ,0xBC80
  17:     -	3627  51      		db 	pW_CHK_PATCH
  17:     -	3628  80BC    		dw 	0xBC80
  17:     -	362A  80BC80BC		dw 	0xBC80,0xBC80
  17:     -	362E          		endm
  18:     -	362E          		dwpatch	0xBC82	,0xBD00 ,0xBD00
  18:     -	362E  51      		db 	pW_CHK_PATCH
  18:     -	362F  82BC    		dw 	0xBC82
  18:     -	3631  00BD00BD		dw 	0xBD00,0xBD00
  18:     -	3635          		endm
  19:     -	3635          		dwpatch	0xc000+1	,0xC4BF ,0xC4BF
  19:     -	3635  51      		db 	pW_CHK_PATCH
  19:     -	3636  01C0    		dw 	0xc000+1
  19:     -	3638  BFC4BFC4		dw 	0xC4BF,0xC4BF
  19:     -	363C          		endm
  20:     -	363C          		dwpatch	0xc003+1	,0xDBFB ,0xDBFB
  20:     -	363C  51      		db 	pW_CHK_PATCH
  20:     -	363D  04C0    		dw 	0xc003+1
  20:     -	363F  FBDBFBDB		dw 	0xDBFB,0xDBFB
  20:     -	3643          		endm
  21:     -	3643          		dbpatch	0xDF95	,0x50 ,0x50
  21:     -	3643  52      		db 	pB_CHK_PATCH
  21:     -	3644  95DF    		dw 	0xDF95
  21:     -	3646  5050    		db 	0x50,0x50
  21:     -	3648          		endm
  22:     -	3648          		dbpatch	0xDF97	,0x18 ,0x18
  22:     -	3648  52      		db 	pB_CHK_PATCH
  22:     -	3649  97DF    		dw 	0xDF97
  22:     -	364B  1818    		db 	0x18,0x18
  22:     -	364D          		endm
  23:     -	364D          		stop 'MICRODOS_OPTS1_861011'
  23:     -	364D  50      		db 	p_STOP
  23:     -	364E  4D494352		db 	'MICRODOS_OPTS1_861011'
	      4F444F53
	      5F4F5054
	      53315F38
	      36313031
	      31
  23:     -	3663  00      		db 	0
  23:     -	3664          		endm
**** out/include-patcher.asm ****
  40:					include "generator/V0/out/patcher-cpm1-CPM_21_91___LAP.asm"	;  4 images in collection
**** generator/V0/out/patcher-cpm1-CPM_21_91___LAP.asm ****
   1:     -	3664          	_BIOS_CPM_21_91___LAP:
   2:     -	3664          		setSUBBIOS 1
   2:     -	3664  5A      		db	pSubBios
   2:     -	3665  01      		db 	1
   2:     -	3666          		endm
   3:     -	3666          		RQ_OPTS_ANY
   3:     -	3666          		endm
   4:     -	3666          		setCPM
   4:     -	3666          		endm
   5:     -	3666          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	3666  59      		db 	pB_MAYBE_PATCH
   5:     -	3667  EEDA    		dw 	0xDAEE
   5:     -	3669  1F0D    		db 	0x1F,0x0d
   5:     -	366B          		endm
   6:     -	366B          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	366B  59      		db 	pB_MAYBE_PATCH
   6:     -	366C  F0DA    		dw 	0xDAEE+2
   6:     -	366E  0A0D    		db 	0x0a,0x0d
   6:     -	3670          		endm
   7:     -	3670          		dbpatch	0xE0D2+1	,0x49	,0xc9
   7:     -	3670  52      		db 	pB_CHK_PATCH
   7:     -	3671  D3E0    		dw 	0xE0D2+1
   7:     -	3673  49C9    		db 	0x49,0xc9
   7:     -	3675          		endm
   8:     -	3675          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	3675  52      		db 	pB_CHK_PATCH
   8:     -	3676  88DA    		dw 	0xDA88
   8:     -	3678  0100    		db 	0x01,0x00
   8:     -	367A          		endm
   9:     -	367A          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	367A  52      		db 	pB_CHK_PATCH
   9:     -	367B  9FDA    		dw 	0xDA9F
   9:     -	367D  0200    		db 	0x02,0x00
   9:     -	367F          		endm
  10:     -	367F          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	367F  52      		db 	pB_CHK_PATCH
  10:     -	3680  B6DA    		dw 	0xDAB6
  10:     -	3682  0401    		db 	0x04,0x01
  10:     -	3684          		endm
  11:     -	3684          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	3684  52      		db 	pB_CHK_PATCH
  11:     -	3685  CDDA    		dw 	0xDACD
  11:     -	3687  0802    		db 	0x08,0x02
  11:     -	3689          		endm
  12:     -	3689          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	3689  54      		db 	pW_STORE
  12:     -	368A  88DA    		dw 	0xDA88
  12:     -	368C  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	368E          		endm
  13:     -	368E          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	368E  54      		db 	pW_STORE
  13:     -	368F  9FDA    		dw 	0xDA9F
  13:     -	3691  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	3693          		endm
  14:     -	3693          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	3693  54      		db 	pW_STORE
  14:     -	3694  B6DA    		dw 	0xDAB6
  14:     -	3696  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	3698          		endm
  15:     -	3698          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	3698  54      		db 	pW_STORE
  15:     -	3699  CDDA    		dw 	0xDACD
  15:     -	369B  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	369D          		endm
  16:     -	369D          		dwpatch 0xDCF2+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	369D  51      		db 	pW_CHK_PATCH
  16:     -	369E  FCDC    		dw 	0xDCF2+5*2
  16:     -	36A0  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	36A4          		endm
  17:     -	36A4          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	36A4  54      		db 	pW_STORE
  17:     -	36A5  A6EB    		dw 	0xEBA6
  17:     -	36A7  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	36A9          		endm
  18:     -	36A9          		dwpatch 0xDA1B+1 	,0xDCAE	,_CPM1_res_seldsk
  18:     -	36A9  51      		db 	pW_CHK_PATCH
  18:     -	36AA  1CDA    		dw 	0xDA1B+1
  18:     -	36AC  AEDC11E9		dw 	0xDCAE,_CPM1_res_seldsk
  18:     -	36B0          		endm
  19:     -	36B0          		dwstore	_CPM1_old_seld_dsk+1	,0xDCAE
  19:     -	36B0  54      		db 	pW_STORE
  19:     -	36B1  AEDC    		dw 	0xDCAE
  19:     -	36B3  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	36B5          		endm
  20:     -	36B5          		dbpatch	0xE69F	,0x77	,0x00
  20:     -	36B5  52      		db 	pB_CHK_PATCH
  20:     -	36B6  9FE6    		dw 	0xE69F
  20:     -	36B8  7700    		db 	0x77,0x00
  20:     -	36BA          		endm
  21:     -	36BA          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFED
  21:     -	36BA  54      		db 	pW_STORE
  21:     -	36BB  EDDF    		dw 	0xDFED
  21:     -	36BD  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	36BF          		endm
  22:     -	36BF          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFED
  22:     -	36BF  54      		db 	pW_STORE
  22:     -	36C0  EDDF    		dw 	0xDFED
  22:     -	36C2  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	36C4          		endm
  23:     -	36C4          		dwpatch	0xDA27+1	,0xDD11	,_CPM1_res_READ
  23:     -	36C4  51      		db 	pW_CHK_PATCH
  23:     -	36C5  28DA    		dw 	0xDA27+1
  23:     -	36C7  11DD1BE9		dw 	0xDD11,_CPM1_res_READ
  23:     -	36CB          		endm
  24:     -	36CB          		dwpatch	0xDA2A+1	,0xDE47	,_CPM1_res_WRITE
  24:     -	36CB  51      		db 	pW_CHK_PATCH
  24:     -	36CC  2BDA    		dw 	0xDA2A+1
  24:     -	36CE  47DE58E9		dw 	0xDE47,_CPM1_res_WRITE
  24:     -	36D2          		endm
  25:     -	36D2          		dwpatch	0xDB5F+1	,0xDD11	,_CPM1_res_READ
  25:     -	36D2  51      		db 	pW_CHK_PATCH
  25:     -	36D3  60DB    		dw 	0xDB5F+1
  25:     -	36D5  11DD1BE9		dw 	0xDD11,_CPM1_res_READ
  25:     -	36D9          		endm
  26:     -	36D9          		dwpatch	0xdce0+1	,0xE5D5	,_CPM1_res_GETINFO
  26:     -	36D9  51      		db 	pW_CHK_PATCH
  26:     -	36DA  E1DC    		dw 	0xdce0+1
  26:     -	36DC  D5E595E9		dw 	0xE5D5,_CPM1_res_GETINFO
  26:     -	36E0          		endm
  27:     -	36E0          		dwstore	_CPM1__old_read+1	,0xDD11
  27:     -	36E0  54      		db 	pW_STORE
  27:     -	36E1  11DD    		dw 	0xDD11
  27:     -	36E3  56E9    		dw 	_CPM1__old_read+1
  27:     -	36E5          		endm
  28:     -	36E5          		dwstore	_CPM1__old_write+1	,0xDE47
  28:     -	36E5  54      		db 	pW_STORE
  28:     -	36E6  47DE    		dw 	0xDE47
  28:     -	36E8  93E9    		dw 	_CPM1__old_write+1
  28:     -	36EA          		endm
  29:     -	36EA          		dwstore	_CPM1__old_getinfo+1	,0xE5D5
  29:     -	36EA  54      		db 	pW_STORE
  29:     -	36EB  D5E5    		dw 	0xE5D5
  29:     -	36ED  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	36EF          		endm
  30:     -	36EF          		dbpatch	0xE615		,0x21	,0x21
  30:     -	36EF  52      		db 	pB_CHK_PATCH
  30:     -	36F0  15E6    		dw 	0xE615
  30:     -	36F2  2121    		db 	0x21,0x21
  30:     -	36F4          		endm
  31:     -	36F4          		dwpatch	0xE615+1 	,0xE645	,0xE645
  31:     -	36F4  51      		db 	pW_CHK_PATCH
  31:     -	36F5  16E6    		dw 	0xE615+1
  31:     -	36F7  45E645E6		dw 	0xE645,0xE645
  31:     -	36FB          		endm
  32:     -	36FB          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE615
  32:     -	36FB  54      		db 	pW_STORE
  32:     -	36FC  15E6    		dw 	0xE615
  32:     -	36FE  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	3700          		endm
  33:     -	3700          		dwstore	_CPM1_r_p_DSK1+1	,0xDFE3 	;read
  33:     -	3700  54      		db 	pW_STORE
  33:     -	3701  E3DF    		dw 	0xDFE3
  33:     -	3703  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	3705          		endm
  34:     -	3705          		dwstore	_CPM1_r_p_TRK1+1	,0xDFE7 	
  34:     -	3705  54      		db 	pW_STORE
  34:     -	3706  E7DF    		dw 	0xDFE7
  34:     -	3708  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	370A          		endm
  35:     -	370A          		dwstore	_CPM1_r_p_SEC1+1	,0xDFE8 	
  35:     -	370A  54      		db 	pW_STORE
  35:     -	370B  E8DF    		dw 	0xDFE8
  35:     -	370D  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	370F          		endm
  36:     -	370F          		dwstore	_CPM1_r_p_DMA1+1	,0xDFE9 	
  36:     -	370F  54      		db 	pW_STORE
  36:     -	3710  E9DF    		dw 	0xDFE9
  36:     -	3712  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	3714          		endm
  37:     -	3714          		dwstore	_CPM1_r_p_DSK2+1	,0xDFE3 	;write
  37:     -	3714  54      		db 	pW_STORE
  37:     -	3715  E3DF    		dw 	0xDFE3
  37:     -	3717  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	3719          		endm
  38:     -	3719          		dwstore	_CPM1_r_p_TRK2+1	,0xDFE7 	
  38:     -	3719  54      		db 	pW_STORE
  38:     -	371A  E7DF    		dw 	0xDFE7
  38:     -	371C  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	371E          		endm
  39:     -	371E          		dwstore	_CPM1_r_p_SEC2+1	,0xDFE8 	
  39:     -	371E  54      		db 	pW_STORE
  39:     -	371F  E8DF    		dw 	0xDFE8
  39:     -	3721  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	3723          		endm
  40:     -	3723          		dwstore	_CPM1_r_p_DMA2+1	,0xDFE9 	
  40:     -	3723  54      		db 	pW_STORE
  40:     -	3724  E9DF    		dw 	0xDFE9
  40:     -	3726  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	3728          		endm
  41:     -	3728          		dwstore	_CPM1_r_p_DSK3+1	,0xDFE3 	;readinfo
  41:     -	3728  54      		db 	pW_STORE
  41:     -	3729  E3DF    		dw 	0xDFE3
  41:     -	372B  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	372D          		endm
  42:				
  43:     -	372D          		stop 'CPM_21_91___LAP'
  43:     -	372D  50      		db 	p_STOP
  43:     -	372E  43504D5F		db 	'CPM_21_91___LAP'
	      32315F39
	      315F5F5F
	      4C4150
  43:     -	373D  00      		db 	0
  43:     -	373E          		endm
**** out/include-patcher.asm ****
  41:					include "generator/V0/out/patcher-cpm1-CPM_20_88___miks.asm"	;  4 images in collection
**** generator/V0/out/patcher-cpm1-CPM_20_88___miks.asm ****
   1:     -	373E          	_BIOS_CPM_20_88___miks:
   2:     -	373E          		setSUBBIOS 1
   2:     -	373E  5A      		db	pSubBios
   2:     -	373F  01      		db 	1
   2:     -	3740          		endm
   3:     -	3740          		RQ_OPTS_ANY
   3:     -	3740          		endm
   4:     -	3740          		setCPM
   4:     -	3740          		endm
   5:     -	3740          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	3740  59      		db 	pB_MAYBE_PATCH
   5:     -	3741  EEDA    		dw 	0xDAEE
   5:     -	3743  1F0D    		db 	0x1F,0x0d
   5:     -	3745          		endm
   6:     -	3745          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	3745  59      		db 	pB_MAYBE_PATCH
   6:     -	3746  F0DA    		dw 	0xDAEE+2
   6:     -	3748  0A0D    		db 	0x0a,0x0d
   6:     -	374A          		endm
   7:     -	374A          		dbpatch	0xE3DC+1	,0x49	,0xc9
   7:     -	374A  52      		db 	pB_CHK_PATCH
   7:     -	374B  DDE3    		dw 	0xE3DC+1
   7:     -	374D  49C9    		db 	0x49,0xc9
   7:     -	374F          		endm
   8:     -	374F          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	374F  52      		db 	pB_CHK_PATCH
   8:     -	3750  88DA    		dw 	0xDA88
   8:     -	3752  0100    		db 	0x01,0x00
   8:     -	3754          		endm
   9:     -	3754          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	3754  52      		db 	pB_CHK_PATCH
   9:     -	3755  9FDA    		dw 	0xDA9F
   9:     -	3757  0200    		db 	0x02,0x00
   9:     -	3759          		endm
  10:     -	3759          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	3759  52      		db 	pB_CHK_PATCH
  10:     -	375A  B6DA    		dw 	0xDAB6
  10:     -	375C  0401    		db 	0x04,0x01
  10:     -	375E          		endm
  11:     -	375E          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	375E  52      		db 	pB_CHK_PATCH
  11:     -	375F  CDDA    		dw 	0xDACD
  11:     -	3761  0802    		db 	0x08,0x02
  11:     -	3763          		endm
  12:     -	3763          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	3763  54      		db 	pW_STORE
  12:     -	3764  88DA    		dw 	0xDA88
  12:     -	3766  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	3768          		endm
  13:     -	3768          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	3768  54      		db 	pW_STORE
  13:     -	3769  9FDA    		dw 	0xDA9F
  13:     -	376B  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	376D          		endm
  14:     -	376D          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	376D  54      		db 	pW_STORE
  14:     -	376E  B6DA    		dw 	0xDAB6
  14:     -	3770  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	3772          		endm
  15:     -	3772          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	3772  54      		db 	pW_STORE
  15:     -	3773  CDDA    		dw 	0xDACD
  15:     -	3775  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	3777          		endm
  16:     -	3777          		dwpatch 0xDCD0+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	3777  51      		db 	pW_CHK_PATCH
  16:     -	3778  DADC    		dw 	0xDCD0+5*2
  16:     -	377A  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	377E          		endm
  17:     -	377E          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	377E  54      		db 	pW_STORE
  17:     -	377F  A6EB    		dw 	0xEBA6
  17:     -	3781  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	3783          		endm
  18:     -	3783          		dwpatch 0xDA1B+1 	,0xDC8C	,_CPM1_res_seldsk
  18:     -	3783  51      		db 	pW_CHK_PATCH
  18:     -	3784  1CDA    		dw 	0xDA1B+1
  18:     -	3786  8CDC11E9		dw 	0xDC8C,_CPM1_res_seldsk
  18:     -	378A          		endm
  19:     -	378A          		dwstore	_CPM1_old_seld_dsk+1	,0xDC8C
  19:     -	378A  54      		db 	pW_STORE
  19:     -	378B  8CDC    		dw 	0xDC8C
  19:     -	378D  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	378F          		endm
  20:     -	378F          		dbpatch	0xE64F	,0x77	,0x00
  20:     -	378F  52      		db 	pB_CHK_PATCH
  20:     -	3790  4FE6    		dw 	0xE64F
  20:     -	3792  7700    		db 	0x77,0x00
  20:     -	3794          		endm
  21:     -	3794          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFA3
  21:     -	3794  54      		db 	pW_STORE
  21:     -	3795  A3DF    		dw 	0xDFA3
  21:     -	3797  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	3799          		endm
  22:     -	3799          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFA3
  22:     -	3799  54      		db 	pW_STORE
  22:     -	379A  A3DF    		dw 	0xDFA3
  22:     -	379C  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	379E          		endm
  23:     -	379E          		dwpatch	0xDA27+1	,0xDCEF	,_CPM1_res_READ
  23:     -	379E  51      		db 	pW_CHK_PATCH
  23:     -	379F  28DA    		dw 	0xDA27+1
  23:     -	37A1  EFDC1BE9		dw 	0xDCEF,_CPM1_res_READ
  23:     -	37A5          		endm
  24:     -	37A5          		dwpatch	0xDA2A+1	,0xDE25	,_CPM1_res_WRITE
  24:     -	37A5  51      		db 	pW_CHK_PATCH
  24:     -	37A6  2BDA    		dw 	0xDA2A+1
  24:     -	37A8  25DE58E9		dw 	0xDE25,_CPM1_res_WRITE
  24:     -	37AC          		endm
  25:     -	37AC          		dwpatch	0xDB85+1	,0xDCEF	,_CPM1_res_READ
  25:     -	37AC  51      		db 	pW_CHK_PATCH
  25:     -	37AD  86DB    		dw 	0xDB85+1
  25:     -	37AF  EFDC1BE9		dw 	0xDCEF,_CPM1_res_READ
  25:     -	37B3          		endm
  26:     -	37B3          		dwpatch	0xdcbe+1	,0xE585	,_CPM1_res_GETINFO
  26:     -	37B3  51      		db 	pW_CHK_PATCH
  26:     -	37B4  BFDC    		dw 	0xdcbe+1
  26:     -	37B6  85E595E9		dw 	0xE585,_CPM1_res_GETINFO
  26:     -	37BA          		endm
  27:     -	37BA          		dwstore	_CPM1__old_read+1	,0xDCEF
  27:     -	37BA  54      		db 	pW_STORE
  27:     -	37BB  EFDC    		dw 	0xDCEF
  27:     -	37BD  56E9    		dw 	_CPM1__old_read+1
  27:     -	37BF          		endm
  28:     -	37BF          		dwstore	_CPM1__old_write+1	,0xDE25
  28:     -	37BF  54      		db 	pW_STORE
  28:     -	37C0  25DE    		dw 	0xDE25
  28:     -	37C2  93E9    		dw 	_CPM1__old_write+1
  28:     -	37C4          		endm
  29:     -	37C4          		dwstore	_CPM1__old_getinfo+1	,0xE585
  29:     -	37C4  54      		db 	pW_STORE
  29:     -	37C5  85E5    		dw 	0xE585
  29:     -	37C7  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	37C9          		endm
  30:     -	37C9          		dbpatch	0xE5C5		,0x21	,0x21
  30:     -	37C9  52      		db 	pB_CHK_PATCH
  30:     -	37CA  C5E5    		dw 	0xE5C5
  30:     -	37CC  2121    		db 	0x21,0x21
  30:     -	37CE          		endm
  31:     -	37CE          		dwpatch	0xE5C5+1 	,0xE5F5	,0xE5F5
  31:     -	37CE  51      		db 	pW_CHK_PATCH
  31:     -	37CF  C6E5    		dw 	0xE5C5+1
  31:     -	37D1  F5E5F5E5		dw 	0xE5F5,0xE5F5
  31:     -	37D5          		endm
  32:     -	37D5          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE5C5
  32:     -	37D5  54      		db 	pW_STORE
  32:     -	37D6  C5E5    		dw 	0xE5C5
  32:     -	37D8  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	37DA          		endm
  33:     -	37DA          		dwstore	_CPM1_r_p_DSK1+1	,0xDF99 	;read
  33:     -	37DA  54      		db 	pW_STORE
  33:     -	37DB  99DF    		dw 	0xDF99
  33:     -	37DD  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	37DF          		endm
  34:     -	37DF          		dwstore	_CPM1_r_p_TRK1+1	,0xDF9D 	
  34:     -	37DF  54      		db 	pW_STORE
  34:     -	37E0  9DDF    		dw 	0xDF9D
  34:     -	37E2  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	37E4          		endm
  35:     -	37E4          		dwstore	_CPM1_r_p_SEC1+1	,0xDF9E 	
  35:     -	37E4  54      		db 	pW_STORE
  35:     -	37E5  9EDF    		dw 	0xDF9E
  35:     -	37E7  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	37E9          		endm
  36:     -	37E9          		dwstore	_CPM1_r_p_DMA1+1	,0xDF9F 	
  36:     -	37E9  54      		db 	pW_STORE
  36:     -	37EA  9FDF    		dw 	0xDF9F
  36:     -	37EC  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	37EE          		endm
  37:     -	37EE          		dwstore	_CPM1_r_p_DSK2+1	,0xDF99 	;write
  37:     -	37EE  54      		db 	pW_STORE
  37:     -	37EF  99DF    		dw 	0xDF99
  37:     -	37F1  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	37F3          		endm
  38:     -	37F3          		dwstore	_CPM1_r_p_TRK2+1	,0xDF9D 	
  38:     -	37F3  54      		db 	pW_STORE
  38:     -	37F4  9DDF    		dw 	0xDF9D
  38:     -	37F6  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	37F8          		endm
  39:     -	37F8          		dwstore	_CPM1_r_p_SEC2+1	,0xDF9E 	
  39:     -	37F8  54      		db 	pW_STORE
  39:     -	37F9  9EDF    		dw 	0xDF9E
  39:     -	37FB  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	37FD          		endm
  40:     -	37FD          		dwstore	_CPM1_r_p_DMA2+1	,0xDF9F 	
  40:     -	37FD  54      		db 	pW_STORE
  40:     -	37FE  9FDF    		dw 	0xDF9F
  40:     -	3800  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	3802          		endm
  41:     -	3802          		dwstore	_CPM1_r_p_DSK3+1	,0xDF99 	;readinfo
  41:     -	3802  54      		db 	pW_STORE
  41:     -	3803  99DF    		dw 	0xDF99
  41:     -	3805  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	3807          		endm
  42:				
  43:     -	3807          		stop 'CPM_20_88___miks'
  43:     -	3807  50      		db 	p_STOP
  43:     -	3808  43504D5F		db 	'CPM_20_88___miks'
	      32305F38
	      385F5F5F
	      6D696B73
  43:     -	3818  00      		db 	0
  43:     -	3819          		endm
**** out/include-patcher.asm ****
  42:					include "generator/V0/out/patcher-cpm1-CPM_12_90_5_kontur.asm"	;  4 images in collection
**** generator/V0/out/patcher-cpm1-CPM_12_90_5_kontur.asm ****
   1:     -	3819          	_BIOS_CPM_12_90_5_kontur:
   2:     -	3819          		setSUBBIOS 1
   2:     -	3819  5A      		db	pSubBios
   2:     -	381A  01      		db 	1
   2:     -	381B          		endm
   3:     -	381B          		RQ_OPTS_ANY
   3:     -	381B          		endm
   4:     -	381B          		setCPM
   4:     -	381B          		endm
   5:     -	381B          		dbpatchmaybe	0xDAEF	,0x1F	,0x0d
   5:     -	381B  59      		db 	pB_MAYBE_PATCH
   5:     -	381C  EFDA    		dw 	0xDAEF
   5:     -	381E  1F0D    		db 	0x1F,0x0d
   5:     -	3820          		endm
   6:     -	3820          		dbpatchmaybe	0xDAEF+2	,0x0a	,0x0d
   6:     -	3820  59      		db 	pB_MAYBE_PATCH
   6:     -	3821  F1DA    		dw 	0xDAEF+2
   6:     -	3823  0A0D    		db 	0x0a,0x0d
   6:     -	3825          		endm
   7:     -	3825          		dbpatch	0xE09B+1	,0x49	,0xc9
   7:     -	3825  52      		db 	pB_CHK_PATCH
   7:     -	3826  9CE0    		dw 	0xE09B+1
   7:     -	3828  49C9    		db 	0x49,0xc9
   7:     -	382A          		endm
   8:     -	382A          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	382A  52      		db 	pB_CHK_PATCH
   8:     -	382B  88DA    		dw 	0xDA88
   8:     -	382D  0100    		db 	0x01,0x00
   8:     -	382F          		endm
   9:     -	382F          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	382F  52      		db 	pB_CHK_PATCH
   9:     -	3830  9FDA    		dw 	0xDA9F
   9:     -	3832  0200    		db 	0x02,0x00
   9:     -	3834          		endm
  10:     -	3834          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	3834  52      		db 	pB_CHK_PATCH
  10:     -	3835  B6DA    		dw 	0xDAB6
  10:     -	3837  0401    		db 	0x04,0x01
  10:     -	3839          		endm
  11:     -	3839          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	3839  52      		db 	pB_CHK_PATCH
  11:     -	383A  CDDA    		dw 	0xDACD
  11:     -	383C  0802    		db 	0x08,0x02
  11:     -	383E          		endm
  12:     -	383E          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	383E  54      		db 	pW_STORE
  12:     -	383F  88DA    		dw 	0xDA88
  12:     -	3841  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	3843          		endm
  13:     -	3843          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	3843  54      		db 	pW_STORE
  13:     -	3844  9FDA    		dw 	0xDA9F
  13:     -	3846  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	3848          		endm
  14:     -	3848          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	3848  54      		db 	pW_STORE
  14:     -	3849  B6DA    		dw 	0xDAB6
  14:     -	384B  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	384D          		endm
  15:     -	384D          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	384D  54      		db 	pW_STORE
  15:     -	384E  CDDA    		dw 	0xDACD
  15:     -	3850  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	3852          		endm
  16:     -	3852          		dwpatch 0xDCB6+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	3852  51      		db 	pW_CHK_PATCH
  16:     -	3853  C0DC    		dw 	0xDCB6+5*2
  16:     -	3855  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	3859          		endm
  17:     -	3859          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	3859  54      		db 	pW_STORE
  17:     -	385A  A6EB    		dw 	0xEBA6
  17:     -	385C  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	385E          		endm
  18:     -	385E          		dwpatch 0xDA1B+1 	,0xDC72	,_CPM1_res_seldsk
  18:     -	385E  51      		db 	pW_CHK_PATCH
  18:     -	385F  1CDA    		dw 	0xDA1B+1
  18:     -	3861  72DC11E9		dw 	0xDC72,_CPM1_res_seldsk
  18:     -	3865          		endm
  19:     -	3865          		dwstore	_CPM1_old_seld_dsk+1	,0xDC72
  19:     -	3865  54      		db 	pW_STORE
  19:     -	3866  72DC    		dw 	0xDC72
  19:     -	3868  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	386A          		endm
  20:     -	386A          		dbpatch	0xE6C0	,0x77	,0x00
  20:     -	386A  52      		db 	pB_CHK_PATCH
  20:     -	386B  C0E6    		dw 	0xE6C0
  20:     -	386D  7700    		db 	0x77,0x00
  20:     -	386F          		endm
  21:     -	386F          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFB6
  21:     -	386F  54      		db 	pW_STORE
  21:     -	3870  B6DF    		dw 	0xDFB6
  21:     -	3872  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	3874          		endm
  22:     -	3874          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFB6
  22:     -	3874  54      		db 	pW_STORE
  22:     -	3875  B6DF    		dw 	0xDFB6
  22:     -	3877  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	3879          		endm
  23:     -	3879          		dwpatch	0xDA27+1	,0xDCD5	,_CPM1_res_READ
  23:     -	3879  51      		db 	pW_CHK_PATCH
  23:     -	387A  28DA    		dw 	0xDA27+1
  23:     -	387C  D5DC1BE9		dw 	0xDCD5,_CPM1_res_READ
  23:     -	3880          		endm
  24:     -	3880          		dwpatch	0xDA2A+1	,0xDE22	,_CPM1_res_WRITE
  24:     -	3880  51      		db 	pW_CHK_PATCH
  24:     -	3881  2BDA    		dw 	0xDA2A+1
  24:     -	3883  22DE58E9		dw 	0xDE22,_CPM1_res_WRITE
  24:     -	3887          		endm
  25:     -	3887          		dwpatch	0xDB6B+1	,0xDCD5	,_CPM1_res_READ
  25:     -	3887  51      		db 	pW_CHK_PATCH
  25:     -	3888  6CDB    		dw 	0xDB6B+1
  25:     -	388A  D5DC1BE9		dw 	0xDCD5,_CPM1_res_READ
  25:     -	388E          		endm
  26:     -	388E          		dwpatch	0xdca4+1	,0xE5F6	,_CPM1_res_GETINFO
  26:     -	388E  51      		db 	pW_CHK_PATCH
  26:     -	388F  A5DC    		dw 	0xdca4+1
  26:     -	3891  F6E595E9		dw 	0xE5F6,_CPM1_res_GETINFO
  26:     -	3895          		endm
  27:     -	3895          		dwstore	_CPM1__old_read+1	,0xDCD5
  27:     -	3895  54      		db 	pW_STORE
  27:     -	3896  D5DC    		dw 	0xDCD5
  27:     -	3898  56E9    		dw 	_CPM1__old_read+1
  27:     -	389A          		endm
  28:     -	389A          		dwstore	_CPM1__old_write+1	,0xDE22
  28:     -	389A  54      		db 	pW_STORE
  28:     -	389B  22DE    		dw 	0xDE22
  28:     -	389D  93E9    		dw 	_CPM1__old_write+1
  28:     -	389F          		endm
  29:     -	389F          		dwstore	_CPM1__old_getinfo+1	,0xE5F6
  29:     -	389F  54      		db 	pW_STORE
  29:     -	38A0  F6E5    		dw 	0xE5F6
  29:     -	38A2  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	38A4          		endm
  30:     -	38A4          		dbpatch	0xE636		,0x21	,0x21
  30:     -	38A4  52      		db 	pB_CHK_PATCH
  30:     -	38A5  36E6    		dw 	0xE636
  30:     -	38A7  2121    		db 	0x21,0x21
  30:     -	38A9          		endm
  31:     -	38A9          		dwpatch	0xE636+1 	,0xE666	,0xE666
  31:     -	38A9  51      		db 	pW_CHK_PATCH
  31:     -	38AA  37E6    		dw 	0xE636+1
  31:     -	38AC  66E666E6		dw 	0xE666,0xE666
  31:     -	38B0          		endm
  32:     -	38B0          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE636
  32:     -	38B0  54      		db 	pW_STORE
  32:     -	38B1  36E6    		dw 	0xE636
  32:     -	38B3  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	38B5          		endm
  33:     -	38B5          		dwstore	_CPM1_r_p_DSK1+1	,0xDFAC 	;read
  33:     -	38B5  54      		db 	pW_STORE
  33:     -	38B6  ACDF    		dw 	0xDFAC
  33:     -	38B8  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	38BA          		endm
  34:     -	38BA          		dwstore	_CPM1_r_p_TRK1+1	,0xDFB0 	
  34:     -	38BA  54      		db 	pW_STORE
  34:     -	38BB  B0DF    		dw 	0xDFB0
  34:     -	38BD  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	38BF          		endm
  35:     -	38BF          		dwstore	_CPM1_r_p_SEC1+1	,0xDFB1 	
  35:     -	38BF  54      		db 	pW_STORE
  35:     -	38C0  B1DF    		dw 	0xDFB1
  35:     -	38C2  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	38C4          		endm
  36:     -	38C4          		dwstore	_CPM1_r_p_DMA1+1	,0xDFB2 	
  36:     -	38C4  54      		db 	pW_STORE
  36:     -	38C5  B2DF    		dw 	0xDFB2
  36:     -	38C7  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	38C9          		endm
  37:     -	38C9          		dwstore	_CPM1_r_p_DSK2+1	,0xDFAC 	;write
  37:     -	38C9  54      		db 	pW_STORE
  37:     -	38CA  ACDF    		dw 	0xDFAC
  37:     -	38CC  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	38CE          		endm
  38:     -	38CE          		dwstore	_CPM1_r_p_TRK2+1	,0xDFB0 	
  38:     -	38CE  54      		db 	pW_STORE
  38:     -	38CF  B0DF    		dw 	0xDFB0
  38:     -	38D1  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	38D3          		endm
  39:     -	38D3          		dwstore	_CPM1_r_p_SEC2+1	,0xDFB1 	
  39:     -	38D3  54      		db 	pW_STORE
  39:     -	38D4  B1DF    		dw 	0xDFB1
  39:     -	38D6  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	38D8          		endm
  40:     -	38D8          		dwstore	_CPM1_r_p_DMA2+1	,0xDFB2 	
  40:     -	38D8  54      		db 	pW_STORE
  40:     -	38D9  B2DF    		dw 	0xDFB2
  40:     -	38DB  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	38DD          		endm
  41:     -	38DD          		dwstore	_CPM1_r_p_DSK3+1	,0xDFAC 	;readinfo
  41:     -	38DD  54      		db 	pW_STORE
  41:     -	38DE  ACDF    		dw 	0xDFAC
  41:     -	38E0  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	38E2          		endm
  42:				
  43:     -	38E2          		stop 'CPM_12_90_5_kontur'
  43:     -	38E2  50      		db 	p_STOP
  43:     -	38E3  43504D5F		db 	'CPM_12_90_5_kontur'
	      31325F39
	      305F355F
	      6B6F6E74
	      7572
  43:     -	38F5  00      		db 	0
  43:     -	38F6          		endm
**** out/include-patcher.asm ****
  43:					include "generator/V0/out/patcher-microdos-MICRODOS_OPTS2_900105.asm"	;  4 images in collection
**** generator/V0/out/patcher-microdos-MICRODOS_OPTS2_900105.asm ****
   1:     -	38F6          	_BIOS_MICRODOS_OPTS2_900105:
   2:					
   3:     -	38F6          		setMICRODOS
   3:     -	38F6  56      		db 	pSETFLAG_MICRODOS
   3:     -	38F7          		endm
   4:     -	38F7          		RQ_OPTS_ANY
   4:     -	38F7          		endm
   5:				
   6:					;BIOS_LOAD_ADDR-------------------------------------------------------------------
   7:					;BIOS_START_ADDR
   8:					;правилнее проверять прямо в 8000 ????
   9:					;копия бутсектора из 8000, 
  10:					;
  11:					;адресс загрузки, куда биос загружает сектора с диска
  12:					;	dwpatch	0xBD80,	0xBD80, 0xBD80
  13:					;адресс старта, куда биос передаёт управление
  14:					;	dwpatch	0xBD82,	0xBE00,	0xBE00
  15:				
  16:					
  17:					;BDOS_ENTRY_POINT---------------------------------------------------------
  18:					;BDOS_ENTRY_POINT2
  19:					;значение перехода, проверяим их для надёжности
  20:					;0005 jp c000
  21:					;RAM:C000          _BDOS:                                  
  22:					;RAM:C000                                                  
  23:					;RAM:C000 C3 87 C4                 jp      loc_C487
  24:					;RAM:C003 C3 C0 DB                 jp      loc_DBC0
  25:					; 	dwpatch	0xc000+1,0xC487,0xC487
  26:					; 	dwpatch	0xc003+1,0xDBC0,0xDBC0
  27:				
  28:					;BIOS_LOGO_ADDR--------------------------------------------------------------
  29:					;косметика,  
  30:					;Биос при старте очищает экран, мы патчим его чтобы он это не делал
  31:					;иначе он затрёт все сообщения патчера, а там много полезной информации
  32:					;выгядит это в коде так
  33:					;это значение там только во время старта, дальше там буфер .....
  34:				
  35:					; RAM:F04E 1B 45 EB+BOOT_LOGO:      text "koi8-r", '\\x1BКОРВЕТ ПК8020\\r\\n'
  36:					; RAM:F04E E5 F4 20+                text "koi8-r", 'НИИСЧЁТМАШ 01.05.90\\r\\n'
  37:					; RAM:F04E F0 EB 38+                text "koi8-r", '$'
  38:     -	38F7          		dbpatchmaybe	0xF04E	,0x1B	,0x0d
  38:     -	38F7  59      		db 	pB_MAYBE_PATCH
  38:     -	38F8  4EF0    		dw 	0xF04E
  38:     -	38FA  1B0D    		db 	0x1B,0x0d
  38:     -	38FC          		endm
  39:     -	38FC          		dbpatchmaybe	0xF04E+1	,0x45	,0x0d
  39:     -	38FC  59      		db 	pB_MAYBE_PATCH
  39:     -	38FD  4FF0    		dw 	0xF04E+1
  39:     -	38FF  450D    		db 	0x45,0x0d
  39:     -	3901          		endm
  40:				
  41:					;JP_READ-----------------------------------------------------------------------
  42:					;JP_WRITE
  43:					; перехватываем обращение к чтению/записи в биос
  44:					; подменяем адресса для чтения/записи
  45:					; собственно во всех это куче кода нас интересует адресса EAFF и EB04
  46:					
  47:					; точки входа обычного биоса
  48:					; RAM:C027 C3 7B DD                 jp      do_READ
  49:					; RAM:C02A C3 78 DD                 jp      do_WRITE
  50:					;.....
  51:					; RAM:DD78          do_WRITE:                               
  52:					; RAM:DD78 3E 06                    ld      a, 6
  53:					; RAM:DD7A 21                       db 21h
  54:					; RAM:DD7B          do_READ:                                
  55:					; RAM:DD7B                                                  
  56:					; RAM:DD7B 3E 04                    ld      a, 4
  57:					; RAM:DD7D 32 1D DF                 ld      (dsk_description.Fucntion), a
  58:					; RAM:DD80 21 1B DF                 ld      hl, dsk_description
  59:					; RAM:DD83 C3 12 E4                 jp      RW_DISK
  60:					; ...
  61:					; RAM:E412          RW_DISK:                                
  62:					; RAM:E412                                                  
  63:					; RAM:E412 C3 A5 EA                 jp      j_DSKIO
  64:				
  65:					; RAM:EAA5          j_DSKIO:                                
  66:					; RAM:EAA5 3A 03 F7                 ld      a, (SysCOPY)
  67:					; RAM:EAA8 F5                       push    af
  68:					; RAM:EAA9 EB                       ex      de, hl
  69:					; RAM:EAAA 06 5C                    ld      b, 5Ch ; '\'
  70:					; RAM:EAAC CD 9F E4                 call    setSYSREG
  71:					; RAM:EAAF EB                       ex      de, hl
  72:					; RAM:EAB0 CD BF EA                 call    do_DSKIO
  73:					; RAM:EAB3 47                       ld      b, a
  74:					; RAM:EAB4 F1                       pop     af
  75:					; RAM:EAB5 F3                       di
  76:					; RAM:EAB6 32 7F FF                 ld      (_5C_SysReg1C), a
  77:					; RAM:EAB9 32 03 F7                 ld      (SysCOPY), a
  78:					; RAM:EABC FB                       ei
  79:					; RAM:EABD 78                       ld      a, b
  80:					; RAM:EABE C9                       ret
  81:					; ....
  82:					; RAM:EABF          do_DSKIO:                               
  83:					; RAM:EABF 79                       ld      a, c
  84:					; RAM:EAC0 32 F7 EE                 ld      (DSK_IO_WriteType), a ; 0       (normal sector write)
  85:					; RAM:EAC0                                                  ; 1       (write to directory sector)
  86:					; RAM:EAC0                                                  ; 2       (write to the first sector of a new data block)
  87:					; RAM:EAC3 22 F8 EE                 ld      (DSC_IO_HL), hl ; DSCDESCR
  88:					; RAM:EAC6          ;
  89:					; RAM:EAC6 3A F6 EE                 ld      a, (E_DRIVE_FLAG)
  90:					; RAM:EAC9 A6                       and     (hl)            ; DRIVE?
  91:					; RAM:EACA FE 04                    cp      4
  92:					; RAM:EACC CA 80 FC                 jp      z, E_DRIVE
  93:					; RAM:EACF          ;
  94:					; RAM:EACF 7E                       ld      a, (hl)
  95:					; RAM:EAD0 FE 02                    cp      2
  96:					; RAM:EAD2 D2 07 EB                 jp      nc, invalidDrive
  97:					; RAM:EAD5          ;
  98:					; ....
  99:					; RAM:EAFA 22 FA EE                 ld      (_DMA??), hl
 100:					; RAM:EAFD FE 04                    cp      4
 101:					; RAM:EAFF CA 36 EB                 jp      z, jREAD
 102:					; RAM:EB02 FE 06                    cp      6
 103:					; RAM:EB04 CA A0 EB                 jp      z, jWRITE
 104:					; RAM:EB07
 105:					; RAM:EB07          invalidDrive:                           
 106:					; RAM:EB07                                                  
 107:					; RAM:EB07 3E FF                    ld      a, 0FFh
 108:					; RAM:EB09 C9                       ret
 109:				
 110:					; а так как пока в резиденте нет поддержки работы с реальными дисками то 
 111:					; адресса оригинальных пока не сохраняем к себе ....
 112:					; TODO: microdos real disk support
 113:				
 114:     -	3901          		dwpatch	0xEAFF+1	,0xEB36	,MD_READ			
 114:     -	3901  51      		db 	pW_CHK_PATCH
 114:     -	3902  00EB    		dw 	0xEAFF+1
 114:     -	3904  36EB3EFA		dw 	0xEB36,MD_READ
 114:     -	3908          		endm
 115:     -	3908          		dwpatch	0xEB04+1	,0xEBA0	,MD_WRITE
 115:     -	3908  51      		db 	pW_CHK_PATCH
 115:     -	3909  05EB    		dw 	0xEB04+1
 115:     -	390B  A0EB53FA		dw 	0xEBA0,MD_WRITE
 115:     -	390F          		endm
 116:				
 117:					;GET_INFO_FDC_SEEK -------------------------------------------------------------
 118:					;GET_INFO_CALL_READ
 119:					;кусок GET_INFO_C, подменяем чтение инфосектора
 120:					; RAM:EC56          GET_INFO_C:                             ; CODE XREF: jGetDPH_Addr+29p
 121:					; RAM:EC56 79                       ld      a, c            ; drive
 122:					; RAM:EC57 B7                       or      a
 123:					; RAM:EC58 3A 93 E6                 ld      a, (dsk_info_a.intiFlag)
 124:					; RAM:EC5B CA 61 EC                 jp      z, loc_EC61
 125:					; RAM:EC61
 126:					;....
 127:					; RAM:EC86 2B                       dec     hl
 128:					; RAM:EC87 CD 14 EE                 call    SEL_DSK_SEEK0
 129:					; RAM:EC8A CD 1E EE                 call    ReadToRDBUF
 130:					; RAM:EC8D          ;
 131:					; RAM:EC8D 3E 04                    ld      a, 4
 132:					; RAM:EC8F 32 FF EE                 ld      (DSK_TRY_Count), a
 133:				
 134:					; для начала удаляем комманду которая готовит чтение с физичесского дисковода
 135:     -	390F          		dbpatch	0xEC87	,0xcd	,0x00
 135:     -	390F  52      		db 	pB_CHK_PATCH
 135:     -	3910  87EC    		dw 	0xEC87
 135:     -	3912  CD00    		db 	0xcd,0x00
 135:     -	3914          		endm
 136:     -	3914          		dwpatch	0xEC87+1	,0xEE14	,0x0000
 136:     -	3914  51      		db 	pW_CHK_PATCH
 136:     -	3915  88EC    		dw 	0xEC87+1
 136:     -	3917  14EE0000		dw 	0xEE14,0x0000
 136:     -	391B          		endm
 137:				
 138:					;GET_INFO_CALL_READ------------------------------------------------------
 139:					;подменяем чтение сектора с диска на нашу функцию
 140:     -	391B          		dwpatch	0xEC8A+1	,0xEE1E	,MD_READ_INFOSECTOR
 140:     -	391B  51      		db 	pW_CHK_PATCH
 140:     -	391C  8BEC    		dw 	0xEC8A+1
 140:     -	391E  1EEE68FA		dw 	0xEE1E,MD_READ_INFOSECTOR
 140:     -	3922          		endm
 141:				
 142:					;DISKINFO_DRIVE--------------------------------------------------------------------------------
 143:					;эти два адресса нужны для DISKINFO
 144:					;rdBufDiskInfo - это очередной блок параметров, по нужному адрессу там текущий диск для операции DISKINFO
 145:					; в примере ниже чтение нашего байта по адрессу 0xED82
 146:					; а собственно адресс по адрессу 0xEB7E (значение 0xEF06)
 147:					; RAM:EB36          jREAD:                                  
 148:					; RAM:EB36 2A F8 EE                 ld      hl, (DSC_IO_HL) 
 149:					; ...
 150:					; RAM:EB7E          ;
 151:					; RAM:EB7E 21 06 EF                 ld      hl, rdBufDiskInfo
 152:					; RAM:EB81 CD 7D ED                 call    FDD_Setup
 153:					; ...
 154:					; RAM:ED7D          FDD_Setup:                              
 155:					; RAM:ED7D                                                  
 156:					; RAM:ED7D 3E D0                    ld      a, FDC_3_FORCE_STOP
 157:					; RAM:ED7F 32 18 FE                 ld      (_5C_FDC_Cmd), a
 158:					; RAM:ED82          ;
 159:					; RAM:ED82 7E                       ld      a, (hl)         ; drive
 160:					; RAM:ED83 B7                       or      a
 161:					; RAM:ED84 06 01                    ld      b, 1
 162:					; RAM:ED86 CA 8B ED                 jp      z, loc_ED8B
 163:				
 164:     -	3922          		dwstore	MD_DRV2+1,	0xEF06
 164:     -	3922  54      		db 	pW_STORE
 164:     -	3923  06EF    		dw 	0xEF06
 164:     -	3925  F3FA    		dw 	MD_DRV2+1
 164:     -	3927          		endm
 165:				
 166:					;DISKINFO_READ_BUFFER--------------------------------------------------------------------------
 167:					;BUF_RD_1k
 168:					;адресс буфера кудв мы читаем 0й сектор а дальше уже старый код в биосе
 169:					;делает всё остальное
 170:					; тут он присутсвует по адрессу 0xEC97 (значение 0xF04E)
 171:					; собственно это подсчёт Контрольной суммы
 172:					; RAM:EC56          GET_INFO_C:                             
 173:					; RAM:EC56 79                       ld      a, c            
 174:					; RAM:EC57 B7                       or      a
 175:					; RAM:EC58 3A 93 E6                 ld      a, (dsk_info_a.intiFlag)
 176:					; RAM:EC5B CA 61 EC                 jp      z, loc_EC61
 177:					; RAM:EC5E 3A 97 E6                 ld      a, (dsk_info_b.intiFlag)
 178:					; RAM:EC61
 179:					; RAM:EC61          loc_EC61:                               
 180:					; RAM:EC61 B7                       or      a
 181:					; RAM:EC62 C2 EC EC                 jp      nz, diskAlreadyInit
 182:					; RAM:EC65          ;
 183:					; ...
 184:					; RAM:EC97          ;
 185:					; RAM:EC97 21 4E F0                 ld      hl, BUF_RD_1k
 186:					; RAM:EC9A 0E 1F                    ld      c, 1Fh
 187:					; RAM:EC9C 3E 66                    ld      a, 66h ; 'f'
 188:					; RAM:EC9E
 189:					; RAM:EC9E          CalcCRC_Loop:                           
 190:					; RAM:EC9E 86                       add     a, (hl)
 191:					; RAM:EC9F 23                       inc     hl
 192:					; RAM:ECA0 0D                       dec     c
 193:					; RAM:ECA1 C2 9E EC                 jp      nz, CalcCRC_Loop
 194:					; RAM:ECA4 BE                       cp      (hl)
 195:					; RAM:ECA5          ;
 196:					; RAM:ECA5 3E 02                    ld      a, 2            ; CRC Error
 197:					; RAM:ECA7 C0                       ret     nz
 198:				
 199:     -	3927          		dwstore	MD_RDBUF2+1,	0xF04E
 199:     -	3927  54      		db 	pW_STORE
 199:     -	3928  4EF0    		dw 	0xF04E
 199:     -	392A  02FB    		dw 	MD_RDBUF2+1
 199:     -	392C          		endm
 200:					
 201:					;DISK_IO_PARAM_BLOCK_ADDR------------------------------------------------------------------------
 202:					;адресс таблички с параметрами дисководой операции
 203:					;dsk,trk,sec,dma берутся тут
 204:					;DSC_IO_HL
 205:     -	392C          		dwstore	MD_PARAM2+1,	0xEEF8
 205:     -	392C  54      		db 	pW_STORE
 205:     -	392D  F8EE    		dw 	0xEEF8
 205:     -	392F  1DFA    		dw 	MD_PARAM2+1
 205:     -	3931          		endm
 206:				
 207:					;DISABLE_DISK_CHECK------------------------------------------------------------------------------
 208:					;убираем проверку в биосе на наличие дисководов
 209:					; RAM:BE00          _BOOT:                                  
 210:					; RAM:BE00                                                  
 211:					; RAM:BE00 F3                       di
 212:					; RAM:BE01 31 00 BE                 ld      sp, 0BE00h
 213:					; RAM:BE04 3A 01 F7                 ld      a, (FDDFLAG)
 214:					; RAM:BE07 E6 02                    and     2
 215:					; RAM:BE09 C2 40 00                 jp      nz, R_RunBasic??	
 216:					;dbpatch 0xbe07+1	,0x02	,0x00
 217:					
 218:					;FLUSH_WRITE_ADDR-------------------------------------------------------------------------------
 219:					; FLUSH нам не нужен, т.к. наша запись идёт без буферезации.
 220:					; TODO: JP invalidateWRBUF ???
 221:					; RAM:EC3A          Flush?:                                 
 222:					; RAM:EC3A                                                  
 223:					; RAM:EC3A 21 FD EE                 ld      hl, flagWriteReuired?
 224:					; RAM:EC3D 7E                       ld      a, (hl)
 225:					; RAM:EC3E B7                       or      a
 226:					; RAM:EC3F C8                       ret     z
 227:					; RAM:EC40          ;
 228:					; RAM:EC40 36 00                    ld      (hl), 0
 229:					; RAM:EC42          ;
 230:					; RAM:EC42 21 0A EF                 ld      hl, WrBufDiskInfo
 231:					; RAM:EC45 CD 7D ED                 call    FDD_Setup
 232:					; RAM:EC48          ;
 233:					; RAM:EC48 CD 66 EE                 call    FDD_Write
 234:					; RAM:EC4B C8                       ret     z
 235:					; RAM:EC4C          invalidateWRBUF:                        
 236:					; RAM:EC4C                                                  
 237:					; RAM:EC4C 21 0A EF                 ld      hl, WrBufDiskInfo
 238:					; RAM:EC4F 36 FF                    ld      (hl), 0FFh
 239:					; RAM:EC51 C9                       ret	
 240:					;dbpatch 0xEC42		,0x21	,0xC9
 241:				
 242:					;SELDSK_ADDR------------------------------------------------------------
 243:					;и модифицируем вызов SELDSK чтобы он поддерживал дополнительную проверку
 244:					;модифицируем оригинальный перехо в SELDSK чтобы он переходил на наш код	
 245:					;и сохраняем старый адресс (в данном коде нужный нам адресс 0xDCB6)
 246:					;RAM:DA1B          _SELDSK:                         ; IN: C
 247:					;RAM:DA1B C3 B6 DC          jp      __SELDSK        ; OUT: HL-DPB/0, HL=xVTRAP0 if c=0xff
 248:				
 249:     -	3931          		dwpatch 0xc01b+1	 ,0xdd4c	,md_res_seldsk
 249:     -	3931  51      		db 	pW_CHK_PATCH
 249:     -	3932  1CC0    		dw 	0xc01b+1
 249:     -	3934  4CDD0EFA		dw 	0xdd4c,md_res_seldsk
 249:     -	3938          		endm
 250:     -	3938          		dwstore md_old_seld_dsk+1,0xdd4c	,0xdd4c
 250:     -	3938  54      		db 	pW_STORE
 250:     -	3939  4CDD    		dw 	0xdd4c
 250:     -	393B  12FA    		dw 	md_old_seld_dsk+1
 250:     -	393D          		endm
 251:				
 252:					;custom checkers
 253:     -	393D          		dwpatch	0xBD80	,0xBD80 ,0xBD80
 253:     -	393D  51      		db 	pW_CHK_PATCH
 253:     -	393E  80BD    		dw 	0xBD80
 253:     -	3940  80BD80BD		dw 	0xBD80,0xBD80
 253:     -	3944          		endm
 254:     -	3944          		dwpatch	0xBD82	,0xBE00 ,0xBE00
 254:     -	3944  51      		db 	pW_CHK_PATCH
 254:     -	3945  82BD    		dw 	0xBD82
 254:     -	3947  00BE00BE		dw 	0xBE00,0xBE00
 254:     -	394B          		endm
 255:     -	394B          		dwpatch	0xc000+1	,0xC487 ,0xC487
 255:     -	394B  51      		db 	pW_CHK_PATCH
 255:     -	394C  01C0    		dw 	0xc000+1
 255:     -	394E  87C487C4		dw 	0xC487,0xC487
 255:     -	3952          		endm
 256:     -	3952          		dwpatch	0xc003+1	,0xDBC0 ,0xDBC0
 256:     -	3952  51      		db 	pW_CHK_PATCH
 256:     -	3953  04C0    		dw 	0xc003+1
 256:     -	3955  C0DBC0DB		dw 	0xDBC0,0xDBC0
 256:     -	3959          		endm
 257:     -	3959          		dbpatch	0xbe07+1	,0x02 ,0x02
 257:     -	3959  52      		db 	pB_CHK_PATCH
 257:     -	395A  08BE    		dw 	0xbe07+1
 257:     -	395C  0202    		db 	0x02,0x02
 257:     -	395E          		endm
 258:     -	395E          		dbpatch	0xEC42	,0x21 ,0x21
 258:     -	395E  52      		db 	pB_CHK_PATCH
 258:     -	395F  42EC    		dw 	0xEC42
 258:     -	3961  2121    		db 	0x21,0x21
 258:     -	3963          		endm
 259:				
 260:					;STOP-------------------------------------------------------------------------------
 261:     -	3963          		stop 'MICRODOS_OPTS2_900105'
 261:     -	3963  50      		db 	p_STOP
 261:     -	3964  4D494352		db 	'MICRODOS_OPTS2_900105'
	      4F444F53
	      5F4F5054
	      53325F39
	      30303130
	      35
 261:     -	3979  00      		db 	0
 261:     -	397A          		endm
 262:					;'MICRODOS_2_900105'
**** out/include-patcher.asm ****
  44:					include "generator/V0/out/patcher-cpm2-CPM_12_87_11_niijaf.asm"	;  3 images in collection
**** generator/V0/out/patcher-cpm2-CPM_12_87_11_niijaf.asm ****
   1:     -	397A          	_BIOS_CPM_12_87_11_niijaf:
   2:     -	397A          		setSUBBIOS 2
   2:     -	397A  5A      		db	pSubBios
   2:     -	397B  02      		db 	2
   2:     -	397C          		endm
   3:     -	397C          		RQ_OPTS_ANY
   3:     -	397C          		endm
   4:     -	397C          		setCPM
   4:     -	397C          		endm
   5:     -	397C          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	397C  59      		db 	pB_MAYBE_PATCH
   5:     -	397D  EEDA    		dw 	0xDAEE
   5:     -	397F  1F0D    		db 	0x1F,0x0d
   5:     -	3981          		endm
   6:     -	3981          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	3981  59      		db 	pB_MAYBE_PATCH
   6:     -	3982  F0DA    		dw 	0xDAEE+2
   6:     -	3984  0A0D    		db 	0x0a,0x0d
   6:     -	3986          		endm
   7:     -	3986          		dbpatch	0xE30E+1	,0x49	,0xc9
   7:     -	3986  52      		db 	pB_CHK_PATCH
   7:     -	3987  0FE3    		dw 	0xE30E+1
   7:     -	3989  49C9    		db 	0x49,0xc9
   7:     -	398B          		endm
   8:     -	398B          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	398B  52      		db 	pB_CHK_PATCH
   8:     -	398C  88DA    		dw 	0xDA88
   8:     -	398E  0100    		db 	0x01,0x00
   8:     -	3990          		endm
   9:     -	3990          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	3990  52      		db 	pB_CHK_PATCH
   9:     -	3991  9FDA    		dw 	0xDA9F
   9:     -	3993  0200    		db 	0x02,0x00
   9:     -	3995          		endm
  10:     -	3995          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	3995  52      		db 	pB_CHK_PATCH
  10:     -	3996  B6DA    		dw 	0xDAB6
  10:     -	3998  0401    		db 	0x04,0x01
  10:     -	399A          		endm
  11:     -	399A          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	399A  52      		db 	pB_CHK_PATCH
  11:     -	399B  CDDA    		dw 	0xDACD
  11:     -	399D  0802    		db 	0x08,0x02
  11:     -	399F          		endm
  12:     -	399F          		dwstore	_CPM2_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	399F  54      		db 	pW_STORE
  12:     -	39A0  88DA    		dw 	0xDA88
  12:     -	39A2  06EA    		dw 	_CPM2_res_DRIVE_TAB+0*2
  12:     -	39A4          		endm
  13:     -	39A4          		dwstore	_CPM2_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	39A4  54      		db 	pW_STORE
  13:     -	39A5  9FDA    		dw 	0xDA9F
  13:     -	39A7  08EA    		dw 	_CPM2_res_DRIVE_TAB+1*2
  13:     -	39A9          		endm
  14:     -	39A9          		dwstore	_CPM2_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	39A9  54      		db 	pW_STORE
  14:     -	39AA  B6DA    		dw 	0xDAB6
  14:     -	39AC  0AEA    		dw 	_CPM2_res_DRIVE_TAB+2*2
  14:     -	39AE          		endm
  15:     -	39AE          		dwstore	_CPM2_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	39AE  54      		db 	pW_STORE
  15:     -	39AF  CDDA    		dw 	0xDACD
  15:     -	39B1  0CEA    		dw 	_CPM2_res_DRIVE_TAB+3*2
  15:     -	39B3          		endm
  16:     -	39B3          		dwpatch 0xDCF6+5*2 	,0x0000 ,_CPM2_dph_F
  16:     -	39B3  51      		db 	pW_CHK_PATCH
  16:     -	39B4  00DD    		dw 	0xDCF6+5*2
  16:     -	39B6  000012EA		dw 	0x0000,_CPM2_dph_F
  16:     -	39BA          		endm
  17:     -	39BA          		dwstore _CPM2_dph_F+8	,0xDFDB
  17:     -	39BA  54      		db 	pW_STORE
  17:     -	39BB  DBDF    		dw 	0xDFDB
  17:     -	39BD  1AEA    		dw 	_CPM2_dph_F+8
  17:     -	39BF          		endm
  18:     -	39BF          		dwpatch 0xDA1B+1 	,0xDCB2	,_CPM2_res_seldsk
  18:     -	39BF  51      		db 	pW_CHK_PATCH
  18:     -	39C0  1CDA    		dw 	0xDA1B+1
  18:     -	39C2  B2DC6BEA		dw 	0xDCB2,_CPM2_res_seldsk
  18:     -	39C6          		endm
  19:     -	39C6          		dwstore	_CPM2_old_seld_dsk+1	,0xDCB2
  19:     -	39C6  54      		db 	pW_STORE
  19:     -	39C7  B2DC    		dw 	0xDCB2
  19:     -	39C9  6FEA    		dw 	_CPM2_old_seld_dsk+1
  19:     -	39CB          		endm
  20:     -	39CB          		dbpatch	0xE789	,0x77	,0x00
  20:     -	39CB  52      		db 	pB_CHK_PATCH
  20:     -	39CC  89E7    		dw 	0xE789
  20:     -	39CE  7700    		db 	0x77,0x00
  20:     -	39D0          		endm
  21:     -	39D0          		dwstore	_CPM2_r_p_SELDSKDRIVER+1	,0xDFC9
  21:     -	39D0  54      		db 	pW_STORE
  21:     -	39D1  C9DF    		dw 	0xDFC9
  21:     -	39D3  88EA    		dw 	_CPM2_r_p_SELDSKDRIVER+1
  21:     -	39D5          		endm
  22:     -	39D5          		dwstore	_CPM2_r_p_SELDSKDRIVEW+1	,0xDFC9
  22:     -	39D5  54      		db 	pW_STORE
  22:     -	39D6  C9DF    		dw 	0xDFC9
  22:     -	39D8  C5EA    		dw 	_CPM2_r_p_SELDSKDRIVEW+1
  22:     -	39DA          		endm
  23:     -	39DA          		dwpatch	0xDA27+1	,0xDD15	,_CPM2_res_READ
  23:     -	39DA  51      		db 	pW_CHK_PATCH
  23:     -	39DB  28DA    		dw 	0xDA27+1
  23:     -	39DD  15DD75EA		dw 	0xDD15,_CPM2_res_READ
  23:     -	39E1          		endm
  24:     -	39E1          		dwpatch	0xDA2A+1	,0xDE4B	,_CPM2_res_WRITE
  24:     -	39E1  51      		db 	pW_CHK_PATCH
  24:     -	39E2  2BDA    		dw 	0xDA2A+1
  24:     -	39E4  4BDEB2EA		dw 	0xDE4B,_CPM2_res_WRITE
  24:     -	39E8          		endm
  25:     -	39E8          		dwpatch	0xDB70+1	,0xDD15	,_CPM2_res_READ
  25:     -	39E8  51      		db 	pW_CHK_PATCH
  25:     -	39E9  71DB    		dw 	0xDB70+1
  25:     -	39EB  15DD75EA		dw 	0xDD15,_CPM2_res_READ
  25:     -	39EF          		endm
  26:     -	39EF          		dwpatch	0xDCE4+1	,0xE6BF	,_CPM2_res_GETINFO
  26:     -	39EF  51      		db 	pW_CHK_PATCH
  26:     -	39F0  E5DC    		dw 	0xDCE4+1
  26:     -	39F2  BFE6EFEA		dw 	0xE6BF,_CPM2_res_GETINFO
  26:     -	39F6          		endm
  27:     -	39F6          		dwstore	_CPM2__old_read+1	,0xDD15
  27:     -	39F6  54      		db 	pW_STORE
  27:     -	39F7  15DD    		dw 	0xDD15
  27:     -	39F9  B0EA    		dw 	_CPM2__old_read+1
  27:     -	39FB          		endm
  28:     -	39FB          		dwstore	_CPM2__old_write+1	,0xDE4B
  28:     -	39FB  54      		db 	pW_STORE
  28:     -	39FC  4BDE    		dw 	0xDE4B
  28:     -	39FE  EDEA    		dw 	_CPM2__old_write+1
  28:     -	3A00          		endm
  29:     -	3A00          		dwstore	_CPM2__old_getinfo+1	,0xE6BF
  29:     -	3A00  54      		db 	pW_STORE
  29:     -	3A01  BFE6    		dw 	0xE6BF
  29:     -	3A03  FDEA    		dw 	_CPM2__old_getinfo+1
  29:     -	3A05          		endm
  30:     -	3A05          		dbpatch	0xE6FF		,0x21	,0x21
  30:     -	3A05  52      		db 	pB_CHK_PATCH
  30:     -	3A06  FFE6    		dw 	0xE6FF
  30:     -	3A08  2121    		db 	0x21,0x21
  30:     -	3A0A          		endm
  31:     -	3A0A          		dwpatch	0xE6FF+1 	,0xe72F	,0xe72F
  31:     -	3A0A  51      		db 	pW_CHK_PATCH
  31:     -	3A0B  00E7    		dw 	0xE6FF+1
  31:     -	3A0D  2FE72FE7		dw 	0xe72F,0xe72F
  31:     -	3A11          		endm
  32:     -	3A11          		dwstore	_CPM2__old_getinfo_chkdo+1	,0xE6FF
  32:     -	3A11  54      		db 	pW_STORE
  32:     -	3A12  FFE6    		dw 	0xE6FF
  32:     -	3A14  FAEA    		dw 	_CPM2__old_getinfo_chkdo+1
  32:     -	3A16          		endm
  33:     -	3A16          		dwstore	_CPM2_r_p_DSK1+1	,0xDFBF 	;read
  33:     -	3A16  54      		db 	pW_STORE
  33:     -	3A17  BFDF    		dw 	0xDFBF
  33:     -	3A19  76EA    		dw 	_CPM2_r_p_DSK1+1
  33:     -	3A1B          		endm
  34:     -	3A1B          		dwstore	_CPM2_r_p_TRK1+1	,0xDFC3 	
  34:     -	3A1B  54      		db 	pW_STORE
  34:     -	3A1C  C3DF    		dw 	0xDFC3
  34:     -	3A1E  91EA    		dw 	_CPM2_r_p_TRK1+1
  34:     -	3A20          		endm
  35:     -	3A20          		dwstore	_CPM2_r_p_SEC1+1	,0xDFC4 	
  35:     -	3A20  54      		db 	pW_STORE
  35:     -	3A21  C4DF    		dw 	0xDFC4
  35:     -	3A23  97EA    		dw 	_CPM2_r_p_SEC1+1
  35:     -	3A25          		endm
  36:     -	3A25          		dwstore	_CPM2_r_p_DMA1+1	,0xDFC5 	
  36:     -	3A25  54      		db 	pW_STORE
  36:     -	3A26  C5DF    		dw 	0xDFC5
  36:     -	3A28  A8EA    		dw 	_CPM2_r_p_DMA1+1
  36:     -	3A2A          		endm
  37:     -	3A2A          		dwstore	_CPM2_r_p_DSK2+1	,0xDFBF 	;write
  37:     -	3A2A  54      		db 	pW_STORE
  37:     -	3A2B  BFDF    		dw 	0xDFBF
  37:     -	3A2D  B3EA    		dw 	_CPM2_r_p_DSK2+1
  37:     -	3A2F          		endm
  38:     -	3A2F          		dwstore	_CPM2_r_p_TRK2+1	,0xDFC3 	
  38:     -	3A2F  54      		db 	pW_STORE
  38:     -	3A30  C3DF    		dw 	0xDFC3
  38:     -	3A32  CEEA    		dw 	_CPM2_r_p_TRK2+1
  38:     -	3A34          		endm
  39:     -	3A34          		dwstore	_CPM2_r_p_SEC2+1	,0xDFC4 	
  39:     -	3A34  54      		db 	pW_STORE
  39:     -	3A35  C4DF    		dw 	0xDFC4
  39:     -	3A37  D4EA    		dw 	_CPM2_r_p_SEC2+1
  39:     -	3A39          		endm
  40:     -	3A39          		dwstore	_CPM2_r_p_DMA2+1	,0xDFC5 	
  40:     -	3A39  54      		db 	pW_STORE
  40:     -	3A3A  C5DF    		dw 	0xDFC5
  40:     -	3A3C  E5EA    		dw 	_CPM2_r_p_DMA2+1
  40:     -	3A3E          		endm
  41:     -	3A3E          		dwstore	_CPM2_r_p_DSK3+1	,0xDFBF 	;readinfo
  41:     -	3A3E  54      		db 	pW_STORE
  41:     -	3A3F  BFDF    		dw 	0xDFBF
  41:     -	3A41  82EB    		dw 	_CPM2_r_p_DSK3+1
  41:     -	3A43          		endm
  42:				
  43:     -	3A43          		stop 'CPM_12_87_11_niijaf'
  43:     -	3A43  50      		db 	p_STOP
  43:     -	3A44  43504D5F		db 	'CPM_12_87_11_niijaf'
	      31325F38
	      375F3131
	      5F6E6969
	      6A6166
  43:     -	3A57  00      		db 	0
  43:     -	3A58          		endm
**** out/include-patcher.asm ****
  45:					include "generator/V0/out/patcher-cpm1-CPM_21m_____Shkanov.asm"	;  2 images in collection
**** generator/V0/out/patcher-cpm1-CPM_21m_____Shkanov.asm ****
   1:     -	3A58          	_BIOS_CPM_21m_____Shkanov:
   2:     -	3A58          		setSUBBIOS 1
   2:     -	3A58  5A      		db	pSubBios
   2:     -	3A59  01      		db 	1
   2:     -	3A5A          		endm
   3:     -	3A5A          		RQ_OPTS_ANY
   3:     -	3A5A          		endm
   4:     -	3A5A          		setCPM
   4:     -	3A5A          		endm
   5:     -	3A5A          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	3A5A  59      		db 	pB_MAYBE_PATCH
   5:     -	3A5B  EEDA    		dw 	0xDAEE
   5:     -	3A5D  1F0D    		db 	0x1F,0x0d
   5:     -	3A5F          		endm
   6:     -	3A5F          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	3A5F  59      		db 	pB_MAYBE_PATCH
   6:     -	3A60  F0DA    		dw 	0xDAEE+2
   6:     -	3A62  0A0D    		db 	0x0a,0x0d
   6:     -	3A64          		endm
   7:     -	3A64          		dbpatch	0xE135+1	,0x49	,0xc9
   7:     -	3A64  52      		db 	pB_CHK_PATCH
   7:     -	3A65  36E1    		dw 	0xE135+1
   7:     -	3A67  49C9    		db 	0x49,0xc9
   7:     -	3A69          		endm
   8:     -	3A69          		dbpatch	0xDA89 	,0x01	,0x00
   8:     -	3A69  52      		db 	pB_CHK_PATCH
   8:     -	3A6A  89DA    		dw 	0xDA89
   8:     -	3A6C  0100    		db 	0x01,0x00
   8:     -	3A6E          		endm
   9:     -	3A6E          		dbpatch	0xDAA0 	,0x02	,0x00
   9:     -	3A6E  52      		db 	pB_CHK_PATCH
   9:     -	3A6F  A0DA    		dw 	0xDAA0
   9:     -	3A71  0200    		db 	0x02,0x00
   9:     -	3A73          		endm
  10:     -	3A73          		dbpatch	0xDAB7 	,0x04	,0x01
  10:     -	3A73  52      		db 	pB_CHK_PATCH
  10:     -	3A74  B7DA    		dw 	0xDAB7
  10:     -	3A76  0401    		db 	0x04,0x01
  10:     -	3A78          		endm
  11:     -	3A78          		dbpatch	0xDACE 	,0x08	,0x02
  11:     -	3A78  52      		db 	pB_CHK_PATCH
  11:     -	3A79  CEDA    		dw 	0xDACE
  11:     -	3A7B  0802    		db 	0x08,0x02
  11:     -	3A7D          		endm
  12:     -	3A7D          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
  12:     -	3A7D  54      		db 	pW_STORE
  12:     -	3A7E  89DA    		dw 	0xDA89
  12:     -	3A80  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	3A82          		endm
  13:     -	3A82          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
  13:     -	3A82  54      		db 	pW_STORE
  13:     -	3A83  A0DA    		dw 	0xDAA0
  13:     -	3A85  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	3A87          		endm
  14:     -	3A87          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
  14:     -	3A87  54      		db 	pW_STORE
  14:     -	3A88  B7DA    		dw 	0xDAB7
  14:     -	3A8A  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	3A8C          		endm
  15:     -	3A8C          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
  15:     -	3A8C  54      		db 	pW_STORE
  15:     -	3A8D  CEDA    		dw 	0xDACE
  15:     -	3A8F  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	3A91          		endm
  16:     -	3A91          		dwpatch 0xDCB5+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	3A91  51      		db 	pW_CHK_PATCH
  16:     -	3A92  BFDC    		dw 	0xDCB5+5*2
  16:     -	3A94  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	3A98          		endm
  17:     -	3A98          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	3A98  54      		db 	pW_STORE
  17:     -	3A99  A6EB    		dw 	0xEBA6
  17:     -	3A9B  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	3A9D          		endm
  18:     -	3A9D          		dwpatch 0xDA1B+1 	,0xDC73	,_CPM1_res_seldsk
  18:     -	3A9D  51      		db 	pW_CHK_PATCH
  18:     -	3A9E  1CDA    		dw 	0xDA1B+1
  18:     -	3AA0  73DC11E9		dw 	0xDC73,_CPM1_res_seldsk
  18:     -	3AA4          		endm
  19:     -	3AA4          		dwstore	_CPM1_old_seld_dsk+1	,0xDC73
  19:     -	3AA4  54      		db 	pW_STORE
  19:     -	3AA5  73DC    		dw 	0xDC73
  19:     -	3AA7  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	3AA9          		endm
  20:     -	3AA9          		dbpatch	0xE6FE	,0x77	,0x00
  20:     -	3AA9  52      		db 	pB_CHK_PATCH
  20:     -	3AAA  FEE6    		dw 	0xE6FE
  20:     -	3AAC  7700    		db 	0x77,0x00
  20:     -	3AAE          		endm
  21:     -	3AAE          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE058
  21:     -	3AAE  54      		db 	pW_STORE
  21:     -	3AAF  58E0    		dw 	0xE058
  21:     -	3AB1  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	3AB3          		endm
  22:     -	3AB3          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE058
  22:     -	3AB3  54      		db 	pW_STORE
  22:     -	3AB4  58E0    		dw 	0xE058
  22:     -	3AB6  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	3AB8          		endm
  23:     -	3AB8          		dwpatch	0xDA27+1	,0xDCD5	,_CPM1_res_READ
  23:     -	3AB8  51      		db 	pW_CHK_PATCH
  23:     -	3AB9  28DA    		dw 	0xDA27+1
  23:     -	3ABB  D5DC1BE9		dw 	0xDCD5,_CPM1_res_READ
  23:     -	3ABF          		endm
  24:     -	3ABF          		dwpatch	0xDA2A+1	,0xDE99	,_CPM1_res_WRITE
  24:     -	3ABF  51      		db 	pW_CHK_PATCH
  24:     -	3AC0  2BDA    		dw 	0xDA2A+1
  24:     -	3AC2  99DE58E9		dw 	0xDE99,_CPM1_res_WRITE
  24:     -	3AC6          		endm
  25:     -	3AC6          		dwpatch	0xDB6A+1	,0xDCD5	,_CPM1_res_READ
  25:     -	3AC6  51      		db 	pW_CHK_PATCH
  25:     -	3AC7  6BDB    		dw 	0xDB6A+1
  25:     -	3AC9  D5DC1BE9		dw 	0xDCD5,_CPM1_res_READ
  25:     -	3ACD          		endm
  26:     -	3ACD          		dwpatch	0xdca8+1	,0xE632	,_CPM1_res_GETINFO
  26:     -	3ACD  51      		db 	pW_CHK_PATCH
  26:     -	3ACE  A9DC    		dw 	0xdca8+1
  26:     -	3AD0  32E695E9		dw 	0xE632,_CPM1_res_GETINFO
  26:     -	3AD4          		endm
  27:     -	3AD4          		dwstore	_CPM1__old_read+1	,0xDCD5
  27:     -	3AD4  54      		db 	pW_STORE
  27:     -	3AD5  D5DC    		dw 	0xDCD5
  27:     -	3AD7  56E9    		dw 	_CPM1__old_read+1
  27:     -	3AD9          		endm
  28:     -	3AD9          		dwstore	_CPM1__old_write+1	,0xDE99
  28:     -	3AD9  54      		db 	pW_STORE
  28:     -	3ADA  99DE    		dw 	0xDE99
  28:     -	3ADC  93E9    		dw 	_CPM1__old_write+1
  28:     -	3ADE          		endm
  29:     -	3ADE          		dwstore	_CPM1__old_getinfo+1	,0xE632
  29:     -	3ADE  54      		db 	pW_STORE
  29:     -	3ADF  32E6    		dw 	0xE632
  29:     -	3AE1  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	3AE3          		endm
  30:     -	3AE3          		dbpatch	0xE669		,0x21	,0x21
  30:     -	3AE3  52      		db 	pB_CHK_PATCH
  30:     -	3AE4  69E6    		dw 	0xE669
  30:     -	3AE6  2121    		db 	0x21,0x21
  30:     -	3AE8          		endm
  31:     -	3AE8          		dwpatch	0xE669+1 	,0xE6A3	,0xE6A3
  31:     -	3AE8  51      		db 	pW_CHK_PATCH
  31:     -	3AE9  6AE6    		dw 	0xE669+1
  31:     -	3AEB  A3E6A3E6		dw 	0xE6A3,0xE6A3
  31:     -	3AEF          		endm
  32:     -	3AEF          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE669
  32:     -	3AEF  54      		db 	pW_STORE
  32:     -	3AF0  69E6    		dw 	0xE669
  32:     -	3AF2  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	3AF4          		endm
  33:     -	3AF4          		dwstore	_CPM1_r_p_DSK1+1	,0xE04E 	;read
  33:     -	3AF4  54      		db 	pW_STORE
  33:     -	3AF5  4EE0    		dw 	0xE04E
  33:     -	3AF7  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	3AF9          		endm
  34:     -	3AF9          		dwstore	_CPM1_r_p_TRK1+1	,0xE052 	
  34:     -	3AF9  54      		db 	pW_STORE
  34:     -	3AFA  52E0    		dw 	0xE052
  34:     -	3AFC  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	3AFE          		endm
  35:     -	3AFE          		dwstore	_CPM1_r_p_SEC1+1	,0xE053 	
  35:     -	3AFE  54      		db 	pW_STORE
  35:     -	3AFF  53E0    		dw 	0xE053
  35:     -	3B01  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	3B03          		endm
  36:     -	3B03          		dwstore	_CPM1_r_p_DMA1+1	,0xE054 	
  36:     -	3B03  54      		db 	pW_STORE
  36:     -	3B04  54E0    		dw 	0xE054
  36:     -	3B06  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	3B08          		endm
  37:     -	3B08          		dwstore	_CPM1_r_p_DSK2+1	,0xE04E 	;write
  37:     -	3B08  54      		db 	pW_STORE
  37:     -	3B09  4EE0    		dw 	0xE04E
  37:     -	3B0B  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	3B0D          		endm
  38:     -	3B0D          		dwstore	_CPM1_r_p_TRK2+1	,0xE052 	
  38:     -	3B0D  54      		db 	pW_STORE
  38:     -	3B0E  52E0    		dw 	0xE052
  38:     -	3B10  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	3B12          		endm
  39:     -	3B12          		dwstore	_CPM1_r_p_SEC2+1	,0xE053 	
  39:     -	3B12  54      		db 	pW_STORE
  39:     -	3B13  53E0    		dw 	0xE053
  39:     -	3B15  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	3B17          		endm
  40:     -	3B17          		dwstore	_CPM1_r_p_DMA2+1	,0xE054 	
  40:     -	3B17  54      		db 	pW_STORE
  40:     -	3B18  54E0    		dw 	0xE054
  40:     -	3B1A  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	3B1C          		endm
  41:     -	3B1C          		dwstore	_CPM1_r_p_DSK3+1	,0xE04E 	;readinfo
  41:     -	3B1C  54      		db 	pW_STORE
  41:     -	3B1D  4EE0    		dw 	0xE04E
  41:     -	3B1F  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	3B21          		endm
  42:				
  43:     -	3B21          		stop 'CPM_21m_____Shkanov'
  43:     -	3B21  50      		db 	p_STOP
  43:     -	3B22  43504D5F		db 	'CPM_21m_____Shkanov'
	      32316D5F
	      5F5F5F5F
	      53686B61
	      6E6F76
  43:     -	3B35  00      		db 	0
  43:     -	3B36          		endm
**** out/include-patcher.asm ****
  46:					include "generator/V0/out/patcher-cpm1-CPM_12_87_09_NIIJAF.asm"	;  2 images in collection
**** generator/V0/out/patcher-cpm1-CPM_12_87_09_NIIJAF.asm ****
   1:     -	3B36          	_BIOS_CPM_12_87_09_NIIJAF:
   2:     -	3B36          		setSUBBIOS 1
   2:     -	3B36  5A      		db	pSubBios
   2:     -	3B37  01      		db 	1
   2:     -	3B38          		endm
   3:     -	3B38          		RQ_OPTS_ANY
   3:     -	3B38          		endm
   4:     -	3B38          		setCPM
   4:     -	3B38          		endm
   5:     -	3B38          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	3B38  59      		db 	pB_MAYBE_PATCH
   5:     -	3B39  EEDA    		dw 	0xDAEE
   5:     -	3B3B  1F0D    		db 	0x1F,0x0d
   5:     -	3B3D          		endm
   6:     -	3B3D          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	3B3D  59      		db 	pB_MAYBE_PATCH
   6:     -	3B3E  F0DA    		dw 	0xDAEE+2
   6:     -	3B40  0A0D    		db 	0x0a,0x0d
   6:     -	3B42          		endm
   7:     -	3B42          		dbpatch	0xE738+1	,0x49	,0xc9
   7:     -	3B42  52      		db 	pB_CHK_PATCH
   7:     -	3B43  39E7    		dw 	0xE738+1
   7:     -	3B45  49C9    		db 	0x49,0xc9
   7:     -	3B47          		endm
   8:     -	3B47          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	3B47  52      		db 	pB_CHK_PATCH
   8:     -	3B48  88DA    		dw 	0xDA88
   8:     -	3B4A  0100    		db 	0x01,0x00
   8:     -	3B4C          		endm
   9:     -	3B4C          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	3B4C  52      		db 	pB_CHK_PATCH
   9:     -	3B4D  9FDA    		dw 	0xDA9F
   9:     -	3B4F  0200    		db 	0x02,0x00
   9:     -	3B51          		endm
  10:     -	3B51          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	3B51  52      		db 	pB_CHK_PATCH
  10:     -	3B52  B6DA    		dw 	0xDAB6
  10:     -	3B54  0401    		db 	0x04,0x01
  10:     -	3B56          		endm
  11:     -	3B56          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	3B56  52      		db 	pB_CHK_PATCH
  11:     -	3B57  CDDA    		dw 	0xDACD
  11:     -	3B59  0802    		db 	0x08,0x02
  11:     -	3B5B          		endm
  12:     -	3B5B          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	3B5B  54      		db 	pW_STORE
  12:     -	3B5C  88DA    		dw 	0xDA88
  12:     -	3B5E  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	3B60          		endm
  13:     -	3B60          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	3B60  54      		db 	pW_STORE
  13:     -	3B61  9FDA    		dw 	0xDA9F
  13:     -	3B63  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	3B65          		endm
  14:     -	3B65          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	3B65  54      		db 	pW_STORE
  14:     -	3B66  B6DA    		dw 	0xDAB6
  14:     -	3B68  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	3B6A          		endm
  15:     -	3B6A          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	3B6A  54      		db 	pW_STORE
  15:     -	3B6B  CDDA    		dw 	0xDACD
  15:     -	3B6D  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	3B6F          		endm
  16:     -	3B6F          		dwpatch 0xDCFA+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	3B6F  51      		db 	pW_CHK_PATCH
  16:     -	3B70  04DD    		dw 	0xDCFA+5*2
  16:     -	3B72  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	3B76          		endm
  17:     -	3B76          		dwstore _CPM1_dph_F+8	,0xDFDF
  17:     -	3B76  54      		db 	pW_STORE
  17:     -	3B77  DFDF    		dw 	0xDFDF
  17:     -	3B79  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	3B7B          		endm
  18:     -	3B7B          		dwpatch 0xDA1B+1 	,0xDCB6	,_CPM1_res_seldsk
  18:     -	3B7B  51      		db 	pW_CHK_PATCH
  18:     -	3B7C  1CDA    		dw 	0xDA1B+1
  18:     -	3B7E  B6DC11E9		dw 	0xDCB6,_CPM1_res_seldsk
  18:     -	3B82          		endm
  19:     -	3B82          		dwstore	_CPM1_old_seld_dsk+1	,0xDCB6
  19:     -	3B82  54      		db 	pW_STORE
  19:     -	3B83  B6DC    		dw 	0xDCB6
  19:     -	3B85  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	3B87          		endm
  20:     -	3B87          		dbpatch	0xE531	,0x77	,0x00
  20:     -	3B87  52      		db 	pB_CHK_PATCH
  20:     -	3B88  31E5    		dw 	0xE531
  20:     -	3B8A  7700    		db 	0x77,0x00
  20:     -	3B8C          		endm
  21:     -	3B8C          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFCD
  21:     -	3B8C  54      		db 	pW_STORE
  21:     -	3B8D  CDDF    		dw 	0xDFCD
  21:     -	3B8F  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	3B91          		endm
  22:     -	3B91          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFCD
  22:     -	3B91  54      		db 	pW_STORE
  22:     -	3B92  CDDF    		dw 	0xDFCD
  22:     -	3B94  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	3B96          		endm
  23:     -	3B96          		dwpatch	0xDA27+1	,0xDD19	,_CPM1_res_READ
  23:     -	3B96  51      		db 	pW_CHK_PATCH
  23:     -	3B97  28DA    		dw 	0xDA27+1
  23:     -	3B99  19DD1BE9		dw 	0xDD19,_CPM1_res_READ
  23:     -	3B9D          		endm
  24:     -	3B9D          		dwpatch	0xDA2A+1	,0xDE4F	,_CPM1_res_WRITE
  24:     -	3B9D  51      		db 	pW_CHK_PATCH
  24:     -	3B9E  2BDA    		dw 	0xDA2A+1
  24:     -	3BA0  4FDE58E9		dw 	0xDE4F,_CPM1_res_WRITE
  24:     -	3BA4          		endm
  25:     -	3BA4          		dwpatch	0xDB6D+1	,0xDD19	,_CPM1_res_READ
  25:     -	3BA4  51      		db 	pW_CHK_PATCH
  25:     -	3BA5  6EDB    		dw 	0xDB6D+1
  25:     -	3BA7  19DD1BE9		dw 	0xDD19,_CPM1_res_READ
  25:     -	3BAB          		endm
  26:     -	3BAB          		dwpatch	0xDCE8+1	,0xE467	,_CPM1_res_GETINFO
  26:     -	3BAB  51      		db 	pW_CHK_PATCH
  26:     -	3BAC  E9DC    		dw 	0xDCE8+1
  26:     -	3BAE  67E495E9		dw 	0xE467,_CPM1_res_GETINFO
  26:     -	3BB2          		endm
  27:     -	3BB2          		dwstore	_CPM1__old_read+1	,0xDD19
  27:     -	3BB2  54      		db 	pW_STORE
  27:     -	3BB3  19DD    		dw 	0xDD19
  27:     -	3BB5  56E9    		dw 	_CPM1__old_read+1
  27:     -	3BB7          		endm
  28:     -	3BB7          		dwstore	_CPM1__old_write+1	,0xDE4F
  28:     -	3BB7  54      		db 	pW_STORE
  28:     -	3BB8  4FDE    		dw 	0xDE4F
  28:     -	3BBA  93E9    		dw 	_CPM1__old_write+1
  28:     -	3BBC          		endm
  29:     -	3BBC          		dwstore	_CPM1__old_getinfo+1	,0xE467
  29:     -	3BBC  54      		db 	pW_STORE
  29:     -	3BBD  67E4    		dw 	0xE467
  29:     -	3BBF  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	3BC1          		endm
  30:     -	3BC1          		dbpatch	0xE4A7		,0x21	,0x21
  30:     -	3BC1  52      		db 	pB_CHK_PATCH
  30:     -	3BC2  A7E4    		dw 	0xE4A7
  30:     -	3BC4  2121    		db 	0x21,0x21
  30:     -	3BC6          		endm
  31:     -	3BC6          		dwpatch	0xE4A7+1 	,0xE4D7	,0xE4D7
  31:     -	3BC6  51      		db 	pW_CHK_PATCH
  31:     -	3BC7  A8E4    		dw 	0xE4A7+1
  31:     -	3BC9  D7E4D7E4		dw 	0xE4D7,0xE4D7
  31:     -	3BCD          		endm
  32:     -	3BCD          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE4A7
  32:     -	3BCD  54      		db 	pW_STORE
  32:     -	3BCE  A7E4    		dw 	0xE4A7
  32:     -	3BD0  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	3BD2          		endm
  33:     -	3BD2          		dwstore	_CPM1_r_p_DSK1+1	,0xDFC3 	;read
  33:     -	3BD2  54      		db 	pW_STORE
  33:     -	3BD3  C3DF    		dw 	0xDFC3
  33:     -	3BD5  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	3BD7          		endm
  34:     -	3BD7          		dwstore	_CPM1_r_p_TRK1+1	,0xDFC7 	
  34:     -	3BD7  54      		db 	pW_STORE
  34:     -	3BD8  C7DF    		dw 	0xDFC7
  34:     -	3BDA  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	3BDC          		endm
  35:     -	3BDC          		dwstore	_CPM1_r_p_SEC1+1	,0xDFC8 	
  35:     -	3BDC  54      		db 	pW_STORE
  35:     -	3BDD  C8DF    		dw 	0xDFC8
  35:     -	3BDF  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	3BE1          		endm
  36:     -	3BE1          		dwstore	_CPM1_r_p_DMA1+1	,0xDFC9 	
  36:     -	3BE1  54      		db 	pW_STORE
  36:     -	3BE2  C9DF    		dw 	0xDFC9
  36:     -	3BE4  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	3BE6          		endm
  37:     -	3BE6          		dwstore	_CPM1_r_p_DSK2+1	,0xDFC3 	;write
  37:     -	3BE6  54      		db 	pW_STORE
  37:     -	3BE7  C3DF    		dw 	0xDFC3
  37:     -	3BE9  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	3BEB          		endm
  38:     -	3BEB          		dwstore	_CPM1_r_p_TRK2+1	,0xDFC7 	
  38:     -	3BEB  54      		db 	pW_STORE
  38:     -	3BEC  C7DF    		dw 	0xDFC7
  38:     -	3BEE  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	3BF0          		endm
  39:     -	3BF0          		dwstore	_CPM1_r_p_SEC2+1	,0xDFC8 	
  39:     -	3BF0  54      		db 	pW_STORE
  39:     -	3BF1  C8DF    		dw 	0xDFC8
  39:     -	3BF3  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	3BF5          		endm
  40:     -	3BF5          		dwstore	_CPM1_r_p_DMA2+1	,0xDFC9 	
  40:     -	3BF5  54      		db 	pW_STORE
  40:     -	3BF6  C9DF    		dw 	0xDFC9
  40:     -	3BF8  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	3BFA          		endm
  41:     -	3BFA          		dwstore	_CPM1_r_p_DSK3+1	,0xDFC3 	;readinfo
  41:     -	3BFA  54      		db 	pW_STORE
  41:     -	3BFB  C3DF    		dw 	0xDFC3
  41:     -	3BFD  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	3BFF          		endm
  42:				
  43:     -	3BFF          		stop 'CPM_12_87_09_NIIJAF'
  43:     -	3BFF  50      		db 	p_STOP
  43:     -	3C00  43504D5F		db 	'CPM_12_87_09_NIIJAF'
	      31325F38
	      375F3039
	      5F4E4949
	      4A4146
  43:     -	3C13  00      		db 	0
  43:     -	3C14          		endm
**** out/include-patcher.asm ****
  47:					include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_871220.asm"	;  2 images in collection
**** generator/V0/out/patcher-microdos-MICRODOS_OPTS1_871220.asm ****
   1:     -	3C14          	_BIOS_MICRODOS_OPTS1_871220:
   2:     -	3C14          		setMICRODOS
   2:     -	3C14  56      		db 	pSETFLAG_MICRODOS
   2:     -	3C15          		endm
   3:     -	3C15          		RQ_OPTS1
   3:     -	3C15  57      		db 	pREQUIRED_OPTS1
   3:     -	3C16          		endm
   4:     -	3C16          		dbpatchmaybe	0xBE4C	,0x1B	,0x0d
   4:     -	3C16  59      		db 	pB_MAYBE_PATCH
   4:     -	3C17  4CBE    		dw 	0xBE4C
   4:     -	3C19  1B0D    		db 	0x1B,0x0d
   4:     -	3C1B          		endm
   5:     -	3C1B          		dbpatchmaybe	0xBE4C+1	,0x45	,0x0d
   5:     -	3C1B  59      		db 	pB_MAYBE_PATCH
   5:     -	3C1C  4DBE    		dw 	0xBE4C+1
   5:     -	3C1E  450D    		db 	0x45,0x0d
   5:     -	3C20          		endm
   6:     -	3C20          		dwpatch	0xE97F+1	,0xE9B6	,MD_READ			
   6:     -	3C20  51      		db 	pW_CHK_PATCH
   6:     -	3C21  80E9    		dw 	0xE97F+1
   6:     -	3C23  B6E93EFA		dw 	0xE9B6,MD_READ
   6:     -	3C27          		endm
   7:     -	3C27          		dwpatch	0xE984+1	,0xEA20	,MD_WRITE
   7:     -	3C27  51      		db 	pW_CHK_PATCH
   7:     -	3C28  85E9    		dw 	0xE984+1
   7:     -	3C2A  20EA53FA		dw 	0xEA20,MD_WRITE
   7:     -	3C2E          		endm
   8:     -	3C2E          		dbpatch	0xEB13	,0xcd	,0x00
   8:     -	3C2E  52      		db 	pB_CHK_PATCH
   8:     -	3C2F  13EB    		dw 	0xEB13
   8:     -	3C31  CD00    		db 	0xcd,0x00
   8:     -	3C33          		endm
   9:     -	3C33          		dwpatch	0xEB13+1	,0xECA9	,0x0000
   9:     -	3C33  51      		db 	pW_CHK_PATCH
   9:     -	3C34  14EB    		dw 	0xEB13+1
   9:     -	3C36  A9EC0000		dw 	0xECA9,0x0000
   9:     -	3C3A          		endm
  10:     -	3C3A          		dwpatch	0xEB16+1	,0xECAE	,MD_READ_INFOSECTOR
  10:     -	3C3A  51      		db 	pW_CHK_PATCH
  10:     -	3C3B  17EB    		dw 	0xEB16+1
  10:     -	3C3D  AEEC68FA		dw 	0xECAE,MD_READ_INFOSECTOR
  10:     -	3C41          		endm
  11:     -	3C41          		dwstore	MD_DRV2+1,	0xEDA4
  11:     -	3C41  54      		db 	pW_STORE
  11:     -	3C42  A4ED    		dw 	0xEDA4
  11:     -	3C44  F3FA    		dw 	MD_DRV2+1
  11:     -	3C46          		endm
  12:     -	3C46          		dwstore	MD_RDBUF2+1,	0xEDAC
  12:     -	3C46  54      		db 	pW_STORE
  12:     -	3C47  ACED    		dw 	0xEDAC
  12:     -	3C49  02FB    		dw 	MD_RDBUF2+1
  12:     -	3C4B          		endm
  13:     -	3C4B          		dwstore	MD_PARAM2+1,	0xED97
  13:     -	3C4B  54      		db 	pW_STORE
  13:     -	3C4C  97ED    		dw 	0xED97
  13:     -	3C4E  1DFA    		dw 	MD_PARAM2+1
  13:     -	3C50          		endm
  14:     -	3C50          		dwpatch 0xc01b+1	 ,0xDDB1	,md_res_seldsk
  14:     -	3C50  51      		db 	pW_CHK_PATCH
  14:     -	3C51  1CC0    		dw 	0xc01b+1
  14:     -	3C53  B1DD0EFA		dw 	0xDDB1,md_res_seldsk
  14:     -	3C57          		endm
  15:     -	3C57          		dwstore md_old_seld_dsk+1,0xDDB1	,0xdd4c
  15:     -	3C57  54      		db 	pW_STORE
  15:     -	3C58  B1DD    		dw 	0xDDB1
  15:     -	3C5A  12FA    		dw 	md_old_seld_dsk+1
  15:     -	3C5C          		endm
  16:					;custom checkers
  17:     -	3C5C          		dwpatch	0xBD80	,0xBD80 ,0xBD80
  17:     -	3C5C  51      		db 	pW_CHK_PATCH
  17:     -	3C5D  80BD    		dw 	0xBD80
  17:     -	3C5F  80BD80BD		dw 	0xBD80,0xBD80
  17:     -	3C63          		endm
  18:     -	3C63          		dwpatch	0xBD82	,0xBE00 ,0xBE00
  18:     -	3C63  51      		db 	pW_CHK_PATCH
  18:     -	3C64  82BD    		dw 	0xBD82
  18:     -	3C66  00BE00BE		dw 	0xBE00,0xBE00
  18:     -	3C6A          		endm
  19:     -	3C6A          		dwpatch	0xc000+1	,0xC495 ,0xC495
  19:     -	3C6A  51      		db 	pW_CHK_PATCH
  19:     -	3C6B  01C0    		dw 	0xc000+1
  19:     -	3C6D  95C495C4		dw 	0xC495,0xC495
  19:     -	3C71          		endm
  20:     -	3C71          		dwpatch	0xc003+1	,0xDC25 ,0xDC25
  20:     -	3C71  51      		db 	pW_CHK_PATCH
  20:     -	3C72  04C0    		dw 	0xc003+1
  20:     -	3C74  25DC25DC		dw 	0xDC25,0xDC25
  20:     -	3C78          		endm
  21:     -	3C78          		dbpatch	0xEACE	,0x21 ,0x21
  21:     -	3C78  52      		db 	pB_CHK_PATCH
  21:     -	3C79  CEEA    		dw 	0xEACE
  21:     -	3C7B  2121    		db 	0x21,0x21
  21:     -	3C7D          		endm
  22:     -	3C7D          		stop 'MICRODOS_OPTS1_871220'
  22:     -	3C7D  50      		db 	p_STOP
  22:     -	3C7E  4D494352		db 	'MICRODOS_OPTS1_871220'
	      4F444F53
	      5F4F5054
	      53315F38
	      37313232
	      30
  22:     -	3C93  00      		db 	0
  22:     -	3C94          		endm
**** out/include-patcher.asm ****
  48:					include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861115.asm"	;  2 images in collection
**** generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861115.asm ****
   1:     -	3C94          	_BIOS_MICRODOS_OPTS1_861115:
   2:     -	3C94          		setMICRODOS
   2:     -	3C94  56      		db 	pSETFLAG_MICRODOS
   2:     -	3C95          		endm
   3:     -	3C95          		RQ_OPTS1
   3:     -	3C95  57      		db 	pREQUIRED_OPTS1
   3:     -	3C96          		endm
   4:     -	3C96          		dbpatchmaybe	0xE693	,0x1B	,0x0d
   4:     -	3C96  59      		db 	pB_MAYBE_PATCH
   4:     -	3C97  93E6    		dw 	0xE693
   4:     -	3C99  1B0D    		db 	0x1B,0x0d
   4:     -	3C9B          		endm
   5:     -	3C9B          		dbpatchmaybe	0xE693+1	,0x45	,0x0d
   5:     -	3C9B  59      		db 	pB_MAYBE_PATCH
   5:     -	3C9C  94E6    		dw 	0xE693+1
   5:     -	3C9E  450D    		db 	0x45,0x0d
   5:     -	3CA0          		endm
   6:     -	3CA0          		dwpatch	0xE497+1	,0xE627	,MD_READ			
   6:     -	3CA0  51      		db 	pW_CHK_PATCH
   6:     -	3CA1  98E4    		dw 	0xE497+1
   6:     -	3CA3  27E63EFA		dw 	0xE627,MD_READ
   6:     -	3CA7          		endm
   7:     -	3CA7          		dwpatch	0xE4A0+1	,0xE62A	,MD_WRITE
   7:     -	3CA7  51      		db 	pW_CHK_PATCH
   7:     -	3CA8  A1E4    		dw 	0xE4A0+1
   7:     -	3CAA  2AE653FA		dw 	0xE62A,MD_WRITE
   7:     -	3CAE          		endm
   8:     -	3CAE          		dbpatch	0xEAAE	,0xcd	,0x00
   8:     -	3CAE  52      		db 	pB_CHK_PATCH
   8:     -	3CAF  AEEA    		dw 	0xEAAE
   8:     -	3CB1  CD00    		db 	0xcd,0x00
   8:     -	3CB3          		endm
   9:     -	3CB3          		dwpatch	0xEAAE+1	,0xE9E9	,0x0000
   9:     -	3CB3  51      		db 	pW_CHK_PATCH
   9:     -	3CB4  AFEA    		dw 	0xEAAE+1
   9:     -	3CB6  E9E90000		dw 	0xE9E9,0x0000
   9:     -	3CBA          		endm
  10:     -	3CBA          		dwpatch	0xEAB4+1	,0xEC5D	,MD_READ_INFOSECTOR
  10:     -	3CBA  51      		db 	pW_CHK_PATCH
  10:     -	3CBB  B5EA    		dw 	0xEAB4+1
  10:     -	3CBD  5DEC68FA		dw 	0xEC5D,MD_READ_INFOSECTOR
  10:     -	3CC1          		endm
  11:     -	3CC1          		dwstore	MD_DRV2+1,	0xDFC8
  11:     -	3CC1  54      		db 	pW_STORE
  11:     -	3CC2  C8DF    		dw 	0xDFC8
  11:     -	3CC4  F3FA    		dw 	MD_DRV2+1
  11:     -	3CC6          		endm
  12:     -	3CC6          		dwstore	MD_RDBUF2+1,	0xEEB0
  12:     -	3CC6  54      		db 	pW_STORE
  12:     -	3CC7  B0EE    		dw 	0xEEB0
  12:     -	3CC9  02FB    		dw 	MD_RDBUF2+1
  12:     -	3CCB          		endm
  13:     -	3CCB          		dwstore	MD_PARAM2+1,	0xDDBC
  13:     -	3CCB  54      		db 	pW_STORE
  13:     -	3CCC  BCDD    		dw 	0xDDBC
  13:     -	3CCE  1DFA    		dw 	MD_PARAM2+1
  13:     -	3CD0          		endm
  14:     -	3CD0          		dwpatch 0xc01b+1	 ,0xDD86	,md_res_seldsk
  14:     -	3CD0  51      		db 	pW_CHK_PATCH
  14:     -	3CD1  1CC0    		dw 	0xc01b+1
  14:     -	3CD3  86DD0EFA		dw 	0xDD86,md_res_seldsk
  14:     -	3CD7          		endm
  15:     -	3CD7          		dwstore md_old_seld_dsk+1,0xDD86	,0xdd4c
  15:     -	3CD7  54      		db 	pW_STORE
  15:     -	3CD8  86DD    		dw 	0xDD86
  15:     -	3CDA  12FA    		dw 	md_old_seld_dsk+1
  15:     -	3CDC          		endm
  16:					;custom checkers
  17:     -	3CDC          		dwpatch	0xBC80	,0xBC80 ,0xBC80
  17:     -	3CDC  51      		db 	pW_CHK_PATCH
  17:     -	3CDD  80BC    		dw 	0xBC80
  17:     -	3CDF  80BC80BC		dw 	0xBC80,0xBC80
  17:     -	3CE3          		endm
  18:     -	3CE3          		dwpatch	0xBC82	,0xBD00 ,0xBD00
  18:     -	3CE3  51      		db 	pW_CHK_PATCH
  18:     -	3CE4  82BC    		dw 	0xBC82
  18:     -	3CE6  00BD00BD		dw 	0xBD00,0xBD00
  18:     -	3CEA          		endm
  19:     -	3CEA          		dwpatch	0xc000+1	,0xC4BF ,0xC4BF
  19:     -	3CEA  51      		db 	pW_CHK_PATCH
  19:     -	3CEB  01C0    		dw 	0xc000+1
  19:     -	3CED  BFC4BFC4		dw 	0xC4BF,0xC4BF
  19:     -	3CF1          		endm
  20:     -	3CF1          		dwpatch	0xc003+1	,0xDBFB ,0xDBFB
  20:     -	3CF1  51      		db 	pW_CHK_PATCH
  20:     -	3CF2  04C0    		dw 	0xc003+1
  20:     -	3CF4  FBDBFBDB		dw 	0xDBFB,0xDBFB
  20:     -	3CF8          		endm
  21:     -	3CF8          		dbpatch	0xDF95	,0x40 ,0x40
  21:     -	3CF8  52      		db 	pB_CHK_PATCH
  21:     -	3CF9  95DF    		dw 	0xDF95
  21:     -	3CFB  4040    		db 	0x40,0x40
  21:     -	3CFD          		endm
  22:     -	3CFD          		dbpatch	0xDF97	,0x10 ,0x10
  22:     -	3CFD  52      		db 	pB_CHK_PATCH
  22:     -	3CFE  97DF    		dw 	0xDF97
  22:     -	3D00  1010    		db 	0x10,0x10
  22:     -	3D02          		endm
  23:     -	3D02          		stop 'MICRODOS_OPTS1_861115'
  23:     -	3D02  50      		db 	p_STOP
  23:     -	3D03  4D494352		db 	'MICRODOS_OPTS1_861115'
	      4F444F53
	      5F4F5054
	      53315F38
	      36313131
	      35
  23:     -	3D18  00      		db 	0
  23:     -	3D19          		endm
**** out/include-patcher.asm ****
  49:					include "generator/V0/out/patcher-unsopported-CPM_NET_SFERA1.asm"	;  2 images in collection
**** generator/V0/out/patcher-unsopported-CPM_NET_SFERA1.asm ****
   1:     -	3D19          	_BIOS_CPM_NET_SFERA1:
   2:     -	3D19          		setUNSUPPORTED
   2:     -	3D19  55      		db 	pNotSupported
   2:     -	3D1A          		endm
   3:					;custom checkers
   4:     -	3D1A          		dwpatch	0xC380  	,0xC380  ,0xC380 
   4:     -	3D1A  51      		db 	pW_CHK_PATCH
   4:     -	3D1B  80C3    		dw 	0xC380
   4:     -	3D1D  80C380C3		dw 	0xC380,0xC380
   4:     -	3D21          		endm
   5:     -	3D21          		dwpatch	0xC382  	,0xDa00 ,0xDa00
   5:     -	3D21  51      		db 	pW_CHK_PATCH
   5:     -	3D22  82C3    		dw 	0xC382
   5:     -	3D24  00DA00DA		dw 	0xDa00,0xDa00
   5:     -	3D28          		endm
   6:     -	3D28          		dwpatch	0xC384  	,0x000A ,0x000A
   6:     -	3D28  51      		db 	pW_CHK_PATCH
   6:     -	3D29  84C3    		dw 	0xC384
   6:     -	3D2B  0A000A00		dw 	0x000A,0x000A
   6:     -	3D2F          		endm
   7:     -	3D2F          		dwpatch	0xDB5C+1	,0xDAC3 ,0xDAC3
   7:     -	3D2F  51      		db 	pW_CHK_PATCH
   7:     -	3D30  5DDB    		dw 	0xDB5C+1
   7:     -	3D32  C3DAC3DA		dw 	0xDAC3,0xDAC3
   7:     -	3D36          		endm
   8:     -	3D36          		dwpatch	0xDA03+1	,0xDB6E ,0xDB6E
   8:     -	3D36  51      		db 	pW_CHK_PATCH
   8:     -	3D37  04DA    		dw 	0xDA03+1
   8:     -	3D39  6EDB6EDB		dw 	0xDB6E,0xDB6E
   8:     -	3D3D          		endm
   9:     -	3D3D          		dwpatch	0xDA27+1	,0xDED4 ,0xDED4
   9:     -	3D3D  51      		db 	pW_CHK_PATCH
   9:     -	3D3E  28DA    		dw 	0xDA27+1
   9:     -	3D40  D4DED4DE		dw 	0xDED4,0xDED4
   9:     -	3D44          		endm
  10:     -	3D44          		dwpatch	0xDA2A+1	,0xE193 ,0xE193
  10:     -	3D44  51      		db 	pW_CHK_PATCH
  10:     -	3D45  2BDA    		dw 	0xDA2A+1
  10:     -	3D47  93E193E1		dw 	0xE193,0xE193
  10:     -	3D4B          		endm
  11:     -	3D4B          		dwpatch	0xDA3C+1	,0xDD06 ,0xDD06
  11:     -	3D4B  51      		db 	pW_CHK_PATCH
  11:     -	3D4C  3DDA    		dw 	0xDA3C+1
  11:     -	3D4E  06DD06DD		dw 	0xDD06,0xDD06
  11:     -	3D52          		endm
  12:     -	3D52          		stop 'CPM_NET_SFERA1'
  12:     -	3D52  50      		db 	p_STOP
  12:     -	3D53  43504D5F		db 	'CPM_NET_SFERA1'
	      4E45545F
	      53464552
	      4131
  12:     -	3D61  00      		db 	0
  12:     -	3D62          		endm
**** out/include-patcher.asm ****
  50:					include "generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_b.asm"	;  2 images in collection
**** generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_b.asm ****
   1:     -	3D62          	_BIOS_CPM_NET_KORNET_drive_b:
   2:     -	3D62          		setUNSUPPORTED
   2:     -	3D62  55      		db 	pNotSupported
   2:     -	3D63          		endm
   3:					;custom checkers
   4:     -	3D63          		dwpatch	0x8000  	,0x00EE  ,0x00EE 
   4:     -	3D63  51      		db 	pW_CHK_PATCH
   4:     -	3D64  0080    		dw 	0x8000
   4:     -	3D66  EE00EE00		dw 	0x00EE,0x00EE
   4:     -	3D6A          		endm
   5:     -	3D6A          		dwpatch	0x8000+2	,0x0000 ,0x0000
   5:     -	3D6A  51      		db 	pW_CHK_PATCH
   5:     -	3D6B  0280    		dw 	0x8000+2
   5:     -	3D6D  00000000		dw 	0x0000,0x0000
   5:     -	3D71          		endm
   6:     -	3D71          		dwpatch	0x8000+4	,0x000E ,0x000E
   6:     -	3D71  51      		db 	pW_CHK_PATCH
   6:     -	3D72  0480    		dw 	0x8000+4
   6:     -	3D74  0E000E00		dw 	0x000E,0x000E
   6:     -	3D78          		endm
   7:     -	3D78          		stop 'CPM_NET_KORNET_drive_b'
   7:     -	3D78  50      		db 	p_STOP
   7:     -	3D79  43504D5F		db 	'CPM_NET_KORNET_drive_b'
	      4E45545F
	      4B4F524E
	      45545F64
	      72697665
	      5F62
   7:     -	3D8F  00      		db 	0
   7:     -	3D90          		endm
**** out/include-patcher.asm ****
  51:					include "generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_a.asm"	;  2 images in collection
**** generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_a.asm ****
   1:     -	3D90          	_BIOS_CPM_NET_KORNET_drive_a:
   2:     -	3D90          		setUNSUPPORTED
   2:     -	3D90  55      		db 	pNotSupported
   2:     -	3D91          		endm
   3:					;custom checkers
   4:     -	3D91          		dwpatch	0xDB59+1	,0xDAAA ,0xDAAA
   4:     -	3D91  51      		db 	pW_CHK_PATCH
   4:     -	3D92  5ADB    		dw 	0xDB59+1
   4:     -	3D94  AADAAADA		dw 	0xDAAA,0xDAAA
   4:     -	3D98          		endm
   5:     -	3D98          		dwpatch	0xD980	,0xD980 ,0xD980
   5:     -	3D98  51      		db 	pW_CHK_PATCH
   5:     -	3D99  80D9    		dw 	0xD980
   5:     -	3D9B  80D980D9		dw 	0xD980,0xD980
   5:     -	3D9F          		endm
   6:     -	3D9F          		dwpatch	0xD982	,0xDa00 ,0xDa00
   6:     -	3D9F  51      		db 	pW_CHK_PATCH
   6:     -	3DA0  82D9    		dw 	0xD982
   6:     -	3DA2  00DA00DA		dw 	0xDa00,0xDa00
   6:     -	3DA6          		endm
   7:     -	3DA6          		dwpatch	0xD984	,0x0006 ,0x0006
   7:     -	3DA6  51      		db 	pW_CHK_PATCH
   7:     -	3DA7  84D9    		dw 	0xD984
   7:     -	3DA9  06000600		dw 	0x0006,0x0006
   7:     -	3DAD          		endm
   8:     -	3DAD          		dwpatch	0xDA03+1	,0xDBA1 ,0xDBA1
   8:     -	3DAD  51      		db 	pW_CHK_PATCH
   8:     -	3DAE  04DA    		dw 	0xDA03+1
   8:     -	3DB0  A1DBA1DB		dw 	0xDBA1,0xDBA1
   8:     -	3DB4          		endm
   9:     -	3DB4          		dwpatch	0xDA27+1	,0xDEB0 ,0xDEB0
   9:     -	3DB4  51      		db 	pW_CHK_PATCH
   9:     -	3DB5  28DA    		dw 	0xDA27+1
   9:     -	3DB7  B0DEB0DE		dw 	0xDEB0,0xDEB0
   9:     -	3DBB          		endm
  10:     -	3DBB          		dwpatch	0xDA2A+1	,0xE19A ,0xE19A
  10:     -	3DBB  51      		db 	pW_CHK_PATCH
  10:     -	3DBC  2BDA    		dw 	0xDA2A+1
  10:     -	3DBE  9AE19AE1		dw 	0xE19A,0xE19A
  10:     -	3DC2          		endm
  11:     -	3DC2          		dwpatch	0xDA33+1	,0xDFC8 ,0xDFC8
  11:     -	3DC2  51      		db 	pW_CHK_PATCH
  11:     -	3DC3  34DA    		dw 	0xDA33+1
  11:     -	3DC5  C8DFC8DF		dw 	0xDFC8,0xDFC8
  11:     -	3DC9          		endm
  12:     -	3DC9          		stop 'CPM_NET_KORNET_drive_a'
  12:     -	3DC9  50      		db 	p_STOP
  12:     -	3DCA  43504D5F		db 	'CPM_NET_KORNET_drive_a'
	      4E45545F
	      4B4F524E
	      45545F64
	      72697665
	      5F61
  12:     -	3DE0  00      		db 	0
  12:     -	3DE1          		endm
**** out/include-patcher.asm ****
  52:					include "generator/V0/out/patcher-cpm2-CPM_1x_88_EPSON_V104.asm"	;  1 images in collection
**** generator/V0/out/patcher-cpm2-CPM_1x_88_EPSON_V104.asm ****
   1:     -	3DE1          	_BIOS_CPM_1x_88_EPSON_V104:
   2:     -	3DE1          		setSUBBIOS 2
   2:     -	3DE1  5A      		db	pSubBios
   2:     -	3DE2  02      		db 	2
   2:     -	3DE3          		endm
   3:     -	3DE3          		RQ_OPTS1
   3:     -	3DE3  57      		db 	pREQUIRED_OPTS1
   3:     -	3DE4          		endm
   4:     -	3DE4          		setCPM
   4:     -	3DE4          		endm
   5:     -	3DE4          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	3DE4  59      		db 	pB_MAYBE_PATCH
   5:     -	3DE5  EEDA    		dw 	0xDAEE
   5:     -	3DE7  1F0D    		db 	0x1F,0x0d
   5:     -	3DE9          		endm
   6:     -	3DE9          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	3DE9  59      		db 	pB_MAYBE_PATCH
   6:     -	3DEA  F0DA    		dw 	0xDAEE+2
   6:     -	3DEC  0A0D    		db 	0x0a,0x0d
   6:     -	3DEE          		endm
   7:     -	3DEE          		dbpatch	0xE8B7+1	,0x49	,0xc9
   7:     -	3DEE  52      		db 	pB_CHK_PATCH
   7:     -	3DEF  B8E8    		dw 	0xE8B7+1
   7:     -	3DF1  49C9    		db 	0x49,0xc9
   7:     -	3DF3          		endm
   8:     -	3DF3          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	3DF3  52      		db 	pB_CHK_PATCH
   8:     -	3DF4  88DA    		dw 	0xDA88
   8:     -	3DF6  0100    		db 	0x01,0x00
   8:     -	3DF8          		endm
   9:     -	3DF8          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	3DF8  52      		db 	pB_CHK_PATCH
   9:     -	3DF9  9FDA    		dw 	0xDA9F
   9:     -	3DFB  0200    		db 	0x02,0x00
   9:     -	3DFD          		endm
  10:     -	3DFD          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	3DFD  52      		db 	pB_CHK_PATCH
  10:     -	3DFE  B6DA    		dw 	0xDAB6
  10:     -	3E00  0401    		db 	0x04,0x01
  10:     -	3E02          		endm
  11:     -	3E02          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	3E02  52      		db 	pB_CHK_PATCH
  11:     -	3E03  CDDA    		dw 	0xDACD
  11:     -	3E05  0802    		db 	0x08,0x02
  11:     -	3E07          		endm
  12:     -	3E07          		dwstore	_CPM2_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	3E07  54      		db 	pW_STORE
  12:     -	3E08  88DA    		dw 	0xDA88
  12:     -	3E0A  06EA    		dw 	_CPM2_res_DRIVE_TAB+0*2
  12:     -	3E0C          		endm
  13:     -	3E0C          		dwstore	_CPM2_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	3E0C  54      		db 	pW_STORE
  13:     -	3E0D  9FDA    		dw 	0xDA9F
  13:     -	3E0F  08EA    		dw 	_CPM2_res_DRIVE_TAB+1*2
  13:     -	3E11          		endm
  14:     -	3E11          		dwstore	_CPM2_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	3E11  54      		db 	pW_STORE
  14:     -	3E12  B6DA    		dw 	0xDAB6
  14:     -	3E14  0AEA    		dw 	_CPM2_res_DRIVE_TAB+2*2
  14:     -	3E16          		endm
  15:     -	3E16          		dwstore	_CPM2_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	3E16  54      		db 	pW_STORE
  15:     -	3E17  CDDA    		dw 	0xDACD
  15:     -	3E19  0CEA    		dw 	_CPM2_res_DRIVE_TAB+3*2
  15:     -	3E1B          		endm
  16:     -	3E1B          		dwpatch 0xDEC6+5*2 	,0x0000 ,_CPM2_dph_F
  16:     -	3E1B  51      		db 	pW_CHK_PATCH
  16:     -	3E1C  D0DE    		dw 	0xDEC6+5*2
  16:     -	3E1E  000012EA		dw 	0x0000,_CPM2_dph_F
  16:     -	3E22          		endm
  17:     -	3E22          		dwstore _CPM2_dph_F+8	,0xE1AB
  17:     -	3E22  54      		db 	pW_STORE
  17:     -	3E23  ABE1    		dw 	0xE1AB
  17:     -	3E25  1AEA    		dw 	_CPM2_dph_F+8
  17:     -	3E27          		endm
  18:     -	3E27          		dwpatch 0xDA1B+1 	,0xDE82	,_CPM2_res_seldsk
  18:     -	3E27  51      		db 	pW_CHK_PATCH
  18:     -	3E28  1CDA    		dw 	0xDA1B+1
  18:     -	3E2A  82DE6BEA		dw 	0xDE82,_CPM2_res_seldsk
  18:     -	3E2E          		endm
  19:     -	3E2E          		dwstore	_CPM2_old_seld_dsk+1	,0xDE82
  19:     -	3E2E  54      		db 	pW_STORE
  19:     -	3E2F  82DE    		dw 	0xDE82
  19:     -	3E31  6FEA    		dw 	_CPM2_old_seld_dsk+1
  19:     -	3E33          		endm
  20:     -	3E33          		dbpatch	0xE6DE	,0x77	,0x00
  20:     -	3E33  52      		db 	pB_CHK_PATCH
  20:     -	3E34  DEE6    		dw 	0xE6DE
  20:     -	3E36  7700    		db 	0x77,0x00
  20:     -	3E38          		endm
  21:     -	3E38          		dwstore	_CPM2_r_p_SELDSKDRIVER+1	,0xE199
  21:     -	3E38  54      		db 	pW_STORE
  21:     -	3E39  99E1    		dw 	0xE199
  21:     -	3E3B  88EA    		dw 	_CPM2_r_p_SELDSKDRIVER+1
  21:     -	3E3D          		endm
  22:     -	3E3D          		dwstore	_CPM2_r_p_SELDSKDRIVEW+1	,0xE199
  22:     -	3E3D  54      		db 	pW_STORE
  22:     -	3E3E  99E1    		dw 	0xE199
  22:     -	3E40  C5EA    		dw 	_CPM2_r_p_SELDSKDRIVEW+1
  22:     -	3E42          		endm
  23:     -	3E42          		dwpatch	0xDA27+1	,0xDEE5	,_CPM2_res_READ
  23:     -	3E42  51      		db 	pW_CHK_PATCH
  23:     -	3E43  28DA    		dw 	0xDA27+1
  23:     -	3E45  E5DE75EA		dw 	0xDEE5,_CPM2_res_READ
  23:     -	3E49          		endm
  24:     -	3E49          		dwpatch	0xDA2A+1	,0xE01B	,_CPM2_res_WRITE
  24:     -	3E49  51      		db 	pW_CHK_PATCH
  24:     -	3E4A  2BDA    		dw 	0xDA2A+1
  24:     -	3E4C  1BE0B2EA		dw 	0xE01B,_CPM2_res_WRITE
  24:     -	3E50          		endm
  25:     -	3E50          		dwpatch	0xDBC2+1	,0xDEE5	,_CPM2_res_READ
  25:     -	3E50  51      		db 	pW_CHK_PATCH
  25:     -	3E51  C3DB    		dw 	0xDBC2+1
  25:     -	3E53  E5DE75EA		dw 	0xDEE5,_CPM2_res_READ
  25:     -	3E57          		endm
  26:     -	3E57          		dwpatch	0xdeb4+1	,0xE614	,_CPM2_res_GETINFO
  26:     -	3E57  51      		db 	pW_CHK_PATCH
  26:     -	3E58  B5DE    		dw 	0xdeb4+1
  26:     -	3E5A  14E6EFEA		dw 	0xE614,_CPM2_res_GETINFO
  26:     -	3E5E          		endm
  27:     -	3E5E          		dwstore	_CPM2__old_read+1	,0xDEE5
  27:     -	3E5E  54      		db 	pW_STORE
  27:     -	3E5F  E5DE    		dw 	0xDEE5
  27:     -	3E61  B0EA    		dw 	_CPM2__old_read+1
  27:     -	3E63          		endm
  28:     -	3E63          		dwstore	_CPM2__old_write+1	,0xE01B
  28:     -	3E63  54      		db 	pW_STORE
  28:     -	3E64  1BE0    		dw 	0xE01B
  28:     -	3E66  EDEA    		dw 	_CPM2__old_write+1
  28:     -	3E68          		endm
  29:     -	3E68          		dwstore	_CPM2__old_getinfo+1	,0xE614
  29:     -	3E68  54      		db 	pW_STORE
  29:     -	3E69  14E6    		dw 	0xE614
  29:     -	3E6B  FDEA    		dw 	_CPM2__old_getinfo+1
  29:     -	3E6D          		endm
  30:     -	3E6D          		dbpatch	0xE654		,0x21	,0x21
  30:     -	3E6D  52      		db 	pB_CHK_PATCH
  30:     -	3E6E  54E6    		dw 	0xE654
  30:     -	3E70  2121    		db 	0x21,0x21
  30:     -	3E72          		endm
  31:     -	3E72          		dwpatch	0xE654+1 	,0xE684	,0xE684
  31:     -	3E72  51      		db 	pW_CHK_PATCH
  31:     -	3E73  55E6    		dw 	0xE654+1
  31:     -	3E75  84E684E6		dw 	0xE684,0xE684
  31:     -	3E79          		endm
  32:     -	3E79          		dwstore	_CPM2__old_getinfo_chkdo+1	,0xE654
  32:     -	3E79  54      		db 	pW_STORE
  32:     -	3E7A  54E6    		dw 	0xE654
  32:     -	3E7C  FAEA    		dw 	_CPM2__old_getinfo_chkdo+1
  32:     -	3E7E          		endm
  33:     -	3E7E          		dwstore	_CPM2_r_p_DSK1+1	,0xE18F 	;read
  33:     -	3E7E  54      		db 	pW_STORE
  33:     -	3E7F  8FE1    		dw 	0xE18F
  33:     -	3E81  76EA    		dw 	_CPM2_r_p_DSK1+1
  33:     -	3E83          		endm
  34:     -	3E83          		dwstore	_CPM2_r_p_TRK1+1	,0xE193 	
  34:     -	3E83  54      		db 	pW_STORE
  34:     -	3E84  93E1    		dw 	0xE193
  34:     -	3E86  91EA    		dw 	_CPM2_r_p_TRK1+1
  34:     -	3E88          		endm
  35:     -	3E88          		dwstore	_CPM2_r_p_SEC1+1	,0xE194 	
  35:     -	3E88  54      		db 	pW_STORE
  35:     -	3E89  94E1    		dw 	0xE194
  35:     -	3E8B  97EA    		dw 	_CPM2_r_p_SEC1+1
  35:     -	3E8D          		endm
  36:     -	3E8D          		dwstore	_CPM2_r_p_DMA1+1	,0xE195 	
  36:     -	3E8D  54      		db 	pW_STORE
  36:     -	3E8E  95E1    		dw 	0xE195
  36:     -	3E90  A8EA    		dw 	_CPM2_r_p_DMA1+1
  36:     -	3E92          		endm
  37:     -	3E92          		dwstore	_CPM2_r_p_DSK2+1	,0xE18F 	;write
  37:     -	3E92  54      		db 	pW_STORE
  37:     -	3E93  8FE1    		dw 	0xE18F
  37:     -	3E95  B3EA    		dw 	_CPM2_r_p_DSK2+1
  37:     -	3E97          		endm
  38:     -	3E97          		dwstore	_CPM2_r_p_TRK2+1	,0xE193 	
  38:     -	3E97  54      		db 	pW_STORE
  38:     -	3E98  93E1    		dw 	0xE193
  38:     -	3E9A  CEEA    		dw 	_CPM2_r_p_TRK2+1
  38:     -	3E9C          		endm
  39:     -	3E9C          		dwstore	_CPM2_r_p_SEC2+1	,0xE194 	
  39:     -	3E9C  54      		db 	pW_STORE
  39:     -	3E9D  94E1    		dw 	0xE194
  39:     -	3E9F  D4EA    		dw 	_CPM2_r_p_SEC2+1
  39:     -	3EA1          		endm
  40:     -	3EA1          		dwstore	_CPM2_r_p_DMA2+1	,0xE195 	
  40:     -	3EA1  54      		db 	pW_STORE
  40:     -	3EA2  95E1    		dw 	0xE195
  40:     -	3EA4  E5EA    		dw 	_CPM2_r_p_DMA2+1
  40:     -	3EA6          		endm
  41:     -	3EA6          		dwstore	_CPM2_r_p_DSK3+1	,0xE18F 	;readinfo
  41:     -	3EA6  54      		db 	pW_STORE
  41:     -	3EA7  8FE1    		dw 	0xE18F
  41:     -	3EA9  82EB    		dw 	_CPM2_r_p_DSK3+1
  41:     -	3EAB          		endm
  42:				
  43:     -	3EAB          		stop 'CPM_1x_88_EPSON_V104'
  43:     -	3EAB  50      		db 	p_STOP
  43:     -	3EAC  43504D5F		db 	'CPM_1x_88_EPSON_V104'
	      31785F38
	      385F4550
	      534F4E5F
	      56313034
  43:     -	3EC0  00      		db 	0
  43:     -	3EC1          		endm
**** out/include-patcher.asm ****
  53:					include "generator/V0/out/patcher-unsopported-CPM_NET_SFERA2.asm"	;  1 images in collection
**** generator/V0/out/patcher-unsopported-CPM_NET_SFERA2.asm ****
   1:     -	3EC1          	_BIOS_CPM_NET_SFERA2:
   2:     -	3EC1          		setUNSUPPORTED
   2:     -	3EC1  55      		db 	pNotSupported
   2:     -	3EC2          		endm
   3:					;custom checkers
   4:     -	3EC2          		dwpatch	0xC380  	,0xC380  ,0xC380 
   4:     -	3EC2  51      		db 	pW_CHK_PATCH
   4:     -	3EC3  80C3    		dw 	0xC380
   4:     -	3EC5  80C380C3		dw 	0xC380,0xC380
   4:     -	3EC9          		endm
   5:     -	3EC9          		dwpatch	0xC382  	,0xDa00 ,0xDa00
   5:     -	3EC9  51      		db 	pW_CHK_PATCH
   5:     -	3ECA  82C3    		dw 	0xC382
   5:     -	3ECC  00DA00DA		dw 	0xDa00,0xDa00
   5:     -	3ED0          		endm
   6:     -	3ED0          		dwpatch	0xC384  	,0x000A ,0x000A
   6:     -	3ED0  51      		db 	pW_CHK_PATCH
   6:     -	3ED1  84C3    		dw 	0xC384
   6:     -	3ED3  0A000A00		dw 	0x000A,0x000A
   6:     -	3ED7          		endm
   7:     -	3ED7          		dwpatch	0xDB5C+1	,0xDAC3 ,0xDAC3
   7:     -	3ED7  51      		db 	pW_CHK_PATCH
   7:     -	3ED8  5DDB    		dw 	0xDB5C+1
   7:     -	3EDA  C3DAC3DA		dw 	0xDAC3,0xDAC3
   7:     -	3EDE          		endm
   8:     -	3EDE          		dwpatch	0xDA03+1	,0xDB6E ,0xDB6E
   8:     -	3EDE  51      		db 	pW_CHK_PATCH
   8:     -	3EDF  04DA    		dw 	0xDA03+1
   8:     -	3EE1  6EDB6EDB		dw 	0xDB6E,0xDB6E
   8:     -	3EE5          		endm
   9:     -	3EE5          		dwpatch	0xDA27+1	,0xDED0 ,0xDED0
   9:     -	3EE5  51      		db 	pW_CHK_PATCH
   9:     -	3EE6  28DA    		dw 	0xDA27+1
   9:     -	3EE8  D0DED0DE		dw 	0xDED0,0xDED0
   9:     -	3EEC          		endm
  10:     -	3EEC          		dwpatch	0xDA2A+1	,0xE18F ,0xE18F
  10:     -	3EEC  51      		db 	pW_CHK_PATCH
  10:     -	3EED  2BDA    		dw 	0xDA2A+1
  10:     -	3EEF  8FE18FE1		dw 	0xE18F,0xE18F
  10:     -	3EF3          		endm
  11:     -	3EF3          		dwpatch	0xDA3C+1	,0xDD02 ,0xDD02
  11:     -	3EF3  51      		db 	pW_CHK_PATCH
  11:     -	3EF4  3DDA    		dw 	0xDA3C+1
  11:     -	3EF6  02DD02DD		dw 	0xDD02,0xDD02
  11:     -	3EFA          		endm
  12:     -	3EFA          		stop 'CPM_NET_SFERA2'
  12:     -	3EFA  50      		db 	p_STOP
  12:     -	3EFB  43504D5F		db 	'CPM_NET_SFERA2'
	      4E45545F
	      53464552
	      4132
  12:     -	3F09  00      		db 	0
  12:     -	3F0A          		endm
**** out/include-patcher.asm ****
  54:     -	3F0A  FF      		db 0xff
**** generator/V0/extrom-patcher.asm ****
 740:				
**** stage2.asm ****
 639:					
 640:				
 641:				
 642:				; Округляем размер всей секции до ближайших 256 байт вверх	
 643:     -	3F0B .. 3FFF 00	        DS      ((($>>8)+1)<<8)-$,0
 644:     -	4000          	FTOP	EQU	$			; верхний адрес памяти, занимаемый загружаемым блоком
 645:				;--------------------------------------------------------------------------
 646:				; Конец загружаемой области
 647:				; Далее идет область рабочих данных, не входящая в тело файла загрузчика
 648:				;--------------------------------------------------------------------------
 649:				
 650:				; Буфер сектора
 651:     -	4000          	SECBUF	EQU	$
 652:     -	4080          		ORG	$+128	; буфер 128 байт, DS использовать нельзя, чтобы не порождать объектный код
 653:				
 654:     -	4080          	loader	END 	



Statistics:

     4	passes
     0	jr promotions
   377	symbols
  8153	bytes

   705	macro calls
 13170	macro bytes
     0	invented symbols



Symbol Table:

.badbootparam   2192     
.chkm           2078     
.cpfddname      2949     
.cpmnoresident  26be     
.cpmremapcd     26e6     
.cpmsubbios1    269a     
.cpmsubbios2    26ac     
.endfill        2a1d     
.fillloop       2a15     
.found_cont     2594     
.inilut         221f     
.inilutgrp      2227     
.noprintkey     20a5     
.phalt          2827     
.physical_drive 291b     
.pnotsupported  27bc     
.prequired_opts1 27e5     
.prequired_opts2 27fe     
.print          2044     
.printkey       205e     
.psetflag_microdos 27cb     
.psubbios       27d8     
.putnospc       2471     
.rom_found      254a     
.romcrc         2525     
.rw             2977     
.setgzusize     2502     
.skipappend     29e6     
.skiplp         2a09     
.subbiosldir    26bb     
.zgu192k        2500     
_bios_cpm_12_87_09_niijaf 3b36     
_bios_cpm_12_87_11_niijaf 397a     
_bios_cpm_12_88_3_alternativa 2f9c     
_bios_cpm_12_88_3_niijaf 308a     
_bios_cpm_12_90_5_kontur 3819     
_bios_cpm_1x_88_epson_v104 3de1     
_bios_cpm_1x_89_03_30_ravi 34ff     
_bios_cpm_20_88___miks 373e     
_bios_cpm_21_89_2_niijaf 33a7     
_bios_cpm_21_89_2_niijaf2 32c9     
_bios_cpm_21_89___wiza 3167     
_bios_cpm_21_91___lap 3664     
_bios_cpm_21_extrom 2f5c     
_bios_cpm_21m_____shkanov 3a58     
_bios_cpm_net_kornet_drive_a 3d90     
_bios_cpm_net_kornet_drive_b 3d62     
_bios_cpm_net_sfera1 3d19     
_bios_cpm_net_sfera2 3ec1     
_bios_microdos_opts1_861011 35df     
_bios_microdos_opts1_861115 3c94     
_bios_microdos_opts1_870430 3484     
_bios_microdos_opts1_871220 3c14     
_bios_microdos_opts2_880630 3249     
_bios_microdos_opts2_900105 38f6     
_cpm1_.r_no_drv_dec e929     
_cpm1_.w_no_drv_dec e966     
_cpm1__old_getinfo e9a2     
_cpm1__old_getinfo_chkdo e99f     
_cpm1__old_read e955     
_cpm1__old_write e992     
_cpm1_alw_f     e8df     
_cpm1_dpb_f     e8d0     
_cpm1_dph_f     e8b8     
_cpm1_exr_cmd   ea3f     
_cpm1_exr_drv   ea40     
_cpm1_exr_getbyte e9a5     
_cpm1_exr_getsec e9c5     
_cpm1_exr_putbyte e9b4     
_cpm1_exr_putsec e9e0     
_cpm1_exr_readinfo ea21     
_cpm1_exr_sec   ea42     
_cpm1_exr_sendcmd e9fb     
_cpm1_exr_trk   ea41     
_cpm1_old_seld_dsk e914     
_cpm1_pgsl      e9ce     
_cpm1_ppsl      e9e9     
_cpm1_pscl      ea0a     
_cpm1_pwg       e9a9     
_cpm1_pwp       e9b9     
_cpm1_r_p_dma1  e94d     
_cpm1_r_p_dma2  e98a     
_cpm1_r_p_dsk1  e91b     
_cpm1_r_p_dsk2  e958     
_cpm1_r_p_dsk3  ea27     
_cpm1_r_p_sec1  e93c     
_cpm1_r_p_sec2  e979     
_cpm1_r_p_seldskdriver e92d     
_cpm1_r_p_seldskdrivew e96a     
_cpm1_r_p_trk1  e936     
_cpm1_r_p_trk2  e973     
_cpm1_res_drive_tab e8ac     
_cpm1_res_getinfo e995     
_cpm1_res_read  e91b     
_cpm1_res_seldsk e911     
_cpm1_res_write e958     
_cpm2_.r_no_drv_dec ea83     
_cpm2_.w_no_drv_dec eac0     
_cpm2__old_getinfo eafc     
_cpm2__old_getinfo_chkdo eaf9     
_cpm2__old_read eaaf     
_cpm2__old_write eaec     
_cpm2_alw_f     ea39     
_cpm2_dpb_f     ea2a     
_cpm2_dph_f     ea12     
_cpm2_exr_cmd   eb99     
_cpm2_exr_drv   eb9a     
_cpm2_exr_getbyte eaff     
_cpm2_exr_getsec eb1f     
_cpm2_exr_putbyte eb0e     
_cpm2_exr_putsec eb3a     
_cpm2_exr_readinfo eb7b     
_cpm2_exr_sec   eb9c     
_cpm2_exr_sendcmd eb55     
_cpm2_exr_trk   eb9b     
_cpm2_old_seld_dsk ea6e     
_cpm2_pgsl      eb28     
_cpm2_ppsl      eb43     
_cpm2_pscl      eb64     
_cpm2_pwg       eb03     
_cpm2_pwp       eb13     
_cpm2_r_p_dma1  eaa7     
_cpm2_r_p_dma2  eae4     
_cpm2_r_p_dsk1  ea75     
_cpm2_r_p_dsk2  eab2     
_cpm2_r_p_dsk3  eb81     
_cpm2_r_p_sec1  ea96     
_cpm2_r_p_sec2  ead3     
_cpm2_r_p_seldskdriver ea87     
_cpm2_r_p_seldskdrivew eac4     
_cpm2_r_p_trk1  ea90     
_cpm2_r_p_trk2  eacd     
_cpm2_res_drive_tab ea06     
_cpm2_res_getinfo eaef     
_cpm2_res_read  ea75     
_cpm2_res_seldsk ea6b     
_cpm2_res_write eab2     
_dma           =ffff     
_dsk           =ffff     
_hw_gzu_size_192k=   2     
_hw_gzu_size_48k=   1     
_hw_rom_model_kvant8=   3     
_hw_rom_model_opts11=   1     
_hw_rom_model_opts20=   2     
_hw_rom_opts1  =   1     
_hw_rom_opts2  =   2     
_oper          =ffff     
_p_ldir         28cb     
_rrbuff        =ee00     
_sec           =ffff     
_trk           =ffff     
api_get_mount_name=  80     
api_get_mount_status=  82     
append_z        29e0     
available_resident_cpm1_len= 163     
available_resident_cpm2_len= 260     
b_chk_maybe     275c     
b_chk_patch     2739     
base           =2000     
bios_found      2585     
bios_not_found  257c     
bios_variants   2f1c     
build_disk_name 295f     
build_emu_name  29bd     
checkbootparams 216b     
chk_bios_lp     2567     
cmd             22e3     
conin          =  49     
copy_z          29f3     
cp_de_bc        28a3     
cpm_bios_patcher 2553     
debug_trace_patcher=   0     
do_patch        2729     
drive_rw_status 2a7e     
drivetab_mount_info 2a36     
drv             22e4     
errzerodrvinfotab 29a0     
fdd_found       2942     
fetch_db_to_b   28c8     
fetch_dw_to_bc  28c6     
fetchdefromhl   2282     
fix_width       2a04     
flag_microdos   25b9     
flag_subbios    25ba     
flag_unsupported 25b8     
force_default_bios 202a     
force_subst     2030     
ftop           =4000     
get_drvinfo_ptr 2988     
get_lp          2a2c     
get_mount_info  2a1f     
getbyte         222e     
getch           22d7     
getsec          22a7     
gsl             22af     
h1d             2259     
hcrlf           235c     
hex1            224e     
hex2            225d     
hex4            226c     
hexw            2277     
hl_after_do_patch_patch 2727     
hmbase          2329     
hmls            2351     
hmps            2337     
hmrun           232f     
hmsg            22ee     
hmsp            234a     
hmss            2342     
hw_check_floppy 24b9     
hw_check_gzu_size 24cc     
hw_check_rom    251f     
hw_fdc_present  23e8     
hw_fdd_drive_a  23e9     
hw_fdd_drive_b  23ea     
hw_fdd_drive_c  23eb     
hw_fdd_drive_d  23ec     
hw_gzu_size     23e7     
hw_rom_model    23e6     
hw_rom_opts_class 23e5     
hw_test         24ac     
il              20d4     
initlut         221a     
l_pw_chk        277a     
l_pw_store      279f     
ld_loop         2136     
ld_loop_sec0    2132     
load_done       2164     
loader          4080     
loadr           22e7     
lspt            22ed     
max_resident_cpm1_len= 2fa     
max_resident_cpm2_len= 3f7     
md_dma          fb0e     
md_drv2         faf2     
md_exr_cmd      fb0a     
md_exr_drv      fb0b     
md_exr_getbyte  fa6d     
md_exr_getsec   fa8d     
md_exr_putbyte  fa7c     
md_exr_putsec   faa9     
md_exr_readinfo faec     
md_exr_sec      fb0d     
md_exr_sendcmd  fac5     
md_exr_trk      fb0c     
md_fetch_params fa18     
md_old_seld_dsk fa11     
md_param2       fa1c     
md_pgsl         fa96     
md_ppsl         fab2     
md_pscl         fad4     
md_pwg          fa71     
md_pwp          fa81     
md_rdbuf2       fb01     
md_read         fa3e     
md_read_infosector fa68     
md_res_drive_tab fa02     
md_res_drivea   fa00     
md_res_driveb   fa01     
md_res_seldsk   fa0e     
md_rpcwr       =fe0b     
md_rporta      =fe08     
md_rportc      =fe0a     
md_rrbuff      =   0     
md_write        fa53     
mount_crlf      2a9c     
mount_info_from_emu 2a7e     
mount_msg       2a45     
mount_msg_drv   2a45     
mount_msg_rw    2a47     
move_microdos_resident 26fb     
msg_default_mount 2a38     
msg_fdc         2450     
msg_fdd         2a6b     
msg_fdd_drv     2a72     
msg_fdd_err     2a74     
msg_gzu_size    2447     
msg_invalidpatchcode 282f     
msg_rom_model   2441     
msg_strangehlafterpatch 2877     
msg_tab16_fdc   2425     
msg_tab8_gzu_size 240d     
msg_tab8_rom_model 23ed     
msg_warning     25bb     
msgask_subst    237d     
msgbadbootparam 219e     
msgcpm          2361     
msgcrlf         2625     
msgdrive_f      2a9f     
msgforceddefaultbios 23a3     
msgfound        25e1     
msgmicrodos     2366     
msgnotfound     25ec     
msgpatcher      25bd     
msgreq_opts     2628     
msgreq_opts_digit 2640     
msgsubst        236f     
msgundefindedsubbios 2854     
msgzerodrvinfotab 29a7     
mute_flag       235f     
ncreg          =fe3a     
out_buffer      2a4a     
p_stop         =  50     
patch_done      2722     
patch_flag      266f     
patch_loop      2734     
pb_chk_patch   =  52     
pb_maybe_patch =  59     
pchdrv         =  4c     
pnotsupported  =  55     
porta          =fb08     
portc          =fb0a     
prequired_opts1=  57     
prequired_opts2=  58     
psetflag_microdos=  56     
pstr            22c2     
psubbios       =  5a     
putbyte         223d     
putch           22cc     
putstr16        2458     
putstr8         2461     
putstr_         246a     
putx8           2466     
pw_chk_patch   =  51     
pw_store       =  54     
read_de_at_tmp  28bd     
receive_c_bytes_to_hl 2a29     
resident_cpm1  =2ade     
resident_cpm1_addr=e8ac     
resident_cpm1_len= 197     
resident_cpm2  =2c75     
resident_cpm2_addr=ea06     
resident_cpm2_len= 197     
resident_md     2e0c     
resident_md_addr=fa00     
resident_md_len= 110     
restart_disable 2086     
rpcwr          =fb0b     
rporta         =fb08     
rportc         =fb0a     
runadr          22e9     
scl             2290     
scount          22eb     
sec             22e6     
secbuf         =4000     
sendcmd         2287     
set_opts_warning 2814     
set_subst       2082     
show_disk_info  2953     
show_hardware_info 2478     
show_mount_drive 28fc     
show_mount_info 28d6     
showbootparams  21da     
skip_disk       295e     
skip_msg_1      20fb     
skip_msg_2      2129     
skip_msg_star   2148     
ssize           22ec     
ssl1            2105     
ssl2            210d     
start           2008     
store_bc_at_tmp 28b4     
store_bc_to_tmp 28ab     
sysreg14       =fa7f     
sysreg3c       =ff7f     
sysreg5c       =ff7f     
tmp             28a9     
tmpkey          2360     
tram           =fc00     
trk             22e5     
try_bios        2670     
unsupported     281f     
vireg          =ffbf     
waitkey         204d     
wg              2232     
work_ptr        266d     
wp              2242     
