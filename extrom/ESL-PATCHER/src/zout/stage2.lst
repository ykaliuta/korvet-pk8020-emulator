   1:				;**********************************************************************************************
   2:				;*  Загрузчик 2 фазы дискового эмулятора Korvet-Extrom
   3:				;*  Работает только в паре с контроллером Extrom через боковой разъем корвета
   4:				;*
   5:				;*  Загружает в память системные дорожки диска А и передает управление на код инициализации BIOS
   6:				;*   Сборка с помощью кросс-ассемблера z80asm, контрольная сумма рассчитывается утилитой ercs
   7:				;*
   8:				;*   Программа записывается на карту SD контроллера в файл LOADER.BIN
   9:				;**********************************************************************************************
  10:     -	2000          	BASE	EQU	2000H		; База для размещения этого кода
  11:     -	FB08          	PORTA	EQU     0FB08H		; Порт A ВВ55 #3
  12:     -	FB0A          	PORTC	EQU     0FB0AH		; Порт C ВВ55 #3
  13:     -	FC00          	TRAM	EQU	0FC00H		; Начало видеопамяти
  14:				
  15:     -	FA7F          	SYSREG14  EQU	0FA7FH		; регистр карты памяти
  16:     -	FF7F          	SYSREG5C  EQU	0FF7FH		; регистр карты памяти
  17:				; SYSREG6C  EQU	0BF7FH
  18:     -	FF7F          	SYSREG3C  EQU	0FF7FH
  19:				
  20:     -	004C          	PCHDRV	EQU	4Ch		; подпрограмма печати байта через драйвер консоли ОПТС
  21:     -	0049          	CONIN	EQU	49h		; подпрограмма ввода символа через драйвер консоли ОПТС
  22:				
  23:				
  24:				; started in config 14
  25:				; 	14  NDOS   0-1FFF  2000-F7FF                   F800  FA00  FC00  FB00
  26:				
  27:     -	2000          		ORG   	BASE
  28:				
  29:				; Стандартный заголовок внешнего ПЗУ корвета
  30:    0+10	2000  C30820  		JP	START	        ; +0
  31:     -	2003  00      		DB      0		; +3
  32:     -	2004  0820    		DW	START           ; +4 - адрес запуска 
  33:     -	2006  20      		DB	BASE>>8         ; +6 - старшие 8 бит адреса загрузки (младшие всегда 00)
  34:     -	2007  20      		DB	(FTOP-BASE)>>8  ; +7 - количество загружаемых 256-байтовых блоков
  35:				
  36:				
  37:				; Далее идет непосредственный программный код	
  38:     -	2008          	START:
  39:   10+4	2008  F3      		DI
  40:   14+10	2009  3100F7  		LD	SP,0F700h	; рабочий стек, размещаем в области F-макросов драйвера клавиатуры
  41:				
  42:   24+17	200C  CD1D22  		call 	initLUT
  43:				
  44:				; Печать промпта 	
  45:   41+10	200F  21F122  		LD	HL,HMSG
  46:   51+17	2012  CDC522  		CALL	PSTR
  47:				
  48:   68+17	2015  CDAF24  		call 	hw_test
  49:				; 	halt
  50:				
  51:				
  52:   85+4	2018  AF      		xor 	a
  53:   89+13	2019  32BC25  		ld 	(flag_microdos),a
  54:				
  55:  102+13	201C  3A80F8  		ld 	a,(0xf880)
  56:  115+7	201F  E621    		and 	0x21 		;ctrl+shift
  57:  122+7	2021  FE21    		cp 	0x21
  58:				
  59:  129+10	2023  CA2A20  		jp 	z,force_default_bios
  60:  139+4	2026  AF      		xor 	a		;turn off system substitution
  61:  143+10	2027  C38620  		jp 	restart_disable
  62:				
  63:     -	202A          	force_default_bios:
  64:  153+10	202A  21A623  		ld 	hl,msgFORCEDDEFAULTBIOS
  65:  163+17	202D  CDC522  		call 	PSTR
  66:				; 	jp 	set_subst
  67:				
  68:     -	2030          	force_subst:
  69:				; 	ld 	hl,msgFORCEDDEFAULTBIOS
  70:				; 	call 	PSTR
  71:				
  72:  180+10	2030  217223  		ld 	hl,msgSUBST
  73:  190+17	2033  CDC522  		call 	PSTR
  74:				
  75:  207+13	2036  3ABC25  		ld 	a,(flag_microdos)
  76:				
  77:  220+10	2039  216923  		ld 	hl,msgMICRODOS
  78:  230+7	203C  FE01    		cp 	1
  79:  237+10	203E  CA4420  		jp 	z,.print
  80:  247+10	2041  216423  		ld 	hl,msgCPM
  81:     -	2044          	.print:
  82:  257+17	2044  CDC522  		call 	PSTR
  83:				
  84:  274+10	2047  218023  		ld 	hl,msgASK_SUBST
  85:  284+17	204A  CDC522  		call 	PSTR
  86:				
  87:     -	204D          	WaitKey:
  88:  301+7	204D  3E07    		ld 	a,7
  89:  308+17	204F  CDCF22  		call 	PUTCH
  90:  325+17	2052  CDDA22  		call 	GETCH
  91:  342+7	2055  E65F    		and 	0x5F
  92:				
  93:  349+7	2057  FE0D    		cp 	0x0d 	;CR
  94:  356+10	2059  C25E20  		jp 	nz,.printKEY
  95:				
  96:  366+7	205C  3E59    		ld 	a,'Y'
  97:				
  98:     -	205E          	.printKEY:
  99:  373+13	205E  326323  		ld 	(tmpKEY),a
 100:				
 101:  386+7	2061  FE59    		cp 	'Y'
 102:  393+10	2063  CA8220  		jp 	z,set_subst
 103:  403+7	2066  FE44    		cp 	'D'
 104:  410+10	2068  CA8220  		jp 	z,set_subst
 105:				
 106:  420+7	206B  FE43    		cp 	a,'C'
 107:  427+10	206D  C27820  		jp 	nz,.chkM
 108:				
 109:  437+7	2070  3E00    		ld 	a,0
 110:  444+13	2072  32BC25  		ld 	(flag_microdos),a
 111:  457+10	2075  C38220  		jp 	set_subst
 112:     -	2078          	.chkM:
 113:  467+7	2078  FE4D    		cp 	'M'
 114:  474+10	207A  C24D20  		jp 	nz,WaitKey
 115:  484+7	207D  3E01    		ld 	a,1	
 116:  491+13	207F  32BC25  		ld 	(flag_microdos),a
 117:				
 118:				
 119:     -	2082          	set_subst:
 120:  504+13	2082  3ABC25  		ld 	a,(flag_microdos)
 121:  517+4	2085  3C      		inc 	a
 122:				
 123:     -	2086          	restart_disable:
 124:  521+13	2086  32E822  		ld 	(TRK),A
 125:  534+7	2089  3EA0    		ld 	a,0xA0 		;system substitution
 126:  541+13	208B  32E622  		ld 	(CMD),a
 127:  554+4	208E  AF      		xor 	a
 128:  558+13	208F  32E722  		ld 	(DRV),a
 129:  571+17	2092  CD8A22  		call 	SENDCMD
 130:				
 131:  588+13	2095  3A6323  		ld 	a,(tmpKEY)
 132:  601+4	2098  B7      		or 	a
 133:  605+10	2099  CAA520  		jp 	z,.noPrintKey
 134:  615+17	209C  CDCF22  		call 	PUTCH
 135:  632+10	209F  215F23  		ld 	hl,HCRLF
 136:  642+17	20A2  CDC522  		call	PSTR 	
 137:				
 138:     -	20A5          	.noPrintKey:
 139:				
 140:				
 141:  659+7	20A5  3E00    		ld 	a,0
 142:  666+13	20A7  32BB25  		ld 	(flag_unsupported),a
 143:  679+13	20AA  32BC25  		ld 	(flag_microdos),a
 144:  692+10	20AD  210000  		ld 	hl,0
 145:  702+16	20B0  22BE25  		ld 	(msg_warning),hl
 146:				
 147:  718+4	20B3  F3      		DI
 148:  722+10	20B4  3100F7  		LD	SP,0F700h	; рабочий стек, размещаем в области F-макросов драйвера клавиатуры
 149:				
 150:  732+17	20B7  CDF828  		call 	show_boot_image_name
 151:				
 152:				; Загрузка инфосектора
 153:				
 154:  749+7	20BA  3E01    		ld 	a,0x1 		;read
 155:  756+13	20BC  32E622  		ld 	(CMD),a
 156:  769+4	20BF  AF      		xor 	a
 157:  773+13	20C0  32E822  		ld 	(TRK),A
 158:  786+13	20C3  32E922  		ld 	(SEC),A
 159:				
 160:				
 161:  799+17	20C6  CD8A22  		CALL	SENDCMD		; отсылаем команду загрузки сектора, параметры уже прописаны в командном блоке
 162:  816+10	20C9  210040  		LD	HL,SECBUF
 163:  826+17	20CC  CDAA22  		CALL	GETSEC		; забираем 256 байт сектора 0
 164:				
 165:				; Разбор инфосектора
 166:				;
 167:				; Вынимаем идущие подряд переменные LOADR, RUNADR, COUNT
 168:				;
 169:				
 170:				;TODO: add crc check!!!!!!!!!!!!!!!
 171:				
 172:  843+10	20CF  210040  		LD	HL,SECBUF
 173:  853+10	20D2  11EA22  		LD	DE,LOADR	; начало блока переменных в памяти
 174:  863+7	20D5  0E05    		LD	C,5		; всего 5 байтов
 175:     -	20D7          	IL:
 176:  870+7	20D7  7E      		LD	A,(HL)		; копируем блок переменных
 177:  877+7	20D8  12      		LD	(DE),A
 178:  884+6	20D9  23      		INC	HL
 179:  890+6	20DA  13      		INC	DE
 180:  896+4	20DB  0D      		DEC	C
 181:  900+10	20DC  C2D720  		JP	NZ,IL
 182:				
 183:				; Получаем индекс размера сектора
 184:  910+10	20DF  210A40  		LD	HL,SECBUF+10	;  +10 - коэффициент блокирования секторов
 185:  920+7	20E2  7E      		LD	A,(HL)
 186:  927+7	20E3  12      		LD	(DE),A
 187:  934+6	20E4  13      		INC	DE
 188:  940+10	20E5  211040  		LD	HL,SECBUF+16	;  +16 - LSPT
 189:  950+7	20E8  7E      		LD	A,(HL)
 190:  957+7	20E9  12      		LD	(DE),A
 191:				
 192:  964+17	20EA  CD6E21  		call 	CheckBootParams
 193:  981+10	20ED  C23020  		jp 	nz,force_subst
 194:					
 195:  991+13	20F0  3A80F8  		ld 	a,(0xf880)
 196: 1004+7	20F3  E601    		and 	0x1
 197: 1011+13	20F5  326223  		ld 	(mute_flag),a
 198: 1024+10	20F8  CAFE20  		jp 	z,skip_msg_1
 199:				
 200: 1034+17	20FB  CDDD21  		call 	ShowBootParams
 201:				
 202:     -	20FE          	skip_msg_1:
 203:						
 204:				; Вычисление числа полных дорожек для загрузки	
 205:					
 206: 1051+10	20FE  21EE22  		LD	HL,SCOUNT	
 207: 1061+7	2101  5E      		LD	E,(HL)		; число загружаемых физических секторов
 208: 1068+7	2102  1600    		LD	D,0		; -> DE
 209: 1075+6	2104  23      		INC	HL
 210: 1081+7	2105  4E      		LD	C,(HL)		; индекс размера сектора
 211:				;
 212:				; Индекс размера - очень удобная величина, определяющая коэффициент блокирования секторов, то есть число логических секторов в физическом
 213:				; Размер логического сектора CP/M - всегда 128 байт.
 214:				;
 215:				;  Физ.сектор   SSIZE    коэффициент блокирования
 216:				;----------------------------------------------------
 217:				;     128         0                1
 218:				;     256         1                2
 219:				;     512         2                4
 220:				;     1024        3                8 
 221:				;
 222:				;
 223:				; Далее выполняется операция DE << C, что приводит к умножению числа физических секторов
 224:				; на коэффициент блокирования - получаем число загружаемых логических секторов
 225: 1088+4	2106  EB      		ex 	de,hl
 226: 1092+4	2107  0C      		INC	C		; Коррекция SSIZE, чтобы начинался с 1
 227:     -	2108          	SSL1:	
 228: 1096+4	2108  0D      		DEC	C		; счетчик сдвига--
 229: 1100+10	2109  CA1021  		JP	Z,SSL2		; сдвиг окончен
 230:				; 	XOR	A		; CF=0
 231:				; 	LD	A,E
 232:				; 	RLA			; сдвигаем младший байт
 233:				; 	LD	E,A
 234:				; 	LD	A,D
 235:				; 	RLA			; сдвигаем старший байт
 236:				; 	LD	D,A
 237: 1110+11	210C  29      		add 	hl,hl
 238: 1121+10	210D  C30821  		JP	SSL1
 239:				;
 240:				;  Выводим на экран число логических секторов
 241:				;
 242:     -	2110          	SSL2:
 243: 1131+4	2110  EB      		ex 	de,hl
 244: 1135+13	2111  3A6223  		ld 	a,(mute_flag)
 245: 1148+4	2114  B7      		or 	a
 246: 1152+10	2115  CA2C21  		jp 	z,skip_msg_2
 247:				
 248: 1162+10	2118  215423  		LD	HL,HMLS
 249: 1172+17	211B  CDC522  		CALL	PSTR
 250: 1189+4	211E  7A      		LD	A,D
 251: 1193+17	211F  CD6022  		CALL	HEX2
 252: 1210+4	2122  7B      		LD	A,E
 253: 1214+17	2123  CD6022  		CALL	HEX2
 254:				
 255: 1231+10	2126  215F23  		LD	HL,HCRLF
 256: 1241+17	2129  CDC522  		CALL	PSTR
 257:				
 258:					;de - sectors to load
 259:				
 260:     -	212C          	skip_msg_2:
 261:				
 262:					;DE - sectors to load
 263:				
 264: 1258+4	212C  4B      		ld 	c,e 		; C - sectors to load (up to 32k)
 265: 1262+16	212D  2AEA22  		LD	HL,(LOADR)	; HL - указатель позиции загрузки в памяти
 266:				
 267: 1278+4	2130  AF      		xor 	a
 268: 1282+13	2131  32E822  		ld 	(TRK),a
 269:				
 270: 1295+4	2134  0C      		inc 	c
 271:				
 272:     -	2135          	ld_loop_sec0:
 273: 1299+4	2135  AF      		xor 	a
 274: 1303+13	2136  32E922  		ld 	(SEC),a
 275:				
 276:     -	2139          	ld_loop:
 277:				
 278: 1316+4	2139  0D      		dec 	c
 279: 1320+4	213A  79      		ld 	a,c
 280: 1324+4	213B  B7      		or 	a
 281: 1328+10	213C  CA6721  		jp 	z,load_done
 282:				
 283: 1338+13	213F  3A6223  		ld 	a,(mute_flag)
 284: 1351+4	2142  B7      		or 	a
 285: 1355+10	2143  CA4B21  		jp 	z,skip_msg_star
 286:				
 287: 1365+7	2146  3E2A    		LD	A,'*'		; прогресс-бар загружаемых секторов
 288: 1372+17	2148  CDCF22  		CALL	PUTCH
 289:     -	214B          	skip_msg_star:
 290:					
 291:				
 292: 1389+17	214B  CD8A22  		CALL	SENDCMD		; отправляем команду
 293: 1406+17	214E  CDAA22  		CALL	GETSEC		; получаем и размещаем сектор
 294:				
 295: 1423+11	2151  E5      		PUSH	HL
 296: 1434+10	2152  21E922  		LD	HL,SEC
 297: 1444+11	2155  34      		INC	(HL)		; номер сектора ++
 298:				
 299: 1455+13	2156  3AF022  		ld 	a,(LSPT)
 300: 1468+7	2159  BE      		cp 	(hl)
 301: 1475+10	215A  E1      		POP	HL
 302:				
 303: 1485+10	215B  C23921  		jp 	nz,ld_loop
 304:				
 305: 1495+11	215E  E5      		PUSH	HL
 306: 1506+10	215F  21E822  		LD	HL,TRK
 307: 1516+11	2162  34      		INC	(HL)		; номер сектора ++
 308: 1527+10	2163  E1      		POP	HL
 309: 1537+10	2164  C33521  		jp 	ld_loop_sec0
 310:				
 311:     -	2167          	load_done:
 312:				; 	halt
 313:				
 314:				; Вся системная область диска загружена - можно запускать ОС
 315:				;	
 316:				; 	LD	A,'@'		; Признак окончания загрузки - на экран
 317:				; 	CALL	PUTCH
 318:				
 319: 1547+17	2167  CD5625  		call 	cpm_bios_patcher
 320:				
 321:				; 	LD	HL,SYSREG14	
 322:				; 	LD	(HL),1Ch	; Включаем карту памяти 1С, для CP/M
 323:					
 324:					;start with sysreg=14
 325:				
 326: 1564+16	216A  2AEC22  		LD	HL,(RUNADR)
 327: 1580+4	216D  E9      		JP	(HL)		; уходим по адресу запуска
 328:					
 329:     -	216E          	CheckBootParams:
 330:				
 331: 1584+10	216E  21EA22  		LD	HL,LOADR
 332: 1594+17	2171  CD8522  		call 	FetchDEfromHL
 333:				
 334: 1611+4	2174  7A      		ld 	a,d
 335: 1615+7	2175  FE22    		cp 	0x22 		; load addr shiould be >0x2200
 336: 1622+10	2177  DA9521  		jp 	c,.BadBootParam
 337:				
 338: 1632+10	217A  21EC22  		LD	HL,RUNADR
 339: 1642+17	217D  CD8522  		call 	FetchDEfromHL
 340: 1659+4	2180  7A      		ld 	a,d
 341: 1663+7	2181  FE22    		cp 	0x22 		; run addr shiould be >0x2200
 342: 1670+10	2183  DA9521  		jp 	c,.BadBootParam
 343:				
 344: 1680+10	2186  21EE22  		LD	HL,SCOUNT
 345: 1690+7	2189  7E      		LD	A,(HL)
 346: 1697+4	218A  B7      		or 	a
 347: 1701+10	218B  CA9521  		jp 	z,.BadBootParam
 348: 1711+7	218E  FE30    		cp 	48 		;sectors to load < 48
 349: 1718+10	2190  D29521  		jp 	nc,.BadBootParam
 350:				
 351: 1728+4	2193  AF      		xor 	a
 352: 1732+10	2194  C9      		ret
 353:				
 354:     -	2195          	.BadBootParam:
 355: 1742+17	2195  CDDD21  		call 	ShowBootParams
 356: 1759+10	2198  21A121  		ld 	hl,msgBadBootParam
 357: 1769+17	219B  CDC522  		CALL	PSTR
 358: 1786+4	219E  AF      		xor 	a
 359: 1790+4	219F  3C      		inc 	a
 360: 1794+10	21A0  C9      		ret
 361:				
 362:     -	21A1          	msgBadBootParam:
 363:     -	21A1  0D0A    		db 	0x0d,0x0a
 364:     -	21A3  496E636F		db 	'Incorrect boot parameters detected, fallback to default'
	      72726563
	      7420626F
	      6F742070
	      6172616D
	      65746572
	      73206465
	      74656374
	      65642C20
	      66616C6C
	      6261636B
	      20746F20
	      64656661
	      756C74
 365:     -	21DA  0D0A00  		db 	0x0d,0x0a,0
 366:				
 367:     -	21DD          	ShowBootParams:
 368:					; Вывод параметров загрузки на экран
 369: 1804+10	21DD  212C23  		LD	HL,HMBASE
 370: 1814+17	21E0  CDC522  		CALL	PSTR
 371: 1831+10	21E3  21EA22  		LD	HL,LOADR
 372: 1841+17	21E6  CD7A22  		CALL	HEXW
 373: 1858+10	21E9  213223  		LD	HL,HMRUN
 374: 1868+17	21EC  CDC522  		CALL	PSTR
 375: 1885+10	21EF  21EC22  		LD	HL,RUNADR
 376: 1895+17	21F2  CD7A22  		CALL	HEXW
 377: 1912+10	21F5  213A23  		LD	HL,HMPS
 378: 1922+17	21F8  CDC522  		CALL	PSTR
 379: 1939+10	21FB  21EE22  		LD	HL,SCOUNT
 380: 1949+7	21FE  7E      		LD	A,(HL)
 381: 1956+17	21FF  CD6022  		CALL	HEX2
 382: 1973+10	2202  214523  		LD	HL,HMSS
 383: 1983+17	2205  CDC522  		CALL	PSTR
 384: 2000+10	2208  21EF22  		LD	HL,SSIZE
 385: 2010+7	220B  7E      		LD	A,(HL)
 386: 2017+17	220C  CD6022  		CALL	HEX2
 387: 2034+10	220F  214D23  		LD	HL,HMSP
 388: 2044+17	2212  CDC522  		CALL	PSTR
 389: 2061+10	2215  21F022  		LD	HL,LSPT
 390: 2071+7	2218  7E      		LD	A,(HL)
 391: 2078+17	2219  CD6022  		CALL	HEX2
 392: 2095+10	221C  C9      		ret
 393:				
 394:     -	221D          	initLUT:
 395: 2105+10	221D  21FBFA  		ld      hl, 0xFAFB
 396: 2115+7	2220  3EF8    		ld      a, 0F8h 
 397:				
 398:     -	2222          	.iniLUT:                  
 399: 2122+7	2222  77      		ld      (hl), a         ; F8,F9,FA,FB,FC,FD,FE,FF
 400: 2129+4	2223  3C      		inc     a
 401: 2133+10	2224  C22222  		jp      nz, .iniLUT      ; F8,F9,FA,FB,FC,FD,FE,FF
 402:					
 403: 2143+10	2227  010811  		ld      bc, 1108h       ; A=0
 404:					
 405:     -	222A          	.iniLUTGRP:                  
 406: 2153+7	222A  77      		ld      (hl), a         ; 00,11,22,33,44,55,66,77
 407: 2160+4	222B  80      		add     a, b
 408: 2164+4	222C  0D      		dec     c
 409: 2168+10	222D  C22A22  		jp      nz, .iniLUTGRP   ; 00,11,22,33,44,55,66,77
 410:				
 411: 2178+10	2230  C9      		ret
 412:				
 413:				
 414:				;****************************************
 415:				;*  Прием байта из порта А по стробу    *
 416:				;****************************************
 417:     -	2231          	GETBYTE:
 418: 2188+11	2231  E5      		PUSH	HL
 419: 2199+10	2232  210AFB  		LD	HL,PORTC
 420:     -	2235          	WG:
 421: 2209+7	2235  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 422: 2216+7	2236  E620    		AND	20h		; выделяем сигнал IBF
 423: 2223+10	2238  CA3522  		JP	Z,WG		; IBF=0 - данных еще нет
 424: 2233+4	223B  2D      		DEC	L
 425: 2237+4	223C  2D      		DEC	L
 426: 2241+7	223D  7E      		LD	A,(HL)		; данные поступили - выбираем их из порта А
 427: 2248+10	223E  E1      		POP	HL
 428: 2258+10	223F  C9      		RET
 429:				
 430:				;****************************************
 431:				;*  Отправка байта в порт A             *
 432:				;****************************************
 433:     -	2240          	PUTBYTE:
 434: 2268+11	2240  E5      		PUSH	HL
 435: 2279+11	2241  F5      		PUSH	AF
 436: 2290+10	2242  210AFB  		LD	HL,PORTC
 437:     -	2245          	WP:
 438: 2300+7	2245  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 439: 2307+7	2246  E680    		AND	80h		; выделяем сигнал -OBF
 440: 2314+10	2248  CA4522  		JP	Z,WP		; -OBF=0 - в передатчике сидит незабранный байт
 441: 2324+4	224B  2D      		DEC	L
 442: 2328+4	224C  2D      		DEC	L
 443: 2332+10	224D  F1      		POP	AF
 444: 2342+7	224E  77      		LD	(HL),A		; отправляем данные в порт данных
 445: 2349+10	224F  E1      		POP	HL
 446: 2359+10	2250  C9      		RET
 447:				
 448:				;****************************************
 449:				;*      Печать полубайта в HEX          *
 450:				;****************************************
 451:				
 452:     -	2251          	HEX1:
 453: 2369+7	2251  E60F    		AND	0Fh		; младший полубайт 
 454: 2376+7	2253  C630    		ADD	'0'		; в ASCII
 455: 2383+7	2255  FE3A    		CP	3Ah		; 0-9?
 456: 2390+10	2257  DA5C22  		JP	C,H1D		; да
 457: 2400+7	225A  C607    		ADD	7		; коррекция до A-F
 458: 2407+17	225C  CDCF22  	H1D:	CALL	PUTCH		; Печать байта
 459: 2424+10	225F  C9      		RET
 460:				
 461:				;****************************************
 462:				;*      Печать байта в HEX              *
 463:				;****************************************
 464:				
 465: 2434+11	2260  F5      	HEX2:	PUSH	AF
 466: 2445+4	2261  0F      		RRCA
 467: 2449+4	2262  0F      		RRCA			; сдвигаем старший полубайт в младший
 468: 2453+4	2263  0F      		RRCA
 469: 2457+4	2264  0F      		RRCA
 470: 2461+17	2265  CD5122  		CALL	HEX1		; печатаем его
 471: 2478+10	2268  F1      		POP	AF
 472: 2488+7	2269  E60F    		AND	0Fh		
 473: 2495+17	226B  CD5122  		CALL	HEX1		; печатаем младший полубайт
 474: 2512+10	226E  C9      		RET
 475:				
 476:     -	226F          	HEX4:
 477: 2522+11	226F  F5      		push 	AF
 478: 2533+4	2270  7C      		ld 	a,h
 479: 2537+17	2271  CD6022  		call 	HEX2
 480: 2554+4	2274  7D      		ld 	a,l
 481: 2558+17	2275  CD6022  		call 	HEX2
 482: 2575+10	2278  F1      		pop 	AF
 483: 2585+10	2279  C9      		ret
 484:				;****************************************
 485:				;*  Печать слова (2 байта) из (HL)      *
 486:				;****************************************
 487:     -	227A          	HEXW:
 488: 2595+6	227A  23      		INC	HL
 489: 2601+7	227B  7E      		LD	A,(HL)		; старший байт
 490: 2608+17	227C  CD6022  		CALL	HEX2
 491: 2625+6	227F  2B      		DEC	HL		; младший байт
 492: 2631+7	2280  7E      		LD	A,(HL)
 493: 2638+17	2281  CD6022  		CALL	HEX2
 494: 2655+10	2284  C9      		RET
 495:				
 496:     -	2285          	FetchDEfromHL:
 497: 2665+7	2285  5E      		LD	E,(HL)
 498: 2672+6	2286  23      		INC	HL
 499: 2678+7	2287  56      		LD	D,(HL)		; старший байт
 500: 2685+6	2288  2B      		DEC	HL		; младший байт
 501: 2691+10	2289  C9      		RET
 502:					
 503:						
 504:				;****************************************
 505:				;*     Отправка командного пакета       *
 506:				;****************************************
 507:     -	228A          	SENDCMD:
 508: 2701+11	228A  E5      		PUSH	HL
 509: 2712+11	228B  C5      		PUSH	BC
 510: 2723+10	228C  21E622  		LD	HL,CMD
 511: 2733+7	228F  0E04    		LD	C,4		; пакет - 4 байта
 512: 2740+7	2291  0600    		LD	B,0		; заготовка контрольной суммы
 513:     -	2293          	SCL:
 514: 2747+7	2293  7E      		LD	A,(HL)		; очередной байт пакета 
 515: 2754+4	2294  80      		ADD 	B		; добавляем к КС
 516: 2758+4	2295  47      		LD	B,A
 517: 2762+7	2296  7E      		LD	A,(HL)		; очередной байт пакета 
 518: 2769+17	2297  CD4022  		CALL	PUTBYTE		; - в порт
 519: 2786+6	229A  23      		INC	HL
 520: 2792+4	229B  0D      		DEC	C
 521: 2796+10	229C  C29322  		JP	NZ,SCL
 522: 2806+4	229F  78      		LD	A,B
 523: 2810+4	22A0  3D      		DEC 	A		; КС-1
 524: 2814+17	22A1  CD4022  		CALL	PUTBYTE     ; контрольная сумма
 525: 2831+17	22A4  CD3122  		CALL	GETBYTE	    ; ответ контроллера
 526: 2848+10	22A7  C1      		POP	BC
 527: 2858+10	22A8  E1      		POP	HL
 528: 2868+10	22A9  C9      		RET
 529:					
 530:					
 531:				;*******************************************
 532:				;*      Прием сектора                      *
 533:				;* HL - адрес размещения сектора в памяти  *
 534:				;*  Размер сектора - 128 байт              *
 535:				;*******************************************
 536:     -	22AA          	GETSEC:
 537: 2878+11	22AA  C5      		PUSH	BC
 538: 2889+11	22AB  D5      		PUSH	DE
 539: 2900+7	22AC  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
 540: 2907+4	22AE  EB      		EX	DE,HL		; адрес буфера -> DE
 541: 2911+10	22AF  210AFB  		LD	HL,PORTC
 542:     -	22B2          	GSL:
 543: 2921+7	22B2  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 544: 2928+7	22B3  E620    		AND	20h		; выделяем сигнал IBF
 545: 2935+10	22B5  CAB222  		JP	Z,GSL		; IBF=0 - данных еще нет
 546: 2945+13	22B8  3A08FB  		LD	A,(PORTA)		; данные поступили - выбираем их из порта А
 547: 2958+7	22BB  12      		LD	(DE),A		; принимаем и размещаем очередной байт
 548: 2965+6	22BC  13      		INC	DE		; указатель буфера ++
 549: 2971+4	22BD  0D      		DEC	C		; принимаем остальные байты
 550: 2975+10	22BE  C2B222  		JP	NZ,GSL
 551: 2985+4	22C1  EB      		EX	DE,HL		; адрес буфера -> HL
 552: 2989+10	22C2  D1      		POP	DE
 553: 2999+10	22C3  C1      		POP	BC
 554: 3009+10	22C4  C9      		RET
 555:					
 556:					
 557:					
 558:				;****************************************
 559:				;  Печать строки на текстовый экран     *
 560:				;****************************************
 561:     -	22C5          	PSTR:
 562: 3019+7	22C5  7E      		LD	A,(HL)
 563: 3026+6	22C6  23      		INC	HL
 564: 3032+4	22C7  B7      		OR	A		; 0 - конец строки
 565: 3036+5+6	22C8  C8      		RET	Z
 566: 3041+17	22C9  CDCF22  		CALL	PUTCH		; выводим байт через вызов ОПТС
 567: 3058+10	22CC  C3C522  		JP	PSTR
 568:					
 569:				;****************************************
 570:				;   Вывод байта на экран через ОПТС
 571:				;****************************************
 572:     -	22CF          	PUTCH:
 573: 3068+11	22CF  E5      		PUSH	HL
 574: 3079+11	22D0  C5      		PUSH	BC
 575: 3090+11	22D1  D5      		PUSH	DE
 576: 3101+4	22D2  4F      		LD	C,A
 577: 3105+17	22D3  CD4C00  		CALL	PCHDRV
 578: 3122+10	22D6  D1      		POP	DE
 579: 3132+10	22D7  C1      		POP	BC
 580: 3142+10	22D8  E1      		POP	HL
 581: 3152+10	22D9  C9      		RET
 582:				
 583:				;A - chr
 584:     -	22DA          	GETCH:
 585: 3162+4	22DA  FB      		EI
 586: 3166+11	22DB  E5      		PUSH	HL
 587: 3177+11	22DC  C5      		PUSH	BC
 588: 3188+11	22DD  D5      		PUSH	DE
 589: 3199+17	22DE  CD4900  		CALL	CONIN
 590: 3216+10	22E1  D1      		POP	DE
 591: 3226+10	22E2  C1      		POP	BC
 592: 3236+10	22E3  E1      		POP	HL
 593: 3246+4	22E4  F3      		DI
 594: 3250+10	22E5  C9      		RET
 595:				
 596:				
 597:				; Командный пакет	
 598:     -	22E6  01      	CMD:	DB	1		; Команда чтения
 599:     -	22E7  00      	DRV:	DB	0
 600:     -	22E8  00      	TRK:	DB	0
 601:     -	22E9  00      	SEC:	DB	0
 602:				
 603:				; Параметры загрузки из инфосектора
 604:     -	22EA          	LOADR:	DS	2	; адрес загрузки
 605:     -	22EC          	RUNADR:	DS	2	; адрес запуска
 606:     -	22EE          	SCOUNT:	DS	1	; число загружаемых физических секторов
 607:     -	22EF          	SSIZE:	DS	1	; коэффициент размера физического сектора
 608:     -	22F0          	LSPT:	DS	1	; число логических секторов на дорожку
 609:				
 610:				; Текстовые строки для вывода на экран
 611:     -	22F1  1F      	HMSG:   DB	1Fh ; очистка экрана
 612:     -	22F2  2D2D4558		DB	"--EXTROM Stage2 boot version 1.1 by Forh32 & ESL 2015--",0dh,0ah,0	; текстовое сообщение на экран
	      54524F4D
	      20537461
	      67653220
	      626F6F74
	      20766572
	      73696F6E
	      20312E31
	      20627920
	      466F7268
	      33322026
	      2045534C
	      20323031
	      352D2D0D
	      0A00
 613:     -	232C  42415345	HMBASE: DB	"BASE:",0
	      3A00
 614:     -	2332  20535441	HMRUN:  DB	" START:",0
	      52543A00
 615:     -	233A  20505345	HMPS:   DB	" PSECTORS:",0
	      43544F52
	      533A00
 616:     -	2345  20535349	HMSS:   DB	" SSIZE:",0
	      5A453A00
 617:     -	234D  204C5350	HMSP:   DB	" LSPT:",0
	      543A00
 618:     -	2354  204C5345	HMLS:   DB	" LSECTORS:",0
	      43544F52
	      533A00
 619:				; HMTR:   DB	" TRACKS:",0
 620:     -	235F  0D0A00  	HCRLF:	DB	0dh,0ah,0
 621:     -	2362          	mute_flag:
 622:     -	2362  00      		db 	0
 623:     -	2363          	tmpKEY:
 624:     -	2363  00      		db 	0
 625:     -	2364          	msgCPM:
 626:     -	2364  43502F4D	 	db 	'CP/M',0
	      00
 627:     -	2369          	msgMICRODOS:
 628:     -	2369  4D494352		db 	'MICRODOS',0
	      4F444F53
	      00
 629:     -	2372          	msgSUBST:
 630:     -	2372  4C6F6164	 	db 	'Load default ',0 
	      20646566
	      61756C74
	      2000
 631:     -	2380          	msgASK_SUBST:
 632:     -	2380  203F2845		db 	' ?(Enter/Y-yes, C-CP/M, M-microdos) ?',0	
	      6E746572
	      2F592D79
	      65732C20
	      432D4350
	      2F4D2C20
	      4D2D6D69
	      63726F64
	      6F732920
	      3F00
 633:				
 634:     -	23A6          	msgFORCEDDEFAULTBIOS:
 635:     -	23A6  0D0A2121		db 	0dh,0ah,'!! Ctrl+Shift - pressed, forced to use BIOS SUBSTITUTION !!',0dh,0ah,0dh,0ah,0
	      20437472
	      6C2B5368
	      69667420
	      2D207072
	      65737365
	      642C2066
	      6F726365
	      6420746F
	      20757365
	      2042494F
	      53205355
	      42535449
	      54555449
	      4F4E2021
	      210D0A0D
	      0A00
 636:				
 637:					include 	"hw_test.asm"
**** hw_test.asm ****
   1:     -	0001          	_HW_ROM_OPTS1		equ 	1
   2:     -	0002          	_HW_ROM_OPTS2		equ 	2
   3:				
   4:     -	0001          	_HW_ROM_MODEL_OPTS11 	equ 	1
   5:     -	0002          	_HW_ROM_MODEL_OPTS20 	equ 	2
   6:     -	0003          	_HW_ROM_MODEL_KVANT8	equ 	3
   7:				
   8:     -	0001          	_HW_GZU_SIZE_48K 	equ 	1
   9:     -	0002          	_HW_GZU_SIZE_192K 	equ 	2
  10:				
  11:				;0 - undefined
  12:				;1 - OPTS 1.x
  13:				;2 - OPTS 2.x
  14:     -	23E8          	HW_ROM_OPTS_CLASS:
  15:     -	23E8  00      		db 	0 	
  16:				
  17:				
  18:				;0 - undefined
  19:				;1 - ОПТС 1.1
  20:				;2 - ОПТС 2.0
  21:				;3 - КОНТУР
  22:				;4 - КВАНТ-8 - Терминал
  23:				;5 - КВАНТ-8 - Тигрис
  24:				;6 - CPM.ROM
  25:     -	23E9          	HW_ROM_MODEL:
  26:     -	23E9  00      		db 	0
  27:				
  28:				;0 - undefined
  29:				;1 - 48k
  30:				;2 - 192k
  31:     -	23EA  00      	HW_GZU_SIZE:	db 	0
  32:				
  33:				
  34:     -	23EB  00      	HW_FDC_PRESENT:	db 	0
  35:     -	23EC  00      	HW_FDD_DRIVE_A:	db 	0		
  36:     -	23ED  00      	HW_FDD_DRIVE_B:	db 	0		
  37:     -	23EE  00      	HW_FDD_DRIVE_C:	db 	0		
  38:     -	23EF  00      	HW_FDD_DRIVE_D:	db 	0		
  39:				
  40:     -	23F0          	msg_tab8_rom_model:
  41:					;        01234567
  42:     -	23F0  3F3F524F		db 	'??ROM?? '
	      4D3F3F20
  43:     -	23F8  4F505453		db 	'OPTS 1.1'
	      20312E31
  44:     -	2400  4F505453		db 	'OPTS 2.0'
	      20322E30
  45:     -	2408  4B76616E		db 	'Kvant8  '
	      74382020
  46:				;нет поддержки загрузки EXTROM
  47:				; 	db 	'Kontur  ' 	
  48:				; 	db 	'Kvant8-T'
  49:				; 	db 	'CPM     '
  50:				
  51:     -	2410          	msg_tab8_gzu_size:
  52:					;        01234567
  53:     -	2410  3F3F3F6B		db 	'???k ',0,0,0
	      20000000
  54:     -	2418  34386B20		db 	'48k ',0,0,0,0
	      00000000
  55:     -	2420  3139326B		db 	'192k ',0,0,0
	      20000000
  56:				
  57:     -	2428          	msg_tab16_fdc:
  58:					;        01234  5     6   789012  3     4  5
  59:     -	2428  3130202D		db 	'10 - ',01bh,'6','no FDC',01bh,'7',0
	      201B366E
	      6F204644
	      431B3700
  60:					;        0123456789012345
  61:     -	2438  32302077		db 	'20 with FDC',0
	      69746820
	      46444300
  62:				
  63:     -	2444          	msg_rom_model:
  64:     -	2444  524F4D3A		db 	'ROM: ',0
	      2000
  65:     -	244A          	msg_gzu_size:
  66:     -	244A  207C2047		db 	' | GZU: ',0
	      5A553A20
	      00
  67:     -	2453          	msg_fdc:
  68:     -	2453  207C2050		db 	' | PK80',0
	      4B383000
  69:				
  70:				; CP/M-80  
  71:				; v. 2.2..SHCOMP BIOS Ver. 1.0 1991
  72:				
  73:     -	245B          	putstr16:
  74: 3260+7	245B  0E10    		ld 	c,16
  75: 3267+4	245D  6F      		ld 	l,a
  76: 3271+7	245E  2600    		ld 	h,0
  77: 3278+11	2460  29      		add 	hl,hl 	
  78: 3289+10	2461  C36924  		jp 	putx8
  79:				; a - n
  80:				;DE - base addr
  81:     -	2464          	putstr8:
  82: 3299+7	2464  0E08    		ld 	c,8
  83: 3306+4	2466  6F      		ld 	l,a
  84: 3310+7	2467  2600    		ld 	h,0
  85:     -	2469          	putx8:
  86: 3317+11	2469  29      		add 	hl,hl 	
  87: 3328+11	246A  29      		add 	hl,hl 	
  88: 3339+11	246B  29      		add 	hl,hl 	
  89: 3350+11	246C  19      		add 	hl,de
  90:				
  91:     -	246D          	putstr_:
  92: 3361+4	246D  79      		ld 	a,c
  93: 3365+4	246E  B7      		or 	a
  94: 3369+5+6	246F  C8      		ret 	z
  95: 3374+4	2470  0D      		dec 	c
  96: 3378+7	2471  7E      		LD	A,(HL)
  97: 3385+4	2472  B7      		or 	a
  98: 3389+5+6	2473  C8      		ret 	z
  99:				; 	jp 	nz,.putNoSpc
 100:				; 	ld 	a,'_'
 101:				; 	dec 	hl
 102:     -	2474          	.putNoSpc:
 103: 3394+6	2474  23      		INC	HL
 104: 3400+17	2475  CDCF22  		CALL	PUTCH		
 105: 3417+10	2478  C36D24  		JP	putstr_
 106:				
 107:     -	247B          	show_hardware_info:
 108: 3427+10	247B  214424  		ld 	hl,msg_rom_model
 109: 3437+17	247E  CDC522  		call 	PSTR
 110:				
 111: 3454+13	2481  3AE923  		ld 	a,(HW_ROM_MODEL)
 112: 3467+10	2484  11F023  		ld 	de,msg_tab8_rom_model
 113: 3477+17	2487  CD6424  		call 	putstr8
 114:				
 115: 3494+10	248A  215324  		ld 	hl,msg_fdc
 116: 3504+17	248D  CDC522  		call 	PSTR
 117:				
 118: 3521+13	2490  3AEB23  		ld 	a,(HW_FDC_PRESENT)
 119: 3534+10	2493  112824  		ld 	de,msg_tab16_fdc
 120: 3544+17	2496  CD5B24  		call 	putstr16
 121:				
 122:				; 	ld 	a,'/'
 123:				; 	call 	PUTCH
 124:				
 125:				; 	ld 	a,(HW_ROM_OPTS_CLASS)
 126:				; 	call 	HEX2
 127:				
 128: 3561+10	2499  214A24  		ld 	hl,msg_gzu_size
 129: 3571+17	249C  CDC522  		call 	PSTR
 130:				
 131: 3588+13	249F  3AEA23  		ld 	a,(HW_GZU_SIZE)
 132: 3601+10	24A2  111024  		ld 	de,msg_tab8_gzu_size
 133: 3611+17	24A5  CD6424  		call 	putstr8
 134:				
 135: 3628+10	24A8  215F23  		LD	HL,HCRLF
 136: 3638+17	24AB  CDC522  		CALL	PSTR
 137:				
 138: 3655+10	24AE  C9      		ret
 139:				
 140:				
 141:     -	24AF          	hw_test:
 142: 3665+17	24AF  CD2225  		call 	hw_check_rom
 143: 3682+17	24B2  CDCF24  		call 	hw_check_gzu_size
 144: 3699+17	24B5  CDBC24  		call 	hw_check_floppy
 145: 3716+17	24B8  CD7B24  		call 	show_hardware_info
 146:				
 147:				; 	halt
 148: 3733+10	24BB  C9      		ret
 149:				
 150:     -	24BC          	hw_check_floppy:
 151: 3743+7	24BC  3E01    		ld 	a,1
 152: 3750+10	24BE  11EB23  		ld 	de,HW_FDC_PRESENT
 153: 3760+7	24C1  12      		ld 	(de),a
 154:				
 155:				; Проверка наличия дисководов
 156: 3767+10	24C2  2119FB  		LD	HL,0FB19H 	; регистр дорожки
 157: 3777+10	24C5  3605    		LD	(HL),5		; записываем образец
 158: 3787+7	24C7  7E      		LD	A,(HL)
 159: 3794+7	24C8  FE05    		CP	5		; проверяем
 160: 3801+5+6	24CA  C8      		RET 	Z		; совпал - FDC у нас есть
 161: 3806+7	24CB  3E00    		ld 	a,0
 162: 3813+7	24CD  12      		ld 	(de),a
 163: 3820+10	24CE  C9      		ret
 164:				; В машине нет FDC
 165:				; 	XOR	A	
 166:				; 	LD	(CPMT02-2),A	; Очищаем маски дисков C и D
 167:				; 	LD	(CPMT03-2),A	; Они становятся эмулируемыми
 168:				; 	RET	ret 
 169:				
 170:     -	FE3A          	NCREG 	equ 	0xFE3A
 171:     -	FFBF          	VIREG 	equ 	0xFFBF
 172:				
 173:     -	24CF          	hw_check_gzu_size:
 174:				; 	проверка ГЗУ, не убивая рамдиск в 1+ страницах
 175:				; 	включаем 0 страницу на доступ
 176:				; 	в последние 3 байта пишем значения
 177:				; 	включаем 3 страницу на доступ
 178:				; 	проверяем содержимое этих байт
 179:				; 	если совпало то 48к (т.к. переключение не проихошло)
 180:				; 	иначе счетаем что 192к
 181:				
 182:				
 183:				;3C  DOSG1          0000-3FFF  4000  8000-FDFF        FF00        FE00
 184: 3830+7	24CF  3E3C    		ld 	a,0x3C
 185: 3837+13	24D1  327FFA  		ld 	(SYSREG14),a
 186:				
 187: 3850+10	24D4  21FF7F  	        ld      hl, 07FFFh 	;last gzu byte
 188:				
 189:					; vireg pointed to RW page 0
 190:				
 191: 3860+7	24D7  3EA4    	        ld      a,0x80 | 4 | 0x20 ;color 2 - green (должен быть не 1)
 192: 3867+13	24D9  32BFFF  	        ld      (VIREG), a
 193:				
 194: 3880+10	24DC  01AA55  	        ld 	bc,0x55aa
 195: 3890+7	24DF  70      	        ld      (hl), b   
 196: 3897+6	24E0  2B      	        dec 	hl
 197: 3903+7	24E1  71      	        ld 	(hl), c
 198: 3910+6	24E2  2B      	        dec 	hl
 199: 3916+7	24E3  75      	        ld 	(hl), l
 200: 3923+6	24E4  23      	        inc 	hl
 201: 3929+6	24E5  23      	        inc 	hl
 202:				
 203: 3935+7	24E6  3EE0    	        ld      a, 0xE0 	;SCR_PAGE0|ATTR_RESET|RW_PAGE3
 204: 3942+13	24E8  323AFE  	        ld      (NCREG), a
 205:				
 206:				        ;читаем инвертированные значения не 0x55aa а 0xaa55
 207: 3955+4	24EB  79      	        ld 	a,c 		
 208: 3959+7	24EC  BE      	        cp 	m
 209: 3966+10	24ED  C20325  	        jp 	nz,.zgu192k
 210: 3976+6	24F0  2B      	        dec 	hl
 211: 3982+4	24F1  78      	        ld 	a,b
 212: 3986+7	24F2  BE      	        cp 	m
 213: 3993+10	24F3  C20325  	        jp 	nz,.zgu192k
 214: 4003+6	24F6  2B      	        dec 	hl
 215: 4009+4	24F7  7D      	        ld 	a,l
 216: 4013+7	24F8  EEFF    	        xor 	0xff
 217: 4020+7	24FA  BE      	        cp 	m
 218: 4027+10	24FB  C20325  	        jp 	nz,.zgu192k
 219:				
 220: 4037+7	24FE  3E01    	        ld 	a,_HW_GZU_SIZE_48K
 221: 4044+10	2500  C30525  	        jp      .setgzusize 
 222:				
 223:     -	2503          	.zgu192k:
 224: 4054+7	2503  3E02    	        ld 	a,_HW_GZU_SIZE_192K
 225:				
 226:     -	2505          	.setgzusize:
 227: 4061+13	2505  32EA23  	        ld      (HW_GZU_SIZE),a
 228:				
 229: 4074+7	2508  3E20    	        ld 	a,0x20		;SCR_PAGE0|ATTR_RESET|RW_PAGE0
 230: 4081+13	250A  323AFE  	        ld      (NCREG),a  	
 231:				
 232:				        ;стереть следы проверки
 233: 4094+7	250D  3E92    	        ld      a,0x80 | 2 | 0x10 ;color 1 - blue
 234: 4101+13	250F  32BFFF  	        ld      (VIREG), a
 235: 4114+10	2512  21FF7F  	        ld 	hl,0x7fff
 236: 4124+7	2515  3EFF    	        ld 	a,0xff
 237: 4131+7	2517  77      	        ld 	(hl),a
 238: 4138+6	2518  2B      	        dec 	hl
 239: 4144+7	2519  77      	        ld 	(hl),a
 240: 4151+6	251A  2B      	        dec 	hl
 241: 4157+7	251B  77      	        ld 	(hl),a
 242:				
 243: 4164+7	251C  3E14    		ld 	a,0x14;
 244: 4171+13	251E  327FFF  		ld 	(SYSREG3C),a
 245:				
 246: 4184+10	2521  C9      		ret
 247:				
 248:     -	2522          	hw_check_rom:
 249: 4194+10	2522  210000  		ld 	hl,0
 250: 4204+7	2525  0E00    		ld 	c,0
 251: 4211+4	2527  3F      		ccf
 252:     -	2528          	.romcrc:
 253: 4215+4	2528  79      		ld 	a,c
 254: 4219+7	2529  8E      		adc 	a,(hl)
 255: 4226+4	252A  4F      		ld 	c,a
 256: 4230+6	252B  23      		inc 	hl
 257: 4236+4	252C  7D      		ld 	a,l
 258: 4240+4	252D  B7      		or 	a
 259: 4244+10	252E  C22825  		jp 	nz,.romcrc
 260: 4254+4	2531  79      		ld 	a,c
 261:				
 262: 4258+7	2532  0601    		ld 	b,_HW_ROM_OPTS1
 263: 4265+7	2534  0E01    		ld 	c,_HW_ROM_MODEL_OPTS11
 264: 4272+7	2536  FE9A    		cp 	0x9A
 265: 4279+10	2538  CA4D25  		jp 	z,.rom_found
 266:				
 267: 4289+7	253B  0E03    		ld 	c,_HW_ROM_MODEL_KVANT8
 268: 4296+7	253D  FE66    		cp 	0x66
 269: 4303+10	253F  CA4D25  		jp 	z,.rom_found
 270:				
 271: 4313+7	2542  0602    		ld 	b,_HW_ROM_OPTS2
 272: 4320+7	2544  0E02    		ld 	c,_HW_ROM_MODEL_OPTS20
 273: 4327+7	2546  FEBB    		cp 	0xBB
 274: 4334+10	2548  CA4D25  		jp 	z,.rom_found
 275:				
 276: 4344+7	254B  0E00    		ld 	c,0
 277:     -	254D          	.rom_found:
 278: 4351+4	254D  78      		ld 	a,b
 279: 4355+13	254E  32E823  		ld 	(HW_ROM_OPTS_CLASS),a
 280: 4368+4	2551  79      		ld 	a,c
 281: 4372+13	2552  32E923  		ld 	(HW_ROM_MODEL),a
 282:				
**** stage2.asm ****
 638: 4385+10	2555  C9      		ret
 639:					include 	"generator/V0/extrom-patcher.asm"
**** generator/V0/extrom-patcher.asm ****
   1:				;по адресу bios_variants табличка ссылок на все известные биосы
   2:				;пробуем выяснить какой биос загружен сейчас.
   3:				;если не нашли - fallback to default forth32 cp/m bios
   4:				;TODO: fallback to microdos if required
   5:				;TODO: ask user about fallback
   6:				
   7:				;алгоритм патчера
   8:				;на момент статрта в памяти уже есть загруженый в свои адреса биос, проверим что это нужный и пропатчим его
   9:				;проход 1, проверка, читаем байткоды (с доп параметрами) и проверяем что "первый параметр" совпадает, 
  10:				;если нет то считаем что это не нужный нам биос, и надо проверять следующий.
  11:				;проход 2, если на превом проходе всё проверки совпали
  12:				;то проходим и записываем занчение из "второго параметра"
  13:				;заодно выставляем флаги.
  14:				;чеки надо ставить в начале цепочки (по идее)
  15:				;последний байт обязательно p_STOP
  16:				;ругаемся на невалидный токен, для отладки.
  17:				
  18:				;токены патчера и их значения
  19:				
  20:     -	0050          	p_STOP 			EQU 	0x50	;должен быть последним токено в цепочке, патчер
  21:									;за ним следует строка с 0 - имя биоса
  22:									; 	db 	p_STOP
  23:									; 	db 	'21_89___wiza',0
  24:     -	0051          	pW_CHK_PATCH 		EQU	0x51 	;проверить значение СЛОВА, записать новое значение, параметры DW ADDR, OLDVALUE, NEWVALUE
  25:									;на этапе чека проверяем 1й параметр, на этапе патча записываем 2й
  26:									; 	db 	pW_CHK_PATCH
  27:									; 	dw 	0xDCBB+1,0xE06E,0xE06E
  28:     -	0052          	pB_CHK_PATCH 		EQU 	0x52 	;проверить значение БАЙТА, записать новое значение, параметры DW ADDR, DB OLDVALUE, NEWVALUE
  29:									;на этапе чека проверяем 1й параметр, на этапе патча записываем 2й
  30:									; 	db 	pB_CHK_PATCH
  31:									; 	dw 	0xE70A
  32:									; 	db	0x77,0x00
  33:     -	0054          	pW_STORE		EQU 	0x54 	;записать значение СЛОВА, параметры DW ADDR, NEWVALUE
  34:									;на этапе чека игнорируется, на этапе патча - применяем
  35:									; 	db 	pW_STORE
  36:									; 	dw 	0xE06E,r_p_SELDSKDRIVER+1	 
  37:     -	0055          	pNotSupported 		EQU 	0x55 	;выставляет флаг что биос не поддерживается
  38:									;используется для биосов которые детектятся но сейчас не поддерживаются
  39:									;на этапе чека игнорируется
  40:									;	db 	pNotSupported
  41:     -	0056          	pSETFLAG_MICRODOS 	EQU 	0x56	;выставляет флаг что биос текущий биос - микродос (по умолчанию считаем что cp/m)
  42:									;на этапе чека игнорируется
  43:									; 	db 	pSETFLAG_MICRODOS
  44:     -	0057          	pREQUIRED_OPTS1 	EQU 	0x57	;проверить версию ROM, если не ОПТС 1 то вывести сообщение и поставить флг Unsupported
  45:									;на этапе чека игнорируется
  46:									;	db 	pREQUIRED_OPTS2
  47:     -	0058          	pREQUIRED_OPTS2 	EQU 	0x58	;проверить версию ROM, если не ОПТС 2 то вывести сообщение и поставить флг Unsupported
  48:									;на этапе чека игнорируется
  49:									;	db 	pREQUIRED_OPTS2
  50:     -	0059          	pB_MAYBE_PATCH 		EQU 	0x59 	;записать новое значение если старое совпадает, параметры DW ADDR, DB OLDVALUE, NEWVALUE
  51:									;на этапе чека не проверяем
  52:									;на этапа патча проверяем 1й параметр и если совпал записываем 2й
  53:									;применяется для патча текстовых строк которые могут быть изменены
  54:									; 	db 	pB_CHK_PATCH
  55:									; 	dw 	0xE70A
  56:									; 	db	0x77,0x00
  57:     -	005A          	pSubBios		EQU 	0x5A	;записывает значение в переменную flag_subbios 
  58:									;используется чтобы указать какой вариант резидента использовать
  59:									; 	db 	pSubBios
  60:									; 	db 	0
  61:				
  62:				
  63:     -	0000          	DEBUG_TRACE_PATCHER	EQU 	0
  64:				
  65:				stop 	macro msg
  66:					db 	p_STOP
  67:					db 	msg
  68:					db 	0
  69:					endm
  70:				
  71:				dbpatch macro addr,oldbyte,newbyte
  72:					db 	pB_CHK_PATCH
  73:					dw 	addr
  74:					db 	oldbyte,newbyte
  75:					endm
  76:				
  77:				dbpatchmaybe macro addr,oldbyte,newbyte
  78:					db 	pB_MAYBE_PATCH
  79:					dw 	addr
  80:					db 	oldbyte,newbyte
  81:					endm
  82:				
  83:				dwpatch macro addr,oldword,newword
  84:					db 	pW_CHK_PATCH
  85:					dw 	addr
  86:					dw 	oldword,newword
  87:					endm
  88:				
  89:				dwstore macro addr,newword
  90:					db 	pW_STORE
  91:					dw 	newword
  92:					dw 	addr
  93:					endm
  94:				
  95:				setCPM 	macro 	
  96:					endm
  97:				
  98:				setSUBBIOS 	macro  id
  99:					db	pSubBios
 100:					db 	id
 101:					endm
 102:				
 103:				setMICRODOS macro
 104:					db 	pSETFLAG_MICRODOS
 105:					endm
 106:				
 107:				setUNSUPPORTED macro
 108:					db 	pNotSupported
 109:					endm
 110:				
 111:				RQ_OPTS1	macro
 112:					db 	pREQUIRED_OPTS1
 113:					endm
 114:				
 115:				RQ_OPTS2	macro
 116:					db 	pREQUIRED_OPTS2
 117:					endm
 118:				
 119:				RQ_OPTS_ANY	macro
 120:					endm
 121:				
 122:				
 123:     -	2556          	cpm_bios_patcher:
 124:				
 125:					;dirty hasck
 126:					;set jp 0 as first jp
 127:					;strange dos behaviour,
 128:					;sometime hangon when dir
 129: 4395+10	2556  210000  		ld 	hl,0
 130: 4405+16	2559  220120  		ld 	(BASE+1),hl 	;
 131:				
 132: 4421+10	255C  21C025  		ld 	hl,msgPATCHER
 133: 4431+17	255F  CDC522  		call 	PSTR
 134:				
 135:					; mute message for second time (fallback code)
 136: 4448+7	2562  3E00    		ld 	a,0
 137: 4455+13	2564  32C025  		ld 	(msgPATCHER),a
 138:				
 139:				
 140:				; 	call 	get_rom_version
 141:				
 142: 4468+10	2567  11552F  		ld 	de,bios_variants
 143:     -	256A          	chk_bios_lp:
 144: 4478+7	256A  1A      		ld 	a,(de)
 145: 4485+4	256B  6F      		ld 	l,a
 146: 4489+6	256C  13      		inc 	de
 147: 4495+7	256D  1A      		ld 	a,(de)
 148: 4502+4	256E  67      		ld 	h,a
 149: 4506+6	256F  13      		inc 	de
 150: 4512+4	2570  B5      		or 	l
 151: 4516+10	2571  CA7F25  		jp 	z,bios_not_found
 152:				
 153: 4526+11	2574  D5      		push 	de
 154: 4537+17	2575  CD7326  		call 	try_bios
 155: 4554+10	2578  D1      		pop 	de
 156:				
 157: 4564+10	2579  CA8825  		jp 	z,bios_found
 158:				
 159: 4574+10	257C  C36A25  		jp 	chk_bios_lp
 160:				
 161:				
 162:     -	257F          	bios_not_found:
 163:				
 164: 4584+10	257F  21EF25  		ld 	hl,msgNOTFOUND
 165: 4594+17	2582  CDC522  		call 	PSTR
 166:					
 167:				; 	halt
 168:				
 169: 4611+10	2585  C33020  		jp 	force_subst
 170:				
 171:     -	2588          	bios_found:
 172: 4621+6	2588  2B      		dec 	hl
 173: 4627+7	2589  7E      		ld 	a,(hl)
 174: 4634+6	258A  23      		inc 	hl
 175: 4640+7	258B  FE50    		cp 	p_STOP
 176: 4647+10	258D  CA9725  		jp 	z,.found_cont
 177:				
 178: 4657+10	2590  217A28  		ld 	hl,msg_StrangeHLAfterPatch
 179: 4667+17	2593  CDC522  		call 	PSTR
 180: 4684+4	2596  76      		halt
 181:				
 182:     -	2597          	.found_cont:
 183: 4688+11	2597  E5      		push 	hl 		;bios name
 184: 4699+10	2598  21E425  		ld 	hl,msgFOUND
 185: 4709+17	259B  CDC522  		call 	PSTR
 186: 4726+10	259E  E1      		pop 	hl
 187: 4736+17	259F  CDC522  		call 	PSTR
 188: 4753+10	25A2  212826  		ld 	hl,msgCRLF
 189: 4763+17	25A5  CDC522  		call 	PSTR
 190:				
 191: 4780+16	25A8  2ABE25  		ld 	hl,(msg_warning)
 192: 4796+4	25AB  7D      		ld 	a,l
 193: 4800+4	25AC  B4      		or 	h
 194: 4804+10+7	25AD  C4C522  		call 	nz,PSTR
 195:				
 196: 4814+13	25B0  3ABB25  		ld 	a,(flag_unsupported)
 197: 4827+4	25B3  B7      		or 	a
 198: 4831+10	25B4  C27F25  		jp 	nz,bios_not_found
 199:				
 200: 4841+17	25B7  CD0F29  	 	call 	show_mount_info
 201:				
 202:				; 	halt
 203: 4858+10	25BA  C9      		ret
 204:				
 205:				; get_rom_version:
 206:				; ;opts1.1
 207:				; ; RAM:003B FF                       db 0FFh
 208:				; ;opts2.0
 209:				; ; RAM:003B 02                       db    2
 210:				; ; kontur
 211:				; ; RAM:003B 05                       dec     b
 212:				; ;kvant8 terminal 
 213:				; ; RAM:003B 00                       db    0
 214:				; ;kvant8 - tigris
 215:				; ; RAM:003B FF                       db 0FFh
 216:				
 217:				; ; RAM:050F EF F0 F4+msgOPTS:        text "KOI8-R", 'OPTS  1.1',0
 218:				; ; RAM:051B EF F0 F4+Logo1:          text "KOI8-R", 'OPTS  2.0',0 
 219:				; 	ld 	a,(0x003b)
 220:				; 	cp 	0xff
 221:				; 	jp 	z,.opts1
 222:				
 223:				; 	cp 	2
 224:				; 	jp 	z,.opts2
 225:				
 226:				; .opts1:
 227:				; 	ld 	a,'1'
 228:				; 	db 	0x21
 229:				; .opts2:
 230:				; 	ld 	a,'2'	
 231:				; 	ld 	(rom_version),a
 232:				; 	ret
 233:				
 234:				; rom_version:
 235:				; 	db 	0 	;1 - opts1, 2-opts2
 236:				
 237:				
 238:				
 239:     -	25BB          	flag_unsupported:
 240:     -	25BB  00      		db 	0
 241:     -	25BC          	flag_microdos:
 242:     -	25BC  00      		db 	0	
 243:     -	25BD          	flag_subbios:
 244:     -	25BD  00      		db 	0
 245:     -	25BE          	msg_warning:
 246:     -	25BE  0000    		dw 	0
 247:				
 248:				
 249:     -	25C0          	msgPATCHER:
 250:     -	25C0  0D0A4249		db 	0dh,0ah,'BIOS PATCHER V 1.52 by ESL 2014',0dh,0ah,0
	      4F532050
	      41544348
	      45522056
	      20312E35
	      32206279
	      2045534C
	      20323031
	      340D0A00
 251:     -	25E4          	msgFOUND:
 252:     -	25E4  44657465		db 	'Detected: ',0
	      63746564
	      3A2000
 253:     -	25EF          	msgNOTFOUND:
 254:     -	25EF  42494F53		db 	'BIOS Unsupported or Broken, '
	      20556E73
	      7570706F
	      72746564
	      206F7220
	      42726F6B
	      656E2C20
 255:     -	260B  1B36    		db 	01bh,'6'
 256:     -	260D  66616C6C		db 	'fallback to DEFAULT bios.'
	      6261636B
	      20746F20
	      44454641
	      554C5420
	      62696F73
	      2E
 257:     -	2626  1B37    		db 	01bh,'7'
 258:     -	2628          	msgCRLF:
 259:     -	2628  0D0A00  		db 	0dh,0ah,0
 260:				
 261:     -	262B          	msgREQ_OPTS:
 262:     -	262B  20212120		db 	' !! '
 263:     -	262F  1B36    		db 	01bh,'6'
 264:     -	2631  42494F53		db 	'BIOS require OPTS '
	      20726571
	      75697265
	      204F5054
	      5320
 265:     -	2643          	msgREQ_OPTS_digit:
 266:     -	2643  312E7820		db 	'1.x ROM'
	      524F4D
 267:     -	264A  1B37    		db 	01bh,'7'
 268:     -	264C  20616E64		db 	' and not compatible with current.'
	      206E6F74
	      20636F6D
	      70617469
	      626C6520
	      77697468
	      20637572
	      72656E74
	      2E
 269:     -	266D  0D0A    		db 	0dh,0ah
 270:     -	266F  00      		db 	0
 271:				
 272:     -	2670          	work_ptr:
 273:     -	2670  0000    		dw 	0;
 274:     -	2672          	patch_flag:
 275:     -	2672  00      		db 	0
 276:				
 277:				;проверит совпадает ли биос с табличкой
 278:				;на входе в HL табличка для биоса
 279:				;если совпало то HL укзывает на имя биоса
 280:     -	2673          	try_bios:
 281: 4868+16	2673  227026  		ld 	(work_ptr),hl
 282:				
 283:					;check
 284: 4884+4	2676  AF      		xor 	a
 285: 4888+16	2677  2A7026  		ld 	hl,(work_ptr)
 286: 4904+17	267A  CD2C27  		call 	do_patch
 287: 4921+5+6	267D  C0      		ret nz
 288:				
 289:				; 	halt
 290:				
 291:					;скопировали резидент в дырку
 292:				
 293:					;preprare to PATCH
 294:				
 295:					;copy resident
 296:				
 297: 4926+13	267E  3ABC25  		ld 	a,(flag_microdos)
 298: 4939+4	2681  B7      		or 	a
 299: 4943+10	2682  C2FE26  		jp 	nz,move_microdos_resident
 300:				
 301: 4953+13	2685  3ABD25  		ld 	a,(flag_subbios)
 302: 4966+7	2688  FE01    		cp 	1
 303: 4973+10	268A  CA9D26  		jp 	z,.cpmsubBios1
 304: 4983+7	268D  FE02    		cp 	2
 305: 4990+10	268F  CAAF26  		jp 	z,.cpmsubBios2
 306: 5000+7	2692  FE03    		cp 	3 			;no resident part
 307: 5007+10	2694  CAC126  		jp 	z,.cpmNoResident
 308:				
 309: 5017+10	2697  215728  		ld 	hl,msgUndefindedsubBios
 310: 5027+17	269A  CDC522  		call 	PSTR
 311:				; 	halt
 312:				
 313:				
 314:     -	269D          	.cpmsubBios1:
 315:				
 316: 5044+10	269D  21ACE8  		ld 	hl,_CPM1_res_DRIVE_TAB
 317: 5054+16	26A0  226F2A  		ld 	(drivetab_mount_info),hl
 318:				
 319: 5070+10	26A3  21172B  		ld 	hl,resident_cpm1
 320: 5080+10	26A6  11ACE8  		ld 	de,resident_cpm1_addr
 321: 5090+10	26A9  019701  		ld 	bc,resident_cpm1_len
 322:				
 323: 5100+10	26AC  C3BE26  		jp 	.subBiosldir
 324:				
 325:     -	26AF          	.cpmsubBios2:
 326: 5110+10	26AF  2106EA  		ld 	hl,_CPM2_res_DRIVE_TAB
 327: 5120+16	26B2  226F2A  		ld 	(drivetab_mount_info),hl
 328:				
 329: 5136+10	26B5  21AE2C  		ld 	hl,resident_cpm2
 330: 5146+10	26B8  1106EA  		ld 	de,resident_cpm2_addr
 331: 5156+10	26BB  019701  		ld 	bc,resident_cpm2_len
 332:				
 333:     -	26BE          	.subBiosldir:
 334: 5166+17	26BE  CDCE28  		call	_p_ldir
 335:				
 336:     -	26C1          	.cpmNoResident:
 337: 5183+7	26C1  3E01    		ld 	a,1
 338: 5190+16	26C3  2A7026  		ld 	hl,(work_ptr)
 339: 5206+17	26C6  CD2C27  		call 	do_patch
 340:				
 341:				; 	halt
 342:				
 343: 5223+16	26C9  222A27  		ld 	(hl_after_do_patch_patch),hl
 344:				
 345:					;если дисководов нет то диски C и D - эмулируемые
 346: 5239+13	26CC  3AEB23  		ld 	a,(HW_FDC_PRESENT)
 347: 5252+4	26CF  B7      		or 	a
 348: 5256+10	26D0  C22527  		jp 	nz,patch_done
 349:				
 350:				
 351: 5266+13	26D3  3ABD25  		ld 	a,(flag_subbios)
 352: 5279+10	26D6  21ACE8  		ld 	hl,_CPM1_res_DRIVE_TAB
 353: 5289+7	26D9  FE01    		cp 	1
 354: 5296+10	26DB  CAE926  		jp 	z,.cpmRemapCD
 355:				
 356: 5306+10	26DE  2106EA  		ld 	hl,_CPM2_res_DRIVE_TAB
 357: 5316+7	26E1  FE02    		cp 	2
 358: 5323+10	26E3  CAE926  		jp 	z,.cpmRemapCD
 359:				
 360: 5333+10	26E6  C32527  		jp 	patch_done 	;no need to patch
 361:				
 362:				
 363:     -	26E9          	.cpmRemapCD:
 364:				
 365:				
 366: 5343+11	26E9  D5      		push 	de
 367: 5354+10	26EA  110400  		ld	de,2*2
 368: 5364+11	26ED  19      		add 	hl,de
 369: 5375+7	26EE  3E00    		ld 	a,0 ;0=use emu
 370:				
 371: 5382+7	26F0  5E      		ld 	e,(hl)
 372: 5389+6	26F1  23      		inc 	hl
 373: 5395+7	26F2  56      		ld 	d,(hl)
 374: 5402+6	26F3  23      		inc 	hl
 375: 5408+7	26F4  12      		ld 	(de),a 	;drive C - emu
 376:				
 377:				
 378: 5415+7	26F5  5E      		ld 	e,(hl)
 379: 5422+6	26F6  23      		inc 	hl
 380: 5428+7	26F7  56      		ld 	d,(hl)
 381: 5435+6	26F8  23      		inc 	hl
 382: 5441+7	26F9  12      		ld 	(de),a	;drive D - emu
 383:				
 384: 5448+10	26FA  D1      		pop 	de
 385:				
 386: 5458+10	26FB  C32527  		jp 	patch_done
 387:				
 388:     -	26FE          	move_microdos_resident:
 389:				
 390:				
 391: 5468+10	26FE  2102FA  		ld 	hl,md_res_DRIVE_TAB
 392: 5478+16	2701  226F2A  		ld 	(drivetab_mount_info),hl
 393:				
 394:					;microdos
 395: 5494+7	2704  3E5C    		ld 	a,0x5c
 396: 5501+13	2706  327FFA  		ld 	(SYSREG14),a
 397:				
 398: 5514+10	2709  21452E  		ld 	hl,resident_md
 399: 5524+10	270C  1100FA  		ld 	de,resident_md_addr
 400: 5534+10	270F  011001  		ld 	bc,resident_md_len
 401: 5544+17	2712  CDCE28  		call	_p_ldir
 402:				
 403: 5561+7	2715  3E01    		ld 	a,1
 404: 5568+16	2717  2A7026  		ld 	hl,(work_ptr)
 405: 5584+17	271A  CD2C27  		call 	do_patch
 406: 5601+16	271D  222A27  		ld 	(hl_after_do_patch_patch),hl
 407:				
 408: 5617+7	2720  3E14    		ld 	a,0x14
 409: 5624+13	2722  327FFF  		ld 	(SYSREG5C),a
 410:				
 411:				
 412:				; 	HALT
 413:     -	2725          	patch_done:
 414: 5637+16	2725  2A2A27  		ld 	hl,(hl_after_do_patch_patch)
 415:				
 416: 5653+4	2728  AF      		xor 	a
 417: 5657+10	2729  C9      		ret
 418:     -	272A          	hl_after_do_patch_patch:
 419:     -	272A  0000    		dw 	0
 420:     -	272C          	do_patch:
 421: 5667+13	272C  327226  		ld 	(patch_flag),a
 422:				
 423:     -	0000          		if DEBUG_TRACE_PATCHER
 451:					endif
 452:				
 453: 5680+7	272F  3E00    		ld 	a,0
 454: 5687+13	2731  32BC25  		ld 	(flag_microdos),a
 455: 5700+13	2734  32BD25  		ld 	(flag_subbios),a
 456:				
 457:     -	2737          	patch_loop:
 458:				
 459: 5713+7	2737  7E      		ld 	a,(hl)
 460: 5720+6	2738  23      		inc 	hl
 461:     -	0000          		if DEBUG_TRACE_PATCHER
 474:					endif
 475:				
 476: 5726+7	2739  FE50    		cp 	p_STOP
 477: 5733+5+6	273B  C8      		ret 	z 	;FOUND
 478:				
 479:     -	273C          	B_CHK_PATCH:
 480: 5738+7	273C  FE52    		cp 	pB_CHK_PATCH
 481: 5745+10	273E  C25F27  		jp 	nz,B_CHK_MAYBE
 482:				
 483: 5755+17	2741  CDC928  		call 	fetch_dw_to_bc 	;BC addr
 484: 5772+11	2744  C5      		push 	bc
 485: 5783+17	2745  CDCB28  		call 	fetch_db_to_b 	;b
 486:				
 487: 5800+4	2748  EB      		ex 	de,hl
 488: 5804+10	2749  E1      		pop 	hl
 489: 5814+7	274A  7E      		ld 	a,(hl)
 490: 5821+4	274B  EB      		ex 	de,hl 		;de - addr
 491:				
 492: 5825+4	274C  48      		ld 	c,b
 493:				
 494: 5829+17	274D  CDCB28  		call 	fetch_db_to_b 	;b store
 495:				
 496: 5846+4	2750  B9      		cp 	c
 497: 5850+5+6	2751  C0      		ret 	nz
 498:				
 499:				
 500: 5855+13	2752  3A7226  		ld 	a,(patch_flag)
 501: 5868+4	2755  B7      		or 	a
 502: 5872+10	2756  CA3727  		jp 	z,patch_loop
 503:				
 504: 5882+4	2759  EB      		ex 	de,hl
 505: 5886+7	275A  70      		ld 	(hl),b
 506: 5893+4	275B  EB      		ex 	de,hl
 507: 5897+10	275C  C33727  		jp 	patch_loop
 508:				
 509:				
 510:     -	275F          	B_CHK_MAYBE:
 511: 5907+7	275F  FE59    		cp 	pB_MAYBE_PATCH
 512: 5914+10	2761  C27D27  		jp 	nz,l_pW_CHK
 513:				
 514: 5924+17	2764  CDC928  		call 	fetch_dw_to_bc 	;BC addr
 515: 5941+11	2767  C5      		push 	bc
 516: 5952+17	2768  CDCB28  		call 	fetch_db_to_b 	;b
 517:				
 518: 5969+4	276B  EB      		ex 	de,hl
 519: 5973+10	276C  E1      		pop 	hl
 520: 5983+7	276D  7E      		ld 	a,(hl)
 521: 5990+4	276E  EB      		ex 	de,hl 		;de - addr
 522:				
 523: 5994+4	276F  48      		ld 	c,b
 524:				
 525: 5998+17	2770  CDCB28  		call 	fetch_db_to_b 	;b store
 526:				
 527: 6015+4	2773  B9      		cp 	c
 528: 6019+10	2774  C23727  		jp  	nz,patch_loop
 529:				
 530: 6029+4	2777  EB      		ex 	de,hl
 531: 6033+7	2778  70      		ld 	(hl),b
 532: 6040+4	2779  EB      		ex 	de,hl
 533: 6044+10	277A  C33727  		jp 	patch_loop
 534:				
 535:				
 536:     -	277D          	l_pW_CHK:
 537: 6054+7	277D  FE51    		cp 	pW_CHK_PATCH
 538: 6061+10	277F  C2A227  		jp 	nz,l_pW_STORE
 539:				
 540: 6071+17	2782  CDC928  		call 	fetch_dw_to_bc 	
 541: 6088+17	2785  CDAE28  		call 	store_bc_to_tmp
 542:				
 543: 6105+17	2788  CDC928  		call 	fetch_dw_to_bc 	;BC OLD value
 544:				
 545: 6122+17	278B  CDC028  		call 	read_de_at_tmp 	;de - value
 546: 6139+17	278E  CDA628  		call 	cp_de_bc
 547:				
 548: 6156+17	2791  CDC928  		call 	fetch_dw_to_bc 	;bc NEW value
 549:				
 550: 6173+5+6	2794  C0      		ret 	nz
 551:				
 552: 6178+13	2795  3A7226  		ld 	a,(patch_flag)
 553: 6191+4	2798  B7      		or 	a
 554: 6195+10	2799  CA3727  		jp 	z,patch_loop
 555:				
 556: 6205+17	279C  CDB728  		call 	store_bc_at_tmp
 557:				
 558: 6222+10	279F  C33727  		jp 	patch_loop
 559:				
 560:     -	27A2          	l_pW_STORE:
 561: 6232+7	27A2  FE54    		cp 	pW_STORE
 562: 6239+10	27A4  C2BF27  		jp 	nz,.pNotSupported
 563:				
 564:				
 565: 6249+17	27A7  CDC928  		call 	fetch_dw_to_bc 	;BC value
 566: 6266+11	27AA  C5      		push 	bc
 567:				
 568: 6277+17	27AB  CDC928  		call 	fetch_dw_to_bc 	
 569: 6294+17	27AE  CDAE28  		call 	store_bc_to_tmp
 570:				
 571: 6311+10	27B1  C1      		pop 	bc
 572:				
 573: 6321+13	27B2  3A7226  		ld 	a,(patch_flag)
 574: 6334+4	27B5  B7      		or 	a
 575: 6338+10	27B6  CA3727  		jp 	z,patch_loop
 576:				
 577: 6348+17	27B9  CDB728  		call 	store_bc_at_tmp
 578:				
 579: 6365+10	27BC  C33727  		jp 	patch_loop
 580:				
 581:     -	27BF          	.pNotSupported:
 582: 6375+7	27BF  FE55    		cp 	pNotSupported
 583: 6382+10	27C1  C2CE27  		jp 	nz,.pSETFLAG_MICRODOS
 584:				
 585:				
 586: 6392+13	27C4  3A7226  		ld 	a,(patch_flag)
 587: 6405+4	27C7  B7      		or 	a
 588: 6409+10	27C8  CA3727  		jp 	z,patch_loop
 589:				
 590: 6419+10	27CB  C32228  		jp 	Unsupported	
 591:				
 592:     -	27CE          	.pSETFLAG_MICRODOS:
 593: 6429+7	27CE  FE56    		cp 	pSETFLAG_MICRODOS
 594: 6436+10	27D0  C2DB27  		jp 	nz,.pSubBios
 595:				
 596:				; 	ld 	a,(patch_flag)
 597:				; 	or 	a
 598:				; 	jp 	z,patch_loop
 599:				
 600: 6446+7	27D3  3E01    		ld 	a,1
 601: 6453+13	27D5  32BC25  		ld 	(flag_microdos),a
 602: 6466+10	27D8  C33727  		jp 	patch_loop
 603:				
 604:     -	27DB          	.pSubBios:
 605: 6476+7	27DB  FE5A    		cp 	pSubBios
 606: 6483+10	27DD  C2E827  		jp 	nz,.pREQUIRED_OPTS1
 607:				
 608: 6493+7	27E0  7E      		ld 	a,(hl)
 609: 6500+6	27E1  23      		inc 	hl
 610: 6506+13	27E2  32BD25  		ld 	(flag_subbios),a
 611: 6519+10	27E5  C33727  		jp 	patch_loop
 612:				
 613:     -	27E8          	.pREQUIRED_OPTS1:
 614: 6529+7	27E8  FE57    		cp 	pREQUIRED_OPTS1
 615: 6536+10	27EA  C20128  		jp 	nz,.pREQUIRED_OPTS2
 616:				
 617: 6546+13	27ED  3A7226  		ld 	a,(patch_flag)
 618: 6559+4	27F0  B7      		or 	a
 619: 6563+10	27F1  CA3727  		jp 	z,patch_loop
 620:				
 621:				; 	ld 	a,(rom_version)
 622: 6573+13	27F4  3AE823  		ld 	a,(HW_ROM_OPTS_CLASS)
 623: 6586+7	27F7  FE01    		cp 	_HW_ROM_OPTS1
 624: 6593+10	27F9  CA3727  		jp 	z,patch_loop
 625:				
 626: 6603+7	27FC  3E31    		ld 	a,'1'
 627: 6610+10	27FE  C31728  		jp 	set_opts_warning
 628:				
 629:				; 	jp 	patch_loop
 630:				
 631:     -	2801          	.pREQUIRED_OPTS2:
 632: 6620+7	2801  FE58    		cp 	pREQUIRED_OPTS2
 633: 6627+10	2803  C22A28  		jp 	nz,.pHALT
 634:				
 635: 6637+13	2806  3A7226  		ld 	a,(patch_flag)
 636: 6650+4	2809  B7      		or 	a
 637: 6654+10	280A  CA3727  		jp 	z,patch_loop
 638:				
 639:				; 	ld 	a,(rom_version)
 640: 6664+13	280D  3AE823  		ld 	a,(HW_ROM_OPTS_CLASS)
 641: 6677+7	2810  FE02    		cp 	_HW_ROM_OPTS2
 642: 6684+10	2812  CA3727  		jp 	z,patch_loop
 643:				
 644: 6694+7	2815  3E32    		ld 	a,'2'
 645:				
 646:     -	2817          	set_opts_warning:
 647: 6701+13	2817  324326  		ld 	(msgREQ_OPTS_digit),a
 648:				
 649: 6714+11	281A  E5      		push 	hl
 650: 6725+10	281B  212B26  		ld 	hl,msgREQ_OPTS
 651: 6735+16	281E  22BE25  		ld 	(msg_warning),hl
 652: 6751+10	2821  E1      		pop 	hl
 653:				
 654:     -	2822          	Unsupported:
 655: 6761+7	2822  3E01    		ld 	a,1
 656: 6768+13	2824  32BB25  		ld 	(flag_unsupported),a
 657: 6781+10	2827  C33727  		jp 	patch_loop
 658:				
 659:     -	282A          	.pHALT:
 660: 6791+10	282A  213228  		ld 	hl,msg_InvalidPatchCode
 661: 6801+17	282D  CDC522  		call 	PSTR
 662:				
 663: 6818+4	2830  76      		halt
 664:				
 665: 6822+10	2831  C9      		ret
 666:				
 667:     -	2832          	msg_InvalidPatchCode:
 668:     -	2832  496E7661		db 	'Invalid patchcode, check registers',0dh,0ah,0
	      6C696420
	      70617463
	      68636F64
	      652C2063
	      6865636B
	      20726567
	      69737465
	      72730D0A
	      00
 669:     -	2857          	msgUndefindedSubBios:
 670:     -	2857  43502F4D		db 	'CP/M subbios not defined, halted',0dh,0ah,0
	      20737562
	      62696F73
	      206E6F74
	      20646566
	      696E6564
	      2C206861
	      6C746564
	      0D0A00
 671:     -	287A          	msg_StrangeHLAfterPatch:
 672:     -	287A  496E7661		db 	'Invalid HL after patch, no p_STOP before!',0dh,0ah,0
	      6C696420
	      484C2061
	      66746572
	      20706174
	      63682C20
	      6E6F2070
	      5F53544F
	      50206265
	      666F7265
	      210D0A00
 673:     -	28A6          	cp_de_bc:
 674: 6832+4	28A6  7B      		ld 	a,e
 675: 6836+4	28A7  B9      		cp 	c
 676: 6840+5+6	28A8  C0      		ret 	nz
 677: 6845+4	28A9  7A      		ld 	a,d
 678: 6849+4	28AA  B8      		cp 	b
 679: 6853+10	28AB  C9      		ret
 680:				
 681:     -	28AC  0000    	tmp: 	dw 	0
 682:				
 683:				;stor bc to tmp
 684:     -	28AE          	store_bc_to_tmp:
 685: 6863+4	28AE  79      		ld 	a,c
 686: 6867+13	28AF  32AC28  		ld 	(tmp),a
 687:				
 688: 6880+4	28B2  78      		ld 	a,b
 689: 6884+13	28B3  32AD28  		ld 	(tmp+1),a
 690: 6897+10	28B6  C9      		ret
 691:				
 692:     -	28B7          	store_bc_at_tmp:
 693: 6907+11	28B7  E5      		push 	hl
 694: 6918+16	28B8  2AAC28  		ld 	hl,(tmp)
 695: 6934+7	28BB  71      		ld 	(hl),c
 696: 6941+6	28BC  23      		inc 	hl
 697: 6947+7	28BD  70      		ld 	(hl),b
 698: 6954+10	28BE  E1      		pop 	hl
 699: 6964+10	28BF  C9      		ret
 700:				
 701:				;de - value at (tmp)
 702:     -	28C0          	read_de_at_tmp:
 703: 6974+11	28C0  E5      		push 	hl
 704: 6985+16	28C1  2AAC28  		ld 	hl,(tmp)
 705:				
 706: 7001+7	28C4  5E      		ld 	e,(hl)
 707: 7008+6	28C5  23      		inc 	hl
 708: 7014+7	28C6  56      		ld 	d,(hl)
 709:				
 710: 7021+10	28C7  E1      		pop 	hl
 711: 7031+10	28C8  C9      		ret
 712:				
 713:				
 714:     -	28C9          	fetch_dw_to_bc:
 715: 7041+7	28C9  4E      		ld 	c,(hl)
 716: 7048+6	28CA  23      		inc 	hl
 717:     -	28CB          	fetch_db_to_b:
 718: 7054+7	28CB  46      		ld 	b,(hl)
 719: 7061+6	28CC  23      		inc 	hl
 720: 7067+10	28CD  C9      		ret
 721:				
 722:     -	28CE          	_p_ldir:
 723: 7077+7	28CE  7E      		ld 	a,(hl)
 724: 7084+7	28CF  12      		ld 	(de),a
 725: 7091+6	28D0  23      		inc 	hl
 726: 7097+6	28D1  13      		inc 	de
 727: 7103+6	28D2  0B      		dec 	bc
 728: 7109+4	28D3  79      		ld 	a,c
 729: 7113+4	28D4  B0      		or 	b
 730: 7117+10	28D5  C2CE28  		jp 	nz,_p_ldir
 731: 7127+10	28D8  C9      		ret
 732:				
 733:					include 	"mount_info.asm"
**** mount_info.asm ****
   1:     -	0080          	API_GET_MOUNT_NAME	EQU	0x80
   2:     -	0082          	API_GET_MOUNT_STATUS 	EQU	0x82
   3:				
   4:				; x123:
   5:				; 	db 0dh,0ah
   6:				; 	db '0         1         2         3         4         5         6   '
   7:				; 	db '0123456789012345678901234567890123456789012345678901234567890123'
   8:				; 	db 0
   9:				
  10:     -	28D9          	msgBootFromImage:
  11:     -	28D9  2D2D4558		db 	'--EXTROM: Booting from image: ',0
	      54524F4D
	      3A20426F
	      6F74696E
	      67206672
	      6F6D2069
	      6D616765
	      3A2000
  12:     -	28F8          	show_boot_image_name:
  13: 7137+10	28F8  21D928  		ld 	hl,msgBootFromImage
  14: 7147+17	28FB  CDC522  		call 	PSTR
  15:				
  16:				
  17: 7164+13	28FE  32E722  		ld 	(DRV),a
  18:				
  19: 7177+7	2901  3E00    		ld 	a,0
  20: 7184+13	2903  32B72A  		ld 	(drive_rw_status),a
  21: 7197+17	2906  CD582A  		call 	get_mount_info
  22: 7214+17	2909  CDF629  		call 	build_emu_name
  23:				
  24: 7231+10	290C  C38C29  		jp 	show_disk_info
  25:				
  26:     -	290F          	show_mount_info:
  27:				
  28: 7241+10	290F  21712A  		ld 	hl,msg_default_mount
  29: 7251+17	2912  CDC522  		call 	PSTR
  30:					
  31: 7268+7	2915  3E00    		ld 	a,0
  32: 7275+17	2917  CD3529  		call 	show_mount_drive
  33:				
  34: 7292+7	291A  3E01    		ld 	a,1
  35: 7299+17	291C  CD3529  		call 	show_mount_drive
  36:				
  37: 7316+7	291F  3E02    		ld 	a,2
  38: 7323+17	2921  CD3529  		call 	show_mount_drive
  39:				
  40: 7340+7	2924  3E03    		ld 	a,3
  41: 7347+17	2926  CD3529  		call 	show_mount_drive
  42:				
  43:				; 	ld 	hl,mount_crlf
  44:				; 	call 	PSTR
  45:				
  46:					;show info about drive F 	
  47: 7364+13	2929  3ABC25  		ld 	a,(flag_microdos)
  48: 7377+4	292C  B7      		or 	a
  49: 7381+5+6	292D  C0      		ret 	nz	
  50:				
  51: 7386+10	292E  21D82A  		ld 	hl,msgDRIVE_F
  52: 7396+17	2931  CDC522  		call 	PSTR
  53:				
  54: 7413+10	2934  C9      		ret
  55:				
  56:     -	2935          	show_mount_drive:
  57: 7423+13	2935  32E722  		ld 	(DRV),a
  58:				
  59: 7436+7	2938  3E00    		ld 	a,0
  60: 7443+13	293A  32B72A  		ld 	(drive_rw_status),a
  61:				
  62: 7456+17	293D  CDC129  		call 	get_drvinfo_ptr
  63: 7473+10	2940  CA9729  		jp 	z,skip_disk 	;de=0, no drive at all
  64:				
  65: 7483+7	2943  1A      		ld 	a,(de)
  66: 7490+4	2944  B7      		or 	a
  67: 7494+10	2945  C25429  		jp 	nz,.physical_drive
  68:				
  69: 7504+17	2948  CD582A  		call 	get_mount_info
  70: 7521+17	294B  CD9829  		call 	build_disk_name
  71: 7538+17	294E  CDF629  		call 	build_emu_name
  72:				
  73: 7555+10	2951  C38C29  		jp 	show_disk_info
  74:				
  75:				
  76:     -	2954          	.physical_drive:
  77:				
  78: 7565+11	2954  F5      		push 	af
  79: 7576+17	2955  CD9829  		call 	build_disk_name
  80: 7593+10	2958  F1      		pop 	af
  81:				
  82: 7603+7	2959  0E41    		ld 	c,'A'
  83: 7610+7	295B  FE01    		cp 	0001b
  84: 7617+10	295D  CA7B29  		jp 	z,fdd_found
  85: 7627+7	2960  0E42    		ld 	c,'B'
  86: 7634+7	2962  FE02    		cp 	0010b
  87: 7641+10	2964  CA7B29  		jp 	z,fdd_found
  88: 7651+7	2967  0E43    		ld 	c,'C'
  89: 7658+7	2969  FE04    		cp 	0100b
  90: 7665+10	296B  CA7B29  		jp 	z,fdd_found
  91: 7675+7	296E  0E44    		ld 	c,'D'
  92: 7682+7	2970  FE08    		cp 	1000b
  93: 7689+10	2972  CA7B29  		jp 	z,fdd_found
  94:				
  95: 7699+10	2975  21AD2A  		ld 	hl,msg_fdd_err
  96: 7709+10	2978  C38229  		jp 	.cpfddname
  97:				
  98:     -	297B          	fdd_found:
  99: 7719+4	297B  79      		ld 	a,c
 100: 7723+13	297C  32AB2A  		ld 	(msg_fdd_drv),a
 101:				
 102: 7736+10	297F  21A42A  		ld 	hl,msg_fdd
 103:				
 104:     -	2982          	.cpfddname
 105:				
 106: 7746+10	2982  11832A  		ld 	de,out_buffer
 107: 7756+7	2985  0E20    		ld 	c,32
 108: 7763+7	2987  060E    		ld 	b,14
 109: 7770+17	2989  CD192A  		call 	append_z
 110:				
 111:     -	298C          	show_disk_info:
 112:				
 113: 7787+10	298C  21832A  		ld 	hl,out_buffer
 114: 7797+7	298F  0E21    		ld 	c,32+1
 115: 7804+17	2991  CD3D2A  		call 	fix_width
 116: 7821+17	2994  CDC522  		call 	PSTR
 117:				
 118:				; 	ld 	hl,mount_crlf
 119:				; 	call 	PSTR
 120:				
 121:     -	2997          	skip_disk:
 122: 7838+10	2997  C9      		ret
 123:				
 124:     -	2998          	build_disk_name:
 125: 7848+4	2998  AF      		xor 	a
 126: 7852+13	2999  32832A  		ld 	(out_buffer+00),a
 127:				; 	ld 	(out_buffer+32),a
 128:				
 129: 7865+13	299C  3AE722  		ld 	a,(DRV)
 130: 7878+7	299F  C641    		add 	a,'A'
 131: 7885+13	29A1  327E2A  		ld 	(mount_msg_drv),a
 132:				
 133: 7898+10	29A4  015257  		ld 	bc,'RW'
 134: 7908+13	29A7  3AB72A  		ld 	a,(drive_rw_status)
 135: 7921+4	29AA  B7      		or 	a
 136: 7925+4	29AB  79      		ld 	a,c
 137: 7929+10	29AC  C2B029  		jp 	nz,.rw
 138: 7939+4	29AF  78      		ld 	a,b
 139:     -	29B0          	.rw:
 140: 7943+13	29B0  32802A  		ld 	(mount_msg_rw),a
 141:				
 142:				;--
 143: 7956+10	29B3  11832A  		ld 	de,out_buffer
 144: 7966+10	29B6  217E2A  		ld 	hl,mount_msg
 145: 7976+7	29B9  0E20    		ld 	c,32
 146: 7983+7	29BB  060E    		ld 	b,14
 147: 7990+17	29BD  CD192A  		call 	append_z
 148:				
 149: 8007+10	29C0  C9      		ret
 150:				
 151:				;in (DRV)
 152:				;de - addr
 153:				;z=0 if de=0
 154:     -	29C1          	get_drvinfo_ptr:
 155: 8017+11	29C1  E5      		push 	hl
 156: 8028+13	29C2  3AE722  		ld 	a,(DRV)
 157: 8041+4	29C5  87      		add 	a,a
 158: 8045+4	29C6  5F      		ld 	e,a
 159: 8049+7	29C7  1600    		ld 	d,0
 160: 8056+16	29C9  2A6F2A  		ld 	hl,(drivetab_mount_info)
 161:					
 162: 8072+4	29CC  7C      		ld 	a,h
 163: 8076+4	29CD  B5      		or 	l
 164: 8080+10	29CE  CAD929  		jp 	z,errZeroDrvInfoTab
 165: 8090+11	29D1  19      		add 	hl,de
 166: 8101+7	29D2  5E      		ld 	e,(hl)
 167: 8108+6	29D3  23      		inc 	hl
 168: 8114+7	29D4  56      		ld 	d,(hl)
 169: 8121+4	29D5  7B      		ld 	a,e
 170: 8125+4	29D6  B2      		or 	d
 171: 8129+10	29D7  E1      		pop 	hl
 172: 8139+10	29D8  C9      		ret
 173:     -	29D9          	errZeroDrvInfoTab:
 174: 8149+10	29D9  21E029  		ld 	hl,msgZeroDrvInfoTab
 175: 8159+17	29DC  CDC522  		call 	PSTR
 176: 8176+4	29DF  76      		halt
 177:     -	29E0          	msgZeroDrvInfoTab:
 178:     -	29E0  53686F77		db 	'ShowInfo: DrvTab=0000',0
	      496E666F
	      3A204472
	      76546162
	      3D303030
	      3000
 179:				
 180:     -	29F6          	build_emu_name:
 181:				
 182: 8180+10	29F6  11832A  		ld 	de,out_buffer
 183: 8190+7	29F9  0E20    		ld 	c,32
 184: 8197+7	29FB  060E    		ld 	b,14
 185:				
 186: 8204+10	29FD  21B82A  		ld 	hl,mount_info_from_emu+1
 187: 8214+17	2A00  CD192A  		call 	append_z
 188:					
 189: 8231+7	2A03  3E2F    		ld 	a,'/'
 190: 8238+7	2A05  12      		ld 	(de),a
 191: 8245+6	2A06  13      		inc 	de
 192: 8251+4	2A07  AF      		xor 	a
 193: 8255+7	2A08  12      		ld 	(de),a
 194:				
 195:				
 196: 8262+10	2A09  11832A  		ld 	de,out_buffer
 197: 8272+10	2A0C  21C62A  		ld 	hl,mount_info_from_emu+1+14
 198: 8282+7	2A0F  0E20    		ld 	c,32
 199: 8289+7	2A11  060E    		ld 	b,14
 200: 8296+17	2A13  CD192A  		call 	append_z
 201:				
 202: 8313+4	2A16  AF      		xor 	a
 203: 8317+7	2A17  12      		ld 	(de),a
 204:				
 205: 8324+10	2A18  C9      		ret
 206:				
 207:				
 208:				
 209:				
 210:				;append (skip all not 0 and then copy_z)
 211:     -	2A19          	append_z:
 212: 8334+4	2A19  79      		ld 	a,c
 213: 8338+4	2A1A  B7      		or 	a
 214: 8342+5+6	2A1B  C8      		ret 	z
 215:				
 216: 8347+7	2A1C  7E      		ld 	a,(hl)
 217: 8354+4	2A1D  B7      		or 	a
 218: 8358+5+6	2A1E  C8      		ret 	z
 219:				
 220:     -	2A1F          	.skipAppend:
 221: 8363+7	2A1F  1A      		ld 	a,(de)
 222: 8370+4	2A20  B7      		or 	a
 223: 8374+10	2A21  CA2C2A  		jp 	z,copy_z
 224: 8384+6	2A24  13      		inc 	de
 225: 8390+4	2A25  0D      		dec 	c
 226: 8394+10	2A26  CA2C2A  		jp 	z,copy_z	
 227:				
 228: 8404+10	2A29  C31F2A  		jp 	.skipAppend
 229:				
 230:				;copy upto C char (or till 0) from HL to DE
 231:				;c - dstbuf sizw
 232:				;b - from buf size
 233:				;hl pointed to NULL terminated string
 234:				
 235:     -	2A2C          	copy_z:
 236: 8414+4	2A2C  79      		ld 	a,c	;to str size left =0
 237: 8418+4	2A2D  B7      		or 	a
 238: 8422+5+6	2A2E  C8      		ret 	z
 239:				
 240: 8427+4	2A2F  78      		ld 	a,b 	;from str size left =0
 241: 8431+4	2A30  B7      		or 	a
 242: 8435+5+6	2A31  C8      		ret 	z
 243:				
 244: 8440+7	2A32  7E      		ld 	a,(hl)
 245: 8447+7	2A33  12      		ld 	(de),a
 246: 8454+4	2A34  B7      		or 	a
 247: 8458+5+6	2A35  C8      		ret 	z
 248:				; 	jp 	nz,.copy_z_store
 249:				; 	ld 	a,'_'
 250:				; .copy_z_store:
 251: 8463+6	2A36  23      		inc 	hl
 252: 8469+6	2A37  13      		inc 	de
 253: 8475+4	2A38  0D      		dec 	c
 254: 8479+4	2A39  05      		dec 	b
 255: 8483+10	2A3A  C32C2A  		jp 	copy_z
 256:				
 257:				;hl ptr
 258:				;c  len
 259:				;дополняет хвост строки пробелами делая её длинной len
 260:     -	2A3D          	fix_width:
 261: 8493+4	2A3D  79      		ld 	a,c
 262: 8497+4	2A3E  B7      		or 	a
 263: 8501+5+6	2A3F  C8      		ret 	z
 264:				
 265: 8506+11	2A40  E5      		push 	hl
 266:				
 267: 8517+6	2A41  2B      		dec 	hl
 268:     -	2A42          	.skipLP:	
 269: 8523+4	2A42  0D      		dec 	c
 270: 8527+10	2A43  CA562A  		jp 	z,.endfill
 271: 8537+6	2A46  23      		inc 	hl
 272: 8543+7	2A47  7E      		ld 	a,(hl)
 273: 8550+4	2A48  B7      		or 	a
 274: 8554+10	2A49  C2422A  		jp 	nz, .skipLP
 275:				
 276: 8564+7	2A4C  3E20    		ld 	a,' '
 277:				
 278:     -	2A4E          	.fillLoop:
 279: 8571+7	2A4E  77      		ld 	(hl),a
 280: 8578+6	2A4F  23      		inc 	hl
 281: 8584+4	2A50  0D      		dec 	c
 282: 8588+10	2A51  C24E2A  		jp 	nz,.fillLoop
 283:				
 284: 8598+4	2A54  AF      		xor 	a
 285: 8602+7	2A55  77      		ld 	(hl),a 	;0
 286:     -	2A56          	.endfill:
 287: 8609+10	2A56  E1      		pop 	hl
 288: 8619+10	2A57  C9      		ret
 289:				
 290:     -	2A58          	get_mount_info:
 291: 8629+7	2A58  3E80    		ld 	a,API_GET_MOUNT_NAME
 292: 8636+13	2A5A  32E622  		ld 	(CMD),a
 293: 8649+17	2A5D  CD8A22  		call 	SENDCMD
 294:				
 295: 8666+7	2A60  0E1D    		ld 	c,29
 296:				
 297:     -	2A62          	receive_c_bytes_to_hl:
 298:				
 299: 8673+10	2A62  21B72A  		ld 	hl,mount_info_from_emu
 300:     -	2A65          	get_lp:
 301: 8683+17	2A65  CD3122  		call 	GETBYTE
 302: 8700+7	2A68  77      		ld 	(HL),a
 303: 8707+6	2A69  23      		inc 	hl
 304: 8713+4	2A6A  0D      		dec 	c
 305: 8717+10	2A6B  C2652A  		jp 	nz,get_lp
 306: 8727+10	2A6E  C9      		ret
 307:				
 308:				;GETBYTE:
 309:				; 	PUSH	HL
 310:				; 	LD	HL,PORTC
 311:				; WG:
 312:				; 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 313:				; 	AND	20h		; выделяем сигнал IBF
 314:				; 	JP	Z,WG		; IBF=0 - данных еще нет
 315:				; 	DEC	L
 316:				; 	DEC	L
 317:				; 	LD	A,(HL)		; данные поступили - выбираем их из порта А
 318:				; 	POP	HL
 319:				; 	RET
 320:				
 321:				
 322:     -	2A6F          	drivetab_mount_info:
 323:     -	2A6F  0000    			dw 	0
 324:				
 325:     -	2A71          	msg_default_mount:
 326:     -	2A71  44726976			db 	'Drive map:',0dh,0ah
	      65206D61
	      703A0D0A
 327:				;		db 	'          1         2         3         4         5         6   '
 328:				;		db 	'0123456789012345678901234567890123456789012345678901234567890123'
 329:     -	2A7D  00      			db 	0
 330:     -	2A7E          	mount_msg:	
 331:     -	2A7E  413A    	mount_msg_drv: 	db 	'A:'
 332:     -	2A80  5720    	mount_msg_rw:	db 	'W '
 333:     -	2A82  00      			db 	0
 334:     -	2A83          	out_buffer:
 335:     -	2A83          			ds 	32
 336:     -	2AA3  00      			db 	0
 337:     -	2AA4          	msg_fdd:
 338:     -	2AA4  24464444			db	'$FDD - '
	      202D20
 339:     -	2AAB  4100    	msg_fdd_drv:	db 	'A',0
 340:				
 341:     -	2AAD          	msg_fdd_err:
 342:     -	2AAD  3F3F4552			db 	'??ERROR??',0
	      524F523F
	      3F00
 343:				
 344:     -	2AB7          	mount_info_from_emu: 	
 345:     -	2AB7          	drive_rw_status:
 346:     -	2AB7  00      			db 	0 			;=1 if R/O
 347:     -	2AB8  20202020			db 	'              ' 	;Folder 14 asciiZ 
	      20202020
	      20202020
	      2020
 348:     -	2AC6  20202020			db 	'              ' 	;Name   14 asciiZ
	      20202020
	      20202020
	      2020
 349:     -	2AD4  00      			db 	0
 350:				
 351:     -	2AD5  0D0A00  	mount_crlf: 	db 	0dh,0ah,0	
 352:				
 353:     -	2AD8          	msgDRIVE_F:
 354:     -	2AD8  463A202D			db 	'F: - /EXRTOOLS.KDI with MOUNT and other EXTROM related utils'
	      202F4558
	      52544F4F
	      4C532E4B
	      44492077
	      69746820
	      4D4F554E
	      5420616E
	      64206F74
	      68657220
	      45585452
	      4F4D2072
	      656C6174
	      65642075
	      74696C73
 355:     -	2B14  0D0A00  			db 	0x0d,0x0a,0
 356:				
 357:				; CMD:	DB	1		; Команда чтения
 358:				; DRV:	DB	0
 359:				; TRK:	DB	0
 360:				; SEC:	DB	0
 361:				
 362:				
 363:				; 80 — получить имя образа
 364:				
 365:				; Команда предназначена для получения имени KDI-файла, смонтированного в данный момент на логическом устройстве A-D.  
 366:				;  Номер устройства задается в поле DRV. Возвращается буфер размером 29 байт, содержащий следующую информацию:
 367:				
 368:				; 1 байт флага разрешение записи (0 — чтение/запись, 1 — только чтение)
 369:				; 14-байтовый буфер с именем каталога, из которого смонтирован файл образа, заканчивающийся 0.
 370:				; 14-байтовый буфер с именем файла, заканчивающийся 0.
 371:				
 372:				; 82 — проверка состояния устройства
 373:				; 	Команда возвращает ответ ОК, если устройство смонтировано, или Fail, если не смонтировано. 
 374:				; Флаг состояния автоматически опускается в случае ошибок ввода-вывода на данном устройстве. 
 375:				; С помощью этой команды можно проверить результат предыдущего вызова mount (81)
**** generator/V0/extrom-patcher.asm ****
 734:					include 	"extrom-patcher-resident-cpm-body.asm"
**** extrom-patcher-resident-cpm-body.asm ****
   1:     -	FB08          	rPORTA	EQU	0FB08H		; Порт Канала A интерфейса расширения
   2:     -	FB0A          	rPORTC	EQU	0FB0AH		; Порт Канала С интерфейса расширения
   3:     -	FB0B          	rPCWR	EQU	0FB0BH		; Порт управляющих команд
   4:				
   5:     -	FFFF          	_DSK 	EQU 	0xFFFF
   6:     -	FFFF          	_OPER 	EQU 	0xFFFF
   7:     -	FFFF          	_TRK 	EQU 	0xFFFF
   8:     -	FFFF          	_SEC 	EQU 	0xFFFF
   9:     -	FFFF          	_DMA 	EQU 	0xFFFF
  10:				
  11:     -	EE00          	_RRBUFF	EQU 	0xEE00
  12:				
  13:				cpm_resident_body 	macro	preffix
  14:				
  15:				;keyhook support removed 2014-10-22
  16:				;больше нет нужды в ней, т.к. есть диск F
  17:				; preffix&kbd_hook_noCtrl_03;
  18:				; 	ld 	(preffix&save_a),a
  19:				; 	cp 	0x03
  20:				; 	jp 	preffix&kbd_hook_noCtrl_chk
  21:				
  22:				; preffix&kbd_hook_noCtrl_33:
  23:				; 	ld 	(preffix&save_a),a
  24:				; 	cp 	0x33
  25:				
  26:				; preffix&kbd_hook_noCtrl_chk:
  27:				; 	jp 	nz,preffix&bios_hook
  28:				
  29:				; 	ld 	a,(0xf880)
  30:				; 	and 	00100001b
  31:				; 	cp 	00100001b
  32:				
  33:				; 	jp 	nz,preffix&bios_hook
  34:				
  35:				; 	jp 	preffix&do_key_action
  36:				
  37:				; preffix&kbd_hook_2133:
  38:				; 	ld 	(preffix&save_a),a
  39:				; 	ld 	a,c
  40:				; 	cp 	0x33 	;stop
  41:				; 	jp 	nz,preffix&bios_hook
  42:				
  43:				; 	ld 	a,b
  44:				; 	cp 	0x21 	;ctrl+stop
  45:				; 	jp 	nz,preffix&bios_hook
  46:				
  47:				; preffix&do_key_action:
  48:				; 	push 	hl
  49:				; 	push 	de
  50:				; 	push 	bc
  51:				; 	ld 	hl,preffix&msg_hook
  52:				; 	ld 	de,0xfc00
  53:				; preffix&.kmlp:	
  54:				; 	ld 	a,(hl)
  55:				; 	or 	a
  56:				; 	jp 	z,preffix&.kmlp_ext
  57:				; 	ld 	(de),a
  58:				; 	inc 	hl
  59:				; 	inc 	de
  60:				; 	jp 	preffix&.kmlp
  61:				
  62:				; preffix&.kmlp_ext:
  63:				; 	pop 	bc
  64:				; 	pop 	de
  65:				; 	pop 	hl
  66:				
  67:				; 	ld 	bc,0 	;simulate no key
  68:				; 	ld 	a,0
  69:				; 	jp 	preffix&old_hook
  70:				; ; 	halt
  71:				
  72:				
  73:				; preffix&bios_hook:
  74:				; 	ld 	a,(preffix&save_a)
  75:				
  76:				; preffix&old_hook:
  77:				; 	jp 	$
  78:				; preffix&save_a:
  79:				; 	db 	0	
  80:				; preffix&msg_hook:
  81:				; 	db 	'CTRL+SHIFT+STOP pressed',0
  82:				
  83:				;ptrs to drive drvreg bytes 
  84:				preffix&res_DRIVE_TAB:
  85:					dw 	0 	;A
  86:					dw 	0 	;B
  87:					dw 	0 	;C
  88:					dw 	0 	;D
  89:					dw 	0 	;E
  90:					dw 	0 	;F
  91:				
  92:				
  93:				preffix&dph_F:
  94:					dw	0	;_XLT:           
  95:					dw	0	;_1:             
  96:					dw	0	;_2:             
  97:					dw	0	;_3:             
  98:					dw	0xFC00	;DirBuf: value store here via patcher 0xfc00 - debug
  99:					dw	preffix&dpb_F	;DPB:   
 100:					dw	0	;CSV: - fixed drive   
 101:					dw	preffix&alw_F	;ALV:   
 102:				
 103:				
 104:				;  ФИЗИЧЕСКИЕ ПАРАМЕТРЫ ДИСКА
 105:				;--------------------------------------
 106:				      DB 50H	;контрольная сумма
 107:				
 108:				      DB 080H ;константа скорости движения головки.
 109:				;	; 3 - 30 мс на шаг, 2 - 20 мс, 1 - 12 мс,
 110:				;	; 0 - 6 мс и 80H - 3 мс.
 111:				      DB 05H  ; число физических секторов на дорожке
 112:				      DB 01H  ; информация о сторонах диска
 113:				;	;( 00 - односторонный диск
 114:				;	;  01 - двухсторонний диск
 115:				      DB 03	; 512 bytes/sector
 116:				;	;( 00 - 128 байт/сектор
 117:				;	;  01 - 256 байт/сектор
 118:				;	;  02 - 512 байт/сектор
 119:				;	;  03 - 1024 байт/сектор
 120:				      DB 0	; номер текущей дорожки.
 121:				      DB 0	; позиционный номер устройства (00000100) - для записи в регистр выбора
 122:				;---------------------------------------------------
 123:				      DB 0	;INFO	; флаг успешного считывания
 124:				
 125:				preffix&dpb_F:
 126:				; kdi params
 127:				      DW 40	;128 байтовых секторов/трек ; SPT
 128:				      DB 4	; размер блока миним.кбайт  ; BSH
 129:				;	; фактор сдвига блока распределения данных
 130:				;	; определяется размером блока данных. Блок 
 131:				;	; данных - минимально возможная частица файла.
 132:				;	; Размер блока - 1, 2, 4, 8 или 16 Кбайт. Если
 133:				;	; блок имеет большой размер, в каждом файле 
 134:				;	; теряется значительное число неиспользуемых
 135:				;	; секторов. При уменьшении размера блока
 136:				;	; увеличивается размер директории, описывающий
 137:				;	; расположение частей файла. BSH = log2[число
 138:				;	; логических секторов в блоке].
 139:				      DB 15	; число логических сек/блок  ; BLM
 140:				;	; маска блока распределения данных.
 141:				;	; BLM = (число логических секторов в блоке)-1.
 142:				      DB 0	; extent mask                ; EXM
 143:				;	; = (BLM+1)*128/1024 - 1 - [DSM/256]. EXM - 
 144:				;	; вспомогательная величина для определения
 145:				;	; номера extent'а.
 146:				;	; extent - часть файла, описываемая одним 
 147:				;	; входом в директорию.
 148:				      DW 394	; обьем диска в блоках-1     ; DSM
 149:				      DW 127	; входов в директорий-1      ; DRM
 150:				      DB 192	; определяет, какие блоки    ; AL0
 151:				;	; зарезервированы
 152:				      DB 0	; alloc 1                    ; AL1
 153:				;	; под директорию. Каждый  бит AL0,AL1, 
 154:				;	; начиная со старшего бита AL0 и кончая 
 155:				;	; младшим битом AL1, значением 1 резервирует
 156:				;	; один блок данных для директории. Нужно
 157:				;	; резервировать необходимое число блоков
 158:				;	; для хранения входов в директорию: 32*DRM/BLS
 159:				      DW 0	; размер вектора контроля директории. ; CKS
 160:				;	; CKS=(DRM+1)/4. Если диск не сменяем, CKS=0.
 161:				      DW 2	; число системных дорожек    ; OFS
 162:				
 163:				
 164:				; preffix&alw_F: 	ds 	50
 165:				preffix&alw_F: 	ds 	50
 166:				
 167:				
 168:				preffix&res_seldsk:
 169:					ld 	a,c
 170:					cp 	0xfe
 171:				preffix&old_seld_dsk:
 172:					jp 	nz,$	
 173:					ld 	hl,preffix&res_DRIVE_TAB
 174:					ret
 175:				
 176:				
 177:				;RAM:DA27 C3 EB DC                 jp      j_READ
 178:				
 179:				;RAM:DCEB          j_READ:                                 ; CODE XREF: RAM:_READj
 180:				;RAM:DCEB                                                  ; RAM:DB84p
 181:				;RAM:DCEB
 182:				;RAM:DCEB          ; FUNCTION CHUNK AT RAM:DDC4 SIZE 0000007B BYTES
 183:				;RAM:DCEB
 184:				;RAM:DCEB 3E 04                    ld      a, 4
 185:				;RAM:DCED 32 66 E0                 ld      (_OPERATION), a
 186:				;RAM:DCF0 3A 64 E0                 ld      a, (_DSK)
 187:				;RAM:DCF3 FE 04                    cp      4
 188:				;RAM:DCF5 CA C4 DD                 jp      z, loc_DDC4
 189:				
 190:				;сюда попадает из биоса JP READ
 191:				;а если не наше то прыгаем на старый read
 192:				preffix&res_READ:
 193:				; 	ld	 A,4	;Режим чтения
 194:				; 	ld  	(_OPER),a
 195:				preffix&r_p_DSK1:
 196:					ld 	a,(_DSK) 	;_DSK
 197:					cp 	4
 198:					jp 	z,preffix&_old_read
 199:				
 200:					cp 	5 		;disk F mapped to EMU drive E
 201:					jp 	nz,preffix&.r_no_drv_dec
 202:					dec 	a
 203:				
 204:				preffix&.r_no_drv_dec:
 205:					LD	(preffix&EXR_DRV),A	; # устройства
 206:				
 207:					push 	hl
 208:				preffix&r_p_SELDSKDRIVER:
 209:					ld 	hl,(0)	;EXR_SELDSK_DRIVE
 210:					ld 	a,(hl)
 211:					pop 	hl
 212:					or 	a
 213:					jp 	nz,preffix&_old_read
 214:				
 215:				preffix&r_p_TRK1:
 216:					LD	A,(_TRK)	
 217:					LD	(preffix&EXR_TRK),A	; дорожка
 218:				preffix&r_p_SEC1:
 219:					LD	A,(_SEC)	; сектор
 220:					DEC	A		; у нас номер сектора начинается с 0
 221:					LD	(preffix&EXR_SEC),A
 222:				
 223:					LD	A,1
 224:					LD	(preffix&EXR_CMD),A	; 1 - команда чтения
 225:				
 226:					CALL	preffix&EXR_SENDCMD	; отсылаем команду
 227:					DEC	A		; ответ, 0 - ошибка, 1 - ОК
 228:					RET	NZ		; 0 - ошибка
 229:				preffix&r_p_DMA1:
 230:					LD	HL,(_DMA)	; адрес буфера для приема данных
 231:					CALL	preffix&EXR_GETSEC	; принимаем данные
 232:					XOR	A		; завершение всегда успешно
 233:					RET
 234:				;
 235:				
 236:				preffix&_old_read:
 237:					jp 	$
 238:				
 239:				preffix&res_WRITE:
 240:				; 	ld	 A,6	;Режим чтения
 241:				; 	ld  	(_OPER),a
 242:				
 243:				preffix&r_p_DSK2:
 244:					ld 	a,(_DSK) 	;_DSK
 245:					cp 	4
 246:					jp 	z,preffix&_old_write
 247:					cp 	5 		;disk F mapped to EMU drive E
 248:					jp 	nz,preffix&.w_no_drv_dec
 249:					dec 	a
 250:				preffix&.w_no_drv_dec:
 251:					LD	(preffix&EXR_DRV),A
 252:				
 253:				
 254:					push 	hl
 255:				preffix&r_p_SELDSKDRIVEW:
 256:					ld 	hl,(0)	;EXR_SELDSK_DRIVE
 257:					ld 	a,(hl)
 258:					pop 	hl
 259:					or 	a
 260:					jp 	nz,preffix&_old_write
 261:				
 262:				preffix&r_p_TRK2:
 263:					LD	A,(_TRK)
 264:					LD	(preffix&EXR_TRK),A
 265:				preffix&r_p_SEC2:
 266:					LD	A,(_SEC)
 267:					DEC	A
 268:					LD	(preffix&EXR_SEC),A
 269:				
 270:					LD	A,2		; 2 - команда записи
 271:					LD	(preffix&EXR_CMD),A
 272:				
 273:					CALL	preffix&EXR_SENDCMD
 274:					DEC	A		; ответ, 0 - ошибка, 1 - ОК
 275:					RET	NZ		; 0 - ошибка
 276:				preffix&r_p_DMA2:
 277:					LD	HL,(_DMA)
 278:					CALL	preffix&EXR_PUTSEC
 279:					XOR	A		; запись успешна
 280:					RET
 281:				
 282:				preffix&_old_write:
 283:					jp 	$
 284:				
 285:				
 286:				preffix&res_GETINFO:
 287:				
 288:					LD 	A,(HL)	; A= маска выбора привода
 289:					or 	a
 290:					jp 	nz,preffix&_old_getinfo 	;=0 if emulated
 291:				
 292:				;
 293:				;  Чтение с эмулируемых дисков A или B
 294:				;
 295:					push 	hl
 296:					CALL	preffix&EXR_READINFO
 297:					DEC	A		; ответ, 0 - ошибка, 1 - ОК
 298:				; 	JP	NZ,0xE6ff	;IERR		; 0 - ошибка
 299:				preffix&_old_getinfo_chkdo:
 300:					JP	$ 		;IERR jnz xxx, CHKDO
 301:				; ;
 302:				preffix&_old_getinfo:
 303:					jp 	$ 		;GETINFO
 304:				
 305:				
 306:				;==================  Драйвер ExtROM-API ====================================
 307:					
 308:					
 309:				;****************************************
 310:				;*  Прием байта из порта А по стробу    *
 311:				;****************************************
 312:				preffix&EXR_GETBYTE:
 313:					PUSH	HL
 314:					LD	HL,rPORTC
 315:				preffix&pWG:
 316:					LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 317:					AND	20h		; выделяем сигнал IBF
 318:					JP	Z,preffix&pWG		; IBF=0 - данных еще нет
 319:					LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
 320:					POP	HL
 321:					RET
 322:				
 323:				;****************************************
 324:				;*  Отправка байта в порт A             *
 325:				;****************************************
 326:				preffix&EXR_PUTBYTE:
 327:					PUSH	HL
 328:					PUSH	AF
 329:					LD	HL,rPORTC
 330:				preffix&pWP:
 331:					LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 332:					AND	80h		; выделяем сигнал -OBF
 333:					JP	Z,preffix&pWP		; -OBF=0 - в передатчике сидит незабранный байт
 334:					POP	AF
 335:					LD	(rPORTA),A		; данные поступили - выбираем их из порта А
 336:					POP	HL
 337:					RET
 338:				
 339:				;*******************************************
 340:				;*      Прием сектора                      *
 341:				;* HL - адрес размещения сектора в памяти  *
 342:				;*  Размер сектора - 128 байт              *
 343:				;*******************************************
 344:				preffix&EXR_GETSEC:
 345:					di
 346:					PUSH	BC
 347:					PUSH	DE
 348:					LD	C,128		; счетчик байтов сектора, всего 128 байт
 349:					EX	DE,HL		; адрес буфера -> DE
 350:					LD	HL,rPORTC
 351:				preffix&pGSL:
 352:					LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 353:					AND	20h		; выделяем сигнал IBF
 354:					JP	Z,preffix&pGSL		; IBF=0 - данных еще нет
 355:					LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
 356:					LD	(DE),A		; принимаем и размещаем очередной байт
 357:					INC	DE		; указатель буфера ++
 358:					DEC	C		; принимаем остальные байты
 359:					JP	NZ,preffix&pGSL
 360:					POP	DE
 361:					POP	BC
 362:				; 	ei - int should be still disabled 
 363:					RET
 364:				
 365:				;*******************************************
 366:				;*      Передача сектора                   *
 367:				;* HL - адрес размещения сектора в памяти  *
 368:				;*  Размер сектора - 128 байт              *
 369:				;*******************************************
 370:				preffix&EXR_PUTSEC:
 371:					di
 372:					PUSH	BC
 373:					PUSH	DE
 374:					LD	C,128		; счетчик байтов сектора, всего 128 байт
 375:					EX	DE,HL		; адрес буфера -> DE
 376:					LD	HL,rPORTC
 377:				preffix&pPSL:
 378:					LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 379:					AND	80h		; выделяем сигнал -OBF
 380:					JP	Z,preffix&pPSL		; -OBF=0 - в передатчике сидит незабранный байт
 381:					LD	A,(DE)		; принимаем и размещаем очередной байт
 382:					LD	(rPORTA),A		; данные поступили - выбираем их из порта А
 383:					INC	DE
 384:					DEC	C		; принимаем остальные байты
 385:					JP	NZ,preffix&pPSL
 386:					POP	DE
 387:					POP	BC
 388:				; 	ei - int should be still disabled 
 389:					RET
 390:				
 391:				;****************************************
 392:				;*     Отправка командного пакета       *
 393:				;****************************************
 394:				preffix&EXR_SENDCMD:
 395:				
 396:					di
 397:					PUSH	HL
 398:					PUSH	BC
 399:					LD	A,0Ch
 400:					LD	(rPCWR),A	; переключаем порт в режим 2
 401:					LD	HL,preffix&EXR_CMD
 402:					LD	C,4		; пакет - 4 байта
 403:					LD	B,0		; заготовка контрольной суммы
 404:				preffix&pSCL:
 405:					LD	A,(HL)		; очередной байт пакета 
 406:					ADD 	B		; добавляем к КС
 407:					LD	B,A
 408:					LD	A,(HL)		; очередной байт пакета 
 409:					CALL	preffix&EXR_PUTBYTE		; - в порт
 410:					INC	HL
 411:					DEC	C
 412:					JP	NZ,preffix&pSCL
 413:					LD	A,B
 414:					DEC 	A		; КС-1
 415:					CALL	preffix&EXR_PUTBYTE     ; контрольная сумма
 416:					CALL	preffix&EXR_GETBYTE	; ответ контроллера
 417:					POP	BC
 418:					POP	HL
 419:				; 	ei - int should be still disabled 
 420:					RET
 421:				
 422:				;*******************************************
 423:				;*  Чтение информационного сектора
 424:				;*******************************************
 425:				preffix&EXR_READINFO:
 426:					LD	HL,preffix&EXR_CMD	; командный пакет
 427:					LD	(HL),1		; команда чтения
 428:					INC	HL
 429:				preffix&r_p_DSK3:
 430:					LD	A,(_DSK)	; вписываем # устройства
 431:					LD	(HL),A
 432:					INC	HL
 433:					LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
 434:					INC	HL
 435:					LD	(HL),0		
 436:					CALL	preffix&EXR_SENDCMD	; отправляем команду
 437:					OR	A
 438:					RET 	Z		; ошибка
 439:					LD	HL,_RRBUFF	; принимаем данные
 440:					CALL	preffix&EXR_GETSEC
 441:					LD	A,1
 442:					RET
 443:				
 444:				
 445:				; Командный пакет интерфейса Extrom-API
 446:				;===============================================
 447:				preffix&EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
 448:				preffix&EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
 449:				preffix&EXR_TRK:	DB	0	; логическая дорожка
 450:				preffix&EXR_SEC:	DB	0	; логический сектор (128b)
 451:				
**** generator/V0/extrom-patcher.asm ****
 735:					endm
 736:					include 	"extrom-patcher-resident-cpm1.asm"
**** extrom-patcher-resident-cpm1.asm ****
   1:					;    12_87_11_niijaf
   2:					;     E8AC-EBA6  = 762 
   3:					;     
   4:				
   5:     -	2B17          	resident_cpm1	equ $
   6:				
   7:     -	E8AC          		.phase 0xE8AC
   8:				
   9:     -	E8AC          	resident_cpm1_addr 	EQU 	$
  10:				
  11:     -	E8AC          		cpm_resident_body _cpm1_
  11:				
  11:				;keyhook support removed 2014-10-22
  11:				;больше нет нужды в ней, т.к. есть диск F
  11:				; preffix&kbd_hook_noCtrl_03;
  11:				; 	ld 	(preffix&save_a),a
  11:				; 	cp 	0x03
  11:				; 	jp 	preffix&kbd_hook_noCtrl_chk
  11:				
  11:				; preffix&kbd_hook_noCtrl_33:
  11:				; 	ld 	(preffix&save_a),a
  11:				; 	cp 	0x33
  11:				
  11:				; preffix&kbd_hook_noCtrl_chk:
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; 	ld 	a,(0xf880)
  11:				; 	and 	00100001b
  11:				; 	cp 	00100001b
  11:				
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; 	jp 	preffix&do_key_action
  11:				
  11:				; preffix&kbd_hook_2133:
  11:				; 	ld 	(preffix&save_a),a
  11:				; 	ld 	a,c
  11:				; 	cp 	0x33 	;stop
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; 	ld 	a,b
  11:				; 	cp 	0x21 	;ctrl+stop
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; preffix&do_key_action:
  11:				; 	push 	hl
  11:				; 	push 	de
  11:				; 	push 	bc
  11:				; 	ld 	hl,preffix&msg_hook
  11:				; 	ld 	de,0xfc00
  11:				; preffix&.kmlp:	
  11:				; 	ld 	a,(hl)
  11:				; 	or 	a
  11:				; 	jp 	z,preffix&.kmlp_ext
  11:				; 	ld 	(de),a
  11:				; 	inc 	hl
  11:				; 	inc 	de
  11:				; 	jp 	preffix&.kmlp
  11:				
  11:				; preffix&.kmlp_ext:
  11:				; 	pop 	bc
  11:				; 	pop 	de
  11:				; 	pop 	hl
  11:				
  11:				; 	ld 	bc,0 	;simulate no key
  11:				; 	ld 	a,0
  11:				; 	jp 	preffix&old_hook
  11:				; ; 	halt
  11:				
  11:				
  11:				; preffix&bios_hook:
  11:				; 	ld 	a,(preffix&save_a)
  11:				
  11:				; preffix&old_hook:
  11:				; 	jp 	$
  11:				; preffix&save_a:
  11:				; 	db 	0	
  11:				; preffix&msg_hook:
  11:				; 	db 	'CTRL+SHIFT+STOP pressed',0
  11:				
  11:				;ptrs to drive drvreg bytes 
  11:     -	E8AC          	_cpm1_res_DRIVE_TAB:
  11:     -	E8AC  0000    		dw 	0 	;A
  11:     -	E8AE  0000    		dw 	0 	;B
  11:     -	E8B0  0000    		dw 	0 	;C
  11:     -	E8B2  0000    		dw 	0 	;D
  11:     -	E8B4  0000    		dw 	0 	;E
  11:     -	E8B6  0000    		dw 	0 	;F
  11:				
  11:				
  11:     -	E8B8          	_cpm1_dph_F:
  11:     -	E8B8  0000    		dw	0	;_XLT:           
  11:     -	E8BA  0000    		dw	0	;_1:             
  11:     -	E8BC  0000    		dw	0	;_2:             
  11:     -	E8BE  0000    		dw	0	;_3:             
  11:     -	E8C0  00FC    		dw	0xFC00	;DirBuf: value store here via patcher 0xfc00 - debug
  11:     -	E8C2  D0E8    		dw	_cpm1_dpb_F	;DPB:   
  11:     -	E8C4  0000    		dw	0	;CSV: - fixed drive   
  11:     -	E8C6  DFE8    		dw	_cpm1_alw_F	;ALV:   
  11:				
  11:				
  11:				;  ФИЗИЧЕСКИЕ ПАРАМЕТРЫ ДИСКА
  11:				;--------------------------------------
  11:     -	E8C8  50      	      DB 50H	;контрольная сумма
  11:				
  11:     -	E8C9  80      	      DB 080H ;константа скорости движения головки.
  11:				;	; 3 - 30 мс на шаг, 2 - 20 мс, 1 - 12 мс,
  11:				;	; 0 - 6 мс и 80H - 3 мс.
  11:     -	E8CA  05      	      DB 05H  ; число физических секторов на дорожке
  11:     -	E8CB  01      	      DB 01H  ; информация о сторонах диска
  11:				;	;( 00 - односторонный диск
  11:				;	;  01 - двухсторонний диск
  11:     -	E8CC  03      	      DB 03	; 512 bytes/sector
  11:				;	;( 00 - 128 байт/сектор
  11:				;	;  01 - 256 байт/сектор
  11:				;	;  02 - 512 байт/сектор
  11:				;	;  03 - 1024 байт/сектор
  11:     -	E8CD  00      	      DB 0	; номер текущей дорожки.
  11:     -	E8CE  00      	      DB 0	; позиционный номер устройства (00000100) - для записи в регистр выбора
  11:				;---------------------------------------------------
  11:     -	E8CF  00      	      DB 0	;INFO	; флаг успешного считывания
  11:				
  11:     -	E8D0          	_cpm1_dpb_F:
  11:				; kdi params
  11:     -	E8D0  2800    	      DW 40	;128 байтовых секторов/трек ; SPT
  11:     -	E8D2  04      	      DB 4	; размер блока миним.кбайт  ; BSH
  11:				;	; фактор сдвига блока распределения данных
  11:				;	; определяется размером блока данных. Блок 
  11:				;	; данных - минимально возможная частица файла.
  11:				;	; Размер блока - 1, 2, 4, 8 или 16 Кбайт. Если
  11:				;	; блок имеет большой размер, в каждом файле 
  11:				;	; теряется значительное число неиспользуемых
  11:				;	; секторов. При уменьшении размера блока
  11:				;	; увеличивается размер директории, описывающий
  11:				;	; расположение частей файла. BSH = log2[число
  11:				;	; логических секторов в блоке].
  11:     -	E8D3  0F      	      DB 15	; число логических сек/блок  ; BLM
  11:				;	; маска блока распределения данных.
  11:				;	; BLM = (число логических секторов в блоке)-1.
  11:     -	E8D4  00      	      DB 0	; extent mask                ; EXM
  11:				;	; = (BLM+1)*128/1024 - 1 - [DSM/256]. EXM - 
  11:				;	; вспомогательная величина для определения
  11:				;	; номера extent'а.
  11:				;	; extent - часть файла, описываемая одним 
  11:				;	; входом в директорию.
  11:     -	E8D5  8A01    	      DW 394	; обьем диска в блоках-1     ; DSM
  11:     -	E8D7  7F00    	      DW 127	; входов в директорий-1      ; DRM
  11:     -	E8D9  C0      	      DB 192	; определяет, какие блоки    ; AL0
  11:				;	; зарезервированы
  11:     -	E8DA  00      	      DB 0	; alloc 1                    ; AL1
  11:				;	; под директорию. Каждый  бит AL0,AL1, 
  11:				;	; начиная со старшего бита AL0 и кончая 
  11:				;	; младшим битом AL1, значением 1 резервирует
  11:				;	; один блок данных для директории. Нужно
  11:				;	; резервировать необходимое число блоков
  11:				;	; для хранения входов в директорию: 32*DRM/BLS
  11:     -	E8DB  0000    	      DW 0	; размер вектора контроля директории. ; CKS
  11:				;	; CKS=(DRM+1)/4. Если диск не сменяем, CKS=0.
  11:     -	E8DD  0200    	      DW 2	; число системных дорожек    ; OFS
  11:				
  11:				
  11:				; preffix&alw_F: 	ds 	50
  11:     -	E8DF .. E910 00	_cpm1_alw_F: 	ds 	50
  11:				
  11:				
  11:     -	E911          	_cpm1_res_seldsk:
  11: 8737+4	E911  79      		ld 	a,c
  11: 8741+7	E912  FEFE    		cp 	0xfe
  11:     -	E914          	_cpm1_old_seld_dsk:
  11: 8748+10	E914  C214E9  		jp 	nz,$	
  11: 8758+10	E917  21ACE8  		ld 	hl,_cpm1_res_DRIVE_TAB
  11: 8768+10	E91A  C9      		ret
  11:				
  11:				
  11:				;RAM:DA27 C3 EB DC                 jp      j_READ
  11:				
  11:				;RAM:DCEB          j_READ:                                 ; CODE XREF: RAM:_READj
  11:				;RAM:DCEB                                                  ; RAM:DB84p
  11:				;RAM:DCEB
  11:				;RAM:DCEB          ; FUNCTION CHUNK AT RAM:DDC4 SIZE 0000007B BYTES
  11:				;RAM:DCEB
  11:				;RAM:DCEB 3E 04                    ld      a, 4
  11:				;RAM:DCED 32 66 E0                 ld      (_OPERATION), a
  11:				;RAM:DCF0 3A 64 E0                 ld      a, (_DSK)
  11:				;RAM:DCF3 FE 04                    cp      4
  11:				;RAM:DCF5 CA C4 DD                 jp      z, loc_DDC4
  11:				
  11:				;сюда попадает из биоса JP READ
  11:				;а если не наше то прыгаем на старый read
  11:     -	E91B          	_cpm1_res_READ:
  11:				; 	ld	 A,4	;Режим чтения
  11:				; 	ld  	(_OPER),a
  11:     -	E91B          	_cpm1_r_p_DSK1:
  11: 8778+13	E91B  3AFFFF  		ld 	a,(_DSK) 	;_DSK
  11: 8791+7	E91E  FE04    		cp 	4
  11: 8798+10	E920  CA55E9  		jp 	z,_cpm1__old_read
  11:				
  11: 8808+7	E923  FE05    		cp 	5 		;disk F mapped to EMU drive E
  11: 8815+10	E925  C229E9  		jp 	nz,_cpm1_.r_no_drv_dec
  11: 8825+4	E928  3D      		dec 	a
  11:				
  11:     -	E929          	_cpm1_.r_no_drv_dec:
  11: 8829+13	E929  3240EA  		LD	(_cpm1_EXR_DRV),A	; # устройства
  11:				
  11: 8842+11	E92C  E5      		push 	hl
  11:     -	E92D          	_cpm1_r_p_SELDSKDRIVER:
  11: 8853+16	E92D  2A0000  		ld 	hl,(0)	;EXR_SELDSK_DRIVE
  11: 8869+7	E930  7E      		ld 	a,(hl)
  11: 8876+10	E931  E1      		pop 	hl
  11: 8886+4	E932  B7      		or 	a
  11: 8890+10	E933  C255E9  		jp 	nz,_cpm1__old_read
  11:				
  11:     -	E936          	_cpm1_r_p_TRK1:
  11: 8900+13	E936  3AFFFF  		LD	A,(_TRK)	
  11: 8913+13	E939  3241EA  		LD	(_cpm1_EXR_TRK),A	; дорожка
  11:     -	E93C          	_cpm1_r_p_SEC1:
  11: 8926+13	E93C  3AFFFF  		LD	A,(_SEC)	; сектор
  11: 8939+4	E93F  3D      		DEC	A		; у нас номер сектора начинается с 0
  11: 8943+13	E940  3242EA  		LD	(_cpm1_EXR_SEC),A
  11:				
  11: 8956+7	E943  3E01    		LD	A,1
  11: 8963+13	E945  323FEA  		LD	(_cpm1_EXR_CMD),A	; 1 - команда чтения
  11:				
  11: 8976+17	E948  CDFBE9  		CALL	_cpm1_EXR_SENDCMD	; отсылаем команду
  11: 8993+4	E94B  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
  11: 8997+5+6	E94C  C0      		RET	NZ		; 0 - ошибка
  11:     -	E94D          	_cpm1_r_p_DMA1:
  11: 9002+16	E94D  2AFFFF  		LD	HL,(_DMA)	; адрес буфера для приема данных
  11: 9018+17	E950  CDC5E9  		CALL	_cpm1_EXR_GETSEC	; принимаем данные
  11: 9035+4	E953  AF      		XOR	A		; завершение всегда успешно
  11: 9039+10	E954  C9      		RET
  11:				;
  11:				
  11:     -	E955          	_cpm1__old_read:
  11: 9049+10	E955  C355E9  		jp 	$
  11:				
  11:     -	E958          	_cpm1_res_WRITE:
  11:				; 	ld	 A,6	;Режим чтения
  11:				; 	ld  	(_OPER),a
  11:				
  11:     -	E958          	_cpm1_r_p_DSK2:
  11: 9059+13	E958  3AFFFF  		ld 	a,(_DSK) 	;_DSK
  11: 9072+7	E95B  FE04    		cp 	4
  11: 9079+10	E95D  CA92E9  		jp 	z,_cpm1__old_write
  11: 9089+7	E960  FE05    		cp 	5 		;disk F mapped to EMU drive E
  11: 9096+10	E962  C266E9  		jp 	nz,_cpm1_.w_no_drv_dec
  11: 9106+4	E965  3D      		dec 	a
  11:     -	E966          	_cpm1_.w_no_drv_dec:
  11: 9110+13	E966  3240EA  		LD	(_cpm1_EXR_DRV),A
  11:				
  11:				
  11: 9123+11	E969  E5      		push 	hl
  11:     -	E96A          	_cpm1_r_p_SELDSKDRIVEW:
  11: 9134+16	E96A  2A0000  		ld 	hl,(0)	;EXR_SELDSK_DRIVE
  11: 9150+7	E96D  7E      		ld 	a,(hl)
  11: 9157+10	E96E  E1      		pop 	hl
  11: 9167+4	E96F  B7      		or 	a
  11: 9171+10	E970  C292E9  		jp 	nz,_cpm1__old_write
  11:				
  11:     -	E973          	_cpm1_r_p_TRK2:
  11: 9181+13	E973  3AFFFF  		LD	A,(_TRK)
  11: 9194+13	E976  3241EA  		LD	(_cpm1_EXR_TRK),A
  11:     -	E979          	_cpm1_r_p_SEC2:
  11: 9207+13	E979  3AFFFF  		LD	A,(_SEC)
  11: 9220+4	E97C  3D      		DEC	A
  11: 9224+13	E97D  3242EA  		LD	(_cpm1_EXR_SEC),A
  11:				
  11: 9237+7	E980  3E02    		LD	A,2		; 2 - команда записи
  11: 9244+13	E982  323FEA  		LD	(_cpm1_EXR_CMD),A
  11:				
  11: 9257+17	E985  CDFBE9  		CALL	_cpm1_EXR_SENDCMD
  11: 9274+4	E988  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
  11: 9278+5+6	E989  C0      		RET	NZ		; 0 - ошибка
  11:     -	E98A          	_cpm1_r_p_DMA2:
  11: 9283+16	E98A  2AFFFF  		LD	HL,(_DMA)
  11: 9299+17	E98D  CDE0E9  		CALL	_cpm1_EXR_PUTSEC
  11: 9316+4	E990  AF      		XOR	A		; запись успешна
  11: 9320+10	E991  C9      		RET
  11:				
  11:     -	E992          	_cpm1__old_write:
  11: 9330+10	E992  C392E9  		jp 	$
  11:				
  11:				
  11:     -	E995          	_cpm1_res_GETINFO:
  11:				
  11: 9340+7	E995  7E      		LD 	A,(HL)	; A= маска выбора привода
  11: 9347+4	E996  B7      		or 	a
  11: 9351+10	E997  C2A2E9  		jp 	nz,_cpm1__old_getinfo 	;=0 if emulated
  11:				
  11:				;
  11:				;  Чтение с эмулируемых дисков A или B
  11:				;
  11: 9361+11	E99A  E5      		push 	hl
  11: 9372+17	E99B  CD21EA  		CALL	_cpm1_EXR_READINFO
  11: 9389+4	E99E  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
  11:				; 	JP	NZ,0xE6ff	;IERR		; 0 - ошибка
  11:     -	E99F          	_cpm1__old_getinfo_chkdo:
  11: 9393+10	E99F  C39FE9  		JP	$ 		;IERR jnz xxx, CHKDO
  11:				; ;
  11:     -	E9A2          	_cpm1__old_getinfo:
  11: 9403+10	E9A2  C3A2E9  		jp 	$ 		;GETINFO
  11:				
  11:				
  11:				;==================  Драйвер ExtROM-API ====================================
  11:					
  11:					
  11:				;****************************************
  11:				;*  Прием байта из порта А по стробу    *
  11:				;****************************************
  11:     -	E9A5          	_cpm1_EXR_GETBYTE:
  11: 9413+11	E9A5  E5      		PUSH	HL
  11: 9424+10	E9A6  210AFB  		LD	HL,rPORTC
  11:     -	E9A9          	_cpm1_pWG:
  11: 9434+7	E9A9  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11: 9441+7	E9AA  E620    		AND	20h		; выделяем сигнал IBF
  11: 9448+10	E9AC  CAA9E9  		JP	Z,_cpm1_pWG		; IBF=0 - данных еще нет
  11: 9458+13	E9AF  3A08FB  		LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
  11: 9471+10	E9B2  E1      		POP	HL
  11: 9481+10	E9B3  C9      		RET
  11:				
  11:				;****************************************
  11:				;*  Отправка байта в порт A             *
  11:				;****************************************
  11:     -	E9B4          	_cpm1_EXR_PUTBYTE:
  11: 9491+11	E9B4  E5      		PUSH	HL
  11: 9502+11	E9B5  F5      		PUSH	AF
  11: 9513+10	E9B6  210AFB  		LD	HL,rPORTC
  11:     -	E9B9          	_cpm1_pWP:
  11: 9523+7	E9B9  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11: 9530+7	E9BA  E680    		AND	80h		; выделяем сигнал -OBF
  11: 9537+10	E9BC  CAB9E9  		JP	Z,_cpm1_pWP		; -OBF=0 - в передатчике сидит незабранный байт
  11: 9547+10	E9BF  F1      		POP	AF
  11: 9557+13	E9C0  3208FB  		LD	(rPORTA),A		; данные поступили - выбираем их из порта А
  11: 9570+10	E9C3  E1      		POP	HL
  11: 9580+10	E9C4  C9      		RET
  11:				
  11:				;*******************************************
  11:				;*      Прием сектора                      *
  11:				;* HL - адрес размещения сектора в памяти  *
  11:				;*  Размер сектора - 128 байт              *
  11:				;*******************************************
  11:     -	E9C5          	_cpm1_EXR_GETSEC:
  11: 9590+4	E9C5  F3      		di
  11: 9594+11	E9C6  C5      		PUSH	BC
  11: 9605+11	E9C7  D5      		PUSH	DE
  11: 9616+7	E9C8  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
  11: 9623+4	E9CA  EB      		EX	DE,HL		; адрес буфера -> DE
  11: 9627+10	E9CB  210AFB  		LD	HL,rPORTC
  11:     -	E9CE          	_cpm1_pGSL:
  11: 9637+7	E9CE  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11: 9644+7	E9CF  E620    		AND	20h		; выделяем сигнал IBF
  11: 9651+10	E9D1  CACEE9  		JP	Z,_cpm1_pGSL		; IBF=0 - данных еще нет
  11: 9661+13	E9D4  3A08FB  		LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
  11: 9674+7	E9D7  12      		LD	(DE),A		; принимаем и размещаем очередной байт
  11: 9681+6	E9D8  13      		INC	DE		; указатель буфера ++
  11: 9687+4	E9D9  0D      		DEC	C		; принимаем остальные байты
  11: 9691+10	E9DA  C2CEE9  		JP	NZ,_cpm1_pGSL
  11: 9701+10	E9DD  D1      		POP	DE
  11: 9711+10	E9DE  C1      		POP	BC
  11:				; 	ei - int should be still disabled 
  11: 9721+10	E9DF  C9      		RET
  11:				
  11:				;*******************************************
  11:				;*      Передача сектора                   *
  11:				;* HL - адрес размещения сектора в памяти  *
  11:				;*  Размер сектора - 128 байт              *
  11:				;*******************************************
  11:     -	E9E0          	_cpm1_EXR_PUTSEC:
  11: 9731+4	E9E0  F3      		di
  11: 9735+11	E9E1  C5      		PUSH	BC
  11: 9746+11	E9E2  D5      		PUSH	DE
  11: 9757+7	E9E3  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
  11: 9764+4	E9E5  EB      		EX	DE,HL		; адрес буфера -> DE
  11: 9768+10	E9E6  210AFB  		LD	HL,rPORTC
  11:     -	E9E9          	_cpm1_pPSL:
  11: 9778+7	E9E9  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11: 9785+7	E9EA  E680    		AND	80h		; выделяем сигнал -OBF
  11: 9792+10	E9EC  CAE9E9  		JP	Z,_cpm1_pPSL		; -OBF=0 - в передатчике сидит незабранный байт
  11: 9802+7	E9EF  1A      		LD	A,(DE)		; принимаем и размещаем очередной байт
  11: 9809+13	E9F0  3208FB  		LD	(rPORTA),A		; данные поступили - выбираем их из порта А
  11: 9822+6	E9F3  13      		INC	DE
  11: 9828+4	E9F4  0D      		DEC	C		; принимаем остальные байты
  11: 9832+10	E9F5  C2E9E9  		JP	NZ,_cpm1_pPSL
  11: 9842+10	E9F8  D1      		POP	DE
  11: 9852+10	E9F9  C1      		POP	BC
  11:				; 	ei - int should be still disabled 
  11: 9862+10	E9FA  C9      		RET
  11:				
  11:				;****************************************
  11:				;*     Отправка командного пакета       *
  11:				;****************************************
  11:     -	E9FB          	_cpm1_EXR_SENDCMD:
  11:				
  11: 9872+4	E9FB  F3      		di
  11: 9876+11	E9FC  E5      		PUSH	HL
  11: 9887+11	E9FD  C5      		PUSH	BC
  11: 9898+7	E9FE  3E0C    		LD	A,0Ch
  11: 9905+13	EA00  320BFB  		LD	(rPCWR),A	; переключаем порт в режим 2
  11: 9918+10	EA03  213FEA  		LD	HL,_cpm1_EXR_CMD
  11: 9928+7	EA06  0E04    		LD	C,4		; пакет - 4 байта
  11: 9935+7	EA08  0600    		LD	B,0		; заготовка контрольной суммы
  11:     -	EA0A          	_cpm1_pSCL:
  11: 9942+7	EA0A  7E      		LD	A,(HL)		; очередной байт пакета 
  11: 9949+4	EA0B  80      		ADD 	B		; добавляем к КС
  11: 9953+4	EA0C  47      		LD	B,A
  11: 9957+7	EA0D  7E      		LD	A,(HL)		; очередной байт пакета 
  11: 9964+17	EA0E  CDB4E9  		CALL	_cpm1_EXR_PUTBYTE		; - в порт
  11: 9981+6	EA11  23      		INC	HL
  11: 9987+4	EA12  0D      		DEC	C
  11: 9991+10	EA13  C20AEA  		JP	NZ,_cpm1_pSCL
  11:10001+4	EA16  78      		LD	A,B
  11:10005+4	EA17  3D      		DEC 	A		; КС-1
  11:10009+17	EA18  CDB4E9  		CALL	_cpm1_EXR_PUTBYTE     ; контрольная сумма
  11:10026+17	EA1B  CDA5E9  		CALL	_cpm1_EXR_GETBYTE	; ответ контроллера
  11:10043+10	EA1E  C1      		POP	BC
  11:10053+10	EA1F  E1      		POP	HL
  11:				; 	ei - int should be still disabled 
  11:10063+10	EA20  C9      		RET
  11:				
  11:				;*******************************************
  11:				;*  Чтение информационного сектора
  11:				;*******************************************
  11:     -	EA21          	_cpm1_EXR_READINFO:
  11:10073+10	EA21  213FEA  		LD	HL,_cpm1_EXR_CMD	; командный пакет
  11:10083+10	EA24  3601    		LD	(HL),1		; команда чтения
  11:10093+6	EA26  23      		INC	HL
  11:     -	EA27          	_cpm1_r_p_DSK3:
  11:10099+13	EA27  3AFFFF  		LD	A,(_DSK)	; вписываем # устройства
  11:10112+7	EA2A  77      		LD	(HL),A
  11:10119+6	EA2B  23      		INC	HL
  11:10125+10	EA2C  3600    		LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
  11:10135+6	EA2E  23      		INC	HL
  11:10141+10	EA2F  3600    		LD	(HL),0		
  11:10151+17	EA31  CDFBE9  		CALL	_cpm1_EXR_SENDCMD	; отправляем команду
  11:10168+4	EA34  B7      		OR	A
  11:10172+5+6	EA35  C8      		RET 	Z		; ошибка
  11:10177+10	EA36  2100EE  		LD	HL,_RRBUFF	; принимаем данные
  11:10187+17	EA39  CDC5E9  		CALL	_cpm1_EXR_GETSEC
  11:10204+7	EA3C  3E01    		LD	A,1
  11:10211+10	EA3E  C9      		RET
  11:				
  11:				
  11:				; Командный пакет интерфейса Extrom-API
  11:				;===============================================
  11:     -	EA3F  00      	_cpm1_EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
  11:     -	EA40  00      	_cpm1_EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
  11:     -	EA41  00      	_cpm1_EXR_TRK:	DB	0	; логическая дорожка
  11:     -	EA42  00      	_cpm1_EXR_SEC:	DB	0	; логический сектор (128b)
  11:				
  11:     -	EA43          		endm
  12:				
  13:     -	2CAE          		.dephase
  14:				
  15:     -	0197          	resident_cpm1_len 		equ	$-resident_cpm1
  16:				
  17:				; minimum hole_start .. min hole_end
  18:     -	02FA          	max_resident_cpm1_len 	equ 	0xEBA6-0xE8AC ;=762
  19:				
  20:     -	0163          	available_resident_cpm1_len	equ 	max_resident_cpm1_len-resident_cpm1_len
  21:				
  22:     -	0001          		.assert max_resident_cpm1_len>=resident_cpm1_len
**** generator/V0/extrom-patcher.asm ****
 737:					include 	"extrom-patcher-resident-cpm2.asm"
**** extrom-patcher-resident-cpm2.asm ****
   1:					;    12_87_11_niijaf
   2:					;  EA06-EDFD = 1015  
   3:					;
   4:					
   5:     -	2CAE          	resident_cpm2	equ $
   6:				
   7:     -	EA06          		.phase 0xea06
   8:				
   9:     -	EA06          	resident_cpm2_addr 	EQU 	$
  10:				
  11:     -	EA06          		cpm_resident_body _cpm2_
  11:				
  11:				;keyhook support removed 2014-10-22
  11:				;больше нет нужды в ней, т.к. есть диск F
  11:				; preffix&kbd_hook_noCtrl_03;
  11:				; 	ld 	(preffix&save_a),a
  11:				; 	cp 	0x03
  11:				; 	jp 	preffix&kbd_hook_noCtrl_chk
  11:				
  11:				; preffix&kbd_hook_noCtrl_33:
  11:				; 	ld 	(preffix&save_a),a
  11:				; 	cp 	0x33
  11:				
  11:				; preffix&kbd_hook_noCtrl_chk:
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; 	ld 	a,(0xf880)
  11:				; 	and 	00100001b
  11:				; 	cp 	00100001b
  11:				
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; 	jp 	preffix&do_key_action
  11:				
  11:				; preffix&kbd_hook_2133:
  11:				; 	ld 	(preffix&save_a),a
  11:				; 	ld 	a,c
  11:				; 	cp 	0x33 	;stop
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; 	ld 	a,b
  11:				; 	cp 	0x21 	;ctrl+stop
  11:				; 	jp 	nz,preffix&bios_hook
  11:				
  11:				; preffix&do_key_action:
  11:				; 	push 	hl
  11:				; 	push 	de
  11:				; 	push 	bc
  11:				; 	ld 	hl,preffix&msg_hook
  11:				; 	ld 	de,0xfc00
  11:				; preffix&.kmlp:	
  11:				; 	ld 	a,(hl)
  11:				; 	or 	a
  11:				; 	jp 	z,preffix&.kmlp_ext
  11:				; 	ld 	(de),a
  11:				; 	inc 	hl
  11:				; 	inc 	de
  11:				; 	jp 	preffix&.kmlp
  11:				
  11:				; preffix&.kmlp_ext:
  11:				; 	pop 	bc
  11:				; 	pop 	de
  11:				; 	pop 	hl
  11:				
  11:				; 	ld 	bc,0 	;simulate no key
  11:				; 	ld 	a,0
  11:				; 	jp 	preffix&old_hook
  11:				; ; 	halt
  11:				
  11:				
  11:				; preffix&bios_hook:
  11:				; 	ld 	a,(preffix&save_a)
  11:				
  11:				; preffix&old_hook:
  11:				; 	jp 	$
  11:				; preffix&save_a:
  11:				; 	db 	0	
  11:				; preffix&msg_hook:
  11:				; 	db 	'CTRL+SHIFT+STOP pressed',0
  11:				
  11:				;ptrs to drive drvreg bytes 
  11:     -	EA06          	_cpm2_res_DRIVE_TAB:
  11:     -	EA06  0000    		dw 	0 	;A
  11:     -	EA08  0000    		dw 	0 	;B
  11:     -	EA0A  0000    		dw 	0 	;C
  11:     -	EA0C  0000    		dw 	0 	;D
  11:     -	EA0E  0000    		dw 	0 	;E
  11:     -	EA10  0000    		dw 	0 	;F
  11:				
  11:				
  11:     -	EA12          	_cpm2_dph_F:
  11:     -	EA12  0000    		dw	0	;_XLT:           
  11:     -	EA14  0000    		dw	0	;_1:             
  11:     -	EA16  0000    		dw	0	;_2:             
  11:     -	EA18  0000    		dw	0	;_3:             
  11:     -	EA1A  00FC    		dw	0xFC00	;DirBuf: value store here via patcher 0xfc00 - debug
  11:     -	EA1C  2AEA    		dw	_cpm2_dpb_F	;DPB:   
  11:     -	EA1E  0000    		dw	0	;CSV: - fixed drive   
  11:     -	EA20  39EA    		dw	_cpm2_alw_F	;ALV:   
  11:				
  11:				
  11:				;  ФИЗИЧЕСКИЕ ПАРАМЕТРЫ ДИСКА
  11:				;--------------------------------------
  11:     -	EA22  50      	      DB 50H	;контрольная сумма
  11:				
  11:     -	EA23  80      	      DB 080H ;константа скорости движения головки.
  11:				;	; 3 - 30 мс на шаг, 2 - 20 мс, 1 - 12 мс,
  11:				;	; 0 - 6 мс и 80H - 3 мс.
  11:     -	EA24  05      	      DB 05H  ; число физических секторов на дорожке
  11:     -	EA25  01      	      DB 01H  ; информация о сторонах диска
  11:				;	;( 00 - односторонный диск
  11:				;	;  01 - двухсторонний диск
  11:     -	EA26  03      	      DB 03	; 512 bytes/sector
  11:				;	;( 00 - 128 байт/сектор
  11:				;	;  01 - 256 байт/сектор
  11:				;	;  02 - 512 байт/сектор
  11:				;	;  03 - 1024 байт/сектор
  11:     -	EA27  00      	      DB 0	; номер текущей дорожки.
  11:     -	EA28  00      	      DB 0	; позиционный номер устройства (00000100) - для записи в регистр выбора
  11:				;---------------------------------------------------
  11:     -	EA29  00      	      DB 0	;INFO	; флаг успешного считывания
  11:				
  11:     -	EA2A          	_cpm2_dpb_F:
  11:				; kdi params
  11:     -	EA2A  2800    	      DW 40	;128 байтовых секторов/трек ; SPT
  11:     -	EA2C  04      	      DB 4	; размер блока миним.кбайт  ; BSH
  11:				;	; фактор сдвига блока распределения данных
  11:				;	; определяется размером блока данных. Блок 
  11:				;	; данных - минимально возможная частица файла.
  11:				;	; Размер блока - 1, 2, 4, 8 или 16 Кбайт. Если
  11:				;	; блок имеет большой размер, в каждом файле 
  11:				;	; теряется значительное число неиспользуемых
  11:				;	; секторов. При уменьшении размера блока
  11:				;	; увеличивается размер директории, описывающий
  11:				;	; расположение частей файла. BSH = log2[число
  11:				;	; логических секторов в блоке].
  11:     -	EA2D  0F      	      DB 15	; число логических сек/блок  ; BLM
  11:				;	; маска блока распределения данных.
  11:				;	; BLM = (число логических секторов в блоке)-1.
  11:     -	EA2E  00      	      DB 0	; extent mask                ; EXM
  11:				;	; = (BLM+1)*128/1024 - 1 - [DSM/256]. EXM - 
  11:				;	; вспомогательная величина для определения
  11:				;	; номера extent'а.
  11:				;	; extent - часть файла, описываемая одним 
  11:				;	; входом в директорию.
  11:     -	EA2F  8A01    	      DW 394	; обьем диска в блоках-1     ; DSM
  11:     -	EA31  7F00    	      DW 127	; входов в директорий-1      ; DRM
  11:     -	EA33  C0      	      DB 192	; определяет, какие блоки    ; AL0
  11:				;	; зарезервированы
  11:     -	EA34  00      	      DB 0	; alloc 1                    ; AL1
  11:				;	; под директорию. Каждый  бит AL0,AL1, 
  11:				;	; начиная со старшего бита AL0 и кончая 
  11:				;	; младшим битом AL1, значением 1 резервирует
  11:				;	; один блок данных для директории. Нужно
  11:				;	; резервировать необходимое число блоков
  11:				;	; для хранения входов в директорию: 32*DRM/BLS
  11:     -	EA35  0000    	      DW 0	; размер вектора контроля директории. ; CKS
  11:				;	; CKS=(DRM+1)/4. Если диск не сменяем, CKS=0.
  11:     -	EA37  0200    	      DW 2	; число системных дорожек    ; OFS
  11:				
  11:				
  11:				; preffix&alw_F: 	ds 	50
  11:     -	EA39 .. EA6A 00	_cpm2_alw_F: 	ds 	50
  11:				
  11:				
  11:     -	EA6B          	_cpm2_res_seldsk:
  11:10221+4	EA6B  79      		ld 	a,c
  11:10225+7	EA6C  FEFE    		cp 	0xfe
  11:     -	EA6E          	_cpm2_old_seld_dsk:
  11:10232+10	EA6E  C26EEA  		jp 	nz,$	
  11:10242+10	EA71  2106EA  		ld 	hl,_cpm2_res_DRIVE_TAB
  11:10252+10	EA74  C9      		ret
  11:				
  11:				
  11:				;RAM:DA27 C3 EB DC                 jp      j_READ
  11:				
  11:				;RAM:DCEB          j_READ:                                 ; CODE XREF: RAM:_READj
  11:				;RAM:DCEB                                                  ; RAM:DB84p
  11:				;RAM:DCEB
  11:				;RAM:DCEB          ; FUNCTION CHUNK AT RAM:DDC4 SIZE 0000007B BYTES
  11:				;RAM:DCEB
  11:				;RAM:DCEB 3E 04                    ld      a, 4
  11:				;RAM:DCED 32 66 E0                 ld      (_OPERATION), a
  11:				;RAM:DCF0 3A 64 E0                 ld      a, (_DSK)
  11:				;RAM:DCF3 FE 04                    cp      4
  11:				;RAM:DCF5 CA C4 DD                 jp      z, loc_DDC4
  11:				
  11:				;сюда попадает из биоса JP READ
  11:				;а если не наше то прыгаем на старый read
  11:     -	EA75          	_cpm2_res_READ:
  11:				; 	ld	 A,4	;Режим чтения
  11:				; 	ld  	(_OPER),a
  11:     -	EA75          	_cpm2_r_p_DSK1:
  11:10262+13	EA75  3AFFFF  		ld 	a,(_DSK) 	;_DSK
  11:10275+7	EA78  FE04    		cp 	4
  11:10282+10	EA7A  CAAFEA  		jp 	z,_cpm2__old_read
  11:				
  11:10292+7	EA7D  FE05    		cp 	5 		;disk F mapped to EMU drive E
  11:10299+10	EA7F  C283EA  		jp 	nz,_cpm2_.r_no_drv_dec
  11:10309+4	EA82  3D      		dec 	a
  11:				
  11:     -	EA83          	_cpm2_.r_no_drv_dec:
  11:10313+13	EA83  329AEB  		LD	(_cpm2_EXR_DRV),A	; # устройства
  11:				
  11:10326+11	EA86  E5      		push 	hl
  11:     -	EA87          	_cpm2_r_p_SELDSKDRIVER:
  11:10337+16	EA87  2A0000  		ld 	hl,(0)	;EXR_SELDSK_DRIVE
  11:10353+7	EA8A  7E      		ld 	a,(hl)
  11:10360+10	EA8B  E1      		pop 	hl
  11:10370+4	EA8C  B7      		or 	a
  11:10374+10	EA8D  C2AFEA  		jp 	nz,_cpm2__old_read
  11:				
  11:     -	EA90          	_cpm2_r_p_TRK1:
  11:10384+13	EA90  3AFFFF  		LD	A,(_TRK)	
  11:10397+13	EA93  329BEB  		LD	(_cpm2_EXR_TRK),A	; дорожка
  11:     -	EA96          	_cpm2_r_p_SEC1:
  11:10410+13	EA96  3AFFFF  		LD	A,(_SEC)	; сектор
  11:10423+4	EA99  3D      		DEC	A		; у нас номер сектора начинается с 0
  11:10427+13	EA9A  329CEB  		LD	(_cpm2_EXR_SEC),A
  11:				
  11:10440+7	EA9D  3E01    		LD	A,1
  11:10447+13	EA9F  3299EB  		LD	(_cpm2_EXR_CMD),A	; 1 - команда чтения
  11:				
  11:10460+17	EAA2  CD55EB  		CALL	_cpm2_EXR_SENDCMD	; отсылаем команду
  11:10477+4	EAA5  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
  11:10481+5+6	EAA6  C0      		RET	NZ		; 0 - ошибка
  11:     -	EAA7          	_cpm2_r_p_DMA1:
  11:10486+16	EAA7  2AFFFF  		LD	HL,(_DMA)	; адрес буфера для приема данных
  11:10502+17	EAAA  CD1FEB  		CALL	_cpm2_EXR_GETSEC	; принимаем данные
  11:10519+4	EAAD  AF      		XOR	A		; завершение всегда успешно
  11:10523+10	EAAE  C9      		RET
  11:				;
  11:				
  11:     -	EAAF          	_cpm2__old_read:
  11:10533+10	EAAF  C3AFEA  		jp 	$
  11:				
  11:     -	EAB2          	_cpm2_res_WRITE:
  11:				; 	ld	 A,6	;Режим чтения
  11:				; 	ld  	(_OPER),a
  11:				
  11:     -	EAB2          	_cpm2_r_p_DSK2:
  11:10543+13	EAB2  3AFFFF  		ld 	a,(_DSK) 	;_DSK
  11:10556+7	EAB5  FE04    		cp 	4
  11:10563+10	EAB7  CAECEA  		jp 	z,_cpm2__old_write
  11:10573+7	EABA  FE05    		cp 	5 		;disk F mapped to EMU drive E
  11:10580+10	EABC  C2C0EA  		jp 	nz,_cpm2_.w_no_drv_dec
  11:10590+4	EABF  3D      		dec 	a
  11:     -	EAC0          	_cpm2_.w_no_drv_dec:
  11:10594+13	EAC0  329AEB  		LD	(_cpm2_EXR_DRV),A
  11:				
  11:				
  11:10607+11	EAC3  E5      		push 	hl
  11:     -	EAC4          	_cpm2_r_p_SELDSKDRIVEW:
  11:10618+16	EAC4  2A0000  		ld 	hl,(0)	;EXR_SELDSK_DRIVE
  11:10634+7	EAC7  7E      		ld 	a,(hl)
  11:10641+10	EAC8  E1      		pop 	hl
  11:10651+4	EAC9  B7      		or 	a
  11:10655+10	EACA  C2ECEA  		jp 	nz,_cpm2__old_write
  11:				
  11:     -	EACD          	_cpm2_r_p_TRK2:
  11:10665+13	EACD  3AFFFF  		LD	A,(_TRK)
  11:10678+13	EAD0  329BEB  		LD	(_cpm2_EXR_TRK),A
  11:     -	EAD3          	_cpm2_r_p_SEC2:
  11:10691+13	EAD3  3AFFFF  		LD	A,(_SEC)
  11:10704+4	EAD6  3D      		DEC	A
  11:10708+13	EAD7  329CEB  		LD	(_cpm2_EXR_SEC),A
  11:				
  11:10721+7	EADA  3E02    		LD	A,2		; 2 - команда записи
  11:10728+13	EADC  3299EB  		LD	(_cpm2_EXR_CMD),A
  11:				
  11:10741+17	EADF  CD55EB  		CALL	_cpm2_EXR_SENDCMD
  11:10758+4	EAE2  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
  11:10762+5+6	EAE3  C0      		RET	NZ		; 0 - ошибка
  11:     -	EAE4          	_cpm2_r_p_DMA2:
  11:10767+16	EAE4  2AFFFF  		LD	HL,(_DMA)
  11:10783+17	EAE7  CD3AEB  		CALL	_cpm2_EXR_PUTSEC
  11:10800+4	EAEA  AF      		XOR	A		; запись успешна
  11:10804+10	EAEB  C9      		RET
  11:				
  11:     -	EAEC          	_cpm2__old_write:
  11:10814+10	EAEC  C3ECEA  		jp 	$
  11:				
  11:				
  11:     -	EAEF          	_cpm2_res_GETINFO:
  11:				
  11:10824+7	EAEF  7E      		LD 	A,(HL)	; A= маска выбора привода
  11:10831+4	EAF0  B7      		or 	a
  11:10835+10	EAF1  C2FCEA  		jp 	nz,_cpm2__old_getinfo 	;=0 if emulated
  11:				
  11:				;
  11:				;  Чтение с эмулируемых дисков A или B
  11:				;
  11:10845+11	EAF4  E5      		push 	hl
  11:10856+17	EAF5  CD7BEB  		CALL	_cpm2_EXR_READINFO
  11:10873+4	EAF8  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
  11:				; 	JP	NZ,0xE6ff	;IERR		; 0 - ошибка
  11:     -	EAF9          	_cpm2__old_getinfo_chkdo:
  11:10877+10	EAF9  C3F9EA  		JP	$ 		;IERR jnz xxx, CHKDO
  11:				; ;
  11:     -	EAFC          	_cpm2__old_getinfo:
  11:10887+10	EAFC  C3FCEA  		jp 	$ 		;GETINFO
  11:				
  11:				
  11:				;==================  Драйвер ExtROM-API ====================================
  11:					
  11:					
  11:				;****************************************
  11:				;*  Прием байта из порта А по стробу    *
  11:				;****************************************
  11:     -	EAFF          	_cpm2_EXR_GETBYTE:
  11:10897+11	EAFF  E5      		PUSH	HL
  11:10908+10	EB00  210AFB  		LD	HL,rPORTC
  11:     -	EB03          	_cpm2_pWG:
  11:10918+7	EB03  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11:10925+7	EB04  E620    		AND	20h		; выделяем сигнал IBF
  11:10932+10	EB06  CA03EB  		JP	Z,_cpm2_pWG		; IBF=0 - данных еще нет
  11:10942+13	EB09  3A08FB  		LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
  11:10955+10	EB0C  E1      		POP	HL
  11:10965+10	EB0D  C9      		RET
  11:				
  11:				;****************************************
  11:				;*  Отправка байта в порт A             *
  11:				;****************************************
  11:     -	EB0E          	_cpm2_EXR_PUTBYTE:
  11:10975+11	EB0E  E5      		PUSH	HL
  11:10986+11	EB0F  F5      		PUSH	AF
  11:10997+10	EB10  210AFB  		LD	HL,rPORTC
  11:     -	EB13          	_cpm2_pWP:
  11:11007+7	EB13  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11:11014+7	EB14  E680    		AND	80h		; выделяем сигнал -OBF
  11:11021+10	EB16  CA13EB  		JP	Z,_cpm2_pWP		; -OBF=0 - в передатчике сидит незабранный байт
  11:11031+10	EB19  F1      		POP	AF
  11:11041+13	EB1A  3208FB  		LD	(rPORTA),A		; данные поступили - выбираем их из порта А
  11:11054+10	EB1D  E1      		POP	HL
  11:11064+10	EB1E  C9      		RET
  11:				
  11:				;*******************************************
  11:				;*      Прием сектора                      *
  11:				;* HL - адрес размещения сектора в памяти  *
  11:				;*  Размер сектора - 128 байт              *
  11:				;*******************************************
  11:     -	EB1F          	_cpm2_EXR_GETSEC:
  11:11074+4	EB1F  F3      		di
  11:11078+11	EB20  C5      		PUSH	BC
  11:11089+11	EB21  D5      		PUSH	DE
  11:11100+7	EB22  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
  11:11107+4	EB24  EB      		EX	DE,HL		; адрес буфера -> DE
  11:11111+10	EB25  210AFB  		LD	HL,rPORTC
  11:     -	EB28          	_cpm2_pGSL:
  11:11121+7	EB28  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11:11128+7	EB29  E620    		AND	20h		; выделяем сигнал IBF
  11:11135+10	EB2B  CA28EB  		JP	Z,_cpm2_pGSL		; IBF=0 - данных еще нет
  11:11145+13	EB2E  3A08FB  		LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
  11:11158+7	EB31  12      		LD	(DE),A		; принимаем и размещаем очередной байт
  11:11165+6	EB32  13      		INC	DE		; указатель буфера ++
  11:11171+4	EB33  0D      		DEC	C		; принимаем остальные байты
  11:11175+10	EB34  C228EB  		JP	NZ,_cpm2_pGSL
  11:11185+10	EB37  D1      		POP	DE
  11:11195+10	EB38  C1      		POP	BC
  11:				; 	ei - int should be still disabled 
  11:11205+10	EB39  C9      		RET
  11:				
  11:				;*******************************************
  11:				;*      Передача сектора                   *
  11:				;* HL - адрес размещения сектора в памяти  *
  11:				;*  Размер сектора - 128 байт              *
  11:				;*******************************************
  11:     -	EB3A          	_cpm2_EXR_PUTSEC:
  11:11215+4	EB3A  F3      		di
  11:11219+11	EB3B  C5      		PUSH	BC
  11:11230+11	EB3C  D5      		PUSH	DE
  11:11241+7	EB3D  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
  11:11248+4	EB3F  EB      		EX	DE,HL		; адрес буфера -> DE
  11:11252+10	EB40  210AFB  		LD	HL,rPORTC
  11:     -	EB43          	_cpm2_pPSL:
  11:11262+7	EB43  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
  11:11269+7	EB44  E680    		AND	80h		; выделяем сигнал -OBF
  11:11276+10	EB46  CA43EB  		JP	Z,_cpm2_pPSL		; -OBF=0 - в передатчике сидит незабранный байт
  11:11286+7	EB49  1A      		LD	A,(DE)		; принимаем и размещаем очередной байт
  11:11293+13	EB4A  3208FB  		LD	(rPORTA),A		; данные поступили - выбираем их из порта А
  11:11306+6	EB4D  13      		INC	DE
  11:11312+4	EB4E  0D      		DEC	C		; принимаем остальные байты
  11:11316+10	EB4F  C243EB  		JP	NZ,_cpm2_pPSL
  11:11326+10	EB52  D1      		POP	DE
  11:11336+10	EB53  C1      		POP	BC
  11:				; 	ei - int should be still disabled 
  11:11346+10	EB54  C9      		RET
  11:				
  11:				;****************************************
  11:				;*     Отправка командного пакета       *
  11:				;****************************************
  11:     -	EB55          	_cpm2_EXR_SENDCMD:
  11:				
  11:11356+4	EB55  F3      		di
  11:11360+11	EB56  E5      		PUSH	HL
  11:11371+11	EB57  C5      		PUSH	BC
  11:11382+7	EB58  3E0C    		LD	A,0Ch
  11:11389+13	EB5A  320BFB  		LD	(rPCWR),A	; переключаем порт в режим 2
  11:11402+10	EB5D  2199EB  		LD	HL,_cpm2_EXR_CMD
  11:11412+7	EB60  0E04    		LD	C,4		; пакет - 4 байта
  11:11419+7	EB62  0600    		LD	B,0		; заготовка контрольной суммы
  11:     -	EB64          	_cpm2_pSCL:
  11:11426+7	EB64  7E      		LD	A,(HL)		; очередной байт пакета 
  11:11433+4	EB65  80      		ADD 	B		; добавляем к КС
  11:11437+4	EB66  47      		LD	B,A
  11:11441+7	EB67  7E      		LD	A,(HL)		; очередной байт пакета 
  11:11448+17	EB68  CD0EEB  		CALL	_cpm2_EXR_PUTBYTE		; - в порт
  11:11465+6	EB6B  23      		INC	HL
  11:11471+4	EB6C  0D      		DEC	C
  11:11475+10	EB6D  C264EB  		JP	NZ,_cpm2_pSCL
  11:11485+4	EB70  78      		LD	A,B
  11:11489+4	EB71  3D      		DEC 	A		; КС-1
  11:11493+17	EB72  CD0EEB  		CALL	_cpm2_EXR_PUTBYTE     ; контрольная сумма
  11:11510+17	EB75  CDFFEA  		CALL	_cpm2_EXR_GETBYTE	; ответ контроллера
  11:11527+10	EB78  C1      		POP	BC
  11:11537+10	EB79  E1      		POP	HL
  11:				; 	ei - int should be still disabled 
  11:11547+10	EB7A  C9      		RET
  11:				
  11:				;*******************************************
  11:				;*  Чтение информационного сектора
  11:				;*******************************************
  11:     -	EB7B          	_cpm2_EXR_READINFO:
  11:11557+10	EB7B  2199EB  		LD	HL,_cpm2_EXR_CMD	; командный пакет
  11:11567+10	EB7E  3601    		LD	(HL),1		; команда чтения
  11:11577+6	EB80  23      		INC	HL
  11:     -	EB81          	_cpm2_r_p_DSK3:
  11:11583+13	EB81  3AFFFF  		LD	A,(_DSK)	; вписываем # устройства
  11:11596+7	EB84  77      		LD	(HL),A
  11:11603+6	EB85  23      		INC	HL
  11:11609+10	EB86  3600    		LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
  11:11619+6	EB88  23      		INC	HL
  11:11625+10	EB89  3600    		LD	(HL),0		
  11:11635+17	EB8B  CD55EB  		CALL	_cpm2_EXR_SENDCMD	; отправляем команду
  11:11652+4	EB8E  B7      		OR	A
  11:11656+5+6	EB8F  C8      		RET 	Z		; ошибка
  11:11661+10	EB90  2100EE  		LD	HL,_RRBUFF	; принимаем данные
  11:11671+17	EB93  CD1FEB  		CALL	_cpm2_EXR_GETSEC
  11:11688+7	EB96  3E01    		LD	A,1
  11:11695+10	EB98  C9      		RET
  11:				
  11:				
  11:				; Командный пакет интерфейса Extrom-API
  11:				;===============================================
  11:     -	EB99  00      	_cpm2_EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
  11:     -	EB9A  00      	_cpm2_EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
  11:     -	EB9B  00      	_cpm2_EXR_TRK:	DB	0	; логическая дорожка
  11:     -	EB9C  00      	_cpm2_EXR_SEC:	DB	0	; логический сектор (128b)
  11:				
  11:     -	EB9D          		endm
  12:				
  13:     -	2E45          		.dephase
  14:				
  15:     -	0197          	resident_cpm2_len 		equ	$-resident_cpm2
  16:				
  17:				; minimum hole_start .. min hole_end
  18:     -	03F7          	max_resident_cpm2_len 	equ 	0xEDFD-0xEA06 ;=1015
  19:				
  20:     -	0260          	available_resident_cpm2_len	equ 	max_resident_cpm2_len-resident_cpm2_len
  21:				
  22:     -	0001          		.assert max_resident_cpm2_len>=resident_cpm2_len
**** generator/V0/extrom-patcher.asm ****
 738:					include 	"extrom-patcher-resident-microdos.asm"
**** extrom-patcher-resident-microdos.asm ****
   1:     -	FE08          	MD_rPORTA	EQU	0FE08H		; Порт Канала A интерфейса расширения
   2:     -	FE0A          	MD_rPORTC	EQU	0FE0AH		; Порт Канала С интерфейса расширения
   3:     -	FE0B          	MD_rPCWR	EQU	0FE0BH		; Порт управляющих команд
   4:				
   5:     -	0000          	MD_RRBUFF 	EQU 	0
   6:				
   7:     -	2E45          	resident_md:
   8:				
   9:				; 	.phase 	0xFD80
  10:     -	FA00          		.phase 	0xFA00
  11:     -	FA00          	resident_md_addr 	EQU 	$
  12:				
  13:				
  14:				;мы тут в конфигуации 0x5C
  15:				
  16:				;Код Cfg    ПЗУ     ОЗУ        ГЗУ   ОЗУ2       Клав  Рег2  А/Ц   Рег1
  17:				;ID  Name   ROM     RAM        GZU   Ram2       KBD   REGS  ACZU  DEV
  18:				;______________________________________________________________________
  19:				;1C  ODOSA          0000-F7FF                   F800  FA00  FC00  FB00
  20:				;5C  DOSA           0000-FDFF                         FF00        FE00
  21:				
  22:				
  23:				
  24:				;PATCH --------------------------------------------------------------------------
  25:				
  26:				;do_dskIO
  27:				
  28:				; RAM:EAFD FE 04                    cp      4 		
  29:				; RAM:EAFF CA 36 EB                 jp      z, jREAD 		<--- MY write
  30:				; RAM:EB02 FE 06                    cp      6
  31:				; RAM:EB04 CA A0 EB                 jp      z, jWRITE 		<--- MY write
  32:				
  33:				
  34:				; SELDSK:
  35:				; RAM:EC87 CD 14 EE                 call    SEL_DSK_SEEK0       <--- 00 00 00
  36:				; RAM:EC8A CD 1E EE                 call    ReadToRDBUF 	<--- MY read info into F04E. nz if err 
  37:				
  38:				; RAM:EC3A          Flush?:                                 ; CODE XREF: do_DSKIO+6Ap
  39:				; RAM:EC3A                                                  ; do_DSKIO+9Ap ...
  40:				; RAM:EC3A 21 FD EE                 ld      hl, flagWriteReuired?
  41:				; RAM:EC3D 7E                       ld      a, (hl)
  42:				; RAM:EC3E B7                       or      a
  43:				; RAM:EC3F C8                       ret     z  			<--- C9, newer flush
  44:				; RAM:EC42 21 0A EF                 ld      hl, WrBufDiskInfo   <--- or C9 HERE
  45:				
  46:				
  47:				;DISKINFO -----------------------------------------------------------------------
  48:				
  49:				; RAM:EB36          jREAD:                                  ; CODE XREF: do_DSKIO+40j
  50:				; RAM:EB36 2A F8 EE                 ld      hl, (DSC_IO_HL) ; DSCDESCR
  51:				; RAM:EB39 46                       ld      b, (hl)         ; Drive
  52:				; RAM:EB3A 23                       inc     hl
  53:				
  54:				; RAM:EAF1 7E                       ld      a, (hl) 	    ;operation 3-reset?, 4-read,6-write
  55:				; RAM:EAF2 23                       inc     hl
  56:				
  57:				; RAM:EB3C 23                       inc     hl 		    ; ?chword?
  58:				; RAM:EB3D 23                       inc     hl              ; ?NumB?
  59:				
  60:				; RAM:EB3E 4E                       ld      c, (hl)         ; track
  61:				; RAM:EB3F 23                       inc     hl
  62:				
  63:				; RAM:EB40 7E                       ld      a, (hl)         ; sector
  64:				; RAM:EB3F 23                       inc     hl
  65:				
  66:				; RAM:EAF6 5E                       ld      e, (hl)
  67:				; RAM:EAF7 23                       inc     hl
  68:				; RAM:EAF8 56                       ld      d, (hl)
  69:				; RAM:EAF9 EB                       ex      de, hl
  70:				; RAM:EAFA 22 FA EE                 ld      (_DMA??), hl
  71:				;DISKINFO -----------------------------------------------------------------------
  72:     -	FA00          	md_res_DRIVEA:
  73:     -	FA00  00      		db 	0
  74:     -	FA01          	md_res_DRIVEB:
  75:     -	FA01  00      		db 	0
  76:				
  77:     -	FA02          	md_res_DRIVE_TAB:
  78:     -	FA02  00FA    		dw 	md_res_DRIVEA 	;A
  79:     -	FA04  01FA    		dw 	md_res_DRIVEB 	;B
  80:     -	FA06  0000    		dw 	0 	;C
  81:     -	FA08  0000    		dw 	0 	;D
  82:     -	FA0A  0000    		dw 	0 	;E
  83:     -	FA0C  0000    		dw 	0 	;F
  84:				
  85:     -	FA0E          	md_res_seldsk:
  86:11705+4	FA0E  79      		ld 	a,c
  87:11709+7	FA0F  FEFE    		cp 	0xfe
  88:     -	FA11          	md_old_seld_dsk:
  89:11716+10	FA11  C211FA  		jp 	nz,$	
  90:11726+10	FA14  2102FA  		ld 	hl,md_res_DRIVE_TAB
  91:11736+10	FA17  C9      		ret
  92:				
  93:     -	FA18          	md_fetch_params:
  94:				
  95:11746+11	FA18  F5      		push 	af
  96:11757+11	FA19  C5      		push 	bc
  97:11768+11	FA1A  D5      		push 	de
  98:11779+11	FA1B  E5      		push 	hl
  99:				
 100:     -	FA1C          	MD_PARAM2:
 101:11790+16	FA1C  2AF8EE  		ld      hl, (0xEEF8) ; DSCDESCR
 102:11806+7	FA1F  7E      		ld      a, (hl)         ; Drive
 103:11813+6	FA20  23      		inc     hl
 104:11819+13	FA21  320BFB  		ld 	(MD_EXR_DRV),a
 105:				
 106:				; 	ld      a, (hl)		;operation 3-reset?, 4-read,6-write
 107:11832+6	FA24  23      		inc     hl
 108:				
 109:11838+6	FA25  23      		inc     hl		; ?chword?
 110:11844+6	FA26  23      		inc     hl              ; ?NumB?
 111:				
 112:11850+7	FA27  7E      		ld      a, (hl)         ; track
 113:11857+6	FA28  23      		inc     hl
 114:11863+13	FA29  320CFB  		ld 	(MD_EXR_TRK),a
 115:				
 116:11876+7	FA2C  7E      		ld      a, (hl)         ; sector
 117:11883+4	FA2D  3D      		DEC	A
 118:11887+6	FA2E  23      		inc     hl
 119:11893+13	FA2F  320DFB  		ld 	(MD_EXR_SEC),a
 120:				
 121:11906+7	FA32  5E      		ld      e, (hl)
 122:11913+6	FA33  23      		inc     hl
 123:11919+7	FA34  56      		ld      d, (hl)
 124:11926+4	FA35  EB      		ex      de, hl
 125:11930+16	FA36  220EFB  		ld      (MD_DMA), hl
 126:				
 127:11946+10	FA39  E1      		pop 	hl
 128:11956+10	FA3A  D1      		pop 	de
 129:11966+10	FA3B  C1      		pop 	bc
 130:11976+10	FA3C  F1      		pop 	af
 131:				
 132:11986+10	FA3D  C9      		ret
 133:				
 134:     -	FA3E          	MD_READ:
 135:11996+17	FA3E  CD18FA  		call 	md_fetch_params
 136:					
 137:12013+7	FA41  3E01    		LD	A,1
 138:12020+13	FA43  320AFB  		LD	(MD_EXR_CMD),A	; 1 - команда чтения
 139:				
 140:12033+17	FA46  CDC5FA  		CALL	MD_EXR_SENDCMD	; отсылаем команду
 141:12050+4	FA49  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
 142:12054+5+6	FA4A  C0      		RET	NZ		; 0 - ошибка
 143:12059+16	FA4B  2A0EFB  		LD	HL,(MD_DMA)	; адрес буфера для приема данных
 144:12075+17	FA4E  CD8DFA  		CALL	MD_EXR_GETSEC	; принимаем данные
 145:12092+4	FA51  AF      		XOR	A		; завершение всегда успешно
 146:12096+10	FA52  C9      		RET
 147:				
 148:     -	FA53          	MD_WRITE:
 149:12106+17	FA53  CD18FA  		call	md_fetch_params
 150:				
 151:12123+7	FA56  3E02    		LD	A,2		; 2 - команда записи
 152:12130+13	FA58  320AFB  		LD	(MD_EXR_CMD),A
 153:				
 154:12143+17	FA5B  CDC5FA  		CALL	MD_EXR_SENDCMD
 155:12160+4	FA5E  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
 156:12164+5+6	FA5F  C0      		RET	NZ		; 0 - ошибка
 157:12169+16	FA60  2A0EFB  		LD	HL,(MD_DMA)
 158:12185+17	FA63  CDA9FA  		CALL	MD_EXR_PUTSEC
 159:12202+4	FA66  AF      		XOR	A		; запись успешна
 160:12206+10	FA67  C9      		RET
 161:				
 162:     -	FA68          	MD_READ_INFOSECTOR:
 163:12216+17	FA68  CDECFA  		CALL	MD_EXR_READINFO
 164:12233+4	FA6B  3D      		DEC	A		; ответ, 0 - ошибка, 1 - ОК
 165:12237+10	FA6C  C9      		ret
 166:				
 167:				
 168:				;==================  Драйвер ExtROM-API ====================================
 169:					
 170:					
 171:				;****************************************
 172:				;*  Прием байта из порта А по стробу    *
 173:				;****************************************
 174:     -	FA6D          	MD_EXR_GETBYTE:
 175:12247+11	FA6D  E5      		PUSH	HL
 176:12258+10	FA6E  210AFE  		LD	HL,MD_rPORTC
 177:     -	FA71          	MD_pWG:
 178:12268+7	FA71  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 179:12275+7	FA72  E620    		AND	20h		; выделяем сигнал IBF
 180:12282+10	FA74  CA71FA  		JP	Z,MD_pWG		; IBF=0 - данных еще нет
 181:12292+13	FA77  3A08FE  		LD	A,(MD_rPORTA)		; данные поступили - выбираем их из порта А
 182:12305+10	FA7A  E1      		POP	HL
 183:12315+10	FA7B  C9      		RET
 184:				
 185:				;****************************************
 186:				;*  Отправка байта в порт A             *
 187:				;****************************************
 188:     -	FA7C          	MD_EXR_PUTBYTE:
 189:12325+11	FA7C  E5      		PUSH	HL
 190:12336+11	FA7D  F5      		PUSH	AF
 191:12347+10	FA7E  210AFE  		LD	HL,MD_rPORTC
 192:     -	FA81          	MD_pWP:
 193:12357+7	FA81  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 194:12364+7	FA82  E680    		AND	80h		; выделяем сигнал -OBF
 195:12371+10	FA84  CA81FA  		JP	Z,MD_pWP		; -OBF=0 - в передатчике сидит незабранный байт
 196:12381+10	FA87  F1      		POP	AF
 197:12391+13	FA88  3208FE  		LD	(MD_rPORTA),A		; данные поступили - выбираем их из порта А
 198:12404+10	FA8B  E1      		POP	HL
 199:12414+10	FA8C  C9      		RET
 200:				
 201:				;*******************************************
 202:				;*      Прием сектора                      *
 203:				;* HL - адрес размещения сектора в памяти  *
 204:				;*  Размер сектора - 128 байт              *
 205:				;*******************************************
 206:     -	FA8D          	MD_EXR_GETSEC:
 207:12424+4	FA8D  F3      		di
 208:12428+11	FA8E  C5      		PUSH	BC
 209:12439+11	FA8F  D5      		PUSH	DE
 210:12450+7	FA90  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
 211:12457+4	FA92  EB      		EX	DE,HL		; адрес буфера -> DE
 212:12461+10	FA93  210AFE  		LD	HL,MD_rPORTC
 213:     -	FA96          	MD_pGSL:
 214:12471+7	FA96  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 215:12478+7	FA97  E620    		AND	20h		; выделяем сигнал IBF
 216:12485+10	FA99  CA96FA  		JP	Z,MD_pGSL		; IBF=0 - данных еще нет
 217:12495+13	FA9C  3A08FE  		LD	A,(MD_rPORTA)		; данные поступили - выбираем их из порта А
 218:12508+7	FA9F  12      		LD	(DE),A		; принимаем и размещаем очередной байт
 219:12515+6	FAA0  13      		INC	DE		; указатель буфера ++
 220:12521+4	FAA1  0D      		DEC	C		; принимаем остальные байты
 221:12525+10	FAA2  C296FA  		JP	NZ,MD_pGSL
 222:12535+10	FAA5  D1      		POP	DE
 223:12545+10	FAA6  C1      		POP	BC
 224:12555+4	FAA7  FB      		ei 		
 225:12559+10	FAA8  C9      		RET
 226:				
 227:				;*******************************************
 228:				;*      Передача сектора                   *
 229:				;* HL - адрес размещения сектора в памяти  *
 230:				;*  Размер сектора - 128 байт              *
 231:				;*******************************************
 232:     -	FAA9          	MD_EXR_PUTSEC:
 233:12569+4	FAA9  F3      		di
 234:12573+11	FAAA  C5      		PUSH	BC
 235:12584+11	FAAB  D5      		PUSH	DE
 236:12595+7	FAAC  0E80    		LD	C,128		; счетчик байтов сектора, всего 128 байт
 237:12602+4	FAAE  EB      		EX	DE,HL		; адрес буфера -> DE
 238:12606+10	FAAF  210AFE  		LD	HL,MD_rPORTC
 239:     -	FAB2          	MD_pPSL:
 240:12616+7	FAB2  7E      		LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
 241:12623+7	FAB3  E680    		AND	80h		; выделяем сигнал -OBF
 242:12630+10	FAB5  CAB2FA  		JP	Z,MD_pPSL		; -OBF=0 - в передатчике сидит незабранный байт
 243:12640+7	FAB8  1A      		LD	A,(DE)		; принимаем и размещаем очередной байт
 244:12647+13	FAB9  3208FE  		LD	(MD_rPORTA),A		; данные поступили - выбираем их из порта А
 245:12660+6	FABC  13      		INC	DE
 246:12666+4	FABD  0D      		DEC	C		; принимаем остальные байты
 247:12670+10	FABE  C2B2FA  		JP	NZ,MD_pPSL
 248:12680+10	FAC1  D1      		POP	DE
 249:12690+10	FAC2  C1      		POP	BC
 250:12700+4	FAC3  FB      		ei 		
 251:12704+10	FAC4  C9      		RET
 252:				
 253:				;****************************************
 254:				;*     Отправка командного пакета       *
 255:				;****************************************
 256:     -	FAC5          	MD_EXR_SENDCMD:
 257:				
 258:12714+4	FAC5  F3      		di
 259:12718+11	FAC6  E5      		PUSH	HL
 260:12729+11	FAC7  C5      		PUSH	BC
 261:12740+7	FAC8  3E0C    		LD	A,0Ch
 262:12747+13	FACA  320BFE  		LD	(MD_rPCWR),A	; переключаем порт в режим 2
 263:12760+10	FACD  210AFB  		LD	HL,MD_EXR_CMD
 264:12770+7	FAD0  0E04    		LD	C,4		; пакет - 4 байта
 265:12777+7	FAD2  0600    		LD	B,0		; заготовка контрольной суммы
 266:     -	FAD4          	MD_pSCL:
 267:12784+7	FAD4  7E      		LD	A,(HL)		; очередной байт пакета 
 268:12791+4	FAD5  80      		ADD 	B		; добавляем к КС
 269:12795+4	FAD6  47      		LD	B,A
 270:12799+7	FAD7  7E      		LD	A,(HL)		; очередной байт пакета 
 271:12806+17	FAD8  CD7CFA  		CALL	MD_EXR_PUTBYTE		; - в порт
 272:12823+6	FADB  23      		INC	HL
 273:12829+4	FADC  0D      		DEC	C
 274:12833+10	FADD  C2D4FA  		JP	NZ,MD_pSCL
 275:12843+4	FAE0  78      		LD	A,B
 276:12847+4	FAE1  3D      		DEC 	A		; КС-1
 277:12851+17	FAE2  CD7CFA  		CALL	MD_EXR_PUTBYTE     ; контрольная сумма
 278:12868+17	FAE5  CD6DFA  		CALL	MD_EXR_GETBYTE	; ответ контроллера
 279:12885+10	FAE8  C1      		POP	BC
 280:12895+10	FAE9  E1      		POP	HL
 281:12905+4	FAEA  FB      		ei 		
 282:12909+10	FAEB  C9      		RET
 283:				
 284:				;*******************************************
 285:				;*  Чтение информационного сектора
 286:				;*******************************************
 287:     -	FAEC          	MD_EXR_READINFO:
 288:12919+10	FAEC  210AFB  		LD	HL,MD_EXR_CMD	; командный пакет
 289:12929+10	FAEF  3601    		LD	(HL),1		; команда чтения
 290:12939+6	FAF1  23      		INC	HL
 291:     -	FAF2          	MD_DRV2:
 292:12945+13	FAF2  3A06EF  		LD	A,(0xEF06)	; вписываем # устройства
 293:12958+7	FAF5  77      		LD	(HL),A
 294:12965+6	FAF6  23      		INC	HL
 295:12971+10	FAF7  3600    		LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
 296:12981+6	FAF9  23      		INC	HL
 297:12987+10	FAFA  3600    		LD	(HL),0		
 298:12997+17	FAFC  CDC5FA  		CALL	MD_EXR_SENDCMD	; отправляем команду
 299:13014+4	FAFF  B7      		OR	A
 300:13018+5+6	FB00  C8      		RET 	Z		; ошибка
 301:     -	FB01          	MD_RDBUF2:
 302:13023+10	FB01  210000  		LD	HL,MD_RRBUFF	; принимаем данные
 303:13033+17	FB04  CD8DFA  		CALL	MD_EXR_GETSEC
 304:13050+7	FB07  3E01    		LD	A,1
 305:13057+10	FB09  C9      		RET
 306:				
 307:				
 308:				; Командный пакет интерфейса Extrom-API
 309:				;===============================================
 310:     -	FB0A  00      	MD_EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
 311:     -	FB0B  00      	MD_EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
 312:     -	FB0C  00      	MD_EXR_TRK:	DB	0	; логическая дорожка
 313:     -	FB0D  00      	MD_EXR_SEC:	DB	0	; логический сектор (128b)
 314:     -	FB0E  0000    	MD_DMA: 	DW 	0 	; адресс куда/откуда
 315:				
 316:     -	2F55          		.dephase
 317:     -	0110          	resident_md_len 	equ $-resident_md
 318:				
 319:				
**** generator/V0/extrom-patcher.asm ****
 739:					include 	"out/include-patcher.asm"
**** out/include-patcher.asm ****
   1:     -	2F55          	bios_variants:
   2:     -	2F55  952F    		dw	_BIOS_CPM_21_EXTROM
   3:     -	2F57  D52F    		dw	_BIOS_CPM_12_88_3_alternativa
   4:     -	2F59  C330    		dw	_BIOS_CPM_12_88_3_niijaf
   5:     -	2F5B  A031    		dw	_BIOS_CPM_21_89___wiza
   6:     -	2F5D  8232    		dw	_BIOS_MICRODOS_OPTS2_880630
   7:     -	2F5F  0233    		dw	_BIOS_CPM_21_89_2_niijaf2
   8:     -	2F61  E033    		dw	_BIOS_CPM_21_89_2_niijaf
   9:     -	2F63  BD34    		dw	_BIOS_MICRODOS_OPTS1_870430
  10:     -	2F65  3835    		dw	_BIOS_CPM_1x_89_03_30_RAVI
  11:     -	2F67  1836    		dw	_BIOS_MICRODOS_OPTS1_861011
  12:     -	2F69  9D36    		dw	_BIOS_CPM_21_91___LAP
  13:     -	2F6B  7737    		dw	_BIOS_CPM_20_88___miks
  14:     -	2F6D  5238    		dw	_BIOS_CPM_12_90_5_kontur
  15:     -	2F6F  2F39    		dw	_BIOS_MICRODOS_OPTS2_900105
  16:     -	2F71  B339    		dw	_BIOS_CPM_12_87_11_niijaf
  17:     -	2F73  913A    		dw	_BIOS_CPM_21m_____Shkanov
  18:     -	2F75  6F3B    		dw	_BIOS_CPM_12_87_09_NIIJAF
  19:     -	2F77  4D3C    		dw	_BIOS_MICRODOS_OPTS1_871220
  20:     -	2F79  CD3C    		dw	_BIOS_MICRODOS_OPTS1_861115
  21:     -	2F7B  523D    		dw	_BIOS_CPM_NET_SFERA1
  22:     -	2F7D  9B3D    		dw	_BIOS_CPM_NET_KORNET_drive_b
  23:     -	2F7F  C93D    		dw	_BIOS_CPM_NET_KORNET_drive_a
  24:     -	2F81  1A3E    		dw	_BIOS_CPM_1x_88_EPSON_V104
  25:     -	2F83  FA3E    		dw	_BIOS_CPM_NET_SFERA2
  26:     -	2F85  0000    		dw	0
  27:				
  28:     -	2F87  50415443		db 	"PATCHER DATA>>"
	      48455220
	      44415441
	      3E3E
  29:				
  30:					include "generator/V0/out/patcher-cpm_chk-CPM_21_EXTROM.asm"
**** generator/V0/out/patcher-cpm_chk-CPM_21_EXTROM.asm ****
   1:     -	2F95          	_BIOS_CPM_21_EXTROM:
   2:     -	2F95          		setCPM
   2:     -	2F95          		endm
   3:     -	2F95          		setSUBBIOS 3
   3:     -	2F95  5A      		db	pSubBios
   3:     -	2F96  03      		db 	3
   3:     -	2F97          		endm
   4:     -	2F97          		dwstore	drivetab_mount_info	,0xDA3F
   4:     -	2F97  54      		db 	pW_STORE
   4:     -	2F98  3FDA    		dw 	0xDA3F
   4:     -	2F9A  6F2A    		dw 	drivetab_mount_info
   4:     -	2F9C          		endm
   5:					;custom checkers
   6:     -	2F9C          		dwpatch	0xDA33+0	,0x5845 ,0x5845
   6:     -	2F9C  51      		db 	pW_CHK_PATCH
   6:     -	2F9D  33DA    		dw 	0xDA33+0
   6:     -	2F9F  45584558		dw 	0x5845,0x5845
   6:     -	2FA3          		endm
   7:     -	2FA3          		dwpatch	0xDA33+2	,0x5254 ,0x5254
   7:     -	2FA3  51      		db 	pW_CHK_PATCH
   7:     -	2FA4  35DA    		dw 	0xDA33+2
   7:     -	2FA6  54525452		dw 	0x5254,0x5254
   7:     -	2FAA          		endm
   8:     -	2FAA          		dwpatch	0xDA33+4	,0x4D4F ,0x4D4F
   8:     -	2FAA  51      		db 	pW_CHK_PATCH
   8:     -	2FAB  37DA    		dw 	0xDA33+4
   8:     -	2FAD  4F4D4F4D		dw 	0x4D4F,0x4D4F
   8:     -	2FB1          		endm
   9:     -	2FB1          		dwpatch	0xDA33+6	,0x4942 ,0x4942
   9:     -	2FB1  51      		db 	pW_CHK_PATCH
   9:     -	2FB2  39DA    		dw 	0xDA33+6
   9:     -	2FB4  42494249		dw 	0x4942,0x4942
   9:     -	2FB8          		endm
  10:     -	2FB8          		dwpatch	0xDA33+8	,0x534F ,0x534F
  10:     -	2FB8  51      		db 	pW_CHK_PATCH
  10:     -	2FB9  3BDA    		dw 	0xDA33+8
  10:     -	2FBB  4F534F53		dw 	0x534F,0x534F
  10:     -	2FBF          		endm
  11:     -	2FBF          		dwpatch	0xDA33+10	,0x3156 ,0x3156
  11:     -	2FBF  51      		db 	pW_CHK_PATCH
  11:     -	2FC0  3DDA    		dw 	0xDA33+10
  11:     -	2FC2  56315631		dw 	0x3156,0x3156
  11:     -	2FC6          		endm
  12:     -	2FC6          		stop 'CPM_21_EXTROM'
  12:     -	2FC6  50      		db 	p_STOP
  12:     -	2FC7  43504D5F		db 	'CPM_21_EXTROM'
	      32315F45
	      5854524F
	      4D
  12:     -	2FD4  00      		db 	0
  12:     -	2FD5          		endm
**** out/include-patcher.asm ****
  31:					include "generator/V0/out/patcher-cpm1-CPM_12_88_3_alternativa.asm"	; 25 images in collection
**** generator/V0/out/patcher-cpm1-CPM_12_88_3_alternativa.asm ****
   1:     -	2FD5          	_BIOS_CPM_12_88_3_alternativa:
   2:     -	2FD5          		setSUBBIOS 1
   2:     -	2FD5  5A      		db	pSubBios
   2:     -	2FD6  01      		db 	1
   2:     -	2FD7          		endm
   3:     -	2FD7          		RQ_OPTS_ANY
   3:     -	2FD7          		endm
   4:     -	2FD7          		setCPM
   4:     -	2FD7          		endm
   5:     -	2FD7          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	2FD7  59      		db 	pB_MAYBE_PATCH
   5:     -	2FD8  EEDA    		dw 	0xDAEE
   5:     -	2FDA  1F0D    		db 	0x1F,0x0d
   5:     -	2FDC          		endm
   6:     -	2FDC          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	2FDC  59      		db 	pB_MAYBE_PATCH
   6:     -	2FDD  F0DA    		dw 	0xDAEE+2
   6:     -	2FDF  0A0D    		db 	0x0a,0x0d
   6:     -	2FE1          		endm
   7:     -	2FE1          		dbpatch	0xE077+1	,0x49	,0xc9
   7:     -	2FE1  52      		db 	pB_CHK_PATCH
   7:     -	2FE2  78E0    		dw 	0xE077+1
   7:     -	2FE4  49C9    		db 	0x49,0xc9
   7:     -	2FE6          		endm
   8:     -	2FE6          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	2FE6  52      		db 	pB_CHK_PATCH
   8:     -	2FE7  88DA    		dw 	0xDA88
   8:     -	2FE9  0100    		db 	0x01,0x00
   8:     -	2FEB          		endm
   9:     -	2FEB          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	2FEB  52      		db 	pB_CHK_PATCH
   9:     -	2FEC  9FDA    		dw 	0xDA9F
   9:     -	2FEE  0200    		db 	0x02,0x00
   9:     -	2FF0          		endm
  10:     -	2FF0          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	2FF0  52      		db 	pB_CHK_PATCH
  10:     -	2FF1  B6DA    		dw 	0xDAB6
  10:     -	2FF3  0401    		db 	0x04,0x01
  10:     -	2FF5          		endm
  11:     -	2FF5          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	2FF5  52      		db 	pB_CHK_PATCH
  11:     -	2FF6  CDDA    		dw 	0xDACD
  11:     -	2FF8  0802    		db 	0x08,0x02
  11:     -	2FFA          		endm
  12:     -	2FFA          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	2FFA  54      		db 	pW_STORE
  12:     -	2FFB  88DA    		dw 	0xDA88
  12:     -	2FFD  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	2FFF          		endm
  13:     -	2FFF          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	2FFF  54      		db 	pW_STORE
  13:     -	3000  9FDA    		dw 	0xDA9F
  13:     -	3002  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	3004          		endm
  14:     -	3004          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	3004  54      		db 	pW_STORE
  14:     -	3005  B6DA    		dw 	0xDAB6
  14:     -	3007  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	3009          		endm
  15:     -	3009          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	3009  54      		db 	pW_STORE
  15:     -	300A  CDDA    		dw 	0xDACD
  15:     -	300C  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	300E          		endm
  16:     -	300E          		dwpatch 0xDCBF+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	300E  51      		db 	pW_CHK_PATCH
  16:     -	300F  C9DC    		dw 	0xDCBF+5*2
  16:     -	3011  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	3015          		endm
  17:     -	3015          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	3015  54      		db 	pW_STORE
  17:     -	3016  A6EB    		dw 	0xEBA6
  17:     -	3018  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	301A          		endm
  18:     -	301A          		dwpatch 0xDA1B+1 	,0xDC7B	,_CPM1_res_seldsk
  18:     -	301A  51      		db 	pW_CHK_PATCH
  18:     -	301B  1CDA    		dw 	0xDA1B+1
  18:     -	301D  7BDC11E9		dw 	0xDC7B,_CPM1_res_seldsk
  18:     -	3021          		endm
  19:     -	3021          		dwstore	_CPM1_old_seld_dsk+1	,0xDC7B
  19:     -	3021  54      		db 	pW_STORE
  19:     -	3022  7BDC    		dw 	0xDC7B
  19:     -	3024  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	3026          		endm
  20:     -	3026          		dbpatch	0xE63E	,0x77	,0x00
  20:     -	3026  52      		db 	pB_CHK_PATCH
  20:     -	3027  3EE6    		dw 	0xE63E
  20:     -	3029  7700    		db 	0x77,0x00
  20:     -	302B          		endm
  21:     -	302B          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDF92
  21:     -	302B  54      		db 	pW_STORE
  21:     -	302C  92DF    		dw 	0xDF92
  21:     -	302E  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	3030          		endm
  22:     -	3030          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDF92
  22:     -	3030  54      		db 	pW_STORE
  22:     -	3031  92DF    		dw 	0xDF92
  22:     -	3033  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	3035          		endm
  23:     -	3035          		dwpatch	0xDA27+1	,0xDCDE	,_CPM1_res_READ
  23:     -	3035  51      		db 	pW_CHK_PATCH
  23:     -	3036  28DA    		dw 	0xDA27+1
  23:     -	3038  DEDC1BE9		dw 	0xDCDE,_CPM1_res_READ
  23:     -	303C          		endm
  24:     -	303C          		dwpatch	0xDA2A+1	,0xDE14	,_CPM1_res_WRITE
  24:     -	303C  51      		db 	pW_CHK_PATCH
  24:     -	303D  2BDA    		dw 	0xDA2A+1
  24:     -	303F  14DE58E9		dw 	0xDE14,_CPM1_res_WRITE
  24:     -	3043          		endm
  25:     -	3043          		dwpatch	0xDB74+1	,0xDCDE	,_CPM1_res_READ
  25:     -	3043  51      		db 	pW_CHK_PATCH
  25:     -	3044  75DB    		dw 	0xDB74+1
  25:     -	3046  DEDC1BE9		dw 	0xDCDE,_CPM1_res_READ
  25:     -	304A          		endm
  26:     -	304A          		dwpatch	0xDCAD+1	,0xE574	,_CPM1_res_GETINFO
  26:     -	304A  51      		db 	pW_CHK_PATCH
  26:     -	304B  AEDC    		dw 	0xDCAD+1
  26:     -	304D  74E595E9		dw 	0xE574,_CPM1_res_GETINFO
  26:     -	3051          		endm
  27:     -	3051          		dwstore	_CPM1__old_read+1	,0xDCDE
  27:     -	3051  54      		db 	pW_STORE
  27:     -	3052  DEDC    		dw 	0xDCDE
  27:     -	3054  56E9    		dw 	_CPM1__old_read+1
  27:     -	3056          		endm
  28:     -	3056          		dwstore	_CPM1__old_write+1	,0xDE14
  28:     -	3056  54      		db 	pW_STORE
  28:     -	3057  14DE    		dw 	0xDE14
  28:     -	3059  93E9    		dw 	_CPM1__old_write+1
  28:     -	305B          		endm
  29:     -	305B          		dwstore	_CPM1__old_getinfo+1	,0xE574
  29:     -	305B  54      		db 	pW_STORE
  29:     -	305C  74E5    		dw 	0xE574
  29:     -	305E  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	3060          		endm
  30:     -	3060          		dbpatch	0xE5B4		,0x21	,0x21
  30:     -	3060  52      		db 	pB_CHK_PATCH
  30:     -	3061  B4E5    		dw 	0xE5B4
  30:     -	3063  2121    		db 	0x21,0x21
  30:     -	3065          		endm
  31:     -	3065          		dwpatch	0xE5B4+1 	,0xE5E4	,0xE5E4
  31:     -	3065  51      		db 	pW_CHK_PATCH
  31:     -	3066  B5E5    		dw 	0xE5B4+1
  31:     -	3068  E4E5E4E5		dw 	0xE5E4,0xE5E4
  31:     -	306C          		endm
  32:     -	306C          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE5B4
  32:     -	306C  54      		db 	pW_STORE
  32:     -	306D  B4E5    		dw 	0xE5B4
  32:     -	306F  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	3071          		endm
  33:     -	3071          		dwstore	_CPM1_r_p_DSK1+1	,0xDF88 	;read
  33:     -	3071  54      		db 	pW_STORE
  33:     -	3072  88DF    		dw 	0xDF88
  33:     -	3074  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	3076          		endm
  34:     -	3076          		dwstore	_CPM1_r_p_TRK1+1	,0xDF8C 	
  34:     -	3076  54      		db 	pW_STORE
  34:     -	3077  8CDF    		dw 	0xDF8C
  34:     -	3079  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	307B          		endm
  35:     -	307B          		dwstore	_CPM1_r_p_SEC1+1	,0xDF8D 	
  35:     -	307B  54      		db 	pW_STORE
  35:     -	307C  8DDF    		dw 	0xDF8D
  35:     -	307E  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	3080          		endm
  36:     -	3080          		dwstore	_CPM1_r_p_DMA1+1	,0xDF8E 	
  36:     -	3080  54      		db 	pW_STORE
  36:     -	3081  8EDF    		dw 	0xDF8E
  36:     -	3083  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	3085          		endm
  37:     -	3085          		dwstore	_CPM1_r_p_DSK2+1	,0xDF88 	;write
  37:     -	3085  54      		db 	pW_STORE
  37:     -	3086  88DF    		dw 	0xDF88
  37:     -	3088  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	308A          		endm
  38:     -	308A          		dwstore	_CPM1_r_p_TRK2+1	,0xDF8C 	
  38:     -	308A  54      		db 	pW_STORE
  38:     -	308B  8CDF    		dw 	0xDF8C
  38:     -	308D  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	308F          		endm
  39:     -	308F          		dwstore	_CPM1_r_p_SEC2+1	,0xDF8D 	
  39:     -	308F  54      		db 	pW_STORE
  39:     -	3090  8DDF    		dw 	0xDF8D
  39:     -	3092  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	3094          		endm
  40:     -	3094          		dwstore	_CPM1_r_p_DMA2+1	,0xDF8E 	
  40:     -	3094  54      		db 	pW_STORE
  40:     -	3095  8EDF    		dw 	0xDF8E
  40:     -	3097  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	3099          		endm
  41:     -	3099          		dwstore	_CPM1_r_p_DSK3+1	,0xDF88 	;readinfo
  41:     -	3099  54      		db 	pW_STORE
  41:     -	309A  88DF    		dw 	0xDF88
  41:     -	309C  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	309E          		endm
  42:					;custom checkers
  43:     -	309E          		dbpatch	0xE01D	,0x21 ,0x21
  43:     -	309E  52      		db 	pB_CHK_PATCH
  43:     -	309F  1DE0    		dw 	0xE01D
  43:     -	30A1  2121    		db 	0x21,0x21
  43:     -	30A3          		endm
  44:     -	30A3          		dwpatch	0xE01D+1	,0xFB21 ,0xFB21
  44:     -	30A3  51      		db 	pW_CHK_PATCH
  44:     -	30A4  1EE0    		dw 	0xE01D+1
  44:     -	30A6  21FB21FB		dw 	0xFB21,0xFB21
  44:     -	30AA          		endm
  45:     -	30AA          		stop 'CPM_12_88_3_alternativa'
  45:     -	30AA  50      		db 	p_STOP
  45:     -	30AB  43504D5F		db 	'CPM_12_88_3_alternativa'
	      31325F38
	      385F335F
	      616C7465
	      726E6174
	      697661
  45:     -	30C2  00      		db 	0
  45:     -	30C3          		endm
**** out/include-patcher.asm ****
  32:					include "generator/V0/out/patcher-cpm1-CPM_12_88_3_niijaf.asm"	; 78 images in collection
**** generator/V0/out/patcher-cpm1-CPM_12_88_3_niijaf.asm ****
   1:     -	30C3          	_BIOS_CPM_12_88_3_niijaf:
   2:     -	30C3          		setSUBBIOS 1
   2:     -	30C3  5A      		db	pSubBios
   2:     -	30C4  01      		db 	1
   2:     -	30C5          		endm
   3:     -	30C5          		RQ_OPTS_ANY
   3:     -	30C5          		endm
   4:     -	30C5          		setCPM
   4:     -	30C5          		endm
   5:     -	30C5          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	30C5  59      		db 	pB_MAYBE_PATCH
   5:     -	30C6  EEDA    		dw 	0xDAEE
   5:     -	30C8  1F0D    		db 	0x1F,0x0d
   5:     -	30CA          		endm
   6:     -	30CA          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	30CA  59      		db 	pB_MAYBE_PATCH
   6:     -	30CB  F0DA    		dw 	0xDAEE+2
   6:     -	30CD  0A0D    		db 	0x0a,0x0d
   6:     -	30CF          		endm
   7:     -	30CF          		dbpatch	0xE077+1	,0x49	,0xc9
   7:     -	30CF  52      		db 	pB_CHK_PATCH
   7:     -	30D0  78E0    		dw 	0xE077+1
   7:     -	30D2  49C9    		db 	0x49,0xc9
   7:     -	30D4          		endm
   8:     -	30D4          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	30D4  52      		db 	pB_CHK_PATCH
   8:     -	30D5  88DA    		dw 	0xDA88
   8:     -	30D7  0100    		db 	0x01,0x00
   8:     -	30D9          		endm
   9:     -	30D9          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	30D9  52      		db 	pB_CHK_PATCH
   9:     -	30DA  9FDA    		dw 	0xDA9F
   9:     -	30DC  0200    		db 	0x02,0x00
   9:     -	30DE          		endm
  10:     -	30DE          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	30DE  52      		db 	pB_CHK_PATCH
  10:     -	30DF  B6DA    		dw 	0xDAB6
  10:     -	30E1  0401    		db 	0x04,0x01
  10:     -	30E3          		endm
  11:     -	30E3          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	30E3  52      		db 	pB_CHK_PATCH
  11:     -	30E4  CDDA    		dw 	0xDACD
  11:     -	30E6  0802    		db 	0x08,0x02
  11:     -	30E8          		endm
  12:     -	30E8          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	30E8  54      		db 	pW_STORE
  12:     -	30E9  88DA    		dw 	0xDA88
  12:     -	30EB  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	30ED          		endm
  13:     -	30ED          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	30ED  54      		db 	pW_STORE
  13:     -	30EE  9FDA    		dw 	0xDA9F
  13:     -	30F0  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	30F2          		endm
  14:     -	30F2          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	30F2  54      		db 	pW_STORE
  14:     -	30F3  B6DA    		dw 	0xDAB6
  14:     -	30F5  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	30F7          		endm
  15:     -	30F7          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	30F7  54      		db 	pW_STORE
  15:     -	30F8  CDDA    		dw 	0xDACD
  15:     -	30FA  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	30FC          		endm
  16:     -	30FC          		dwpatch 0xDCBF+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	30FC  51      		db 	pW_CHK_PATCH
  16:     -	30FD  C9DC    		dw 	0xDCBF+5*2
  16:     -	30FF  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	3103          		endm
  17:     -	3103          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	3103  54      		db 	pW_STORE
  17:     -	3104  A6EB    		dw 	0xEBA6
  17:     -	3106  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	3108          		endm
  18:     -	3108          		dwpatch 0xDA1B+1 	,0xDC7B	,_CPM1_res_seldsk
  18:     -	3108  51      		db 	pW_CHK_PATCH
  18:     -	3109  1CDA    		dw 	0xDA1B+1
  18:     -	310B  7BDC11E9		dw 	0xDC7B,_CPM1_res_seldsk
  18:     -	310F          		endm
  19:     -	310F          		dwstore	_CPM1_old_seld_dsk+1	,0xDC7B
  19:     -	310F  54      		db 	pW_STORE
  19:     -	3110  7BDC    		dw 	0xDC7B
  19:     -	3112  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	3114          		endm
  20:     -	3114          		dbpatch	0xE63E	,0x77	,0x00
  20:     -	3114  52      		db 	pB_CHK_PATCH
  20:     -	3115  3EE6    		dw 	0xE63E
  20:     -	3117  7700    		db 	0x77,0x00
  20:     -	3119          		endm
  21:     -	3119          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDF92
  21:     -	3119  54      		db 	pW_STORE
  21:     -	311A  92DF    		dw 	0xDF92
  21:     -	311C  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	311E          		endm
  22:     -	311E          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDF92
  22:     -	311E  54      		db 	pW_STORE
  22:     -	311F  92DF    		dw 	0xDF92
  22:     -	3121  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	3123          		endm
  23:     -	3123          		dwpatch	0xDA27+1	,0xDCDE	,_CPM1_res_READ
  23:     -	3123  51      		db 	pW_CHK_PATCH
  23:     -	3124  28DA    		dw 	0xDA27+1
  23:     -	3126  DEDC1BE9		dw 	0xDCDE,_CPM1_res_READ
  23:     -	312A          		endm
  24:     -	312A          		dwpatch	0xDA2A+1	,0xDE14	,_CPM1_res_WRITE
  24:     -	312A  51      		db 	pW_CHK_PATCH
  24:     -	312B  2BDA    		dw 	0xDA2A+1
  24:     -	312D  14DE58E9		dw 	0xDE14,_CPM1_res_WRITE
  24:     -	3131          		endm
  25:     -	3131          		dwpatch	0xDB74+1	,0xDCDE	,_CPM1_res_READ
  25:     -	3131  51      		db 	pW_CHK_PATCH
  25:     -	3132  75DB    		dw 	0xDB74+1
  25:     -	3134  DEDC1BE9		dw 	0xDCDE,_CPM1_res_READ
  25:     -	3138          		endm
  26:     -	3138          		dwpatch	0xDCAD+1	,0xE574	,_CPM1_res_GETINFO
  26:     -	3138  51      		db 	pW_CHK_PATCH
  26:     -	3139  AEDC    		dw 	0xDCAD+1
  26:     -	313B  74E595E9		dw 	0xE574,_CPM1_res_GETINFO
  26:     -	313F          		endm
  27:     -	313F          		dwstore	_CPM1__old_read+1	,0xDCDE
  27:     -	313F  54      		db 	pW_STORE
  27:     -	3140  DEDC    		dw 	0xDCDE
  27:     -	3142  56E9    		dw 	_CPM1__old_read+1
  27:     -	3144          		endm
  28:     -	3144          		dwstore	_CPM1__old_write+1	,0xDE14
  28:     -	3144  54      		db 	pW_STORE
  28:     -	3145  14DE    		dw 	0xDE14
  28:     -	3147  93E9    		dw 	_CPM1__old_write+1
  28:     -	3149          		endm
  29:     -	3149          		dwstore	_CPM1__old_getinfo+1	,0xE574
  29:     -	3149  54      		db 	pW_STORE
  29:     -	314A  74E5    		dw 	0xE574
  29:     -	314C  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	314E          		endm
  30:     -	314E          		dbpatch	0xE5B4		,0x21	,0x21
  30:     -	314E  52      		db 	pB_CHK_PATCH
  30:     -	314F  B4E5    		dw 	0xE5B4
  30:     -	3151  2121    		db 	0x21,0x21
  30:     -	3153          		endm
  31:     -	3153          		dwpatch	0xE5B4+1 	,0xE5E4	,0xE5E4
  31:     -	3153  51      		db 	pW_CHK_PATCH
  31:     -	3154  B5E5    		dw 	0xE5B4+1
  31:     -	3156  E4E5E4E5		dw 	0xE5E4,0xE5E4
  31:     -	315A          		endm
  32:     -	315A          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE5B4
  32:     -	315A  54      		db 	pW_STORE
  32:     -	315B  B4E5    		dw 	0xE5B4
  32:     -	315D  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	315F          		endm
  33:     -	315F          		dwstore	_CPM1_r_p_DSK1+1	,0xDF88 	;read
  33:     -	315F  54      		db 	pW_STORE
  33:     -	3160  88DF    		dw 	0xDF88
  33:     -	3162  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	3164          		endm
  34:     -	3164          		dwstore	_CPM1_r_p_TRK1+1	,0xDF8C 	
  34:     -	3164  54      		db 	pW_STORE
  34:     -	3165  8CDF    		dw 	0xDF8C
  34:     -	3167  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	3169          		endm
  35:     -	3169          		dwstore	_CPM1_r_p_SEC1+1	,0xDF8D 	
  35:     -	3169  54      		db 	pW_STORE
  35:     -	316A  8DDF    		dw 	0xDF8D
  35:     -	316C  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	316E          		endm
  36:     -	316E          		dwstore	_CPM1_r_p_DMA1+1	,0xDF8E 	
  36:     -	316E  54      		db 	pW_STORE
  36:     -	316F  8EDF    		dw 	0xDF8E
  36:     -	3171  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	3173          		endm
  37:     -	3173          		dwstore	_CPM1_r_p_DSK2+1	,0xDF88 	;write
  37:     -	3173  54      		db 	pW_STORE
  37:     -	3174  88DF    		dw 	0xDF88
  37:     -	3176  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	3178          		endm
  38:     -	3178          		dwstore	_CPM1_r_p_TRK2+1	,0xDF8C 	
  38:     -	3178  54      		db 	pW_STORE
  38:     -	3179  8CDF    		dw 	0xDF8C
  38:     -	317B  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	317D          		endm
  39:     -	317D          		dwstore	_CPM1_r_p_SEC2+1	,0xDF8D 	
  39:     -	317D  54      		db 	pW_STORE
  39:     -	317E  8DDF    		dw 	0xDF8D
  39:     -	3180  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	3182          		endm
  40:     -	3182          		dwstore	_CPM1_r_p_DMA2+1	,0xDF8E 	
  40:     -	3182  54      		db 	pW_STORE
  40:     -	3183  8EDF    		dw 	0xDF8E
  40:     -	3185  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	3187          		endm
  41:     -	3187          		dwstore	_CPM1_r_p_DSK3+1	,0xDF88 	;readinfo
  41:     -	3187  54      		db 	pW_STORE
  41:     -	3188  88DF    		dw 	0xDF88
  41:     -	318A  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	318C          		endm
  42:				
  43:     -	318C          		stop 'CPM_12_88_3_niijaf'
  43:     -	318C  50      		db 	p_STOP
  43:     -	318D  43504D5F		db 	'CPM_12_88_3_niijaf'
	      31325F38
	      385F335F
	      6E69696A
	      6166
  43:     -	319F  00      		db 	0
  43:     -	31A0          		endm
**** out/include-patcher.asm ****
  33:					include "generator/V0/out/patcher-cpm1-CPM_21_89___wiza.asm"	; 42 images in collection
**** generator/V0/out/patcher-cpm1-CPM_21_89___wiza.asm ****
   1:     -	31A0          	_BIOS_CPM_21_89___wiza:
   2:     -	31A0          		setSUBBIOS 1
   2:     -	31A0  5A      		db	pSubBios
   2:     -	31A1  01      		db 	1
   2:     -	31A2          		endm
   3:				
   4:					;адресса актуальные для биоса 21_89___wiza
   5:				
   6:					;BIOS_LOGO 		=> "0xDAEE",
   7:					;PPI2C_BIOS_IIT 	=> "0xE49F",
   8:					;DRVREG_A 		=> "0xDAA0",
   9:					;DRVREG_B 		=> "0xDA90",
  10:					;DRVREG_C 		=> "0xDAB7",
  11:					;DRVREG_D 		=> "0xDACE",
  12:					;SELDSK_STOREDRV	=> "0xE70A",
  13:					;SELDSK_ADDR		=> "0xDC8D",
  14:					;CURRENT_DISKPTR   	=> "0xE06E",
  15:					;BIOS_READ 		=> "0xDCEB",
  16:					;BIOS_WRITE 		=> "0xDEAF",
  17:					;SELDSK_GETINO_CALL	=> "0xdcbf",
  18:					;BIOS_GETINFO		=> "0xE648",
  19:					;WBOOT_READ_CLL 	=> "0xDB84",
  20:					;GETINFO_POSTTOM_ADDR 	=> "0xE67F",
  21:					;GETINFO_POSTTOM_CHKW 	=> "0xE6AF",
  22:					;BIOS_VAR_DSK		=> "0xE064",
  23:					;BIOS_VAR_SEC		=> "0xE068",
  24:					;BIOS_VAR_TRK		=> "0xE069",
  25:					;BIOS_VAR_DMA		=> "0xE06A",
  26:					;VINTKBDADDR 		=> "0xe3e3",
  27:					;VINTKBDVALUE		=> "0xdc46",
  28:					;KBD_HOOK_PRO 		=> "kbd_hook_2133",
  29:					;NAME 			=> '21_89___wiza',
  30:				
  31:					;Чекер/Патчер
  32:					;есть три основных комманды
  33:					;dbpatch addr oldbyte newbyte
  34:					;dwpatch addr oldword newword
  35:					;dwstore addr newword
  36:					;и ряд вспомогательных
  37:					;setCPM
  38:					;setMICRODOS
  39:					;checkOPTS1
  40:					;checkOPTS2
  41:					;unsupported
  42:					;pSTOP 'biosname'
  43:				
  44:					;на первом этапе патчер проверяет что в памяти именно этот биос
  45:					;для этого он проходтся по d(b|w)patch и проверяет 
  46:					;что по адрессу addr записано значени old(byte|word)
  47:				
  48:					;если это не так (т.е. на первой же проверке которая не прошла)
  49:					;то считаем что биос не соответсвует проверяемому и надо пробовать следующий
  50:				
  51:					;если же все проверки прошли - то запускается второй проход
  52:					;правим значения в памяти (собственно patch)
  53:					;т.е для d(b|w)patch по addr записывается значение new(byte|word)
  54:					;для dwstore просто по адрессу addr записывается newword
  55:				
  56:					;если old = new - то это просто проверка, т.к. значение не изменяется
  57:				
  58:     -	31A2          		RQ_OPTS_ANY
  58:     -	31A2          		endm
  59:				
  60:					;
  61:					;ниже описан "TEMPLATE" для поддержки CP/M BIOS
  62:					;все примеры кода ниже взяты для биоса '21_89___wiza'
  63:					;
  64:					;я попробую возле каждого параметра описать откуда он получен
  65:					;если вдруг будет необходимость расширить набор поддерживаемых
  66:					;bios.
  67:					;на сегодня поддерживается 13 уникальных CP/M bios для Корвета
  68:					;под "уникальными" понимается разные биосы, в которых отличается код
  69:					;во времена когда использовали Корвет было нормально править биос прямо на дискете
  70:					;обычно правили функциональные клавиши, таблицы перекодировки принтера
  71:					;и надписи ;)
  72:					;по этой причине разно выглядящие биосы могут быть одинаковыми внутри
  73:					;предварительный анализ позволил выделить 13 уникальных биосов среди сотен дискет
  74:					;что сильно упростило дальнейшую работу.
  75:					;
  76:					;patcher же делает необходимое кол-во проверок и изменений биоса
  77:					;чтобы подготовить его к работе с EXTROM API
  78:					;
  79:					;значения вида CPM_21_89___wiza должны быть заменены на значения
  80:					;соотвествующие конкретному биосу
  81:				
  82:					;Lets go
  83:				
  84:					;установим тип системы CP/M (нужно для случая когда биос опознан но не может быть использован)
  85:					;в случае с cp/m это важно для '1x_88_EPSON_V104'	'1x_89_03_30_RAVI'
  86:					;они работают только с ОПТС 1
  87:					;и по этой причине на ОПТС 2 надо fallback to default CP/M
  88:     -	31A2          		setCPM
  88:     -	31A2          		endm
  89:				
  90:					;BIOS_LOGO--------------------------------------------------------------
  91:					;косметика,  
  92:					;Биос при старте очищает экран, мы патчим его чтобы он это не делал
  93:					;иначе он затрёт все сообщения патчера, а там много полезной информации
  94:					;выгядит это в коде так
  95:					
  96:					;RAM:DA00          _BOOT:
  97:					;RAM:DA00 C3 42 DB                 jp      j_BOOT
  98:					;....
  99:					;RAM:DB42          j_BOOT:                                 
 100:					;RAM:DB42 F3                       di
 101:					;RAM:DB43 31 80 00                 ld      sp, 80h 
 102:					;RAM:DB46 3E 1C                    ld      a, 1Ch
 103:					;RAM:DB48 32 7F FA                 ld      (_1C_SysReg1C), a
 104:					;...
 105:					;RAM:DB58 21 EE DA                 ld      hl, BIOS_LOGO   ; "\\x1F\\r\\nCP/M-80  vers. 2.2"
 106:					;RAM:DB5B CD 2D E0                 call    putstr
 107:					;...
 108:					;RAM:DAEE 1F 0D 0A+BIOS_LOGO:      text "KOI8-R", '\\x1F\\r\\n'
 109:					;RAM:DAEE 43 50 2F+                text "KOI8-R", 'CP/M-80  vers. 2.2 \\r\\n'
 110:					;RAM:DAEE 4D 2D 38+                text "KOI8-R", 'BIOS  vers.2.1 (c) \\r\\n'
 111:					;RAM:DAEE 30 20 20+                text "KOI8-R", 'МГУ н/п кооп."ВИЗА"\\r\\n'
 112:					;RAM:DAEE 76 65 72+                text "KOI8-R", '   МОСКВА 1989 \\r\\n'
 113:					;RAM:DAEE 73 2E 20+                text "KOI8-R", 0
 114:     -	31A2          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
 114:     -	31A2  59      		db 	pB_MAYBE_PATCH
 114:     -	31A3  EEDA    		dw 	0xDAEE
 114:     -	31A5  1F0D    		db 	0x1F,0x0d
 114:     -	31A7          		endm
 115:     -	31A7          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
 115:     -	31A7  59      		db 	pB_MAYBE_PATCH
 115:     -	31A8  F0DA    		dw 	0xDAEE+2
 115:     -	31AA  0A0D    		db 	0x0a,0x0d
 115:     -	31AC          		endm
 116:				
 117:					;PPI2C_BIOS_INIT--------------------------------------------------------
 118:					;Биос при старте производит инициализацию перифирии, разных контроллеров
 119:					;в том числе записывает значение 0x49 в порт PPI2.C 
 120:					;(разрешаем вывод звука, ~SE, ResetForJoy)
 121:					;для нас важно что тут он сбрабсывает PPI2.C.8 (ENABLE EXTROM)
 122:					;без которого наш контроллер не работает.
 123:					;мы модифицируем это значение чтобы бит8 был установлен 0x49 -> 0xC9 
 124:					;выгядит это в коде так
 125:					;нас интересует адресс E49F
 126:				
 127:					;RAM:DA00          _BOOT:
 128:					;RAM:DA00 C3 42 DB                 jp      j_BOOT
 129:					;....
 130:					;RAM:DB42          j_BOOT:                                 
 131:					;RAM:DB42 F3                       di
 132:					;RAM:DB43 31 80 00                 ld      sp, 80h ; 'Ç'
 133:					;RAM:DB46 3E 1C                    ld      a, 1Ch
 134:					;RAM:DB48 32 7F FA                 ld      (_1C_SysReg1C), a
 135:					;RAM:DB4E CD 0A E4                 call    HW_Init
 136:					;...
 137:					;RAM:E40A          HW_Init:                                
 138:					;RAM:E40A                                                  
 139:					;RAM:E40A F3                       di
 140:					;RAM:E40B 11 D1 E3                 ld      de, IntstINTAB
 141:					;RAM:E40E 21 C6 F7                 ld      hl, _xVTRAP
 142:					;RAM:E411 01 3A 00                 ld      bc, 58
 143:					;RAM:E414 CD 3A E0                 call    _LDIR
 144:					;...
 145:					;RAM:E495 3E FF                    ld      a, 0FFh
 146:					;RAM:E497 32 31 F7                 ld      (SndFlag), a    ; flag key click (0 - no click)
 147:					;RAM:E49A 3E 02                    ld      a, 2
 148:					;RAM:E49C 32 2E F7                 ld      (F_Alft), a     ; 0 - russian
 149:					;RAM:E49F 3E 49                    ld      a, 49h ; 'I'
 150:					;RAM:E4A1 32 32 FB                 ld      (_1C_PPI2C_), a
 151:					;RAM:E4A4 C9                       ret
 152:     -	31AC          		dbpatch	0xE49F+1	,0x49	,0xc9
 152:     -	31AC  52      		db 	pB_CHK_PATCH
 152:     -	31AD  A0E4    		dw 	0xE49F+1
 152:     -	31AF  49C9    		db 	0x49,0xc9
 152:     -	31B1          		endm
 153:				
 154:					;DRVREG_x---------------------------------------------------------------
 155:					;DRVREG_A,DRVREG_B,DRVREG_C,DRVREG_D
 156:					;драйверу дисковода необходимо знать какой логичесской букве соответствует какой диск
 157:					;для этой цели мы используем байт который в оригинальном CP/M BIOS указывает
 158:					;какое значение надо записать в DRVREG чтобы выбрать данный диск
 159:					;это даёт возможность использовать и эмулятор и настоящие диски.
 160:					;в нашем биосе если этот байт =0 то этот диск работает через EXTROM API
 161:					;если же там не 0 то это физичесский диск.
 162:					;эти значения также использует утилита MOUNT которая позволяет изменить это соответсвие
 163:					;и подключить нужный образ диска к нужному дисководу.
 164:					;по умолчанию 
 165:					;при наличии дисковода
 166:					;A: -> эмулятор образ disk/DISKA.KDI
 167:					;B: -> эмулятор образ disk/DISKB.KDI
 168:					;C: -> физичесский дисковод A:
 169:					;D: -> физичесский дисковод B:
 170:					;или при отсутствии дисковода
 171:					;A: -> эмулятор образ disk/DISKA.KDI
 172:					;B: -> эмулятор образ disk/DISKB.KDI
 173:					;C: -> эмулятор образ disk/DISKC.KDI
 174:					;D: -> эмулятор образ disk/DISKD.KDI
 175:				
 176:					;этот адресс можно найти так (это справедливо для всех известных CP/M биосов)
 177:					;для каждого диска в биосе есть таблица DPH (Disk Parameter Header)
 178:					;в этой таблице по смещению +0x0A находится адрес DPB (Disk Parameter Block)
 179:					;интересующий нас байт находится по адрессу DPH-2
 180:					;звучит сложно, но на практике всё просто.
 181:					;найти DPH для всех дисков можно достаточно просто
 182:					;есть вызов биоса SELDSK (0xDA1B)
 183:					;иначе он попытается сделает операцию "Выбор диска" для указанного в регистре C диска
 184:					;а для этого ему надо получить параметры диска для своих целей
 185:					;а мы этим и воспользуемся
 186:					;в коде ниже по адрессу 0xDC99
 187:					;собственно тут нас интересует ссылка на таблицу DPH_TABLE
 188:					;в которой и есть ссылки на DPH для дисков (0xDCCC)
 189:					;A-DA33,B-DA43,etc
 190:					;RAM:DC8D          j_SELDSK:                               
 191:					;RAM:DC8D 79                       ld      a, c
 192:					;RAM:DC8E FE FF                    cp      0FFh
 193:					;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
 194:					;RAM:DC93 C8                       ret     z
 195:					;RAM:DC94 FE 08                    cp      8
 196:					;RAM:DC96 D2 C4 DC                 jp      nc, loc_DCC4
 197:					;RAM:DC99 21 CC DC                 ld      hl, DPH_TABLE
 198:					;RAM:DC9C 32 64 E0                 ld      (_DSK), a
 199:					;....
 200:					;RAM:DCCC 33 DA    DPH_TABLE:      dw dph_a                ; DATA XREF: j_SELDSK+Co
 201:					;RAM:DCCE 43 DA                    dw dph_b
 202:					;RAM:DCD0 53 DA                    dw dph_c
 203:					;RAM:DCD2 63 DA                    dw dph_d
 204:					;RAM:DCD4 73 DA                    dw dph_e
 205:					;RAM:DCD6 00 00                    dw loc_0
 206:					;RAM:DCD8 00 00                    dw loc_0
 207:					;RAM:DCDA 00 00                    dw loc_0
 208:					;...
 209:				
 210:					;DPH             struc ; (sizeof=0x10)
 211:					;_XLT:           dw ?
 212:					;_1:             dw ?
 213:					;_2:             dw ?
 214:					;_3:             dw ?
 215:					;DirBuf:         dw ?                    ; offset (00000000)
 216:					;DPB:            dw ?                    ; offset (00000000)
 217:					;CSV:            dw ?                    ; offset (00000000)
 218:					;ALV:            dw ?                    ; offset (00000000)
 219:					;DPH             ends
 220:				
 221:					;RAM:DA33 00 00 03+dph_a:          DPH <0, 3, 0, 0, dirBUF, dpbA, csvA, alwA>
 222:					;RAM:DA43 00 00 00+dph_b:          DPH <0, 0, 0, 0, dirBUF, dpbB, csvB, alwB>
 223:					;RAM:DA53 00 00 00+dph_c:          DPH <0, 0, 0, 0, dirBUF, dpbC, csvC, alwC>
 224:					;RAM:DA63 00 00 00+dph_d:          DPH <0, 0, 0, 0, dirBUF, dpbD, csvD, alwD>
 225:					;RAM:DA73 00 00 00+dph_e:          DPH <0, 0, 0, 0, dirBUF, dpbE, loc_0, alwE>
 226:					;RAM:DA83 50                       db  50h ; P
 227:					;RAM:DA84 80                       db  80h ; Ç
 228:					;RAM:DA85 05                       db    5
 229:					;RAM:DA86 01                       db    1
 230:					;RAM:DA87 03                       db    3
 231:					;RAM:DA88 01                       db    1
 232:					;RAM:DA89 01       unk_DA89:       db    1                 
 233:					;RAM:DA8A FF       			       db 0FFh                 
 234:					;RAM:DA8B 28 00 04+dpbA:           DPB <28h, 4, 0Fh, 0, 18Ah, 7Fh, 0C0h, 0, 20h, 2>
 235:					;
 236:					;собственно по адрессу DPB_A-2 и находится интересующая нас ячейка для диска A
 237:					;для остальных дисков - аналогично
 238:					;для физичесского дисковода A там значение 1
 239:					;для физичесского дисковода B там значение 2
 240:					;для физичесского дисковода C там значение 4
 241:					;для физичесского дисковода D там значение 8
 242:					;0 будет означать эмуляцию
 243:				
 244:     -	31B1          		dbpatch	0xDA89 	,0x01	,0x00
 244:     -	31B1  52      		db 	pB_CHK_PATCH
 244:     -	31B2  89DA    		dw 	0xDA89
 244:     -	31B4  0100    		db 	0x01,0x00
 244:     -	31B6          		endm
 245:     -	31B6          		dbpatch	0xDAA0 	,0x02	,0x00
 245:     -	31B6  52      		db 	pB_CHK_PATCH
 245:     -	31B7  A0DA    		dw 	0xDAA0
 245:     -	31B9  0200    		db 	0x02,0x00
 245:     -	31BB          		endm
 246:     -	31BB          		dbpatch	0xDAB7 	,0x04	,0x01
 246:     -	31BB  52      		db 	pB_CHK_PATCH
 246:     -	31BC  B7DA    		dw 	0xDAB7
 246:     -	31BE  0401    		db 	0x04,0x01
 246:     -	31C0          		endm
 247:     -	31C0          		dbpatch	0xDACE 	,0x08	,0x02
 247:     -	31C0  52      		db 	pB_CHK_PATCH
 247:     -	31C1  CEDA    		dw 	0xDACE
 247:     -	31C3  0802    		db 	0x08,0x02
 247:     -	31C5          		endm
 248:				
 249:					;для нормальной работы MOUNT в биос добавлена новая подфункция - получить таблицу
 250:					;адресов DRVREGxx
 251:					;call SELDSK с C=0xFE, которая возвращает указатель на таблицу с адресами DRVTRG_X
 252:					;собтвенно готовим эту таблицу используя уже исзвестные нам данные
 253:					;сохраняя адреса в таблицу внутри кода "резедента".
 254:				
 255:     -	31C5          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
 255:     -	31C5  54      		db 	pW_STORE
 255:     -	31C6  89DA    		dw 	0xDA89
 255:     -	31C8  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
 255:     -	31CA          		endm
 256:     -	31CA          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
 256:     -	31CA  54      		db 	pW_STORE
 256:     -	31CB  A0DA    		dw 	0xDAA0
 256:     -	31CD  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
 256:     -	31CF          		endm
 257:     -	31CF          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
 257:     -	31CF  54      		db 	pW_STORE
 257:     -	31D0  B7DA    		dw 	0xDAB7
 257:     -	31D2  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
 257:     -	31D4          		endm
 258:     -	31D4          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
 258:     -	31D4  54      		db 	pW_STORE
 258:     -	31D5  CEDA    		dw 	0xDACE
 258:     -	31D7  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
 258:     -	31D9          		endm
 259:				
 260:				
 261:					;DPH_TABLE-----------------------------------------------------
 262:					;добавляем поддержку диска F - образа с утилитами
 263:					;как найти DPH_TABLE см выше
 264:     -	31D9          		dwpatch 0xDCCC+5*2 	,0x0000 ,_CPM1_dph_F
 264:     -	31D9  51      		db 	pW_CHK_PATCH
 264:     -	31DA  D6DC    		dw 	0xDCCC+5*2
 264:     -	31DC  0000B8E8		dw 	0x0000,_CPM1_dph_F
 264:     -	31E0          		endm
 265:				
 266:     -	31E0          		dwstore _CPM1_dph_F+8	,0xEBA6
 266:     -	31E0  54      		db 	pW_STORE
 266:     -	31E1  A6EB    		dw 	0xEBA6
 266:     -	31E3  C0E8    		dw 	_CPM1_dph_F+8
 266:     -	31E5          		endm
 267:				
 268:					;SELDSK_ADDR------------------------------------------------------------
 269:					;и модифицируем вызов SELDSK чтобы он поддерживал дополнительную проверку
 270:					;модифицируем оригинальный перехо в SELDSK чтобы он переходил на наш код	
 271:					;и сохраняем старый адресс (в данном коде нужный нам адресс 0xDCB6)
 272:					;RAM:DA1B          _SELDSK:                         ; IN: C
 273:					;RAM:DA1B C3 B6 DC          jp      __SELDSK        ; OUT: HL-DPB/0, HL=xVTRAP0 if c=0xff
 274:				
 275:     -	31E5          		dwpatch 0xDA1B+1 	,0xDC8D	,_CPM1_res_seldsk
 275:     -	31E5  51      		db 	pW_CHK_PATCH
 275:     -	31E6  1CDA    		dw 	0xDA1B+1
 275:     -	31E8  8DDC11E9		dw 	0xDC8D,_CPM1_res_seldsk
 275:     -	31EC          		endm
 276:     -	31EC          		dwstore	_CPM1_old_seld_dsk+1	,0xDC8D
 276:     -	31EC  54      		db 	pW_STORE
 276:     -	31ED  8DDC    		dw 	0xDC8D
 276:     -	31EF  15E9    		dw 	_CPM1_old_seld_dsk+1
 276:     -	31F1          		endm
 277:				
 278:					;SELDSK_STORE_DRV-------------------------------------------------------
 279:					;в процессе работы SELDSK биос вызывает функцию GETINFO которая читает параметры диска
 280:					;из первого сектора.
 281:					;в процессе рабты она перезаписывает значение байта DRVREG_x
 282:					;затрём эту комманду 
 283:					;в примере ниже E70A 77 ld (hl), a - записав NOP на ее место.
 284:				
 285:					;RAM:DC8D          j_SELDSK:                               
 286:					;RAM:DC8D                                                  
 287:					;RAM:DC8D 79                       ld      a, c
 288:					;RAM:DC8E FE FF                    cp      0FFh
 289:					;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
 290:					;RAM:DC93 C8                       ret     z
 291:					;...
 292:					;RAM:DCBB 22 6E E0                 ld      (off_E06E), hl
 293:					;RAM:DCBE 3C                       inc     a
 294:					;RAM:DCBF C4 48 E6                 call    nz, GETINFO
 295:					;RAM:DCC2 E1                       pop     hl
 296:					;RAM:DCC3 C8                       ret     z
 297:					;...
 298:					;RAM:E648          GETINFO:                                
 299:					;RAM:E648 E5                       push    hl
 300:					;RAM:E649 CD 4E DF                 call    sub_DF4E
 301:					;RAM:E64C E1                       pop     hl
 302:					;...
 303:					;RAM:E703          loc_E703:                               
 304:					;RAM:E703 E1                       pop     hl
 305:					;RAM:E704 E5                       push    hl
 306:					;RAM:E705 3A 39 FB                 ld      a, (_1C_PPI1B_DrvReg)
 307:					;RAM:E708 E6 CF                    and     ~_SIDE1|_MOTOR
 308:					;RAM:E70A 77                       ld      (hl), a
 309:					;RAM:E70B 23                       inc     hl
 310:					;RAM:E70C 36 FF                    ld      (hl), 0FFh
 311:					;RAM:E70E 23                       inc     hl
 312:				
 313:     -	31F1          		dbpatch	0xE70A	,0x77	,0x00
 313:     -	31F1  52      		db 	pB_CHK_PATCH
 313:     -	31F2  0AE7    		dw 	0xE70A
 313:     -	31F4  7700    		db 	0x77,0x00
 313:     -	31F6          		endm
 314:				
 315:					;CURRENT_DISK_PTR-------------------------------------------------------
 316:					;нашему резиденту для операций чтения и записи нужно знать к какому диску идёт обращение
 317:					;и надо ли подменять обращение к эмулятору
 318:					;у биоса есть переменная которая указывает на DRVREG_x для текушего диска
 319:					;резидент читает из этого адресса и смотрит надо ли эмулировать диск
 320:					;собственно в коде ниже по адрессу 0xDCBB комманда которая сохраняет в нужную нам переменную
 321:					;ld      (off_E06E), hl
 322:					;т.е. нужный нам адресс 0xE06E
 323:				
 324:					;RAM:DC8D          j_SELDSK:                               
 325:					;RAM:DC8D                                                  
 326:					;RAM:DC8D 79                       ld      a, c
 327:					;RAM:DC8E FE FF                    cp      0FFh
 328:					;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
 329:					;RAM:DC93 C8                       ret     z
 330:					;...
 331:					;RAM:DCBB 22 6E E0                 ld      (off_E06E), hl
 332:					;RAM:DCBE 3C                       inc     a
 333:					;RAM:DCBF C4 48 E6                 call    nz, GETINFO
 334:				
 335:     -	31F6          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE06E
 335:     -	31F6  54      		db 	pW_STORE
 335:     -	31F7  6EE0    		dw 	0xE06E
 335:     -	31F9  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
 335:     -	31FB          		endm
 336:     -	31FB          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE06E
 336:     -	31FB  54      		db 	pW_STORE
 336:     -	31FC  6EE0    		dw 	0xE06E
 336:     -	31FE  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
 336:     -	3200          		endm
 337:				
 338:				
 339:					;CURRENT_DISK_PTR-------------------------------------------------------
 340:					;патчим адресса в основной таблицк BIOS для READ и WRITE
 341:					;теперь они указывают на наш "резидент"
 342:				
 343:					;RAM:DA27          _READ:                                  
 344:					;RAM:DA27 C3 EB DC                 jp      j_READ
 345:					;RAM:DA2A          _WRITE:                                 
 346:					;RAM:DA2A C3 AF DE                 jp      j_WRITE
 347:				
 348:     -	3200          		dwpatch	0xDA27+1	,0xDCEB	,_CPM1_res_READ
 348:     -	3200  51      		db 	pW_CHK_PATCH
 348:     -	3201  28DA    		dw 	0xDA27+1
 348:     -	3203  EBDC1BE9		dw 	0xDCEB,_CPM1_res_READ
 348:     -	3207          		endm
 349:     -	3207          		dwpatch	0xDA2A+1	,0xDEAF	,_CPM1_res_WRITE
 349:     -	3207  51      		db 	pW_CHK_PATCH
 349:     -	3208  2BDA    		dw 	0xDA2A+1
 349:     -	320A  AFDE58E9		dw 	0xDEAF,_CPM1_res_WRITE
 349:     -	320E          		endm
 350:				
 351:					;WBOOT_READ_CALL--------------------------------------------------------
 352:					;биосовоский wboot напрямую делает вызов READ
 353:					;патчим его тоже
 354:					;RAM:DB5E          j_WBOOT:                                
 355:					;RAM:DB5E                                                  
 356:					;RAM:DB5E F3                       di
 357:					;RAM:DB5F 31 80 00                 ld      sp, 80h ; 'Ç'
 358:					;RAM:DB62 CD 0A E4                 call    HW_Init
 359:					;...
 360:					;RAM:DB80 C5                       push    bc
 361:					;RAM:DB81 CD E5 DC                 call    j_SETDMA
 362:					;RAM:DB84 CD EB DC                 call    j_READ
 363:					;RAM:DB87 B7                       or      a
 364:					;RAM:DB88 C2 5E DB                 jp      nz, j_WBOOT
 365:				
 366:     -	320E          		dwpatch	0xDB84+1	,0xDCEB	,_CPM1_res_READ
 366:     -	320E  51      		db 	pW_CHK_PATCH
 366:     -	320F  85DB    		dw 	0xDB84+1
 366:     -	3211  EBDC1BE9		dw 	0xDCEB,_CPM1_res_READ
 366:     -	3215          		endm
 367:				
 368:					;SELDSK_GETINFO_CALL------------------------------------------------------------------------
 369:					;внутри  SELDSK есть вызов GETINFO
 370:					;используется для чтения параметров диска с нового диска
 371:					;мы его перехватываем, и для дисково которые работают через EXTROM API
 372:					;делаем сами его функции (частично)
 373:					;для физичесских дисков работает оригинальный код
 374:					;причина в том, что GETINFO обращается к диску напрямую, а нас это не устраивает
 375:					;в примере ниже это адресс DCBF
 376:				
 377:					;RAM:DC8D          j_SELDSK:                               
 378:					;RAM:DC8D                                                  
 379:					;RAM:DC8D 79                       ld      a, c
 380:					;RAM:DC8E FE FF                    cp      0FFh
 381:					;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
 382:					;RAM:DC93 C8                       ret     z
 383:					;...
 384:					;RAM:DCBB 22 6E E0                 ld      (off_E06E), hl
 385:					;RAM:DCBE 3C                       inc     a
 386:					;RAM:DCBF C4 48 E6                 call    nz, GETINFO
 387:					;RAM:DCC2 E1                       pop     hl
 388:					;RAM:DCC3 C8                       ret     z
 389:				
 390:     -	3215          		dwpatch	0xdcbf+1	,0xE648	,_CPM1_res_GETINFO
 390:     -	3215  51      		db 	pW_CHK_PATCH
 390:     -	3216  C0DC    		dw 	0xdcbf+1
 390:     -	3218  48E695E9		dw 	0xE648,_CPM1_res_GETINFO
 390:     -	321C          		endm
 391:				
 392:					;BIOS_xxxx--------------------------------------------------------------
 393:					;сохраняем в "резидет" адреса оригинальных функций
 394:					;они вызываются если идёт обращение к физичесским дискам
 395:				
 396:     -	321C          		dwstore	_CPM1__old_read+1	,0xDCEB
 396:     -	321C  54      		db 	pW_STORE
 396:     -	321D  EBDC    		dw 	0xDCEB
 396:     -	321F  56E9    		dw 	_CPM1__old_read+1
 396:     -	3221          		endm
 397:     -	3221          		dwstore	_CPM1__old_write+1	,0xDEAF
 397:     -	3221  54      		db 	pW_STORE
 397:     -	3222  AFDE    		dw 	0xDEAF
 397:     -	3224  93E9    		dw 	_CPM1__old_write+1
 397:     -	3226          		endm
 398:     -	3226          		dwstore	_CPM1__old_getinfo+1	,0xE648
 398:     -	3226  54      		db 	pW_STORE
 398:     -	3227  48E6    		dw 	0xE648
 398:     -	3229  A3E9    		dw 	_CPM1__old_getinfo+1
 398:     -	322B          		endm
 399:				
 400:					;-------------------------------------------------------------------------------
 401:					;наш эмулятор GETINFO производит чтение первого сектора из образа диска
 402:					;в буфер чтения, остальную работу делает сатарый код
 403:					;т.е. мы читаем сектор в буффер и передаём управление на код который
 404:					;проверяет результат успешности чтения, проверяе контролльную сумму сектора 
 405:					;и готовит сектор к дальнейшей работе
 406:					;в коде ниже это 0xE67F 
 407:				
 408:					;RAM:E648          GETINFO:                                ; CODE XREF: j_SELDSK+32p
 409:					;RAM:E648 E5                       push    hl
 410:					;RAM:E649 CD 4E DF                 call    sub_DF4E
 411:					;RAM:E64C E1                       pop     hl
 412:					;RAM:E64D 22 6E E0                 ld      (off_E06E), hl
 413:					;RAM:E650 E5                       push    hl
 414:					;RAM:E651 7E                       ld      a, (hl)
 415:					;RAM:E652 E6 0F                    and     0Fh
 416:					;RAM:E654 32 70 E0                 ld      (byte_E070), a
 417:					;RAM:E657 AF                       xor     a
 418:					;RAM:E658 32 71 E0                 ld      (byte_E071), a
 419:					;RAM:E65B 3C                       inc     a
 420:					;RAM:E65C 32 72 E0                 ld      (byte_E072), a
 421:					;RAM:E65F 21 6E E0                 ld      hl, off_E06E
 422:					;RAM:E662 CD D3 DF                 call    sub_DFD3
 423:					;RAM:E665 21 00 EE                 ld      hl, RD_BUF
 424:					;RAM:E668 CD 9A E7                 call    DTOM
 425:					;RAM:E66B CA 85 E6                 jp      z, CHKDO
 426:					;RAM:E66E 3A 39 FB                 ld      a, (_1C_PPI1B_DrvReg)
 427:					;RAM:E671 C6 40                    add     a, 40h ; '@'
 428:					;RAM:E673 32 39 FB                 ld      (_1C_PPI1B_DrvReg), a
 429:					;RAM:E676 CD 79 E8                 call    FDD_BREAK
 430:					;RAM:E679 21 00 EE                 ld      hl, RD_BUF
 431:					;RAM:E67C CD 9A E7                 call    DTOM
 432:					;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 433:					;RAM:E67F 21 AF E6                 ld      hl, msgDiskNotRead 
 434:					;RAM:E682 C2 A7 E6                 jp      nz, loc_E6A7
 435:					;RAM:E685
 436:				
 437:					;для надёжности проверим что по этому аддреск находтся то что ожидаем 
 438:				
 439:     -	322B          		dbpatch	0xE67F		,0x21	,0x21
 439:     -	322B  52      		db 	pB_CHK_PATCH
 439:     -	322C  7FE6    		dw 	0xE67F
 439:     -	322E  2121    		db 	0x21,0x21
 439:     -	3230          		endm
 440:     -	3230          		dwpatch	0xE67F+1 	,0xE6AF	,0xE6AF
 440:     -	3230  51      		db 	pW_CHK_PATCH
 440:     -	3231  80E6    		dw 	0xE67F+1
 440:     -	3233  AFE6AFE6		dw 	0xE6AF,0xE6AF
 440:     -	3237          		endm
 441:				
 442:					;и устанавливаем в наш "резидент" переход на эту точку.
 443:					
 444:     -	3237          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE67F
 444:     -	3237  54      		db 	pW_STORE
 444:     -	3238  7FE6    		dw 	0xE67F
 444:     -	323A  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
 444:     -	323C          		endm
 445:				
 446:					;BIOS_VAR_xxx-----------------------------------------------------------------------
 447:					;BIOS_VAR_DSK,BIOS_VAR_TRK,BIOS_VAR_SEC,BIOS_VAR_DMA
 448:					;системные переменные BIOS которые необходимы "эмулятору" для работы 
 449:					;функций READ/WRITE, т.к. их параметры предварительно записываются именно в
 450:					;эти переменные 
 451:					;сохраняем в эмулятор значения характерные именно для текущего биоса
 452:					;
 453:					;найти их совсем просто
 454:					;
 455:					;в стандартном CPM BIOS есть набор соответсвующих вызовов
 456:					;TRK -> 0xE068 (инструкция по адрессу DC89)
 457:					;SEC -> 0xE069 (инструкция по адрессу DCDD)
 458:					;DMA -> 0xE06A (инструкция по адрессу DCE7)
 459:				
 460:					;RAM:DA1E          _SELTRK:                                
 461:					;RAM:DA1E C3 88 DC                 jp      j_SELTRK
 462:					;RAM:DA21          _SETSEC:                                
 463:					;RAM:DA21 C3 DC DC                 jp      j_SETSEC
 464:					;RAM:DA24          _SETDMA:
 465:					;RAM:DA24 C3 E5 DC                 jp      j_SETDMA
 466:					;
 467:					;RAM:DC88          j_SELTRK:                               
 468:					;RAM:DC88                                                  
 469:					;RAM:DC88 79                       ld      a, c
 470:					;RAM:DC89 32 68 E0                 ld      (_TRK), a
 471:					;RAM:DC8C C9                       ret
 472:					;...
 473:					;RAM:DCDC          j_SETSEC:                               
 474:					;RAM:DCDC                                                  
 475:					;RAM:DCDC 79                       ld      a, c
 476:					;RAM:DCDD 32 69 E0                 ld      (_SEC), a
 477:					;RAM:DCE0 C9                       ret
 478:					;...
 479:					;RAM:DCE5          j_SETDMA:                               
 480:					;RAM:DCE5                                                  
 481:					;RAM:DCE5 69                       ld      l, c
 482:					;RAM:DCE6 60                       ld      h, b
 483:					;RAM:DCE7 22 6A E0                 ld      (_DMA), hl
 484:					;RAM:DCEA C9                       ret
 485:				
 486:					;а с DSK - тоже, многострадальный код SELDSK
 487:					;тут нужная нам число 0xE064 в инструкции по адрессу 0xDC9C
 488:				
 489:					;RAM:DC8D          j_SELDSK:                               
 490:					;RAM:DC8D 79                       ld      a, c
 491:					;RAM:DC8E FE FF                    cp      0FFh
 492:					;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
 493:					;RAM:DC93 C8                       ret     z
 494:					;RAM:DC94 FE 08                    cp      8
 495:					;RAM:DC96 D2 C4 DC                 jp      nc, loc_DCC4
 496:					;RAM:DC99 21 CC DC                 ld      hl, DPH_TABLE
 497:					;RAM:DC9C 32 64 E0                 ld      (_DSK), a
 498:				
 499:     -	323C          		dwstore	_CPM1_r_p_DSK1+1	,0xE064 	;read
 499:     -	323C  54      		db 	pW_STORE
 499:     -	323D  64E0    		dw 	0xE064
 499:     -	323F  1CE9    		dw 	_CPM1_r_p_DSK1+1
 499:     -	3241          		endm
 500:     -	3241          		dwstore	_CPM1_r_p_TRK1+1	,0xE068 	
 500:     -	3241  54      		db 	pW_STORE
 500:     -	3242  68E0    		dw 	0xE068
 500:     -	3244  37E9    		dw 	_CPM1_r_p_TRK1+1
 500:     -	3246          		endm
 501:     -	3246          		dwstore	_CPM1_r_p_SEC1+1	,0xE069 	
 501:     -	3246  54      		db 	pW_STORE
 501:     -	3247  69E0    		dw 	0xE069
 501:     -	3249  3DE9    		dw 	_CPM1_r_p_SEC1+1
 501:     -	324B          		endm
 502:     -	324B          		dwstore	_CPM1_r_p_DMA1+1	,0xE06A 	
 502:     -	324B  54      		db 	pW_STORE
 502:     -	324C  6AE0    		dw 	0xE06A
 502:     -	324E  4EE9    		dw 	_CPM1_r_p_DMA1+1
 502:     -	3250          		endm
 503:				
 504:     -	3250          		dwstore	_CPM1_r_p_DSK2+1	,0xE064 	;write
 504:     -	3250  54      		db 	pW_STORE
 504:     -	3251  64E0    		dw 	0xE064
 504:     -	3253  59E9    		dw 	_CPM1_r_p_DSK2+1
 504:     -	3255          		endm
 505:     -	3255          		dwstore	_CPM1_r_p_TRK2+1	,0xE068 	
 505:     -	3255  54      		db 	pW_STORE
 505:     -	3256  68E0    		dw 	0xE068
 505:     -	3258  74E9    		dw 	_CPM1_r_p_TRK2+1
 505:     -	325A          		endm
 506:     -	325A          		dwstore	_CPM1_r_p_SEC2+1	,0xE069 	
 506:     -	325A  54      		db 	pW_STORE
 506:     -	325B  69E0    		dw 	0xE069
 506:     -	325D  7AE9    		dw 	_CPM1_r_p_SEC2+1
 506:     -	325F          		endm
 507:     -	325F          		dwstore	_CPM1_r_p_DMA2+1	,0xE06A 	
 507:     -	325F  54      		db 	pW_STORE
 507:     -	3260  6AE0    		dw 	0xE06A
 507:     -	3262  8BE9    		dw 	_CPM1_r_p_DMA2+1
 507:     -	3264          		endm
 508:				
 509:     -	3264          		dwstore	_CPM1_r_p_DSK3+1	,0xE064 	;readinfo
 509:     -	3264  54      		db 	pW_STORE
 509:     -	3265  64E0    		dw 	0xE064
 509:     -	3267  28EA    		dw 	_CPM1_r_p_DSK3+1
 509:     -	3269          		endm
 510:				
 511:				
 512:					;KEY_HOOK:---------------------------------------------------------------------------
 513:					;VINTKBDADDR,VINTKBDVALUE,KBD_HOOK_PROC
 514:					;перехватываем нажатие комбинации клавиш CTRL+SHIFT+STOP
 515:					;планируется что по нажатии этой комбинации - содержимое диска E
 516:					;будет перезаписано содержимым на котором записан - 
 517:					;MOUNT и другие служебные утилиты для работы с EXTROM API 
 518:					;к сожадлению нет общего для всех кода
 519:					;точнее самые старые биосы - требуют "особых" отношений
 520:					;там немного по другому драйвер клавиатуры возвращает коды.
 521:					;
 522:					;kbd_hook_noCtrl_03 - '12_87_09_NIIJAF'	и производных от него '1x_88_EPSON_V104','1x_89_03_30_RAVI'
 523:					;kbd_hook_noCtrl_33 - '12_87_11_niijaf'
 524:					;kbd_hook_2133      - все остальные
 525:				
 526:					;по сути, мы подменяем перехватываем обработчик VTRAP8_pseudoKBD
 527:					;как найти 
 528:				
 529:					;в HWINIT есть копирование стандартной таблицы векторов VTRAP в рабочее место
 530:					;вот ее мы и патчим
 531:					;в коде ниже это адрес 0xdc46 и значение 0xdc46
 532:				
 533:					;RAM:DA00          _BOOT:
 534:					;RAM:DA00 C3 42 DB                 jp      j_BOOT
 535:					;...
 536:					;RAM:DB42          j_BOOT:                                 
 537:					;RAM:DB42 F3                       di
 538:					;RAM:DB43 31 80 00                 ld      sp, 80h ; 'Ç'
 539:					;RAM:DB46 3E 1C                    ld      a, 1Ch
 540:					;RAM:DB48 32 7F FA                 ld      (_1C_SysReg1C), a
 541:					;RAM:DB4B 32 03 F7                 ld      (SysCOPY), a
 542:					;RAM:DB4E CD 0A E4                 call    HW_Init
 543:					;....
 544:					;RAM:E40A          HW_Init:                                
 545:					;RAM:E40A                                                  
 546:					;RAM:E40A F3                       di
 547:					;RAM:E40B 11 D1 E3                 ld      de, IntstINTAB
 548:					;RAM:E40E 21 C6 F7                 ld      hl, _xVTRAP
 549:					;RAM:E411 01 3A 00                 ld      bc, 58
 550:					;RAM:E414 CD 3A E0                 call    _LDIR
 551:					;....
 552:					;RAM:E3D1 D3 E3    IntstINTAB:     dw off_E3D3             
 553:					;RAM:E3D3 0C DC    off_E3D3:       dw _EOI                 
 554:					;RAM:E3D3                                                  
 555:					;RAM:E3D5 0C DC                    dw _EOI
 556:					;RAM:E3D7 0C DC                    dw _EOI
 557:					;RAM:E3D9 0C DC                    dw _EOI
 558:					;RAM:E3DB 1C DC                    dw VINT_VBL
 559:					;RAM:E3DD 0C DC                    dw _EOI
 560:					;RAM:E3DF 0C DC                    dw _EOI
 561:					;RAM:E3E1 0C DC                    dw _EOI
 562:					;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 563:					;RAM:E3E3 46 DC                    dw VINT_KBD
 564:					;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 565:					;RAM:E3E5 00 00                    dw 0
 566:					;RAM:E3E7 00 00                    dw 0
 567:					;RAM:E3E9 00 00                    dw 0
 568:					
 569:					;support removed
 570:					;dwpatch	#_CPM1_VINTKBDADDR#	,#_CPM1_VINTKBDVALUE#	,#_CPM1_KBD_HOOK_PROC#
 571:					;dwstore	_CPM1_old_hook+1	,#_CPM1_VINTKBDVALUE#
 572:				
 573:					;custom checkers
 574:     -	3269          		dwpatch	0xDCBB+1	,0xE06E ,0xE06E
 574:     -	3269  51      		db 	pW_CHK_PATCH
 574:     -	326A  BCDC    		dw 	0xDCBB+1
 574:     -	326C  6EE06EE0		dw 	0xE06E,0xE06E
 574:     -	3270          		endm
 575:				
 576:					;STOP-------------------------------------------------------------------------------
 577:     -	3270          		stop 'CPM_21_89___wiza'
 577:     -	3270  50      		db 	p_STOP
 577:     -	3271  43504D5F		db 	'CPM_21_89___wiza'
	      32315F38
	      395F5F5F
	      77697A61
 577:     -	3281  00      		db 	0
 577:     -	3282          		endm
**** out/include-patcher.asm ****
  34:					include "generator/V0/out/patcher-microdos-MICRODOS_OPTS2_880630.asm"	; 42 images in collection
**** generator/V0/out/patcher-microdos-MICRODOS_OPTS2_880630.asm ****
   1:     -	3282          	_BIOS_MICRODOS_OPTS2_880630:
   2:     -	3282          		setMICRODOS
   2:     -	3282  56      		db 	pSETFLAG_MICRODOS
   2:     -	3283          		endm
   3:     -	3283          		RQ_OPTS2
   3:     -	3283  58      		db 	pREQUIRED_OPTS2
   3:     -	3284          		endm
   4:     -	3284          		dbpatchmaybe	0xBEA3	,0x1B	,0x0d
   4:     -	3284  59      		db 	pB_MAYBE_PATCH
   4:     -	3285  A3BE    		dw 	0xBEA3
   4:     -	3287  1B0D    		db 	0x1B,0x0d
   4:     -	3289          		endm
   5:     -	3289          		dbpatchmaybe	0xBEA3+1	,0x45	,0x0d
   5:     -	3289  59      		db 	pB_MAYBE_PATCH
   5:     -	328A  A4BE    		dw 	0xBEA3+1
   5:     -	328C  450D    		db 	0x45,0x0d
   5:     -	328E          		endm
   6:     -	328E          		dwpatch	0xEAFD+1	,0xEB34	,MD_READ			
   6:     -	328E  51      		db 	pW_CHK_PATCH
   6:     -	328F  FEEA    		dw 	0xEAFD+1
   6:     -	3291  34EB3EFA		dw 	0xEB34,MD_READ
   6:     -	3295          		endm
   7:     -	3295          		dwpatch	0xEB02+1	,0xEB9E	,MD_WRITE
   7:     -	3295  51      		db 	pW_CHK_PATCH
   7:     -	3296  03EB    		dw 	0xEB02+1
   7:     -	3298  9EEB53FA		dw 	0xEB9E,MD_WRITE
   7:     -	329C          		endm
   8:     -	329C          		dbpatch	0xEC91	,0xcd	,0x00
   8:     -	329C  52      		db 	pB_CHK_PATCH
   8:     -	329D  91EC    		dw 	0xEC91
   8:     -	329F  CD00    		db 	0xcd,0x00
   8:     -	32A1          		endm
   9:     -	32A1          		dwpatch	0xEC91+1	,0xee27	,0x0000
   9:     -	32A1  51      		db 	pW_CHK_PATCH
   9:     -	32A2  92EC    		dw 	0xEC91+1
   9:     -	32A4  27EE0000		dw 	0xee27,0x0000
   9:     -	32A8          		endm
  10:     -	32A8          		dwpatch	0xEC94+1	,0xEE2C	,MD_READ_INFOSECTOR
  10:     -	32A8  51      		db 	pW_CHK_PATCH
  10:     -	32A9  95EC    		dw 	0xEC94+1
  10:     -	32AB  2CEE68FA		dw 	0xEE2C,MD_READ_INFOSECTOR
  10:     -	32AF          		endm
  11:     -	32AF          		dwstore	MD_DRV2+1,	0xEF23
  11:     -	32AF  54      		db 	pW_STORE
  11:     -	32B0  23EF    		dw 	0xEF23
  11:     -	32B2  F3FA    		dw 	MD_DRV2+1
  11:     -	32B4          		endm
  12:     -	32B4          		dwstore	MD_RDBUF2+1,	0xEF2B
  12:     -	32B4  54      		db 	pW_STORE
  12:     -	32B5  2BEF    		dw 	0xEF2B
  12:     -	32B7  02FB    		dw 	MD_RDBUF2+1
  12:     -	32B9          		endm
  13:     -	32B9          		dwstore	MD_PARAM2+1,	0xEF16
  13:     -	32B9  54      		db 	pW_STORE
  13:     -	32BA  16EF    		dw 	0xEF16
  13:     -	32BC  1DFA    		dw 	MD_PARAM2+1
  13:     -	32BE          		endm
  14:     -	32BE          		dwpatch 0xc01b+1	 ,0xDD88	,md_res_seldsk
  14:     -	32BE  51      		db 	pW_CHK_PATCH
  14:     -	32BF  1CC0    		dw 	0xc01b+1
  14:     -	32C1  88DD0EFA		dw 	0xDD88,md_res_seldsk
  14:     -	32C5          		endm
  15:     -	32C5          		dwstore md_old_seld_dsk+1,0xDD88	,0xdd4c
  15:     -	32C5  54      		db 	pW_STORE
  15:     -	32C6  88DD    		dw 	0xDD88
  15:     -	32C8  12FA    		dw 	md_old_seld_dsk+1
  15:     -	32CA          		endm
  16:					;custom checkers
  17:     -	32CA          		dwpatch	0xBD80	,0xBD80 ,0xBD80
  17:     -	32CA  51      		db 	pW_CHK_PATCH
  17:     -	32CB  80BD    		dw 	0xBD80
  17:     -	32CD  80BD80BD		dw 	0xBD80,0xBD80
  17:     -	32D1          		endm
  18:     -	32D1          		dwpatch	0xBD82	,0xBE00 ,0xBE00
  18:     -	32D1  51      		db 	pW_CHK_PATCH
  18:     -	32D2  82BD    		dw 	0xBD82
  18:     -	32D4  00BE00BE		dw 	0xBE00,0xBE00
  18:     -	32D8          		endm
  19:     -	32D8          		dwpatch	0xc000+1	,0xC488 ,0xC488
  19:     -	32D8  51      		db 	pW_CHK_PATCH
  19:     -	32D9  01C0    		dw 	0xc000+1
  19:     -	32DB  88C488C4		dw 	0xC488,0xC488
  19:     -	32DF          		endm
  20:     -	32DF          		dwpatch	0xc003+1	,0xDBFC ,0xDBFC
  20:     -	32DF  51      		db 	pW_CHK_PATCH
  20:     -	32E0  04C0    		dw 	0xc003+1
  20:     -	32E2  FCDBFCDB		dw 	0xDBFC,0xDBFC
  20:     -	32E6          		endm
  21:     -	32E6          		dbpatch	0xEC4C	,0x21 ,0x21
  21:     -	32E6  52      		db 	pB_CHK_PATCH
  21:     -	32E7  4CEC    		dw 	0xEC4C
  21:     -	32E9  2121    		db 	0x21,0x21
  21:     -	32EB          		endm
  22:     -	32EB          		stop 'MICRODOS_OPTS2_880630'
  22:     -	32EB  50      		db 	p_STOP
  22:     -	32EC  4D494352		db 	'MICRODOS_OPTS2_880630'
	      4F444F53
	      5F4F5054
	      53325F38
	      38303633
	      30
  22:     -	3301  00      		db 	0
  22:     -	3302          		endm
**** out/include-patcher.asm ****
  35:					include "generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf2.asm"	; 36 images in collection
**** generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf2.asm ****
   1:     -	3302          	_BIOS_CPM_21_89_2_niijaf2:
   2:     -	3302          		setSUBBIOS 1
   2:     -	3302  5A      		db	pSubBios
   2:     -	3303  01      		db 	1
   2:     -	3304          		endm
   3:     -	3304          		RQ_OPTS_ANY
   3:     -	3304          		endm
   4:     -	3304          		setCPM
   4:     -	3304          		endm
   5:     -	3304          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	3304  59      		db 	pB_MAYBE_PATCH
   5:     -	3305  EEDA    		dw 	0xDAEE
   5:     -	3307  1F0D    		db 	0x1F,0x0d
   5:     -	3309          		endm
   6:     -	3309          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	3309  59      		db 	pB_MAYBE_PATCH
   6:     -	330A  F0DA    		dw 	0xDAEE+2
   6:     -	330C  0A0D    		db 	0x0a,0x0d
   6:     -	330E          		endm
   7:     -	330E          		dbpatch	0xE487+1	,0x49	,0xc9
   7:     -	330E  52      		db 	pB_CHK_PATCH
   7:     -	330F  88E4    		dw 	0xE487+1
   7:     -	3311  49C9    		db 	0x49,0xc9
   7:     -	3313          		endm
   8:     -	3313          		dbpatch	0xDA89 	,0x01	,0x00
   8:     -	3313  52      		db 	pB_CHK_PATCH
   8:     -	3314  89DA    		dw 	0xDA89
   8:     -	3316  0100    		db 	0x01,0x00
   8:     -	3318          		endm
   9:     -	3318          		dbpatch	0xDAA0 	,0x02	,0x00
   9:     -	3318  52      		db 	pB_CHK_PATCH
   9:     -	3319  A0DA    		dw 	0xDAA0
   9:     -	331B  0200    		db 	0x02,0x00
   9:     -	331D          		endm
  10:     -	331D          		dbpatch	0xDAB7 	,0x04	,0x01
  10:     -	331D  52      		db 	pB_CHK_PATCH
  10:     -	331E  B7DA    		dw 	0xDAB7
  10:     -	3320  0401    		db 	0x04,0x01
  10:     -	3322          		endm
  11:     -	3322          		dbpatch	0xDACE 	,0x08	,0x02
  11:     -	3322  52      		db 	pB_CHK_PATCH
  11:     -	3323  CEDA    		dw 	0xDACE
  11:     -	3325  0802    		db 	0x08,0x02
  11:     -	3327          		endm
  12:     -	3327          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
  12:     -	3327  54      		db 	pW_STORE
  12:     -	3328  89DA    		dw 	0xDA89
  12:     -	332A  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	332C          		endm
  13:     -	332C          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
  13:     -	332C  54      		db 	pW_STORE
  13:     -	332D  A0DA    		dw 	0xDAA0
  13:     -	332F  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	3331          		endm
  14:     -	3331          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
  14:     -	3331  54      		db 	pW_STORE
  14:     -	3332  B7DA    		dw 	0xDAB7
  14:     -	3334  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	3336          		endm
  15:     -	3336          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
  15:     -	3336  54      		db 	pW_STORE
  15:     -	3337  CEDA    		dw 	0xDACE
  15:     -	3339  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	333B          		endm
  16:     -	333B          		dwpatch 0xDCBB+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	333B  51      		db 	pW_CHK_PATCH
  16:     -	333C  C5DC    		dw 	0xDCBB+5*2
  16:     -	333E  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	3342          		endm
  17:     -	3342          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	3342  54      		db 	pW_STORE
  17:     -	3343  A6EB    		dw 	0xEBA6
  17:     -	3345  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	3347          		endm
  18:     -	3347          		dwpatch 0xDA1B+1 	,0xDC7C	,_CPM1_res_seldsk
  18:     -	3347  51      		db 	pW_CHK_PATCH
  18:     -	3348  1CDA    		dw 	0xDA1B+1
  18:     -	334A  7CDC11E9		dw 	0xDC7C,_CPM1_res_seldsk
  18:     -	334E          		endm
  19:     -	334E          		dwstore	_CPM1_old_seld_dsk+1	,0xDC7C
  19:     -	334E  54      		db 	pW_STORE
  19:     -	334F  7CDC    		dw 	0xDC7C
  19:     -	3351  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	3353          		endm
  20:     -	3353          		dbpatch	0xE6F2	,0x77	,0x00
  20:     -	3353  52      		db 	pB_CHK_PATCH
  20:     -	3354  F2E6    		dw 	0xE6F2
  20:     -	3356  7700    		db 	0x77,0x00
  20:     -	3358          		endm
  21:     -	3358          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE056
  21:     -	3358  54      		db 	pW_STORE
  21:     -	3359  56E0    		dw 	0xE056
  21:     -	335B  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	335D          		endm
  22:     -	335D          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE056
  22:     -	335D  54      		db 	pW_STORE
  22:     -	335E  56E0    		dw 	0xE056
  22:     -	3360  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	3362          		endm
  23:     -	3362          		dwpatch	0xDA27+1	,0xDCDA	,_CPM1_res_READ
  23:     -	3362  51      		db 	pW_CHK_PATCH
  23:     -	3363  28DA    		dw 	0xDA27+1
  23:     -	3365  DADC1BE9		dw 	0xDCDA,_CPM1_res_READ
  23:     -	3369          		endm
  24:     -	3369          		dwpatch	0xDA2A+1	,0xDE97	,_CPM1_res_WRITE
  24:     -	3369  51      		db 	pW_CHK_PATCH
  24:     -	336A  2BDA    		dw 	0xDA2A+1
  24:     -	336C  97DE58E9		dw 	0xDE97,_CPM1_res_WRITE
  24:     -	3370          		endm
  25:     -	3370          		dwpatch	0xDB73+1	,0xDCDA	,_CPM1_res_READ
  25:     -	3370  51      		db 	pW_CHK_PATCH
  25:     -	3371  74DB    		dw 	0xDB73+1
  25:     -	3373  DADC1BE9		dw 	0xDCDA,_CPM1_res_READ
  25:     -	3377          		endm
  26:     -	3377          		dwpatch	0xdcae+1	,0xE630	,_CPM1_res_GETINFO
  26:     -	3377  51      		db 	pW_CHK_PATCH
  26:     -	3378  AFDC    		dw 	0xdcae+1
  26:     -	337A  30E695E9		dw 	0xE630,_CPM1_res_GETINFO
  26:     -	337E          		endm
  27:     -	337E          		dwstore	_CPM1__old_read+1	,0xDCDA
  27:     -	337E  54      		db 	pW_STORE
  27:     -	337F  DADC    		dw 	0xDCDA
  27:     -	3381  56E9    		dw 	_CPM1__old_read+1
  27:     -	3383          		endm
  28:     -	3383          		dwstore	_CPM1__old_write+1	,0xDE97
  28:     -	3383  54      		db 	pW_STORE
  28:     -	3384  97DE    		dw 	0xDE97
  28:     -	3386  93E9    		dw 	_CPM1__old_write+1
  28:     -	3388          		endm
  29:     -	3388          		dwstore	_CPM1__old_getinfo+1	,0xE630
  29:     -	3388  54      		db 	pW_STORE
  29:     -	3389  30E6    		dw 	0xE630
  29:     -	338B  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	338D          		endm
  30:     -	338D          		dbpatch	0xE667		,0x21	,0x21
  30:     -	338D  52      		db 	pB_CHK_PATCH
  30:     -	338E  67E6    		dw 	0xE667
  30:     -	3390  2121    		db 	0x21,0x21
  30:     -	3392          		endm
  31:     -	3392          		dwpatch	0xE667+1 	,0xE697	,0xE697
  31:     -	3392  51      		db 	pW_CHK_PATCH
  31:     -	3393  68E6    		dw 	0xE667+1
  31:     -	3395  97E697E6		dw 	0xE697,0xE697
  31:     -	3399          		endm
  32:     -	3399          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE667
  32:     -	3399  54      		db 	pW_STORE
  32:     -	339A  67E6    		dw 	0xE667
  32:     -	339C  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	339E          		endm
  33:     -	339E          		dwstore	_CPM1_r_p_DSK1+1	,0xE04C 	;read
  33:     -	339E  54      		db 	pW_STORE
  33:     -	339F  4CE0    		dw 	0xE04C
  33:     -	33A1  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	33A3          		endm
  34:     -	33A3          		dwstore	_CPM1_r_p_TRK1+1	,0xE050 	
  34:     -	33A3  54      		db 	pW_STORE
  34:     -	33A4  50E0    		dw 	0xE050
  34:     -	33A6  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	33A8          		endm
  35:     -	33A8          		dwstore	_CPM1_r_p_SEC1+1	,0xE051 	
  35:     -	33A8  54      		db 	pW_STORE
  35:     -	33A9  51E0    		dw 	0xE051
  35:     -	33AB  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	33AD          		endm
  36:     -	33AD          		dwstore	_CPM1_r_p_DMA1+1	,0xE052 	
  36:     -	33AD  54      		db 	pW_STORE
  36:     -	33AE  52E0    		dw 	0xE052
  36:     -	33B0  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	33B2          		endm
  37:     -	33B2          		dwstore	_CPM1_r_p_DSK2+1	,0xE04C 	;write
  37:     -	33B2  54      		db 	pW_STORE
  37:     -	33B3  4CE0    		dw 	0xE04C
  37:     -	33B5  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	33B7          		endm
  38:     -	33B7          		dwstore	_CPM1_r_p_TRK2+1	,0xE050 	
  38:     -	33B7  54      		db 	pW_STORE
  38:     -	33B8  50E0    		dw 	0xE050
  38:     -	33BA  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	33BC          		endm
  39:     -	33BC          		dwstore	_CPM1_r_p_SEC2+1	,0xE051 	
  39:     -	33BC  54      		db 	pW_STORE
  39:     -	33BD  51E0    		dw 	0xE051
  39:     -	33BF  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	33C1          		endm
  40:     -	33C1          		dwstore	_CPM1_r_p_DMA2+1	,0xE052 	
  40:     -	33C1  54      		db 	pW_STORE
  40:     -	33C2  52E0    		dw 	0xE052
  40:     -	33C4  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	33C6          		endm
  41:     -	33C6          		dwstore	_CPM1_r_p_DSK3+1	,0xE04C 	;readinfo
  41:     -	33C6  54      		db 	pW_STORE
  41:     -	33C7  4CE0    		dw 	0xE04C
  41:     -	33C9  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	33CB          		endm
  42:				
  43:     -	33CB          		stop 'CPM_21_89_2_niijaf2'
  43:     -	33CB  50      		db 	p_STOP
  43:     -	33CC  43504D5F		db 	'CPM_21_89_2_niijaf2'
	      32315F38
	      395F325F
	      6E69696A
	      616632
  43:     -	33DF  00      		db 	0
  43:     -	33E0          		endm
**** out/include-patcher.asm ****
  36:					include "generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf.asm"	; 28 images in collection
**** generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf.asm ****
   1:     -	33E0          	_BIOS_CPM_21_89_2_niijaf:
   2:     -	33E0          		setSUBBIOS 1
   2:     -	33E0  5A      		db	pSubBios
   2:     -	33E1  01      		db 	1
   2:     -	33E2          		endm
   3:     -	33E2          		RQ_OPTS_ANY
   3:     -	33E2          		endm
   4:     -	33E2          		setCPM
   4:     -	33E2          		endm
   5:     -	33E2          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	33E2  59      		db 	pB_MAYBE_PATCH
   5:     -	33E3  EEDA    		dw 	0xDAEE
   5:     -	33E5  1F0D    		db 	0x1F,0x0d
   5:     -	33E7          		endm
   6:     -	33E7          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	33E7  59      		db 	pB_MAYBE_PATCH
   6:     -	33E8  F0DA    		dw 	0xDAEE+2
   6:     -	33EA  0A0D    		db 	0x0a,0x0d
   6:     -	33EC          		endm
   7:     -	33EC          		dbpatch	0xE48E+1	,0x49	,0xc9
   7:     -	33EC  52      		db 	pB_CHK_PATCH
   7:     -	33ED  8FE4    		dw 	0xE48E+1
   7:     -	33EF  49C9    		db 	0x49,0xc9
   7:     -	33F1          		endm
   8:     -	33F1          		dbpatch	0xDA89 	,0x01	,0x00
   8:     -	33F1  52      		db 	pB_CHK_PATCH
   8:     -	33F2  89DA    		dw 	0xDA89
   8:     -	33F4  0100    		db 	0x01,0x00
   8:     -	33F6          		endm
   9:     -	33F6          		dbpatch	0xDAA0 	,0x02	,0x00
   9:     -	33F6  52      		db 	pB_CHK_PATCH
   9:     -	33F7  A0DA    		dw 	0xDAA0
   9:     -	33F9  0200    		db 	0x02,0x00
   9:     -	33FB          		endm
  10:     -	33FB          		dbpatch	0xDAB7 	,0x04	,0x01
  10:     -	33FB  52      		db 	pB_CHK_PATCH
  10:     -	33FC  B7DA    		dw 	0xDAB7
  10:     -	33FE  0401    		db 	0x04,0x01
  10:     -	3400          		endm
  11:     -	3400          		dbpatch	0xDACE 	,0x08	,0x02
  11:     -	3400  52      		db 	pB_CHK_PATCH
  11:     -	3401  CEDA    		dw 	0xDACE
  11:     -	3403  0802    		db 	0x08,0x02
  11:     -	3405          		endm
  12:     -	3405          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
  12:     -	3405  54      		db 	pW_STORE
  12:     -	3406  89DA    		dw 	0xDA89
  12:     -	3408  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	340A          		endm
  13:     -	340A          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
  13:     -	340A  54      		db 	pW_STORE
  13:     -	340B  A0DA    		dw 	0xDAA0
  13:     -	340D  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	340F          		endm
  14:     -	340F          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
  14:     -	340F  54      		db 	pW_STORE
  14:     -	3410  B7DA    		dw 	0xDAB7
  14:     -	3412  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	3414          		endm
  15:     -	3414          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
  15:     -	3414  54      		db 	pW_STORE
  15:     -	3415  CEDA    		dw 	0xDACE
  15:     -	3417  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	3419          		endm
  16:     -	3419          		dwpatch 0xDCBB+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	3419  51      		db 	pW_CHK_PATCH
  16:     -	341A  C5DC    		dw 	0xDCBB+5*2
  16:     -	341C  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	3420          		endm
  17:     -	3420          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	3420  54      		db 	pW_STORE
  17:     -	3421  A6EB    		dw 	0xEBA6
  17:     -	3423  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	3425          		endm
  18:     -	3425          		dwpatch 0xDA1B+1 	,0xDC7C	,_CPM1_res_seldsk
  18:     -	3425  51      		db 	pW_CHK_PATCH
  18:     -	3426  1CDA    		dw 	0xDA1B+1
  18:     -	3428  7CDC11E9		dw 	0xDC7C,_CPM1_res_seldsk
  18:     -	342C          		endm
  19:     -	342C          		dwstore	_CPM1_old_seld_dsk+1	,0xDC7C
  19:     -	342C  54      		db 	pW_STORE
  19:     -	342D  7CDC    		dw 	0xDC7C
  19:     -	342F  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	3431          		endm
  20:     -	3431          		dbpatch	0xE6F9	,0x77	,0x00
  20:     -	3431  52      		db 	pB_CHK_PATCH
  20:     -	3432  F9E6    		dw 	0xE6F9
  20:     -	3434  7700    		db 	0x77,0x00
  20:     -	3436          		endm
  21:     -	3436          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE05D
  21:     -	3436  54      		db 	pW_STORE
  21:     -	3437  5DE0    		dw 	0xE05D
  21:     -	3439  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	343B          		endm
  22:     -	343B          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE05D
  22:     -	343B  54      		db 	pW_STORE
  22:     -	343C  5DE0    		dw 	0xE05D
  22:     -	343E  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	3440          		endm
  23:     -	3440          		dwpatch	0xDA27+1	,0xDCDA	,_CPM1_res_READ
  23:     -	3440  51      		db 	pW_CHK_PATCH
  23:     -	3441  28DA    		dw 	0xDA27+1
  23:     -	3443  DADC1BE9		dw 	0xDCDA,_CPM1_res_READ
  23:     -	3447          		endm
  24:     -	3447          		dwpatch	0xDA2A+1	,0xDE9E	,_CPM1_res_WRITE
  24:     -	3447  51      		db 	pW_CHK_PATCH
  24:     -	3448  2BDA    		dw 	0xDA2A+1
  24:     -	344A  9EDE58E9		dw 	0xDE9E,_CPM1_res_WRITE
  24:     -	344E          		endm
  25:     -	344E          		dwpatch	0xDB73+1	,0xDCDA	,_CPM1_res_READ
  25:     -	344E  51      		db 	pW_CHK_PATCH
  25:     -	344F  74DB    		dw 	0xDB73+1
  25:     -	3451  DADC1BE9		dw 	0xDCDA,_CPM1_res_READ
  25:     -	3455          		endm
  26:     -	3455          		dwpatch	0xdcae+1	,0xE637	,_CPM1_res_GETINFO
  26:     -	3455  51      		db 	pW_CHK_PATCH
  26:     -	3456  AFDC    		dw 	0xdcae+1
  26:     -	3458  37E695E9		dw 	0xE637,_CPM1_res_GETINFO
  26:     -	345C          		endm
  27:     -	345C          		dwstore	_CPM1__old_read+1	,0xDCDA
  27:     -	345C  54      		db 	pW_STORE
  27:     -	345D  DADC    		dw 	0xDCDA
  27:     -	345F  56E9    		dw 	_CPM1__old_read+1
  27:     -	3461          		endm
  28:     -	3461          		dwstore	_CPM1__old_write+1	,0xDE9E
  28:     -	3461  54      		db 	pW_STORE
  28:     -	3462  9EDE    		dw 	0xDE9E
  28:     -	3464  93E9    		dw 	_CPM1__old_write+1
  28:     -	3466          		endm
  29:     -	3466          		dwstore	_CPM1__old_getinfo+1	,0xE637
  29:     -	3466  54      		db 	pW_STORE
  29:     -	3467  37E6    		dw 	0xE637
  29:     -	3469  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	346B          		endm
  30:     -	346B          		dbpatch	0xE66E		,0x21	,0x21
  30:     -	346B  52      		db 	pB_CHK_PATCH
  30:     -	346C  6EE6    		dw 	0xE66E
  30:     -	346E  2121    		db 	0x21,0x21
  30:     -	3470          		endm
  31:     -	3470          		dwpatch	0xE66E+1 	,0xE69E	,0xE69E
  31:     -	3470  51      		db 	pW_CHK_PATCH
  31:     -	3471  6FE6    		dw 	0xE66E+1
  31:     -	3473  9EE69EE6		dw 	0xE69E,0xE69E
  31:     -	3477          		endm
  32:     -	3477          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE66E
  32:     -	3477  54      		db 	pW_STORE
  32:     -	3478  6EE6    		dw 	0xE66E
  32:     -	347A  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	347C          		endm
  33:     -	347C          		dwstore	_CPM1_r_p_DSK1+1	,0xE053 	;read
  33:     -	347C  54      		db 	pW_STORE
  33:     -	347D  53E0    		dw 	0xE053
  33:     -	347F  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	3481          		endm
  34:     -	3481          		dwstore	_CPM1_r_p_TRK1+1	,0xE057 	
  34:     -	3481  54      		db 	pW_STORE
  34:     -	3482  57E0    		dw 	0xE057
  34:     -	3484  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	3486          		endm
  35:     -	3486          		dwstore	_CPM1_r_p_SEC1+1	,0xE058 	
  35:     -	3486  54      		db 	pW_STORE
  35:     -	3487  58E0    		dw 	0xE058
  35:     -	3489  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	348B          		endm
  36:     -	348B          		dwstore	_CPM1_r_p_DMA1+1	,0xE059 	
  36:     -	348B  54      		db 	pW_STORE
  36:     -	348C  59E0    		dw 	0xE059
  36:     -	348E  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	3490          		endm
  37:     -	3490          		dwstore	_CPM1_r_p_DSK2+1	,0xE053 	;write
  37:     -	3490  54      		db 	pW_STORE
  37:     -	3491  53E0    		dw 	0xE053
  37:     -	3493  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	3495          		endm
  38:     -	3495          		dwstore	_CPM1_r_p_TRK2+1	,0xE057 	
  38:     -	3495  54      		db 	pW_STORE
  38:     -	3496  57E0    		dw 	0xE057
  38:     -	3498  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	349A          		endm
  39:     -	349A          		dwstore	_CPM1_r_p_SEC2+1	,0xE058 	
  39:     -	349A  54      		db 	pW_STORE
  39:     -	349B  58E0    		dw 	0xE058
  39:     -	349D  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	349F          		endm
  40:     -	349F          		dwstore	_CPM1_r_p_DMA2+1	,0xE059 	
  40:     -	349F  54      		db 	pW_STORE
  40:     -	34A0  59E0    		dw 	0xE059
  40:     -	34A2  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	34A4          		endm
  41:     -	34A4          		dwstore	_CPM1_r_p_DSK3+1	,0xE053 	;readinfo
  41:     -	34A4  54      		db 	pW_STORE
  41:     -	34A5  53E0    		dw 	0xE053
  41:     -	34A7  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	34A9          		endm
  42:				
  43:     -	34A9          		stop 'CPM_21_89_2_niijaf'
  43:     -	34A9  50      		db 	p_STOP
  43:     -	34AA  43504D5F		db 	'CPM_21_89_2_niijaf'
	      32315F38
	      395F325F
	      6E69696A
	      6166
  43:     -	34BC  00      		db 	0
  43:     -	34BD          		endm
**** out/include-patcher.asm ****
  37:					include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_870430.asm"	; 28 images in collection
**** generator/V0/out/patcher-microdos-MICRODOS_OPTS1_870430.asm ****
   1:     -	34BD          	_BIOS_MICRODOS_OPTS1_870430:
   2:     -	34BD          		setMICRODOS
   2:     -	34BD  56      		db 	pSETFLAG_MICRODOS
   2:     -	34BE          		endm
   3:     -	34BE          		RQ_OPTS1
   3:     -	34BE  57      		db 	pREQUIRED_OPTS1
   3:     -	34BF          		endm
   4:     -	34BF          		dbpatchmaybe	0xE5A2	,0x1B	,0x0d
   4:     -	34BF  59      		db 	pB_MAYBE_PATCH
   4:     -	34C0  A2E5    		dw 	0xE5A2
   4:     -	34C2  1B0D    		db 	0x1B,0x0d
   4:     -	34C4          		endm
   5:     -	34C4          		dbpatchmaybe	0xE5A2+1	,0x45	,0x0d
   5:     -	34C4  59      		db 	pB_MAYBE_PATCH
   5:     -	34C5  A3E5    		dw 	0xE5A2+1
   5:     -	34C7  450D    		db 	0x45,0x0d
   5:     -	34C9          		endm
   6:     -	34C9          		dwpatch	0xE497+1	,0xE627	,MD_READ			
   6:     -	34C9  51      		db 	pW_CHK_PATCH
   6:     -	34CA  98E4    		dw 	0xE497+1
   6:     -	34CC  27E63EFA		dw 	0xE627,MD_READ
   6:     -	34D0          		endm
   7:     -	34D0          		dwpatch	0xE4A0+1	,0xE62A	,MD_WRITE
   7:     -	34D0  51      		db 	pW_CHK_PATCH
   7:     -	34D1  A1E4    		dw 	0xE4A0+1
   7:     -	34D3  2AE653FA		dw 	0xE62A,MD_WRITE
   7:     -	34D7          		endm
   8:     -	34D7          		dbpatch	0xEAAE	,0xcd	,0x00
   8:     -	34D7  52      		db 	pB_CHK_PATCH
   8:     -	34D8  AEEA    		dw 	0xEAAE
   8:     -	34DA  CD00    		db 	0xcd,0x00
   8:     -	34DC          		endm
   9:     -	34DC          		dwpatch	0xEAAE+1	,0xE9E9	,0x0000
   9:     -	34DC  51      		db 	pW_CHK_PATCH
   9:     -	34DD  AFEA    		dw 	0xEAAE+1
   9:     -	34DF  E9E90000		dw 	0xE9E9,0x0000
   9:     -	34E3          		endm
  10:     -	34E3          		dwpatch	0xEAB4+1	,0xEC5D	,MD_READ_INFOSECTOR
  10:     -	34E3  51      		db 	pW_CHK_PATCH
  10:     -	34E4  B5EA    		dw 	0xEAB4+1
  10:     -	34E6  5DEC68FA		dw 	0xEC5D,MD_READ_INFOSECTOR
  10:     -	34EA          		endm
  11:     -	34EA          		dwstore	MD_DRV2+1,	0xDF5A
  11:     -	34EA  54      		db 	pW_STORE
  11:     -	34EB  5ADF    		dw 	0xDF5A
  11:     -	34ED  F3FA    		dw 	MD_DRV2+1
  11:     -	34EF          		endm
  12:     -	34EF          		dwstore	MD_RDBUF2+1,	0xE09A
  12:     -	34EF  54      		db 	pW_STORE
  12:     -	34F0  9AE0    		dw 	0xE09A
  12:     -	34F2  02FB    		dw 	MD_RDBUF2+1
  12:     -	34F4          		endm
  13:     -	34F4          		dwstore	MD_PARAM2+1,	0xDDC1
  13:     -	34F4  54      		db 	pW_STORE
  13:     -	34F5  C1DD    		dw 	0xDDC1
  13:     -	34F7  1DFA    		dw 	MD_PARAM2+1
  13:     -	34F9          		endm
  14:     -	34F9          		dwpatch 0xc01b+1	 ,0xDD8B	,md_res_seldsk
  14:     -	34F9  51      		db 	pW_CHK_PATCH
  14:     -	34FA  1CC0    		dw 	0xc01b+1
  14:     -	34FC  8BDD0EFA		dw 	0xDD8B,md_res_seldsk
  14:     -	3500          		endm
  15:     -	3500          		dwstore md_old_seld_dsk+1,0xDD8B	,0xdd4c
  15:     -	3500  54      		db 	pW_STORE
  15:     -	3501  8BDD    		dw 	0xDD8B
  15:     -	3503  12FA    		dw 	md_old_seld_dsk+1
  15:     -	3505          		endm
  16:					;custom checkers
  17:     -	3505          		dwpatch	0xBE80	,0xBE80 ,0xBE80
  17:     -	3505  51      		db 	pW_CHK_PATCH
  17:     -	3506  80BE    		dw 	0xBE80
  17:     -	3508  80BE80BE		dw 	0xBE80,0xBE80
  17:     -	350C          		endm
  18:     -	350C          		dwpatch	0xBE82	,0xBF00 ,0xBF00
  18:     -	350C  51      		db 	pW_CHK_PATCH
  18:     -	350D  82BE    		dw 	0xBE82
  18:     -	350F  00BF00BF		dw 	0xBF00,0xBF00
  18:     -	3513          		endm
  19:     -	3513          		dwpatch	0xc000+1	,0xC49A ,0xC49A
  19:     -	3513  51      		db 	pW_CHK_PATCH
  19:     -	3514  01C0    		dw 	0xc000+1
  19:     -	3516  9AC49AC4		dw 	0xC49A,0xC49A
  19:     -	351A          		endm
  20:     -	351A          		dwpatch	0xc003+1	,0xDBFD ,0xDBFD
  20:     -	351A  51      		db 	pW_CHK_PATCH
  20:     -	351B  04C0    		dw 	0xc003+1
  20:     -	351D  FDDBFDDB		dw 	0xDBFD,0xDBFD
  20:     -	3521          		endm
  21:     -	3521          		stop 'MICRODOS_OPTS1_870430'
  21:     -	3521  50      		db 	p_STOP
  21:     -	3522  4D494352		db 	'MICRODOS_OPTS1_870430'
	      4F444F53
	      5F4F5054
	      53315F38
	      37303433
	      30
  21:     -	3537  00      		db 	0
  21:     -	3538          		endm
**** out/include-patcher.asm ****
  38:					include "generator/V0/out/patcher-cpm2-CPM_1x_89_03_30_RAVI.asm"	; 17 images in collection
**** generator/V0/out/patcher-cpm2-CPM_1x_89_03_30_RAVI.asm ****
   1:     -	3538          	_BIOS_CPM_1x_89_03_30_RAVI:
   2:     -	3538          		setSUBBIOS 2
   2:     -	3538  5A      		db	pSubBios
   2:     -	3539  02      		db 	2
   2:     -	353A          		endm
   3:     -	353A          		RQ_OPTS1
   3:     -	353A  57      		db 	pREQUIRED_OPTS1
   3:     -	353B          		endm
   4:     -	353B          		setCPM
   4:     -	353B          		endm
   5:     -	353B          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	353B  59      		db 	pB_MAYBE_PATCH
   5:     -	353C  EEDA    		dw 	0xDAEE
   5:     -	353E  1F0D    		db 	0x1F,0x0d
   5:     -	3540          		endm
   6:     -	3540          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	3540  59      		db 	pB_MAYBE_PATCH
   6:     -	3541  F0DA    		dw 	0xDAEE+2
   6:     -	3543  0A0D    		db 	0x0a,0x0d
   6:     -	3545          		endm
   7:     -	3545          		dbpatch	0xE8B8+1	,0x49	,0xc9
   7:     -	3545  52      		db 	pB_CHK_PATCH
   7:     -	3546  B9E8    		dw 	0xE8B8+1
   7:     -	3548  49C9    		db 	0x49,0xc9
   7:     -	354A          		endm
   8:     -	354A          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	354A  52      		db 	pB_CHK_PATCH
   8:     -	354B  88DA    		dw 	0xDA88
   8:     -	354D  0100    		db 	0x01,0x00
   8:     -	354F          		endm
   9:     -	354F          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	354F  52      		db 	pB_CHK_PATCH
   9:     -	3550  9FDA    		dw 	0xDA9F
   9:     -	3552  0200    		db 	0x02,0x00
   9:     -	3554          		endm
  10:     -	3554          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	3554  52      		db 	pB_CHK_PATCH
  10:     -	3555  B6DA    		dw 	0xDAB6
  10:     -	3557  0401    		db 	0x04,0x01
  10:     -	3559          		endm
  11:     -	3559          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	3559  52      		db 	pB_CHK_PATCH
  11:     -	355A  CDDA    		dw 	0xDACD
  11:     -	355C  0802    		db 	0x08,0x02
  11:     -	355E          		endm
  12:     -	355E          		dwstore	_CPM2_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	355E  54      		db 	pW_STORE
  12:     -	355F  88DA    		dw 	0xDA88
  12:     -	3561  06EA    		dw 	_CPM2_res_DRIVE_TAB+0*2
  12:     -	3563          		endm
  13:     -	3563          		dwstore	_CPM2_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	3563  54      		db 	pW_STORE
  13:     -	3564  9FDA    		dw 	0xDA9F
  13:     -	3566  08EA    		dw 	_CPM2_res_DRIVE_TAB+1*2
  13:     -	3568          		endm
  14:     -	3568          		dwstore	_CPM2_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	3568  54      		db 	pW_STORE
  14:     -	3569  B6DA    		dw 	0xDAB6
  14:     -	356B  0AEA    		dw 	_CPM2_res_DRIVE_TAB+2*2
  14:     -	356D          		endm
  15:     -	356D          		dwstore	_CPM2_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	356D  54      		db 	pW_STORE
  15:     -	356E  CDDA    		dw 	0xDACD
  15:     -	3570  0CEA    		dw 	_CPM2_res_DRIVE_TAB+3*2
  15:     -	3572          		endm
  16:     -	3572          		dwpatch 0xDEC6+5*2 	,0x0000 ,_CPM2_dph_F
  16:     -	3572  51      		db 	pW_CHK_PATCH
  16:     -	3573  D0DE    		dw 	0xDEC6+5*2
  16:     -	3575  000012EA		dw 	0x0000,_CPM2_dph_F
  16:     -	3579          		endm
  17:     -	3579          		dwstore _CPM2_dph_F+8	,0xE1AB
  17:     -	3579  54      		db 	pW_STORE
  17:     -	357A  ABE1    		dw 	0xE1AB
  17:     -	357C  1AEA    		dw 	_CPM2_dph_F+8
  17:     -	357E          		endm
  18:     -	357E          		dwpatch 0xDA1B+1 	,0xDE82	,_CPM2_res_seldsk
  18:     -	357E  51      		db 	pW_CHK_PATCH
  18:     -	357F  1CDA    		dw 	0xDA1B+1
  18:     -	3581  82DE6BEA		dw 	0xDE82,_CPM2_res_seldsk
  18:     -	3585          		endm
  19:     -	3585          		dwstore	_CPM2_old_seld_dsk+1	,0xDE82
  19:     -	3585  54      		db 	pW_STORE
  19:     -	3586  82DE    		dw 	0xDE82
  19:     -	3588  6FEA    		dw 	_CPM2_old_seld_dsk+1
  19:     -	358A          		endm
  20:     -	358A          		dbpatch	0xE6DF	,0x77	,0x00
  20:     -	358A  52      		db 	pB_CHK_PATCH
  20:     -	358B  DFE6    		dw 	0xE6DF
  20:     -	358D  7700    		db 	0x77,0x00
  20:     -	358F          		endm
  21:     -	358F          		dwstore	_CPM2_r_p_SELDSKDRIVER+1	,0xE199
  21:     -	358F  54      		db 	pW_STORE
  21:     -	3590  99E1    		dw 	0xE199
  21:     -	3592  88EA    		dw 	_CPM2_r_p_SELDSKDRIVER+1
  21:     -	3594          		endm
  22:     -	3594          		dwstore	_CPM2_r_p_SELDSKDRIVEW+1	,0xE199
  22:     -	3594  54      		db 	pW_STORE
  22:     -	3595  99E1    		dw 	0xE199
  22:     -	3597  C5EA    		dw 	_CPM2_r_p_SELDSKDRIVEW+1
  22:     -	3599          		endm
  23:     -	3599          		dwpatch	0xDA27+1	,0xDEE5	,_CPM2_res_READ
  23:     -	3599  51      		db 	pW_CHK_PATCH
  23:     -	359A  28DA    		dw 	0xDA27+1
  23:     -	359C  E5DE75EA		dw 	0xDEE5,_CPM2_res_READ
  23:     -	35A0          		endm
  24:     -	35A0          		dwpatch	0xDA2A+1	,0xE01B	,_CPM2_res_WRITE
  24:     -	35A0  51      		db 	pW_CHK_PATCH
  24:     -	35A1  2BDA    		dw 	0xDA2A+1
  24:     -	35A3  1BE0B2EA		dw 	0xE01B,_CPM2_res_WRITE
  24:     -	35A7          		endm
  25:     -	35A7          		dwpatch	0xDBC2+1	,0xDEE5	,_CPM2_res_READ
  25:     -	35A7  51      		db 	pW_CHK_PATCH
  25:     -	35A8  C3DB    		dw 	0xDBC2+1
  25:     -	35AA  E5DE75EA		dw 	0xDEE5,_CPM2_res_READ
  25:     -	35AE          		endm
  26:     -	35AE          		dwpatch	0xdeb4+1	,0xE615	,_CPM2_res_GETINFO
  26:     -	35AE  51      		db 	pW_CHK_PATCH
  26:     -	35AF  B5DE    		dw 	0xdeb4+1
  26:     -	35B1  15E6EFEA		dw 	0xE615,_CPM2_res_GETINFO
  26:     -	35B5          		endm
  27:     -	35B5          		dwstore	_CPM2__old_read+1	,0xDEE5
  27:     -	35B5  54      		db 	pW_STORE
  27:     -	35B6  E5DE    		dw 	0xDEE5
  27:     -	35B8  B0EA    		dw 	_CPM2__old_read+1
  27:     -	35BA          		endm
  28:     -	35BA          		dwstore	_CPM2__old_write+1	,0xE01B
  28:     -	35BA  54      		db 	pW_STORE
  28:     -	35BB  1BE0    		dw 	0xE01B
  28:     -	35BD  EDEA    		dw 	_CPM2__old_write+1
  28:     -	35BF          		endm
  29:     -	35BF          		dwstore	_CPM2__old_getinfo+1	,0xE615
  29:     -	35BF  54      		db 	pW_STORE
  29:     -	35C0  15E6    		dw 	0xE615
  29:     -	35C2  FDEA    		dw 	_CPM2__old_getinfo+1
  29:     -	35C4          		endm
  30:     -	35C4          		dbpatch	0xE655		,0x21	,0x21
  30:     -	35C4  52      		db 	pB_CHK_PATCH
  30:     -	35C5  55E6    		dw 	0xE655
  30:     -	35C7  2121    		db 	0x21,0x21
  30:     -	35C9          		endm
  31:     -	35C9          		dwpatch	0xE655+1 	,0xE685	,0xE685
  31:     -	35C9  51      		db 	pW_CHK_PATCH
  31:     -	35CA  56E6    		dw 	0xE655+1
  31:     -	35CC  85E685E6		dw 	0xE685,0xE685
  31:     -	35D0          		endm
  32:     -	35D0          		dwstore	_CPM2__old_getinfo_chkdo+1	,0xE655
  32:     -	35D0  54      		db 	pW_STORE
  32:     -	35D1  55E6    		dw 	0xE655
  32:     -	35D3  FAEA    		dw 	_CPM2__old_getinfo_chkdo+1
  32:     -	35D5          		endm
  33:     -	35D5          		dwstore	_CPM2_r_p_DSK1+1	,0xE18F 	;read
  33:     -	35D5  54      		db 	pW_STORE
  33:     -	35D6  8FE1    		dw 	0xE18F
  33:     -	35D8  76EA    		dw 	_CPM2_r_p_DSK1+1
  33:     -	35DA          		endm
  34:     -	35DA          		dwstore	_CPM2_r_p_TRK1+1	,0xE193 	
  34:     -	35DA  54      		db 	pW_STORE
  34:     -	35DB  93E1    		dw 	0xE193
  34:     -	35DD  91EA    		dw 	_CPM2_r_p_TRK1+1
  34:     -	35DF          		endm
  35:     -	35DF          		dwstore	_CPM2_r_p_SEC1+1	,0xE194 	
  35:     -	35DF  54      		db 	pW_STORE
  35:     -	35E0  94E1    		dw 	0xE194
  35:     -	35E2  97EA    		dw 	_CPM2_r_p_SEC1+1
  35:     -	35E4          		endm
  36:     -	35E4          		dwstore	_CPM2_r_p_DMA1+1	,0xE195 	
  36:     -	35E4  54      		db 	pW_STORE
  36:     -	35E5  95E1    		dw 	0xE195
  36:     -	35E7  A8EA    		dw 	_CPM2_r_p_DMA1+1
  36:     -	35E9          		endm
  37:     -	35E9          		dwstore	_CPM2_r_p_DSK2+1	,0xE18F 	;write
  37:     -	35E9  54      		db 	pW_STORE
  37:     -	35EA  8FE1    		dw 	0xE18F
  37:     -	35EC  B3EA    		dw 	_CPM2_r_p_DSK2+1
  37:     -	35EE          		endm
  38:     -	35EE          		dwstore	_CPM2_r_p_TRK2+1	,0xE193 	
  38:     -	35EE  54      		db 	pW_STORE
  38:     -	35EF  93E1    		dw 	0xE193
  38:     -	35F1  CEEA    		dw 	_CPM2_r_p_TRK2+1
  38:     -	35F3          		endm
  39:     -	35F3          		dwstore	_CPM2_r_p_SEC2+1	,0xE194 	
  39:     -	35F3  54      		db 	pW_STORE
  39:     -	35F4  94E1    		dw 	0xE194
  39:     -	35F6  D4EA    		dw 	_CPM2_r_p_SEC2+1
  39:     -	35F8          		endm
  40:     -	35F8          		dwstore	_CPM2_r_p_DMA2+1	,0xE195 	
  40:     -	35F8  54      		db 	pW_STORE
  40:     -	35F9  95E1    		dw 	0xE195
  40:     -	35FB  E5EA    		dw 	_CPM2_r_p_DMA2+1
  40:     -	35FD          		endm
  41:     -	35FD          		dwstore	_CPM2_r_p_DSK3+1	,0xE18F 	;readinfo
  41:     -	35FD  54      		db 	pW_STORE
  41:     -	35FE  8FE1    		dw 	0xE18F
  41:     -	3600  82EB    		dw 	_CPM2_r_p_DSK3+1
  41:     -	3602          		endm
  42:				
  43:     -	3602          		stop 'CPM_1x_89_03_30_RAVI'
  43:     -	3602  50      		db 	p_STOP
  43:     -	3603  43504D5F		db 	'CPM_1x_89_03_30_RAVI'
	      31785F38
	      395F3033
	      5F33305F
	      52415649
  43:     -	3617  00      		db 	0
  43:     -	3618          		endm
**** out/include-patcher.asm ****
  39:					include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861011.asm"	;  7 images in collection
**** generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861011.asm ****
   1:     -	3618          	_BIOS_MICRODOS_OPTS1_861011:
   2:     -	3618          		setMICRODOS
   2:     -	3618  56      		db 	pSETFLAG_MICRODOS
   2:     -	3619          		endm
   3:     -	3619          		RQ_OPTS1
   3:     -	3619  57      		db 	pREQUIRED_OPTS1
   3:     -	361A          		endm
   4:     -	361A          		dbpatchmaybe	0xE693	,0x1B	,0x0d
   4:     -	361A  59      		db 	pB_MAYBE_PATCH
   4:     -	361B  93E6    		dw 	0xE693
   4:     -	361D  1B0D    		db 	0x1B,0x0d
   4:     -	361F          		endm
   5:     -	361F          		dbpatchmaybe	0xE693+1	,0x45	,0x0d
   5:     -	361F  59      		db 	pB_MAYBE_PATCH
   5:     -	3620  94E6    		dw 	0xE693+1
   5:     -	3622  450D    		db 	0x45,0x0d
   5:     -	3624          		endm
   6:     -	3624          		dwpatch	0xE497+1	,0xE627	,MD_READ			
   6:     -	3624  51      		db 	pW_CHK_PATCH
   6:     -	3625  98E4    		dw 	0xE497+1
   6:     -	3627  27E63EFA		dw 	0xE627,MD_READ
   6:     -	362B          		endm
   7:     -	362B          		dwpatch	0xE4A0+1	,0xE62A	,MD_WRITE
   7:     -	362B  51      		db 	pW_CHK_PATCH
   7:     -	362C  A1E4    		dw 	0xE4A0+1
   7:     -	362E  2AE653FA		dw 	0xE62A,MD_WRITE
   7:     -	3632          		endm
   8:     -	3632          		dbpatch	0xEAAE	,0xcd	,0x00
   8:     -	3632  52      		db 	pB_CHK_PATCH
   8:     -	3633  AEEA    		dw 	0xEAAE
   8:     -	3635  CD00    		db 	0xcd,0x00
   8:     -	3637          		endm
   9:     -	3637          		dwpatch	0xEAAE+1	,0xE9E9	,0x0000
   9:     -	3637  51      		db 	pW_CHK_PATCH
   9:     -	3638  AFEA    		dw 	0xEAAE+1
   9:     -	363A  E9E90000		dw 	0xE9E9,0x0000
   9:     -	363E          		endm
  10:     -	363E          		dwpatch	0xEAB4+1	,0xEC5D	,MD_READ_INFOSECTOR
  10:     -	363E  51      		db 	pW_CHK_PATCH
  10:     -	363F  B5EA    		dw 	0xEAB4+1
  10:     -	3641  5DEC68FA		dw 	0xEC5D,MD_READ_INFOSECTOR
  10:     -	3645          		endm
  11:     -	3645          		dwstore	MD_DRV2+1,	0xDFC8
  11:     -	3645  54      		db 	pW_STORE
  11:     -	3646  C8DF    		dw 	0xDFC8
  11:     -	3648  F3FA    		dw 	MD_DRV2+1
  11:     -	364A          		endm
  12:     -	364A          		dwstore	MD_RDBUF2+1,	0xEEB0
  12:     -	364A  54      		db 	pW_STORE
  12:     -	364B  B0EE    		dw 	0xEEB0
  12:     -	364D  02FB    		dw 	MD_RDBUF2+1
  12:     -	364F          		endm
  13:     -	364F          		dwstore	MD_PARAM2+1,	0xDDBC
  13:     -	364F  54      		db 	pW_STORE
  13:     -	3650  BCDD    		dw 	0xDDBC
  13:     -	3652  1DFA    		dw 	MD_PARAM2+1
  13:     -	3654          		endm
  14:     -	3654          		dwpatch 0xc01b+1	 ,0xDD86	,md_res_seldsk
  14:     -	3654  51      		db 	pW_CHK_PATCH
  14:     -	3655  1CC0    		dw 	0xc01b+1
  14:     -	3657  86DD0EFA		dw 	0xDD86,md_res_seldsk
  14:     -	365B          		endm
  15:     -	365B          		dwstore md_old_seld_dsk+1,0xDD86	,0xdd4c
  15:     -	365B  54      		db 	pW_STORE
  15:     -	365C  86DD    		dw 	0xDD86
  15:     -	365E  12FA    		dw 	md_old_seld_dsk+1
  15:     -	3660          		endm
  16:					;custom checkers
  17:     -	3660          		dwpatch	0xBC80	,0xBC80 ,0xBC80
  17:     -	3660  51      		db 	pW_CHK_PATCH
  17:     -	3661  80BC    		dw 	0xBC80
  17:     -	3663  80BC80BC		dw 	0xBC80,0xBC80
  17:     -	3667          		endm
  18:     -	3667          		dwpatch	0xBC82	,0xBD00 ,0xBD00
  18:     -	3667  51      		db 	pW_CHK_PATCH
  18:     -	3668  82BC    		dw 	0xBC82
  18:     -	366A  00BD00BD		dw 	0xBD00,0xBD00
  18:     -	366E          		endm
  19:     -	366E          		dwpatch	0xc000+1	,0xC4BF ,0xC4BF
  19:     -	366E  51      		db 	pW_CHK_PATCH
  19:     -	366F  01C0    		dw 	0xc000+1
  19:     -	3671  BFC4BFC4		dw 	0xC4BF,0xC4BF
  19:     -	3675          		endm
  20:     -	3675          		dwpatch	0xc003+1	,0xDBFB ,0xDBFB
  20:     -	3675  51      		db 	pW_CHK_PATCH
  20:     -	3676  04C0    		dw 	0xc003+1
  20:     -	3678  FBDBFBDB		dw 	0xDBFB,0xDBFB
  20:     -	367C          		endm
  21:     -	367C          		dbpatch	0xDF95	,0x50 ,0x50
  21:     -	367C  52      		db 	pB_CHK_PATCH
  21:     -	367D  95DF    		dw 	0xDF95
  21:     -	367F  5050    		db 	0x50,0x50
  21:     -	3681          		endm
  22:     -	3681          		dbpatch	0xDF97	,0x18 ,0x18
  22:     -	3681  52      		db 	pB_CHK_PATCH
  22:     -	3682  97DF    		dw 	0xDF97
  22:     -	3684  1818    		db 	0x18,0x18
  22:     -	3686          		endm
  23:     -	3686          		stop 'MICRODOS_OPTS1_861011'
  23:     -	3686  50      		db 	p_STOP
  23:     -	3687  4D494352		db 	'MICRODOS_OPTS1_861011'
	      4F444F53
	      5F4F5054
	      53315F38
	      36313031
	      31
  23:     -	369C  00      		db 	0
  23:     -	369D          		endm
**** out/include-patcher.asm ****
  40:					include "generator/V0/out/patcher-cpm1-CPM_21_91___LAP.asm"	;  4 images in collection
**** generator/V0/out/patcher-cpm1-CPM_21_91___LAP.asm ****
   1:     -	369D          	_BIOS_CPM_21_91___LAP:
   2:     -	369D          		setSUBBIOS 1
   2:     -	369D  5A      		db	pSubBios
   2:     -	369E  01      		db 	1
   2:     -	369F          		endm
   3:     -	369F          		RQ_OPTS_ANY
   3:     -	369F          		endm
   4:     -	369F          		setCPM
   4:     -	369F          		endm
   5:     -	369F          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	369F  59      		db 	pB_MAYBE_PATCH
   5:     -	36A0  EEDA    		dw 	0xDAEE
   5:     -	36A2  1F0D    		db 	0x1F,0x0d
   5:     -	36A4          		endm
   6:     -	36A4          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	36A4  59      		db 	pB_MAYBE_PATCH
   6:     -	36A5  F0DA    		dw 	0xDAEE+2
   6:     -	36A7  0A0D    		db 	0x0a,0x0d
   6:     -	36A9          		endm
   7:     -	36A9          		dbpatch	0xE0D2+1	,0x49	,0xc9
   7:     -	36A9  52      		db 	pB_CHK_PATCH
   7:     -	36AA  D3E0    		dw 	0xE0D2+1
   7:     -	36AC  49C9    		db 	0x49,0xc9
   7:     -	36AE          		endm
   8:     -	36AE          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	36AE  52      		db 	pB_CHK_PATCH
   8:     -	36AF  88DA    		dw 	0xDA88
   8:     -	36B1  0100    		db 	0x01,0x00
   8:     -	36B3          		endm
   9:     -	36B3          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	36B3  52      		db 	pB_CHK_PATCH
   9:     -	36B4  9FDA    		dw 	0xDA9F
   9:     -	36B6  0200    		db 	0x02,0x00
   9:     -	36B8          		endm
  10:     -	36B8          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	36B8  52      		db 	pB_CHK_PATCH
  10:     -	36B9  B6DA    		dw 	0xDAB6
  10:     -	36BB  0401    		db 	0x04,0x01
  10:     -	36BD          		endm
  11:     -	36BD          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	36BD  52      		db 	pB_CHK_PATCH
  11:     -	36BE  CDDA    		dw 	0xDACD
  11:     -	36C0  0802    		db 	0x08,0x02
  11:     -	36C2          		endm
  12:     -	36C2          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	36C2  54      		db 	pW_STORE
  12:     -	36C3  88DA    		dw 	0xDA88
  12:     -	36C5  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	36C7          		endm
  13:     -	36C7          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	36C7  54      		db 	pW_STORE
  13:     -	36C8  9FDA    		dw 	0xDA9F
  13:     -	36CA  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	36CC          		endm
  14:     -	36CC          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	36CC  54      		db 	pW_STORE
  14:     -	36CD  B6DA    		dw 	0xDAB6
  14:     -	36CF  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	36D1          		endm
  15:     -	36D1          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	36D1  54      		db 	pW_STORE
  15:     -	36D2  CDDA    		dw 	0xDACD
  15:     -	36D4  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	36D6          		endm
  16:     -	36D6          		dwpatch 0xDCF2+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	36D6  51      		db 	pW_CHK_PATCH
  16:     -	36D7  FCDC    		dw 	0xDCF2+5*2
  16:     -	36D9  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	36DD          		endm
  17:     -	36DD          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	36DD  54      		db 	pW_STORE
  17:     -	36DE  A6EB    		dw 	0xEBA6
  17:     -	36E0  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	36E2          		endm
  18:     -	36E2          		dwpatch 0xDA1B+1 	,0xDCAE	,_CPM1_res_seldsk
  18:     -	36E2  51      		db 	pW_CHK_PATCH
  18:     -	36E3  1CDA    		dw 	0xDA1B+1
  18:     -	36E5  AEDC11E9		dw 	0xDCAE,_CPM1_res_seldsk
  18:     -	36E9          		endm
  19:     -	36E9          		dwstore	_CPM1_old_seld_dsk+1	,0xDCAE
  19:     -	36E9  54      		db 	pW_STORE
  19:     -	36EA  AEDC    		dw 	0xDCAE
  19:     -	36EC  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	36EE          		endm
  20:     -	36EE          		dbpatch	0xE69F	,0x77	,0x00
  20:     -	36EE  52      		db 	pB_CHK_PATCH
  20:     -	36EF  9FE6    		dw 	0xE69F
  20:     -	36F1  7700    		db 	0x77,0x00
  20:     -	36F3          		endm
  21:     -	36F3          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFED
  21:     -	36F3  54      		db 	pW_STORE
  21:     -	36F4  EDDF    		dw 	0xDFED
  21:     -	36F6  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	36F8          		endm
  22:     -	36F8          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFED
  22:     -	36F8  54      		db 	pW_STORE
  22:     -	36F9  EDDF    		dw 	0xDFED
  22:     -	36FB  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	36FD          		endm
  23:     -	36FD          		dwpatch	0xDA27+1	,0xDD11	,_CPM1_res_READ
  23:     -	36FD  51      		db 	pW_CHK_PATCH
  23:     -	36FE  28DA    		dw 	0xDA27+1
  23:     -	3700  11DD1BE9		dw 	0xDD11,_CPM1_res_READ
  23:     -	3704          		endm
  24:     -	3704          		dwpatch	0xDA2A+1	,0xDE47	,_CPM1_res_WRITE
  24:     -	3704  51      		db 	pW_CHK_PATCH
  24:     -	3705  2BDA    		dw 	0xDA2A+1
  24:     -	3707  47DE58E9		dw 	0xDE47,_CPM1_res_WRITE
  24:     -	370B          		endm
  25:     -	370B          		dwpatch	0xDB5F+1	,0xDD11	,_CPM1_res_READ
  25:     -	370B  51      		db 	pW_CHK_PATCH
  25:     -	370C  60DB    		dw 	0xDB5F+1
  25:     -	370E  11DD1BE9		dw 	0xDD11,_CPM1_res_READ
  25:     -	3712          		endm
  26:     -	3712          		dwpatch	0xdce0+1	,0xE5D5	,_CPM1_res_GETINFO
  26:     -	3712  51      		db 	pW_CHK_PATCH
  26:     -	3713  E1DC    		dw 	0xdce0+1
  26:     -	3715  D5E595E9		dw 	0xE5D5,_CPM1_res_GETINFO
  26:     -	3719          		endm
  27:     -	3719          		dwstore	_CPM1__old_read+1	,0xDD11
  27:     -	3719  54      		db 	pW_STORE
  27:     -	371A  11DD    		dw 	0xDD11
  27:     -	371C  56E9    		dw 	_CPM1__old_read+1
  27:     -	371E          		endm
  28:     -	371E          		dwstore	_CPM1__old_write+1	,0xDE47
  28:     -	371E  54      		db 	pW_STORE
  28:     -	371F  47DE    		dw 	0xDE47
  28:     -	3721  93E9    		dw 	_CPM1__old_write+1
  28:     -	3723          		endm
  29:     -	3723          		dwstore	_CPM1__old_getinfo+1	,0xE5D5
  29:     -	3723  54      		db 	pW_STORE
  29:     -	3724  D5E5    		dw 	0xE5D5
  29:     -	3726  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	3728          		endm
  30:     -	3728          		dbpatch	0xE615		,0x21	,0x21
  30:     -	3728  52      		db 	pB_CHK_PATCH
  30:     -	3729  15E6    		dw 	0xE615
  30:     -	372B  2121    		db 	0x21,0x21
  30:     -	372D          		endm
  31:     -	372D          		dwpatch	0xE615+1 	,0xE645	,0xE645
  31:     -	372D  51      		db 	pW_CHK_PATCH
  31:     -	372E  16E6    		dw 	0xE615+1
  31:     -	3730  45E645E6		dw 	0xE645,0xE645
  31:     -	3734          		endm
  32:     -	3734          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE615
  32:     -	3734  54      		db 	pW_STORE
  32:     -	3735  15E6    		dw 	0xE615
  32:     -	3737  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	3739          		endm
  33:     -	3739          		dwstore	_CPM1_r_p_DSK1+1	,0xDFE3 	;read
  33:     -	3739  54      		db 	pW_STORE
  33:     -	373A  E3DF    		dw 	0xDFE3
  33:     -	373C  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	373E          		endm
  34:     -	373E          		dwstore	_CPM1_r_p_TRK1+1	,0xDFE7 	
  34:     -	373E  54      		db 	pW_STORE
  34:     -	373F  E7DF    		dw 	0xDFE7
  34:     -	3741  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	3743          		endm
  35:     -	3743          		dwstore	_CPM1_r_p_SEC1+1	,0xDFE8 	
  35:     -	3743  54      		db 	pW_STORE
  35:     -	3744  E8DF    		dw 	0xDFE8
  35:     -	3746  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	3748          		endm
  36:     -	3748          		dwstore	_CPM1_r_p_DMA1+1	,0xDFE9 	
  36:     -	3748  54      		db 	pW_STORE
  36:     -	3749  E9DF    		dw 	0xDFE9
  36:     -	374B  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	374D          		endm
  37:     -	374D          		dwstore	_CPM1_r_p_DSK2+1	,0xDFE3 	;write
  37:     -	374D  54      		db 	pW_STORE
  37:     -	374E  E3DF    		dw 	0xDFE3
  37:     -	3750  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	3752          		endm
  38:     -	3752          		dwstore	_CPM1_r_p_TRK2+1	,0xDFE7 	
  38:     -	3752  54      		db 	pW_STORE
  38:     -	3753  E7DF    		dw 	0xDFE7
  38:     -	3755  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	3757          		endm
  39:     -	3757          		dwstore	_CPM1_r_p_SEC2+1	,0xDFE8 	
  39:     -	3757  54      		db 	pW_STORE
  39:     -	3758  E8DF    		dw 	0xDFE8
  39:     -	375A  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	375C          		endm
  40:     -	375C          		dwstore	_CPM1_r_p_DMA2+1	,0xDFE9 	
  40:     -	375C  54      		db 	pW_STORE
  40:     -	375D  E9DF    		dw 	0xDFE9
  40:     -	375F  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	3761          		endm
  41:     -	3761          		dwstore	_CPM1_r_p_DSK3+1	,0xDFE3 	;readinfo
  41:     -	3761  54      		db 	pW_STORE
  41:     -	3762  E3DF    		dw 	0xDFE3
  41:     -	3764  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	3766          		endm
  42:				
  43:     -	3766          		stop 'CPM_21_91___LAP'
  43:     -	3766  50      		db 	p_STOP
  43:     -	3767  43504D5F		db 	'CPM_21_91___LAP'
	      32315F39
	      315F5F5F
	      4C4150
  43:     -	3776  00      		db 	0
  43:     -	3777          		endm
**** out/include-patcher.asm ****
  41:					include "generator/V0/out/patcher-cpm1-CPM_20_88___miks.asm"	;  4 images in collection
**** generator/V0/out/patcher-cpm1-CPM_20_88___miks.asm ****
   1:     -	3777          	_BIOS_CPM_20_88___miks:
   2:     -	3777          		setSUBBIOS 1
   2:     -	3777  5A      		db	pSubBios
   2:     -	3778  01      		db 	1
   2:     -	3779          		endm
   3:     -	3779          		RQ_OPTS_ANY
   3:     -	3779          		endm
   4:     -	3779          		setCPM
   4:     -	3779          		endm
   5:     -	3779          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	3779  59      		db 	pB_MAYBE_PATCH
   5:     -	377A  EEDA    		dw 	0xDAEE
   5:     -	377C  1F0D    		db 	0x1F,0x0d
   5:     -	377E          		endm
   6:     -	377E          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	377E  59      		db 	pB_MAYBE_PATCH
   6:     -	377F  F0DA    		dw 	0xDAEE+2
   6:     -	3781  0A0D    		db 	0x0a,0x0d
   6:     -	3783          		endm
   7:     -	3783          		dbpatch	0xE3DC+1	,0x49	,0xc9
   7:     -	3783  52      		db 	pB_CHK_PATCH
   7:     -	3784  DDE3    		dw 	0xE3DC+1
   7:     -	3786  49C9    		db 	0x49,0xc9
   7:     -	3788          		endm
   8:     -	3788          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	3788  52      		db 	pB_CHK_PATCH
   8:     -	3789  88DA    		dw 	0xDA88
   8:     -	378B  0100    		db 	0x01,0x00
   8:     -	378D          		endm
   9:     -	378D          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	378D  52      		db 	pB_CHK_PATCH
   9:     -	378E  9FDA    		dw 	0xDA9F
   9:     -	3790  0200    		db 	0x02,0x00
   9:     -	3792          		endm
  10:     -	3792          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	3792  52      		db 	pB_CHK_PATCH
  10:     -	3793  B6DA    		dw 	0xDAB6
  10:     -	3795  0401    		db 	0x04,0x01
  10:     -	3797          		endm
  11:     -	3797          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	3797  52      		db 	pB_CHK_PATCH
  11:     -	3798  CDDA    		dw 	0xDACD
  11:     -	379A  0802    		db 	0x08,0x02
  11:     -	379C          		endm
  12:     -	379C          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	379C  54      		db 	pW_STORE
  12:     -	379D  88DA    		dw 	0xDA88
  12:     -	379F  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	37A1          		endm
  13:     -	37A1          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	37A1  54      		db 	pW_STORE
  13:     -	37A2  9FDA    		dw 	0xDA9F
  13:     -	37A4  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	37A6          		endm
  14:     -	37A6          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	37A6  54      		db 	pW_STORE
  14:     -	37A7  B6DA    		dw 	0xDAB6
  14:     -	37A9  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	37AB          		endm
  15:     -	37AB          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	37AB  54      		db 	pW_STORE
  15:     -	37AC  CDDA    		dw 	0xDACD
  15:     -	37AE  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	37B0          		endm
  16:     -	37B0          		dwpatch 0xDCD0+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	37B0  51      		db 	pW_CHK_PATCH
  16:     -	37B1  DADC    		dw 	0xDCD0+5*2
  16:     -	37B3  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	37B7          		endm
  17:     -	37B7          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	37B7  54      		db 	pW_STORE
  17:     -	37B8  A6EB    		dw 	0xEBA6
  17:     -	37BA  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	37BC          		endm
  18:     -	37BC          		dwpatch 0xDA1B+1 	,0xDC8C	,_CPM1_res_seldsk
  18:     -	37BC  51      		db 	pW_CHK_PATCH
  18:     -	37BD  1CDA    		dw 	0xDA1B+1
  18:     -	37BF  8CDC11E9		dw 	0xDC8C,_CPM1_res_seldsk
  18:     -	37C3          		endm
  19:     -	37C3          		dwstore	_CPM1_old_seld_dsk+1	,0xDC8C
  19:     -	37C3  54      		db 	pW_STORE
  19:     -	37C4  8CDC    		dw 	0xDC8C
  19:     -	37C6  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	37C8          		endm
  20:     -	37C8          		dbpatch	0xE64F	,0x77	,0x00
  20:     -	37C8  52      		db 	pB_CHK_PATCH
  20:     -	37C9  4FE6    		dw 	0xE64F
  20:     -	37CB  7700    		db 	0x77,0x00
  20:     -	37CD          		endm
  21:     -	37CD          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFA3
  21:     -	37CD  54      		db 	pW_STORE
  21:     -	37CE  A3DF    		dw 	0xDFA3
  21:     -	37D0  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	37D2          		endm
  22:     -	37D2          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFA3
  22:     -	37D2  54      		db 	pW_STORE
  22:     -	37D3  A3DF    		dw 	0xDFA3
  22:     -	37D5  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	37D7          		endm
  23:     -	37D7          		dwpatch	0xDA27+1	,0xDCEF	,_CPM1_res_READ
  23:     -	37D7  51      		db 	pW_CHK_PATCH
  23:     -	37D8  28DA    		dw 	0xDA27+1
  23:     -	37DA  EFDC1BE9		dw 	0xDCEF,_CPM1_res_READ
  23:     -	37DE          		endm
  24:     -	37DE          		dwpatch	0xDA2A+1	,0xDE25	,_CPM1_res_WRITE
  24:     -	37DE  51      		db 	pW_CHK_PATCH
  24:     -	37DF  2BDA    		dw 	0xDA2A+1
  24:     -	37E1  25DE58E9		dw 	0xDE25,_CPM1_res_WRITE
  24:     -	37E5          		endm
  25:     -	37E5          		dwpatch	0xDB85+1	,0xDCEF	,_CPM1_res_READ
  25:     -	37E5  51      		db 	pW_CHK_PATCH
  25:     -	37E6  86DB    		dw 	0xDB85+1
  25:     -	37E8  EFDC1BE9		dw 	0xDCEF,_CPM1_res_READ
  25:     -	37EC          		endm
  26:     -	37EC          		dwpatch	0xdcbe+1	,0xE585	,_CPM1_res_GETINFO
  26:     -	37EC  51      		db 	pW_CHK_PATCH
  26:     -	37ED  BFDC    		dw 	0xdcbe+1
  26:     -	37EF  85E595E9		dw 	0xE585,_CPM1_res_GETINFO
  26:     -	37F3          		endm
  27:     -	37F3          		dwstore	_CPM1__old_read+1	,0xDCEF
  27:     -	37F3  54      		db 	pW_STORE
  27:     -	37F4  EFDC    		dw 	0xDCEF
  27:     -	37F6  56E9    		dw 	_CPM1__old_read+1
  27:     -	37F8          		endm
  28:     -	37F8          		dwstore	_CPM1__old_write+1	,0xDE25
  28:     -	37F8  54      		db 	pW_STORE
  28:     -	37F9  25DE    		dw 	0xDE25
  28:     -	37FB  93E9    		dw 	_CPM1__old_write+1
  28:     -	37FD          		endm
  29:     -	37FD          		dwstore	_CPM1__old_getinfo+1	,0xE585
  29:     -	37FD  54      		db 	pW_STORE
  29:     -	37FE  85E5    		dw 	0xE585
  29:     -	3800  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	3802          		endm
  30:     -	3802          		dbpatch	0xE5C5		,0x21	,0x21
  30:     -	3802  52      		db 	pB_CHK_PATCH
  30:     -	3803  C5E5    		dw 	0xE5C5
  30:     -	3805  2121    		db 	0x21,0x21
  30:     -	3807          		endm
  31:     -	3807          		dwpatch	0xE5C5+1 	,0xE5F5	,0xE5F5
  31:     -	3807  51      		db 	pW_CHK_PATCH
  31:     -	3808  C6E5    		dw 	0xE5C5+1
  31:     -	380A  F5E5F5E5		dw 	0xE5F5,0xE5F5
  31:     -	380E          		endm
  32:     -	380E          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE5C5
  32:     -	380E  54      		db 	pW_STORE
  32:     -	380F  C5E5    		dw 	0xE5C5
  32:     -	3811  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	3813          		endm
  33:     -	3813          		dwstore	_CPM1_r_p_DSK1+1	,0xDF99 	;read
  33:     -	3813  54      		db 	pW_STORE
  33:     -	3814  99DF    		dw 	0xDF99
  33:     -	3816  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	3818          		endm
  34:     -	3818          		dwstore	_CPM1_r_p_TRK1+1	,0xDF9D 	
  34:     -	3818  54      		db 	pW_STORE
  34:     -	3819  9DDF    		dw 	0xDF9D
  34:     -	381B  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	381D          		endm
  35:     -	381D          		dwstore	_CPM1_r_p_SEC1+1	,0xDF9E 	
  35:     -	381D  54      		db 	pW_STORE
  35:     -	381E  9EDF    		dw 	0xDF9E
  35:     -	3820  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	3822          		endm
  36:     -	3822          		dwstore	_CPM1_r_p_DMA1+1	,0xDF9F 	
  36:     -	3822  54      		db 	pW_STORE
  36:     -	3823  9FDF    		dw 	0xDF9F
  36:     -	3825  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	3827          		endm
  37:     -	3827          		dwstore	_CPM1_r_p_DSK2+1	,0xDF99 	;write
  37:     -	3827  54      		db 	pW_STORE
  37:     -	3828  99DF    		dw 	0xDF99
  37:     -	382A  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	382C          		endm
  38:     -	382C          		dwstore	_CPM1_r_p_TRK2+1	,0xDF9D 	
  38:     -	382C  54      		db 	pW_STORE
  38:     -	382D  9DDF    		dw 	0xDF9D
  38:     -	382F  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	3831          		endm
  39:     -	3831          		dwstore	_CPM1_r_p_SEC2+1	,0xDF9E 	
  39:     -	3831  54      		db 	pW_STORE
  39:     -	3832  9EDF    		dw 	0xDF9E
  39:     -	3834  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	3836          		endm
  40:     -	3836          		dwstore	_CPM1_r_p_DMA2+1	,0xDF9F 	
  40:     -	3836  54      		db 	pW_STORE
  40:     -	3837  9FDF    		dw 	0xDF9F
  40:     -	3839  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	383B          		endm
  41:     -	383B          		dwstore	_CPM1_r_p_DSK3+1	,0xDF99 	;readinfo
  41:     -	383B  54      		db 	pW_STORE
  41:     -	383C  99DF    		dw 	0xDF99
  41:     -	383E  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	3840          		endm
  42:				
  43:     -	3840          		stop 'CPM_20_88___miks'
  43:     -	3840  50      		db 	p_STOP
  43:     -	3841  43504D5F		db 	'CPM_20_88___miks'
	      32305F38
	      385F5F5F
	      6D696B73
  43:     -	3851  00      		db 	0
  43:     -	3852          		endm
**** out/include-patcher.asm ****
  42:					include "generator/V0/out/patcher-cpm1-CPM_12_90_5_kontur.asm"	;  4 images in collection
**** generator/V0/out/patcher-cpm1-CPM_12_90_5_kontur.asm ****
   1:     -	3852          	_BIOS_CPM_12_90_5_kontur:
   2:     -	3852          		setSUBBIOS 1
   2:     -	3852  5A      		db	pSubBios
   2:     -	3853  01      		db 	1
   2:     -	3854          		endm
   3:     -	3854          		RQ_OPTS_ANY
   3:     -	3854          		endm
   4:     -	3854          		setCPM
   4:     -	3854          		endm
   5:     -	3854          		dbpatchmaybe	0xDAEF	,0x1F	,0x0d
   5:     -	3854  59      		db 	pB_MAYBE_PATCH
   5:     -	3855  EFDA    		dw 	0xDAEF
   5:     -	3857  1F0D    		db 	0x1F,0x0d
   5:     -	3859          		endm
   6:     -	3859          		dbpatchmaybe	0xDAEF+2	,0x0a	,0x0d
   6:     -	3859  59      		db 	pB_MAYBE_PATCH
   6:     -	385A  F1DA    		dw 	0xDAEF+2
   6:     -	385C  0A0D    		db 	0x0a,0x0d
   6:     -	385E          		endm
   7:     -	385E          		dbpatch	0xE09B+1	,0x49	,0xc9
   7:     -	385E  52      		db 	pB_CHK_PATCH
   7:     -	385F  9CE0    		dw 	0xE09B+1
   7:     -	3861  49C9    		db 	0x49,0xc9
   7:     -	3863          		endm
   8:     -	3863          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	3863  52      		db 	pB_CHK_PATCH
   8:     -	3864  88DA    		dw 	0xDA88
   8:     -	3866  0100    		db 	0x01,0x00
   8:     -	3868          		endm
   9:     -	3868          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	3868  52      		db 	pB_CHK_PATCH
   9:     -	3869  9FDA    		dw 	0xDA9F
   9:     -	386B  0200    		db 	0x02,0x00
   9:     -	386D          		endm
  10:     -	386D          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	386D  52      		db 	pB_CHK_PATCH
  10:     -	386E  B6DA    		dw 	0xDAB6
  10:     -	3870  0401    		db 	0x04,0x01
  10:     -	3872          		endm
  11:     -	3872          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	3872  52      		db 	pB_CHK_PATCH
  11:     -	3873  CDDA    		dw 	0xDACD
  11:     -	3875  0802    		db 	0x08,0x02
  11:     -	3877          		endm
  12:     -	3877          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	3877  54      		db 	pW_STORE
  12:     -	3878  88DA    		dw 	0xDA88
  12:     -	387A  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	387C          		endm
  13:     -	387C          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	387C  54      		db 	pW_STORE
  13:     -	387D  9FDA    		dw 	0xDA9F
  13:     -	387F  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	3881          		endm
  14:     -	3881          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	3881  54      		db 	pW_STORE
  14:     -	3882  B6DA    		dw 	0xDAB6
  14:     -	3884  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	3886          		endm
  15:     -	3886          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	3886  54      		db 	pW_STORE
  15:     -	3887  CDDA    		dw 	0xDACD
  15:     -	3889  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	388B          		endm
  16:     -	388B          		dwpatch 0xDCB6+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	388B  51      		db 	pW_CHK_PATCH
  16:     -	388C  C0DC    		dw 	0xDCB6+5*2
  16:     -	388E  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	3892          		endm
  17:     -	3892          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	3892  54      		db 	pW_STORE
  17:     -	3893  A6EB    		dw 	0xEBA6
  17:     -	3895  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	3897          		endm
  18:     -	3897          		dwpatch 0xDA1B+1 	,0xDC72	,_CPM1_res_seldsk
  18:     -	3897  51      		db 	pW_CHK_PATCH
  18:     -	3898  1CDA    		dw 	0xDA1B+1
  18:     -	389A  72DC11E9		dw 	0xDC72,_CPM1_res_seldsk
  18:     -	389E          		endm
  19:     -	389E          		dwstore	_CPM1_old_seld_dsk+1	,0xDC72
  19:     -	389E  54      		db 	pW_STORE
  19:     -	389F  72DC    		dw 	0xDC72
  19:     -	38A1  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	38A3          		endm
  20:     -	38A3          		dbpatch	0xE6C0	,0x77	,0x00
  20:     -	38A3  52      		db 	pB_CHK_PATCH
  20:     -	38A4  C0E6    		dw 	0xE6C0
  20:     -	38A6  7700    		db 	0x77,0x00
  20:     -	38A8          		endm
  21:     -	38A8          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFB6
  21:     -	38A8  54      		db 	pW_STORE
  21:     -	38A9  B6DF    		dw 	0xDFB6
  21:     -	38AB  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	38AD          		endm
  22:     -	38AD          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFB6
  22:     -	38AD  54      		db 	pW_STORE
  22:     -	38AE  B6DF    		dw 	0xDFB6
  22:     -	38B0  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	38B2          		endm
  23:     -	38B2          		dwpatch	0xDA27+1	,0xDCD5	,_CPM1_res_READ
  23:     -	38B2  51      		db 	pW_CHK_PATCH
  23:     -	38B3  28DA    		dw 	0xDA27+1
  23:     -	38B5  D5DC1BE9		dw 	0xDCD5,_CPM1_res_READ
  23:     -	38B9          		endm
  24:     -	38B9          		dwpatch	0xDA2A+1	,0xDE22	,_CPM1_res_WRITE
  24:     -	38B9  51      		db 	pW_CHK_PATCH
  24:     -	38BA  2BDA    		dw 	0xDA2A+1
  24:     -	38BC  22DE58E9		dw 	0xDE22,_CPM1_res_WRITE
  24:     -	38C0          		endm
  25:     -	38C0          		dwpatch	0xDB6B+1	,0xDCD5	,_CPM1_res_READ
  25:     -	38C0  51      		db 	pW_CHK_PATCH
  25:     -	38C1  6CDB    		dw 	0xDB6B+1
  25:     -	38C3  D5DC1BE9		dw 	0xDCD5,_CPM1_res_READ
  25:     -	38C7          		endm
  26:     -	38C7          		dwpatch	0xdca4+1	,0xE5F6	,_CPM1_res_GETINFO
  26:     -	38C7  51      		db 	pW_CHK_PATCH
  26:     -	38C8  A5DC    		dw 	0xdca4+1
  26:     -	38CA  F6E595E9		dw 	0xE5F6,_CPM1_res_GETINFO
  26:     -	38CE          		endm
  27:     -	38CE          		dwstore	_CPM1__old_read+1	,0xDCD5
  27:     -	38CE  54      		db 	pW_STORE
  27:     -	38CF  D5DC    		dw 	0xDCD5
  27:     -	38D1  56E9    		dw 	_CPM1__old_read+1
  27:     -	38D3          		endm
  28:     -	38D3          		dwstore	_CPM1__old_write+1	,0xDE22
  28:     -	38D3  54      		db 	pW_STORE
  28:     -	38D4  22DE    		dw 	0xDE22
  28:     -	38D6  93E9    		dw 	_CPM1__old_write+1
  28:     -	38D8          		endm
  29:     -	38D8          		dwstore	_CPM1__old_getinfo+1	,0xE5F6
  29:     -	38D8  54      		db 	pW_STORE
  29:     -	38D9  F6E5    		dw 	0xE5F6
  29:     -	38DB  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	38DD          		endm
  30:     -	38DD          		dbpatch	0xE636		,0x21	,0x21
  30:     -	38DD  52      		db 	pB_CHK_PATCH
  30:     -	38DE  36E6    		dw 	0xE636
  30:     -	38E0  2121    		db 	0x21,0x21
  30:     -	38E2          		endm
  31:     -	38E2          		dwpatch	0xE636+1 	,0xE666	,0xE666
  31:     -	38E2  51      		db 	pW_CHK_PATCH
  31:     -	38E3  37E6    		dw 	0xE636+1
  31:     -	38E5  66E666E6		dw 	0xE666,0xE666
  31:     -	38E9          		endm
  32:     -	38E9          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE636
  32:     -	38E9  54      		db 	pW_STORE
  32:     -	38EA  36E6    		dw 	0xE636
  32:     -	38EC  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	38EE          		endm
  33:     -	38EE          		dwstore	_CPM1_r_p_DSK1+1	,0xDFAC 	;read
  33:     -	38EE  54      		db 	pW_STORE
  33:     -	38EF  ACDF    		dw 	0xDFAC
  33:     -	38F1  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	38F3          		endm
  34:     -	38F3          		dwstore	_CPM1_r_p_TRK1+1	,0xDFB0 	
  34:     -	38F3  54      		db 	pW_STORE
  34:     -	38F4  B0DF    		dw 	0xDFB0
  34:     -	38F6  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	38F8          		endm
  35:     -	38F8          		dwstore	_CPM1_r_p_SEC1+1	,0xDFB1 	
  35:     -	38F8  54      		db 	pW_STORE
  35:     -	38F9  B1DF    		dw 	0xDFB1
  35:     -	38FB  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	38FD          		endm
  36:     -	38FD          		dwstore	_CPM1_r_p_DMA1+1	,0xDFB2 	
  36:     -	38FD  54      		db 	pW_STORE
  36:     -	38FE  B2DF    		dw 	0xDFB2
  36:     -	3900  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	3902          		endm
  37:     -	3902          		dwstore	_CPM1_r_p_DSK2+1	,0xDFAC 	;write
  37:     -	3902  54      		db 	pW_STORE
  37:     -	3903  ACDF    		dw 	0xDFAC
  37:     -	3905  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	3907          		endm
  38:     -	3907          		dwstore	_CPM1_r_p_TRK2+1	,0xDFB0 	
  38:     -	3907  54      		db 	pW_STORE
  38:     -	3908  B0DF    		dw 	0xDFB0
  38:     -	390A  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	390C          		endm
  39:     -	390C          		dwstore	_CPM1_r_p_SEC2+1	,0xDFB1 	
  39:     -	390C  54      		db 	pW_STORE
  39:     -	390D  B1DF    		dw 	0xDFB1
  39:     -	390F  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	3911          		endm
  40:     -	3911          		dwstore	_CPM1_r_p_DMA2+1	,0xDFB2 	
  40:     -	3911  54      		db 	pW_STORE
  40:     -	3912  B2DF    		dw 	0xDFB2
  40:     -	3914  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	3916          		endm
  41:     -	3916          		dwstore	_CPM1_r_p_DSK3+1	,0xDFAC 	;readinfo
  41:     -	3916  54      		db 	pW_STORE
  41:     -	3917  ACDF    		dw 	0xDFAC
  41:     -	3919  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	391B          		endm
  42:				
  43:     -	391B          		stop 'CPM_12_90_5_kontur'
  43:     -	391B  50      		db 	p_STOP
  43:     -	391C  43504D5F		db 	'CPM_12_90_5_kontur'
	      31325F39
	      305F355F
	      6B6F6E74
	      7572
  43:     -	392E  00      		db 	0
  43:     -	392F          		endm
**** out/include-patcher.asm ****
  43:					include "generator/V0/out/patcher-microdos-MICRODOS_OPTS2_900105.asm"	;  4 images in collection
**** generator/V0/out/patcher-microdos-MICRODOS_OPTS2_900105.asm ****
   1:     -	392F          	_BIOS_MICRODOS_OPTS2_900105:
   2:					
   3:     -	392F          		setMICRODOS
   3:     -	392F  56      		db 	pSETFLAG_MICRODOS
   3:     -	3930          		endm
   4:     -	3930          		RQ_OPTS_ANY
   4:     -	3930          		endm
   5:				
   6:					;BIOS_LOAD_ADDR-------------------------------------------------------------------
   7:					;BIOS_START_ADDR
   8:					;правилнее проверять прямо в 8000 ????
   9:					;копия бутсектора из 8000, 
  10:					;
  11:					;адресс загрузки, куда биос загружает сектора с диска
  12:					;	dwpatch	0xBD80,	0xBD80, 0xBD80
  13:					;адресс старта, куда биос передаёт управление
  14:					;	dwpatch	0xBD82,	0xBE00,	0xBE00
  15:				
  16:					
  17:					;BDOS_ENTRY_POINT---------------------------------------------------------
  18:					;BDOS_ENTRY_POINT2
  19:					;значение перехода, проверяим их для надёжности
  20:					;0005 jp c000
  21:					;RAM:C000          _BDOS:                                  
  22:					;RAM:C000                                                  
  23:					;RAM:C000 C3 87 C4                 jp      loc_C487
  24:					;RAM:C003 C3 C0 DB                 jp      loc_DBC0
  25:					; 	dwpatch	0xc000+1,0xC487,0xC487
  26:					; 	dwpatch	0xc003+1,0xDBC0,0xDBC0
  27:				
  28:					;BIOS_LOGO_ADDR--------------------------------------------------------------
  29:					;косметика,  
  30:					;Биос при старте очищает экран, мы патчим его чтобы он это не делал
  31:					;иначе он затрёт все сообщения патчера, а там много полезной информации
  32:					;выгядит это в коде так
  33:					;это значение там только во время старта, дальше там буфер .....
  34:				
  35:					; RAM:F04E 1B 45 EB+BOOT_LOGO:      text "koi8-r", '\\x1BКОРВЕТ ПК8020\\r\\n'
  36:					; RAM:F04E E5 F4 20+                text "koi8-r", 'НИИСЧЁТМАШ 01.05.90\\r\\n'
  37:					; RAM:F04E F0 EB 38+                text "koi8-r", '$'
  38:     -	3930          		dbpatchmaybe	0xF04E	,0x1B	,0x0d
  38:     -	3930  59      		db 	pB_MAYBE_PATCH
  38:     -	3931  4EF0    		dw 	0xF04E
  38:     -	3933  1B0D    		db 	0x1B,0x0d
  38:     -	3935          		endm
  39:     -	3935          		dbpatchmaybe	0xF04E+1	,0x45	,0x0d
  39:     -	3935  59      		db 	pB_MAYBE_PATCH
  39:     -	3936  4FF0    		dw 	0xF04E+1
  39:     -	3938  450D    		db 	0x45,0x0d
  39:     -	393A          		endm
  40:				
  41:					;JP_READ-----------------------------------------------------------------------
  42:					;JP_WRITE
  43:					; перехватываем обращение к чтению/записи в биос
  44:					; подменяем адресса для чтения/записи
  45:					; собственно во всех это куче кода нас интересует адресса EAFF и EB04
  46:					
  47:					; точки входа обычного биоса
  48:					; RAM:C027 C3 7B DD                 jp      do_READ
  49:					; RAM:C02A C3 78 DD                 jp      do_WRITE
  50:					;.....
  51:					; RAM:DD78          do_WRITE:                               
  52:					; RAM:DD78 3E 06                    ld      a, 6
  53:					; RAM:DD7A 21                       db 21h
  54:					; RAM:DD7B          do_READ:                                
  55:					; RAM:DD7B                                                  
  56:					; RAM:DD7B 3E 04                    ld      a, 4
  57:					; RAM:DD7D 32 1D DF                 ld      (dsk_description.Fucntion), a
  58:					; RAM:DD80 21 1B DF                 ld      hl, dsk_description
  59:					; RAM:DD83 C3 12 E4                 jp      RW_DISK
  60:					; ...
  61:					; RAM:E412          RW_DISK:                                
  62:					; RAM:E412                                                  
  63:					; RAM:E412 C3 A5 EA                 jp      j_DSKIO
  64:				
  65:					; RAM:EAA5          j_DSKIO:                                
  66:					; RAM:EAA5 3A 03 F7                 ld      a, (SysCOPY)
  67:					; RAM:EAA8 F5                       push    af
  68:					; RAM:EAA9 EB                       ex      de, hl
  69:					; RAM:EAAA 06 5C                    ld      b, 5Ch ; '\'
  70:					; RAM:EAAC CD 9F E4                 call    setSYSREG
  71:					; RAM:EAAF EB                       ex      de, hl
  72:					; RAM:EAB0 CD BF EA                 call    do_DSKIO
  73:					; RAM:EAB3 47                       ld      b, a
  74:					; RAM:EAB4 F1                       pop     af
  75:					; RAM:EAB5 F3                       di
  76:					; RAM:EAB6 32 7F FF                 ld      (_5C_SysReg1C), a
  77:					; RAM:EAB9 32 03 F7                 ld      (SysCOPY), a
  78:					; RAM:EABC FB                       ei
  79:					; RAM:EABD 78                       ld      a, b
  80:					; RAM:EABE C9                       ret
  81:					; ....
  82:					; RAM:EABF          do_DSKIO:                               
  83:					; RAM:EABF 79                       ld      a, c
  84:					; RAM:EAC0 32 F7 EE                 ld      (DSK_IO_WriteType), a ; 0       (normal sector write)
  85:					; RAM:EAC0                                                  ; 1       (write to directory sector)
  86:					; RAM:EAC0                                                  ; 2       (write to the first sector of a new data block)
  87:					; RAM:EAC3 22 F8 EE                 ld      (DSC_IO_HL), hl ; DSCDESCR
  88:					; RAM:EAC6          ;
  89:					; RAM:EAC6 3A F6 EE                 ld      a, (E_DRIVE_FLAG)
  90:					; RAM:EAC9 A6                       and     (hl)            ; DRIVE?
  91:					; RAM:EACA FE 04                    cp      4
  92:					; RAM:EACC CA 80 FC                 jp      z, E_DRIVE
  93:					; RAM:EACF          ;
  94:					; RAM:EACF 7E                       ld      a, (hl)
  95:					; RAM:EAD0 FE 02                    cp      2
  96:					; RAM:EAD2 D2 07 EB                 jp      nc, invalidDrive
  97:					; RAM:EAD5          ;
  98:					; ....
  99:					; RAM:EAFA 22 FA EE                 ld      (_DMA??), hl
 100:					; RAM:EAFD FE 04                    cp      4
 101:					; RAM:EAFF CA 36 EB                 jp      z, jREAD
 102:					; RAM:EB02 FE 06                    cp      6
 103:					; RAM:EB04 CA A0 EB                 jp      z, jWRITE
 104:					; RAM:EB07
 105:					; RAM:EB07          invalidDrive:                           
 106:					; RAM:EB07                                                  
 107:					; RAM:EB07 3E FF                    ld      a, 0FFh
 108:					; RAM:EB09 C9                       ret
 109:				
 110:					; а так как пока в резиденте нет поддержки работы с реальными дисками то 
 111:					; адресса оригинальных пока не сохраняем к себе ....
 112:					; TODO: microdos real disk support
 113:				
 114:     -	393A          		dwpatch	0xEAFF+1	,0xEB36	,MD_READ			
 114:     -	393A  51      		db 	pW_CHK_PATCH
 114:     -	393B  00EB    		dw 	0xEAFF+1
 114:     -	393D  36EB3EFA		dw 	0xEB36,MD_READ
 114:     -	3941          		endm
 115:     -	3941          		dwpatch	0xEB04+1	,0xEBA0	,MD_WRITE
 115:     -	3941  51      		db 	pW_CHK_PATCH
 115:     -	3942  05EB    		dw 	0xEB04+1
 115:     -	3944  A0EB53FA		dw 	0xEBA0,MD_WRITE
 115:     -	3948          		endm
 116:				
 117:					;GET_INFO_FDC_SEEK -------------------------------------------------------------
 118:					;GET_INFO_CALL_READ
 119:					;кусок GET_INFO_C, подменяем чтение инфосектора
 120:					; RAM:EC56          GET_INFO_C:                             ; CODE XREF: jGetDPH_Addr+29p
 121:					; RAM:EC56 79                       ld      a, c            ; drive
 122:					; RAM:EC57 B7                       or      a
 123:					; RAM:EC58 3A 93 E6                 ld      a, (dsk_info_a.intiFlag)
 124:					; RAM:EC5B CA 61 EC                 jp      z, loc_EC61
 125:					; RAM:EC61
 126:					;....
 127:					; RAM:EC86 2B                       dec     hl
 128:					; RAM:EC87 CD 14 EE                 call    SEL_DSK_SEEK0
 129:					; RAM:EC8A CD 1E EE                 call    ReadToRDBUF
 130:					; RAM:EC8D          ;
 131:					; RAM:EC8D 3E 04                    ld      a, 4
 132:					; RAM:EC8F 32 FF EE                 ld      (DSK_TRY_Count), a
 133:				
 134:					; для начала удаляем комманду которая готовит чтение с физичесского дисковода
 135:     -	3948          		dbpatch	0xEC87	,0xcd	,0x00
 135:     -	3948  52      		db 	pB_CHK_PATCH
 135:     -	3949  87EC    		dw 	0xEC87
 135:     -	394B  CD00    		db 	0xcd,0x00
 135:     -	394D          		endm
 136:     -	394D          		dwpatch	0xEC87+1	,0xEE14	,0x0000
 136:     -	394D  51      		db 	pW_CHK_PATCH
 136:     -	394E  88EC    		dw 	0xEC87+1
 136:     -	3950  14EE0000		dw 	0xEE14,0x0000
 136:     -	3954          		endm
 137:				
 138:					;GET_INFO_CALL_READ------------------------------------------------------
 139:					;подменяем чтение сектора с диска на нашу функцию
 140:     -	3954          		dwpatch	0xEC8A+1	,0xEE1E	,MD_READ_INFOSECTOR
 140:     -	3954  51      		db 	pW_CHK_PATCH
 140:     -	3955  8BEC    		dw 	0xEC8A+1
 140:     -	3957  1EEE68FA		dw 	0xEE1E,MD_READ_INFOSECTOR
 140:     -	395B          		endm
 141:				
 142:					;DISKINFO_DRIVE--------------------------------------------------------------------------------
 143:					;эти два адресса нужны для DISKINFO
 144:					;rdBufDiskInfo - это очередной блок параметров, по нужному адрессу там текущий диск для операции DISKINFO
 145:					; в примере ниже чтение нашего байта по адрессу 0xED82
 146:					; а собственно адресс по адрессу 0xEB7E (значение 0xEF06)
 147:					; RAM:EB36          jREAD:                                  
 148:					; RAM:EB36 2A F8 EE                 ld      hl, (DSC_IO_HL) 
 149:					; ...
 150:					; RAM:EB7E          ;
 151:					; RAM:EB7E 21 06 EF                 ld      hl, rdBufDiskInfo
 152:					; RAM:EB81 CD 7D ED                 call    FDD_Setup
 153:					; ...
 154:					; RAM:ED7D          FDD_Setup:                              
 155:					; RAM:ED7D                                                  
 156:					; RAM:ED7D 3E D0                    ld      a, FDC_3_FORCE_STOP
 157:					; RAM:ED7F 32 18 FE                 ld      (_5C_FDC_Cmd), a
 158:					; RAM:ED82          ;
 159:					; RAM:ED82 7E                       ld      a, (hl)         ; drive
 160:					; RAM:ED83 B7                       or      a
 161:					; RAM:ED84 06 01                    ld      b, 1
 162:					; RAM:ED86 CA 8B ED                 jp      z, loc_ED8B
 163:				
 164:     -	395B          		dwstore	MD_DRV2+1,	0xEF06
 164:     -	395B  54      		db 	pW_STORE
 164:     -	395C  06EF    		dw 	0xEF06
 164:     -	395E  F3FA    		dw 	MD_DRV2+1
 164:     -	3960          		endm
 165:				
 166:					;DISKINFO_READ_BUFFER--------------------------------------------------------------------------
 167:					;BUF_RD_1k
 168:					;адресс буфера кудв мы читаем 0й сектор а дальше уже старый код в биосе
 169:					;делает всё остальное
 170:					; тут он присутсвует по адрессу 0xEC97 (значение 0xF04E)
 171:					; собственно это подсчёт Контрольной суммы
 172:					; RAM:EC56          GET_INFO_C:                             
 173:					; RAM:EC56 79                       ld      a, c            
 174:					; RAM:EC57 B7                       or      a
 175:					; RAM:EC58 3A 93 E6                 ld      a, (dsk_info_a.intiFlag)
 176:					; RAM:EC5B CA 61 EC                 jp      z, loc_EC61
 177:					; RAM:EC5E 3A 97 E6                 ld      a, (dsk_info_b.intiFlag)
 178:					; RAM:EC61
 179:					; RAM:EC61          loc_EC61:                               
 180:					; RAM:EC61 B7                       or      a
 181:					; RAM:EC62 C2 EC EC                 jp      nz, diskAlreadyInit
 182:					; RAM:EC65          ;
 183:					; ...
 184:					; RAM:EC97          ;
 185:					; RAM:EC97 21 4E F0                 ld      hl, BUF_RD_1k
 186:					; RAM:EC9A 0E 1F                    ld      c, 1Fh
 187:					; RAM:EC9C 3E 66                    ld      a, 66h ; 'f'
 188:					; RAM:EC9E
 189:					; RAM:EC9E          CalcCRC_Loop:                           
 190:					; RAM:EC9E 86                       add     a, (hl)
 191:					; RAM:EC9F 23                       inc     hl
 192:					; RAM:ECA0 0D                       dec     c
 193:					; RAM:ECA1 C2 9E EC                 jp      nz, CalcCRC_Loop
 194:					; RAM:ECA4 BE                       cp      (hl)
 195:					; RAM:ECA5          ;
 196:					; RAM:ECA5 3E 02                    ld      a, 2            ; CRC Error
 197:					; RAM:ECA7 C0                       ret     nz
 198:				
 199:     -	3960          		dwstore	MD_RDBUF2+1,	0xF04E
 199:     -	3960  54      		db 	pW_STORE
 199:     -	3961  4EF0    		dw 	0xF04E
 199:     -	3963  02FB    		dw 	MD_RDBUF2+1
 199:     -	3965          		endm
 200:					
 201:					;DISK_IO_PARAM_BLOCK_ADDR------------------------------------------------------------------------
 202:					;адресс таблички с параметрами дисководой операции
 203:					;dsk,trk,sec,dma берутся тут
 204:					;DSC_IO_HL
 205:     -	3965          		dwstore	MD_PARAM2+1,	0xEEF8
 205:     -	3965  54      		db 	pW_STORE
 205:     -	3966  F8EE    		dw 	0xEEF8
 205:     -	3968  1DFA    		dw 	MD_PARAM2+1
 205:     -	396A          		endm
 206:				
 207:					;DISABLE_DISK_CHECK------------------------------------------------------------------------------
 208:					;убираем проверку в биосе на наличие дисководов
 209:					; RAM:BE00          _BOOT:                                  
 210:					; RAM:BE00                                                  
 211:					; RAM:BE00 F3                       di
 212:					; RAM:BE01 31 00 BE                 ld      sp, 0BE00h
 213:					; RAM:BE04 3A 01 F7                 ld      a, (FDDFLAG)
 214:					; RAM:BE07 E6 02                    and     2
 215:					; RAM:BE09 C2 40 00                 jp      nz, R_RunBasic??	
 216:					;dbpatch 0xbe07+1	,0x02	,0x00
 217:					
 218:					;FLUSH_WRITE_ADDR-------------------------------------------------------------------------------
 219:					; FLUSH нам не нужен, т.к. наша запись идёт без буферезации.
 220:					; TODO: JP invalidateWRBUF ???
 221:					; RAM:EC3A          Flush?:                                 
 222:					; RAM:EC3A                                                  
 223:					; RAM:EC3A 21 FD EE                 ld      hl, flagWriteReuired?
 224:					; RAM:EC3D 7E                       ld      a, (hl)
 225:					; RAM:EC3E B7                       or      a
 226:					; RAM:EC3F C8                       ret     z
 227:					; RAM:EC40          ;
 228:					; RAM:EC40 36 00                    ld      (hl), 0
 229:					; RAM:EC42          ;
 230:					; RAM:EC42 21 0A EF                 ld      hl, WrBufDiskInfo
 231:					; RAM:EC45 CD 7D ED                 call    FDD_Setup
 232:					; RAM:EC48          ;
 233:					; RAM:EC48 CD 66 EE                 call    FDD_Write
 234:					; RAM:EC4B C8                       ret     z
 235:					; RAM:EC4C          invalidateWRBUF:                        
 236:					; RAM:EC4C                                                  
 237:					; RAM:EC4C 21 0A EF                 ld      hl, WrBufDiskInfo
 238:					; RAM:EC4F 36 FF                    ld      (hl), 0FFh
 239:					; RAM:EC51 C9                       ret	
 240:					;dbpatch 0xEC42		,0x21	,0xC9
 241:				
 242:					;SELDSK_ADDR------------------------------------------------------------
 243:					;и модифицируем вызов SELDSK чтобы он поддерживал дополнительную проверку
 244:					;модифицируем оригинальный перехо в SELDSK чтобы он переходил на наш код	
 245:					;и сохраняем старый адресс (в данном коде нужный нам адресс 0xDCB6)
 246:					;RAM:DA1B          _SELDSK:                         ; IN: C
 247:					;RAM:DA1B C3 B6 DC          jp      __SELDSK        ; OUT: HL-DPB/0, HL=xVTRAP0 if c=0xff
 248:				
 249:     -	396A          		dwpatch 0xc01b+1	 ,0xdd4c	,md_res_seldsk
 249:     -	396A  51      		db 	pW_CHK_PATCH
 249:     -	396B  1CC0    		dw 	0xc01b+1
 249:     -	396D  4CDD0EFA		dw 	0xdd4c,md_res_seldsk
 249:     -	3971          		endm
 250:     -	3971          		dwstore md_old_seld_dsk+1,0xdd4c	,0xdd4c
 250:     -	3971  54      		db 	pW_STORE
 250:     -	3972  4CDD    		dw 	0xdd4c
 250:     -	3974  12FA    		dw 	md_old_seld_dsk+1
 250:     -	3976          		endm
 251:				
 252:					;custom checkers
 253:     -	3976          		dwpatch	0xBD80	,0xBD80 ,0xBD80
 253:     -	3976  51      		db 	pW_CHK_PATCH
 253:     -	3977  80BD    		dw 	0xBD80
 253:     -	3979  80BD80BD		dw 	0xBD80,0xBD80
 253:     -	397D          		endm
 254:     -	397D          		dwpatch	0xBD82	,0xBE00 ,0xBE00
 254:     -	397D  51      		db 	pW_CHK_PATCH
 254:     -	397E  82BD    		dw 	0xBD82
 254:     -	3980  00BE00BE		dw 	0xBE00,0xBE00
 254:     -	3984          		endm
 255:     -	3984          		dwpatch	0xc000+1	,0xC487 ,0xC487
 255:     -	3984  51      		db 	pW_CHK_PATCH
 255:     -	3985  01C0    		dw 	0xc000+1
 255:     -	3987  87C487C4		dw 	0xC487,0xC487
 255:     -	398B          		endm
 256:     -	398B          		dwpatch	0xc003+1	,0xDBC0 ,0xDBC0
 256:     -	398B  51      		db 	pW_CHK_PATCH
 256:     -	398C  04C0    		dw 	0xc003+1
 256:     -	398E  C0DBC0DB		dw 	0xDBC0,0xDBC0
 256:     -	3992          		endm
 257:     -	3992          		dbpatch	0xbe07+1	,0x02 ,0x02
 257:     -	3992  52      		db 	pB_CHK_PATCH
 257:     -	3993  08BE    		dw 	0xbe07+1
 257:     -	3995  0202    		db 	0x02,0x02
 257:     -	3997          		endm
 258:     -	3997          		dbpatch	0xEC42	,0x21 ,0x21
 258:     -	3997  52      		db 	pB_CHK_PATCH
 258:     -	3998  42EC    		dw 	0xEC42
 258:     -	399A  2121    		db 	0x21,0x21
 258:     -	399C          		endm
 259:				
 260:					;STOP-------------------------------------------------------------------------------
 261:     -	399C          		stop 'MICRODOS_OPTS2_900105'
 261:     -	399C  50      		db 	p_STOP
 261:     -	399D  4D494352		db 	'MICRODOS_OPTS2_900105'
	      4F444F53
	      5F4F5054
	      53325F39
	      30303130
	      35
 261:     -	39B2  00      		db 	0
 261:     -	39B3          		endm
 262:					;'MICRODOS_2_900105'
**** out/include-patcher.asm ****
  44:					include "generator/V0/out/patcher-cpm2-CPM_12_87_11_niijaf.asm"	;  3 images in collection
**** generator/V0/out/patcher-cpm2-CPM_12_87_11_niijaf.asm ****
   1:     -	39B3          	_BIOS_CPM_12_87_11_niijaf:
   2:     -	39B3          		setSUBBIOS 2
   2:     -	39B3  5A      		db	pSubBios
   2:     -	39B4  02      		db 	2
   2:     -	39B5          		endm
   3:     -	39B5          		RQ_OPTS_ANY
   3:     -	39B5          		endm
   4:     -	39B5          		setCPM
   4:     -	39B5          		endm
   5:     -	39B5          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	39B5  59      		db 	pB_MAYBE_PATCH
   5:     -	39B6  EEDA    		dw 	0xDAEE
   5:     -	39B8  1F0D    		db 	0x1F,0x0d
   5:     -	39BA          		endm
   6:     -	39BA          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	39BA  59      		db 	pB_MAYBE_PATCH
   6:     -	39BB  F0DA    		dw 	0xDAEE+2
   6:     -	39BD  0A0D    		db 	0x0a,0x0d
   6:     -	39BF          		endm
   7:     -	39BF          		dbpatch	0xE30E+1	,0x49	,0xc9
   7:     -	39BF  52      		db 	pB_CHK_PATCH
   7:     -	39C0  0FE3    		dw 	0xE30E+1
   7:     -	39C2  49C9    		db 	0x49,0xc9
   7:     -	39C4          		endm
   8:     -	39C4          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	39C4  52      		db 	pB_CHK_PATCH
   8:     -	39C5  88DA    		dw 	0xDA88
   8:     -	39C7  0100    		db 	0x01,0x00
   8:     -	39C9          		endm
   9:     -	39C9          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	39C9  52      		db 	pB_CHK_PATCH
   9:     -	39CA  9FDA    		dw 	0xDA9F
   9:     -	39CC  0200    		db 	0x02,0x00
   9:     -	39CE          		endm
  10:     -	39CE          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	39CE  52      		db 	pB_CHK_PATCH
  10:     -	39CF  B6DA    		dw 	0xDAB6
  10:     -	39D1  0401    		db 	0x04,0x01
  10:     -	39D3          		endm
  11:     -	39D3          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	39D3  52      		db 	pB_CHK_PATCH
  11:     -	39D4  CDDA    		dw 	0xDACD
  11:     -	39D6  0802    		db 	0x08,0x02
  11:     -	39D8          		endm
  12:     -	39D8          		dwstore	_CPM2_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	39D8  54      		db 	pW_STORE
  12:     -	39D9  88DA    		dw 	0xDA88
  12:     -	39DB  06EA    		dw 	_CPM2_res_DRIVE_TAB+0*2
  12:     -	39DD          		endm
  13:     -	39DD          		dwstore	_CPM2_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	39DD  54      		db 	pW_STORE
  13:     -	39DE  9FDA    		dw 	0xDA9F
  13:     -	39E0  08EA    		dw 	_CPM2_res_DRIVE_TAB+1*2
  13:     -	39E2          		endm
  14:     -	39E2          		dwstore	_CPM2_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	39E2  54      		db 	pW_STORE
  14:     -	39E3  B6DA    		dw 	0xDAB6
  14:     -	39E5  0AEA    		dw 	_CPM2_res_DRIVE_TAB+2*2
  14:     -	39E7          		endm
  15:     -	39E7          		dwstore	_CPM2_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	39E7  54      		db 	pW_STORE
  15:     -	39E8  CDDA    		dw 	0xDACD
  15:     -	39EA  0CEA    		dw 	_CPM2_res_DRIVE_TAB+3*2
  15:     -	39EC          		endm
  16:     -	39EC          		dwpatch 0xDCF6+5*2 	,0x0000 ,_CPM2_dph_F
  16:     -	39EC  51      		db 	pW_CHK_PATCH
  16:     -	39ED  00DD    		dw 	0xDCF6+5*2
  16:     -	39EF  000012EA		dw 	0x0000,_CPM2_dph_F
  16:     -	39F3          		endm
  17:     -	39F3          		dwstore _CPM2_dph_F+8	,0xDFDB
  17:     -	39F3  54      		db 	pW_STORE
  17:     -	39F4  DBDF    		dw 	0xDFDB
  17:     -	39F6  1AEA    		dw 	_CPM2_dph_F+8
  17:     -	39F8          		endm
  18:     -	39F8          		dwpatch 0xDA1B+1 	,0xDCB2	,_CPM2_res_seldsk
  18:     -	39F8  51      		db 	pW_CHK_PATCH
  18:     -	39F9  1CDA    		dw 	0xDA1B+1
  18:     -	39FB  B2DC6BEA		dw 	0xDCB2,_CPM2_res_seldsk
  18:     -	39FF          		endm
  19:     -	39FF          		dwstore	_CPM2_old_seld_dsk+1	,0xDCB2
  19:     -	39FF  54      		db 	pW_STORE
  19:     -	3A00  B2DC    		dw 	0xDCB2
  19:     -	3A02  6FEA    		dw 	_CPM2_old_seld_dsk+1
  19:     -	3A04          		endm
  20:     -	3A04          		dbpatch	0xE789	,0x77	,0x00
  20:     -	3A04  52      		db 	pB_CHK_PATCH
  20:     -	3A05  89E7    		dw 	0xE789
  20:     -	3A07  7700    		db 	0x77,0x00
  20:     -	3A09          		endm
  21:     -	3A09          		dwstore	_CPM2_r_p_SELDSKDRIVER+1	,0xDFC9
  21:     -	3A09  54      		db 	pW_STORE
  21:     -	3A0A  C9DF    		dw 	0xDFC9
  21:     -	3A0C  88EA    		dw 	_CPM2_r_p_SELDSKDRIVER+1
  21:     -	3A0E          		endm
  22:     -	3A0E          		dwstore	_CPM2_r_p_SELDSKDRIVEW+1	,0xDFC9
  22:     -	3A0E  54      		db 	pW_STORE
  22:     -	3A0F  C9DF    		dw 	0xDFC9
  22:     -	3A11  C5EA    		dw 	_CPM2_r_p_SELDSKDRIVEW+1
  22:     -	3A13          		endm
  23:     -	3A13          		dwpatch	0xDA27+1	,0xDD15	,_CPM2_res_READ
  23:     -	3A13  51      		db 	pW_CHK_PATCH
  23:     -	3A14  28DA    		dw 	0xDA27+1
  23:     -	3A16  15DD75EA		dw 	0xDD15,_CPM2_res_READ
  23:     -	3A1A          		endm
  24:     -	3A1A          		dwpatch	0xDA2A+1	,0xDE4B	,_CPM2_res_WRITE
  24:     -	3A1A  51      		db 	pW_CHK_PATCH
  24:     -	3A1B  2BDA    		dw 	0xDA2A+1
  24:     -	3A1D  4BDEB2EA		dw 	0xDE4B,_CPM2_res_WRITE
  24:     -	3A21          		endm
  25:     -	3A21          		dwpatch	0xDB70+1	,0xDD15	,_CPM2_res_READ
  25:     -	3A21  51      		db 	pW_CHK_PATCH
  25:     -	3A22  71DB    		dw 	0xDB70+1
  25:     -	3A24  15DD75EA		dw 	0xDD15,_CPM2_res_READ
  25:     -	3A28          		endm
  26:     -	3A28          		dwpatch	0xDCE4+1	,0xE6BF	,_CPM2_res_GETINFO
  26:     -	3A28  51      		db 	pW_CHK_PATCH
  26:     -	3A29  E5DC    		dw 	0xDCE4+1
  26:     -	3A2B  BFE6EFEA		dw 	0xE6BF,_CPM2_res_GETINFO
  26:     -	3A2F          		endm
  27:     -	3A2F          		dwstore	_CPM2__old_read+1	,0xDD15
  27:     -	3A2F  54      		db 	pW_STORE
  27:     -	3A30  15DD    		dw 	0xDD15
  27:     -	3A32  B0EA    		dw 	_CPM2__old_read+1
  27:     -	3A34          		endm
  28:     -	3A34          		dwstore	_CPM2__old_write+1	,0xDE4B
  28:     -	3A34  54      		db 	pW_STORE
  28:     -	3A35  4BDE    		dw 	0xDE4B
  28:     -	3A37  EDEA    		dw 	_CPM2__old_write+1
  28:     -	3A39          		endm
  29:     -	3A39          		dwstore	_CPM2__old_getinfo+1	,0xE6BF
  29:     -	3A39  54      		db 	pW_STORE
  29:     -	3A3A  BFE6    		dw 	0xE6BF
  29:     -	3A3C  FDEA    		dw 	_CPM2__old_getinfo+1
  29:     -	3A3E          		endm
  30:     -	3A3E          		dbpatch	0xE6FF		,0x21	,0x21
  30:     -	3A3E  52      		db 	pB_CHK_PATCH
  30:     -	3A3F  FFE6    		dw 	0xE6FF
  30:     -	3A41  2121    		db 	0x21,0x21
  30:     -	3A43          		endm
  31:     -	3A43          		dwpatch	0xE6FF+1 	,0xe72F	,0xe72F
  31:     -	3A43  51      		db 	pW_CHK_PATCH
  31:     -	3A44  00E7    		dw 	0xE6FF+1
  31:     -	3A46  2FE72FE7		dw 	0xe72F,0xe72F
  31:     -	3A4A          		endm
  32:     -	3A4A          		dwstore	_CPM2__old_getinfo_chkdo+1	,0xE6FF
  32:     -	3A4A  54      		db 	pW_STORE
  32:     -	3A4B  FFE6    		dw 	0xE6FF
  32:     -	3A4D  FAEA    		dw 	_CPM2__old_getinfo_chkdo+1
  32:     -	3A4F          		endm
  33:     -	3A4F          		dwstore	_CPM2_r_p_DSK1+1	,0xDFBF 	;read
  33:     -	3A4F  54      		db 	pW_STORE
  33:     -	3A50  BFDF    		dw 	0xDFBF
  33:     -	3A52  76EA    		dw 	_CPM2_r_p_DSK1+1
  33:     -	3A54          		endm
  34:     -	3A54          		dwstore	_CPM2_r_p_TRK1+1	,0xDFC3 	
  34:     -	3A54  54      		db 	pW_STORE
  34:     -	3A55  C3DF    		dw 	0xDFC3
  34:     -	3A57  91EA    		dw 	_CPM2_r_p_TRK1+1
  34:     -	3A59          		endm
  35:     -	3A59          		dwstore	_CPM2_r_p_SEC1+1	,0xDFC4 	
  35:     -	3A59  54      		db 	pW_STORE
  35:     -	3A5A  C4DF    		dw 	0xDFC4
  35:     -	3A5C  97EA    		dw 	_CPM2_r_p_SEC1+1
  35:     -	3A5E          		endm
  36:     -	3A5E          		dwstore	_CPM2_r_p_DMA1+1	,0xDFC5 	
  36:     -	3A5E  54      		db 	pW_STORE
  36:     -	3A5F  C5DF    		dw 	0xDFC5
  36:     -	3A61  A8EA    		dw 	_CPM2_r_p_DMA1+1
  36:     -	3A63          		endm
  37:     -	3A63          		dwstore	_CPM2_r_p_DSK2+1	,0xDFBF 	;write
  37:     -	3A63  54      		db 	pW_STORE
  37:     -	3A64  BFDF    		dw 	0xDFBF
  37:     -	3A66  B3EA    		dw 	_CPM2_r_p_DSK2+1
  37:     -	3A68          		endm
  38:     -	3A68          		dwstore	_CPM2_r_p_TRK2+1	,0xDFC3 	
  38:     -	3A68  54      		db 	pW_STORE
  38:     -	3A69  C3DF    		dw 	0xDFC3
  38:     -	3A6B  CEEA    		dw 	_CPM2_r_p_TRK2+1
  38:     -	3A6D          		endm
  39:     -	3A6D          		dwstore	_CPM2_r_p_SEC2+1	,0xDFC4 	
  39:     -	3A6D  54      		db 	pW_STORE
  39:     -	3A6E  C4DF    		dw 	0xDFC4
  39:     -	3A70  D4EA    		dw 	_CPM2_r_p_SEC2+1
  39:     -	3A72          		endm
  40:     -	3A72          		dwstore	_CPM2_r_p_DMA2+1	,0xDFC5 	
  40:     -	3A72  54      		db 	pW_STORE
  40:     -	3A73  C5DF    		dw 	0xDFC5
  40:     -	3A75  E5EA    		dw 	_CPM2_r_p_DMA2+1
  40:     -	3A77          		endm
  41:     -	3A77          		dwstore	_CPM2_r_p_DSK3+1	,0xDFBF 	;readinfo
  41:     -	3A77  54      		db 	pW_STORE
  41:     -	3A78  BFDF    		dw 	0xDFBF
  41:     -	3A7A  82EB    		dw 	_CPM2_r_p_DSK3+1
  41:     -	3A7C          		endm
  42:				
  43:     -	3A7C          		stop 'CPM_12_87_11_niijaf'
  43:     -	3A7C  50      		db 	p_STOP
  43:     -	3A7D  43504D5F		db 	'CPM_12_87_11_niijaf'
	      31325F38
	      375F3131
	      5F6E6969
	      6A6166
  43:     -	3A90  00      		db 	0
  43:     -	3A91          		endm
**** out/include-patcher.asm ****
  45:					include "generator/V0/out/patcher-cpm1-CPM_21m_____Shkanov.asm"	;  2 images in collection
**** generator/V0/out/patcher-cpm1-CPM_21m_____Shkanov.asm ****
   1:     -	3A91          	_BIOS_CPM_21m_____Shkanov:
   2:     -	3A91          		setSUBBIOS 1
   2:     -	3A91  5A      		db	pSubBios
   2:     -	3A92  01      		db 	1
   2:     -	3A93          		endm
   3:     -	3A93          		RQ_OPTS_ANY
   3:     -	3A93          		endm
   4:     -	3A93          		setCPM
   4:     -	3A93          		endm
   5:     -	3A93          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	3A93  59      		db 	pB_MAYBE_PATCH
   5:     -	3A94  EEDA    		dw 	0xDAEE
   5:     -	3A96  1F0D    		db 	0x1F,0x0d
   5:     -	3A98          		endm
   6:     -	3A98          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	3A98  59      		db 	pB_MAYBE_PATCH
   6:     -	3A99  F0DA    		dw 	0xDAEE+2
   6:     -	3A9B  0A0D    		db 	0x0a,0x0d
   6:     -	3A9D          		endm
   7:     -	3A9D          		dbpatch	0xE135+1	,0x49	,0xc9
   7:     -	3A9D  52      		db 	pB_CHK_PATCH
   7:     -	3A9E  36E1    		dw 	0xE135+1
   7:     -	3AA0  49C9    		db 	0x49,0xc9
   7:     -	3AA2          		endm
   8:     -	3AA2          		dbpatch	0xDA89 	,0x01	,0x00
   8:     -	3AA2  52      		db 	pB_CHK_PATCH
   8:     -	3AA3  89DA    		dw 	0xDA89
   8:     -	3AA5  0100    		db 	0x01,0x00
   8:     -	3AA7          		endm
   9:     -	3AA7          		dbpatch	0xDAA0 	,0x02	,0x00
   9:     -	3AA7  52      		db 	pB_CHK_PATCH
   9:     -	3AA8  A0DA    		dw 	0xDAA0
   9:     -	3AAA  0200    		db 	0x02,0x00
   9:     -	3AAC          		endm
  10:     -	3AAC          		dbpatch	0xDAB7 	,0x04	,0x01
  10:     -	3AAC  52      		db 	pB_CHK_PATCH
  10:     -	3AAD  B7DA    		dw 	0xDAB7
  10:     -	3AAF  0401    		db 	0x04,0x01
  10:     -	3AB1          		endm
  11:     -	3AB1          		dbpatch	0xDACE 	,0x08	,0x02
  11:     -	3AB1  52      		db 	pB_CHK_PATCH
  11:     -	3AB2  CEDA    		dw 	0xDACE
  11:     -	3AB4  0802    		db 	0x08,0x02
  11:     -	3AB6          		endm
  12:     -	3AB6          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
  12:     -	3AB6  54      		db 	pW_STORE
  12:     -	3AB7  89DA    		dw 	0xDA89
  12:     -	3AB9  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	3ABB          		endm
  13:     -	3ABB          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
  13:     -	3ABB  54      		db 	pW_STORE
  13:     -	3ABC  A0DA    		dw 	0xDAA0
  13:     -	3ABE  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	3AC0          		endm
  14:     -	3AC0          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
  14:     -	3AC0  54      		db 	pW_STORE
  14:     -	3AC1  B7DA    		dw 	0xDAB7
  14:     -	3AC3  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	3AC5          		endm
  15:     -	3AC5          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
  15:     -	3AC5  54      		db 	pW_STORE
  15:     -	3AC6  CEDA    		dw 	0xDACE
  15:     -	3AC8  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	3ACA          		endm
  16:     -	3ACA          		dwpatch 0xDCB5+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	3ACA  51      		db 	pW_CHK_PATCH
  16:     -	3ACB  BFDC    		dw 	0xDCB5+5*2
  16:     -	3ACD  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	3AD1          		endm
  17:     -	3AD1          		dwstore _CPM1_dph_F+8	,0xEBA6
  17:     -	3AD1  54      		db 	pW_STORE
  17:     -	3AD2  A6EB    		dw 	0xEBA6
  17:     -	3AD4  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	3AD6          		endm
  18:     -	3AD6          		dwpatch 0xDA1B+1 	,0xDC73	,_CPM1_res_seldsk
  18:     -	3AD6  51      		db 	pW_CHK_PATCH
  18:     -	3AD7  1CDA    		dw 	0xDA1B+1
  18:     -	3AD9  73DC11E9		dw 	0xDC73,_CPM1_res_seldsk
  18:     -	3ADD          		endm
  19:     -	3ADD          		dwstore	_CPM1_old_seld_dsk+1	,0xDC73
  19:     -	3ADD  54      		db 	pW_STORE
  19:     -	3ADE  73DC    		dw 	0xDC73
  19:     -	3AE0  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	3AE2          		endm
  20:     -	3AE2          		dbpatch	0xE6FE	,0x77	,0x00
  20:     -	3AE2  52      		db 	pB_CHK_PATCH
  20:     -	3AE3  FEE6    		dw 	0xE6FE
  20:     -	3AE5  7700    		db 	0x77,0x00
  20:     -	3AE7          		endm
  21:     -	3AE7          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE058
  21:     -	3AE7  54      		db 	pW_STORE
  21:     -	3AE8  58E0    		dw 	0xE058
  21:     -	3AEA  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	3AEC          		endm
  22:     -	3AEC          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE058
  22:     -	3AEC  54      		db 	pW_STORE
  22:     -	3AED  58E0    		dw 	0xE058
  22:     -	3AEF  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	3AF1          		endm
  23:     -	3AF1          		dwpatch	0xDA27+1	,0xDCD5	,_CPM1_res_READ
  23:     -	3AF1  51      		db 	pW_CHK_PATCH
  23:     -	3AF2  28DA    		dw 	0xDA27+1
  23:     -	3AF4  D5DC1BE9		dw 	0xDCD5,_CPM1_res_READ
  23:     -	3AF8          		endm
  24:     -	3AF8          		dwpatch	0xDA2A+1	,0xDE99	,_CPM1_res_WRITE
  24:     -	3AF8  51      		db 	pW_CHK_PATCH
  24:     -	3AF9  2BDA    		dw 	0xDA2A+1
  24:     -	3AFB  99DE58E9		dw 	0xDE99,_CPM1_res_WRITE
  24:     -	3AFF          		endm
  25:     -	3AFF          		dwpatch	0xDB6A+1	,0xDCD5	,_CPM1_res_READ
  25:     -	3AFF  51      		db 	pW_CHK_PATCH
  25:     -	3B00  6BDB    		dw 	0xDB6A+1
  25:     -	3B02  D5DC1BE9		dw 	0xDCD5,_CPM1_res_READ
  25:     -	3B06          		endm
  26:     -	3B06          		dwpatch	0xdca8+1	,0xE632	,_CPM1_res_GETINFO
  26:     -	3B06  51      		db 	pW_CHK_PATCH
  26:     -	3B07  A9DC    		dw 	0xdca8+1
  26:     -	3B09  32E695E9		dw 	0xE632,_CPM1_res_GETINFO
  26:     -	3B0D          		endm
  27:     -	3B0D          		dwstore	_CPM1__old_read+1	,0xDCD5
  27:     -	3B0D  54      		db 	pW_STORE
  27:     -	3B0E  D5DC    		dw 	0xDCD5
  27:     -	3B10  56E9    		dw 	_CPM1__old_read+1
  27:     -	3B12          		endm
  28:     -	3B12          		dwstore	_CPM1__old_write+1	,0xDE99
  28:     -	3B12  54      		db 	pW_STORE
  28:     -	3B13  99DE    		dw 	0xDE99
  28:     -	3B15  93E9    		dw 	_CPM1__old_write+1
  28:     -	3B17          		endm
  29:     -	3B17          		dwstore	_CPM1__old_getinfo+1	,0xE632
  29:     -	3B17  54      		db 	pW_STORE
  29:     -	3B18  32E6    		dw 	0xE632
  29:     -	3B1A  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	3B1C          		endm
  30:     -	3B1C          		dbpatch	0xE669		,0x21	,0x21
  30:     -	3B1C  52      		db 	pB_CHK_PATCH
  30:     -	3B1D  69E6    		dw 	0xE669
  30:     -	3B1F  2121    		db 	0x21,0x21
  30:     -	3B21          		endm
  31:     -	3B21          		dwpatch	0xE669+1 	,0xE6A3	,0xE6A3
  31:     -	3B21  51      		db 	pW_CHK_PATCH
  31:     -	3B22  6AE6    		dw 	0xE669+1
  31:     -	3B24  A3E6A3E6		dw 	0xE6A3,0xE6A3
  31:     -	3B28          		endm
  32:     -	3B28          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE669
  32:     -	3B28  54      		db 	pW_STORE
  32:     -	3B29  69E6    		dw 	0xE669
  32:     -	3B2B  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	3B2D          		endm
  33:     -	3B2D          		dwstore	_CPM1_r_p_DSK1+1	,0xE04E 	;read
  33:     -	3B2D  54      		db 	pW_STORE
  33:     -	3B2E  4EE0    		dw 	0xE04E
  33:     -	3B30  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	3B32          		endm
  34:     -	3B32          		dwstore	_CPM1_r_p_TRK1+1	,0xE052 	
  34:     -	3B32  54      		db 	pW_STORE
  34:     -	3B33  52E0    		dw 	0xE052
  34:     -	3B35  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	3B37          		endm
  35:     -	3B37          		dwstore	_CPM1_r_p_SEC1+1	,0xE053 	
  35:     -	3B37  54      		db 	pW_STORE
  35:     -	3B38  53E0    		dw 	0xE053
  35:     -	3B3A  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	3B3C          		endm
  36:     -	3B3C          		dwstore	_CPM1_r_p_DMA1+1	,0xE054 	
  36:     -	3B3C  54      		db 	pW_STORE
  36:     -	3B3D  54E0    		dw 	0xE054
  36:     -	3B3F  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	3B41          		endm
  37:     -	3B41          		dwstore	_CPM1_r_p_DSK2+1	,0xE04E 	;write
  37:     -	3B41  54      		db 	pW_STORE
  37:     -	3B42  4EE0    		dw 	0xE04E
  37:     -	3B44  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	3B46          		endm
  38:     -	3B46          		dwstore	_CPM1_r_p_TRK2+1	,0xE052 	
  38:     -	3B46  54      		db 	pW_STORE
  38:     -	3B47  52E0    		dw 	0xE052
  38:     -	3B49  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	3B4B          		endm
  39:     -	3B4B          		dwstore	_CPM1_r_p_SEC2+1	,0xE053 	
  39:     -	3B4B  54      		db 	pW_STORE
  39:     -	3B4C  53E0    		dw 	0xE053
  39:     -	3B4E  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	3B50          		endm
  40:     -	3B50          		dwstore	_CPM1_r_p_DMA2+1	,0xE054 	
  40:     -	3B50  54      		db 	pW_STORE
  40:     -	3B51  54E0    		dw 	0xE054
  40:     -	3B53  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	3B55          		endm
  41:     -	3B55          		dwstore	_CPM1_r_p_DSK3+1	,0xE04E 	;readinfo
  41:     -	3B55  54      		db 	pW_STORE
  41:     -	3B56  4EE0    		dw 	0xE04E
  41:     -	3B58  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	3B5A          		endm
  42:				
  43:     -	3B5A          		stop 'CPM_21m_____Shkanov'
  43:     -	3B5A  50      		db 	p_STOP
  43:     -	3B5B  43504D5F		db 	'CPM_21m_____Shkanov'
	      32316D5F
	      5F5F5F5F
	      53686B61
	      6E6F76
  43:     -	3B6E  00      		db 	0
  43:     -	3B6F          		endm
**** out/include-patcher.asm ****
  46:					include "generator/V0/out/patcher-cpm1-CPM_12_87_09_NIIJAF.asm"	;  2 images in collection
**** generator/V0/out/patcher-cpm1-CPM_12_87_09_NIIJAF.asm ****
   1:     -	3B6F          	_BIOS_CPM_12_87_09_NIIJAF:
   2:     -	3B6F          		setSUBBIOS 1
   2:     -	3B6F  5A      		db	pSubBios
   2:     -	3B70  01      		db 	1
   2:     -	3B71          		endm
   3:     -	3B71          		RQ_OPTS_ANY
   3:     -	3B71          		endm
   4:     -	3B71          		setCPM
   4:     -	3B71          		endm
   5:     -	3B71          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	3B71  59      		db 	pB_MAYBE_PATCH
   5:     -	3B72  EEDA    		dw 	0xDAEE
   5:     -	3B74  1F0D    		db 	0x1F,0x0d
   5:     -	3B76          		endm
   6:     -	3B76          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	3B76  59      		db 	pB_MAYBE_PATCH
   6:     -	3B77  F0DA    		dw 	0xDAEE+2
   6:     -	3B79  0A0D    		db 	0x0a,0x0d
   6:     -	3B7B          		endm
   7:     -	3B7B          		dbpatch	0xE738+1	,0x49	,0xc9
   7:     -	3B7B  52      		db 	pB_CHK_PATCH
   7:     -	3B7C  39E7    		dw 	0xE738+1
   7:     -	3B7E  49C9    		db 	0x49,0xc9
   7:     -	3B80          		endm
   8:     -	3B80          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	3B80  52      		db 	pB_CHK_PATCH
   8:     -	3B81  88DA    		dw 	0xDA88
   8:     -	3B83  0100    		db 	0x01,0x00
   8:     -	3B85          		endm
   9:     -	3B85          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	3B85  52      		db 	pB_CHK_PATCH
   9:     -	3B86  9FDA    		dw 	0xDA9F
   9:     -	3B88  0200    		db 	0x02,0x00
   9:     -	3B8A          		endm
  10:     -	3B8A          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	3B8A  52      		db 	pB_CHK_PATCH
  10:     -	3B8B  B6DA    		dw 	0xDAB6
  10:     -	3B8D  0401    		db 	0x04,0x01
  10:     -	3B8F          		endm
  11:     -	3B8F          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	3B8F  52      		db 	pB_CHK_PATCH
  11:     -	3B90  CDDA    		dw 	0xDACD
  11:     -	3B92  0802    		db 	0x08,0x02
  11:     -	3B94          		endm
  12:     -	3B94          		dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	3B94  54      		db 	pW_STORE
  12:     -	3B95  88DA    		dw 	0xDA88
  12:     -	3B97  ACE8    		dw 	_CPM1_res_DRIVE_TAB+0*2
  12:     -	3B99          		endm
  13:     -	3B99          		dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	3B99  54      		db 	pW_STORE
  13:     -	3B9A  9FDA    		dw 	0xDA9F
  13:     -	3B9C  AEE8    		dw 	_CPM1_res_DRIVE_TAB+1*2
  13:     -	3B9E          		endm
  14:     -	3B9E          		dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	3B9E  54      		db 	pW_STORE
  14:     -	3B9F  B6DA    		dw 	0xDAB6
  14:     -	3BA1  B0E8    		dw 	_CPM1_res_DRIVE_TAB+2*2
  14:     -	3BA3          		endm
  15:     -	3BA3          		dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	3BA3  54      		db 	pW_STORE
  15:     -	3BA4  CDDA    		dw 	0xDACD
  15:     -	3BA6  B2E8    		dw 	_CPM1_res_DRIVE_TAB+3*2
  15:     -	3BA8          		endm
  16:     -	3BA8          		dwpatch 0xDCFA+5*2 	,0x0000 ,_CPM1_dph_F
  16:     -	3BA8  51      		db 	pW_CHK_PATCH
  16:     -	3BA9  04DD    		dw 	0xDCFA+5*2
  16:     -	3BAB  0000B8E8		dw 	0x0000,_CPM1_dph_F
  16:     -	3BAF          		endm
  17:     -	3BAF          		dwstore _CPM1_dph_F+8	,0xDFDF
  17:     -	3BAF  54      		db 	pW_STORE
  17:     -	3BB0  DFDF    		dw 	0xDFDF
  17:     -	3BB2  C0E8    		dw 	_CPM1_dph_F+8
  17:     -	3BB4          		endm
  18:     -	3BB4          		dwpatch 0xDA1B+1 	,0xDCB6	,_CPM1_res_seldsk
  18:     -	3BB4  51      		db 	pW_CHK_PATCH
  18:     -	3BB5  1CDA    		dw 	0xDA1B+1
  18:     -	3BB7  B6DC11E9		dw 	0xDCB6,_CPM1_res_seldsk
  18:     -	3BBB          		endm
  19:     -	3BBB          		dwstore	_CPM1_old_seld_dsk+1	,0xDCB6
  19:     -	3BBB  54      		db 	pW_STORE
  19:     -	3BBC  B6DC    		dw 	0xDCB6
  19:     -	3BBE  15E9    		dw 	_CPM1_old_seld_dsk+1
  19:     -	3BC0          		endm
  20:     -	3BC0          		dbpatch	0xE531	,0x77	,0x00
  20:     -	3BC0  52      		db 	pB_CHK_PATCH
  20:     -	3BC1  31E5    		dw 	0xE531
  20:     -	3BC3  7700    		db 	0x77,0x00
  20:     -	3BC5          		endm
  21:     -	3BC5          		dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFCD
  21:     -	3BC5  54      		db 	pW_STORE
  21:     -	3BC6  CDDF    		dw 	0xDFCD
  21:     -	3BC8  2EE9    		dw 	_CPM1_r_p_SELDSKDRIVER+1
  21:     -	3BCA          		endm
  22:     -	3BCA          		dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFCD
  22:     -	3BCA  54      		db 	pW_STORE
  22:     -	3BCB  CDDF    		dw 	0xDFCD
  22:     -	3BCD  6BE9    		dw 	_CPM1_r_p_SELDSKDRIVEW+1
  22:     -	3BCF          		endm
  23:     -	3BCF          		dwpatch	0xDA27+1	,0xDD19	,_CPM1_res_READ
  23:     -	3BCF  51      		db 	pW_CHK_PATCH
  23:     -	3BD0  28DA    		dw 	0xDA27+1
  23:     -	3BD2  19DD1BE9		dw 	0xDD19,_CPM1_res_READ
  23:     -	3BD6          		endm
  24:     -	3BD6          		dwpatch	0xDA2A+1	,0xDE4F	,_CPM1_res_WRITE
  24:     -	3BD6  51      		db 	pW_CHK_PATCH
  24:     -	3BD7  2BDA    		dw 	0xDA2A+1
  24:     -	3BD9  4FDE58E9		dw 	0xDE4F,_CPM1_res_WRITE
  24:     -	3BDD          		endm
  25:     -	3BDD          		dwpatch	0xDB6D+1	,0xDD19	,_CPM1_res_READ
  25:     -	3BDD  51      		db 	pW_CHK_PATCH
  25:     -	3BDE  6EDB    		dw 	0xDB6D+1
  25:     -	3BE0  19DD1BE9		dw 	0xDD19,_CPM1_res_READ
  25:     -	3BE4          		endm
  26:     -	3BE4          		dwpatch	0xDCE8+1	,0xE467	,_CPM1_res_GETINFO
  26:     -	3BE4  51      		db 	pW_CHK_PATCH
  26:     -	3BE5  E9DC    		dw 	0xDCE8+1
  26:     -	3BE7  67E495E9		dw 	0xE467,_CPM1_res_GETINFO
  26:     -	3BEB          		endm
  27:     -	3BEB          		dwstore	_CPM1__old_read+1	,0xDD19
  27:     -	3BEB  54      		db 	pW_STORE
  27:     -	3BEC  19DD    		dw 	0xDD19
  27:     -	3BEE  56E9    		dw 	_CPM1__old_read+1
  27:     -	3BF0          		endm
  28:     -	3BF0          		dwstore	_CPM1__old_write+1	,0xDE4F
  28:     -	3BF0  54      		db 	pW_STORE
  28:     -	3BF1  4FDE    		dw 	0xDE4F
  28:     -	3BF3  93E9    		dw 	_CPM1__old_write+1
  28:     -	3BF5          		endm
  29:     -	3BF5          		dwstore	_CPM1__old_getinfo+1	,0xE467
  29:     -	3BF5  54      		db 	pW_STORE
  29:     -	3BF6  67E4    		dw 	0xE467
  29:     -	3BF8  A3E9    		dw 	_CPM1__old_getinfo+1
  29:     -	3BFA          		endm
  30:     -	3BFA          		dbpatch	0xE4A7		,0x21	,0x21
  30:     -	3BFA  52      		db 	pB_CHK_PATCH
  30:     -	3BFB  A7E4    		dw 	0xE4A7
  30:     -	3BFD  2121    		db 	0x21,0x21
  30:     -	3BFF          		endm
  31:     -	3BFF          		dwpatch	0xE4A7+1 	,0xE4D7	,0xE4D7
  31:     -	3BFF  51      		db 	pW_CHK_PATCH
  31:     -	3C00  A8E4    		dw 	0xE4A7+1
  31:     -	3C02  D7E4D7E4		dw 	0xE4D7,0xE4D7
  31:     -	3C06          		endm
  32:     -	3C06          		dwstore	_CPM1__old_getinfo_chkdo+1	,0xE4A7
  32:     -	3C06  54      		db 	pW_STORE
  32:     -	3C07  A7E4    		dw 	0xE4A7
  32:     -	3C09  A0E9    		dw 	_CPM1__old_getinfo_chkdo+1
  32:     -	3C0B          		endm
  33:     -	3C0B          		dwstore	_CPM1_r_p_DSK1+1	,0xDFC3 	;read
  33:     -	3C0B  54      		db 	pW_STORE
  33:     -	3C0C  C3DF    		dw 	0xDFC3
  33:     -	3C0E  1CE9    		dw 	_CPM1_r_p_DSK1+1
  33:     -	3C10          		endm
  34:     -	3C10          		dwstore	_CPM1_r_p_TRK1+1	,0xDFC7 	
  34:     -	3C10  54      		db 	pW_STORE
  34:     -	3C11  C7DF    		dw 	0xDFC7
  34:     -	3C13  37E9    		dw 	_CPM1_r_p_TRK1+1
  34:     -	3C15          		endm
  35:     -	3C15          		dwstore	_CPM1_r_p_SEC1+1	,0xDFC8 	
  35:     -	3C15  54      		db 	pW_STORE
  35:     -	3C16  C8DF    		dw 	0xDFC8
  35:     -	3C18  3DE9    		dw 	_CPM1_r_p_SEC1+1
  35:     -	3C1A          		endm
  36:     -	3C1A          		dwstore	_CPM1_r_p_DMA1+1	,0xDFC9 	
  36:     -	3C1A  54      		db 	pW_STORE
  36:     -	3C1B  C9DF    		dw 	0xDFC9
  36:     -	3C1D  4EE9    		dw 	_CPM1_r_p_DMA1+1
  36:     -	3C1F          		endm
  37:     -	3C1F          		dwstore	_CPM1_r_p_DSK2+1	,0xDFC3 	;write
  37:     -	3C1F  54      		db 	pW_STORE
  37:     -	3C20  C3DF    		dw 	0xDFC3
  37:     -	3C22  59E9    		dw 	_CPM1_r_p_DSK2+1
  37:     -	3C24          		endm
  38:     -	3C24          		dwstore	_CPM1_r_p_TRK2+1	,0xDFC7 	
  38:     -	3C24  54      		db 	pW_STORE
  38:     -	3C25  C7DF    		dw 	0xDFC7
  38:     -	3C27  74E9    		dw 	_CPM1_r_p_TRK2+1
  38:     -	3C29          		endm
  39:     -	3C29          		dwstore	_CPM1_r_p_SEC2+1	,0xDFC8 	
  39:     -	3C29  54      		db 	pW_STORE
  39:     -	3C2A  C8DF    		dw 	0xDFC8
  39:     -	3C2C  7AE9    		dw 	_CPM1_r_p_SEC2+1
  39:     -	3C2E          		endm
  40:     -	3C2E          		dwstore	_CPM1_r_p_DMA2+1	,0xDFC9 	
  40:     -	3C2E  54      		db 	pW_STORE
  40:     -	3C2F  C9DF    		dw 	0xDFC9
  40:     -	3C31  8BE9    		dw 	_CPM1_r_p_DMA2+1
  40:     -	3C33          		endm
  41:     -	3C33          		dwstore	_CPM1_r_p_DSK3+1	,0xDFC3 	;readinfo
  41:     -	3C33  54      		db 	pW_STORE
  41:     -	3C34  C3DF    		dw 	0xDFC3
  41:     -	3C36  28EA    		dw 	_CPM1_r_p_DSK3+1
  41:     -	3C38          		endm
  42:				
  43:     -	3C38          		stop 'CPM_12_87_09_NIIJAF'
  43:     -	3C38  50      		db 	p_STOP
  43:     -	3C39  43504D5F		db 	'CPM_12_87_09_NIIJAF'
	      31325F38
	      375F3039
	      5F4E4949
	      4A4146
  43:     -	3C4C  00      		db 	0
  43:     -	3C4D          		endm
**** out/include-patcher.asm ****
  47:					include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_871220.asm"	;  2 images in collection
**** generator/V0/out/patcher-microdos-MICRODOS_OPTS1_871220.asm ****
   1:     -	3C4D          	_BIOS_MICRODOS_OPTS1_871220:
   2:     -	3C4D          		setMICRODOS
   2:     -	3C4D  56      		db 	pSETFLAG_MICRODOS
   2:     -	3C4E          		endm
   3:     -	3C4E          		RQ_OPTS1
   3:     -	3C4E  57      		db 	pREQUIRED_OPTS1
   3:     -	3C4F          		endm
   4:     -	3C4F          		dbpatchmaybe	0xBE4C	,0x1B	,0x0d
   4:     -	3C4F  59      		db 	pB_MAYBE_PATCH
   4:     -	3C50  4CBE    		dw 	0xBE4C
   4:     -	3C52  1B0D    		db 	0x1B,0x0d
   4:     -	3C54          		endm
   5:     -	3C54          		dbpatchmaybe	0xBE4C+1	,0x45	,0x0d
   5:     -	3C54  59      		db 	pB_MAYBE_PATCH
   5:     -	3C55  4DBE    		dw 	0xBE4C+1
   5:     -	3C57  450D    		db 	0x45,0x0d
   5:     -	3C59          		endm
   6:     -	3C59          		dwpatch	0xE97F+1	,0xE9B6	,MD_READ			
   6:     -	3C59  51      		db 	pW_CHK_PATCH
   6:     -	3C5A  80E9    		dw 	0xE97F+1
   6:     -	3C5C  B6E93EFA		dw 	0xE9B6,MD_READ
   6:     -	3C60          		endm
   7:     -	3C60          		dwpatch	0xE984+1	,0xEA20	,MD_WRITE
   7:     -	3C60  51      		db 	pW_CHK_PATCH
   7:     -	3C61  85E9    		dw 	0xE984+1
   7:     -	3C63  20EA53FA		dw 	0xEA20,MD_WRITE
   7:     -	3C67          		endm
   8:     -	3C67          		dbpatch	0xEB13	,0xcd	,0x00
   8:     -	3C67  52      		db 	pB_CHK_PATCH
   8:     -	3C68  13EB    		dw 	0xEB13
   8:     -	3C6A  CD00    		db 	0xcd,0x00
   8:     -	3C6C          		endm
   9:     -	3C6C          		dwpatch	0xEB13+1	,0xECA9	,0x0000
   9:     -	3C6C  51      		db 	pW_CHK_PATCH
   9:     -	3C6D  14EB    		dw 	0xEB13+1
   9:     -	3C6F  A9EC0000		dw 	0xECA9,0x0000
   9:     -	3C73          		endm
  10:     -	3C73          		dwpatch	0xEB16+1	,0xECAE	,MD_READ_INFOSECTOR
  10:     -	3C73  51      		db 	pW_CHK_PATCH
  10:     -	3C74  17EB    		dw 	0xEB16+1
  10:     -	3C76  AEEC68FA		dw 	0xECAE,MD_READ_INFOSECTOR
  10:     -	3C7A          		endm
  11:     -	3C7A          		dwstore	MD_DRV2+1,	0xEDA4
  11:     -	3C7A  54      		db 	pW_STORE
  11:     -	3C7B  A4ED    		dw 	0xEDA4
  11:     -	3C7D  F3FA    		dw 	MD_DRV2+1
  11:     -	3C7F          		endm
  12:     -	3C7F          		dwstore	MD_RDBUF2+1,	0xEDAC
  12:     -	3C7F  54      		db 	pW_STORE
  12:     -	3C80  ACED    		dw 	0xEDAC
  12:     -	3C82  02FB    		dw 	MD_RDBUF2+1
  12:     -	3C84          		endm
  13:     -	3C84          		dwstore	MD_PARAM2+1,	0xED97
  13:     -	3C84  54      		db 	pW_STORE
  13:     -	3C85  97ED    		dw 	0xED97
  13:     -	3C87  1DFA    		dw 	MD_PARAM2+1
  13:     -	3C89          		endm
  14:     -	3C89          		dwpatch 0xc01b+1	 ,0xDDB1	,md_res_seldsk
  14:     -	3C89  51      		db 	pW_CHK_PATCH
  14:     -	3C8A  1CC0    		dw 	0xc01b+1
  14:     -	3C8C  B1DD0EFA		dw 	0xDDB1,md_res_seldsk
  14:     -	3C90          		endm
  15:     -	3C90          		dwstore md_old_seld_dsk+1,0xDDB1	,0xdd4c
  15:     -	3C90  54      		db 	pW_STORE
  15:     -	3C91  B1DD    		dw 	0xDDB1
  15:     -	3C93  12FA    		dw 	md_old_seld_dsk+1
  15:     -	3C95          		endm
  16:					;custom checkers
  17:     -	3C95          		dwpatch	0xBD80	,0xBD80 ,0xBD80
  17:     -	3C95  51      		db 	pW_CHK_PATCH
  17:     -	3C96  80BD    		dw 	0xBD80
  17:     -	3C98  80BD80BD		dw 	0xBD80,0xBD80
  17:     -	3C9C          		endm
  18:     -	3C9C          		dwpatch	0xBD82	,0xBE00 ,0xBE00
  18:     -	3C9C  51      		db 	pW_CHK_PATCH
  18:     -	3C9D  82BD    		dw 	0xBD82
  18:     -	3C9F  00BE00BE		dw 	0xBE00,0xBE00
  18:     -	3CA3          		endm
  19:     -	3CA3          		dwpatch	0xc000+1	,0xC495 ,0xC495
  19:     -	3CA3  51      		db 	pW_CHK_PATCH
  19:     -	3CA4  01C0    		dw 	0xc000+1
  19:     -	3CA6  95C495C4		dw 	0xC495,0xC495
  19:     -	3CAA          		endm
  20:     -	3CAA          		dwpatch	0xc003+1	,0xDC25 ,0xDC25
  20:     -	3CAA  51      		db 	pW_CHK_PATCH
  20:     -	3CAB  04C0    		dw 	0xc003+1
  20:     -	3CAD  25DC25DC		dw 	0xDC25,0xDC25
  20:     -	3CB1          		endm
  21:     -	3CB1          		dbpatch	0xEACE	,0x21 ,0x21
  21:     -	3CB1  52      		db 	pB_CHK_PATCH
  21:     -	3CB2  CEEA    		dw 	0xEACE
  21:     -	3CB4  2121    		db 	0x21,0x21
  21:     -	3CB6          		endm
  22:     -	3CB6          		stop 'MICRODOS_OPTS1_871220'
  22:     -	3CB6  50      		db 	p_STOP
  22:     -	3CB7  4D494352		db 	'MICRODOS_OPTS1_871220'
	      4F444F53
	      5F4F5054
	      53315F38
	      37313232
	      30
  22:     -	3CCC  00      		db 	0
  22:     -	3CCD          		endm
**** out/include-patcher.asm ****
  48:					include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861115.asm"	;  2 images in collection
**** generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861115.asm ****
   1:     -	3CCD          	_BIOS_MICRODOS_OPTS1_861115:
   2:     -	3CCD          		setMICRODOS
   2:     -	3CCD  56      		db 	pSETFLAG_MICRODOS
   2:     -	3CCE          		endm
   3:     -	3CCE          		RQ_OPTS1
   3:     -	3CCE  57      		db 	pREQUIRED_OPTS1
   3:     -	3CCF          		endm
   4:     -	3CCF          		dbpatchmaybe	0xE693	,0x1B	,0x0d
   4:     -	3CCF  59      		db 	pB_MAYBE_PATCH
   4:     -	3CD0  93E6    		dw 	0xE693
   4:     -	3CD2  1B0D    		db 	0x1B,0x0d
   4:     -	3CD4          		endm
   5:     -	3CD4          		dbpatchmaybe	0xE693+1	,0x45	,0x0d
   5:     -	3CD4  59      		db 	pB_MAYBE_PATCH
   5:     -	3CD5  94E6    		dw 	0xE693+1
   5:     -	3CD7  450D    		db 	0x45,0x0d
   5:     -	3CD9          		endm
   6:     -	3CD9          		dwpatch	0xE497+1	,0xE627	,MD_READ			
   6:     -	3CD9  51      		db 	pW_CHK_PATCH
   6:     -	3CDA  98E4    		dw 	0xE497+1
   6:     -	3CDC  27E63EFA		dw 	0xE627,MD_READ
   6:     -	3CE0          		endm
   7:     -	3CE0          		dwpatch	0xE4A0+1	,0xE62A	,MD_WRITE
   7:     -	3CE0  51      		db 	pW_CHK_PATCH
   7:     -	3CE1  A1E4    		dw 	0xE4A0+1
   7:     -	3CE3  2AE653FA		dw 	0xE62A,MD_WRITE
   7:     -	3CE7          		endm
   8:     -	3CE7          		dbpatch	0xEAAE	,0xcd	,0x00
   8:     -	3CE7  52      		db 	pB_CHK_PATCH
   8:     -	3CE8  AEEA    		dw 	0xEAAE
   8:     -	3CEA  CD00    		db 	0xcd,0x00
   8:     -	3CEC          		endm
   9:     -	3CEC          		dwpatch	0xEAAE+1	,0xE9E9	,0x0000
   9:     -	3CEC  51      		db 	pW_CHK_PATCH
   9:     -	3CED  AFEA    		dw 	0xEAAE+1
   9:     -	3CEF  E9E90000		dw 	0xE9E9,0x0000
   9:     -	3CF3          		endm
  10:     -	3CF3          		dwpatch	0xEAB4+1	,0xEC5D	,MD_READ_INFOSECTOR
  10:     -	3CF3  51      		db 	pW_CHK_PATCH
  10:     -	3CF4  B5EA    		dw 	0xEAB4+1
  10:     -	3CF6  5DEC68FA		dw 	0xEC5D,MD_READ_INFOSECTOR
  10:     -	3CFA          		endm
  11:     -	3CFA          		dwstore	MD_DRV2+1,	0xDFC8
  11:     -	3CFA  54      		db 	pW_STORE
  11:     -	3CFB  C8DF    		dw 	0xDFC8
  11:     -	3CFD  F3FA    		dw 	MD_DRV2+1
  11:     -	3CFF          		endm
  12:     -	3CFF          		dwstore	MD_RDBUF2+1,	0xEEB0
  12:     -	3CFF  54      		db 	pW_STORE
  12:     -	3D00  B0EE    		dw 	0xEEB0
  12:     -	3D02  02FB    		dw 	MD_RDBUF2+1
  12:     -	3D04          		endm
  13:     -	3D04          		dwstore	MD_PARAM2+1,	0xDDBC
  13:     -	3D04  54      		db 	pW_STORE
  13:     -	3D05  BCDD    		dw 	0xDDBC
  13:     -	3D07  1DFA    		dw 	MD_PARAM2+1
  13:     -	3D09          		endm
  14:     -	3D09          		dwpatch 0xc01b+1	 ,0xDD86	,md_res_seldsk
  14:     -	3D09  51      		db 	pW_CHK_PATCH
  14:     -	3D0A  1CC0    		dw 	0xc01b+1
  14:     -	3D0C  86DD0EFA		dw 	0xDD86,md_res_seldsk
  14:     -	3D10          		endm
  15:     -	3D10          		dwstore md_old_seld_dsk+1,0xDD86	,0xdd4c
  15:     -	3D10  54      		db 	pW_STORE
  15:     -	3D11  86DD    		dw 	0xDD86
  15:     -	3D13  12FA    		dw 	md_old_seld_dsk+1
  15:     -	3D15          		endm
  16:					;custom checkers
  17:     -	3D15          		dwpatch	0xBC80	,0xBC80 ,0xBC80
  17:     -	3D15  51      		db 	pW_CHK_PATCH
  17:     -	3D16  80BC    		dw 	0xBC80
  17:     -	3D18  80BC80BC		dw 	0xBC80,0xBC80
  17:     -	3D1C          		endm
  18:     -	3D1C          		dwpatch	0xBC82	,0xBD00 ,0xBD00
  18:     -	3D1C  51      		db 	pW_CHK_PATCH
  18:     -	3D1D  82BC    		dw 	0xBC82
  18:     -	3D1F  00BD00BD		dw 	0xBD00,0xBD00
  18:     -	3D23          		endm
  19:     -	3D23          		dwpatch	0xc000+1	,0xC4BF ,0xC4BF
  19:     -	3D23  51      		db 	pW_CHK_PATCH
  19:     -	3D24  01C0    		dw 	0xc000+1
  19:     -	3D26  BFC4BFC4		dw 	0xC4BF,0xC4BF
  19:     -	3D2A          		endm
  20:     -	3D2A          		dwpatch	0xc003+1	,0xDBFB ,0xDBFB
  20:     -	3D2A  51      		db 	pW_CHK_PATCH
  20:     -	3D2B  04C0    		dw 	0xc003+1
  20:     -	3D2D  FBDBFBDB		dw 	0xDBFB,0xDBFB
  20:     -	3D31          		endm
  21:     -	3D31          		dbpatch	0xDF95	,0x40 ,0x40
  21:     -	3D31  52      		db 	pB_CHK_PATCH
  21:     -	3D32  95DF    		dw 	0xDF95
  21:     -	3D34  4040    		db 	0x40,0x40
  21:     -	3D36          		endm
  22:     -	3D36          		dbpatch	0xDF97	,0x10 ,0x10
  22:     -	3D36  52      		db 	pB_CHK_PATCH
  22:     -	3D37  97DF    		dw 	0xDF97
  22:     -	3D39  1010    		db 	0x10,0x10
  22:     -	3D3B          		endm
  23:     -	3D3B          		stop 'MICRODOS_OPTS1_861115'
  23:     -	3D3B  50      		db 	p_STOP
  23:     -	3D3C  4D494352		db 	'MICRODOS_OPTS1_861115'
	      4F444F53
	      5F4F5054
	      53315F38
	      36313131
	      35
  23:     -	3D51  00      		db 	0
  23:     -	3D52          		endm
**** out/include-patcher.asm ****
  49:					include "generator/V0/out/patcher-unsopported-CPM_NET_SFERA1.asm"	;  2 images in collection
**** generator/V0/out/patcher-unsopported-CPM_NET_SFERA1.asm ****
   1:     -	3D52          	_BIOS_CPM_NET_SFERA1:
   2:     -	3D52          		setUNSUPPORTED
   2:     -	3D52  55      		db 	pNotSupported
   2:     -	3D53          		endm
   3:					;custom checkers
   4:     -	3D53          		dwpatch	0xC380  	,0xC380  ,0xC380 
   4:     -	3D53  51      		db 	pW_CHK_PATCH
   4:     -	3D54  80C3    		dw 	0xC380
   4:     -	3D56  80C380C3		dw 	0xC380,0xC380
   4:     -	3D5A          		endm
   5:     -	3D5A          		dwpatch	0xC382  	,0xDa00 ,0xDa00
   5:     -	3D5A  51      		db 	pW_CHK_PATCH
   5:     -	3D5B  82C3    		dw 	0xC382
   5:     -	3D5D  00DA00DA		dw 	0xDa00,0xDa00
   5:     -	3D61          		endm
   6:     -	3D61          		dwpatch	0xC384  	,0x000A ,0x000A
   6:     -	3D61  51      		db 	pW_CHK_PATCH
   6:     -	3D62  84C3    		dw 	0xC384
   6:     -	3D64  0A000A00		dw 	0x000A,0x000A
   6:     -	3D68          		endm
   7:     -	3D68          		dwpatch	0xDB5C+1	,0xDAC3 ,0xDAC3
   7:     -	3D68  51      		db 	pW_CHK_PATCH
   7:     -	3D69  5DDB    		dw 	0xDB5C+1
   7:     -	3D6B  C3DAC3DA		dw 	0xDAC3,0xDAC3
   7:     -	3D6F          		endm
   8:     -	3D6F          		dwpatch	0xDA03+1	,0xDB6E ,0xDB6E
   8:     -	3D6F  51      		db 	pW_CHK_PATCH
   8:     -	3D70  04DA    		dw 	0xDA03+1
   8:     -	3D72  6EDB6EDB		dw 	0xDB6E,0xDB6E
   8:     -	3D76          		endm
   9:     -	3D76          		dwpatch	0xDA27+1	,0xDED4 ,0xDED4
   9:     -	3D76  51      		db 	pW_CHK_PATCH
   9:     -	3D77  28DA    		dw 	0xDA27+1
   9:     -	3D79  D4DED4DE		dw 	0xDED4,0xDED4
   9:     -	3D7D          		endm
  10:     -	3D7D          		dwpatch	0xDA2A+1	,0xE193 ,0xE193
  10:     -	3D7D  51      		db 	pW_CHK_PATCH
  10:     -	3D7E  2BDA    		dw 	0xDA2A+1
  10:     -	3D80  93E193E1		dw 	0xE193,0xE193
  10:     -	3D84          		endm
  11:     -	3D84          		dwpatch	0xDA3C+1	,0xDD06 ,0xDD06
  11:     -	3D84  51      		db 	pW_CHK_PATCH
  11:     -	3D85  3DDA    		dw 	0xDA3C+1
  11:     -	3D87  06DD06DD		dw 	0xDD06,0xDD06
  11:     -	3D8B          		endm
  12:     -	3D8B          		stop 'CPM_NET_SFERA1'
  12:     -	3D8B  50      		db 	p_STOP
  12:     -	3D8C  43504D5F		db 	'CPM_NET_SFERA1'
	      4E45545F
	      53464552
	      4131
  12:     -	3D9A  00      		db 	0
  12:     -	3D9B          		endm
**** out/include-patcher.asm ****
  50:					include "generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_b.asm"	;  2 images in collection
**** generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_b.asm ****
   1:     -	3D9B          	_BIOS_CPM_NET_KORNET_drive_b:
   2:     -	3D9B          		setUNSUPPORTED
   2:     -	3D9B  55      		db 	pNotSupported
   2:     -	3D9C          		endm
   3:					;custom checkers
   4:     -	3D9C          		dwpatch	0x8000  	,0x00EE  ,0x00EE 
   4:     -	3D9C  51      		db 	pW_CHK_PATCH
   4:     -	3D9D  0080    		dw 	0x8000
   4:     -	3D9F  EE00EE00		dw 	0x00EE,0x00EE
   4:     -	3DA3          		endm
   5:     -	3DA3          		dwpatch	0x8000+2	,0x0000 ,0x0000
   5:     -	3DA3  51      		db 	pW_CHK_PATCH
   5:     -	3DA4  0280    		dw 	0x8000+2
   5:     -	3DA6  00000000		dw 	0x0000,0x0000
   5:     -	3DAA          		endm
   6:     -	3DAA          		dwpatch	0x8000+4	,0x000E ,0x000E
   6:     -	3DAA  51      		db 	pW_CHK_PATCH
   6:     -	3DAB  0480    		dw 	0x8000+4
   6:     -	3DAD  0E000E00		dw 	0x000E,0x000E
   6:     -	3DB1          		endm
   7:     -	3DB1          		stop 'CPM_NET_KORNET_drive_b'
   7:     -	3DB1  50      		db 	p_STOP
   7:     -	3DB2  43504D5F		db 	'CPM_NET_KORNET_drive_b'
	      4E45545F
	      4B4F524E
	      45545F64
	      72697665
	      5F62
   7:     -	3DC8  00      		db 	0
   7:     -	3DC9          		endm
**** out/include-patcher.asm ****
  51:					include "generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_a.asm"	;  2 images in collection
**** generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_a.asm ****
   1:     -	3DC9          	_BIOS_CPM_NET_KORNET_drive_a:
   2:     -	3DC9          		setUNSUPPORTED
   2:     -	3DC9  55      		db 	pNotSupported
   2:     -	3DCA          		endm
   3:					;custom checkers
   4:     -	3DCA          		dwpatch	0xDB59+1	,0xDAAA ,0xDAAA
   4:     -	3DCA  51      		db 	pW_CHK_PATCH
   4:     -	3DCB  5ADB    		dw 	0xDB59+1
   4:     -	3DCD  AADAAADA		dw 	0xDAAA,0xDAAA
   4:     -	3DD1          		endm
   5:     -	3DD1          		dwpatch	0xD980	,0xD980 ,0xD980
   5:     -	3DD1  51      		db 	pW_CHK_PATCH
   5:     -	3DD2  80D9    		dw 	0xD980
   5:     -	3DD4  80D980D9		dw 	0xD980,0xD980
   5:     -	3DD8          		endm
   6:     -	3DD8          		dwpatch	0xD982	,0xDa00 ,0xDa00
   6:     -	3DD8  51      		db 	pW_CHK_PATCH
   6:     -	3DD9  82D9    		dw 	0xD982
   6:     -	3DDB  00DA00DA		dw 	0xDa00,0xDa00
   6:     -	3DDF          		endm
   7:     -	3DDF          		dwpatch	0xD984	,0x0006 ,0x0006
   7:     -	3DDF  51      		db 	pW_CHK_PATCH
   7:     -	3DE0  84D9    		dw 	0xD984
   7:     -	3DE2  06000600		dw 	0x0006,0x0006
   7:     -	3DE6          		endm
   8:     -	3DE6          		dwpatch	0xDA03+1	,0xDBA1 ,0xDBA1
   8:     -	3DE6  51      		db 	pW_CHK_PATCH
   8:     -	3DE7  04DA    		dw 	0xDA03+1
   8:     -	3DE9  A1DBA1DB		dw 	0xDBA1,0xDBA1
   8:     -	3DED          		endm
   9:     -	3DED          		dwpatch	0xDA27+1	,0xDEB0 ,0xDEB0
   9:     -	3DED  51      		db 	pW_CHK_PATCH
   9:     -	3DEE  28DA    		dw 	0xDA27+1
   9:     -	3DF0  B0DEB0DE		dw 	0xDEB0,0xDEB0
   9:     -	3DF4          		endm
  10:     -	3DF4          		dwpatch	0xDA2A+1	,0xE19A ,0xE19A
  10:     -	3DF4  51      		db 	pW_CHK_PATCH
  10:     -	3DF5  2BDA    		dw 	0xDA2A+1
  10:     -	3DF7  9AE19AE1		dw 	0xE19A,0xE19A
  10:     -	3DFB          		endm
  11:     -	3DFB          		dwpatch	0xDA33+1	,0xDFC8 ,0xDFC8
  11:     -	3DFB  51      		db 	pW_CHK_PATCH
  11:     -	3DFC  34DA    		dw 	0xDA33+1
  11:     -	3DFE  C8DFC8DF		dw 	0xDFC8,0xDFC8
  11:     -	3E02          		endm
  12:     -	3E02          		stop 'CPM_NET_KORNET_drive_a'
  12:     -	3E02  50      		db 	p_STOP
  12:     -	3E03  43504D5F		db 	'CPM_NET_KORNET_drive_a'
	      4E45545F
	      4B4F524E
	      45545F64
	      72697665
	      5F61
  12:     -	3E19  00      		db 	0
  12:     -	3E1A          		endm
**** out/include-patcher.asm ****
  52:					include "generator/V0/out/patcher-cpm2-CPM_1x_88_EPSON_V104.asm"	;  1 images in collection
**** generator/V0/out/patcher-cpm2-CPM_1x_88_EPSON_V104.asm ****
   1:     -	3E1A          	_BIOS_CPM_1x_88_EPSON_V104:
   2:     -	3E1A          		setSUBBIOS 2
   2:     -	3E1A  5A      		db	pSubBios
   2:     -	3E1B  02      		db 	2
   2:     -	3E1C          		endm
   3:     -	3E1C          		RQ_OPTS1
   3:     -	3E1C  57      		db 	pREQUIRED_OPTS1
   3:     -	3E1D          		endm
   4:     -	3E1D          		setCPM
   4:     -	3E1D          		endm
   5:     -	3E1D          		dbpatchmaybe	0xDAEE	,0x1F	,0x0d
   5:     -	3E1D  59      		db 	pB_MAYBE_PATCH
   5:     -	3E1E  EEDA    		dw 	0xDAEE
   5:     -	3E20  1F0D    		db 	0x1F,0x0d
   5:     -	3E22          		endm
   6:     -	3E22          		dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
   6:     -	3E22  59      		db 	pB_MAYBE_PATCH
   6:     -	3E23  F0DA    		dw 	0xDAEE+2
   6:     -	3E25  0A0D    		db 	0x0a,0x0d
   6:     -	3E27          		endm
   7:     -	3E27          		dbpatch	0xE8B7+1	,0x49	,0xc9
   7:     -	3E27  52      		db 	pB_CHK_PATCH
   7:     -	3E28  B8E8    		dw 	0xE8B7+1
   7:     -	3E2A  49C9    		db 	0x49,0xc9
   7:     -	3E2C          		endm
   8:     -	3E2C          		dbpatch	0xDA88 	,0x01	,0x00
   8:     -	3E2C  52      		db 	pB_CHK_PATCH
   8:     -	3E2D  88DA    		dw 	0xDA88
   8:     -	3E2F  0100    		db 	0x01,0x00
   8:     -	3E31          		endm
   9:     -	3E31          		dbpatch	0xDA9F 	,0x02	,0x00
   9:     -	3E31  52      		db 	pB_CHK_PATCH
   9:     -	3E32  9FDA    		dw 	0xDA9F
   9:     -	3E34  0200    		db 	0x02,0x00
   9:     -	3E36          		endm
  10:     -	3E36          		dbpatch	0xDAB6 	,0x04	,0x01
  10:     -	3E36  52      		db 	pB_CHK_PATCH
  10:     -	3E37  B6DA    		dw 	0xDAB6
  10:     -	3E39  0401    		db 	0x04,0x01
  10:     -	3E3B          		endm
  11:     -	3E3B          		dbpatch	0xDACD 	,0x08	,0x02
  11:     -	3E3B  52      		db 	pB_CHK_PATCH
  11:     -	3E3C  CDDA    		dw 	0xDACD
  11:     -	3E3E  0802    		db 	0x08,0x02
  11:     -	3E40          		endm
  12:     -	3E40          		dwstore	_CPM2_res_DRIVE_TAB+0*2	,0xDA88
  12:     -	3E40  54      		db 	pW_STORE
  12:     -	3E41  88DA    		dw 	0xDA88
  12:     -	3E43  06EA    		dw 	_CPM2_res_DRIVE_TAB+0*2
  12:     -	3E45          		endm
  13:     -	3E45          		dwstore	_CPM2_res_DRIVE_TAB+1*2	,0xDA9F
  13:     -	3E45  54      		db 	pW_STORE
  13:     -	3E46  9FDA    		dw 	0xDA9F
  13:     -	3E48  08EA    		dw 	_CPM2_res_DRIVE_TAB+1*2
  13:     -	3E4A          		endm
  14:     -	3E4A          		dwstore	_CPM2_res_DRIVE_TAB+2*2	,0xDAB6
  14:     -	3E4A  54      		db 	pW_STORE
  14:     -	3E4B  B6DA    		dw 	0xDAB6
  14:     -	3E4D  0AEA    		dw 	_CPM2_res_DRIVE_TAB+2*2
  14:     -	3E4F          		endm
  15:     -	3E4F          		dwstore	_CPM2_res_DRIVE_TAB+3*2	,0xDACD
  15:     -	3E4F  54      		db 	pW_STORE
  15:     -	3E50  CDDA    		dw 	0xDACD
  15:     -	3E52  0CEA    		dw 	_CPM2_res_DRIVE_TAB+3*2
  15:     -	3E54          		endm
  16:     -	3E54          		dwpatch 0xDEC6+5*2 	,0x0000 ,_CPM2_dph_F
  16:     -	3E54  51      		db 	pW_CHK_PATCH
  16:     -	3E55  D0DE    		dw 	0xDEC6+5*2
  16:     -	3E57  000012EA		dw 	0x0000,_CPM2_dph_F
  16:     -	3E5B          		endm
  17:     -	3E5B          		dwstore _CPM2_dph_F+8	,0xE1AB
  17:     -	3E5B  54      		db 	pW_STORE
  17:     -	3E5C  ABE1    		dw 	0xE1AB
  17:     -	3E5E  1AEA    		dw 	_CPM2_dph_F+8
  17:     -	3E60          		endm
  18:     -	3E60          		dwpatch 0xDA1B+1 	,0xDE82	,_CPM2_res_seldsk
  18:     -	3E60  51      		db 	pW_CHK_PATCH
  18:     -	3E61  1CDA    		dw 	0xDA1B+1
  18:     -	3E63  82DE6BEA		dw 	0xDE82,_CPM2_res_seldsk
  18:     -	3E67          		endm
  19:     -	3E67          		dwstore	_CPM2_old_seld_dsk+1	,0xDE82
  19:     -	3E67  54      		db 	pW_STORE
  19:     -	3E68  82DE    		dw 	0xDE82
  19:     -	3E6A  6FEA    		dw 	_CPM2_old_seld_dsk+1
  19:     -	3E6C          		endm
  20:     -	3E6C          		dbpatch	0xE6DE	,0x77	,0x00
  20:     -	3E6C  52      		db 	pB_CHK_PATCH
  20:     -	3E6D  DEE6    		dw 	0xE6DE
  20:     -	3E6F  7700    		db 	0x77,0x00
  20:     -	3E71          		endm
  21:     -	3E71          		dwstore	_CPM2_r_p_SELDSKDRIVER+1	,0xE199
  21:     -	3E71  54      		db 	pW_STORE
  21:     -	3E72  99E1    		dw 	0xE199
  21:     -	3E74  88EA    		dw 	_CPM2_r_p_SELDSKDRIVER+1
  21:     -	3E76          		endm
  22:     -	3E76          		dwstore	_CPM2_r_p_SELDSKDRIVEW+1	,0xE199
  22:     -	3E76  54      		db 	pW_STORE
  22:     -	3E77  99E1    		dw 	0xE199
  22:     -	3E79  C5EA    		dw 	_CPM2_r_p_SELDSKDRIVEW+1
  22:     -	3E7B          		endm
  23:     -	3E7B          		dwpatch	0xDA27+1	,0xDEE5	,_CPM2_res_READ
  23:     -	3E7B  51      		db 	pW_CHK_PATCH
  23:     -	3E7C  28DA    		dw 	0xDA27+1
  23:     -	3E7E  E5DE75EA		dw 	0xDEE5,_CPM2_res_READ
  23:     -	3E82          		endm
  24:     -	3E82          		dwpatch	0xDA2A+1	,0xE01B	,_CPM2_res_WRITE
  24:     -	3E82  51      		db 	pW_CHK_PATCH
  24:     -	3E83  2BDA    		dw 	0xDA2A+1
  24:     -	3E85  1BE0B2EA		dw 	0xE01B,_CPM2_res_WRITE
  24:     -	3E89          		endm
  25:     -	3E89          		dwpatch	0xDBC2+1	,0xDEE5	,_CPM2_res_READ
  25:     -	3E89  51      		db 	pW_CHK_PATCH
  25:     -	3E8A  C3DB    		dw 	0xDBC2+1
  25:     -	3E8C  E5DE75EA		dw 	0xDEE5,_CPM2_res_READ
  25:     -	3E90          		endm
  26:     -	3E90          		dwpatch	0xdeb4+1	,0xE614	,_CPM2_res_GETINFO
  26:     -	3E90  51      		db 	pW_CHK_PATCH
  26:     -	3E91  B5DE    		dw 	0xdeb4+1
  26:     -	3E93  14E6EFEA		dw 	0xE614,_CPM2_res_GETINFO
  26:     -	3E97          		endm
  27:     -	3E97          		dwstore	_CPM2__old_read+1	,0xDEE5
  27:     -	3E97  54      		db 	pW_STORE
  27:     -	3E98  E5DE    		dw 	0xDEE5
  27:     -	3E9A  B0EA    		dw 	_CPM2__old_read+1
  27:     -	3E9C          		endm
  28:     -	3E9C          		dwstore	_CPM2__old_write+1	,0xE01B
  28:     -	3E9C  54      		db 	pW_STORE
  28:     -	3E9D  1BE0    		dw 	0xE01B
  28:     -	3E9F  EDEA    		dw 	_CPM2__old_write+1
  28:     -	3EA1          		endm
  29:     -	3EA1          		dwstore	_CPM2__old_getinfo+1	,0xE614
  29:     -	3EA1  54      		db 	pW_STORE
  29:     -	3EA2  14E6    		dw 	0xE614
  29:     -	3EA4  FDEA    		dw 	_CPM2__old_getinfo+1
  29:     -	3EA6          		endm
  30:     -	3EA6          		dbpatch	0xE654		,0x21	,0x21
  30:     -	3EA6  52      		db 	pB_CHK_PATCH
  30:     -	3EA7  54E6    		dw 	0xE654
  30:     -	3EA9  2121    		db 	0x21,0x21
  30:     -	3EAB          		endm
  31:     -	3EAB          		dwpatch	0xE654+1 	,0xE684	,0xE684
  31:     -	3EAB  51      		db 	pW_CHK_PATCH
  31:     -	3EAC  55E6    		dw 	0xE654+1
  31:     -	3EAE  84E684E6		dw 	0xE684,0xE684
  31:     -	3EB2          		endm
  32:     -	3EB2          		dwstore	_CPM2__old_getinfo_chkdo+1	,0xE654
  32:     -	3EB2  54      		db 	pW_STORE
  32:     -	3EB3  54E6    		dw 	0xE654
  32:     -	3EB5  FAEA    		dw 	_CPM2__old_getinfo_chkdo+1
  32:     -	3EB7          		endm
  33:     -	3EB7          		dwstore	_CPM2_r_p_DSK1+1	,0xE18F 	;read
  33:     -	3EB7  54      		db 	pW_STORE
  33:     -	3EB8  8FE1    		dw 	0xE18F
  33:     -	3EBA  76EA    		dw 	_CPM2_r_p_DSK1+1
  33:     -	3EBC          		endm
  34:     -	3EBC          		dwstore	_CPM2_r_p_TRK1+1	,0xE193 	
  34:     -	3EBC  54      		db 	pW_STORE
  34:     -	3EBD  93E1    		dw 	0xE193
  34:     -	3EBF  91EA    		dw 	_CPM2_r_p_TRK1+1
  34:     -	3EC1          		endm
  35:     -	3EC1          		dwstore	_CPM2_r_p_SEC1+1	,0xE194 	
  35:     -	3EC1  54      		db 	pW_STORE
  35:     -	3EC2  94E1    		dw 	0xE194
  35:     -	3EC4  97EA    		dw 	_CPM2_r_p_SEC1+1
  35:     -	3EC6          		endm
  36:     -	3EC6          		dwstore	_CPM2_r_p_DMA1+1	,0xE195 	
  36:     -	3EC6  54      		db 	pW_STORE
  36:     -	3EC7  95E1    		dw 	0xE195
  36:     -	3EC9  A8EA    		dw 	_CPM2_r_p_DMA1+1
  36:     -	3ECB          		endm
  37:     -	3ECB          		dwstore	_CPM2_r_p_DSK2+1	,0xE18F 	;write
  37:     -	3ECB  54      		db 	pW_STORE
  37:     -	3ECC  8FE1    		dw 	0xE18F
  37:     -	3ECE  B3EA    		dw 	_CPM2_r_p_DSK2+1
  37:     -	3ED0          		endm
  38:     -	3ED0          		dwstore	_CPM2_r_p_TRK2+1	,0xE193 	
  38:     -	3ED0  54      		db 	pW_STORE
  38:     -	3ED1  93E1    		dw 	0xE193
  38:     -	3ED3  CEEA    		dw 	_CPM2_r_p_TRK2+1
  38:     -	3ED5          		endm
  39:     -	3ED5          		dwstore	_CPM2_r_p_SEC2+1	,0xE194 	
  39:     -	3ED5  54      		db 	pW_STORE
  39:     -	3ED6  94E1    		dw 	0xE194
  39:     -	3ED8  D4EA    		dw 	_CPM2_r_p_SEC2+1
  39:     -	3EDA          		endm
  40:     -	3EDA          		dwstore	_CPM2_r_p_DMA2+1	,0xE195 	
  40:     -	3EDA  54      		db 	pW_STORE
  40:     -	3EDB  95E1    		dw 	0xE195
  40:     -	3EDD  E5EA    		dw 	_CPM2_r_p_DMA2+1
  40:     -	3EDF          		endm
  41:     -	3EDF          		dwstore	_CPM2_r_p_DSK3+1	,0xE18F 	;readinfo
  41:     -	3EDF  54      		db 	pW_STORE
  41:     -	3EE0  8FE1    		dw 	0xE18F
  41:     -	3EE2  82EB    		dw 	_CPM2_r_p_DSK3+1
  41:     -	3EE4          		endm
  42:				
  43:     -	3EE4          		stop 'CPM_1x_88_EPSON_V104'
  43:     -	3EE4  50      		db 	p_STOP
  43:     -	3EE5  43504D5F		db 	'CPM_1x_88_EPSON_V104'
	      31785F38
	      385F4550
	      534F4E5F
	      56313034
  43:     -	3EF9  00      		db 	0
  43:     -	3EFA          		endm
**** out/include-patcher.asm ****
  53:					include "generator/V0/out/patcher-unsopported-CPM_NET_SFERA2.asm"	;  1 images in collection
**** generator/V0/out/patcher-unsopported-CPM_NET_SFERA2.asm ****
   1:     -	3EFA          	_BIOS_CPM_NET_SFERA2:
   2:     -	3EFA          		setUNSUPPORTED
   2:     -	3EFA  55      		db 	pNotSupported
   2:     -	3EFB          		endm
   3:					;custom checkers
   4:     -	3EFB          		dwpatch	0xC380  	,0xC380  ,0xC380 
   4:     -	3EFB  51      		db 	pW_CHK_PATCH
   4:     -	3EFC  80C3    		dw 	0xC380
   4:     -	3EFE  80C380C3		dw 	0xC380,0xC380
   4:     -	3F02          		endm
   5:     -	3F02          		dwpatch	0xC382  	,0xDa00 ,0xDa00
   5:     -	3F02  51      		db 	pW_CHK_PATCH
   5:     -	3F03  82C3    		dw 	0xC382
   5:     -	3F05  00DA00DA		dw 	0xDa00,0xDa00
   5:     -	3F09          		endm
   6:     -	3F09          		dwpatch	0xC384  	,0x000A ,0x000A
   6:     -	3F09  51      		db 	pW_CHK_PATCH
   6:     -	3F0A  84C3    		dw 	0xC384
   6:     -	3F0C  0A000A00		dw 	0x000A,0x000A
   6:     -	3F10          		endm
   7:     -	3F10          		dwpatch	0xDB5C+1	,0xDAC3 ,0xDAC3
   7:     -	3F10  51      		db 	pW_CHK_PATCH
   7:     -	3F11  5DDB    		dw 	0xDB5C+1
   7:     -	3F13  C3DAC3DA		dw 	0xDAC3,0xDAC3
   7:     -	3F17          		endm
   8:     -	3F17          		dwpatch	0xDA03+1	,0xDB6E ,0xDB6E
   8:     -	3F17  51      		db 	pW_CHK_PATCH
   8:     -	3F18  04DA    		dw 	0xDA03+1
   8:     -	3F1A  6EDB6EDB		dw 	0xDB6E,0xDB6E
   8:     -	3F1E          		endm
   9:     -	3F1E          		dwpatch	0xDA27+1	,0xDED0 ,0xDED0
   9:     -	3F1E  51      		db 	pW_CHK_PATCH
   9:     -	3F1F  28DA    		dw 	0xDA27+1
   9:     -	3F21  D0DED0DE		dw 	0xDED0,0xDED0
   9:     -	3F25          		endm
  10:     -	3F25          		dwpatch	0xDA2A+1	,0xE18F ,0xE18F
  10:     -	3F25  51      		db 	pW_CHK_PATCH
  10:     -	3F26  2BDA    		dw 	0xDA2A+1
  10:     -	3F28  8FE18FE1		dw 	0xE18F,0xE18F
  10:     -	3F2C          		endm
  11:     -	3F2C          		dwpatch	0xDA3C+1	,0xDD02 ,0xDD02
  11:     -	3F2C  51      		db 	pW_CHK_PATCH
  11:     -	3F2D  3DDA    		dw 	0xDA3C+1
  11:     -	3F2F  02DD02DD		dw 	0xDD02,0xDD02
  11:     -	3F33          		endm
  12:     -	3F33          		stop 'CPM_NET_SFERA2'
  12:     -	3F33  50      		db 	p_STOP
  12:     -	3F34  43504D5F		db 	'CPM_NET_SFERA2'
	      4E45545F
	      53464552
	      4132
  12:     -	3F42  00      		db 	0
  12:     -	3F43          		endm
**** out/include-patcher.asm ****
  54:     -	3F43  FF      		db 0xff
**** generator/V0/extrom-patcher.asm ****
 740:				
**** stage2.asm ****
 640:					
 641:				
 642:				
 643:				; Округляем размер всей секции до ближайших 256 байт вверх	
 644:     -	3F44 .. 3FFF 00	        DS      ((($>>8)+1)<<8)-$,0
 645:     -	4000          	FTOP	EQU	$			; верхний адрес памяти, занимаемый загружаемым блоком
 646:				;--------------------------------------------------------------------------
 647:				; Конец загружаемой области
 648:				; Далее идет область рабочих данных, не входящая в тело файла загрузчика
 649:				;--------------------------------------------------------------------------
 650:				
 651:				; Буфер сектора
 652:     -	4000          	SECBUF	EQU	$
 653:     -	4080          		ORG	$+128	; буфер 128 байт, DS использовать нельзя, чтобы не порождать объектный код
 654:				
 655:     -	4080          	loader	END 	



Statistics:

     4	passes
     0	jr promotions
   379	symbols
  8153	bytes

   705	macro calls
 13170	macro bytes
     0	invented symbols



Symbol Table:

.badbootparam   2195     
.chkm           2078     
.cpfddname      2982     
.cpmnoresident  26c1     
.cpmremapcd     26e9     
.cpmsubbios1    269d     
.cpmsubbios2    26af     
.endfill        2a56     
.fillloop       2a4e     
.found_cont     2597     
.inilut         2222     
.inilutgrp      222a     
.noprintkey     20a5     
.phalt          282a     
.physical_drive 2954     
.pnotsupported  27bf     
.prequired_opts1 27e8     
.prequired_opts2 2801     
.print          2044     
.printkey       205e     
.psetflag_microdos 27ce     
.psubbios       27db     
.putnospc       2474     
.rom_found      254d     
.romcrc         2528     
.rw             29b0     
.setgzusize     2505     
.skipappend     2a1f     
.skiplp         2a42     
.subbiosldir    26be     
.zgu192k        2503     
_bios_cpm_12_87_09_niijaf 3b6f     
_bios_cpm_12_87_11_niijaf 39b3     
_bios_cpm_12_88_3_alternativa 2fd5     
_bios_cpm_12_88_3_niijaf 30c3     
_bios_cpm_12_90_5_kontur 3852     
_bios_cpm_1x_88_epson_v104 3e1a     
_bios_cpm_1x_89_03_30_ravi 3538     
_bios_cpm_20_88___miks 3777     
_bios_cpm_21_89_2_niijaf 33e0     
_bios_cpm_21_89_2_niijaf2 3302     
_bios_cpm_21_89___wiza 31a0     
_bios_cpm_21_91___lap 369d     
_bios_cpm_21_extrom 2f95     
_bios_cpm_21m_____shkanov 3a91     
_bios_cpm_net_kornet_drive_a 3dc9     
_bios_cpm_net_kornet_drive_b 3d9b     
_bios_cpm_net_sfera1 3d52     
_bios_cpm_net_sfera2 3efa     
_bios_microdos_opts1_861011 3618     
_bios_microdos_opts1_861115 3ccd     
_bios_microdos_opts1_870430 34bd     
_bios_microdos_opts1_871220 3c4d     
_bios_microdos_opts2_880630 3282     
_bios_microdos_opts2_900105 392f     
_cpm1_.r_no_drv_dec e929     
_cpm1_.w_no_drv_dec e966     
_cpm1__old_getinfo e9a2     
_cpm1__old_getinfo_chkdo e99f     
_cpm1__old_read e955     
_cpm1__old_write e992     
_cpm1_alw_f     e8df     
_cpm1_dpb_f     e8d0     
_cpm1_dph_f     e8b8     
_cpm1_exr_cmd   ea3f     
_cpm1_exr_drv   ea40     
_cpm1_exr_getbyte e9a5     
_cpm1_exr_getsec e9c5     
_cpm1_exr_putbyte e9b4     
_cpm1_exr_putsec e9e0     
_cpm1_exr_readinfo ea21     
_cpm1_exr_sec   ea42     
_cpm1_exr_sendcmd e9fb     
_cpm1_exr_trk   ea41     
_cpm1_old_seld_dsk e914     
_cpm1_pgsl      e9ce     
_cpm1_ppsl      e9e9     
_cpm1_pscl      ea0a     
_cpm1_pwg       e9a9     
_cpm1_pwp       e9b9     
_cpm1_r_p_dma1  e94d     
_cpm1_r_p_dma2  e98a     
_cpm1_r_p_dsk1  e91b     
_cpm1_r_p_dsk2  e958     
_cpm1_r_p_dsk3  ea27     
_cpm1_r_p_sec1  e93c     
_cpm1_r_p_sec2  e979     
_cpm1_r_p_seldskdriver e92d     
_cpm1_r_p_seldskdrivew e96a     
_cpm1_r_p_trk1  e936     
_cpm1_r_p_trk2  e973     
_cpm1_res_drive_tab e8ac     
_cpm1_res_getinfo e995     
_cpm1_res_read  e91b     
_cpm1_res_seldsk e911     
_cpm1_res_write e958     
_cpm2_.r_no_drv_dec ea83     
_cpm2_.w_no_drv_dec eac0     
_cpm2__old_getinfo eafc     
_cpm2__old_getinfo_chkdo eaf9     
_cpm2__old_read eaaf     
_cpm2__old_write eaec     
_cpm2_alw_f     ea39     
_cpm2_dpb_f     ea2a     
_cpm2_dph_f     ea12     
_cpm2_exr_cmd   eb99     
_cpm2_exr_drv   eb9a     
_cpm2_exr_getbyte eaff     
_cpm2_exr_getsec eb1f     
_cpm2_exr_putbyte eb0e     
_cpm2_exr_putsec eb3a     
_cpm2_exr_readinfo eb7b     
_cpm2_exr_sec   eb9c     
_cpm2_exr_sendcmd eb55     
_cpm2_exr_trk   eb9b     
_cpm2_old_seld_dsk ea6e     
_cpm2_pgsl      eb28     
_cpm2_ppsl      eb43     
_cpm2_pscl      eb64     
_cpm2_pwg       eb03     
_cpm2_pwp       eb13     
_cpm2_r_p_dma1  eaa7     
_cpm2_r_p_dma2  eae4     
_cpm2_r_p_dsk1  ea75     
_cpm2_r_p_dsk2  eab2     
_cpm2_r_p_dsk3  eb81     
_cpm2_r_p_sec1  ea96     
_cpm2_r_p_sec2  ead3     
_cpm2_r_p_seldskdriver ea87     
_cpm2_r_p_seldskdrivew eac4     
_cpm2_r_p_trk1  ea90     
_cpm2_r_p_trk2  eacd     
_cpm2_res_drive_tab ea06     
_cpm2_res_getinfo eaef     
_cpm2_res_read  ea75     
_cpm2_res_seldsk ea6b     
_cpm2_res_write eab2     
_dma           =ffff     
_dsk           =ffff     
_hw_gzu_size_192k=   2     
_hw_gzu_size_48k=   1     
_hw_rom_model_kvant8=   3     
_hw_rom_model_opts11=   1     
_hw_rom_model_opts20=   2     
_hw_rom_opts1  =   1     
_hw_rom_opts2  =   2     
_oper          =ffff     
_p_ldir         28ce     
_rrbuff        =ee00     
_sec           =ffff     
_trk           =ffff     
api_get_mount_name=  80     
api_get_mount_status=  82     
append_z        2a19     
available_resident_cpm1_len= 163     
available_resident_cpm2_len= 260     
b_chk_maybe     275f     
b_chk_patch     273c     
base           =2000     
bios_found      2588     
bios_not_found  257f     
bios_variants   2f55     
build_disk_name 2998     
build_emu_name  29f6     
checkbootparams 216e     
chk_bios_lp     256a     
cmd             22e6     
conin          =  49     
copy_z          2a2c     
cp_de_bc        28a6     
cpm_bios_patcher 2556     
debug_trace_patcher=   0     
do_patch        272c     
drive_rw_status 2ab7     
drivetab_mount_info 2a6f     
drv             22e7     
errzerodrvinfotab 29d9     
fdd_found       297b     
fetch_db_to_b   28cb     
fetch_dw_to_bc  28c9     
fetchdefromhl   2285     
fix_width       2a3d     
flag_microdos   25bc     
flag_subbios    25bd     
flag_unsupported 25bb     
force_default_bios 202a     
force_subst     2030     
ftop           =4000     
get_drvinfo_ptr 29c1     
get_lp          2a65     
get_mount_info  2a58     
getbyte         2231     
getch           22da     
getsec          22aa     
gsl             22b2     
h1d             225c     
hcrlf           235f     
hex1            2251     
hex2            2260     
hex4            226f     
hexw            227a     
hl_after_do_patch_patch 272a     
hmbase          232c     
hmls            2354     
hmps            233a     
hmrun           2332     
hmsg            22f1     
hmsp            234d     
hmss            2345     
hw_check_floppy 24bc     
hw_check_gzu_size 24cf     
hw_check_rom    2522     
hw_fdc_present  23eb     
hw_fdd_drive_a  23ec     
hw_fdd_drive_b  23ed     
hw_fdd_drive_c  23ee     
hw_fdd_drive_d  23ef     
hw_gzu_size     23ea     
hw_rom_model    23e9     
hw_rom_opts_class 23e8     
hw_test         24af     
il              20d7     
initlut         221d     
l_pw_chk        277d     
l_pw_store      27a2     
ld_loop         2139     
ld_loop_sec0    2135     
load_done       2167     
loader          4080     
loadr           22ea     
lspt            22f0     
max_resident_cpm1_len= 2fa     
max_resident_cpm2_len= 3f7     
md_dma          fb0e     
md_drv2         faf2     
md_exr_cmd      fb0a     
md_exr_drv      fb0b     
md_exr_getbyte  fa6d     
md_exr_getsec   fa8d     
md_exr_putbyte  fa7c     
md_exr_putsec   faa9     
md_exr_readinfo faec     
md_exr_sec      fb0d     
md_exr_sendcmd  fac5     
md_exr_trk      fb0c     
md_fetch_params fa18     
md_old_seld_dsk fa11     
md_param2       fa1c     
md_pgsl         fa96     
md_ppsl         fab2     
md_pscl         fad4     
md_pwg          fa71     
md_pwp          fa81     
md_rdbuf2       fb01     
md_read         fa3e     
md_read_infosector fa68     
md_res_drive_tab fa02     
md_res_drivea   fa00     
md_res_driveb   fa01     
md_res_seldsk   fa0e     
md_rpcwr       =fe0b     
md_rporta      =fe08     
md_rportc      =fe0a     
md_rrbuff      =   0     
md_write        fa53     
mount_crlf      2ad5     
mount_info_from_emu 2ab7     
mount_msg       2a7e     
mount_msg_drv   2a7e     
mount_msg_rw    2a80     
move_microdos_resident 26fe     
msg_default_mount 2a71     
msg_fdc         2453     
msg_fdd         2aa4     
msg_fdd_drv     2aab     
msg_fdd_err     2aad     
msg_gzu_size    244a     
msg_invalidpatchcode 2832     
msg_rom_model   2444     
msg_strangehlafterpatch 287a     
msg_tab16_fdc   2428     
msg_tab8_gzu_size 2410     
msg_tab8_rom_model 23f0     
msg_warning     25be     
msgask_subst    2380     
msgbadbootparam 21a1     
msgbootfromimage 28d9     
msgcpm          2364     
msgcrlf         2628     
msgdrive_f      2ad8     
msgforceddefaultbios 23a6     
msgfound        25e4     
msgmicrodos     2369     
msgnotfound     25ef     
msgpatcher      25c0     
msgreq_opts     262b     
msgreq_opts_digit 2643     
msgsubst        2372     
msgundefindedsubbios 2857     
msgzerodrvinfotab 29e0     
mute_flag       2362     
ncreg          =fe3a     
out_buffer      2a83     
p_stop         =  50     
patch_done      2725     
patch_flag      2672     
patch_loop      2737     
pb_chk_patch   =  52     
pb_maybe_patch =  59     
pchdrv         =  4c     
pnotsupported  =  55     
porta          =fb08     
portc          =fb0a     
prequired_opts1=  57     
prequired_opts2=  58     
psetflag_microdos=  56     
pstr            22c5     
psubbios       =  5a     
putbyte         2240     
putch           22cf     
putstr16        245b     
putstr8         2464     
putstr_         246d     
putx8           2469     
pw_chk_patch   =  51     
pw_store       =  54     
read_de_at_tmp  28c0     
receive_c_bytes_to_hl 2a62     
resident_cpm1  =2b17     
resident_cpm1_addr=e8ac     
resident_cpm1_len= 197     
resident_cpm2  =2cae     
resident_cpm2_addr=ea06     
resident_cpm2_len= 197     
resident_md     2e45     
resident_md_addr=fa00     
resident_md_len= 110     
restart_disable 2086     
rpcwr          =fb0b     
rporta         =fb08     
rportc         =fb0a     
runadr          22ec     
scl             2293     
scount          22ee     
sec             22e9     
secbuf         =4000     
sendcmd         228a     
set_opts_warning 2817     
set_subst       2082     
show_boot_image_name 28f8     
show_disk_info  298c     
show_hardware_info 247b     
show_mount_drive 2935     
show_mount_info 290f     
showbootparams  21dd     
skip_disk       2997     
skip_msg_1      20fe     
skip_msg_2      212c     
skip_msg_star   214b     
ssize           22ef     
ssl1            2108     
ssl2            2110     
start           2008     
store_bc_at_tmp 28b7     
store_bc_to_tmp 28ae     
sysreg14       =fa7f     
sysreg3c       =ff7f     
sysreg5c       =ff7f     
tmp             28ac     
tmpkey          2363     
tram           =fc00     
trk             22e8     
try_bios        2673     
unsupported     2822     
vireg          =ffbf     
waitkey         204d     
wg              2235     
work_ptr        2670     
wp              2245     
