binary-debuggable-source
0000 0000 f stage2.asm
0000 0000 s ;**********************************************************************************************
0000 0000 s ;*  Загрузчик 2 фазы дискового эмулятора Korvet-Extrom
0000 0000 s ;*  Работает только в паре с контроллером Extrom через боковой разъем корвета
0000 0000 s ;*
0000 0000 s ;*  Загружает в память системные дорожки диска А и передает управление на код инициализации BIOS
0000 0000 s ;*   Сборка с помощью кросс-ассемблера z80asm, контрольная сумма рассчитывается утилитой ercs
0000 0000 s ;*
0000 0000 s ;*   Программа записывается на карту SD контроллера в файл LOADER.BIN
0000 0000 s ;**********************************************************************************************
0000 0000 s BASE	EQU	2000H		; База для размещения этого кода
0000 0000 s PORTA	EQU     0FB08H		; Порт A ВВ55 #3
0000 0000 s PORTC	EQU     0FB0AH		; Порт C ВВ55 #3
0000 0000 s TRAM	EQU	0FC00H		; Начало видеопамяти
0000 0000 s 
0000 0000 s SYSREG14  EQU	0FA7FH		; регистр карты памяти
0000 0000 s SYSREG5C  EQU	0FF7FH		; регистр карты памяти
0000 0000 s ; SYSREG6C  EQU	0BF7FH
0000 0000 s SYSREG3C  EQU	0FF7FH
0000 0000 s 
0000 0000 s PCHDRV	EQU	4Ch		; подпрограмма печати байта через драйвер консоли ОПТС
0000 0000 s CONIN	EQU	49h		; подпрограмма ввода символа через драйвер консоли ОПТС
0000 0000 s 
0000 0000 s 
0000 0000 s ; started in config 14
0000 0000 s ; 	14  NDOS   0-1FFF  2000-F7FF                   F800  FA00  FC00  FB00
0000 0000 s 
2000 2000 s 	ORG   	BASE
2000 2000 s 
2000 2000 s ; Стандартный заголовок внешнего ПЗУ корвета
2000 2000 d c30820
2000 2000 s 	JP	START	        ; +0
2003 2003 d 00
2003 2003 s 	DB      0		; +3
2004 2004 d 0820
2004 2004 s 	DW	START           ; +4 - адрес запуска 
2006 2006 d 20
2006 2006 s 	DB	BASE>>8         ; +6 - старшие 8 бит адреса загрузки (младшие всегда 00)
2007 2007 d 20
2007 2007 s 	DB	(FTOP-BASE)>>8  ; +7 - количество загружаемых 256-байтовых блоков
2008 2008 s 
2008 2008 s 
2008 2008 s ; Далее идет непосредственный программный код	
2008 2008 s START:
2008 2008 d f3
2008 2008 s 	DI
2009 2009 d 3100f7
2009 2009 s 	LD	SP,0F700h	; рабочий стек, размещаем в области F-макросов драйвера клавиатуры
200c 200c s 
200c 200c d cd1d22
200c 200c s 	call 	initLUT
200f 200f s 
200f 200f s ; Печать промпта 	
200f 200f d 21f122
200f 200f s 	LD	HL,HMSG
2012 2012 d cdc522
2012 2012 s 	CALL	PSTR
2015 2015 s 
2015 2015 d cdaf24
2015 2015 s 	call 	hw_test
2018 2018 s ; 	halt
2018 2018 s 
2018 2018 s 
2018 2018 d af
2018 2018 s 	xor 	a
2019 2019 d 32bc25
2019 2019 s 	ld 	(flag_microdos),a
201c 201c s 
201c 201c d 3a80f8
201c 201c s 	ld 	a,(0xf880)
201f 201f d e621
201f 201f s 	and 	0x21 		;ctrl+shift
2021 2021 d fe21
2021 2021 s 	cp 	0x21
2023 2023 s 
2023 2023 d ca2a20
2023 2023 s 	jp 	z,force_default_bios
2026 2026 d af
2026 2026 s 	xor 	a		;turn off system substitution
2027 2027 d c38620
2027 2027 s 	jp 	restart_disable
202a 202a s 
202a 202a s force_default_bios:
202a 202a d 21a623
202a 202a s 	ld 	hl,msgFORCEDDEFAULTBIOS
202d 202d d cdc522
202d 202d s 	call 	PSTR
2030 2030 s ; 	jp 	set_subst
2030 2030 s 
2030 2030 s force_subst:
2030 2030 s ; 	ld 	hl,msgFORCEDDEFAULTBIOS
2030 2030 s ; 	call 	PSTR
2030 2030 s 
2030 2030 d 217223
2030 2030 s 	ld 	hl,msgSUBST
2033 2033 d cdc522
2033 2033 s 	call 	PSTR
2036 2036 s 
2036 2036 d 3abc25
2036 2036 s 	ld 	a,(flag_microdos)
2039 2039 s 
2039 2039 d 216923
2039 2039 s 	ld 	hl,msgMICRODOS
203c 203c d fe01
203c 203c s 	cp 	1
203e 203e d ca4420
203e 203e s 	jp 	z,.print
2041 2041 d 216423
2041 2041 s 	ld 	hl,msgCPM
2044 2044 s .print:
2044 2044 d cdc522
2044 2044 s 	call 	PSTR
2047 2047 s 
2047 2047 d 218023
2047 2047 s 	ld 	hl,msgASK_SUBST
204a 204a d cdc522
204a 204a s 	call 	PSTR
204d 204d s 
204d 204d s WaitKey:
204d 204d d 3e07
204d 204d s 	ld 	a,7
204f 204f d cdcf22
204f 204f s 	call 	PUTCH
2052 2052 d cdda22
2052 2052 s 	call 	GETCH
2055 2055 d e65f
2055 2055 s 	and 	0x5F
2057 2057 s 
2057 2057 d fe0d
2057 2057 s 	cp 	0x0d 	;CR
2059 2059 d c25e20
2059 2059 s 	jp 	nz,.printKEY
205c 205c s 
205c 205c d 3e59
205c 205c s 	ld 	a,'Y'
205e 205e s 
205e 205e s .printKEY:
205e 205e d 326323
205e 205e s 	ld 	(tmpKEY),a
2061 2061 s 
2061 2061 d fe59
2061 2061 s 	cp 	'Y'
2063 2063 d ca8220
2063 2063 s 	jp 	z,set_subst
2066 2066 d fe44
2066 2066 s 	cp 	'D'
2068 2068 d ca8220
2068 2068 s 	jp 	z,set_subst
206b 206b s 
206b 206b d fe43
206b 206b s 	cp 	a,'C'
206d 206d d c27820
206d 206d s 	jp 	nz,.chkM
2070 2070 s 
2070 2070 d 3e00
2070 2070 s 	ld 	a,0
2072 2072 d 32bc25
2072 2072 s 	ld 	(flag_microdos),a
2075 2075 d c38220
2075 2075 s 	jp 	set_subst
2078 2078 s .chkM:
2078 2078 d fe4d
2078 2078 s 	cp 	'M'
207a 207a d c24d20
207a 207a s 	jp 	nz,WaitKey
207d 207d d 3e01
207d 207d s 	ld 	a,1	
207f 207f d 32bc25
207f 207f s 	ld 	(flag_microdos),a
2082 2082 s 
2082 2082 s 
2082 2082 s set_subst:
2082 2082 d 3abc25
2082 2082 s 	ld 	a,(flag_microdos)
2085 2085 d 3c
2085 2085 s 	inc 	a
2086 2086 s 
2086 2086 s restart_disable:
2086 2086 d 32e822
2086 2086 s 	ld 	(TRK),A
2089 2089 d 3ea0
2089 2089 s 	ld 	a,0xA0 		;system substitution
208b 208b d 32e622
208b 208b s 	ld 	(CMD),a
208e 208e d af
208e 208e s 	xor 	a
208f 208f d 32e722
208f 208f s 	ld 	(DRV),a
2092 2092 d cd8a22
2092 2092 s 	call 	SENDCMD
2095 2095 s 
2095 2095 d 3a6323
2095 2095 s 	ld 	a,(tmpKEY)
2098 2098 d b7
2098 2098 s 	or 	a
2099 2099 d caa520
2099 2099 s 	jp 	z,.noPrintKey
209c 209c d cdcf22
209c 209c s 	call 	PUTCH
209f 209f d 215f23
209f 209f s 	ld 	hl,HCRLF
20a2 20a2 d cdc522
20a2 20a2 s 	call	PSTR 	
20a5 20a5 s 
20a5 20a5 s .noPrintKey:
20a5 20a5 s 
20a5 20a5 s 
20a5 20a5 d 3e00
20a5 20a5 s 	ld 	a,0
20a7 20a7 d 32bb25
20a7 20a7 s 	ld 	(flag_unsupported),a
20aa 20aa d 32bc25
20aa 20aa s 	ld 	(flag_microdos),a
20ad 20ad d 210000
20ad 20ad s 	ld 	hl,0
20b0 20b0 d 22be25
20b0 20b0 s 	ld 	(msg_warning),hl
20b3 20b3 s 
20b3 20b3 d f3
20b3 20b3 s 	DI
20b4 20b4 d 3100f7
20b4 20b4 s 	LD	SP,0F700h	; рабочий стек, размещаем в области F-макросов драйвера клавиатуры
20b7 20b7 s 
20b7 20b7 d cdf828
20b7 20b7 s 	call 	show_boot_image_name
20ba 20ba s 
20ba 20ba s ; Загрузка инфосектора
20ba 20ba s 
20ba 20ba d 3e01
20ba 20ba s 	ld 	a,0x1 		;read
20bc 20bc d 32e622
20bc 20bc s 	ld 	(CMD),a
20bf 20bf d af
20bf 20bf s 	xor 	a
20c0 20c0 d 32e822
20c0 20c0 s 	ld 	(TRK),A
20c3 20c3 d 32e922
20c3 20c3 s 	ld 	(SEC),A
20c6 20c6 s 
20c6 20c6 s 
20c6 20c6 d cd8a22
20c6 20c6 s 	CALL	SENDCMD		; отсылаем команду загрузки сектора, параметры уже прописаны в командном блоке
20c9 20c9 d 210040
20c9 20c9 s 	LD	HL,SECBUF
20cc 20cc d cdaa22
20cc 20cc s 	CALL	GETSEC		; забираем 256 байт сектора 0
20cf 20cf s 
20cf 20cf s ; Разбор инфосектора
20cf 20cf s ;
20cf 20cf s ; Вынимаем идущие подряд переменные LOADR, RUNADR, COUNT
20cf 20cf s ;
20cf 20cf s 
20cf 20cf s ;TODO: add crc check!!!!!!!!!!!!!!!
20cf 20cf s 
20cf 20cf d 210040
20cf 20cf s 	LD	HL,SECBUF
20d2 20d2 d 11ea22
20d2 20d2 s 	LD	DE,LOADR	; начало блока переменных в памяти
20d5 20d5 d 0e05
20d5 20d5 s 	LD	C,5		; всего 5 байтов
20d7 20d7 s IL:
20d7 20d7 d 7e
20d7 20d7 s 	LD	A,(HL)		; копируем блок переменных
20d8 20d8 d 12
20d8 20d8 s 	LD	(DE),A
20d9 20d9 d 23
20d9 20d9 s 	INC	HL
20da 20da d 13
20da 20da s 	INC	DE
20db 20db d 0d
20db 20db s 	DEC	C
20dc 20dc d c2d720
20dc 20dc s 	JP	NZ,IL
20df 20df s 
20df 20df s ; Получаем индекс размера сектора
20df 20df d 210a40
20df 20df s 	LD	HL,SECBUF+10	;  +10 - коэффициент блокирования секторов
20e2 20e2 d 7e
20e2 20e2 s 	LD	A,(HL)
20e3 20e3 d 12
20e3 20e3 s 	LD	(DE),A
20e4 20e4 d 13
20e4 20e4 s 	INC	DE
20e5 20e5 d 211040
20e5 20e5 s 	LD	HL,SECBUF+16	;  +16 - LSPT
20e8 20e8 d 7e
20e8 20e8 s 	LD	A,(HL)
20e9 20e9 d 12
20e9 20e9 s 	LD	(DE),A
20ea 20ea s 
20ea 20ea d cd6e21
20ea 20ea s 	call 	CheckBootParams
20ed 20ed d c23020
20ed 20ed s 	jp 	nz,force_subst
20f0 20f0 s 	
20f0 20f0 d 3a80f8
20f0 20f0 s 	ld 	a,(0xf880)
20f3 20f3 d e601
20f3 20f3 s 	and 	0x1
20f5 20f5 d 326223
20f5 20f5 s 	ld 	(mute_flag),a
20f8 20f8 d cafe20
20f8 20f8 s 	jp 	z,skip_msg_1
20fb 20fb s 
20fb 20fb d cddd21
20fb 20fb s 	call 	ShowBootParams
20fe 20fe s 
20fe 20fe s skip_msg_1:
20fe 20fe s 		
20fe 20fe s ; Вычисление числа полных дорожек для загрузки	
20fe 20fe s 	
20fe 20fe d 21ee22
20fe 20fe s 	LD	HL,SCOUNT	
2101 2101 d 5e
2101 2101 s 	LD	E,(HL)		; число загружаемых физических секторов
2102 2102 d 1600
2102 2102 s 	LD	D,0		; -> DE
2104 2104 d 23
2104 2104 s 	INC	HL
2105 2105 d 4e
2105 2105 s 	LD	C,(HL)		; индекс размера сектора
2106 2106 s ;
2106 2106 s ; Индекс размера - очень удобная величина, определяющая коэффициент блокирования секторов, то есть число логических секторов в физическом
2106 2106 s ; Размер логического сектора CP/M - всегда 128 байт.
2106 2106 s ;
2106 2106 s ;  Физ.сектор   SSIZE    коэффициент блокирования
2106 2106 s ;----------------------------------------------------
2106 2106 s ;     128         0                1
2106 2106 s ;     256         1                2
2106 2106 s ;     512         2                4
2106 2106 s ;     1024        3                8 
2106 2106 s ;
2106 2106 s ;
2106 2106 s ; Далее выполняется операция DE << C, что приводит к умножению числа физических секторов
2106 2106 s ; на коэффициент блокирования - получаем число загружаемых логических секторов
2106 2106 d eb
2106 2106 s 	ex 	de,hl
2107 2107 d 0c
2107 2107 s 	INC	C		; Коррекция SSIZE, чтобы начинался с 1
2108 2108 s SSL1:	
2108 2108 d 0d
2108 2108 s 	DEC	C		; счетчик сдвига--
2109 2109 d ca1021
2109 2109 s 	JP	Z,SSL2		; сдвиг окончен
210c 210c s ; 	XOR	A		; CF=0
210c 210c s ; 	LD	A,E
210c 210c s ; 	RLA			; сдвигаем младший байт
210c 210c s ; 	LD	E,A
210c 210c s ; 	LD	A,D
210c 210c s ; 	RLA			; сдвигаем старший байт
210c 210c s ; 	LD	D,A
210c 210c d 29
210c 210c s 	add 	hl,hl
210d 210d d c30821
210d 210d s 	JP	SSL1
2110 2110 s ;
2110 2110 s ;  Выводим на экран число логических секторов
2110 2110 s ;
2110 2110 s SSL2:
2110 2110 d eb
2110 2110 s 	ex 	de,hl
2111 2111 d 3a6223
2111 2111 s 	ld 	a,(mute_flag)
2114 2114 d b7
2114 2114 s 	or 	a
2115 2115 d ca2c21
2115 2115 s 	jp 	z,skip_msg_2
2118 2118 s 
2118 2118 d 215423
2118 2118 s 	LD	HL,HMLS
211b 211b d cdc522
211b 211b s 	CALL	PSTR
211e 211e d 7a
211e 211e s 	LD	A,D
211f 211f d cd6022
211f 211f s 	CALL	HEX2
2122 2122 d 7b
2122 2122 s 	LD	A,E
2123 2123 d cd6022
2123 2123 s 	CALL	HEX2
2126 2126 s 
2126 2126 d 215f23
2126 2126 s 	LD	HL,HCRLF
2129 2129 d cdc522
2129 2129 s 	CALL	PSTR
212c 212c s 
212c 212c s 	;de - sectors to load
212c 212c s 
212c 212c s skip_msg_2:
212c 212c s 
212c 212c s 	;DE - sectors to load
212c 212c s 
212c 212c d 4b
212c 212c s 	ld 	c,e 		; C - sectors to load (up to 32k)
212d 212d d 2aea22
212d 212d s 	LD	HL,(LOADR)	; HL - указатель позиции загрузки в памяти
2130 2130 s 
2130 2130 d af
2130 2130 s 	xor 	a
2131 2131 d 32e822
2131 2131 s 	ld 	(TRK),a
2134 2134 s 
2134 2134 d 0c
2134 2134 s 	inc 	c
2135 2135 s 
2135 2135 s ld_loop_sec0:
2135 2135 d af
2135 2135 s 	xor 	a
2136 2136 d 32e922
2136 2136 s 	ld 	(SEC),a
2139 2139 s 
2139 2139 s ld_loop:
2139 2139 s 
2139 2139 d 0d
2139 2139 s 	dec 	c
213a 213a d 79
213a 213a s 	ld 	a,c
213b 213b d b7
213b 213b s 	or 	a
213c 213c d ca6721
213c 213c s 	jp 	z,load_done
213f 213f s 
213f 213f d 3a6223
213f 213f s 	ld 	a,(mute_flag)
2142 2142 d b7
2142 2142 s 	or 	a
2143 2143 d ca4b21
2143 2143 s 	jp 	z,skip_msg_star
2146 2146 s 
2146 2146 d 3e2a
2146 2146 s 	LD	A,'*'		; прогресс-бар загружаемых секторов
2148 2148 d cdcf22
2148 2148 s 	CALL	PUTCH
214b 214b s skip_msg_star:
214b 214b s 	
214b 214b s 
214b 214b d cd8a22
214b 214b s 	CALL	SENDCMD		; отправляем команду
214e 214e d cdaa22
214e 214e s 	CALL	GETSEC		; получаем и размещаем сектор
2151 2151 s 
2151 2151 d e5
2151 2151 s 	PUSH	HL
2152 2152 d 21e922
2152 2152 s 	LD	HL,SEC
2155 2155 d 34
2155 2155 s 	INC	(HL)		; номер сектора ++
2156 2156 s 
2156 2156 d 3af022
2156 2156 s 	ld 	a,(LSPT)
2159 2159 d be
2159 2159 s 	cp 	(hl)
215a 215a d e1
215a 215a s 	POP	HL
215b 215b s 
215b 215b d c23921
215b 215b s 	jp 	nz,ld_loop
215e 215e s 
215e 215e d e5
215e 215e s 	PUSH	HL
215f 215f d 21e822
215f 215f s 	LD	HL,TRK
2162 2162 d 34
2162 2162 s 	INC	(HL)		; номер сектора ++
2163 2163 d e1
2163 2163 s 	POP	HL
2164 2164 d c33521
2164 2164 s 	jp 	ld_loop_sec0
2167 2167 s 
2167 2167 s load_done:
2167 2167 s ; 	halt
2167 2167 s 
2167 2167 s ; Вся системная область диска загружена - можно запускать ОС
2167 2167 s ;	
2167 2167 s ; 	LD	A,'@'		; Признак окончания загрузки - на экран
2167 2167 s ; 	CALL	PUTCH
2167 2167 s 
2167 2167 d cd5625
2167 2167 s 	call 	cpm_bios_patcher
216a 216a s 
216a 216a s ; 	LD	HL,SYSREG14	
216a 216a s ; 	LD	(HL),1Ch	; Включаем карту памяти 1С, для CP/M
216a 216a s 	
216a 216a s 	;start with sysreg=14
216a 216a s 
216a 216a d 2aec22
216a 216a s 	LD	HL,(RUNADR)
216d 216d d e9
216d 216d s 	JP	(HL)		; уходим по адресу запуска
216e 216e s 	
216e 216e s CheckBootParams:
216e 216e s 
216e 216e d 21ea22
216e 216e s 	LD	HL,LOADR
2171 2171 d cd8522
2171 2171 s 	call 	FetchDEfromHL
2174 2174 s 
2174 2174 d 7a
2174 2174 s 	ld 	a,d
2175 2175 d fe22
2175 2175 s 	cp 	0x22 		; load addr shiould be >0x2200
2177 2177 d da9521
2177 2177 s 	jp 	c,.BadBootParam
217a 217a s 
217a 217a d 21ec22
217a 217a s 	LD	HL,RUNADR
217d 217d d cd8522
217d 217d s 	call 	FetchDEfromHL
2180 2180 d 7a
2180 2180 s 	ld 	a,d
2181 2181 d fe22
2181 2181 s 	cp 	0x22 		; run addr shiould be >0x2200
2183 2183 d da9521
2183 2183 s 	jp 	c,.BadBootParam
2186 2186 s 
2186 2186 d 21ee22
2186 2186 s 	LD	HL,SCOUNT
2189 2189 d 7e
2189 2189 s 	LD	A,(HL)
218a 218a d b7
218a 218a s 	or 	a
218b 218b d ca9521
218b 218b s 	jp 	z,.BadBootParam
218e 218e d fe30
218e 218e s 	cp 	48 		;sectors to load < 48
2190 2190 d d29521
2190 2190 s 	jp 	nc,.BadBootParam
2193 2193 s 
2193 2193 d af
2193 2193 s 	xor 	a
2194 2194 d c9
2194 2194 s 	ret
2195 2195 s 
2195 2195 s .BadBootParam:
2195 2195 d cddd21
2195 2195 s 	call 	ShowBootParams
2198 2198 d 21a121
2198 2198 s 	ld 	hl,msgBadBootParam
219b 219b d cdc522
219b 219b s 	CALL	PSTR
219e 219e d af
219e 219e s 	xor 	a
219f 219f d 3c
219f 219f s 	inc 	a
21a0 21a0 d c9
21a0 21a0 s 	ret
21a1 21a1 s 
21a1 21a1 s msgBadBootParam:
21a1 21a1 d 0d0a
21a1 21a1 s 	db 	0x0d,0x0a
21a3 21a3 d 496e636f727265637420626f6f7420706172616d65746572732064657465637465642c2066616c6c6261636b20746f2064656661756c74
21a3 21a3 s 	db 	'Incorrect boot parameters detected, fallback to default'
21da 21da d 0d0a00
21da 21da s 	db 	0x0d,0x0a,0
21dd 21dd s 
21dd 21dd s ShowBootParams:
21dd 21dd s 	; Вывод параметров загрузки на экран
21dd 21dd d 212c23
21dd 21dd s 	LD	HL,HMBASE
21e0 21e0 d cdc522
21e0 21e0 s 	CALL	PSTR
21e3 21e3 d 21ea22
21e3 21e3 s 	LD	HL,LOADR
21e6 21e6 d cd7a22
21e6 21e6 s 	CALL	HEXW
21e9 21e9 d 213223
21e9 21e9 s 	LD	HL,HMRUN
21ec 21ec d cdc522
21ec 21ec s 	CALL	PSTR
21ef 21ef d 21ec22
21ef 21ef s 	LD	HL,RUNADR
21f2 21f2 d cd7a22
21f2 21f2 s 	CALL	HEXW
21f5 21f5 d 213a23
21f5 21f5 s 	LD	HL,HMPS
21f8 21f8 d cdc522
21f8 21f8 s 	CALL	PSTR
21fb 21fb d 21ee22
21fb 21fb s 	LD	HL,SCOUNT
21fe 21fe d 7e
21fe 21fe s 	LD	A,(HL)
21ff 21ff d cd6022
21ff 21ff s 	CALL	HEX2
2202 2202 d 214523
2202 2202 s 	LD	HL,HMSS
2205 2205 d cdc522
2205 2205 s 	CALL	PSTR
2208 2208 d 21ef22
2208 2208 s 	LD	HL,SSIZE
220b 220b d 7e
220b 220b s 	LD	A,(HL)
220c 220c d cd6022
220c 220c s 	CALL	HEX2
220f 220f d 214d23
220f 220f s 	LD	HL,HMSP
2212 2212 d cdc522
2212 2212 s 	CALL	PSTR
2215 2215 d 21f022
2215 2215 s 	LD	HL,LSPT
2218 2218 d 7e
2218 2218 s 	LD	A,(HL)
2219 2219 d cd6022
2219 2219 s 	CALL	HEX2
221c 221c d c9
221c 221c s 	ret
221d 221d s 
221d 221d s initLUT:
221d 221d d 21fbfa
221d 221d s 	ld      hl, 0xFAFB
2220 2220 d 3ef8
2220 2220 s 	ld      a, 0F8h 
2222 2222 s 
2222 2222 s .iniLUT:                  
2222 2222 d 77
2222 2222 s 	ld      (hl), a         ; F8,F9,FA,FB,FC,FD,FE,FF
2223 2223 d 3c
2223 2223 s 	inc     a
2224 2224 d c22222
2224 2224 s 	jp      nz, .iniLUT      ; F8,F9,FA,FB,FC,FD,FE,FF
2227 2227 s 	
2227 2227 d 010811
2227 2227 s 	ld      bc, 1108h       ; A=0
222a 222a s 	
222a 222a s .iniLUTGRP:                  
222a 222a d 77
222a 222a s 	ld      (hl), a         ; 00,11,22,33,44,55,66,77
222b 222b d 80
222b 222b s 	add     a, b
222c 222c d 0d
222c 222c s 	dec     c
222d 222d d c22a22
222d 222d s 	jp      nz, .iniLUTGRP   ; 00,11,22,33,44,55,66,77
2230 2230 s 
2230 2230 d c9
2230 2230 s 	ret
2231 2231 s 
2231 2231 s 
2231 2231 s ;****************************************
2231 2231 s ;*  Прием байта из порта А по стробу    *
2231 2231 s ;****************************************
2231 2231 s GETBYTE:
2231 2231 d e5
2231 2231 s 	PUSH	HL
2232 2232 d 210afb
2232 2232 s 	LD	HL,PORTC
2235 2235 s WG:
2235 2235 d 7e
2235 2235 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2236 2236 d e620
2236 2236 s 	AND	20h		; выделяем сигнал IBF
2238 2238 d ca3522
2238 2238 s 	JP	Z,WG		; IBF=0 - данных еще нет
223b 223b d 2d
223b 223b s 	DEC	L
223c 223c d 2d
223c 223c s 	DEC	L
223d 223d d 7e
223d 223d s 	LD	A,(HL)		; данные поступили - выбираем их из порта А
223e 223e d e1
223e 223e s 	POP	HL
223f 223f d c9
223f 223f s 	RET
2240 2240 s 
2240 2240 s ;****************************************
2240 2240 s ;*  Отправка байта в порт A             *
2240 2240 s ;****************************************
2240 2240 s PUTBYTE:
2240 2240 d e5
2240 2240 s 	PUSH	HL
2241 2241 d f5
2241 2241 s 	PUSH	AF
2242 2242 d 210afb
2242 2242 s 	LD	HL,PORTC
2245 2245 s WP:
2245 2245 d 7e
2245 2245 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2246 2246 d e680
2246 2246 s 	AND	80h		; выделяем сигнал -OBF
2248 2248 d ca4522
2248 2248 s 	JP	Z,WP		; -OBF=0 - в передатчике сидит незабранный байт
224b 224b d 2d
224b 224b s 	DEC	L
224c 224c d 2d
224c 224c s 	DEC	L
224d 224d d f1
224d 224d s 	POP	AF
224e 224e d 77
224e 224e s 	LD	(HL),A		; отправляем данные в порт данных
224f 224f d e1
224f 224f s 	POP	HL
2250 2250 d c9
2250 2250 s 	RET
2251 2251 s 
2251 2251 s ;****************************************
2251 2251 s ;*      Печать полубайта в HEX          *
2251 2251 s ;****************************************
2251 2251 s 
2251 2251 s HEX1:
2251 2251 d e60f
2251 2251 s 	AND	0Fh		; младший полубайт 
2253 2253 d c630
2253 2253 s 	ADD	'0'		; в ASCII
2255 2255 d fe3a
2255 2255 s 	CP	3Ah		; 0-9?
2257 2257 d da5c22
2257 2257 s 	JP	C,H1D		; да
225a 225a d c607
225a 225a s 	ADD	7		; коррекция до A-F
225c 225c d cdcf22
225c 225c s H1D:	CALL	PUTCH		; Печать байта
225f 225f d c9
225f 225f s 	RET
2260 2260 s 
2260 2260 s ;****************************************
2260 2260 s ;*      Печать байта в HEX              *
2260 2260 s ;****************************************
2260 2260 s 
2260 2260 d f5
2260 2260 s HEX2:	PUSH	AF
2261 2261 d 0f
2261 2261 s 	RRCA
2262 2262 d 0f
2262 2262 s 	RRCA			; сдвигаем старший полубайт в младший
2263 2263 d 0f
2263 2263 s 	RRCA
2264 2264 d 0f
2264 2264 s 	RRCA
2265 2265 d cd5122
2265 2265 s 	CALL	HEX1		; печатаем его
2268 2268 d f1
2268 2268 s 	POP	AF
2269 2269 d e60f
2269 2269 s 	AND	0Fh		
226b 226b d cd5122
226b 226b s 	CALL	HEX1		; печатаем младший полубайт
226e 226e d c9
226e 226e s 	RET
226f 226f s 
226f 226f s HEX4:
226f 226f d f5
226f 226f s 	push 	AF
2270 2270 d 7c
2270 2270 s 	ld 	a,h
2271 2271 d cd6022
2271 2271 s 	call 	HEX2
2274 2274 d 7d
2274 2274 s 	ld 	a,l
2275 2275 d cd6022
2275 2275 s 	call 	HEX2
2278 2278 d f1
2278 2278 s 	pop 	AF
2279 2279 d c9
2279 2279 s 	ret
227a 227a s ;****************************************
227a 227a s ;*  Печать слова (2 байта) из (HL)      *
227a 227a s ;****************************************
227a 227a s HEXW:
227a 227a d 23
227a 227a s 	INC	HL
227b 227b d 7e
227b 227b s 	LD	A,(HL)		; старший байт
227c 227c d cd6022
227c 227c s 	CALL	HEX2
227f 227f d 2b
227f 227f s 	DEC	HL		; младший байт
2280 2280 d 7e
2280 2280 s 	LD	A,(HL)
2281 2281 d cd6022
2281 2281 s 	CALL	HEX2
2284 2284 d c9
2284 2284 s 	RET
2285 2285 s 
2285 2285 s FetchDEfromHL:
2285 2285 d 5e
2285 2285 s 	LD	E,(HL)
2286 2286 d 23
2286 2286 s 	INC	HL
2287 2287 d 56
2287 2287 s 	LD	D,(HL)		; старший байт
2288 2288 d 2b
2288 2288 s 	DEC	HL		; младший байт
2289 2289 d c9
2289 2289 s 	RET
228a 228a s 	
228a 228a s 		
228a 228a s ;****************************************
228a 228a s ;*     Отправка командного пакета       *
228a 228a s ;****************************************
228a 228a s SENDCMD:
228a 228a d e5
228a 228a s 	PUSH	HL
228b 228b d c5
228b 228b s 	PUSH	BC
228c 228c d 21e622
228c 228c s 	LD	HL,CMD
228f 228f d 0e04
228f 228f s 	LD	C,4		; пакет - 4 байта
2291 2291 d 0600
2291 2291 s 	LD	B,0		; заготовка контрольной суммы
2293 2293 s SCL:
2293 2293 d 7e
2293 2293 s 	LD	A,(HL)		; очередной байт пакета 
2294 2294 d 80
2294 2294 s 	ADD 	B		; добавляем к КС
2295 2295 d 47
2295 2295 s 	LD	B,A
2296 2296 d 7e
2296 2296 s 	LD	A,(HL)		; очередной байт пакета 
2297 2297 d cd4022
2297 2297 s 	CALL	PUTBYTE		; - в порт
229a 229a d 23
229a 229a s 	INC	HL
229b 229b d 0d
229b 229b s 	DEC	C
229c 229c d c29322
229c 229c s 	JP	NZ,SCL
229f 229f d 78
229f 229f s 	LD	A,B
22a0 22a0 d 3d
22a0 22a0 s 	DEC 	A		; КС-1
22a1 22a1 d cd4022
22a1 22a1 s 	CALL	PUTBYTE     ; контрольная сумма
22a4 22a4 d cd3122
22a4 22a4 s 	CALL	GETBYTE	    ; ответ контроллера
22a7 22a7 d c1
22a7 22a7 s 	POP	BC
22a8 22a8 d e1
22a8 22a8 s 	POP	HL
22a9 22a9 d c9
22a9 22a9 s 	RET
22aa 22aa s 	
22aa 22aa s 	
22aa 22aa s ;*******************************************
22aa 22aa s ;*      Прием сектора                      *
22aa 22aa s ;* HL - адрес размещения сектора в памяти  *
22aa 22aa s ;*  Размер сектора - 128 байт              *
22aa 22aa s ;*******************************************
22aa 22aa s GETSEC:
22aa 22aa d c5
22aa 22aa s 	PUSH	BC
22ab 22ab d d5
22ab 22ab s 	PUSH	DE
22ac 22ac d 0e80
22ac 22ac s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
22ae 22ae d eb
22ae 22ae s 	EX	DE,HL		; адрес буфера -> DE
22af 22af d 210afb
22af 22af s 	LD	HL,PORTC
22b2 22b2 s GSL:
22b2 22b2 d 7e
22b2 22b2 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
22b3 22b3 d e620
22b3 22b3 s 	AND	20h		; выделяем сигнал IBF
22b5 22b5 d cab222
22b5 22b5 s 	JP	Z,GSL		; IBF=0 - данных еще нет
22b8 22b8 d 3a08fb
22b8 22b8 s 	LD	A,(PORTA)		; данные поступили - выбираем их из порта А
22bb 22bb d 12
22bb 22bb s 	LD	(DE),A		; принимаем и размещаем очередной байт
22bc 22bc d 13
22bc 22bc s 	INC	DE		; указатель буфера ++
22bd 22bd d 0d
22bd 22bd s 	DEC	C		; принимаем остальные байты
22be 22be d c2b222
22be 22be s 	JP	NZ,GSL
22c1 22c1 d eb
22c1 22c1 s 	EX	DE,HL		; адрес буфера -> HL
22c2 22c2 d d1
22c2 22c2 s 	POP	DE
22c3 22c3 d c1
22c3 22c3 s 	POP	BC
22c4 22c4 d c9
22c4 22c4 s 	RET
22c5 22c5 s 	
22c5 22c5 s 	
22c5 22c5 s 	
22c5 22c5 s ;****************************************
22c5 22c5 s ;  Печать строки на текстовый экран     *
22c5 22c5 s ;****************************************
22c5 22c5 s PSTR:
22c5 22c5 d 7e
22c5 22c5 s 	LD	A,(HL)
22c6 22c6 d 23
22c6 22c6 s 	INC	HL
22c7 22c7 d b7
22c7 22c7 s 	OR	A		; 0 - конец строки
22c8 22c8 d c8
22c8 22c8 s 	RET	Z
22c9 22c9 d cdcf22
22c9 22c9 s 	CALL	PUTCH		; выводим байт через вызов ОПТС
22cc 22cc d c3c522
22cc 22cc s 	JP	PSTR
22cf 22cf s 	
22cf 22cf s ;****************************************
22cf 22cf s ;   Вывод байта на экран через ОПТС
22cf 22cf s ;****************************************
22cf 22cf s PUTCH:
22cf 22cf d e5
22cf 22cf s 	PUSH	HL
22d0 22d0 d c5
22d0 22d0 s 	PUSH	BC
22d1 22d1 d d5
22d1 22d1 s 	PUSH	DE
22d2 22d2 d 4f
22d2 22d2 s 	LD	C,A
22d3 22d3 d cd4c00
22d3 22d3 s 	CALL	PCHDRV
22d6 22d6 d d1
22d6 22d6 s 	POP	DE
22d7 22d7 d c1
22d7 22d7 s 	POP	BC
22d8 22d8 d e1
22d8 22d8 s 	POP	HL
22d9 22d9 d c9
22d9 22d9 s 	RET
22da 22da s 
22da 22da s ;A - chr
22da 22da s GETCH:
22da 22da d fb
22da 22da s 	EI
22db 22db d e5
22db 22db s 	PUSH	HL
22dc 22dc d c5
22dc 22dc s 	PUSH	BC
22dd 22dd d d5
22dd 22dd s 	PUSH	DE
22de 22de d cd4900
22de 22de s 	CALL	CONIN
22e1 22e1 d d1
22e1 22e1 s 	POP	DE
22e2 22e2 d c1
22e2 22e2 s 	POP	BC
22e3 22e3 d e1
22e3 22e3 s 	POP	HL
22e4 22e4 d f3
22e4 22e4 s 	DI
22e5 22e5 d c9
22e5 22e5 s 	RET
22e6 22e6 s 
22e6 22e6 s 
22e6 22e6 s ; Командный пакет	
22e6 22e6 d 01
22e6 22e6 s CMD:	DB	1		; Команда чтения
22e7 22e7 d 00
22e7 22e7 s DRV:	DB	0
22e8 22e8 d 00
22e8 22e8 s TRK:	DB	0
22e9 22e9 d 00
22e9 22e9 s SEC:	DB	0
22ea 22ea s 
22ea 22ea s ; Параметры загрузки из инфосектора
22ea 22ea s LOADR:	DS	2	; адрес загрузки
22ec 22ec s RUNADR:	DS	2	; адрес запуска
22ee 22ee s SCOUNT:	DS	1	; число загружаемых физических секторов
22ef 22ef s SSIZE:	DS	1	; коэффициент размера физического сектора
22f0 22f0 s LSPT:	DS	1	; число логических секторов на дорожку
22f1 22f1 s 
22f1 22f1 s ; Текстовые строки для вывода на экран
22f1 22f1 d 1f
22f1 22f1 s HMSG:   DB	1Fh ; очистка экрана
22f2 22f2 d 2d2d455854524f4d2053746167653220626f6f742076657273696f6e20312e3120627920466f7268333220262045534c20323031352d2d0d0a00
22f2 22f2 s 	DB	"--EXTROM Stage2 boot version 1.1 by Forh32 & ESL 2015--",0dh,0ah,0	; текстовое сообщение на экран
232c 232c d 424153453a00
232c 232c s HMBASE: DB	"BASE:",0
2332 2332 d 2053544152543a00
2332 2332 s HMRUN:  DB	" START:",0
233a 233a d 2050534543544f52533a00
233a 233a s HMPS:   DB	" PSECTORS:",0
2345 2345 d 205353495a453a00
2345 2345 s HMSS:   DB	" SSIZE:",0
234d 234d d 204c5350543a00
234d 234d s HMSP:   DB	" LSPT:",0
2354 2354 d 204c534543544f52533a00
2354 2354 s HMLS:   DB	" LSECTORS:",0
235f 235f s ; HMTR:   DB	" TRACKS:",0
235f 235f d 0d0a00
235f 235f s HCRLF:	DB	0dh,0ah,0
2362 2362 s mute_flag:
2362 2362 d 00
2362 2362 s 	db 	0
2363 2363 s tmpKEY:
2363 2363 d 00
2363 2363 s 	db 	0
2364 2364 s msgCPM:
2364 2364 d 43502f4d00
2364 2364 s  	db 	'CP/M',0
2369 2369 s msgMICRODOS:
2369 2369 d 4d4943524f444f5300
2369 2369 s 	db 	'MICRODOS',0
2372 2372 s msgSUBST:
2372 2372 d 4c6f61642064656661756c742000
2372 2372 s  	db 	'Load default ',0 
2380 2380 s msgASK_SUBST:
2380 2380 d 203f28456e7465722f592d7965732c20432d43502f4d2c204d2d6d6963726f646f7329203f00
2380 2380 s 	db 	' ?(Enter/Y-yes, C-CP/M, M-microdos) ?',0	
23a6 23a6 s 
23a6 23a6 s msgFORCEDDEFAULTBIOS:
23a6 23a6 d 0d0a2121204374726c2b5368696674202d20707265737365642c20666f7263656420746f207573652042494f5320535542535449545554494f4e2021210d0a0d0a00
23a6 23a6 s 	db 	0dh,0ah,'!! Ctrl+Shift - pressed, forced to use BIOS SUBSTITUTION !!',0dh,0ah,0dh,0ah,0
23e8 23e8 s 
23e8 23e8 s 	include 	"hw_test.asm"
23e8 23e8 f hw_test.asm
23e8 23e8 s _HW_ROM_OPTS1		equ 	1
23e8 23e8 s _HW_ROM_OPTS2		equ 	2
23e8 23e8 s 
23e8 23e8 s _HW_ROM_MODEL_OPTS11 	equ 	1
23e8 23e8 s _HW_ROM_MODEL_OPTS20 	equ 	2
23e8 23e8 s _HW_ROM_MODEL_KVANT8	equ 	3
23e8 23e8 s 
23e8 23e8 s _HW_GZU_SIZE_48K 	equ 	1
23e8 23e8 s _HW_GZU_SIZE_192K 	equ 	2
23e8 23e8 s 
23e8 23e8 s ;0 - undefined
23e8 23e8 s ;1 - OPTS 1.x
23e8 23e8 s ;2 - OPTS 2.x
23e8 23e8 s HW_ROM_OPTS_CLASS:
23e8 23e8 d 00
23e8 23e8 s 	db 	0 	
23e9 23e9 s 
23e9 23e9 s 
23e9 23e9 s ;0 - undefined
23e9 23e9 s ;1 - ОПТС 1.1
23e9 23e9 s ;2 - ОПТС 2.0
23e9 23e9 s ;3 - КОНТУР
23e9 23e9 s ;4 - КВАНТ-8 - Терминал
23e9 23e9 s ;5 - КВАНТ-8 - Тигрис
23e9 23e9 s ;6 - CPM.ROM
23e9 23e9 s HW_ROM_MODEL:
23e9 23e9 d 00
23e9 23e9 s 	db 	0
23ea 23ea s 
23ea 23ea s ;0 - undefined
23ea 23ea s ;1 - 48k
23ea 23ea s ;2 - 192k
23ea 23ea d 00
23ea 23ea s HW_GZU_SIZE:	db 	0
23eb 23eb s 
23eb 23eb s 
23eb 23eb d 00
23eb 23eb s HW_FDC_PRESENT:	db 	0
23ec 23ec d 00
23ec 23ec s HW_FDD_DRIVE_A:	db 	0		
23ed 23ed d 00
23ed 23ed s HW_FDD_DRIVE_B:	db 	0		
23ee 23ee d 00
23ee 23ee s HW_FDD_DRIVE_C:	db 	0		
23ef 23ef d 00
23ef 23ef s HW_FDD_DRIVE_D:	db 	0		
23f0 23f0 s 
23f0 23f0 s msg_tab8_rom_model:
23f0 23f0 s 	;        01234567
23f0 23f0 d 3f3f524f4d3f3f20
23f0 23f0 s 	db 	'??ROM?? '
23f8 23f8 d 4f50545320312e31
23f8 23f8 s 	db 	'OPTS 1.1'
2400 2400 d 4f50545320322e30
2400 2400 s 	db 	'OPTS 2.0'
2408 2408 d 4b76616e74382020
2408 2408 s 	db 	'Kvant8  '
2410 2410 s ;нет поддержки загрузки EXTROM
2410 2410 s ; 	db 	'Kontur  ' 	
2410 2410 s ; 	db 	'Kvant8-T'
2410 2410 s ; 	db 	'CPM     '
2410 2410 s 
2410 2410 s msg_tab8_gzu_size:
2410 2410 s 	;        01234567
2410 2410 d 3f3f3f6b20000000
2410 2410 s 	db 	'???k ',0,0,0
2418 2418 d 34386b2000000000
2418 2418 s 	db 	'48k ',0,0,0,0
2420 2420 d 3139326b20000000
2420 2420 s 	db 	'192k ',0,0,0
2428 2428 s 
2428 2428 s msg_tab16_fdc:
2428 2428 s 	;        01234  5     6   789012  3     4  5
2428 2428 d 3130202d201b366e6f204644431b3700
2428 2428 s 	db 	'10 - ',01bh,'6','no FDC',01bh,'7',0
2438 2438 s 	;        0123456789012345
2438 2438 d 323020776974682046444300
2438 2438 s 	db 	'20 with FDC',0
2444 2444 s 
2444 2444 s msg_rom_model:
2444 2444 d 524f4d3a2000
2444 2444 s 	db 	'ROM: ',0
244a 244a s msg_gzu_size:
244a 244a d 207c20475a553a2000
244a 244a s 	db 	' | GZU: ',0
2453 2453 s msg_fdc:
2453 2453 d 207c20504b383000
2453 2453 s 	db 	' | PK80',0
245b 245b s 
245b 245b s ; CP/M-80  
245b 245b s ; v. 2.2..SHCOMP BIOS Ver. 1.0 1991
245b 245b s 
245b 245b s putstr16:
245b 245b d 0e10
245b 245b s 	ld 	c,16
245d 245d d 6f
245d 245d s 	ld 	l,a
245e 245e d 2600
245e 245e s 	ld 	h,0
2460 2460 d 29
2460 2460 s 	add 	hl,hl 	
2461 2461 d c36924
2461 2461 s 	jp 	putx8
2464 2464 s ; a - n
2464 2464 s ;DE - base addr
2464 2464 s putstr8:
2464 2464 d 0e08
2464 2464 s 	ld 	c,8
2466 2466 d 6f
2466 2466 s 	ld 	l,a
2467 2467 d 2600
2467 2467 s 	ld 	h,0
2469 2469 s putx8:
2469 2469 d 29
2469 2469 s 	add 	hl,hl 	
246a 246a d 29
246a 246a s 	add 	hl,hl 	
246b 246b d 29
246b 246b s 	add 	hl,hl 	
246c 246c d 19
246c 246c s 	add 	hl,de
246d 246d s 
246d 246d s putstr_:
246d 246d d 79
246d 246d s 	ld 	a,c
246e 246e d b7
246e 246e s 	or 	a
246f 246f d c8
246f 246f s 	ret 	z
2470 2470 d 0d
2470 2470 s 	dec 	c
2471 2471 d 7e
2471 2471 s 	LD	A,(HL)
2472 2472 d b7
2472 2472 s 	or 	a
2473 2473 d c8
2473 2473 s 	ret 	z
2474 2474 s ; 	jp 	nz,.putNoSpc
2474 2474 s ; 	ld 	a,'_'
2474 2474 s ; 	dec 	hl
2474 2474 s .putNoSpc:
2474 2474 d 23
2474 2474 s 	INC	HL
2475 2475 d cdcf22
2475 2475 s 	CALL	PUTCH		
2478 2478 d c36d24
2478 2478 s 	JP	putstr_
247b 247b s 
247b 247b s show_hardware_info:
247b 247b d 214424
247b 247b s 	ld 	hl,msg_rom_model
247e 247e d cdc522
247e 247e s 	call 	PSTR
2481 2481 s 
2481 2481 d 3ae923
2481 2481 s 	ld 	a,(HW_ROM_MODEL)
2484 2484 d 11f023
2484 2484 s 	ld 	de,msg_tab8_rom_model
2487 2487 d cd6424
2487 2487 s 	call 	putstr8
248a 248a s 
248a 248a d 215324
248a 248a s 	ld 	hl,msg_fdc
248d 248d d cdc522
248d 248d s 	call 	PSTR
2490 2490 s 
2490 2490 d 3aeb23
2490 2490 s 	ld 	a,(HW_FDC_PRESENT)
2493 2493 d 112824
2493 2493 s 	ld 	de,msg_tab16_fdc
2496 2496 d cd5b24
2496 2496 s 	call 	putstr16
2499 2499 s 
2499 2499 s ; 	ld 	a,'/'
2499 2499 s ; 	call 	PUTCH
2499 2499 s 
2499 2499 s ; 	ld 	a,(HW_ROM_OPTS_CLASS)
2499 2499 s ; 	call 	HEX2
2499 2499 s 
2499 2499 d 214a24
2499 2499 s 	ld 	hl,msg_gzu_size
249c 249c d cdc522
249c 249c s 	call 	PSTR
249f 249f s 
249f 249f d 3aea23
249f 249f s 	ld 	a,(HW_GZU_SIZE)
24a2 24a2 d 111024
24a2 24a2 s 	ld 	de,msg_tab8_gzu_size
24a5 24a5 d cd6424
24a5 24a5 s 	call 	putstr8
24a8 24a8 s 
24a8 24a8 d 215f23
24a8 24a8 s 	LD	HL,HCRLF
24ab 24ab d cdc522
24ab 24ab s 	CALL	PSTR
24ae 24ae s 
24ae 24ae d c9
24ae 24ae s 	ret
24af 24af s 
24af 24af s 
24af 24af s hw_test:
24af 24af d cd2225
24af 24af s 	call 	hw_check_rom
24b2 24b2 d cdcf24
24b2 24b2 s 	call 	hw_check_gzu_size
24b5 24b5 d cdbc24
24b5 24b5 s 	call 	hw_check_floppy
24b8 24b8 d cd7b24
24b8 24b8 s 	call 	show_hardware_info
24bb 24bb s 
24bb 24bb s ; 	halt
24bb 24bb d c9
24bb 24bb s 	ret
24bc 24bc s 
24bc 24bc s hw_check_floppy:
24bc 24bc d 3e01
24bc 24bc s 	ld 	a,1
24be 24be d 11eb23
24be 24be s 	ld 	de,HW_FDC_PRESENT
24c1 24c1 d 12
24c1 24c1 s 	ld 	(de),a
24c2 24c2 s 
24c2 24c2 s ; Проверка наличия дисководов
24c2 24c2 d 2119fb
24c2 24c2 s 	LD	HL,0FB19H 	; регистр дорожки
24c5 24c5 d 3605
24c5 24c5 s 	LD	(HL),5		; записываем образец
24c7 24c7 d 7e
24c7 24c7 s 	LD	A,(HL)
24c8 24c8 d fe05
24c8 24c8 s 	CP	5		; проверяем
24ca 24ca d c8
24ca 24ca s 	RET 	Z		; совпал - FDC у нас есть
24cb 24cb d 3e00
24cb 24cb s 	ld 	a,0
24cd 24cd d 12
24cd 24cd s 	ld 	(de),a
24ce 24ce d c9
24ce 24ce s 	ret
24cf 24cf s ; В машине нет FDC
24cf 24cf s ; 	XOR	A	
24cf 24cf s ; 	LD	(CPMT02-2),A	; Очищаем маски дисков C и D
24cf 24cf s ; 	LD	(CPMT03-2),A	; Они становятся эмулируемыми
24cf 24cf s ; 	RET	ret 
24cf 24cf s 
24cf 24cf s NCREG 	equ 	0xFE3A
24cf 24cf s VIREG 	equ 	0xFFBF
24cf 24cf s 
24cf 24cf s hw_check_gzu_size:
24cf 24cf s ; 	проверка ГЗУ, не убивая рамдиск в 1+ страницах
24cf 24cf s ; 	включаем 0 страницу на доступ
24cf 24cf s ; 	в последние 3 байта пишем значения
24cf 24cf s ; 	включаем 3 страницу на доступ
24cf 24cf s ; 	проверяем содержимое этих байт
24cf 24cf s ; 	если совпало то 48к (т.к. переключение не проихошло)
24cf 24cf s ; 	иначе счетаем что 192к
24cf 24cf s 
24cf 24cf s 
24cf 24cf s ;3C  DOSG1          0000-3FFF  4000  8000-FDFF        FF00        FE00
24cf 24cf d 3e3c
24cf 24cf s 	ld 	a,0x3C
24d1 24d1 d 327ffa
24d1 24d1 s 	ld 	(SYSREG14),a
24d4 24d4 s 
24d4 24d4 d 21ff7f
24d4 24d4 s         ld      hl, 07FFFh 	;last gzu byte
24d7 24d7 s 
24d7 24d7 s 	; vireg pointed to RW page 0
24d7 24d7 s 
24d7 24d7 d 3ea4
24d7 24d7 s         ld      a,0x80 | 4 | 0x20 ;color 2 - green (должен быть не 1)
24d9 24d9 d 32bfff
24d9 24d9 s         ld      (VIREG), a
24dc 24dc s 
24dc 24dc d 01aa55
24dc 24dc s         ld 	bc,0x55aa
24df 24df d 70
24df 24df s         ld      (hl), b   
24e0 24e0 d 2b
24e0 24e0 s         dec 	hl
24e1 24e1 d 71
24e1 24e1 s         ld 	(hl), c
24e2 24e2 d 2b
24e2 24e2 s         dec 	hl
24e3 24e3 d 75
24e3 24e3 s         ld 	(hl), l
24e4 24e4 d 23
24e4 24e4 s         inc 	hl
24e5 24e5 d 23
24e5 24e5 s         inc 	hl
24e6 24e6 s 
24e6 24e6 d 3ee0
24e6 24e6 s         ld      a, 0xE0 	;SCR_PAGE0|ATTR_RESET|RW_PAGE3
24e8 24e8 d 323afe
24e8 24e8 s         ld      (NCREG), a
24eb 24eb s 
24eb 24eb s         ;читаем инвертированные значения не 0x55aa а 0xaa55
24eb 24eb d 79
24eb 24eb s         ld 	a,c 		
24ec 24ec d be
24ec 24ec s         cp 	m
24ed 24ed d c20325
24ed 24ed s         jp 	nz,.zgu192k
24f0 24f0 d 2b
24f0 24f0 s         dec 	hl
24f1 24f1 d 78
24f1 24f1 s         ld 	a,b
24f2 24f2 d be
24f2 24f2 s         cp 	m
24f3 24f3 d c20325
24f3 24f3 s         jp 	nz,.zgu192k
24f6 24f6 d 2b
24f6 24f6 s         dec 	hl
24f7 24f7 d 7d
24f7 24f7 s         ld 	a,l
24f8 24f8 d eeff
24f8 24f8 s         xor 	0xff
24fa 24fa d be
24fa 24fa s         cp 	m
24fb 24fb d c20325
24fb 24fb s         jp 	nz,.zgu192k
24fe 24fe s 
24fe 24fe d 3e01
24fe 24fe s         ld 	a,_HW_GZU_SIZE_48K
2500 2500 d c30525
2500 2500 s         jp      .setgzusize 
2503 2503 s 
2503 2503 s .zgu192k:
2503 2503 d 3e02
2503 2503 s         ld 	a,_HW_GZU_SIZE_192K
2505 2505 s 
2505 2505 s .setgzusize:
2505 2505 d 32ea23
2505 2505 s         ld      (HW_GZU_SIZE),a
2508 2508 s 
2508 2508 d 3e20
2508 2508 s         ld 	a,0x20		;SCR_PAGE0|ATTR_RESET|RW_PAGE0
250a 250a d 323afe
250a 250a s         ld      (NCREG),a  	
250d 250d s 
250d 250d s         ;стереть следы проверки
250d 250d d 3e92
250d 250d s         ld      a,0x80 | 2 | 0x10 ;color 1 - blue
250f 250f d 32bfff
250f 250f s         ld      (VIREG), a
2512 2512 d 21ff7f
2512 2512 s         ld 	hl,0x7fff
2515 2515 d 3eff
2515 2515 s         ld 	a,0xff
2517 2517 d 77
2517 2517 s         ld 	(hl),a
2518 2518 d 2b
2518 2518 s         dec 	hl
2519 2519 d 77
2519 2519 s         ld 	(hl),a
251a 251a d 2b
251a 251a s         dec 	hl
251b 251b d 77
251b 251b s         ld 	(hl),a
251c 251c s 
251c 251c d 3e14
251c 251c s 	ld 	a,0x14;
251e 251e d 327fff
251e 251e s 	ld 	(SYSREG3C),a
2521 2521 s 
2521 2521 d c9
2521 2521 s 	ret
2522 2522 s 
2522 2522 s hw_check_rom:
2522 2522 d 210000
2522 2522 s 	ld 	hl,0
2525 2525 d 0e00
2525 2525 s 	ld 	c,0
2527 2527 d 3f
2527 2527 s 	ccf
2528 2528 s .romcrc:
2528 2528 d 79
2528 2528 s 	ld 	a,c
2529 2529 d 8e
2529 2529 s 	adc 	a,(hl)
252a 252a d 4f
252a 252a s 	ld 	c,a
252b 252b d 23
252b 252b s 	inc 	hl
252c 252c d 7d
252c 252c s 	ld 	a,l
252d 252d d b7
252d 252d s 	or 	a
252e 252e d c22825
252e 252e s 	jp 	nz,.romcrc
2531 2531 d 79
2531 2531 s 	ld 	a,c
2532 2532 s 
2532 2532 d 0601
2532 2532 s 	ld 	b,_HW_ROM_OPTS1
2534 2534 d 0e01
2534 2534 s 	ld 	c,_HW_ROM_MODEL_OPTS11
2536 2536 d fe9a
2536 2536 s 	cp 	0x9A
2538 2538 d ca4d25
2538 2538 s 	jp 	z,.rom_found
253b 253b s 
253b 253b d 0e03
253b 253b s 	ld 	c,_HW_ROM_MODEL_KVANT8
253d 253d d fe66
253d 253d s 	cp 	0x66
253f 253f d ca4d25
253f 253f s 	jp 	z,.rom_found
2542 2542 s 
2542 2542 d 0602
2542 2542 s 	ld 	b,_HW_ROM_OPTS2
2544 2544 d 0e02
2544 2544 s 	ld 	c,_HW_ROM_MODEL_OPTS20
2546 2546 d febb
2546 2546 s 	cp 	0xBB
2548 2548 d ca4d25
2548 2548 s 	jp 	z,.rom_found
254b 254b s 
254b 254b d 0e00
254b 254b s 	ld 	c,0
254d 254d s .rom_found:
254d 254d d 78
254d 254d s 	ld 	a,b
254e 254e d 32e823
254e 254e s 	ld 	(HW_ROM_OPTS_CLASS),a
2551 2551 d 79
2551 2551 s 	ld 	a,c
2552 2552 d 32e923
2552 2552 s 	ld 	(HW_ROM_MODEL),a
2555 2555 s 
2555 2555 f stage2.asm
2555 2555 d c9
2555 2555 s 	ret
2556 2556 s 	include 	"generator/V0/extrom-patcher.asm"
2556 2556 f generator/V0/extrom-patcher.asm
2556 2556 s ;по адресу bios_variants табличка ссылок на все известные биосы
2556 2556 s ;пробуем выяснить какой биос загружен сейчас.
2556 2556 s ;если не нашли - fallback to default forth32 cp/m bios
2556 2556 s ;TODO: fallback to microdos if required
2556 2556 s ;TODO: ask user about fallback
2556 2556 s 
2556 2556 s ;алгоритм патчера
2556 2556 s ;на момент статрта в памяти уже есть загруженый в свои адреса биос, проверим что это нужный и пропатчим его
2556 2556 s ;проход 1, проверка, читаем байткоды (с доп параметрами) и проверяем что "первый параметр" совпадает, 
2556 2556 s ;если нет то считаем что это не нужный нам биос, и надо проверять следующий.
2556 2556 s ;проход 2, если на превом проходе всё проверки совпали
2556 2556 s ;то проходим и записываем занчение из "второго параметра"
2556 2556 s ;заодно выставляем флаги.
2556 2556 s ;чеки надо ставить в начале цепочки (по идее)
2556 2556 s ;последний байт обязательно p_STOP
2556 2556 s ;ругаемся на невалидный токен, для отладки.
2556 2556 s 
2556 2556 s ;токены патчера и их значения
2556 2556 s 
2556 2556 s p_STOP 			EQU 	0x50	;должен быть последним токено в цепочке, патчер
2556 2556 s 					;за ним следует строка с 0 - имя биоса
2556 2556 s 					; 	db 	p_STOP
2556 2556 s 					; 	db 	'21_89___wiza',0
2556 2556 s pW_CHK_PATCH 		EQU	0x51 	;проверить значение СЛОВА, записать новое значение, параметры DW ADDR, OLDVALUE, NEWVALUE
2556 2556 s 					;на этапе чека проверяем 1й параметр, на этапе патча записываем 2й
2556 2556 s 					; 	db 	pW_CHK_PATCH
2556 2556 s 					; 	dw 	0xDCBB+1,0xE06E,0xE06E
2556 2556 s pB_CHK_PATCH 		EQU 	0x52 	;проверить значение БАЙТА, записать новое значение, параметры DW ADDR, DB OLDVALUE, NEWVALUE
2556 2556 s 					;на этапе чека проверяем 1й параметр, на этапе патча записываем 2й
2556 2556 s 					; 	db 	pB_CHK_PATCH
2556 2556 s 					; 	dw 	0xE70A
2556 2556 s 					; 	db	0x77,0x00
2556 2556 s pW_STORE		EQU 	0x54 	;записать значение СЛОВА, параметры DW ADDR, NEWVALUE
2556 2556 s 					;на этапе чека игнорируется, на этапе патча - применяем
2556 2556 s 					; 	db 	pW_STORE
2556 2556 s 					; 	dw 	0xE06E,r_p_SELDSKDRIVER+1	 
2556 2556 s pNotSupported 		EQU 	0x55 	;выставляет флаг что биос не поддерживается
2556 2556 s 					;используется для биосов которые детектятся но сейчас не поддерживаются
2556 2556 s 					;на этапе чека игнорируется
2556 2556 s 					;	db 	pNotSupported
2556 2556 s pSETFLAG_MICRODOS 	EQU 	0x56	;выставляет флаг что биос текущий биос - микродос (по умолчанию считаем что cp/m)
2556 2556 s 					;на этапе чека игнорируется
2556 2556 s 					; 	db 	pSETFLAG_MICRODOS
2556 2556 s pREQUIRED_OPTS1 	EQU 	0x57	;проверить версию ROM, если не ОПТС 1 то вывести сообщение и поставить флг Unsupported
2556 2556 s 					;на этапе чека игнорируется
2556 2556 s 					;	db 	pREQUIRED_OPTS2
2556 2556 s pREQUIRED_OPTS2 	EQU 	0x58	;проверить версию ROM, если не ОПТС 2 то вывести сообщение и поставить флг Unsupported
2556 2556 s 					;на этапе чека игнорируется
2556 2556 s 					;	db 	pREQUIRED_OPTS2
2556 2556 s pB_MAYBE_PATCH 		EQU 	0x59 	;записать новое значение если старое совпадает, параметры DW ADDR, DB OLDVALUE, NEWVALUE
2556 2556 s 					;на этапе чека не проверяем
2556 2556 s 					;на этапа патча проверяем 1й параметр и если совпал записываем 2й
2556 2556 s 					;применяется для патча текстовых строк которые могут быть изменены
2556 2556 s 					; 	db 	pB_CHK_PATCH
2556 2556 s 					; 	dw 	0xE70A
2556 2556 s 					; 	db	0x77,0x00
2556 2556 s pSubBios		EQU 	0x5A	;записывает значение в переменную flag_subbios 
2556 2556 s 					;используется чтобы указать какой вариант резидента использовать
2556 2556 s 					; 	db 	pSubBios
2556 2556 s 					; 	db 	0
2556 2556 s 
2556 2556 s 
2556 2556 s DEBUG_TRACE_PATCHER	EQU 	0
2556 2556 s 
2556 2556 s stop 	macro msg
2556 2556 s 	db 	p_STOP
2556 2556 s 	db 	msg
2556 2556 s 	db 	0
2556 2556 s 	endm
2556 2556 s 
2556 2556 s dbpatch macro addr,oldbyte,newbyte
2556 2556 s 	db 	pB_CHK_PATCH
2556 2556 s 	dw 	addr
2556 2556 s 	db 	oldbyte,newbyte
2556 2556 s 	endm
2556 2556 s 
2556 2556 s dbpatchmaybe macro addr,oldbyte,newbyte
2556 2556 s 	db 	pB_MAYBE_PATCH
2556 2556 s 	dw 	addr
2556 2556 s 	db 	oldbyte,newbyte
2556 2556 s 	endm
2556 2556 s 
2556 2556 s dwpatch macro addr,oldword,newword
2556 2556 s 	db 	pW_CHK_PATCH
2556 2556 s 	dw 	addr
2556 2556 s 	dw 	oldword,newword
2556 2556 s 	endm
2556 2556 s 
2556 2556 s dwstore macro addr,newword
2556 2556 s 	db 	pW_STORE
2556 2556 s 	dw 	newword
2556 2556 s 	dw 	addr
2556 2556 s 	endm
2556 2556 s 
2556 2556 s setCPM 	macro 	
2556 2556 s 	endm
2556 2556 s 
2556 2556 s setSUBBIOS 	macro  id
2556 2556 s 	db	pSubBios
2556 2556 s 	db 	id
2556 2556 s 	endm
2556 2556 s 
2556 2556 s setMICRODOS macro
2556 2556 s 	db 	pSETFLAG_MICRODOS
2556 2556 s 	endm
2556 2556 s 
2556 2556 s setUNSUPPORTED macro
2556 2556 s 	db 	pNotSupported
2556 2556 s 	endm
2556 2556 s 
2556 2556 s RQ_OPTS1	macro
2556 2556 s 	db 	pREQUIRED_OPTS1
2556 2556 s 	endm
2556 2556 s 
2556 2556 s RQ_OPTS2	macro
2556 2556 s 	db 	pREQUIRED_OPTS2
2556 2556 s 	endm
2556 2556 s 
2556 2556 s RQ_OPTS_ANY	macro
2556 2556 s 	endm
2556 2556 s 
2556 2556 s 
2556 2556 s cpm_bios_patcher:
2556 2556 s 
2556 2556 s 	;dirty hasck
2556 2556 s 	;set jp 0 as first jp
2556 2556 s 	;strange dos behaviour,
2556 2556 s 	;sometime hangon when dir
2556 2556 d 210000
2556 2556 s 	ld 	hl,0
2559 2559 d 220120
2559 2559 s 	ld 	(BASE+1),hl 	;
255c 255c s 
255c 255c d 21c025
255c 255c s 	ld 	hl,msgPATCHER
255f 255f d cdc522
255f 255f s 	call 	PSTR
2562 2562 s 
2562 2562 s 	; mute message for second time (fallback code)
2562 2562 d 3e00
2562 2562 s 	ld 	a,0
2564 2564 d 32c025
2564 2564 s 	ld 	(msgPATCHER),a
2567 2567 s 
2567 2567 s 
2567 2567 s ; 	call 	get_rom_version
2567 2567 s 
2567 2567 d 11552f
2567 2567 s 	ld 	de,bios_variants
256a 256a s chk_bios_lp:
256a 256a d 1a
256a 256a s 	ld 	a,(de)
256b 256b d 6f
256b 256b s 	ld 	l,a
256c 256c d 13
256c 256c s 	inc 	de
256d 256d d 1a
256d 256d s 	ld 	a,(de)
256e 256e d 67
256e 256e s 	ld 	h,a
256f 256f d 13
256f 256f s 	inc 	de
2570 2570 d b5
2570 2570 s 	or 	l
2571 2571 d ca7f25
2571 2571 s 	jp 	z,bios_not_found
2574 2574 s 
2574 2574 d d5
2574 2574 s 	push 	de
2575 2575 d cd7326
2575 2575 s 	call 	try_bios
2578 2578 d d1
2578 2578 s 	pop 	de
2579 2579 s 
2579 2579 d ca8825
2579 2579 s 	jp 	z,bios_found
257c 257c s 
257c 257c d c36a25
257c 257c s 	jp 	chk_bios_lp
257f 257f s 
257f 257f s 
257f 257f s bios_not_found:
257f 257f s 
257f 257f d 21ef25
257f 257f s 	ld 	hl,msgNOTFOUND
2582 2582 d cdc522
2582 2582 s 	call 	PSTR
2585 2585 s 	
2585 2585 s ; 	halt
2585 2585 s 
2585 2585 d c33020
2585 2585 s 	jp 	force_subst
2588 2588 s 
2588 2588 s bios_found:
2588 2588 d 2b
2588 2588 s 	dec 	hl
2589 2589 d 7e
2589 2589 s 	ld 	a,(hl)
258a 258a d 23
258a 258a s 	inc 	hl
258b 258b d fe50
258b 258b s 	cp 	p_STOP
258d 258d d ca9725
258d 258d s 	jp 	z,.found_cont
2590 2590 s 
2590 2590 d 217a28
2590 2590 s 	ld 	hl,msg_StrangeHLAfterPatch
2593 2593 d cdc522
2593 2593 s 	call 	PSTR
2596 2596 d 76
2596 2596 s 	halt
2597 2597 s 
2597 2597 s .found_cont:
2597 2597 d e5
2597 2597 s 	push 	hl 		;bios name
2598 2598 d 21e425
2598 2598 s 	ld 	hl,msgFOUND
259b 259b d cdc522
259b 259b s 	call 	PSTR
259e 259e d e1
259e 259e s 	pop 	hl
259f 259f d cdc522
259f 259f s 	call 	PSTR
25a2 25a2 d 212826
25a2 25a2 s 	ld 	hl,msgCRLF
25a5 25a5 d cdc522
25a5 25a5 s 	call 	PSTR
25a8 25a8 s 
25a8 25a8 d 2abe25
25a8 25a8 s 	ld 	hl,(msg_warning)
25ab 25ab d 7d
25ab 25ab s 	ld 	a,l
25ac 25ac d b4
25ac 25ac s 	or 	h
25ad 25ad d c4c522
25ad 25ad s 	call 	nz,PSTR
25b0 25b0 s 
25b0 25b0 d 3abb25
25b0 25b0 s 	ld 	a,(flag_unsupported)
25b3 25b3 d b7
25b3 25b3 s 	or 	a
25b4 25b4 d c27f25
25b4 25b4 s 	jp 	nz,bios_not_found
25b7 25b7 s 
25b7 25b7 d cd0f29
25b7 25b7 s  	call 	show_mount_info
25ba 25ba s 
25ba 25ba s ; 	halt
25ba 25ba d c9
25ba 25ba s 	ret
25bb 25bb s 
25bb 25bb s ; get_rom_version:
25bb 25bb s ; ;opts1.1
25bb 25bb s ; ; RAM:003B FF                       db 0FFh
25bb 25bb s ; ;opts2.0
25bb 25bb s ; ; RAM:003B 02                       db    2
25bb 25bb s ; ; kontur
25bb 25bb s ; ; RAM:003B 05                       dec     b
25bb 25bb s ; ;kvant8 terminal 
25bb 25bb s ; ; RAM:003B 00                       db    0
25bb 25bb s ; ;kvant8 - tigris
25bb 25bb s ; ; RAM:003B FF                       db 0FFh
25bb 25bb s 
25bb 25bb s ; ; RAM:050F EF F0 F4+msgOPTS:        text "KOI8-R", 'OPTS  1.1',0
25bb 25bb s ; ; RAM:051B EF F0 F4+Logo1:          text "KOI8-R", 'OPTS  2.0',0 
25bb 25bb s ; 	ld 	a,(0x003b)
25bb 25bb s ; 	cp 	0xff
25bb 25bb s ; 	jp 	z,.opts1
25bb 25bb s 
25bb 25bb s ; 	cp 	2
25bb 25bb s ; 	jp 	z,.opts2
25bb 25bb s 
25bb 25bb s ; .opts1:
25bb 25bb s ; 	ld 	a,'1'
25bb 25bb s ; 	db 	0x21
25bb 25bb s ; .opts2:
25bb 25bb s ; 	ld 	a,'2'	
25bb 25bb s ; 	ld 	(rom_version),a
25bb 25bb s ; 	ret
25bb 25bb s 
25bb 25bb s ; rom_version:
25bb 25bb s ; 	db 	0 	;1 - opts1, 2-opts2
25bb 25bb s 
25bb 25bb s 
25bb 25bb s 
25bb 25bb s flag_unsupported:
25bb 25bb d 00
25bb 25bb s 	db 	0
25bc 25bc s flag_microdos:
25bc 25bc d 00
25bc 25bc s 	db 	0	
25bd 25bd s flag_subbios:
25bd 25bd d 00
25bd 25bd s 	db 	0
25be 25be s msg_warning:
25be 25be d 0000
25be 25be s 	dw 	0
25c0 25c0 s 
25c0 25c0 s 
25c0 25c0 s msgPATCHER:
25c0 25c0 d 0d0a42494f532050415443484552205620312e35322062792045534c20323031340d0a00
25c0 25c0 s 	db 	0dh,0ah,'BIOS PATCHER V 1.52 by ESL 2014',0dh,0ah,0
25e4 25e4 s msgFOUND:
25e4 25e4 d 44657465637465643a2000
25e4 25e4 s 	db 	'Detected: ',0
25ef 25ef s msgNOTFOUND:
25ef 25ef d 42494f5320556e737570706f72746564206f722042726f6b656e2c20
25ef 25ef s 	db 	'BIOS Unsupported or Broken, '
260b 260b d 1b36
260b 260b s 	db 	01bh,'6'
260d 260d d 66616c6c6261636b20746f2044454641554c542062696f732e
260d 260d s 	db 	'fallback to DEFAULT bios.'
2626 2626 d 1b37
2626 2626 s 	db 	01bh,'7'
2628 2628 s msgCRLF:
2628 2628 d 0d0a00
2628 2628 s 	db 	0dh,0ah,0
262b 262b s 
262b 262b s msgREQ_OPTS:
262b 262b d 20212120
262b 262b s 	db 	' !! '
262f 262f d 1b36
262f 262f s 	db 	01bh,'6'
2631 2631 d 42494f532072657175697265204f50545320
2631 2631 s 	db 	'BIOS require OPTS '
2643 2643 s msgREQ_OPTS_digit:
2643 2643 d 312e7820524f4d
2643 2643 s 	db 	'1.x ROM'
264a 264a d 1b37
264a 264a s 	db 	01bh,'7'
264c 264c d 20616e64206e6f7420636f6d70617469626c6520776974682063757272656e742e
264c 264c s 	db 	' and not compatible with current.'
266d 266d d 0d0a
266d 266d s 	db 	0dh,0ah
266f 266f d 00
266f 266f s 	db 	0
2670 2670 s 
2670 2670 s work_ptr:
2670 2670 d 0000
2670 2670 s 	dw 	0;
2672 2672 s patch_flag:
2672 2672 d 00
2672 2672 s 	db 	0
2673 2673 s 
2673 2673 s ;проверит совпадает ли биос с табличкой
2673 2673 s ;на входе в HL табличка для биоса
2673 2673 s ;если совпало то HL укзывает на имя биоса
2673 2673 s try_bios:
2673 2673 d 227026
2673 2673 s 	ld 	(work_ptr),hl
2676 2676 s 
2676 2676 s 	;check
2676 2676 d af
2676 2676 s 	xor 	a
2677 2677 d 2a7026
2677 2677 s 	ld 	hl,(work_ptr)
267a 267a d cd2c27
267a 267a s 	call 	do_patch
267d 267d d c0
267d 267d s 	ret nz
267e 267e s 
267e 267e s ; 	halt
267e 267e s 
267e 267e s 	;скопировали резидент в дырку
267e 267e s 
267e 267e s 	;preprare to PATCH
267e 267e s 
267e 267e s 	;copy resident
267e 267e s 
267e 267e d 3abc25
267e 267e s 	ld 	a,(flag_microdos)
2681 2681 d b7
2681 2681 s 	or 	a
2682 2682 d c2fe26
2682 2682 s 	jp 	nz,move_microdos_resident
2685 2685 s 
2685 2685 d 3abd25
2685 2685 s 	ld 	a,(flag_subbios)
2688 2688 d fe01
2688 2688 s 	cp 	1
268a 268a d ca9d26
268a 268a s 	jp 	z,.cpmsubBios1
268d 268d d fe02
268d 268d s 	cp 	2
268f 268f d caaf26
268f 268f s 	jp 	z,.cpmsubBios2
2692 2692 d fe03
2692 2692 s 	cp 	3 			;no resident part
2694 2694 d cac126
2694 2694 s 	jp 	z,.cpmNoResident
2697 2697 s 
2697 2697 d 215728
2697 2697 s 	ld 	hl,msgUndefindedsubBios
269a 269a d cdc522
269a 269a s 	call 	PSTR
269d 269d s ; 	halt
269d 269d s 
269d 269d s 
269d 269d s .cpmsubBios1:
269d 269d s 
269d 269d d 21ace8
269d 269d s 	ld 	hl,_CPM1_res_DRIVE_TAB
26a0 26a0 d 226f2a
26a0 26a0 s 	ld 	(drivetab_mount_info),hl
26a3 26a3 s 
26a3 26a3 d 21172b
26a3 26a3 s 	ld 	hl,resident_cpm1
26a6 26a6 d 11ace8
26a6 26a6 s 	ld 	de,resident_cpm1_addr
26a9 26a9 d 019701
26a9 26a9 s 	ld 	bc,resident_cpm1_len
26ac 26ac s 
26ac 26ac d c3be26
26ac 26ac s 	jp 	.subBiosldir
26af 26af s 
26af 26af s .cpmsubBios2:
26af 26af d 2106ea
26af 26af s 	ld 	hl,_CPM2_res_DRIVE_TAB
26b2 26b2 d 226f2a
26b2 26b2 s 	ld 	(drivetab_mount_info),hl
26b5 26b5 s 
26b5 26b5 d 21ae2c
26b5 26b5 s 	ld 	hl,resident_cpm2
26b8 26b8 d 1106ea
26b8 26b8 s 	ld 	de,resident_cpm2_addr
26bb 26bb d 019701
26bb 26bb s 	ld 	bc,resident_cpm2_len
26be 26be s 
26be 26be s .subBiosldir:
26be 26be d cdce28
26be 26be s 	call	_p_ldir
26c1 26c1 s 
26c1 26c1 s .cpmNoResident:
26c1 26c1 d 3e01
26c1 26c1 s 	ld 	a,1
26c3 26c3 d 2a7026
26c3 26c3 s 	ld 	hl,(work_ptr)
26c6 26c6 d cd2c27
26c6 26c6 s 	call 	do_patch
26c9 26c9 s 
26c9 26c9 s ; 	halt
26c9 26c9 s 
26c9 26c9 d 222a27
26c9 26c9 s 	ld 	(hl_after_do_patch_patch),hl
26cc 26cc s 
26cc 26cc s 	;если дисководов нет то диски C и D - эмулируемые
26cc 26cc d 3aeb23
26cc 26cc s 	ld 	a,(HW_FDC_PRESENT)
26cf 26cf d b7
26cf 26cf s 	or 	a
26d0 26d0 d c22527
26d0 26d0 s 	jp 	nz,patch_done
26d3 26d3 s 
26d3 26d3 s 
26d3 26d3 d 3abd25
26d3 26d3 s 	ld 	a,(flag_subbios)
26d6 26d6 d 21ace8
26d6 26d6 s 	ld 	hl,_CPM1_res_DRIVE_TAB
26d9 26d9 d fe01
26d9 26d9 s 	cp 	1
26db 26db d cae926
26db 26db s 	jp 	z,.cpmRemapCD
26de 26de s 
26de 26de d 2106ea
26de 26de s 	ld 	hl,_CPM2_res_DRIVE_TAB
26e1 26e1 d fe02
26e1 26e1 s 	cp 	2
26e3 26e3 d cae926
26e3 26e3 s 	jp 	z,.cpmRemapCD
26e6 26e6 s 
26e6 26e6 d c32527
26e6 26e6 s 	jp 	patch_done 	;no need to patch
26e9 26e9 s 
26e9 26e9 s 
26e9 26e9 s .cpmRemapCD:
26e9 26e9 s 
26e9 26e9 s 
26e9 26e9 d d5
26e9 26e9 s 	push 	de
26ea 26ea d 110400
26ea 26ea s 	ld	de,2*2
26ed 26ed d 19
26ed 26ed s 	add 	hl,de
26ee 26ee d 3e00
26ee 26ee s 	ld 	a,0 ;0=use emu
26f0 26f0 s 
26f0 26f0 d 5e
26f0 26f0 s 	ld 	e,(hl)
26f1 26f1 d 23
26f1 26f1 s 	inc 	hl
26f2 26f2 d 56
26f2 26f2 s 	ld 	d,(hl)
26f3 26f3 d 23
26f3 26f3 s 	inc 	hl
26f4 26f4 d 12
26f4 26f4 s 	ld 	(de),a 	;drive C - emu
26f5 26f5 s 
26f5 26f5 s 
26f5 26f5 d 5e
26f5 26f5 s 	ld 	e,(hl)
26f6 26f6 d 23
26f6 26f6 s 	inc 	hl
26f7 26f7 d 56
26f7 26f7 s 	ld 	d,(hl)
26f8 26f8 d 23
26f8 26f8 s 	inc 	hl
26f9 26f9 d 12
26f9 26f9 s 	ld 	(de),a	;drive D - emu
26fa 26fa s 
26fa 26fa d d1
26fa 26fa s 	pop 	de
26fb 26fb s 
26fb 26fb d c32527
26fb 26fb s 	jp 	patch_done
26fe 26fe s 
26fe 26fe s move_microdos_resident:
26fe 26fe s 
26fe 26fe s 
26fe 26fe d 2102fa
26fe 26fe s 	ld 	hl,md_res_DRIVE_TAB
2701 2701 d 226f2a
2701 2701 s 	ld 	(drivetab_mount_info),hl
2704 2704 s 
2704 2704 s 	;microdos
2704 2704 d 3e5c
2704 2704 s 	ld 	a,0x5c
2706 2706 d 327ffa
2706 2706 s 	ld 	(SYSREG14),a
2709 2709 s 
2709 2709 d 21452e
2709 2709 s 	ld 	hl,resident_md
270c 270c d 1100fa
270c 270c s 	ld 	de,resident_md_addr
270f 270f d 011001
270f 270f s 	ld 	bc,resident_md_len
2712 2712 d cdce28
2712 2712 s 	call	_p_ldir
2715 2715 s 
2715 2715 d 3e01
2715 2715 s 	ld 	a,1
2717 2717 d 2a7026
2717 2717 s 	ld 	hl,(work_ptr)
271a 271a d cd2c27
271a 271a s 	call 	do_patch
271d 271d d 222a27
271d 271d s 	ld 	(hl_after_do_patch_patch),hl
2720 2720 s 
2720 2720 d 3e14
2720 2720 s 	ld 	a,0x14
2722 2722 d 327fff
2722 2722 s 	ld 	(SYSREG5C),a
2725 2725 s 
2725 2725 s 
2725 2725 s ; 	HALT
2725 2725 s patch_done:
2725 2725 d 2a2a27
2725 2725 s 	ld 	hl,(hl_after_do_patch_patch)
2728 2728 s 
2728 2728 d af
2728 2728 s 	xor 	a
2729 2729 d c9
2729 2729 s 	ret
272a 272a s hl_after_do_patch_patch:
272a 272a d 0000
272a 272a s 	dw 	0
272c 272c s do_patch:
272c 272c d 327226
272c 272c s 	ld 	(patch_flag),a
272f 272f s 
272f 272f s 	if DEBUG_TRACE_PATCHER
272f 272f s 		;debug
272f 272f s ; 		or 	a
272f 272f s ; 		jp 	nz,.noTrace1
272f 272f s 
272f 272f s 		push 	hl
272f 272f s 
272f 272f s 
272f 272f s 		LD	HL,HCRLF
272f 272f s 		CALL	PSTR
272f 272f s 		pop	hl
272f 272f s 
272f 272f s 		push 	hl
272f 272f s 		CALL	HEX4
272f 272f s 		ld 	a,':'
272f 272f s 		call 	PUTCH
272f 272f s 		;DEBUG
272f 272f s 
272f 272f s 		ld 	a,'>'
272f 272f s 		call 	PUTCH
272f 272f s 		ld 	a,(patch_flag)
272f 272f s 		call 	HEX2
272f 272f s 		ld 	a,':'
272f 272f s 		call 	PUTCH
272f 272f s 
272f 272f s 		pop 	hl
272f 272f s .noTrace1:
272f 272f s 		; 	debug
272f 272f s 	endif
272f 272f s 
272f 272f d 3e00
272f 272f s 	ld 	a,0
2731 2731 d 32bc25
2731 2731 s 	ld 	(flag_microdos),a
2734 2734 d 32bd25
2734 2734 s 	ld 	(flag_subbios),a
2737 2737 s 
2737 2737 s patch_loop:
2737 2737 s 
2737 2737 d 7e
2737 2737 s 	ld 	a,(hl)
2738 2738 d 23
2738 2738 s 	inc 	hl
2739 2739 s 	if DEBUG_TRACE_PATCHER
2739 2739 s 
2739 2739 s ; 		;debug
2739 2739 s ; 		push 	af
2739 2739 s ; 		ld 	a,(patch_flag)
2739 2739 s ; 		or 	a
2739 2739 s ; 		jp 	nz,.noTrace2
2739 2739 s ; 		pop 	af
2739 2739 s 		push 	af
2739 2739 s 		call 	HEX2
2739 2739 s 	.noTrace2:
2739 2739 s 		pop 	af
2739 2739 s 		;debug
2739 2739 s 	endif
2739 2739 s 
2739 2739 d fe50
2739 2739 s 	cp 	p_STOP
273b 273b d c8
273b 273b s 	ret 	z 	;FOUND
273c 273c s 
273c 273c s B_CHK_PATCH:
273c 273c d fe52
273c 273c s 	cp 	pB_CHK_PATCH
273e 273e d c25f27
273e 273e s 	jp 	nz,B_CHK_MAYBE
2741 2741 s 
2741 2741 d cdc928
2741 2741 s 	call 	fetch_dw_to_bc 	;BC addr
2744 2744 d c5
2744 2744 s 	push 	bc
2745 2745 d cdcb28
2745 2745 s 	call 	fetch_db_to_b 	;b
2748 2748 s 
2748 2748 d eb
2748 2748 s 	ex 	de,hl
2749 2749 d e1
2749 2749 s 	pop 	hl
274a 274a d 7e
274a 274a s 	ld 	a,(hl)
274b 274b d eb
274b 274b s 	ex 	de,hl 		;de - addr
274c 274c s 
274c 274c d 48
274c 274c s 	ld 	c,b
274d 274d s 
274d 274d d cdcb28
274d 274d s 	call 	fetch_db_to_b 	;b store
2750 2750 s 
2750 2750 d b9
2750 2750 s 	cp 	c
2751 2751 d c0
2751 2751 s 	ret 	nz
2752 2752 s 
2752 2752 s 
2752 2752 d 3a7226
2752 2752 s 	ld 	a,(patch_flag)
2755 2755 d b7
2755 2755 s 	or 	a
2756 2756 d ca3727
2756 2756 s 	jp 	z,patch_loop
2759 2759 s 
2759 2759 d eb
2759 2759 s 	ex 	de,hl
275a 275a d 70
275a 275a s 	ld 	(hl),b
275b 275b d eb
275b 275b s 	ex 	de,hl
275c 275c d c33727
275c 275c s 	jp 	patch_loop
275f 275f s 
275f 275f s 
275f 275f s B_CHK_MAYBE:
275f 275f d fe59
275f 275f s 	cp 	pB_MAYBE_PATCH
2761 2761 d c27d27
2761 2761 s 	jp 	nz,l_pW_CHK
2764 2764 s 
2764 2764 d cdc928
2764 2764 s 	call 	fetch_dw_to_bc 	;BC addr
2767 2767 d c5
2767 2767 s 	push 	bc
2768 2768 d cdcb28
2768 2768 s 	call 	fetch_db_to_b 	;b
276b 276b s 
276b 276b d eb
276b 276b s 	ex 	de,hl
276c 276c d e1
276c 276c s 	pop 	hl
276d 276d d 7e
276d 276d s 	ld 	a,(hl)
276e 276e d eb
276e 276e s 	ex 	de,hl 		;de - addr
276f 276f s 
276f 276f d 48
276f 276f s 	ld 	c,b
2770 2770 s 
2770 2770 d cdcb28
2770 2770 s 	call 	fetch_db_to_b 	;b store
2773 2773 s 
2773 2773 d b9
2773 2773 s 	cp 	c
2774 2774 d c23727
2774 2774 s 	jp  	nz,patch_loop
2777 2777 s 
2777 2777 d eb
2777 2777 s 	ex 	de,hl
2778 2778 d 70
2778 2778 s 	ld 	(hl),b
2779 2779 d eb
2779 2779 s 	ex 	de,hl
277a 277a d c33727
277a 277a s 	jp 	patch_loop
277d 277d s 
277d 277d s 
277d 277d s l_pW_CHK:
277d 277d d fe51
277d 277d s 	cp 	pW_CHK_PATCH
277f 277f d c2a227
277f 277f s 	jp 	nz,l_pW_STORE
2782 2782 s 
2782 2782 d cdc928
2782 2782 s 	call 	fetch_dw_to_bc 	
2785 2785 d cdae28
2785 2785 s 	call 	store_bc_to_tmp
2788 2788 s 
2788 2788 d cdc928
2788 2788 s 	call 	fetch_dw_to_bc 	;BC OLD value
278b 278b s 
278b 278b d cdc028
278b 278b s 	call 	read_de_at_tmp 	;de - value
278e 278e d cda628
278e 278e s 	call 	cp_de_bc
2791 2791 s 
2791 2791 d cdc928
2791 2791 s 	call 	fetch_dw_to_bc 	;bc NEW value
2794 2794 s 
2794 2794 d c0
2794 2794 s 	ret 	nz
2795 2795 s 
2795 2795 d 3a7226
2795 2795 s 	ld 	a,(patch_flag)
2798 2798 d b7
2798 2798 s 	or 	a
2799 2799 d ca3727
2799 2799 s 	jp 	z,patch_loop
279c 279c s 
279c 279c d cdb728
279c 279c s 	call 	store_bc_at_tmp
279f 279f s 
279f 279f d c33727
279f 279f s 	jp 	patch_loop
27a2 27a2 s 
27a2 27a2 s l_pW_STORE:
27a2 27a2 d fe54
27a2 27a2 s 	cp 	pW_STORE
27a4 27a4 d c2bf27
27a4 27a4 s 	jp 	nz,.pNotSupported
27a7 27a7 s 
27a7 27a7 s 
27a7 27a7 d cdc928
27a7 27a7 s 	call 	fetch_dw_to_bc 	;BC value
27aa 27aa d c5
27aa 27aa s 	push 	bc
27ab 27ab s 
27ab 27ab d cdc928
27ab 27ab s 	call 	fetch_dw_to_bc 	
27ae 27ae d cdae28
27ae 27ae s 	call 	store_bc_to_tmp
27b1 27b1 s 
27b1 27b1 d c1
27b1 27b1 s 	pop 	bc
27b2 27b2 s 
27b2 27b2 d 3a7226
27b2 27b2 s 	ld 	a,(patch_flag)
27b5 27b5 d b7
27b5 27b5 s 	or 	a
27b6 27b6 d ca3727
27b6 27b6 s 	jp 	z,patch_loop
27b9 27b9 s 
27b9 27b9 d cdb728
27b9 27b9 s 	call 	store_bc_at_tmp
27bc 27bc s 
27bc 27bc d c33727
27bc 27bc s 	jp 	patch_loop
27bf 27bf s 
27bf 27bf s .pNotSupported:
27bf 27bf d fe55
27bf 27bf s 	cp 	pNotSupported
27c1 27c1 d c2ce27
27c1 27c1 s 	jp 	nz,.pSETFLAG_MICRODOS
27c4 27c4 s 
27c4 27c4 s 
27c4 27c4 d 3a7226
27c4 27c4 s 	ld 	a,(patch_flag)
27c7 27c7 d b7
27c7 27c7 s 	or 	a
27c8 27c8 d ca3727
27c8 27c8 s 	jp 	z,patch_loop
27cb 27cb s 
27cb 27cb d c32228
27cb 27cb s 	jp 	Unsupported	
27ce 27ce s 
27ce 27ce s .pSETFLAG_MICRODOS:
27ce 27ce d fe56
27ce 27ce s 	cp 	pSETFLAG_MICRODOS
27d0 27d0 d c2db27
27d0 27d0 s 	jp 	nz,.pSubBios
27d3 27d3 s 
27d3 27d3 s ; 	ld 	a,(patch_flag)
27d3 27d3 s ; 	or 	a
27d3 27d3 s ; 	jp 	z,patch_loop
27d3 27d3 s 
27d3 27d3 d 3e01
27d3 27d3 s 	ld 	a,1
27d5 27d5 d 32bc25
27d5 27d5 s 	ld 	(flag_microdos),a
27d8 27d8 d c33727
27d8 27d8 s 	jp 	patch_loop
27db 27db s 
27db 27db s .pSubBios:
27db 27db d fe5a
27db 27db s 	cp 	pSubBios
27dd 27dd d c2e827
27dd 27dd s 	jp 	nz,.pREQUIRED_OPTS1
27e0 27e0 s 
27e0 27e0 d 7e
27e0 27e0 s 	ld 	a,(hl)
27e1 27e1 d 23
27e1 27e1 s 	inc 	hl
27e2 27e2 d 32bd25
27e2 27e2 s 	ld 	(flag_subbios),a
27e5 27e5 d c33727
27e5 27e5 s 	jp 	patch_loop
27e8 27e8 s 
27e8 27e8 s .pREQUIRED_OPTS1:
27e8 27e8 d fe57
27e8 27e8 s 	cp 	pREQUIRED_OPTS1
27ea 27ea d c20128
27ea 27ea s 	jp 	nz,.pREQUIRED_OPTS2
27ed 27ed s 
27ed 27ed d 3a7226
27ed 27ed s 	ld 	a,(patch_flag)
27f0 27f0 d b7
27f0 27f0 s 	or 	a
27f1 27f1 d ca3727
27f1 27f1 s 	jp 	z,patch_loop
27f4 27f4 s 
27f4 27f4 s ; 	ld 	a,(rom_version)
27f4 27f4 d 3ae823
27f4 27f4 s 	ld 	a,(HW_ROM_OPTS_CLASS)
27f7 27f7 d fe01
27f7 27f7 s 	cp 	_HW_ROM_OPTS1
27f9 27f9 d ca3727
27f9 27f9 s 	jp 	z,patch_loop
27fc 27fc s 
27fc 27fc d 3e31
27fc 27fc s 	ld 	a,'1'
27fe 27fe d c31728
27fe 27fe s 	jp 	set_opts_warning
2801 2801 s 
2801 2801 s ; 	jp 	patch_loop
2801 2801 s 
2801 2801 s .pREQUIRED_OPTS2:
2801 2801 d fe58
2801 2801 s 	cp 	pREQUIRED_OPTS2
2803 2803 d c22a28
2803 2803 s 	jp 	nz,.pHALT
2806 2806 s 
2806 2806 d 3a7226
2806 2806 s 	ld 	a,(patch_flag)
2809 2809 d b7
2809 2809 s 	or 	a
280a 280a d ca3727
280a 280a s 	jp 	z,patch_loop
280d 280d s 
280d 280d s ; 	ld 	a,(rom_version)
280d 280d d 3ae823
280d 280d s 	ld 	a,(HW_ROM_OPTS_CLASS)
2810 2810 d fe02
2810 2810 s 	cp 	_HW_ROM_OPTS2
2812 2812 d ca3727
2812 2812 s 	jp 	z,patch_loop
2815 2815 s 
2815 2815 d 3e32
2815 2815 s 	ld 	a,'2'
2817 2817 s 
2817 2817 s set_opts_warning:
2817 2817 d 324326
2817 2817 s 	ld 	(msgREQ_OPTS_digit),a
281a 281a s 
281a 281a d e5
281a 281a s 	push 	hl
281b 281b d 212b26
281b 281b s 	ld 	hl,msgREQ_OPTS
281e 281e d 22be25
281e 281e s 	ld 	(msg_warning),hl
2821 2821 d e1
2821 2821 s 	pop 	hl
2822 2822 s 
2822 2822 s Unsupported:
2822 2822 d 3e01
2822 2822 s 	ld 	a,1
2824 2824 d 32bb25
2824 2824 s 	ld 	(flag_unsupported),a
2827 2827 d c33727
2827 2827 s 	jp 	patch_loop
282a 282a s 
282a 282a s .pHALT:
282a 282a d 213228
282a 282a s 	ld 	hl,msg_InvalidPatchCode
282d 282d d cdc522
282d 282d s 	call 	PSTR
2830 2830 s 
2830 2830 d 76
2830 2830 s 	halt
2831 2831 s 
2831 2831 d c9
2831 2831 s 	ret
2832 2832 s 
2832 2832 s msg_InvalidPatchCode:
2832 2832 d 496e76616c6964207061746368636f64652c20636865636b207265676973746572730d0a00
2832 2832 s 	db 	'Invalid patchcode, check registers',0dh,0ah,0
2857 2857 s msgUndefindedSubBios:
2857 2857 d 43502f4d2073756262696f73206e6f7420646566696e65642c2068616c7465640d0a00
2857 2857 s 	db 	'CP/M subbios not defined, halted',0dh,0ah,0
287a 287a s msg_StrangeHLAfterPatch:
287a 287a d 496e76616c696420484c2061667465722070617463682c206e6f20705f53544f50206265666f7265210d0a00
287a 287a s 	db 	'Invalid HL after patch, no p_STOP before!',0dh,0ah,0
28a6 28a6 s cp_de_bc:
28a6 28a6 d 7b
28a6 28a6 s 	ld 	a,e
28a7 28a7 d b9
28a7 28a7 s 	cp 	c
28a8 28a8 d c0
28a8 28a8 s 	ret 	nz
28a9 28a9 d 7a
28a9 28a9 s 	ld 	a,d
28aa 28aa d b8
28aa 28aa s 	cp 	b
28ab 28ab d c9
28ab 28ab s 	ret
28ac 28ac s 
28ac 28ac d 0000
28ac 28ac s tmp: 	dw 	0
28ae 28ae s 
28ae 28ae s ;stor bc to tmp
28ae 28ae s store_bc_to_tmp:
28ae 28ae d 79
28ae 28ae s 	ld 	a,c
28af 28af d 32ac28
28af 28af s 	ld 	(tmp),a
28b2 28b2 s 
28b2 28b2 d 78
28b2 28b2 s 	ld 	a,b
28b3 28b3 d 32ad28
28b3 28b3 s 	ld 	(tmp+1),a
28b6 28b6 d c9
28b6 28b6 s 	ret
28b7 28b7 s 
28b7 28b7 s store_bc_at_tmp:
28b7 28b7 d e5
28b7 28b7 s 	push 	hl
28b8 28b8 d 2aac28
28b8 28b8 s 	ld 	hl,(tmp)
28bb 28bb d 71
28bb 28bb s 	ld 	(hl),c
28bc 28bc d 23
28bc 28bc s 	inc 	hl
28bd 28bd d 70
28bd 28bd s 	ld 	(hl),b
28be 28be d e1
28be 28be s 	pop 	hl
28bf 28bf d c9
28bf 28bf s 	ret
28c0 28c0 s 
28c0 28c0 s ;de - value at (tmp)
28c0 28c0 s read_de_at_tmp:
28c0 28c0 d e5
28c0 28c0 s 	push 	hl
28c1 28c1 d 2aac28
28c1 28c1 s 	ld 	hl,(tmp)
28c4 28c4 s 
28c4 28c4 d 5e
28c4 28c4 s 	ld 	e,(hl)
28c5 28c5 d 23
28c5 28c5 s 	inc 	hl
28c6 28c6 d 56
28c6 28c6 s 	ld 	d,(hl)
28c7 28c7 s 
28c7 28c7 d e1
28c7 28c7 s 	pop 	hl
28c8 28c8 d c9
28c8 28c8 s 	ret
28c9 28c9 s 
28c9 28c9 s 
28c9 28c9 s fetch_dw_to_bc:
28c9 28c9 d 4e
28c9 28c9 s 	ld 	c,(hl)
28ca 28ca d 23
28ca 28ca s 	inc 	hl
28cb 28cb s fetch_db_to_b:
28cb 28cb d 46
28cb 28cb s 	ld 	b,(hl)
28cc 28cc d 23
28cc 28cc s 	inc 	hl
28cd 28cd d c9
28cd 28cd s 	ret
28ce 28ce s 
28ce 28ce s _p_ldir:
28ce 28ce d 7e
28ce 28ce s 	ld 	a,(hl)
28cf 28cf d 12
28cf 28cf s 	ld 	(de),a
28d0 28d0 d 23
28d0 28d0 s 	inc 	hl
28d1 28d1 d 13
28d1 28d1 s 	inc 	de
28d2 28d2 d 0b
28d2 28d2 s 	dec 	bc
28d3 28d3 d 79
28d3 28d3 s 	ld 	a,c
28d4 28d4 d b0
28d4 28d4 s 	or 	b
28d5 28d5 d c2ce28
28d5 28d5 s 	jp 	nz,_p_ldir
28d8 28d8 d c9
28d8 28d8 s 	ret
28d9 28d9 s 
28d9 28d9 s 	include 	"mount_info.asm"
28d9 28d9 f mount_info.asm
28d9 28d9 s API_GET_MOUNT_NAME	EQU	0x80
28d9 28d9 s API_GET_MOUNT_STATUS 	EQU	0x82
28d9 28d9 s 
28d9 28d9 s ; x123:
28d9 28d9 s ; 	db 0dh,0ah
28d9 28d9 s ; 	db '0         1         2         3         4         5         6   '
28d9 28d9 s ; 	db '0123456789012345678901234567890123456789012345678901234567890123'
28d9 28d9 s ; 	db 0
28d9 28d9 s 
28d9 28d9 s msgBootFromImage:
28d9 28d9 d 2d2d455854524f4d3a20426f6f74696e672066726f6d20696d6167653a2000
28d9 28d9 s 	db 	'--EXTROM: Booting from image: ',0
28f8 28f8 s show_boot_image_name:
28f8 28f8 d 21d928
28f8 28f8 s 	ld 	hl,msgBootFromImage
28fb 28fb d cdc522
28fb 28fb s 	call 	PSTR
28fe 28fe s 
28fe 28fe s 
28fe 28fe d 32e722
28fe 28fe s 	ld 	(DRV),a
2901 2901 s 
2901 2901 d 3e00
2901 2901 s 	ld 	a,0
2903 2903 d 32b72a
2903 2903 s 	ld 	(drive_rw_status),a
2906 2906 d cd582a
2906 2906 s 	call 	get_mount_info
2909 2909 d cdf629
2909 2909 s 	call 	build_emu_name
290c 290c s 
290c 290c d c38c29
290c 290c s 	jp 	show_disk_info
290f 290f s 
290f 290f s show_mount_info:
290f 290f s 
290f 290f d 21712a
290f 290f s 	ld 	hl,msg_default_mount
2912 2912 d cdc522
2912 2912 s 	call 	PSTR
2915 2915 s 	
2915 2915 d 3e00
2915 2915 s 	ld 	a,0
2917 2917 d cd3529
2917 2917 s 	call 	show_mount_drive
291a 291a s 
291a 291a d 3e01
291a 291a s 	ld 	a,1
291c 291c d cd3529
291c 291c s 	call 	show_mount_drive
291f 291f s 
291f 291f d 3e02
291f 291f s 	ld 	a,2
2921 2921 d cd3529
2921 2921 s 	call 	show_mount_drive
2924 2924 s 
2924 2924 d 3e03
2924 2924 s 	ld 	a,3
2926 2926 d cd3529
2926 2926 s 	call 	show_mount_drive
2929 2929 s 
2929 2929 s ; 	ld 	hl,mount_crlf
2929 2929 s ; 	call 	PSTR
2929 2929 s 
2929 2929 s 	;show info about drive F 	
2929 2929 d 3abc25
2929 2929 s 	ld 	a,(flag_microdos)
292c 292c d b7
292c 292c s 	or 	a
292d 292d d c0
292d 292d s 	ret 	nz	
292e 292e s 
292e 292e d 21d82a
292e 292e s 	ld 	hl,msgDRIVE_F
2931 2931 d cdc522
2931 2931 s 	call 	PSTR
2934 2934 s 
2934 2934 d c9
2934 2934 s 	ret
2935 2935 s 
2935 2935 s show_mount_drive:
2935 2935 d 32e722
2935 2935 s 	ld 	(DRV),a
2938 2938 s 
2938 2938 d 3e00
2938 2938 s 	ld 	a,0
293a 293a d 32b72a
293a 293a s 	ld 	(drive_rw_status),a
293d 293d s 
293d 293d d cdc129
293d 293d s 	call 	get_drvinfo_ptr
2940 2940 d ca9729
2940 2940 s 	jp 	z,skip_disk 	;de=0, no drive at all
2943 2943 s 
2943 2943 d 1a
2943 2943 s 	ld 	a,(de)
2944 2944 d b7
2944 2944 s 	or 	a
2945 2945 d c25429
2945 2945 s 	jp 	nz,.physical_drive
2948 2948 s 
2948 2948 d cd582a
2948 2948 s 	call 	get_mount_info
294b 294b d cd9829
294b 294b s 	call 	build_disk_name
294e 294e d cdf629
294e 294e s 	call 	build_emu_name
2951 2951 s 
2951 2951 d c38c29
2951 2951 s 	jp 	show_disk_info
2954 2954 s 
2954 2954 s 
2954 2954 s .physical_drive:
2954 2954 s 
2954 2954 d f5
2954 2954 s 	push 	af
2955 2955 d cd9829
2955 2955 s 	call 	build_disk_name
2958 2958 d f1
2958 2958 s 	pop 	af
2959 2959 s 
2959 2959 d 0e41
2959 2959 s 	ld 	c,'A'
295b 295b d fe01
295b 295b s 	cp 	0001b
295d 295d d ca7b29
295d 295d s 	jp 	z,fdd_found
2960 2960 d 0e42
2960 2960 s 	ld 	c,'B'
2962 2962 d fe02
2962 2962 s 	cp 	0010b
2964 2964 d ca7b29
2964 2964 s 	jp 	z,fdd_found
2967 2967 d 0e43
2967 2967 s 	ld 	c,'C'
2969 2969 d fe04
2969 2969 s 	cp 	0100b
296b 296b d ca7b29
296b 296b s 	jp 	z,fdd_found
296e 296e d 0e44
296e 296e s 	ld 	c,'D'
2970 2970 d fe08
2970 2970 s 	cp 	1000b
2972 2972 d ca7b29
2972 2972 s 	jp 	z,fdd_found
2975 2975 s 
2975 2975 d 21ad2a
2975 2975 s 	ld 	hl,msg_fdd_err
2978 2978 d c38229
2978 2978 s 	jp 	.cpfddname
297b 297b s 
297b 297b s fdd_found:
297b 297b d 79
297b 297b s 	ld 	a,c
297c 297c d 32ab2a
297c 297c s 	ld 	(msg_fdd_drv),a
297f 297f s 
297f 297f d 21a42a
297f 297f s 	ld 	hl,msg_fdd
2982 2982 s 
2982 2982 s .cpfddname
2982 2982 s 
2982 2982 d 11832a
2982 2982 s 	ld 	de,out_buffer
2985 2985 d 0e20
2985 2985 s 	ld 	c,32
2987 2987 d 060e
2987 2987 s 	ld 	b,14
2989 2989 d cd192a
2989 2989 s 	call 	append_z
298c 298c s 
298c 298c s show_disk_info:
298c 298c s 
298c 298c d 21832a
298c 298c s 	ld 	hl,out_buffer
298f 298f d 0e21
298f 298f s 	ld 	c,32+1
2991 2991 d cd3d2a
2991 2991 s 	call 	fix_width
2994 2994 d cdc522
2994 2994 s 	call 	PSTR
2997 2997 s 
2997 2997 s ; 	ld 	hl,mount_crlf
2997 2997 s ; 	call 	PSTR
2997 2997 s 
2997 2997 s skip_disk:
2997 2997 d c9
2997 2997 s 	ret
2998 2998 s 
2998 2998 s build_disk_name:
2998 2998 d af
2998 2998 s 	xor 	a
2999 2999 d 32832a
2999 2999 s 	ld 	(out_buffer+00),a
299c 299c s ; 	ld 	(out_buffer+32),a
299c 299c s 
299c 299c d 3ae722
299c 299c s 	ld 	a,(DRV)
299f 299f d c641
299f 299f s 	add 	a,'A'
29a1 29a1 d 327e2a
29a1 29a1 s 	ld 	(mount_msg_drv),a
29a4 29a4 s 
29a4 29a4 d 015257
29a4 29a4 s 	ld 	bc,'RW'
29a7 29a7 d 3ab72a
29a7 29a7 s 	ld 	a,(drive_rw_status)
29aa 29aa d b7
29aa 29aa s 	or 	a
29ab 29ab d 79
29ab 29ab s 	ld 	a,c
29ac 29ac d c2b029
29ac 29ac s 	jp 	nz,.rw
29af 29af d 78
29af 29af s 	ld 	a,b
29b0 29b0 s .rw:
29b0 29b0 d 32802a
29b0 29b0 s 	ld 	(mount_msg_rw),a
29b3 29b3 s 
29b3 29b3 s ;--
29b3 29b3 d 11832a
29b3 29b3 s 	ld 	de,out_buffer
29b6 29b6 d 217e2a
29b6 29b6 s 	ld 	hl,mount_msg
29b9 29b9 d 0e20
29b9 29b9 s 	ld 	c,32
29bb 29bb d 060e
29bb 29bb s 	ld 	b,14
29bd 29bd d cd192a
29bd 29bd s 	call 	append_z
29c0 29c0 s 
29c0 29c0 d c9
29c0 29c0 s 	ret
29c1 29c1 s 
29c1 29c1 s ;in (DRV)
29c1 29c1 s ;de - addr
29c1 29c1 s ;z=0 if de=0
29c1 29c1 s get_drvinfo_ptr:
29c1 29c1 d e5
29c1 29c1 s 	push 	hl
29c2 29c2 d 3ae722
29c2 29c2 s 	ld 	a,(DRV)
29c5 29c5 d 87
29c5 29c5 s 	add 	a,a
29c6 29c6 d 5f
29c6 29c6 s 	ld 	e,a
29c7 29c7 d 1600
29c7 29c7 s 	ld 	d,0
29c9 29c9 d 2a6f2a
29c9 29c9 s 	ld 	hl,(drivetab_mount_info)
29cc 29cc s 	
29cc 29cc d 7c
29cc 29cc s 	ld 	a,h
29cd 29cd d b5
29cd 29cd s 	or 	l
29ce 29ce d cad929
29ce 29ce s 	jp 	z,errZeroDrvInfoTab
29d1 29d1 d 19
29d1 29d1 s 	add 	hl,de
29d2 29d2 d 5e
29d2 29d2 s 	ld 	e,(hl)
29d3 29d3 d 23
29d3 29d3 s 	inc 	hl
29d4 29d4 d 56
29d4 29d4 s 	ld 	d,(hl)
29d5 29d5 d 7b
29d5 29d5 s 	ld 	a,e
29d6 29d6 d b2
29d6 29d6 s 	or 	d
29d7 29d7 d e1
29d7 29d7 s 	pop 	hl
29d8 29d8 d c9
29d8 29d8 s 	ret
29d9 29d9 s errZeroDrvInfoTab:
29d9 29d9 d 21e029
29d9 29d9 s 	ld 	hl,msgZeroDrvInfoTab
29dc 29dc d cdc522
29dc 29dc s 	call 	PSTR
29df 29df d 76
29df 29df s 	halt
29e0 29e0 s msgZeroDrvInfoTab:
29e0 29e0 d 53686f77496e666f3a204472765461623d3030303000
29e0 29e0 s 	db 	'ShowInfo: DrvTab=0000',0
29f6 29f6 s 
29f6 29f6 s build_emu_name:
29f6 29f6 s 
29f6 29f6 d 11832a
29f6 29f6 s 	ld 	de,out_buffer
29f9 29f9 d 0e20
29f9 29f9 s 	ld 	c,32
29fb 29fb d 060e
29fb 29fb s 	ld 	b,14
29fd 29fd s 
29fd 29fd d 21b82a
29fd 29fd s 	ld 	hl,mount_info_from_emu+1
2a00 2a00 d cd192a
2a00 2a00 s 	call 	append_z
2a03 2a03 s 	
2a03 2a03 d 3e2f
2a03 2a03 s 	ld 	a,'/'
2a05 2a05 d 12
2a05 2a05 s 	ld 	(de),a
2a06 2a06 d 13
2a06 2a06 s 	inc 	de
2a07 2a07 d af
2a07 2a07 s 	xor 	a
2a08 2a08 d 12
2a08 2a08 s 	ld 	(de),a
2a09 2a09 s 
2a09 2a09 s 
2a09 2a09 d 11832a
2a09 2a09 s 	ld 	de,out_buffer
2a0c 2a0c d 21c62a
2a0c 2a0c s 	ld 	hl,mount_info_from_emu+1+14
2a0f 2a0f d 0e20
2a0f 2a0f s 	ld 	c,32
2a11 2a11 d 060e
2a11 2a11 s 	ld 	b,14
2a13 2a13 d cd192a
2a13 2a13 s 	call 	append_z
2a16 2a16 s 
2a16 2a16 d af
2a16 2a16 s 	xor 	a
2a17 2a17 d 12
2a17 2a17 s 	ld 	(de),a
2a18 2a18 s 
2a18 2a18 d c9
2a18 2a18 s 	ret
2a19 2a19 s 
2a19 2a19 s 
2a19 2a19 s 
2a19 2a19 s 
2a19 2a19 s ;append (skip all not 0 and then copy_z)
2a19 2a19 s append_z:
2a19 2a19 d 79
2a19 2a19 s 	ld 	a,c
2a1a 2a1a d b7
2a1a 2a1a s 	or 	a
2a1b 2a1b d c8
2a1b 2a1b s 	ret 	z
2a1c 2a1c s 
2a1c 2a1c d 7e
2a1c 2a1c s 	ld 	a,(hl)
2a1d 2a1d d b7
2a1d 2a1d s 	or 	a
2a1e 2a1e d c8
2a1e 2a1e s 	ret 	z
2a1f 2a1f s 
2a1f 2a1f s .skipAppend:
2a1f 2a1f d 1a
2a1f 2a1f s 	ld 	a,(de)
2a20 2a20 d b7
2a20 2a20 s 	or 	a
2a21 2a21 d ca2c2a
2a21 2a21 s 	jp 	z,copy_z
2a24 2a24 d 13
2a24 2a24 s 	inc 	de
2a25 2a25 d 0d
2a25 2a25 s 	dec 	c
2a26 2a26 d ca2c2a
2a26 2a26 s 	jp 	z,copy_z	
2a29 2a29 s 
2a29 2a29 d c31f2a
2a29 2a29 s 	jp 	.skipAppend
2a2c 2a2c s 
2a2c 2a2c s ;copy upto C char (or till 0) from HL to DE
2a2c 2a2c s ;c - dstbuf sizw
2a2c 2a2c s ;b - from buf size
2a2c 2a2c s ;hl pointed to NULL terminated string
2a2c 2a2c s 
2a2c 2a2c s copy_z:
2a2c 2a2c d 79
2a2c 2a2c s 	ld 	a,c	;to str size left =0
2a2d 2a2d d b7
2a2d 2a2d s 	or 	a
2a2e 2a2e d c8
2a2e 2a2e s 	ret 	z
2a2f 2a2f s 
2a2f 2a2f d 78
2a2f 2a2f s 	ld 	a,b 	;from str size left =0
2a30 2a30 d b7
2a30 2a30 s 	or 	a
2a31 2a31 d c8
2a31 2a31 s 	ret 	z
2a32 2a32 s 
2a32 2a32 d 7e
2a32 2a32 s 	ld 	a,(hl)
2a33 2a33 d 12
2a33 2a33 s 	ld 	(de),a
2a34 2a34 d b7
2a34 2a34 s 	or 	a
2a35 2a35 d c8
2a35 2a35 s 	ret 	z
2a36 2a36 s ; 	jp 	nz,.copy_z_store
2a36 2a36 s ; 	ld 	a,'_'
2a36 2a36 s ; .copy_z_store:
2a36 2a36 d 23
2a36 2a36 s 	inc 	hl
2a37 2a37 d 13
2a37 2a37 s 	inc 	de
2a38 2a38 d 0d
2a38 2a38 s 	dec 	c
2a39 2a39 d 05
2a39 2a39 s 	dec 	b
2a3a 2a3a d c32c2a
2a3a 2a3a s 	jp 	copy_z
2a3d 2a3d s 
2a3d 2a3d s ;hl ptr
2a3d 2a3d s ;c  len
2a3d 2a3d s ;дополняет хвост строки пробелами делая её длинной len
2a3d 2a3d s fix_width:
2a3d 2a3d d 79
2a3d 2a3d s 	ld 	a,c
2a3e 2a3e d b7
2a3e 2a3e s 	or 	a
2a3f 2a3f d c8
2a3f 2a3f s 	ret 	z
2a40 2a40 s 
2a40 2a40 d e5
2a40 2a40 s 	push 	hl
2a41 2a41 s 
2a41 2a41 d 2b
2a41 2a41 s 	dec 	hl
2a42 2a42 s .skipLP:	
2a42 2a42 d 0d
2a42 2a42 s 	dec 	c
2a43 2a43 d ca562a
2a43 2a43 s 	jp 	z,.endfill
2a46 2a46 d 23
2a46 2a46 s 	inc 	hl
2a47 2a47 d 7e
2a47 2a47 s 	ld 	a,(hl)
2a48 2a48 d b7
2a48 2a48 s 	or 	a
2a49 2a49 d c2422a
2a49 2a49 s 	jp 	nz, .skipLP
2a4c 2a4c s 
2a4c 2a4c d 3e20
2a4c 2a4c s 	ld 	a,' '
2a4e 2a4e s 
2a4e 2a4e s .fillLoop:
2a4e 2a4e d 77
2a4e 2a4e s 	ld 	(hl),a
2a4f 2a4f d 23
2a4f 2a4f s 	inc 	hl
2a50 2a50 d 0d
2a50 2a50 s 	dec 	c
2a51 2a51 d c24e2a
2a51 2a51 s 	jp 	nz,.fillLoop
2a54 2a54 s 
2a54 2a54 d af
2a54 2a54 s 	xor 	a
2a55 2a55 d 77
2a55 2a55 s 	ld 	(hl),a 	;0
2a56 2a56 s .endfill:
2a56 2a56 d e1
2a56 2a56 s 	pop 	hl
2a57 2a57 d c9
2a57 2a57 s 	ret
2a58 2a58 s 
2a58 2a58 s get_mount_info:
2a58 2a58 d 3e80
2a58 2a58 s 	ld 	a,API_GET_MOUNT_NAME
2a5a 2a5a d 32e622
2a5a 2a5a s 	ld 	(CMD),a
2a5d 2a5d d cd8a22
2a5d 2a5d s 	call 	SENDCMD
2a60 2a60 s 
2a60 2a60 d 0e1d
2a60 2a60 s 	ld 	c,29
2a62 2a62 s 
2a62 2a62 s receive_c_bytes_to_hl:
2a62 2a62 s 
2a62 2a62 d 21b72a
2a62 2a62 s 	ld 	hl,mount_info_from_emu
2a65 2a65 s get_lp:
2a65 2a65 d cd3122
2a65 2a65 s 	call 	GETBYTE
2a68 2a68 d 77
2a68 2a68 s 	ld 	(HL),a
2a69 2a69 d 23
2a69 2a69 s 	inc 	hl
2a6a 2a6a d 0d
2a6a 2a6a s 	dec 	c
2a6b 2a6b d c2652a
2a6b 2a6b s 	jp 	nz,get_lp
2a6e 2a6e d c9
2a6e 2a6e s 	ret
2a6f 2a6f s 
2a6f 2a6f s ;GETBYTE:
2a6f 2a6f s ; 	PUSH	HL
2a6f 2a6f s ; 	LD	HL,PORTC
2a6f 2a6f s ; WG:
2a6f 2a6f s ; 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2a6f 2a6f s ; 	AND	20h		; выделяем сигнал IBF
2a6f 2a6f s ; 	JP	Z,WG		; IBF=0 - данных еще нет
2a6f 2a6f s ; 	DEC	L
2a6f 2a6f s ; 	DEC	L
2a6f 2a6f s ; 	LD	A,(HL)		; данные поступили - выбираем их из порта А
2a6f 2a6f s ; 	POP	HL
2a6f 2a6f s ; 	RET
2a6f 2a6f s 
2a6f 2a6f s 
2a6f 2a6f s drivetab_mount_info:
2a6f 2a6f d 0000
2a6f 2a6f s 		dw 	0
2a71 2a71 s 
2a71 2a71 s msg_default_mount:
2a71 2a71 d 4472697665206d61703a0d0a
2a71 2a71 s 		db 	'Drive map:',0dh,0ah
2a7d 2a7d s ;		db 	'          1         2         3         4         5         6   '
2a7d 2a7d s ;		db 	'0123456789012345678901234567890123456789012345678901234567890123'
2a7d 2a7d d 00
2a7d 2a7d s 		db 	0
2a7e 2a7e s mount_msg:	
2a7e 2a7e d 413a
2a7e 2a7e s mount_msg_drv: 	db 	'A:'
2a80 2a80 d 5720
2a80 2a80 s mount_msg_rw:	db 	'W '
2a82 2a82 d 00
2a82 2a82 s 		db 	0
2a83 2a83 s out_buffer:
2a83 2a83 s 		ds 	32
2aa3 2aa3 d 00
2aa3 2aa3 s 		db 	0
2aa4 2aa4 s msg_fdd:
2aa4 2aa4 d 24464444202d20
2aa4 2aa4 s 		db	'$FDD - '
2aab 2aab d 4100
2aab 2aab s msg_fdd_drv:	db 	'A',0
2aad 2aad s 
2aad 2aad s msg_fdd_err:
2aad 2aad d 3f3f4552524f523f3f00
2aad 2aad s 		db 	'??ERROR??',0
2ab7 2ab7 s 
2ab7 2ab7 s mount_info_from_emu: 	
2ab7 2ab7 s drive_rw_status:
2ab7 2ab7 d 00
2ab7 2ab7 s 		db 	0 			;=1 if R/O
2ab8 2ab8 d 2020202020202020202020202020
2ab8 2ab8 s 		db 	'              ' 	;Folder 14 asciiZ 
2ac6 2ac6 d 2020202020202020202020202020
2ac6 2ac6 s 		db 	'              ' 	;Name   14 asciiZ
2ad4 2ad4 d 00
2ad4 2ad4 s 		db 	0
2ad5 2ad5 s 
2ad5 2ad5 d 0d0a00
2ad5 2ad5 s mount_crlf: 	db 	0dh,0ah,0	
2ad8 2ad8 s 
2ad8 2ad8 s msgDRIVE_F:
2ad8 2ad8 d 463a202d202f455852544f4f4c532e4b44492077697468204d4f554e5420616e64206f7468657220455854524f4d2072656c61746564207574696c73
2ad8 2ad8 s 		db 	'F: - /EXRTOOLS.KDI with MOUNT and other EXTROM related utils'
2b14 2b14 d 0d0a00
2b14 2b14 s 		db 	0x0d,0x0a,0
2b17 2b17 s 
2b17 2b17 s ; CMD:	DB	1		; Команда чтения
2b17 2b17 s ; DRV:	DB	0
2b17 2b17 s ; TRK:	DB	0
2b17 2b17 s ; SEC:	DB	0
2b17 2b17 s 
2b17 2b17 s 
2b17 2b17 s ; 80 — получить имя образа
2b17 2b17 s 
2b17 2b17 s ; Команда предназначена для получения имени KDI-файла, смонтированного в данный момент на логическом устройстве A-D.  
2b17 2b17 s ;  Номер устройства задается в поле DRV. Возвращается буфер размером 29 байт, содержащий следующую информацию:
2b17 2b17 s 
2b17 2b17 s ; 1 байт флага разрешение записи (0 — чтение/запись, 1 — только чтение)
2b17 2b17 s ; 14-байтовый буфер с именем каталога, из которого смонтирован файл образа, заканчивающийся 0.
2b17 2b17 s ; 14-байтовый буфер с именем файла, заканчивающийся 0.
2b17 2b17 s 
2b17 2b17 s ; 82 — проверка состояния устройства
2b17 2b17 s ; 	Команда возвращает ответ ОК, если устройство смонтировано, или Fail, если не смонтировано. 
2b17 2b17 s ; Флаг состояния автоматически опускается в случае ошибок ввода-вывода на данном устройстве. 
2b17 2b17 s ; С помощью этой команды можно проверить результат предыдущего вызова mount (81)
2b17 2b17 f generator/V0/extrom-patcher.asm
2b17 2b17 s 	include 	"extrom-patcher-resident-cpm-body.asm"
2b17 2b17 f extrom-patcher-resident-cpm-body.asm
2b17 2b17 s rPORTA	EQU	0FB08H		; Порт Канала A интерфейса расширения
2b17 2b17 s rPORTC	EQU	0FB0AH		; Порт Канала С интерфейса расширения
2b17 2b17 s rPCWR	EQU	0FB0BH		; Порт управляющих команд
2b17 2b17 s 
2b17 2b17 s _DSK 	EQU 	0xFFFF
2b17 2b17 s _OPER 	EQU 	0xFFFF
2b17 2b17 s _TRK 	EQU 	0xFFFF
2b17 2b17 s _SEC 	EQU 	0xFFFF
2b17 2b17 s _DMA 	EQU 	0xFFFF
2b17 2b17 s 
2b17 2b17 s _RRBUFF	EQU 	0xEE00
2b17 2b17 s 
2b17 2b17 s cpm_resident_body 	macro	preffix
2b17 2b17 s 
2b17 2b17 s ;keyhook support removed 2014-10-22
2b17 2b17 s ;больше нет нужды в ней, т.к. есть диск F
2b17 2b17 s ; preffix&kbd_hook_noCtrl_03;
2b17 2b17 s ; 	ld 	(preffix&save_a),a
2b17 2b17 s ; 	cp 	0x03
2b17 2b17 s ; 	jp 	preffix&kbd_hook_noCtrl_chk
2b17 2b17 s 
2b17 2b17 s ; preffix&kbd_hook_noCtrl_33:
2b17 2b17 s ; 	ld 	(preffix&save_a),a
2b17 2b17 s ; 	cp 	0x33
2b17 2b17 s 
2b17 2b17 s ; preffix&kbd_hook_noCtrl_chk:
2b17 2b17 s ; 	jp 	nz,preffix&bios_hook
2b17 2b17 s 
2b17 2b17 s ; 	ld 	a,(0xf880)
2b17 2b17 s ; 	and 	00100001b
2b17 2b17 s ; 	cp 	00100001b
2b17 2b17 s 
2b17 2b17 s ; 	jp 	nz,preffix&bios_hook
2b17 2b17 s 
2b17 2b17 s ; 	jp 	preffix&do_key_action
2b17 2b17 s 
2b17 2b17 s ; preffix&kbd_hook_2133:
2b17 2b17 s ; 	ld 	(preffix&save_a),a
2b17 2b17 s ; 	ld 	a,c
2b17 2b17 s ; 	cp 	0x33 	;stop
2b17 2b17 s ; 	jp 	nz,preffix&bios_hook
2b17 2b17 s 
2b17 2b17 s ; 	ld 	a,b
2b17 2b17 s ; 	cp 	0x21 	;ctrl+stop
2b17 2b17 s ; 	jp 	nz,preffix&bios_hook
2b17 2b17 s 
2b17 2b17 s ; preffix&do_key_action:
2b17 2b17 s ; 	push 	hl
2b17 2b17 s ; 	push 	de
2b17 2b17 s ; 	push 	bc
2b17 2b17 s ; 	ld 	hl,preffix&msg_hook
2b17 2b17 s ; 	ld 	de,0xfc00
2b17 2b17 s ; preffix&.kmlp:	
2b17 2b17 s ; 	ld 	a,(hl)
2b17 2b17 s ; 	or 	a
2b17 2b17 s ; 	jp 	z,preffix&.kmlp_ext
2b17 2b17 s ; 	ld 	(de),a
2b17 2b17 s ; 	inc 	hl
2b17 2b17 s ; 	inc 	de
2b17 2b17 s ; 	jp 	preffix&.kmlp
2b17 2b17 s 
2b17 2b17 s ; preffix&.kmlp_ext:
2b17 2b17 s ; 	pop 	bc
2b17 2b17 s ; 	pop 	de
2b17 2b17 s ; 	pop 	hl
2b17 2b17 s 
2b17 2b17 s ; 	ld 	bc,0 	;simulate no key
2b17 2b17 s ; 	ld 	a,0
2b17 2b17 s ; 	jp 	preffix&old_hook
2b17 2b17 s ; ; 	halt
2b17 2b17 s 
2b17 2b17 s 
2b17 2b17 s ; preffix&bios_hook:
2b17 2b17 s ; 	ld 	a,(preffix&save_a)
2b17 2b17 s 
2b17 2b17 s ; preffix&old_hook:
2b17 2b17 s ; 	jp 	$
2b17 2b17 s ; preffix&save_a:
2b17 2b17 s ; 	db 	0	
2b17 2b17 s ; preffix&msg_hook:
2b17 2b17 s ; 	db 	'CTRL+SHIFT+STOP pressed',0
2b17 2b17 s 
2b17 2b17 s ;ptrs to drive drvreg bytes 
2b17 2b17 s preffix&res_DRIVE_TAB:
2b17 2b17 s 	dw 	0 	;A
2b17 2b17 s 	dw 	0 	;B
2b17 2b17 s 	dw 	0 	;C
2b17 2b17 s 	dw 	0 	;D
2b17 2b17 s 	dw 	0 	;E
2b17 2b17 s 	dw 	0 	;F
2b17 2b17 s 
2b17 2b17 s 
2b17 2b17 s preffix&dph_F:
2b17 2b17 s 	dw	0	;_XLT:           
2b17 2b17 s 	dw	0	;_1:             
2b17 2b17 s 	dw	0	;_2:             
2b17 2b17 s 	dw	0	;_3:             
2b17 2b17 s 	dw	0xFC00	;DirBuf: value store here via patcher 0xfc00 - debug
2b17 2b17 s 	dw	preffix&dpb_F	;DPB:   
2b17 2b17 s 	dw	0	;CSV: - fixed drive   
2b17 2b17 s 	dw	preffix&alw_F	;ALV:   
2b17 2b17 s 
2b17 2b17 s 
2b17 2b17 s ;  ФИЗИЧЕСКИЕ ПАРАМЕТРЫ ДИСКА
2b17 2b17 s ;--------------------------------------
2b17 2b17 s       DB 50H	;контрольная сумма
2b17 2b17 s 
2b17 2b17 s       DB 080H ;константа скорости движения головки.
2b17 2b17 s ;	; 3 - 30 мс на шаг, 2 - 20 мс, 1 - 12 мс,
2b17 2b17 s ;	; 0 - 6 мс и 80H - 3 мс.
2b17 2b17 s       DB 05H  ; число физических секторов на дорожке
2b17 2b17 s       DB 01H  ; информация о сторонах диска
2b17 2b17 s ;	;( 00 - односторонный диск
2b17 2b17 s ;	;  01 - двухсторонний диск
2b17 2b17 s       DB 03	; 512 bytes/sector
2b17 2b17 s ;	;( 00 - 128 байт/сектор
2b17 2b17 s ;	;  01 - 256 байт/сектор
2b17 2b17 s ;	;  02 - 512 байт/сектор
2b17 2b17 s ;	;  03 - 1024 байт/сектор
2b17 2b17 s       DB 0	; номер текущей дорожки.
2b17 2b17 s       DB 0	; позиционный номер устройства (00000100) - для записи в регистр выбора
2b17 2b17 s ;---------------------------------------------------
2b17 2b17 s       DB 0	;INFO	; флаг успешного считывания
2b17 2b17 s 
2b17 2b17 s preffix&dpb_F:
2b17 2b17 s ; kdi params
2b17 2b17 s       DW 40	;128 байтовых секторов/трек ; SPT
2b17 2b17 s       DB 4	; размер блока миним.кбайт  ; BSH
2b17 2b17 s ;	; фактор сдвига блока распределения данных
2b17 2b17 s ;	; определяется размером блока данных. Блок 
2b17 2b17 s ;	; данных - минимально возможная частица файла.
2b17 2b17 s ;	; Размер блока - 1, 2, 4, 8 или 16 Кбайт. Если
2b17 2b17 s ;	; блок имеет большой размер, в каждом файле 
2b17 2b17 s ;	; теряется значительное число неиспользуемых
2b17 2b17 s ;	; секторов. При уменьшении размера блока
2b17 2b17 s ;	; увеличивается размер директории, описывающий
2b17 2b17 s ;	; расположение частей файла. BSH = log2[число
2b17 2b17 s ;	; логических секторов в блоке].
2b17 2b17 s       DB 15	; число логических сек/блок  ; BLM
2b17 2b17 s ;	; маска блока распределения данных.
2b17 2b17 s ;	; BLM = (число логических секторов в блоке)-1.
2b17 2b17 s       DB 0	; extent mask                ; EXM
2b17 2b17 s ;	; = (BLM+1)*128/1024 - 1 - [DSM/256]. EXM - 
2b17 2b17 s ;	; вспомогательная величина для определения
2b17 2b17 s ;	; номера extent'а.
2b17 2b17 s ;	; extent - часть файла, описываемая одним 
2b17 2b17 s ;	; входом в директорию.
2b17 2b17 s       DW 394	; обьем диска в блоках-1     ; DSM
2b17 2b17 s       DW 127	; входов в директорий-1      ; DRM
2b17 2b17 s       DB 192	; определяет, какие блоки    ; AL0
2b17 2b17 s ;	; зарезервированы
2b17 2b17 s       DB 0	; alloc 1                    ; AL1
2b17 2b17 s ;	; под директорию. Каждый  бит AL0,AL1, 
2b17 2b17 s ;	; начиная со старшего бита AL0 и кончая 
2b17 2b17 s ;	; младшим битом AL1, значением 1 резервирует
2b17 2b17 s ;	; один блок данных для директории. Нужно
2b17 2b17 s ;	; резервировать необходимое число блоков
2b17 2b17 s ;	; для хранения входов в директорию: 32*DRM/BLS
2b17 2b17 s       DW 0	; размер вектора контроля директории. ; CKS
2b17 2b17 s ;	; CKS=(DRM+1)/4. Если диск не сменяем, CKS=0.
2b17 2b17 s       DW 2	; число системных дорожек    ; OFS
2b17 2b17 s 
2b17 2b17 s 
2b17 2b17 s ; preffix&alw_F: 	ds 	50
2b17 2b17 s preffix&alw_F: 	ds 	50
2b17 2b17 s 
2b17 2b17 s 
2b17 2b17 s preffix&res_seldsk:
2b17 2b17 s 	ld 	a,c
2b17 2b17 s 	cp 	0xfe
2b17 2b17 s preffix&old_seld_dsk:
2b17 2b17 s 	jp 	nz,$	
2b17 2b17 s 	ld 	hl,preffix&res_DRIVE_TAB
2b17 2b17 s 	ret
2b17 2b17 s 
2b17 2b17 s 
2b17 2b17 s ;RAM:DA27 C3 EB DC                 jp      j_READ
2b17 2b17 s 
2b17 2b17 s ;RAM:DCEB          j_READ:                                 ; CODE XREF: RAM:_READj
2b17 2b17 s ;RAM:DCEB                                                  ; RAM:DB84p
2b17 2b17 s ;RAM:DCEB
2b17 2b17 s ;RAM:DCEB          ; FUNCTION CHUNK AT RAM:DDC4 SIZE 0000007B BYTES
2b17 2b17 s ;RAM:DCEB
2b17 2b17 s ;RAM:DCEB 3E 04                    ld      a, 4
2b17 2b17 s ;RAM:DCED 32 66 E0                 ld      (_OPERATION), a
2b17 2b17 s ;RAM:DCF0 3A 64 E0                 ld      a, (_DSK)
2b17 2b17 s ;RAM:DCF3 FE 04                    cp      4
2b17 2b17 s ;RAM:DCF5 CA C4 DD                 jp      z, loc_DDC4
2b17 2b17 s 
2b17 2b17 s ;сюда попадает из биоса JP READ
2b17 2b17 s ;а если не наше то прыгаем на старый read
2b17 2b17 s preffix&res_READ:
2b17 2b17 s ; 	ld	 A,4	;Режим чтения
2b17 2b17 s ; 	ld  	(_OPER),a
2b17 2b17 s preffix&r_p_DSK1:
2b17 2b17 s 	ld 	a,(_DSK) 	;_DSK
2b17 2b17 s 	cp 	4
2b17 2b17 s 	jp 	z,preffix&_old_read
2b17 2b17 s 
2b17 2b17 s 	cp 	5 		;disk F mapped to EMU drive E
2b17 2b17 s 	jp 	nz,preffix&.r_no_drv_dec
2b17 2b17 s 	dec 	a
2b17 2b17 s 
2b17 2b17 s preffix&.r_no_drv_dec:
2b17 2b17 s 	LD	(preffix&EXR_DRV),A	; # устройства
2b17 2b17 s 
2b17 2b17 s 	push 	hl
2b17 2b17 s preffix&r_p_SELDSKDRIVER:
2b17 2b17 s 	ld 	hl,(0)	;EXR_SELDSK_DRIVE
2b17 2b17 s 	ld 	a,(hl)
2b17 2b17 s 	pop 	hl
2b17 2b17 s 	or 	a
2b17 2b17 s 	jp 	nz,preffix&_old_read
2b17 2b17 s 
2b17 2b17 s preffix&r_p_TRK1:
2b17 2b17 s 	LD	A,(_TRK)	
2b17 2b17 s 	LD	(preffix&EXR_TRK),A	; дорожка
2b17 2b17 s preffix&r_p_SEC1:
2b17 2b17 s 	LD	A,(_SEC)	; сектор
2b17 2b17 s 	DEC	A		; у нас номер сектора начинается с 0
2b17 2b17 s 	LD	(preffix&EXR_SEC),A
2b17 2b17 s 
2b17 2b17 s 	LD	A,1
2b17 2b17 s 	LD	(preffix&EXR_CMD),A	; 1 - команда чтения
2b17 2b17 s 
2b17 2b17 s 	CALL	preffix&EXR_SENDCMD	; отсылаем команду
2b17 2b17 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
2b17 2b17 s 	RET	NZ		; 0 - ошибка
2b17 2b17 s preffix&r_p_DMA1:
2b17 2b17 s 	LD	HL,(_DMA)	; адрес буфера для приема данных
2b17 2b17 s 	CALL	preffix&EXR_GETSEC	; принимаем данные
2b17 2b17 s 	XOR	A		; завершение всегда успешно
2b17 2b17 s 	RET
2b17 2b17 s ;
2b17 2b17 s 
2b17 2b17 s preffix&_old_read:
2b17 2b17 s 	jp 	$
2b17 2b17 s 
2b17 2b17 s preffix&res_WRITE:
2b17 2b17 s ; 	ld	 A,6	;Режим чтения
2b17 2b17 s ; 	ld  	(_OPER),a
2b17 2b17 s 
2b17 2b17 s preffix&r_p_DSK2:
2b17 2b17 s 	ld 	a,(_DSK) 	;_DSK
2b17 2b17 s 	cp 	4
2b17 2b17 s 	jp 	z,preffix&_old_write
2b17 2b17 s 	cp 	5 		;disk F mapped to EMU drive E
2b17 2b17 s 	jp 	nz,preffix&.w_no_drv_dec
2b17 2b17 s 	dec 	a
2b17 2b17 s preffix&.w_no_drv_dec:
2b17 2b17 s 	LD	(preffix&EXR_DRV),A
2b17 2b17 s 
2b17 2b17 s 
2b17 2b17 s 	push 	hl
2b17 2b17 s preffix&r_p_SELDSKDRIVEW:
2b17 2b17 s 	ld 	hl,(0)	;EXR_SELDSK_DRIVE
2b17 2b17 s 	ld 	a,(hl)
2b17 2b17 s 	pop 	hl
2b17 2b17 s 	or 	a
2b17 2b17 s 	jp 	nz,preffix&_old_write
2b17 2b17 s 
2b17 2b17 s preffix&r_p_TRK2:
2b17 2b17 s 	LD	A,(_TRK)
2b17 2b17 s 	LD	(preffix&EXR_TRK),A
2b17 2b17 s preffix&r_p_SEC2:
2b17 2b17 s 	LD	A,(_SEC)
2b17 2b17 s 	DEC	A
2b17 2b17 s 	LD	(preffix&EXR_SEC),A
2b17 2b17 s 
2b17 2b17 s 	LD	A,2		; 2 - команда записи
2b17 2b17 s 	LD	(preffix&EXR_CMD),A
2b17 2b17 s 
2b17 2b17 s 	CALL	preffix&EXR_SENDCMD
2b17 2b17 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
2b17 2b17 s 	RET	NZ		; 0 - ошибка
2b17 2b17 s preffix&r_p_DMA2:
2b17 2b17 s 	LD	HL,(_DMA)
2b17 2b17 s 	CALL	preffix&EXR_PUTSEC
2b17 2b17 s 	XOR	A		; запись успешна
2b17 2b17 s 	RET
2b17 2b17 s 
2b17 2b17 s preffix&_old_write:
2b17 2b17 s 	jp 	$
2b17 2b17 s 
2b17 2b17 s 
2b17 2b17 s preffix&res_GETINFO:
2b17 2b17 s 
2b17 2b17 s 	LD 	A,(HL)	; A= маска выбора привода
2b17 2b17 s 	or 	a
2b17 2b17 s 	jp 	nz,preffix&_old_getinfo 	;=0 if emulated
2b17 2b17 s 
2b17 2b17 s ;
2b17 2b17 s ;  Чтение с эмулируемых дисков A или B
2b17 2b17 s ;
2b17 2b17 s 	push 	hl
2b17 2b17 s 	CALL	preffix&EXR_READINFO
2b17 2b17 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
2b17 2b17 s ; 	JP	NZ,0xE6ff	;IERR		; 0 - ошибка
2b17 2b17 s preffix&_old_getinfo_chkdo:
2b17 2b17 s 	JP	$ 		;IERR jnz xxx, CHKDO
2b17 2b17 s ; ;
2b17 2b17 s preffix&_old_getinfo:
2b17 2b17 s 	jp 	$ 		;GETINFO
2b17 2b17 s 
2b17 2b17 s 
2b17 2b17 s ;==================  Драйвер ExtROM-API ====================================
2b17 2b17 s 	
2b17 2b17 s 	
2b17 2b17 s ;****************************************
2b17 2b17 s ;*  Прием байта из порта А по стробу    *
2b17 2b17 s ;****************************************
2b17 2b17 s preffix&EXR_GETBYTE:
2b17 2b17 s 	PUSH	HL
2b17 2b17 s 	LD	HL,rPORTC
2b17 2b17 s preffix&pWG:
2b17 2b17 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2b17 2b17 s 	AND	20h		; выделяем сигнал IBF
2b17 2b17 s 	JP	Z,preffix&pWG		; IBF=0 - данных еще нет
2b17 2b17 s 	LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
2b17 2b17 s 	POP	HL
2b17 2b17 s 	RET
2b17 2b17 s 
2b17 2b17 s ;****************************************
2b17 2b17 s ;*  Отправка байта в порт A             *
2b17 2b17 s ;****************************************
2b17 2b17 s preffix&EXR_PUTBYTE:
2b17 2b17 s 	PUSH	HL
2b17 2b17 s 	PUSH	AF
2b17 2b17 s 	LD	HL,rPORTC
2b17 2b17 s preffix&pWP:
2b17 2b17 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2b17 2b17 s 	AND	80h		; выделяем сигнал -OBF
2b17 2b17 s 	JP	Z,preffix&pWP		; -OBF=0 - в передатчике сидит незабранный байт
2b17 2b17 s 	POP	AF
2b17 2b17 s 	LD	(rPORTA),A		; данные поступили - выбираем их из порта А
2b17 2b17 s 	POP	HL
2b17 2b17 s 	RET
2b17 2b17 s 
2b17 2b17 s ;*******************************************
2b17 2b17 s ;*      Прием сектора                      *
2b17 2b17 s ;* HL - адрес размещения сектора в памяти  *
2b17 2b17 s ;*  Размер сектора - 128 байт              *
2b17 2b17 s ;*******************************************
2b17 2b17 s preffix&EXR_GETSEC:
2b17 2b17 s 	di
2b17 2b17 s 	PUSH	BC
2b17 2b17 s 	PUSH	DE
2b17 2b17 s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
2b17 2b17 s 	EX	DE,HL		; адрес буфера -> DE
2b17 2b17 s 	LD	HL,rPORTC
2b17 2b17 s preffix&pGSL:
2b17 2b17 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2b17 2b17 s 	AND	20h		; выделяем сигнал IBF
2b17 2b17 s 	JP	Z,preffix&pGSL		; IBF=0 - данных еще нет
2b17 2b17 s 	LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
2b17 2b17 s 	LD	(DE),A		; принимаем и размещаем очередной байт
2b17 2b17 s 	INC	DE		; указатель буфера ++
2b17 2b17 s 	DEC	C		; принимаем остальные байты
2b17 2b17 s 	JP	NZ,preffix&pGSL
2b17 2b17 s 	POP	DE
2b17 2b17 s 	POP	BC
2b17 2b17 s ; 	ei - int should be still disabled 
2b17 2b17 s 	RET
2b17 2b17 s 
2b17 2b17 s ;*******************************************
2b17 2b17 s ;*      Передача сектора                   *
2b17 2b17 s ;* HL - адрес размещения сектора в памяти  *
2b17 2b17 s ;*  Размер сектора - 128 байт              *
2b17 2b17 s ;*******************************************
2b17 2b17 s preffix&EXR_PUTSEC:
2b17 2b17 s 	di
2b17 2b17 s 	PUSH	BC
2b17 2b17 s 	PUSH	DE
2b17 2b17 s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
2b17 2b17 s 	EX	DE,HL		; адрес буфера -> DE
2b17 2b17 s 	LD	HL,rPORTC
2b17 2b17 s preffix&pPSL:
2b17 2b17 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2b17 2b17 s 	AND	80h		; выделяем сигнал -OBF
2b17 2b17 s 	JP	Z,preffix&pPSL		; -OBF=0 - в передатчике сидит незабранный байт
2b17 2b17 s 	LD	A,(DE)		; принимаем и размещаем очередной байт
2b17 2b17 s 	LD	(rPORTA),A		; данные поступили - выбираем их из порта А
2b17 2b17 s 	INC	DE
2b17 2b17 s 	DEC	C		; принимаем остальные байты
2b17 2b17 s 	JP	NZ,preffix&pPSL
2b17 2b17 s 	POP	DE
2b17 2b17 s 	POP	BC
2b17 2b17 s ; 	ei - int should be still disabled 
2b17 2b17 s 	RET
2b17 2b17 s 
2b17 2b17 s ;****************************************
2b17 2b17 s ;*     Отправка командного пакета       *
2b17 2b17 s ;****************************************
2b17 2b17 s preffix&EXR_SENDCMD:
2b17 2b17 s 
2b17 2b17 s 	di
2b17 2b17 s 	PUSH	HL
2b17 2b17 s 	PUSH	BC
2b17 2b17 s 	LD	A,0Ch
2b17 2b17 s 	LD	(rPCWR),A	; переключаем порт в режим 2
2b17 2b17 s 	LD	HL,preffix&EXR_CMD
2b17 2b17 s 	LD	C,4		; пакет - 4 байта
2b17 2b17 s 	LD	B,0		; заготовка контрольной суммы
2b17 2b17 s preffix&pSCL:
2b17 2b17 s 	LD	A,(HL)		; очередной байт пакета 
2b17 2b17 s 	ADD 	B		; добавляем к КС
2b17 2b17 s 	LD	B,A
2b17 2b17 s 	LD	A,(HL)		; очередной байт пакета 
2b17 2b17 s 	CALL	preffix&EXR_PUTBYTE		; - в порт
2b17 2b17 s 	INC	HL
2b17 2b17 s 	DEC	C
2b17 2b17 s 	JP	NZ,preffix&pSCL
2b17 2b17 s 	LD	A,B
2b17 2b17 s 	DEC 	A		; КС-1
2b17 2b17 s 	CALL	preffix&EXR_PUTBYTE     ; контрольная сумма
2b17 2b17 s 	CALL	preffix&EXR_GETBYTE	; ответ контроллера
2b17 2b17 s 	POP	BC
2b17 2b17 s 	POP	HL
2b17 2b17 s ; 	ei - int should be still disabled 
2b17 2b17 s 	RET
2b17 2b17 s 
2b17 2b17 s ;*******************************************
2b17 2b17 s ;*  Чтение информационного сектора
2b17 2b17 s ;*******************************************
2b17 2b17 s preffix&EXR_READINFO:
2b17 2b17 s 	LD	HL,preffix&EXR_CMD	; командный пакет
2b17 2b17 s 	LD	(HL),1		; команда чтения
2b17 2b17 s 	INC	HL
2b17 2b17 s preffix&r_p_DSK3:
2b17 2b17 s 	LD	A,(_DSK)	; вписываем # устройства
2b17 2b17 s 	LD	(HL),A
2b17 2b17 s 	INC	HL
2b17 2b17 s 	LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
2b17 2b17 s 	INC	HL
2b17 2b17 s 	LD	(HL),0		
2b17 2b17 s 	CALL	preffix&EXR_SENDCMD	; отправляем команду
2b17 2b17 s 	OR	A
2b17 2b17 s 	RET 	Z		; ошибка
2b17 2b17 s 	LD	HL,_RRBUFF	; принимаем данные
2b17 2b17 s 	CALL	preffix&EXR_GETSEC
2b17 2b17 s 	LD	A,1
2b17 2b17 s 	RET
2b17 2b17 s 
2b17 2b17 s 
2b17 2b17 s ; Командный пакет интерфейса Extrom-API
2b17 2b17 s ;===============================================
2b17 2b17 s preffix&EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
2b17 2b17 s preffix&EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
2b17 2b17 s preffix&EXR_TRK:	DB	0	; логическая дорожка
2b17 2b17 s preffix&EXR_SEC:	DB	0	; логический сектор (128b)
2b17 2b17 s 
2b17 2b17 f generator/V0/extrom-patcher.asm
2b17 2b17 s 	endm
2b17 2b17 s 	include 	"extrom-patcher-resident-cpm1.asm"
2b17 2b17 f extrom-patcher-resident-cpm1.asm
2b17 2b17 s 	;    12_87_11_niijaf
2b17 2b17 s 	;     E8AC-EBA6  = 762 
2b17 2b17 s 	;     
2b17 2b17 s 
2b17 2b17 s resident_cpm1	equ $
2b17 2b17 s 
e8ac 2b17 s 	.phase 0xE8AC
e8ac 2b17 s 
e8ac 2b17 s resident_cpm1_addr 	EQU 	$
e8ac 2b17 s 
e8ac 2b17 s 	cpm_resident_body _cpm1_
e8ac 2b17 s 
e8ac 2b17 s ;keyhook support removed 2014-10-22
e8ac 2b17 s ;больше нет нужды в ней, т.к. есть диск F
e8ac 2b17 s ; preffix&kbd_hook_noCtrl_03;
e8ac 2b17 s ; 	ld 	(preffix&save_a),a
e8ac 2b17 s ; 	cp 	0x03
e8ac 2b17 s ; 	jp 	preffix&kbd_hook_noCtrl_chk
e8ac 2b17 s 
e8ac 2b17 s ; preffix&kbd_hook_noCtrl_33:
e8ac 2b17 s ; 	ld 	(preffix&save_a),a
e8ac 2b17 s ; 	cp 	0x33
e8ac 2b17 s 
e8ac 2b17 s ; preffix&kbd_hook_noCtrl_chk:
e8ac 2b17 s ; 	jp 	nz,preffix&bios_hook
e8ac 2b17 s 
e8ac 2b17 s ; 	ld 	a,(0xf880)
e8ac 2b17 s ; 	and 	00100001b
e8ac 2b17 s ; 	cp 	00100001b
e8ac 2b17 s 
e8ac 2b17 s ; 	jp 	nz,preffix&bios_hook
e8ac 2b17 s 
e8ac 2b17 s ; 	jp 	preffix&do_key_action
e8ac 2b17 s 
e8ac 2b17 s ; preffix&kbd_hook_2133:
e8ac 2b17 s ; 	ld 	(preffix&save_a),a
e8ac 2b17 s ; 	ld 	a,c
e8ac 2b17 s ; 	cp 	0x33 	;stop
e8ac 2b17 s ; 	jp 	nz,preffix&bios_hook
e8ac 2b17 s 
e8ac 2b17 s ; 	ld 	a,b
e8ac 2b17 s ; 	cp 	0x21 	;ctrl+stop
e8ac 2b17 s ; 	jp 	nz,preffix&bios_hook
e8ac 2b17 s 
e8ac 2b17 s ; preffix&do_key_action:
e8ac 2b17 s ; 	push 	hl
e8ac 2b17 s ; 	push 	de
e8ac 2b17 s ; 	push 	bc
e8ac 2b17 s ; 	ld 	hl,preffix&msg_hook
e8ac 2b17 s ; 	ld 	de,0xfc00
e8ac 2b17 s ; preffix&.kmlp:	
e8ac 2b17 s ; 	ld 	a,(hl)
e8ac 2b17 s ; 	or 	a
e8ac 2b17 s ; 	jp 	z,preffix&.kmlp_ext
e8ac 2b17 s ; 	ld 	(de),a
e8ac 2b17 s ; 	inc 	hl
e8ac 2b17 s ; 	inc 	de
e8ac 2b17 s ; 	jp 	preffix&.kmlp
e8ac 2b17 s 
e8ac 2b17 s ; preffix&.kmlp_ext:
e8ac 2b17 s ; 	pop 	bc
e8ac 2b17 s ; 	pop 	de
e8ac 2b17 s ; 	pop 	hl
e8ac 2b17 s 
e8ac 2b17 s ; 	ld 	bc,0 	;simulate no key
e8ac 2b17 s ; 	ld 	a,0
e8ac 2b17 s ; 	jp 	preffix&old_hook
e8ac 2b17 s ; ; 	halt
e8ac 2b17 s 
e8ac 2b17 s 
e8ac 2b17 s ; preffix&bios_hook:
e8ac 2b17 s ; 	ld 	a,(preffix&save_a)
e8ac 2b17 s 
e8ac 2b17 s ; preffix&old_hook:
e8ac 2b17 s ; 	jp 	$
e8ac 2b17 s ; preffix&save_a:
e8ac 2b17 s ; 	db 	0	
e8ac 2b17 s ; preffix&msg_hook:
e8ac 2b17 s ; 	db 	'CTRL+SHIFT+STOP pressed',0
e8ac 2b17 s 
e8ac 2b17 s ;ptrs to drive drvreg bytes 
e8ac 2b17 s _cpm1_res_DRIVE_TAB:
e8ac 2b17 d 0000
e8ac 2b17 s 	dw 	0 	;A
e8ae 2b19 d 0000
e8ae 2b19 s 	dw 	0 	;B
e8b0 2b1b d 0000
e8b0 2b1b s 	dw 	0 	;C
e8b2 2b1d d 0000
e8b2 2b1d s 	dw 	0 	;D
e8b4 2b1f d 0000
e8b4 2b1f s 	dw 	0 	;E
e8b6 2b21 d 0000
e8b6 2b21 s 	dw 	0 	;F
e8b8 2b23 s 
e8b8 2b23 s 
e8b8 2b23 s _cpm1_dph_F:
e8b8 2b23 d 0000
e8b8 2b23 s 	dw	0	;_XLT:           
e8ba 2b25 d 0000
e8ba 2b25 s 	dw	0	;_1:             
e8bc 2b27 d 0000
e8bc 2b27 s 	dw	0	;_2:             
e8be 2b29 d 0000
e8be 2b29 s 	dw	0	;_3:             
e8c0 2b2b d 00fc
e8c0 2b2b s 	dw	0xFC00	;DirBuf: value store here via patcher 0xfc00 - debug
e8c2 2b2d d d0e8
e8c2 2b2d s 	dw	_cpm1_dpb_F	;DPB:   
e8c4 2b2f d 0000
e8c4 2b2f s 	dw	0	;CSV: - fixed drive   
e8c6 2b31 d dfe8
e8c6 2b31 s 	dw	_cpm1_alw_F	;ALV:   
e8c8 2b33 s 
e8c8 2b33 s 
e8c8 2b33 s ;  ФИЗИЧЕСКИЕ ПАРАМЕТРЫ ДИСКА
e8c8 2b33 s ;--------------------------------------
e8c8 2b33 d 50
e8c8 2b33 s       DB 50H	;контрольная сумма
e8c9 2b34 s 
e8c9 2b34 d 80
e8c9 2b34 s       DB 080H ;константа скорости движения головки.
e8ca 2b35 s ;	; 3 - 30 мс на шаг, 2 - 20 мс, 1 - 12 мс,
e8ca 2b35 s ;	; 0 - 6 мс и 80H - 3 мс.
e8ca 2b35 d 05
e8ca 2b35 s       DB 05H  ; число физических секторов на дорожке
e8cb 2b36 d 01
e8cb 2b36 s       DB 01H  ; информация о сторонах диска
e8cc 2b37 s ;	;( 00 - односторонный диск
e8cc 2b37 s ;	;  01 - двухсторонний диск
e8cc 2b37 d 03
e8cc 2b37 s       DB 03	; 512 bytes/sector
e8cd 2b38 s ;	;( 00 - 128 байт/сектор
e8cd 2b38 s ;	;  01 - 256 байт/сектор
e8cd 2b38 s ;	;  02 - 512 байт/сектор
e8cd 2b38 s ;	;  03 - 1024 байт/сектор
e8cd 2b38 d 00
e8cd 2b38 s       DB 0	; номер текущей дорожки.
e8ce 2b39 d 00
e8ce 2b39 s       DB 0	; позиционный номер устройства (00000100) - для записи в регистр выбора
e8cf 2b3a s ;---------------------------------------------------
e8cf 2b3a d 00
e8cf 2b3a s       DB 0	;INFO	; флаг успешного считывания
e8d0 2b3b s 
e8d0 2b3b s _cpm1_dpb_F:
e8d0 2b3b s ; kdi params
e8d0 2b3b d 2800
e8d0 2b3b s       DW 40	;128 байтовых секторов/трек ; SPT
e8d2 2b3d d 04
e8d2 2b3d s       DB 4	; размер блока миним.кбайт  ; BSH
e8d3 2b3e s ;	; фактор сдвига блока распределения данных
e8d3 2b3e s ;	; определяется размером блока данных. Блок 
e8d3 2b3e s ;	; данных - минимально возможная частица файла.
e8d3 2b3e s ;	; Размер блока - 1, 2, 4, 8 или 16 Кбайт. Если
e8d3 2b3e s ;	; блок имеет большой размер, в каждом файле 
e8d3 2b3e s ;	; теряется значительное число неиспользуемых
e8d3 2b3e s ;	; секторов. При уменьшении размера блока
e8d3 2b3e s ;	; увеличивается размер директории, описывающий
e8d3 2b3e s ;	; расположение частей файла. BSH = log2[число
e8d3 2b3e s ;	; логических секторов в блоке].
e8d3 2b3e d 0f
e8d3 2b3e s       DB 15	; число логических сек/блок  ; BLM
e8d4 2b3f s ;	; маска блока распределения данных.
e8d4 2b3f s ;	; BLM = (число логических секторов в блоке)-1.
e8d4 2b3f d 00
e8d4 2b3f s       DB 0	; extent mask                ; EXM
e8d5 2b40 s ;	; = (BLM+1)*128/1024 - 1 - [DSM/256]. EXM - 
e8d5 2b40 s ;	; вспомогательная величина для определения
e8d5 2b40 s ;	; номера extent'а.
e8d5 2b40 s ;	; extent - часть файла, описываемая одним 
e8d5 2b40 s ;	; входом в директорию.
e8d5 2b40 d 8a01
e8d5 2b40 s       DW 394	; обьем диска в блоках-1     ; DSM
e8d7 2b42 d 7f00
e8d7 2b42 s       DW 127	; входов в директорий-1      ; DRM
e8d9 2b44 d c0
e8d9 2b44 s       DB 192	; определяет, какие блоки    ; AL0
e8da 2b45 s ;	; зарезервированы
e8da 2b45 d 00
e8da 2b45 s       DB 0	; alloc 1                    ; AL1
e8db 2b46 s ;	; под директорию. Каждый  бит AL0,AL1, 
e8db 2b46 s ;	; начиная со старшего бита AL0 и кончая 
e8db 2b46 s ;	; младшим битом AL1, значением 1 резервирует
e8db 2b46 s ;	; один блок данных для директории. Нужно
e8db 2b46 s ;	; резервировать необходимое число блоков
e8db 2b46 s ;	; для хранения входов в директорию: 32*DRM/BLS
e8db 2b46 d 0000
e8db 2b46 s       DW 0	; размер вектора контроля директории. ; CKS
e8dd 2b48 s ;	; CKS=(DRM+1)/4. Если диск не сменяем, CKS=0.
e8dd 2b48 d 0200
e8dd 2b48 s       DW 2	; число системных дорожек    ; OFS
e8df 2b4a s 
e8df 2b4a s 
e8df 2b4a s ; preffix&alw_F: 	ds 	50
e8df 2b4a s _cpm1_alw_F: 	ds 	50
e8df 2b4a d 00000000000000000000000000000000
e8ef 2b5a d 00000000000000000000000000000000
e8ff 2b6a d 00000000000000000000000000000000
e90f 2b7a d 0000
e911 2b7c s 
e911 2b7c s 
e911 2b7c s _cpm1_res_seldsk:
e911 2b7c d 79
e911 2b7c s 	ld 	a,c
e912 2b7d d fefe
e912 2b7d s 	cp 	0xfe
e914 2b7f s _cpm1_old_seld_dsk:
e914 2b7f d c214e9
e914 2b7f s 	jp 	nz,$	
e917 2b82 d 21ace8
e917 2b82 s 	ld 	hl,_cpm1_res_DRIVE_TAB
e91a 2b85 d c9
e91a 2b85 s 	ret
e91b 2b86 s 
e91b 2b86 s 
e91b 2b86 s ;RAM:DA27 C3 EB DC                 jp      j_READ
e91b 2b86 s 
e91b 2b86 s ;RAM:DCEB          j_READ:                                 ; CODE XREF: RAM:_READj
e91b 2b86 s ;RAM:DCEB                                                  ; RAM:DB84p
e91b 2b86 s ;RAM:DCEB
e91b 2b86 s ;RAM:DCEB          ; FUNCTION CHUNK AT RAM:DDC4 SIZE 0000007B BYTES
e91b 2b86 s ;RAM:DCEB
e91b 2b86 s ;RAM:DCEB 3E 04                    ld      a, 4
e91b 2b86 s ;RAM:DCED 32 66 E0                 ld      (_OPERATION), a
e91b 2b86 s ;RAM:DCF0 3A 64 E0                 ld      a, (_DSK)
e91b 2b86 s ;RAM:DCF3 FE 04                    cp      4
e91b 2b86 s ;RAM:DCF5 CA C4 DD                 jp      z, loc_DDC4
e91b 2b86 s 
e91b 2b86 s ;сюда попадает из биоса JP READ
e91b 2b86 s ;а если не наше то прыгаем на старый read
e91b 2b86 s _cpm1_res_READ:
e91b 2b86 s ; 	ld	 A,4	;Режим чтения
e91b 2b86 s ; 	ld  	(_OPER),a
e91b 2b86 s _cpm1_r_p_DSK1:
e91b 2b86 d 3affff
e91b 2b86 s 	ld 	a,(_DSK) 	;_DSK
e91e 2b89 d fe04
e91e 2b89 s 	cp 	4
e920 2b8b d ca55e9
e920 2b8b s 	jp 	z,_cpm1__old_read
e923 2b8e s 
e923 2b8e d fe05
e923 2b8e s 	cp 	5 		;disk F mapped to EMU drive E
e925 2b90 d c229e9
e925 2b90 s 	jp 	nz,_cpm1_.r_no_drv_dec
e928 2b93 d 3d
e928 2b93 s 	dec 	a
e929 2b94 s 
e929 2b94 s _cpm1_.r_no_drv_dec:
e929 2b94 d 3240ea
e929 2b94 s 	LD	(_cpm1_EXR_DRV),A	; # устройства
e92c 2b97 s 
e92c 2b97 d e5
e92c 2b97 s 	push 	hl
e92d 2b98 s _cpm1_r_p_SELDSKDRIVER:
e92d 2b98 d 2a0000
e92d 2b98 s 	ld 	hl,(0)	;EXR_SELDSK_DRIVE
e930 2b9b d 7e
e930 2b9b s 	ld 	a,(hl)
e931 2b9c d e1
e931 2b9c s 	pop 	hl
e932 2b9d d b7
e932 2b9d s 	or 	a
e933 2b9e d c255e9
e933 2b9e s 	jp 	nz,_cpm1__old_read
e936 2ba1 s 
e936 2ba1 s _cpm1_r_p_TRK1:
e936 2ba1 d 3affff
e936 2ba1 s 	LD	A,(_TRK)	
e939 2ba4 d 3241ea
e939 2ba4 s 	LD	(_cpm1_EXR_TRK),A	; дорожка
e93c 2ba7 s _cpm1_r_p_SEC1:
e93c 2ba7 d 3affff
e93c 2ba7 s 	LD	A,(_SEC)	; сектор
e93f 2baa d 3d
e93f 2baa s 	DEC	A		; у нас номер сектора начинается с 0
e940 2bab d 3242ea
e940 2bab s 	LD	(_cpm1_EXR_SEC),A
e943 2bae s 
e943 2bae d 3e01
e943 2bae s 	LD	A,1
e945 2bb0 d 323fea
e945 2bb0 s 	LD	(_cpm1_EXR_CMD),A	; 1 - команда чтения
e948 2bb3 s 
e948 2bb3 d cdfbe9
e948 2bb3 s 	CALL	_cpm1_EXR_SENDCMD	; отсылаем команду
e94b 2bb6 d 3d
e94b 2bb6 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
e94c 2bb7 d c0
e94c 2bb7 s 	RET	NZ		; 0 - ошибка
e94d 2bb8 s _cpm1_r_p_DMA1:
e94d 2bb8 d 2affff
e94d 2bb8 s 	LD	HL,(_DMA)	; адрес буфера для приема данных
e950 2bbb d cdc5e9
e950 2bbb s 	CALL	_cpm1_EXR_GETSEC	; принимаем данные
e953 2bbe d af
e953 2bbe s 	XOR	A		; завершение всегда успешно
e954 2bbf d c9
e954 2bbf s 	RET
e955 2bc0 s ;
e955 2bc0 s 
e955 2bc0 s _cpm1__old_read:
e955 2bc0 d c355e9
e955 2bc0 s 	jp 	$
e958 2bc3 s 
e958 2bc3 s _cpm1_res_WRITE:
e958 2bc3 s ; 	ld	 A,6	;Режим чтения
e958 2bc3 s ; 	ld  	(_OPER),a
e958 2bc3 s 
e958 2bc3 s _cpm1_r_p_DSK2:
e958 2bc3 d 3affff
e958 2bc3 s 	ld 	a,(_DSK) 	;_DSK
e95b 2bc6 d fe04
e95b 2bc6 s 	cp 	4
e95d 2bc8 d ca92e9
e95d 2bc8 s 	jp 	z,_cpm1__old_write
e960 2bcb d fe05
e960 2bcb s 	cp 	5 		;disk F mapped to EMU drive E
e962 2bcd d c266e9
e962 2bcd s 	jp 	nz,_cpm1_.w_no_drv_dec
e965 2bd0 d 3d
e965 2bd0 s 	dec 	a
e966 2bd1 s _cpm1_.w_no_drv_dec:
e966 2bd1 d 3240ea
e966 2bd1 s 	LD	(_cpm1_EXR_DRV),A
e969 2bd4 s 
e969 2bd4 s 
e969 2bd4 d e5
e969 2bd4 s 	push 	hl
e96a 2bd5 s _cpm1_r_p_SELDSKDRIVEW:
e96a 2bd5 d 2a0000
e96a 2bd5 s 	ld 	hl,(0)	;EXR_SELDSK_DRIVE
e96d 2bd8 d 7e
e96d 2bd8 s 	ld 	a,(hl)
e96e 2bd9 d e1
e96e 2bd9 s 	pop 	hl
e96f 2bda d b7
e96f 2bda s 	or 	a
e970 2bdb d c292e9
e970 2bdb s 	jp 	nz,_cpm1__old_write
e973 2bde s 
e973 2bde s _cpm1_r_p_TRK2:
e973 2bde d 3affff
e973 2bde s 	LD	A,(_TRK)
e976 2be1 d 3241ea
e976 2be1 s 	LD	(_cpm1_EXR_TRK),A
e979 2be4 s _cpm1_r_p_SEC2:
e979 2be4 d 3affff
e979 2be4 s 	LD	A,(_SEC)
e97c 2be7 d 3d
e97c 2be7 s 	DEC	A
e97d 2be8 d 3242ea
e97d 2be8 s 	LD	(_cpm1_EXR_SEC),A
e980 2beb s 
e980 2beb d 3e02
e980 2beb s 	LD	A,2		; 2 - команда записи
e982 2bed d 323fea
e982 2bed s 	LD	(_cpm1_EXR_CMD),A
e985 2bf0 s 
e985 2bf0 d cdfbe9
e985 2bf0 s 	CALL	_cpm1_EXR_SENDCMD
e988 2bf3 d 3d
e988 2bf3 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
e989 2bf4 d c0
e989 2bf4 s 	RET	NZ		; 0 - ошибка
e98a 2bf5 s _cpm1_r_p_DMA2:
e98a 2bf5 d 2affff
e98a 2bf5 s 	LD	HL,(_DMA)
e98d 2bf8 d cde0e9
e98d 2bf8 s 	CALL	_cpm1_EXR_PUTSEC
e990 2bfb d af
e990 2bfb s 	XOR	A		; запись успешна
e991 2bfc d c9
e991 2bfc s 	RET
e992 2bfd s 
e992 2bfd s _cpm1__old_write:
e992 2bfd d c392e9
e992 2bfd s 	jp 	$
e995 2c00 s 
e995 2c00 s 
e995 2c00 s _cpm1_res_GETINFO:
e995 2c00 s 
e995 2c00 d 7e
e995 2c00 s 	LD 	A,(HL)	; A= маска выбора привода
e996 2c01 d b7
e996 2c01 s 	or 	a
e997 2c02 d c2a2e9
e997 2c02 s 	jp 	nz,_cpm1__old_getinfo 	;=0 if emulated
e99a 2c05 s 
e99a 2c05 s ;
e99a 2c05 s ;  Чтение с эмулируемых дисков A или B
e99a 2c05 s ;
e99a 2c05 d e5
e99a 2c05 s 	push 	hl
e99b 2c06 d cd21ea
e99b 2c06 s 	CALL	_cpm1_EXR_READINFO
e99e 2c09 d 3d
e99e 2c09 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
e99f 2c0a s ; 	JP	NZ,0xE6ff	;IERR		; 0 - ошибка
e99f 2c0a s _cpm1__old_getinfo_chkdo:
e99f 2c0a d c39fe9
e99f 2c0a s 	JP	$ 		;IERR jnz xxx, CHKDO
e9a2 2c0d s ; ;
e9a2 2c0d s _cpm1__old_getinfo:
e9a2 2c0d d c3a2e9
e9a2 2c0d s 	jp 	$ 		;GETINFO
e9a5 2c10 s 
e9a5 2c10 s 
e9a5 2c10 s ;==================  Драйвер ExtROM-API ====================================
e9a5 2c10 s 	
e9a5 2c10 s 	
e9a5 2c10 s ;****************************************
e9a5 2c10 s ;*  Прием байта из порта А по стробу    *
e9a5 2c10 s ;****************************************
e9a5 2c10 s _cpm1_EXR_GETBYTE:
e9a5 2c10 d e5
e9a5 2c10 s 	PUSH	HL
e9a6 2c11 d 210afb
e9a6 2c11 s 	LD	HL,rPORTC
e9a9 2c14 s _cpm1_pWG:
e9a9 2c14 d 7e
e9a9 2c14 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
e9aa 2c15 d e620
e9aa 2c15 s 	AND	20h		; выделяем сигнал IBF
e9ac 2c17 d caa9e9
e9ac 2c17 s 	JP	Z,_cpm1_pWG		; IBF=0 - данных еще нет
e9af 2c1a d 3a08fb
e9af 2c1a s 	LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
e9b2 2c1d d e1
e9b2 2c1d s 	POP	HL
e9b3 2c1e d c9
e9b3 2c1e s 	RET
e9b4 2c1f s 
e9b4 2c1f s ;****************************************
e9b4 2c1f s ;*  Отправка байта в порт A             *
e9b4 2c1f s ;****************************************
e9b4 2c1f s _cpm1_EXR_PUTBYTE:
e9b4 2c1f d e5
e9b4 2c1f s 	PUSH	HL
e9b5 2c20 d f5
e9b5 2c20 s 	PUSH	AF
e9b6 2c21 d 210afb
e9b6 2c21 s 	LD	HL,rPORTC
e9b9 2c24 s _cpm1_pWP:
e9b9 2c24 d 7e
e9b9 2c24 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
e9ba 2c25 d e680
e9ba 2c25 s 	AND	80h		; выделяем сигнал -OBF
e9bc 2c27 d cab9e9
e9bc 2c27 s 	JP	Z,_cpm1_pWP		; -OBF=0 - в передатчике сидит незабранный байт
e9bf 2c2a d f1
e9bf 2c2a s 	POP	AF
e9c0 2c2b d 3208fb
e9c0 2c2b s 	LD	(rPORTA),A		; данные поступили - выбираем их из порта А
e9c3 2c2e d e1
e9c3 2c2e s 	POP	HL
e9c4 2c2f d c9
e9c4 2c2f s 	RET
e9c5 2c30 s 
e9c5 2c30 s ;*******************************************
e9c5 2c30 s ;*      Прием сектора                      *
e9c5 2c30 s ;* HL - адрес размещения сектора в памяти  *
e9c5 2c30 s ;*  Размер сектора - 128 байт              *
e9c5 2c30 s ;*******************************************
e9c5 2c30 s _cpm1_EXR_GETSEC:
e9c5 2c30 d f3
e9c5 2c30 s 	di
e9c6 2c31 d c5
e9c6 2c31 s 	PUSH	BC
e9c7 2c32 d d5
e9c7 2c32 s 	PUSH	DE
e9c8 2c33 d 0e80
e9c8 2c33 s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
e9ca 2c35 d eb
e9ca 2c35 s 	EX	DE,HL		; адрес буфера -> DE
e9cb 2c36 d 210afb
e9cb 2c36 s 	LD	HL,rPORTC
e9ce 2c39 s _cpm1_pGSL:
e9ce 2c39 d 7e
e9ce 2c39 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
e9cf 2c3a d e620
e9cf 2c3a s 	AND	20h		; выделяем сигнал IBF
e9d1 2c3c d cacee9
e9d1 2c3c s 	JP	Z,_cpm1_pGSL		; IBF=0 - данных еще нет
e9d4 2c3f d 3a08fb
e9d4 2c3f s 	LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
e9d7 2c42 d 12
e9d7 2c42 s 	LD	(DE),A		; принимаем и размещаем очередной байт
e9d8 2c43 d 13
e9d8 2c43 s 	INC	DE		; указатель буфера ++
e9d9 2c44 d 0d
e9d9 2c44 s 	DEC	C		; принимаем остальные байты
e9da 2c45 d c2cee9
e9da 2c45 s 	JP	NZ,_cpm1_pGSL
e9dd 2c48 d d1
e9dd 2c48 s 	POP	DE
e9de 2c49 d c1
e9de 2c49 s 	POP	BC
e9df 2c4a s ; 	ei - int should be still disabled 
e9df 2c4a d c9
e9df 2c4a s 	RET
e9e0 2c4b s 
e9e0 2c4b s ;*******************************************
e9e0 2c4b s ;*      Передача сектора                   *
e9e0 2c4b s ;* HL - адрес размещения сектора в памяти  *
e9e0 2c4b s ;*  Размер сектора - 128 байт              *
e9e0 2c4b s ;*******************************************
e9e0 2c4b s _cpm1_EXR_PUTSEC:
e9e0 2c4b d f3
e9e0 2c4b s 	di
e9e1 2c4c d c5
e9e1 2c4c s 	PUSH	BC
e9e2 2c4d d d5
e9e2 2c4d s 	PUSH	DE
e9e3 2c4e d 0e80
e9e3 2c4e s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
e9e5 2c50 d eb
e9e5 2c50 s 	EX	DE,HL		; адрес буфера -> DE
e9e6 2c51 d 210afb
e9e6 2c51 s 	LD	HL,rPORTC
e9e9 2c54 s _cpm1_pPSL:
e9e9 2c54 d 7e
e9e9 2c54 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
e9ea 2c55 d e680
e9ea 2c55 s 	AND	80h		; выделяем сигнал -OBF
e9ec 2c57 d cae9e9
e9ec 2c57 s 	JP	Z,_cpm1_pPSL		; -OBF=0 - в передатчике сидит незабранный байт
e9ef 2c5a d 1a
e9ef 2c5a s 	LD	A,(DE)		; принимаем и размещаем очередной байт
e9f0 2c5b d 3208fb
e9f0 2c5b s 	LD	(rPORTA),A		; данные поступили - выбираем их из порта А
e9f3 2c5e d 13
e9f3 2c5e s 	INC	DE
e9f4 2c5f d 0d
e9f4 2c5f s 	DEC	C		; принимаем остальные байты
e9f5 2c60 d c2e9e9
e9f5 2c60 s 	JP	NZ,_cpm1_pPSL
e9f8 2c63 d d1
e9f8 2c63 s 	POP	DE
e9f9 2c64 d c1
e9f9 2c64 s 	POP	BC
e9fa 2c65 s ; 	ei - int should be still disabled 
e9fa 2c65 d c9
e9fa 2c65 s 	RET
e9fb 2c66 s 
e9fb 2c66 s ;****************************************
e9fb 2c66 s ;*     Отправка командного пакета       *
e9fb 2c66 s ;****************************************
e9fb 2c66 s _cpm1_EXR_SENDCMD:
e9fb 2c66 s 
e9fb 2c66 d f3
e9fb 2c66 s 	di
e9fc 2c67 d e5
e9fc 2c67 s 	PUSH	HL
e9fd 2c68 d c5
e9fd 2c68 s 	PUSH	BC
e9fe 2c69 d 3e0c
e9fe 2c69 s 	LD	A,0Ch
ea00 2c6b d 320bfb
ea00 2c6b s 	LD	(rPCWR),A	; переключаем порт в режим 2
ea03 2c6e d 213fea
ea03 2c6e s 	LD	HL,_cpm1_EXR_CMD
ea06 2c71 d 0e04
ea06 2c71 s 	LD	C,4		; пакет - 4 байта
ea08 2c73 d 0600
ea08 2c73 s 	LD	B,0		; заготовка контрольной суммы
ea0a 2c75 s _cpm1_pSCL:
ea0a 2c75 d 7e
ea0a 2c75 s 	LD	A,(HL)		; очередной байт пакета 
ea0b 2c76 d 80
ea0b 2c76 s 	ADD 	B		; добавляем к КС
ea0c 2c77 d 47
ea0c 2c77 s 	LD	B,A
ea0d 2c78 d 7e
ea0d 2c78 s 	LD	A,(HL)		; очередной байт пакета 
ea0e 2c79 d cdb4e9
ea0e 2c79 s 	CALL	_cpm1_EXR_PUTBYTE		; - в порт
ea11 2c7c d 23
ea11 2c7c s 	INC	HL
ea12 2c7d d 0d
ea12 2c7d s 	DEC	C
ea13 2c7e d c20aea
ea13 2c7e s 	JP	NZ,_cpm1_pSCL
ea16 2c81 d 78
ea16 2c81 s 	LD	A,B
ea17 2c82 d 3d
ea17 2c82 s 	DEC 	A		; КС-1
ea18 2c83 d cdb4e9
ea18 2c83 s 	CALL	_cpm1_EXR_PUTBYTE     ; контрольная сумма
ea1b 2c86 d cda5e9
ea1b 2c86 s 	CALL	_cpm1_EXR_GETBYTE	; ответ контроллера
ea1e 2c89 d c1
ea1e 2c89 s 	POP	BC
ea1f 2c8a d e1
ea1f 2c8a s 	POP	HL
ea20 2c8b s ; 	ei - int should be still disabled 
ea20 2c8b d c9
ea20 2c8b s 	RET
ea21 2c8c s 
ea21 2c8c s ;*******************************************
ea21 2c8c s ;*  Чтение информационного сектора
ea21 2c8c s ;*******************************************
ea21 2c8c s _cpm1_EXR_READINFO:
ea21 2c8c d 213fea
ea21 2c8c s 	LD	HL,_cpm1_EXR_CMD	; командный пакет
ea24 2c8f d 3601
ea24 2c8f s 	LD	(HL),1		; команда чтения
ea26 2c91 d 23
ea26 2c91 s 	INC	HL
ea27 2c92 s _cpm1_r_p_DSK3:
ea27 2c92 d 3affff
ea27 2c92 s 	LD	A,(_DSK)	; вписываем # устройства
ea2a 2c95 d 77
ea2a 2c95 s 	LD	(HL),A
ea2b 2c96 d 23
ea2b 2c96 s 	INC	HL
ea2c 2c97 d 3600
ea2c 2c97 s 	LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
ea2e 2c99 d 23
ea2e 2c99 s 	INC	HL
ea2f 2c9a d 3600
ea2f 2c9a s 	LD	(HL),0		
ea31 2c9c d cdfbe9
ea31 2c9c s 	CALL	_cpm1_EXR_SENDCMD	; отправляем команду
ea34 2c9f d b7
ea34 2c9f s 	OR	A
ea35 2ca0 d c8
ea35 2ca0 s 	RET 	Z		; ошибка
ea36 2ca1 d 2100ee
ea36 2ca1 s 	LD	HL,_RRBUFF	; принимаем данные
ea39 2ca4 d cdc5e9
ea39 2ca4 s 	CALL	_cpm1_EXR_GETSEC
ea3c 2ca7 d 3e01
ea3c 2ca7 s 	LD	A,1
ea3e 2ca9 d c9
ea3e 2ca9 s 	RET
ea3f 2caa s 
ea3f 2caa s 
ea3f 2caa s ; Командный пакет интерфейса Extrom-API
ea3f 2caa s ;===============================================
ea3f 2caa d 00
ea3f 2caa s _cpm1_EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
ea40 2cab d 00
ea40 2cab s _cpm1_EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
ea41 2cac d 00
ea41 2cac s _cpm1_EXR_TRK:	DB	0	; логическая дорожка
ea42 2cad d 00
ea42 2cad s _cpm1_EXR_SEC:	DB	0	; логический сектор (128b)
ea43 2cae s 
ea43 2cae s 	endm
ea43 2cae s 
2cae 2cae s 	.dephase
2cae 2cae s 
2cae 2cae s resident_cpm1_len 		equ	$-resident_cpm1
2cae 2cae s 
2cae 2cae s ; minimum hole_start .. min hole_end
2cae 2cae s max_resident_cpm1_len 	equ 	0xEBA6-0xE8AC ;=762
2cae 2cae s 
2cae 2cae s available_resident_cpm1_len	equ 	max_resident_cpm1_len-resident_cpm1_len
2cae 2cae s 
2cae 2cae s 	.assert max_resident_cpm1_len>=resident_cpm1_len
2cae 2cae f generator/V0/extrom-patcher.asm
2cae 2cae s 	include 	"extrom-patcher-resident-cpm2.asm"
2cae 2cae f extrom-patcher-resident-cpm2.asm
2cae 2cae s 	;    12_87_11_niijaf
2cae 2cae s 	;  EA06-EDFD = 1015  
2cae 2cae s 	;
2cae 2cae s 	
2cae 2cae s resident_cpm2	equ $
2cae 2cae s 
ea06 2cae s 	.phase 0xea06
ea06 2cae s 
ea06 2cae s resident_cpm2_addr 	EQU 	$
ea06 2cae s 
ea06 2cae s 	cpm_resident_body _cpm2_
ea06 2cae s 
ea06 2cae s ;keyhook support removed 2014-10-22
ea06 2cae s ;больше нет нужды в ней, т.к. есть диск F
ea06 2cae s ; preffix&kbd_hook_noCtrl_03;
ea06 2cae s ; 	ld 	(preffix&save_a),a
ea06 2cae s ; 	cp 	0x03
ea06 2cae s ; 	jp 	preffix&kbd_hook_noCtrl_chk
ea06 2cae s 
ea06 2cae s ; preffix&kbd_hook_noCtrl_33:
ea06 2cae s ; 	ld 	(preffix&save_a),a
ea06 2cae s ; 	cp 	0x33
ea06 2cae s 
ea06 2cae s ; preffix&kbd_hook_noCtrl_chk:
ea06 2cae s ; 	jp 	nz,preffix&bios_hook
ea06 2cae s 
ea06 2cae s ; 	ld 	a,(0xf880)
ea06 2cae s ; 	and 	00100001b
ea06 2cae s ; 	cp 	00100001b
ea06 2cae s 
ea06 2cae s ; 	jp 	nz,preffix&bios_hook
ea06 2cae s 
ea06 2cae s ; 	jp 	preffix&do_key_action
ea06 2cae s 
ea06 2cae s ; preffix&kbd_hook_2133:
ea06 2cae s ; 	ld 	(preffix&save_a),a
ea06 2cae s ; 	ld 	a,c
ea06 2cae s ; 	cp 	0x33 	;stop
ea06 2cae s ; 	jp 	nz,preffix&bios_hook
ea06 2cae s 
ea06 2cae s ; 	ld 	a,b
ea06 2cae s ; 	cp 	0x21 	;ctrl+stop
ea06 2cae s ; 	jp 	nz,preffix&bios_hook
ea06 2cae s 
ea06 2cae s ; preffix&do_key_action:
ea06 2cae s ; 	push 	hl
ea06 2cae s ; 	push 	de
ea06 2cae s ; 	push 	bc
ea06 2cae s ; 	ld 	hl,preffix&msg_hook
ea06 2cae s ; 	ld 	de,0xfc00
ea06 2cae s ; preffix&.kmlp:	
ea06 2cae s ; 	ld 	a,(hl)
ea06 2cae s ; 	or 	a
ea06 2cae s ; 	jp 	z,preffix&.kmlp_ext
ea06 2cae s ; 	ld 	(de),a
ea06 2cae s ; 	inc 	hl
ea06 2cae s ; 	inc 	de
ea06 2cae s ; 	jp 	preffix&.kmlp
ea06 2cae s 
ea06 2cae s ; preffix&.kmlp_ext:
ea06 2cae s ; 	pop 	bc
ea06 2cae s ; 	pop 	de
ea06 2cae s ; 	pop 	hl
ea06 2cae s 
ea06 2cae s ; 	ld 	bc,0 	;simulate no key
ea06 2cae s ; 	ld 	a,0
ea06 2cae s ; 	jp 	preffix&old_hook
ea06 2cae s ; ; 	halt
ea06 2cae s 
ea06 2cae s 
ea06 2cae s ; preffix&bios_hook:
ea06 2cae s ; 	ld 	a,(preffix&save_a)
ea06 2cae s 
ea06 2cae s ; preffix&old_hook:
ea06 2cae s ; 	jp 	$
ea06 2cae s ; preffix&save_a:
ea06 2cae s ; 	db 	0	
ea06 2cae s ; preffix&msg_hook:
ea06 2cae s ; 	db 	'CTRL+SHIFT+STOP pressed',0
ea06 2cae s 
ea06 2cae s ;ptrs to drive drvreg bytes 
ea06 2cae s _cpm2_res_DRIVE_TAB:
ea06 2cae d 0000
ea06 2cae s 	dw 	0 	;A
ea08 2cb0 d 0000
ea08 2cb0 s 	dw 	0 	;B
ea0a 2cb2 d 0000
ea0a 2cb2 s 	dw 	0 	;C
ea0c 2cb4 d 0000
ea0c 2cb4 s 	dw 	0 	;D
ea0e 2cb6 d 0000
ea0e 2cb6 s 	dw 	0 	;E
ea10 2cb8 d 0000
ea10 2cb8 s 	dw 	0 	;F
ea12 2cba s 
ea12 2cba s 
ea12 2cba s _cpm2_dph_F:
ea12 2cba d 0000
ea12 2cba s 	dw	0	;_XLT:           
ea14 2cbc d 0000
ea14 2cbc s 	dw	0	;_1:             
ea16 2cbe d 0000
ea16 2cbe s 	dw	0	;_2:             
ea18 2cc0 d 0000
ea18 2cc0 s 	dw	0	;_3:             
ea1a 2cc2 d 00fc
ea1a 2cc2 s 	dw	0xFC00	;DirBuf: value store here via patcher 0xfc00 - debug
ea1c 2cc4 d 2aea
ea1c 2cc4 s 	dw	_cpm2_dpb_F	;DPB:   
ea1e 2cc6 d 0000
ea1e 2cc6 s 	dw	0	;CSV: - fixed drive   
ea20 2cc8 d 39ea
ea20 2cc8 s 	dw	_cpm2_alw_F	;ALV:   
ea22 2cca s 
ea22 2cca s 
ea22 2cca s ;  ФИЗИЧЕСКИЕ ПАРАМЕТРЫ ДИСКА
ea22 2cca s ;--------------------------------------
ea22 2cca d 50
ea22 2cca s       DB 50H	;контрольная сумма
ea23 2ccb s 
ea23 2ccb d 80
ea23 2ccb s       DB 080H ;константа скорости движения головки.
ea24 2ccc s ;	; 3 - 30 мс на шаг, 2 - 20 мс, 1 - 12 мс,
ea24 2ccc s ;	; 0 - 6 мс и 80H - 3 мс.
ea24 2ccc d 05
ea24 2ccc s       DB 05H  ; число физических секторов на дорожке
ea25 2ccd d 01
ea25 2ccd s       DB 01H  ; информация о сторонах диска
ea26 2cce s ;	;( 00 - односторонный диск
ea26 2cce s ;	;  01 - двухсторонний диск
ea26 2cce d 03
ea26 2cce s       DB 03	; 512 bytes/sector
ea27 2ccf s ;	;( 00 - 128 байт/сектор
ea27 2ccf s ;	;  01 - 256 байт/сектор
ea27 2ccf s ;	;  02 - 512 байт/сектор
ea27 2ccf s ;	;  03 - 1024 байт/сектор
ea27 2ccf d 00
ea27 2ccf s       DB 0	; номер текущей дорожки.
ea28 2cd0 d 00
ea28 2cd0 s       DB 0	; позиционный номер устройства (00000100) - для записи в регистр выбора
ea29 2cd1 s ;---------------------------------------------------
ea29 2cd1 d 00
ea29 2cd1 s       DB 0	;INFO	; флаг успешного считывания
ea2a 2cd2 s 
ea2a 2cd2 s _cpm2_dpb_F:
ea2a 2cd2 s ; kdi params
ea2a 2cd2 d 2800
ea2a 2cd2 s       DW 40	;128 байтовых секторов/трек ; SPT
ea2c 2cd4 d 04
ea2c 2cd4 s       DB 4	; размер блока миним.кбайт  ; BSH
ea2d 2cd5 s ;	; фактор сдвига блока распределения данных
ea2d 2cd5 s ;	; определяется размером блока данных. Блок 
ea2d 2cd5 s ;	; данных - минимально возможная частица файла.
ea2d 2cd5 s ;	; Размер блока - 1, 2, 4, 8 или 16 Кбайт. Если
ea2d 2cd5 s ;	; блок имеет большой размер, в каждом файле 
ea2d 2cd5 s ;	; теряется значительное число неиспользуемых
ea2d 2cd5 s ;	; секторов. При уменьшении размера блока
ea2d 2cd5 s ;	; увеличивается размер директории, описывающий
ea2d 2cd5 s ;	; расположение частей файла. BSH = log2[число
ea2d 2cd5 s ;	; логических секторов в блоке].
ea2d 2cd5 d 0f
ea2d 2cd5 s       DB 15	; число логических сек/блок  ; BLM
ea2e 2cd6 s ;	; маска блока распределения данных.
ea2e 2cd6 s ;	; BLM = (число логических секторов в блоке)-1.
ea2e 2cd6 d 00
ea2e 2cd6 s       DB 0	; extent mask                ; EXM
ea2f 2cd7 s ;	; = (BLM+1)*128/1024 - 1 - [DSM/256]. EXM - 
ea2f 2cd7 s ;	; вспомогательная величина для определения
ea2f 2cd7 s ;	; номера extent'а.
ea2f 2cd7 s ;	; extent - часть файла, описываемая одним 
ea2f 2cd7 s ;	; входом в директорию.
ea2f 2cd7 d 8a01
ea2f 2cd7 s       DW 394	; обьем диска в блоках-1     ; DSM
ea31 2cd9 d 7f00
ea31 2cd9 s       DW 127	; входов в директорий-1      ; DRM
ea33 2cdb d c0
ea33 2cdb s       DB 192	; определяет, какие блоки    ; AL0
ea34 2cdc s ;	; зарезервированы
ea34 2cdc d 00
ea34 2cdc s       DB 0	; alloc 1                    ; AL1
ea35 2cdd s ;	; под директорию. Каждый  бит AL0,AL1, 
ea35 2cdd s ;	; начиная со старшего бита AL0 и кончая 
ea35 2cdd s ;	; младшим битом AL1, значением 1 резервирует
ea35 2cdd s ;	; один блок данных для директории. Нужно
ea35 2cdd s ;	; резервировать необходимое число блоков
ea35 2cdd s ;	; для хранения входов в директорию: 32*DRM/BLS
ea35 2cdd d 0000
ea35 2cdd s       DW 0	; размер вектора контроля директории. ; CKS
ea37 2cdf s ;	; CKS=(DRM+1)/4. Если диск не сменяем, CKS=0.
ea37 2cdf d 0200
ea37 2cdf s       DW 2	; число системных дорожек    ; OFS
ea39 2ce1 s 
ea39 2ce1 s 
ea39 2ce1 s ; preffix&alw_F: 	ds 	50
ea39 2ce1 s _cpm2_alw_F: 	ds 	50
ea39 2ce1 d 00000000000000000000000000000000
ea49 2cf1 d 00000000000000000000000000000000
ea59 2d01 d 00000000000000000000000000000000
ea69 2d11 d 0000
ea6b 2d13 s 
ea6b 2d13 s 
ea6b 2d13 s _cpm2_res_seldsk:
ea6b 2d13 d 79
ea6b 2d13 s 	ld 	a,c
ea6c 2d14 d fefe
ea6c 2d14 s 	cp 	0xfe
ea6e 2d16 s _cpm2_old_seld_dsk:
ea6e 2d16 d c26eea
ea6e 2d16 s 	jp 	nz,$	
ea71 2d19 d 2106ea
ea71 2d19 s 	ld 	hl,_cpm2_res_DRIVE_TAB
ea74 2d1c d c9
ea74 2d1c s 	ret
ea75 2d1d s 
ea75 2d1d s 
ea75 2d1d s ;RAM:DA27 C3 EB DC                 jp      j_READ
ea75 2d1d s 
ea75 2d1d s ;RAM:DCEB          j_READ:                                 ; CODE XREF: RAM:_READj
ea75 2d1d s ;RAM:DCEB                                                  ; RAM:DB84p
ea75 2d1d s ;RAM:DCEB
ea75 2d1d s ;RAM:DCEB          ; FUNCTION CHUNK AT RAM:DDC4 SIZE 0000007B BYTES
ea75 2d1d s ;RAM:DCEB
ea75 2d1d s ;RAM:DCEB 3E 04                    ld      a, 4
ea75 2d1d s ;RAM:DCED 32 66 E0                 ld      (_OPERATION), a
ea75 2d1d s ;RAM:DCF0 3A 64 E0                 ld      a, (_DSK)
ea75 2d1d s ;RAM:DCF3 FE 04                    cp      4
ea75 2d1d s ;RAM:DCF5 CA C4 DD                 jp      z, loc_DDC4
ea75 2d1d s 
ea75 2d1d s ;сюда попадает из биоса JP READ
ea75 2d1d s ;а если не наше то прыгаем на старый read
ea75 2d1d s _cpm2_res_READ:
ea75 2d1d s ; 	ld	 A,4	;Режим чтения
ea75 2d1d s ; 	ld  	(_OPER),a
ea75 2d1d s _cpm2_r_p_DSK1:
ea75 2d1d d 3affff
ea75 2d1d s 	ld 	a,(_DSK) 	;_DSK
ea78 2d20 d fe04
ea78 2d20 s 	cp 	4
ea7a 2d22 d caafea
ea7a 2d22 s 	jp 	z,_cpm2__old_read
ea7d 2d25 s 
ea7d 2d25 d fe05
ea7d 2d25 s 	cp 	5 		;disk F mapped to EMU drive E
ea7f 2d27 d c283ea
ea7f 2d27 s 	jp 	nz,_cpm2_.r_no_drv_dec
ea82 2d2a d 3d
ea82 2d2a s 	dec 	a
ea83 2d2b s 
ea83 2d2b s _cpm2_.r_no_drv_dec:
ea83 2d2b d 329aeb
ea83 2d2b s 	LD	(_cpm2_EXR_DRV),A	; # устройства
ea86 2d2e s 
ea86 2d2e d e5
ea86 2d2e s 	push 	hl
ea87 2d2f s _cpm2_r_p_SELDSKDRIVER:
ea87 2d2f d 2a0000
ea87 2d2f s 	ld 	hl,(0)	;EXR_SELDSK_DRIVE
ea8a 2d32 d 7e
ea8a 2d32 s 	ld 	a,(hl)
ea8b 2d33 d e1
ea8b 2d33 s 	pop 	hl
ea8c 2d34 d b7
ea8c 2d34 s 	or 	a
ea8d 2d35 d c2afea
ea8d 2d35 s 	jp 	nz,_cpm2__old_read
ea90 2d38 s 
ea90 2d38 s _cpm2_r_p_TRK1:
ea90 2d38 d 3affff
ea90 2d38 s 	LD	A,(_TRK)	
ea93 2d3b d 329beb
ea93 2d3b s 	LD	(_cpm2_EXR_TRK),A	; дорожка
ea96 2d3e s _cpm2_r_p_SEC1:
ea96 2d3e d 3affff
ea96 2d3e s 	LD	A,(_SEC)	; сектор
ea99 2d41 d 3d
ea99 2d41 s 	DEC	A		; у нас номер сектора начинается с 0
ea9a 2d42 d 329ceb
ea9a 2d42 s 	LD	(_cpm2_EXR_SEC),A
ea9d 2d45 s 
ea9d 2d45 d 3e01
ea9d 2d45 s 	LD	A,1
ea9f 2d47 d 3299eb
ea9f 2d47 s 	LD	(_cpm2_EXR_CMD),A	; 1 - команда чтения
eaa2 2d4a s 
eaa2 2d4a d cd55eb
eaa2 2d4a s 	CALL	_cpm2_EXR_SENDCMD	; отсылаем команду
eaa5 2d4d d 3d
eaa5 2d4d s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
eaa6 2d4e d c0
eaa6 2d4e s 	RET	NZ		; 0 - ошибка
eaa7 2d4f s _cpm2_r_p_DMA1:
eaa7 2d4f d 2affff
eaa7 2d4f s 	LD	HL,(_DMA)	; адрес буфера для приема данных
eaaa 2d52 d cd1feb
eaaa 2d52 s 	CALL	_cpm2_EXR_GETSEC	; принимаем данные
eaad 2d55 d af
eaad 2d55 s 	XOR	A		; завершение всегда успешно
eaae 2d56 d c9
eaae 2d56 s 	RET
eaaf 2d57 s ;
eaaf 2d57 s 
eaaf 2d57 s _cpm2__old_read:
eaaf 2d57 d c3afea
eaaf 2d57 s 	jp 	$
eab2 2d5a s 
eab2 2d5a s _cpm2_res_WRITE:
eab2 2d5a s ; 	ld	 A,6	;Режим чтения
eab2 2d5a s ; 	ld  	(_OPER),a
eab2 2d5a s 
eab2 2d5a s _cpm2_r_p_DSK2:
eab2 2d5a d 3affff
eab2 2d5a s 	ld 	a,(_DSK) 	;_DSK
eab5 2d5d d fe04
eab5 2d5d s 	cp 	4
eab7 2d5f d caecea
eab7 2d5f s 	jp 	z,_cpm2__old_write
eaba 2d62 d fe05
eaba 2d62 s 	cp 	5 		;disk F mapped to EMU drive E
eabc 2d64 d c2c0ea
eabc 2d64 s 	jp 	nz,_cpm2_.w_no_drv_dec
eabf 2d67 d 3d
eabf 2d67 s 	dec 	a
eac0 2d68 s _cpm2_.w_no_drv_dec:
eac0 2d68 d 329aeb
eac0 2d68 s 	LD	(_cpm2_EXR_DRV),A
eac3 2d6b s 
eac3 2d6b s 
eac3 2d6b d e5
eac3 2d6b s 	push 	hl
eac4 2d6c s _cpm2_r_p_SELDSKDRIVEW:
eac4 2d6c d 2a0000
eac4 2d6c s 	ld 	hl,(0)	;EXR_SELDSK_DRIVE
eac7 2d6f d 7e
eac7 2d6f s 	ld 	a,(hl)
eac8 2d70 d e1
eac8 2d70 s 	pop 	hl
eac9 2d71 d b7
eac9 2d71 s 	or 	a
eaca 2d72 d c2ecea
eaca 2d72 s 	jp 	nz,_cpm2__old_write
eacd 2d75 s 
eacd 2d75 s _cpm2_r_p_TRK2:
eacd 2d75 d 3affff
eacd 2d75 s 	LD	A,(_TRK)
ead0 2d78 d 329beb
ead0 2d78 s 	LD	(_cpm2_EXR_TRK),A
ead3 2d7b s _cpm2_r_p_SEC2:
ead3 2d7b d 3affff
ead3 2d7b s 	LD	A,(_SEC)
ead6 2d7e d 3d
ead6 2d7e s 	DEC	A
ead7 2d7f d 329ceb
ead7 2d7f s 	LD	(_cpm2_EXR_SEC),A
eada 2d82 s 
eada 2d82 d 3e02
eada 2d82 s 	LD	A,2		; 2 - команда записи
eadc 2d84 d 3299eb
eadc 2d84 s 	LD	(_cpm2_EXR_CMD),A
eadf 2d87 s 
eadf 2d87 d cd55eb
eadf 2d87 s 	CALL	_cpm2_EXR_SENDCMD
eae2 2d8a d 3d
eae2 2d8a s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
eae3 2d8b d c0
eae3 2d8b s 	RET	NZ		; 0 - ошибка
eae4 2d8c s _cpm2_r_p_DMA2:
eae4 2d8c d 2affff
eae4 2d8c s 	LD	HL,(_DMA)
eae7 2d8f d cd3aeb
eae7 2d8f s 	CALL	_cpm2_EXR_PUTSEC
eaea 2d92 d af
eaea 2d92 s 	XOR	A		; запись успешна
eaeb 2d93 d c9
eaeb 2d93 s 	RET
eaec 2d94 s 
eaec 2d94 s _cpm2__old_write:
eaec 2d94 d c3ecea
eaec 2d94 s 	jp 	$
eaef 2d97 s 
eaef 2d97 s 
eaef 2d97 s _cpm2_res_GETINFO:
eaef 2d97 s 
eaef 2d97 d 7e
eaef 2d97 s 	LD 	A,(HL)	; A= маска выбора привода
eaf0 2d98 d b7
eaf0 2d98 s 	or 	a
eaf1 2d99 d c2fcea
eaf1 2d99 s 	jp 	nz,_cpm2__old_getinfo 	;=0 if emulated
eaf4 2d9c s 
eaf4 2d9c s ;
eaf4 2d9c s ;  Чтение с эмулируемых дисков A или B
eaf4 2d9c s ;
eaf4 2d9c d e5
eaf4 2d9c s 	push 	hl
eaf5 2d9d d cd7beb
eaf5 2d9d s 	CALL	_cpm2_EXR_READINFO
eaf8 2da0 d 3d
eaf8 2da0 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
eaf9 2da1 s ; 	JP	NZ,0xE6ff	;IERR		; 0 - ошибка
eaf9 2da1 s _cpm2__old_getinfo_chkdo:
eaf9 2da1 d c3f9ea
eaf9 2da1 s 	JP	$ 		;IERR jnz xxx, CHKDO
eafc 2da4 s ; ;
eafc 2da4 s _cpm2__old_getinfo:
eafc 2da4 d c3fcea
eafc 2da4 s 	jp 	$ 		;GETINFO
eaff 2da7 s 
eaff 2da7 s 
eaff 2da7 s ;==================  Драйвер ExtROM-API ====================================
eaff 2da7 s 	
eaff 2da7 s 	
eaff 2da7 s ;****************************************
eaff 2da7 s ;*  Прием байта из порта А по стробу    *
eaff 2da7 s ;****************************************
eaff 2da7 s _cpm2_EXR_GETBYTE:
eaff 2da7 d e5
eaff 2da7 s 	PUSH	HL
eb00 2da8 d 210afb
eb00 2da8 s 	LD	HL,rPORTC
eb03 2dab s _cpm2_pWG:
eb03 2dab d 7e
eb03 2dab s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
eb04 2dac d e620
eb04 2dac s 	AND	20h		; выделяем сигнал IBF
eb06 2dae d ca03eb
eb06 2dae s 	JP	Z,_cpm2_pWG		; IBF=0 - данных еще нет
eb09 2db1 d 3a08fb
eb09 2db1 s 	LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
eb0c 2db4 d e1
eb0c 2db4 s 	POP	HL
eb0d 2db5 d c9
eb0d 2db5 s 	RET
eb0e 2db6 s 
eb0e 2db6 s ;****************************************
eb0e 2db6 s ;*  Отправка байта в порт A             *
eb0e 2db6 s ;****************************************
eb0e 2db6 s _cpm2_EXR_PUTBYTE:
eb0e 2db6 d e5
eb0e 2db6 s 	PUSH	HL
eb0f 2db7 d f5
eb0f 2db7 s 	PUSH	AF
eb10 2db8 d 210afb
eb10 2db8 s 	LD	HL,rPORTC
eb13 2dbb s _cpm2_pWP:
eb13 2dbb d 7e
eb13 2dbb s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
eb14 2dbc d e680
eb14 2dbc s 	AND	80h		; выделяем сигнал -OBF
eb16 2dbe d ca13eb
eb16 2dbe s 	JP	Z,_cpm2_pWP		; -OBF=0 - в передатчике сидит незабранный байт
eb19 2dc1 d f1
eb19 2dc1 s 	POP	AF
eb1a 2dc2 d 3208fb
eb1a 2dc2 s 	LD	(rPORTA),A		; данные поступили - выбираем их из порта А
eb1d 2dc5 d e1
eb1d 2dc5 s 	POP	HL
eb1e 2dc6 d c9
eb1e 2dc6 s 	RET
eb1f 2dc7 s 
eb1f 2dc7 s ;*******************************************
eb1f 2dc7 s ;*      Прием сектора                      *
eb1f 2dc7 s ;* HL - адрес размещения сектора в памяти  *
eb1f 2dc7 s ;*  Размер сектора - 128 байт              *
eb1f 2dc7 s ;*******************************************
eb1f 2dc7 s _cpm2_EXR_GETSEC:
eb1f 2dc7 d f3
eb1f 2dc7 s 	di
eb20 2dc8 d c5
eb20 2dc8 s 	PUSH	BC
eb21 2dc9 d d5
eb21 2dc9 s 	PUSH	DE
eb22 2dca d 0e80
eb22 2dca s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
eb24 2dcc d eb
eb24 2dcc s 	EX	DE,HL		; адрес буфера -> DE
eb25 2dcd d 210afb
eb25 2dcd s 	LD	HL,rPORTC
eb28 2dd0 s _cpm2_pGSL:
eb28 2dd0 d 7e
eb28 2dd0 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
eb29 2dd1 d e620
eb29 2dd1 s 	AND	20h		; выделяем сигнал IBF
eb2b 2dd3 d ca28eb
eb2b 2dd3 s 	JP	Z,_cpm2_pGSL		; IBF=0 - данных еще нет
eb2e 2dd6 d 3a08fb
eb2e 2dd6 s 	LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
eb31 2dd9 d 12
eb31 2dd9 s 	LD	(DE),A		; принимаем и размещаем очередной байт
eb32 2dda d 13
eb32 2dda s 	INC	DE		; указатель буфера ++
eb33 2ddb d 0d
eb33 2ddb s 	DEC	C		; принимаем остальные байты
eb34 2ddc d c228eb
eb34 2ddc s 	JP	NZ,_cpm2_pGSL
eb37 2ddf d d1
eb37 2ddf s 	POP	DE
eb38 2de0 d c1
eb38 2de0 s 	POP	BC
eb39 2de1 s ; 	ei - int should be still disabled 
eb39 2de1 d c9
eb39 2de1 s 	RET
eb3a 2de2 s 
eb3a 2de2 s ;*******************************************
eb3a 2de2 s ;*      Передача сектора                   *
eb3a 2de2 s ;* HL - адрес размещения сектора в памяти  *
eb3a 2de2 s ;*  Размер сектора - 128 байт              *
eb3a 2de2 s ;*******************************************
eb3a 2de2 s _cpm2_EXR_PUTSEC:
eb3a 2de2 d f3
eb3a 2de2 s 	di
eb3b 2de3 d c5
eb3b 2de3 s 	PUSH	BC
eb3c 2de4 d d5
eb3c 2de4 s 	PUSH	DE
eb3d 2de5 d 0e80
eb3d 2de5 s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
eb3f 2de7 d eb
eb3f 2de7 s 	EX	DE,HL		; адрес буфера -> DE
eb40 2de8 d 210afb
eb40 2de8 s 	LD	HL,rPORTC
eb43 2deb s _cpm2_pPSL:
eb43 2deb d 7e
eb43 2deb s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
eb44 2dec d e680
eb44 2dec s 	AND	80h		; выделяем сигнал -OBF
eb46 2dee d ca43eb
eb46 2dee s 	JP	Z,_cpm2_pPSL		; -OBF=0 - в передатчике сидит незабранный байт
eb49 2df1 d 1a
eb49 2df1 s 	LD	A,(DE)		; принимаем и размещаем очередной байт
eb4a 2df2 d 3208fb
eb4a 2df2 s 	LD	(rPORTA),A		; данные поступили - выбираем их из порта А
eb4d 2df5 d 13
eb4d 2df5 s 	INC	DE
eb4e 2df6 d 0d
eb4e 2df6 s 	DEC	C		; принимаем остальные байты
eb4f 2df7 d c243eb
eb4f 2df7 s 	JP	NZ,_cpm2_pPSL
eb52 2dfa d d1
eb52 2dfa s 	POP	DE
eb53 2dfb d c1
eb53 2dfb s 	POP	BC
eb54 2dfc s ; 	ei - int should be still disabled 
eb54 2dfc d c9
eb54 2dfc s 	RET
eb55 2dfd s 
eb55 2dfd s ;****************************************
eb55 2dfd s ;*     Отправка командного пакета       *
eb55 2dfd s ;****************************************
eb55 2dfd s _cpm2_EXR_SENDCMD:
eb55 2dfd s 
eb55 2dfd d f3
eb55 2dfd s 	di
eb56 2dfe d e5
eb56 2dfe s 	PUSH	HL
eb57 2dff d c5
eb57 2dff s 	PUSH	BC
eb58 2e00 d 3e0c
eb58 2e00 s 	LD	A,0Ch
eb5a 2e02 d 320bfb
eb5a 2e02 s 	LD	(rPCWR),A	; переключаем порт в режим 2
eb5d 2e05 d 2199eb
eb5d 2e05 s 	LD	HL,_cpm2_EXR_CMD
eb60 2e08 d 0e04
eb60 2e08 s 	LD	C,4		; пакет - 4 байта
eb62 2e0a d 0600
eb62 2e0a s 	LD	B,0		; заготовка контрольной суммы
eb64 2e0c s _cpm2_pSCL:
eb64 2e0c d 7e
eb64 2e0c s 	LD	A,(HL)		; очередной байт пакета 
eb65 2e0d d 80
eb65 2e0d s 	ADD 	B		; добавляем к КС
eb66 2e0e d 47
eb66 2e0e s 	LD	B,A
eb67 2e0f d 7e
eb67 2e0f s 	LD	A,(HL)		; очередной байт пакета 
eb68 2e10 d cd0eeb
eb68 2e10 s 	CALL	_cpm2_EXR_PUTBYTE		; - в порт
eb6b 2e13 d 23
eb6b 2e13 s 	INC	HL
eb6c 2e14 d 0d
eb6c 2e14 s 	DEC	C
eb6d 2e15 d c264eb
eb6d 2e15 s 	JP	NZ,_cpm2_pSCL
eb70 2e18 d 78
eb70 2e18 s 	LD	A,B
eb71 2e19 d 3d
eb71 2e19 s 	DEC 	A		; КС-1
eb72 2e1a d cd0eeb
eb72 2e1a s 	CALL	_cpm2_EXR_PUTBYTE     ; контрольная сумма
eb75 2e1d d cdffea
eb75 2e1d s 	CALL	_cpm2_EXR_GETBYTE	; ответ контроллера
eb78 2e20 d c1
eb78 2e20 s 	POP	BC
eb79 2e21 d e1
eb79 2e21 s 	POP	HL
eb7a 2e22 s ; 	ei - int should be still disabled 
eb7a 2e22 d c9
eb7a 2e22 s 	RET
eb7b 2e23 s 
eb7b 2e23 s ;*******************************************
eb7b 2e23 s ;*  Чтение информационного сектора
eb7b 2e23 s ;*******************************************
eb7b 2e23 s _cpm2_EXR_READINFO:
eb7b 2e23 d 2199eb
eb7b 2e23 s 	LD	HL,_cpm2_EXR_CMD	; командный пакет
eb7e 2e26 d 3601
eb7e 2e26 s 	LD	(HL),1		; команда чтения
eb80 2e28 d 23
eb80 2e28 s 	INC	HL
eb81 2e29 s _cpm2_r_p_DSK3:
eb81 2e29 d 3affff
eb81 2e29 s 	LD	A,(_DSK)	; вписываем # устройства
eb84 2e2c d 77
eb84 2e2c s 	LD	(HL),A
eb85 2e2d d 23
eb85 2e2d s 	INC	HL
eb86 2e2e d 3600
eb86 2e2e s 	LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
eb88 2e30 d 23
eb88 2e30 s 	INC	HL
eb89 2e31 d 3600
eb89 2e31 s 	LD	(HL),0		
eb8b 2e33 d cd55eb
eb8b 2e33 s 	CALL	_cpm2_EXR_SENDCMD	; отправляем команду
eb8e 2e36 d b7
eb8e 2e36 s 	OR	A
eb8f 2e37 d c8
eb8f 2e37 s 	RET 	Z		; ошибка
eb90 2e38 d 2100ee
eb90 2e38 s 	LD	HL,_RRBUFF	; принимаем данные
eb93 2e3b d cd1feb
eb93 2e3b s 	CALL	_cpm2_EXR_GETSEC
eb96 2e3e d 3e01
eb96 2e3e s 	LD	A,1
eb98 2e40 d c9
eb98 2e40 s 	RET
eb99 2e41 s 
eb99 2e41 s 
eb99 2e41 s ; Командный пакет интерфейса Extrom-API
eb99 2e41 s ;===============================================
eb99 2e41 d 00
eb99 2e41 s _cpm2_EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
eb9a 2e42 d 00
eb9a 2e42 s _cpm2_EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
eb9b 2e43 d 00
eb9b 2e43 s _cpm2_EXR_TRK:	DB	0	; логическая дорожка
eb9c 2e44 d 00
eb9c 2e44 s _cpm2_EXR_SEC:	DB	0	; логический сектор (128b)
eb9d 2e45 s 
eb9d 2e45 s 	endm
eb9d 2e45 s 
2e45 2e45 s 	.dephase
2e45 2e45 s 
2e45 2e45 s resident_cpm2_len 		equ	$-resident_cpm2
2e45 2e45 s 
2e45 2e45 s ; minimum hole_start .. min hole_end
2e45 2e45 s max_resident_cpm2_len 	equ 	0xEDFD-0xEA06 ;=1015
2e45 2e45 s 
2e45 2e45 s available_resident_cpm2_len	equ 	max_resident_cpm2_len-resident_cpm2_len
2e45 2e45 s 
2e45 2e45 s 	.assert max_resident_cpm2_len>=resident_cpm2_len
2e45 2e45 f generator/V0/extrom-patcher.asm
2e45 2e45 s 	include 	"extrom-patcher-resident-microdos.asm"
2e45 2e45 f extrom-patcher-resident-microdos.asm
2e45 2e45 s MD_rPORTA	EQU	0FE08H		; Порт Канала A интерфейса расширения
2e45 2e45 s MD_rPORTC	EQU	0FE0AH		; Порт Канала С интерфейса расширения
2e45 2e45 s MD_rPCWR	EQU	0FE0BH		; Порт управляющих команд
2e45 2e45 s 
2e45 2e45 s MD_RRBUFF 	EQU 	0
2e45 2e45 s 
2e45 2e45 s resident_md:
2e45 2e45 s 
2e45 2e45 s ; 	.phase 	0xFD80
fa00 2e45 s 	.phase 	0xFA00
fa00 2e45 s resident_md_addr 	EQU 	$
fa00 2e45 s 
fa00 2e45 s 
fa00 2e45 s ;мы тут в конфигуации 0x5C
fa00 2e45 s 
fa00 2e45 s ;Код Cfg    ПЗУ     ОЗУ        ГЗУ   ОЗУ2       Клав  Рег2  А/Ц   Рег1
fa00 2e45 s ;ID  Name   ROM     RAM        GZU   Ram2       KBD   REGS  ACZU  DEV
fa00 2e45 s ;______________________________________________________________________
fa00 2e45 s ;1C  ODOSA          0000-F7FF                   F800  FA00  FC00  FB00
fa00 2e45 s ;5C  DOSA           0000-FDFF                         FF00        FE00
fa00 2e45 s 
fa00 2e45 s 
fa00 2e45 s 
fa00 2e45 s ;PATCH --------------------------------------------------------------------------
fa00 2e45 s 
fa00 2e45 s ;do_dskIO
fa00 2e45 s 
fa00 2e45 s ; RAM:EAFD FE 04                    cp      4 		
fa00 2e45 s ; RAM:EAFF CA 36 EB                 jp      z, jREAD 		<--- MY write
fa00 2e45 s ; RAM:EB02 FE 06                    cp      6
fa00 2e45 s ; RAM:EB04 CA A0 EB                 jp      z, jWRITE 		<--- MY write
fa00 2e45 s 
fa00 2e45 s 
fa00 2e45 s ; SELDSK:
fa00 2e45 s ; RAM:EC87 CD 14 EE                 call    SEL_DSK_SEEK0       <--- 00 00 00
fa00 2e45 s ; RAM:EC8A CD 1E EE                 call    ReadToRDBUF 	<--- MY read info into F04E. nz if err 
fa00 2e45 s 
fa00 2e45 s ; RAM:EC3A          Flush?:                                 ; CODE XREF: do_DSKIO+6Ap
fa00 2e45 s ; RAM:EC3A                                                  ; do_DSKIO+9Ap ...
fa00 2e45 s ; RAM:EC3A 21 FD EE                 ld      hl, flagWriteReuired?
fa00 2e45 s ; RAM:EC3D 7E                       ld      a, (hl)
fa00 2e45 s ; RAM:EC3E B7                       or      a
fa00 2e45 s ; RAM:EC3F C8                       ret     z  			<--- C9, newer flush
fa00 2e45 s ; RAM:EC42 21 0A EF                 ld      hl, WrBufDiskInfo   <--- or C9 HERE
fa00 2e45 s 
fa00 2e45 s 
fa00 2e45 s ;DISKINFO -----------------------------------------------------------------------
fa00 2e45 s 
fa00 2e45 s ; RAM:EB36          jREAD:                                  ; CODE XREF: do_DSKIO+40j
fa00 2e45 s ; RAM:EB36 2A F8 EE                 ld      hl, (DSC_IO_HL) ; DSCDESCR
fa00 2e45 s ; RAM:EB39 46                       ld      b, (hl)         ; Drive
fa00 2e45 s ; RAM:EB3A 23                       inc     hl
fa00 2e45 s 
fa00 2e45 s ; RAM:EAF1 7E                       ld      a, (hl) 	    ;operation 3-reset?, 4-read,6-write
fa00 2e45 s ; RAM:EAF2 23                       inc     hl
fa00 2e45 s 
fa00 2e45 s ; RAM:EB3C 23                       inc     hl 		    ; ?chword?
fa00 2e45 s ; RAM:EB3D 23                       inc     hl              ; ?NumB?
fa00 2e45 s 
fa00 2e45 s ; RAM:EB3E 4E                       ld      c, (hl)         ; track
fa00 2e45 s ; RAM:EB3F 23                       inc     hl
fa00 2e45 s 
fa00 2e45 s ; RAM:EB40 7E                       ld      a, (hl)         ; sector
fa00 2e45 s ; RAM:EB3F 23                       inc     hl
fa00 2e45 s 
fa00 2e45 s ; RAM:EAF6 5E                       ld      e, (hl)
fa00 2e45 s ; RAM:EAF7 23                       inc     hl
fa00 2e45 s ; RAM:EAF8 56                       ld      d, (hl)
fa00 2e45 s ; RAM:EAF9 EB                       ex      de, hl
fa00 2e45 s ; RAM:EAFA 22 FA EE                 ld      (_DMA??), hl
fa00 2e45 s ;DISKINFO -----------------------------------------------------------------------
fa00 2e45 s md_res_DRIVEA:
fa00 2e45 d 00
fa00 2e45 s 	db 	0
fa01 2e46 s md_res_DRIVEB:
fa01 2e46 d 00
fa01 2e46 s 	db 	0
fa02 2e47 s 
fa02 2e47 s md_res_DRIVE_TAB:
fa02 2e47 d 00fa
fa02 2e47 s 	dw 	md_res_DRIVEA 	;A
fa04 2e49 d 01fa
fa04 2e49 s 	dw 	md_res_DRIVEB 	;B
fa06 2e4b d 0000
fa06 2e4b s 	dw 	0 	;C
fa08 2e4d d 0000
fa08 2e4d s 	dw 	0 	;D
fa0a 2e4f d 0000
fa0a 2e4f s 	dw 	0 	;E
fa0c 2e51 d 0000
fa0c 2e51 s 	dw 	0 	;F
fa0e 2e53 s 
fa0e 2e53 s md_res_seldsk:
fa0e 2e53 d 79
fa0e 2e53 s 	ld 	a,c
fa0f 2e54 d fefe
fa0f 2e54 s 	cp 	0xfe
fa11 2e56 s md_old_seld_dsk:
fa11 2e56 d c211fa
fa11 2e56 s 	jp 	nz,$	
fa14 2e59 d 2102fa
fa14 2e59 s 	ld 	hl,md_res_DRIVE_TAB
fa17 2e5c d c9
fa17 2e5c s 	ret
fa18 2e5d s 
fa18 2e5d s md_fetch_params:
fa18 2e5d s 
fa18 2e5d d f5
fa18 2e5d s 	push 	af
fa19 2e5e d c5
fa19 2e5e s 	push 	bc
fa1a 2e5f d d5
fa1a 2e5f s 	push 	de
fa1b 2e60 d e5
fa1b 2e60 s 	push 	hl
fa1c 2e61 s 
fa1c 2e61 s MD_PARAM2:
fa1c 2e61 d 2af8ee
fa1c 2e61 s 	ld      hl, (0xEEF8) ; DSCDESCR
fa1f 2e64 d 7e
fa1f 2e64 s 	ld      a, (hl)         ; Drive
fa20 2e65 d 23
fa20 2e65 s 	inc     hl
fa21 2e66 d 320bfb
fa21 2e66 s 	ld 	(MD_EXR_DRV),a
fa24 2e69 s 
fa24 2e69 s ; 	ld      a, (hl)		;operation 3-reset?, 4-read,6-write
fa24 2e69 d 23
fa24 2e69 s 	inc     hl
fa25 2e6a s 
fa25 2e6a d 23
fa25 2e6a s 	inc     hl		; ?chword?
fa26 2e6b d 23
fa26 2e6b s 	inc     hl              ; ?NumB?
fa27 2e6c s 
fa27 2e6c d 7e
fa27 2e6c s 	ld      a, (hl)         ; track
fa28 2e6d d 23
fa28 2e6d s 	inc     hl
fa29 2e6e d 320cfb
fa29 2e6e s 	ld 	(MD_EXR_TRK),a
fa2c 2e71 s 
fa2c 2e71 d 7e
fa2c 2e71 s 	ld      a, (hl)         ; sector
fa2d 2e72 d 3d
fa2d 2e72 s 	DEC	A
fa2e 2e73 d 23
fa2e 2e73 s 	inc     hl
fa2f 2e74 d 320dfb
fa2f 2e74 s 	ld 	(MD_EXR_SEC),a
fa32 2e77 s 
fa32 2e77 d 5e
fa32 2e77 s 	ld      e, (hl)
fa33 2e78 d 23
fa33 2e78 s 	inc     hl
fa34 2e79 d 56
fa34 2e79 s 	ld      d, (hl)
fa35 2e7a d eb
fa35 2e7a s 	ex      de, hl
fa36 2e7b d 220efb
fa36 2e7b s 	ld      (MD_DMA), hl
fa39 2e7e s 
fa39 2e7e d e1
fa39 2e7e s 	pop 	hl
fa3a 2e7f d d1
fa3a 2e7f s 	pop 	de
fa3b 2e80 d c1
fa3b 2e80 s 	pop 	bc
fa3c 2e81 d f1
fa3c 2e81 s 	pop 	af
fa3d 2e82 s 
fa3d 2e82 d c9
fa3d 2e82 s 	ret
fa3e 2e83 s 
fa3e 2e83 s MD_READ:
fa3e 2e83 d cd18fa
fa3e 2e83 s 	call 	md_fetch_params
fa41 2e86 s 	
fa41 2e86 d 3e01
fa41 2e86 s 	LD	A,1
fa43 2e88 d 320afb
fa43 2e88 s 	LD	(MD_EXR_CMD),A	; 1 - команда чтения
fa46 2e8b s 
fa46 2e8b d cdc5fa
fa46 2e8b s 	CALL	MD_EXR_SENDCMD	; отсылаем команду
fa49 2e8e d 3d
fa49 2e8e s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
fa4a 2e8f d c0
fa4a 2e8f s 	RET	NZ		; 0 - ошибка
fa4b 2e90 d 2a0efb
fa4b 2e90 s 	LD	HL,(MD_DMA)	; адрес буфера для приема данных
fa4e 2e93 d cd8dfa
fa4e 2e93 s 	CALL	MD_EXR_GETSEC	; принимаем данные
fa51 2e96 d af
fa51 2e96 s 	XOR	A		; завершение всегда успешно
fa52 2e97 d c9
fa52 2e97 s 	RET
fa53 2e98 s 
fa53 2e98 s MD_WRITE:
fa53 2e98 d cd18fa
fa53 2e98 s 	call	md_fetch_params
fa56 2e9b s 
fa56 2e9b d 3e02
fa56 2e9b s 	LD	A,2		; 2 - команда записи
fa58 2e9d d 320afb
fa58 2e9d s 	LD	(MD_EXR_CMD),A
fa5b 2ea0 s 
fa5b 2ea0 d cdc5fa
fa5b 2ea0 s 	CALL	MD_EXR_SENDCMD
fa5e 2ea3 d 3d
fa5e 2ea3 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
fa5f 2ea4 d c0
fa5f 2ea4 s 	RET	NZ		; 0 - ошибка
fa60 2ea5 d 2a0efb
fa60 2ea5 s 	LD	HL,(MD_DMA)
fa63 2ea8 d cda9fa
fa63 2ea8 s 	CALL	MD_EXR_PUTSEC
fa66 2eab d af
fa66 2eab s 	XOR	A		; запись успешна
fa67 2eac d c9
fa67 2eac s 	RET
fa68 2ead s 
fa68 2ead s MD_READ_INFOSECTOR:
fa68 2ead d cdecfa
fa68 2ead s 	CALL	MD_EXR_READINFO
fa6b 2eb0 d 3d
fa6b 2eb0 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
fa6c 2eb1 d c9
fa6c 2eb1 s 	ret
fa6d 2eb2 s 
fa6d 2eb2 s 
fa6d 2eb2 s ;==================  Драйвер ExtROM-API ====================================
fa6d 2eb2 s 	
fa6d 2eb2 s 	
fa6d 2eb2 s ;****************************************
fa6d 2eb2 s ;*  Прием байта из порта А по стробу    *
fa6d 2eb2 s ;****************************************
fa6d 2eb2 s MD_EXR_GETBYTE:
fa6d 2eb2 d e5
fa6d 2eb2 s 	PUSH	HL
fa6e 2eb3 d 210afe
fa6e 2eb3 s 	LD	HL,MD_rPORTC
fa71 2eb6 s MD_pWG:
fa71 2eb6 d 7e
fa71 2eb6 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
fa72 2eb7 d e620
fa72 2eb7 s 	AND	20h		; выделяем сигнал IBF
fa74 2eb9 d ca71fa
fa74 2eb9 s 	JP	Z,MD_pWG		; IBF=0 - данных еще нет
fa77 2ebc d 3a08fe
fa77 2ebc s 	LD	A,(MD_rPORTA)		; данные поступили - выбираем их из порта А
fa7a 2ebf d e1
fa7a 2ebf s 	POP	HL
fa7b 2ec0 d c9
fa7b 2ec0 s 	RET
fa7c 2ec1 s 
fa7c 2ec1 s ;****************************************
fa7c 2ec1 s ;*  Отправка байта в порт A             *
fa7c 2ec1 s ;****************************************
fa7c 2ec1 s MD_EXR_PUTBYTE:
fa7c 2ec1 d e5
fa7c 2ec1 s 	PUSH	HL
fa7d 2ec2 d f5
fa7d 2ec2 s 	PUSH	AF
fa7e 2ec3 d 210afe
fa7e 2ec3 s 	LD	HL,MD_rPORTC
fa81 2ec6 s MD_pWP:
fa81 2ec6 d 7e
fa81 2ec6 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
fa82 2ec7 d e680
fa82 2ec7 s 	AND	80h		; выделяем сигнал -OBF
fa84 2ec9 d ca81fa
fa84 2ec9 s 	JP	Z,MD_pWP		; -OBF=0 - в передатчике сидит незабранный байт
fa87 2ecc d f1
fa87 2ecc s 	POP	AF
fa88 2ecd d 3208fe
fa88 2ecd s 	LD	(MD_rPORTA),A		; данные поступили - выбираем их из порта А
fa8b 2ed0 d e1
fa8b 2ed0 s 	POP	HL
fa8c 2ed1 d c9
fa8c 2ed1 s 	RET
fa8d 2ed2 s 
fa8d 2ed2 s ;*******************************************
fa8d 2ed2 s ;*      Прием сектора                      *
fa8d 2ed2 s ;* HL - адрес размещения сектора в памяти  *
fa8d 2ed2 s ;*  Размер сектора - 128 байт              *
fa8d 2ed2 s ;*******************************************
fa8d 2ed2 s MD_EXR_GETSEC:
fa8d 2ed2 d f3
fa8d 2ed2 s 	di
fa8e 2ed3 d c5
fa8e 2ed3 s 	PUSH	BC
fa8f 2ed4 d d5
fa8f 2ed4 s 	PUSH	DE
fa90 2ed5 d 0e80
fa90 2ed5 s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
fa92 2ed7 d eb
fa92 2ed7 s 	EX	DE,HL		; адрес буфера -> DE
fa93 2ed8 d 210afe
fa93 2ed8 s 	LD	HL,MD_rPORTC
fa96 2edb s MD_pGSL:
fa96 2edb d 7e
fa96 2edb s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
fa97 2edc d e620
fa97 2edc s 	AND	20h		; выделяем сигнал IBF
fa99 2ede d ca96fa
fa99 2ede s 	JP	Z,MD_pGSL		; IBF=0 - данных еще нет
fa9c 2ee1 d 3a08fe
fa9c 2ee1 s 	LD	A,(MD_rPORTA)		; данные поступили - выбираем их из порта А
fa9f 2ee4 d 12
fa9f 2ee4 s 	LD	(DE),A		; принимаем и размещаем очередной байт
faa0 2ee5 d 13
faa0 2ee5 s 	INC	DE		; указатель буфера ++
faa1 2ee6 d 0d
faa1 2ee6 s 	DEC	C		; принимаем остальные байты
faa2 2ee7 d c296fa
faa2 2ee7 s 	JP	NZ,MD_pGSL
faa5 2eea d d1
faa5 2eea s 	POP	DE
faa6 2eeb d c1
faa6 2eeb s 	POP	BC
faa7 2eec d fb
faa7 2eec s 	ei 		
faa8 2eed d c9
faa8 2eed s 	RET
faa9 2eee s 
faa9 2eee s ;*******************************************
faa9 2eee s ;*      Передача сектора                   *
faa9 2eee s ;* HL - адрес размещения сектора в памяти  *
faa9 2eee s ;*  Размер сектора - 128 байт              *
faa9 2eee s ;*******************************************
faa9 2eee s MD_EXR_PUTSEC:
faa9 2eee d f3
faa9 2eee s 	di
faaa 2eef d c5
faaa 2eef s 	PUSH	BC
faab 2ef0 d d5
faab 2ef0 s 	PUSH	DE
faac 2ef1 d 0e80
faac 2ef1 s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
faae 2ef3 d eb
faae 2ef3 s 	EX	DE,HL		; адрес буфера -> DE
faaf 2ef4 d 210afe
faaf 2ef4 s 	LD	HL,MD_rPORTC
fab2 2ef7 s MD_pPSL:
fab2 2ef7 d 7e
fab2 2ef7 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
fab3 2ef8 d e680
fab3 2ef8 s 	AND	80h		; выделяем сигнал -OBF
fab5 2efa d cab2fa
fab5 2efa s 	JP	Z,MD_pPSL		; -OBF=0 - в передатчике сидит незабранный байт
fab8 2efd d 1a
fab8 2efd s 	LD	A,(DE)		; принимаем и размещаем очередной байт
fab9 2efe d 3208fe
fab9 2efe s 	LD	(MD_rPORTA),A		; данные поступили - выбираем их из порта А
fabc 2f01 d 13
fabc 2f01 s 	INC	DE
fabd 2f02 d 0d
fabd 2f02 s 	DEC	C		; принимаем остальные байты
fabe 2f03 d c2b2fa
fabe 2f03 s 	JP	NZ,MD_pPSL
fac1 2f06 d d1
fac1 2f06 s 	POP	DE
fac2 2f07 d c1
fac2 2f07 s 	POP	BC
fac3 2f08 d fb
fac3 2f08 s 	ei 		
fac4 2f09 d c9
fac4 2f09 s 	RET
fac5 2f0a s 
fac5 2f0a s ;****************************************
fac5 2f0a s ;*     Отправка командного пакета       *
fac5 2f0a s ;****************************************
fac5 2f0a s MD_EXR_SENDCMD:
fac5 2f0a s 
fac5 2f0a d f3
fac5 2f0a s 	di
fac6 2f0b d e5
fac6 2f0b s 	PUSH	HL
fac7 2f0c d c5
fac7 2f0c s 	PUSH	BC
fac8 2f0d d 3e0c
fac8 2f0d s 	LD	A,0Ch
faca 2f0f d 320bfe
faca 2f0f s 	LD	(MD_rPCWR),A	; переключаем порт в режим 2
facd 2f12 d 210afb
facd 2f12 s 	LD	HL,MD_EXR_CMD
fad0 2f15 d 0e04
fad0 2f15 s 	LD	C,4		; пакет - 4 байта
fad2 2f17 d 0600
fad2 2f17 s 	LD	B,0		; заготовка контрольной суммы
fad4 2f19 s MD_pSCL:
fad4 2f19 d 7e
fad4 2f19 s 	LD	A,(HL)		; очередной байт пакета 
fad5 2f1a d 80
fad5 2f1a s 	ADD 	B		; добавляем к КС
fad6 2f1b d 47
fad6 2f1b s 	LD	B,A
fad7 2f1c d 7e
fad7 2f1c s 	LD	A,(HL)		; очередной байт пакета 
fad8 2f1d d cd7cfa
fad8 2f1d s 	CALL	MD_EXR_PUTBYTE		; - в порт
fadb 2f20 d 23
fadb 2f20 s 	INC	HL
fadc 2f21 d 0d
fadc 2f21 s 	DEC	C
fadd 2f22 d c2d4fa
fadd 2f22 s 	JP	NZ,MD_pSCL
fae0 2f25 d 78
fae0 2f25 s 	LD	A,B
fae1 2f26 d 3d
fae1 2f26 s 	DEC 	A		; КС-1
fae2 2f27 d cd7cfa
fae2 2f27 s 	CALL	MD_EXR_PUTBYTE     ; контрольная сумма
fae5 2f2a d cd6dfa
fae5 2f2a s 	CALL	MD_EXR_GETBYTE	; ответ контроллера
fae8 2f2d d c1
fae8 2f2d s 	POP	BC
fae9 2f2e d e1
fae9 2f2e s 	POP	HL
faea 2f2f d fb
faea 2f2f s 	ei 		
faeb 2f30 d c9
faeb 2f30 s 	RET
faec 2f31 s 
faec 2f31 s ;*******************************************
faec 2f31 s ;*  Чтение информационного сектора
faec 2f31 s ;*******************************************
faec 2f31 s MD_EXR_READINFO:
faec 2f31 d 210afb
faec 2f31 s 	LD	HL,MD_EXR_CMD	; командный пакет
faef 2f34 d 3601
faef 2f34 s 	LD	(HL),1		; команда чтения
faf1 2f36 d 23
faf1 2f36 s 	INC	HL
faf2 2f37 s MD_DRV2:
faf2 2f37 d 3a06ef
faf2 2f37 s 	LD	A,(0xEF06)	; вписываем # устройства
faf5 2f3a d 77
faf5 2f3a s 	LD	(HL),A
faf6 2f3b d 23
faf6 2f3b s 	INC	HL
faf7 2f3c d 3600
faf7 2f3c s 	LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
faf9 2f3e d 23
faf9 2f3e s 	INC	HL
fafa 2f3f d 3600
fafa 2f3f s 	LD	(HL),0		
fafc 2f41 d cdc5fa
fafc 2f41 s 	CALL	MD_EXR_SENDCMD	; отправляем команду
faff 2f44 d b7
faff 2f44 s 	OR	A
fb00 2f45 d c8
fb00 2f45 s 	RET 	Z		; ошибка
fb01 2f46 s MD_RDBUF2:
fb01 2f46 d 210000
fb01 2f46 s 	LD	HL,MD_RRBUFF	; принимаем данные
fb04 2f49 d cd8dfa
fb04 2f49 s 	CALL	MD_EXR_GETSEC
fb07 2f4c d 3e01
fb07 2f4c s 	LD	A,1
fb09 2f4e d c9
fb09 2f4e s 	RET
fb0a 2f4f s 
fb0a 2f4f s 
fb0a 2f4f s ; Командный пакет интерфейса Extrom-API
fb0a 2f4f s ;===============================================
fb0a 2f4f d 00
fb0a 2f4f s MD_EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
fb0b 2f50 d 00
fb0b 2f50 s MD_EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
fb0c 2f51 d 00
fb0c 2f51 s MD_EXR_TRK:	DB	0	; логическая дорожка
fb0d 2f52 d 00
fb0d 2f52 s MD_EXR_SEC:	DB	0	; логический сектор (128b)
fb0e 2f53 d 0000
fb0e 2f53 s MD_DMA: 	DW 	0 	; адресс куда/откуда
fb10 2f55 s 
2f55 2f55 s 	.dephase
2f55 2f55 s resident_md_len 	equ $-resident_md
2f55 2f55 s 
2f55 2f55 s 
2f55 2f55 f generator/V0/extrom-patcher.asm
2f55 2f55 s 	include 	"out/include-patcher.asm"
2f55 2f55 f out/include-patcher.asm
2f55 2f55 s bios_variants:
2f55 2f55 d 952f
2f55 2f55 s 	dw	_BIOS_CPM_21_EXTROM
2f57 2f57 d d52f
2f57 2f57 s 	dw	_BIOS_CPM_12_88_3_alternativa
2f59 2f59 d c330
2f59 2f59 s 	dw	_BIOS_CPM_12_88_3_niijaf
2f5b 2f5b d a031
2f5b 2f5b s 	dw	_BIOS_CPM_21_89___wiza
2f5d 2f5d d 8232
2f5d 2f5d s 	dw	_BIOS_MICRODOS_OPTS2_880630
2f5f 2f5f d 0233
2f5f 2f5f s 	dw	_BIOS_CPM_21_89_2_niijaf2
2f61 2f61 d e033
2f61 2f61 s 	dw	_BIOS_CPM_21_89_2_niijaf
2f63 2f63 d bd34
2f63 2f63 s 	dw	_BIOS_MICRODOS_OPTS1_870430
2f65 2f65 d 3835
2f65 2f65 s 	dw	_BIOS_CPM_1x_89_03_30_RAVI
2f67 2f67 d 1836
2f67 2f67 s 	dw	_BIOS_MICRODOS_OPTS1_861011
2f69 2f69 d 9d36
2f69 2f69 s 	dw	_BIOS_CPM_21_91___LAP
2f6b 2f6b d 7737
2f6b 2f6b s 	dw	_BIOS_CPM_20_88___miks
2f6d 2f6d d 5238
2f6d 2f6d s 	dw	_BIOS_CPM_12_90_5_kontur
2f6f 2f6f d 2f39
2f6f 2f6f s 	dw	_BIOS_MICRODOS_OPTS2_900105
2f71 2f71 d b339
2f71 2f71 s 	dw	_BIOS_CPM_12_87_11_niijaf
2f73 2f73 d 913a
2f73 2f73 s 	dw	_BIOS_CPM_21m_____Shkanov
2f75 2f75 d 6f3b
2f75 2f75 s 	dw	_BIOS_CPM_12_87_09_NIIJAF
2f77 2f77 d 4d3c
2f77 2f77 s 	dw	_BIOS_MICRODOS_OPTS1_871220
2f79 2f79 d cd3c
2f79 2f79 s 	dw	_BIOS_MICRODOS_OPTS1_861115
2f7b 2f7b d 523d
2f7b 2f7b s 	dw	_BIOS_CPM_NET_SFERA1
2f7d 2f7d d 9b3d
2f7d 2f7d s 	dw	_BIOS_CPM_NET_KORNET_drive_b
2f7f 2f7f d c93d
2f7f 2f7f s 	dw	_BIOS_CPM_NET_KORNET_drive_a
2f81 2f81 d 1a3e
2f81 2f81 s 	dw	_BIOS_CPM_1x_88_EPSON_V104
2f83 2f83 d fa3e
2f83 2f83 s 	dw	_BIOS_CPM_NET_SFERA2
2f85 2f85 d 0000
2f85 2f85 s 	dw	0
2f87 2f87 s 
2f87 2f87 d 5041544348455220444154413e3e
2f87 2f87 s 	db 	"PATCHER DATA>>"
2f95 2f95 s 
2f95 2f95 s 	include "generator/V0/out/patcher-cpm_chk-CPM_21_EXTROM.asm"
2f95 2f95 f generator/V0/out/patcher-cpm_chk-CPM_21_EXTROM.asm
2f95 2f95 s _BIOS_CPM_21_EXTROM:
2f95 2f95 s 	setCPM
2f95 2f95 s 	endm
2f95 2f95 s 	setSUBBIOS 3
2f95 2f95 d 5a
2f95 2f95 s 	db	pSubBios
2f96 2f96 d 03
2f96 2f96 s 	db 	3
2f97 2f97 s 	endm
2f97 2f97 s 	dwstore	drivetab_mount_info	,0xDA3F
2f97 2f97 d 54
2f97 2f97 s 	db 	pW_STORE
2f98 2f98 d 3fda
2f98 2f98 s 	dw 	0xDA3F
2f9a 2f9a d 6f2a
2f9a 2f9a s 	dw 	drivetab_mount_info
2f9c 2f9c s 	endm
2f9c 2f9c s 	;custom checkers
2f9c 2f9c s 	dwpatch	0xDA33+0	,0x5845 ,0x5845
2f9c 2f9c d 51
2f9c 2f9c s 	db 	pW_CHK_PATCH
2f9d 2f9d d 33da
2f9d 2f9d s 	dw 	0xDA33+0
2f9f 2f9f d 45584558
2f9f 2f9f s 	dw 	0x5845,0x5845
2fa3 2fa3 s 	endm
2fa3 2fa3 s 	dwpatch	0xDA33+2	,0x5254 ,0x5254
2fa3 2fa3 d 51
2fa3 2fa3 s 	db 	pW_CHK_PATCH
2fa4 2fa4 d 35da
2fa4 2fa4 s 	dw 	0xDA33+2
2fa6 2fa6 d 54525452
2fa6 2fa6 s 	dw 	0x5254,0x5254
2faa 2faa s 	endm
2faa 2faa s 	dwpatch	0xDA33+4	,0x4D4F ,0x4D4F
2faa 2faa d 51
2faa 2faa s 	db 	pW_CHK_PATCH
2fab 2fab d 37da
2fab 2fab s 	dw 	0xDA33+4
2fad 2fad d 4f4d4f4d
2fad 2fad s 	dw 	0x4D4F,0x4D4F
2fb1 2fb1 s 	endm
2fb1 2fb1 s 	dwpatch	0xDA33+6	,0x4942 ,0x4942
2fb1 2fb1 d 51
2fb1 2fb1 s 	db 	pW_CHK_PATCH
2fb2 2fb2 d 39da
2fb2 2fb2 s 	dw 	0xDA33+6
2fb4 2fb4 d 42494249
2fb4 2fb4 s 	dw 	0x4942,0x4942
2fb8 2fb8 s 	endm
2fb8 2fb8 s 	dwpatch	0xDA33+8	,0x534F ,0x534F
2fb8 2fb8 d 51
2fb8 2fb8 s 	db 	pW_CHK_PATCH
2fb9 2fb9 d 3bda
2fb9 2fb9 s 	dw 	0xDA33+8
2fbb 2fbb d 4f534f53
2fbb 2fbb s 	dw 	0x534F,0x534F
2fbf 2fbf s 	endm
2fbf 2fbf s 	dwpatch	0xDA33+10	,0x3156 ,0x3156
2fbf 2fbf d 51
2fbf 2fbf s 	db 	pW_CHK_PATCH
2fc0 2fc0 d 3dda
2fc0 2fc0 s 	dw 	0xDA33+10
2fc2 2fc2 d 56315631
2fc2 2fc2 s 	dw 	0x3156,0x3156
2fc6 2fc6 s 	endm
2fc6 2fc6 s 	stop 'CPM_21_EXTROM'
2fc6 2fc6 d 50
2fc6 2fc6 s 	db 	p_STOP
2fc7 2fc7 d 43504d5f32315f455854524f4d
2fc7 2fc7 s 	db 	'CPM_21_EXTROM'
2fd4 2fd4 d 00
2fd4 2fd4 s 	db 	0
2fd5 2fd5 s 	endm
2fd5 2fd5 f out/include-patcher.asm
2fd5 2fd5 s 	include "generator/V0/out/patcher-cpm1-CPM_12_88_3_alternativa.asm"	; 25 images in collection
2fd5 2fd5 f generator/V0/out/patcher-cpm1-CPM_12_88_3_alternativa.asm
2fd5 2fd5 s _BIOS_CPM_12_88_3_alternativa:
2fd5 2fd5 s 	setSUBBIOS 1
2fd5 2fd5 d 5a
2fd5 2fd5 s 	db	pSubBios
2fd6 2fd6 d 01
2fd6 2fd6 s 	db 	1
2fd7 2fd7 s 	endm
2fd7 2fd7 s 	RQ_OPTS_ANY
2fd7 2fd7 s 	endm
2fd7 2fd7 s 	setCPM
2fd7 2fd7 s 	endm
2fd7 2fd7 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
2fd7 2fd7 d 59
2fd7 2fd7 s 	db 	pB_MAYBE_PATCH
2fd8 2fd8 d eeda
2fd8 2fd8 s 	dw 	0xDAEE
2fda 2fda d 1f0d
2fda 2fda s 	db 	0x1F,0x0d
2fdc 2fdc s 	endm
2fdc 2fdc s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
2fdc 2fdc d 59
2fdc 2fdc s 	db 	pB_MAYBE_PATCH
2fdd 2fdd d f0da
2fdd 2fdd s 	dw 	0xDAEE+2
2fdf 2fdf d 0a0d
2fdf 2fdf s 	db 	0x0a,0x0d
2fe1 2fe1 s 	endm
2fe1 2fe1 s 	dbpatch	0xE077+1	,0x49	,0xc9
2fe1 2fe1 d 52
2fe1 2fe1 s 	db 	pB_CHK_PATCH
2fe2 2fe2 d 78e0
2fe2 2fe2 s 	dw 	0xE077+1
2fe4 2fe4 d 49c9
2fe4 2fe4 s 	db 	0x49,0xc9
2fe6 2fe6 s 	endm
2fe6 2fe6 s 	dbpatch	0xDA88 	,0x01	,0x00
2fe6 2fe6 d 52
2fe6 2fe6 s 	db 	pB_CHK_PATCH
2fe7 2fe7 d 88da
2fe7 2fe7 s 	dw 	0xDA88
2fe9 2fe9 d 0100
2fe9 2fe9 s 	db 	0x01,0x00
2feb 2feb s 	endm
2feb 2feb s 	dbpatch	0xDA9F 	,0x02	,0x00
2feb 2feb d 52
2feb 2feb s 	db 	pB_CHK_PATCH
2fec 2fec d 9fda
2fec 2fec s 	dw 	0xDA9F
2fee 2fee d 0200
2fee 2fee s 	db 	0x02,0x00
2ff0 2ff0 s 	endm
2ff0 2ff0 s 	dbpatch	0xDAB6 	,0x04	,0x01
2ff0 2ff0 d 52
2ff0 2ff0 s 	db 	pB_CHK_PATCH
2ff1 2ff1 d b6da
2ff1 2ff1 s 	dw 	0xDAB6
2ff3 2ff3 d 0401
2ff3 2ff3 s 	db 	0x04,0x01
2ff5 2ff5 s 	endm
2ff5 2ff5 s 	dbpatch	0xDACD 	,0x08	,0x02
2ff5 2ff5 d 52
2ff5 2ff5 s 	db 	pB_CHK_PATCH
2ff6 2ff6 d cdda
2ff6 2ff6 s 	dw 	0xDACD
2ff8 2ff8 d 0802
2ff8 2ff8 s 	db 	0x08,0x02
2ffa 2ffa s 	endm
2ffa 2ffa s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
2ffa 2ffa d 54
2ffa 2ffa s 	db 	pW_STORE
2ffb 2ffb d 88da
2ffb 2ffb s 	dw 	0xDA88
2ffd 2ffd d ace8
2ffd 2ffd s 	dw 	_CPM1_res_DRIVE_TAB+0*2
2fff 2fff s 	endm
2fff 2fff s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
2fff 2fff d 54
2fff 2fff s 	db 	pW_STORE
3000 3000 d 9fda
3000 3000 s 	dw 	0xDA9F
3002 3002 d aee8
3002 3002 s 	dw 	_CPM1_res_DRIVE_TAB+1*2
3004 3004 s 	endm
3004 3004 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
3004 3004 d 54
3004 3004 s 	db 	pW_STORE
3005 3005 d b6da
3005 3005 s 	dw 	0xDAB6
3007 3007 d b0e8
3007 3007 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
3009 3009 s 	endm
3009 3009 s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
3009 3009 d 54
3009 3009 s 	db 	pW_STORE
300a 300a d cdda
300a 300a s 	dw 	0xDACD
300c 300c d b2e8
300c 300c s 	dw 	_CPM1_res_DRIVE_TAB+3*2
300e 300e s 	endm
300e 300e s 	dwpatch 0xDCBF+5*2 	,0x0000 ,_CPM1_dph_F
300e 300e d 51
300e 300e s 	db 	pW_CHK_PATCH
300f 300f d c9dc
300f 300f s 	dw 	0xDCBF+5*2
3011 3011 d 0000b8e8
3011 3011 s 	dw 	0x0000,_CPM1_dph_F
3015 3015 s 	endm
3015 3015 s 	dwstore _CPM1_dph_F+8	,0xEBA6
3015 3015 d 54
3015 3015 s 	db 	pW_STORE
3016 3016 d a6eb
3016 3016 s 	dw 	0xEBA6
3018 3018 d c0e8
3018 3018 s 	dw 	_CPM1_dph_F+8
301a 301a s 	endm
301a 301a s 	dwpatch 0xDA1B+1 	,0xDC7B	,_CPM1_res_seldsk
301a 301a d 51
301a 301a s 	db 	pW_CHK_PATCH
301b 301b d 1cda
301b 301b s 	dw 	0xDA1B+1
301d 301d d 7bdc11e9
301d 301d s 	dw 	0xDC7B,_CPM1_res_seldsk
3021 3021 s 	endm
3021 3021 s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC7B
3021 3021 d 54
3021 3021 s 	db 	pW_STORE
3022 3022 d 7bdc
3022 3022 s 	dw 	0xDC7B
3024 3024 d 15e9
3024 3024 s 	dw 	_CPM1_old_seld_dsk+1
3026 3026 s 	endm
3026 3026 s 	dbpatch	0xE63E	,0x77	,0x00
3026 3026 d 52
3026 3026 s 	db 	pB_CHK_PATCH
3027 3027 d 3ee6
3027 3027 s 	dw 	0xE63E
3029 3029 d 7700
3029 3029 s 	db 	0x77,0x00
302b 302b s 	endm
302b 302b s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDF92
302b 302b d 54
302b 302b s 	db 	pW_STORE
302c 302c d 92df
302c 302c s 	dw 	0xDF92
302e 302e d 2ee9
302e 302e s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
3030 3030 s 	endm
3030 3030 s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDF92
3030 3030 d 54
3030 3030 s 	db 	pW_STORE
3031 3031 d 92df
3031 3031 s 	dw 	0xDF92
3033 3033 d 6be9
3033 3033 s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
3035 3035 s 	endm
3035 3035 s 	dwpatch	0xDA27+1	,0xDCDE	,_CPM1_res_READ
3035 3035 d 51
3035 3035 s 	db 	pW_CHK_PATCH
3036 3036 d 28da
3036 3036 s 	dw 	0xDA27+1
3038 3038 d dedc1be9
3038 3038 s 	dw 	0xDCDE,_CPM1_res_READ
303c 303c s 	endm
303c 303c s 	dwpatch	0xDA2A+1	,0xDE14	,_CPM1_res_WRITE
303c 303c d 51
303c 303c s 	db 	pW_CHK_PATCH
303d 303d d 2bda
303d 303d s 	dw 	0xDA2A+1
303f 303f d 14de58e9
303f 303f s 	dw 	0xDE14,_CPM1_res_WRITE
3043 3043 s 	endm
3043 3043 s 	dwpatch	0xDB74+1	,0xDCDE	,_CPM1_res_READ
3043 3043 d 51
3043 3043 s 	db 	pW_CHK_PATCH
3044 3044 d 75db
3044 3044 s 	dw 	0xDB74+1
3046 3046 d dedc1be9
3046 3046 s 	dw 	0xDCDE,_CPM1_res_READ
304a 304a s 	endm
304a 304a s 	dwpatch	0xDCAD+1	,0xE574	,_CPM1_res_GETINFO
304a 304a d 51
304a 304a s 	db 	pW_CHK_PATCH
304b 304b d aedc
304b 304b s 	dw 	0xDCAD+1
304d 304d d 74e595e9
304d 304d s 	dw 	0xE574,_CPM1_res_GETINFO
3051 3051 s 	endm
3051 3051 s 	dwstore	_CPM1__old_read+1	,0xDCDE
3051 3051 d 54
3051 3051 s 	db 	pW_STORE
3052 3052 d dedc
3052 3052 s 	dw 	0xDCDE
3054 3054 d 56e9
3054 3054 s 	dw 	_CPM1__old_read+1
3056 3056 s 	endm
3056 3056 s 	dwstore	_CPM1__old_write+1	,0xDE14
3056 3056 d 54
3056 3056 s 	db 	pW_STORE
3057 3057 d 14de
3057 3057 s 	dw 	0xDE14
3059 3059 d 93e9
3059 3059 s 	dw 	_CPM1__old_write+1
305b 305b s 	endm
305b 305b s 	dwstore	_CPM1__old_getinfo+1	,0xE574
305b 305b d 54
305b 305b s 	db 	pW_STORE
305c 305c d 74e5
305c 305c s 	dw 	0xE574
305e 305e d a3e9
305e 305e s 	dw 	_CPM1__old_getinfo+1
3060 3060 s 	endm
3060 3060 s 	dbpatch	0xE5B4		,0x21	,0x21
3060 3060 d 52
3060 3060 s 	db 	pB_CHK_PATCH
3061 3061 d b4e5
3061 3061 s 	dw 	0xE5B4
3063 3063 d 2121
3063 3063 s 	db 	0x21,0x21
3065 3065 s 	endm
3065 3065 s 	dwpatch	0xE5B4+1 	,0xE5E4	,0xE5E4
3065 3065 d 51
3065 3065 s 	db 	pW_CHK_PATCH
3066 3066 d b5e5
3066 3066 s 	dw 	0xE5B4+1
3068 3068 d e4e5e4e5
3068 3068 s 	dw 	0xE5E4,0xE5E4
306c 306c s 	endm
306c 306c s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE5B4
306c 306c d 54
306c 306c s 	db 	pW_STORE
306d 306d d b4e5
306d 306d s 	dw 	0xE5B4
306f 306f d a0e9
306f 306f s 	dw 	_CPM1__old_getinfo_chkdo+1
3071 3071 s 	endm
3071 3071 s 	dwstore	_CPM1_r_p_DSK1+1	,0xDF88 	;read
3071 3071 d 54
3071 3071 s 	db 	pW_STORE
3072 3072 d 88df
3072 3072 s 	dw 	0xDF88
3074 3074 d 1ce9
3074 3074 s 	dw 	_CPM1_r_p_DSK1+1
3076 3076 s 	endm
3076 3076 s 	dwstore	_CPM1_r_p_TRK1+1	,0xDF8C 	
3076 3076 d 54
3076 3076 s 	db 	pW_STORE
3077 3077 d 8cdf
3077 3077 s 	dw 	0xDF8C
3079 3079 d 37e9
3079 3079 s 	dw 	_CPM1_r_p_TRK1+1
307b 307b s 	endm
307b 307b s 	dwstore	_CPM1_r_p_SEC1+1	,0xDF8D 	
307b 307b d 54
307b 307b s 	db 	pW_STORE
307c 307c d 8ddf
307c 307c s 	dw 	0xDF8D
307e 307e d 3de9
307e 307e s 	dw 	_CPM1_r_p_SEC1+1
3080 3080 s 	endm
3080 3080 s 	dwstore	_CPM1_r_p_DMA1+1	,0xDF8E 	
3080 3080 d 54
3080 3080 s 	db 	pW_STORE
3081 3081 d 8edf
3081 3081 s 	dw 	0xDF8E
3083 3083 d 4ee9
3083 3083 s 	dw 	_CPM1_r_p_DMA1+1
3085 3085 s 	endm
3085 3085 s 	dwstore	_CPM1_r_p_DSK2+1	,0xDF88 	;write
3085 3085 d 54
3085 3085 s 	db 	pW_STORE
3086 3086 d 88df
3086 3086 s 	dw 	0xDF88
3088 3088 d 59e9
3088 3088 s 	dw 	_CPM1_r_p_DSK2+1
308a 308a s 	endm
308a 308a s 	dwstore	_CPM1_r_p_TRK2+1	,0xDF8C 	
308a 308a d 54
308a 308a s 	db 	pW_STORE
308b 308b d 8cdf
308b 308b s 	dw 	0xDF8C
308d 308d d 74e9
308d 308d s 	dw 	_CPM1_r_p_TRK2+1
308f 308f s 	endm
308f 308f s 	dwstore	_CPM1_r_p_SEC2+1	,0xDF8D 	
308f 308f d 54
308f 308f s 	db 	pW_STORE
3090 3090 d 8ddf
3090 3090 s 	dw 	0xDF8D
3092 3092 d 7ae9
3092 3092 s 	dw 	_CPM1_r_p_SEC2+1
3094 3094 s 	endm
3094 3094 s 	dwstore	_CPM1_r_p_DMA2+1	,0xDF8E 	
3094 3094 d 54
3094 3094 s 	db 	pW_STORE
3095 3095 d 8edf
3095 3095 s 	dw 	0xDF8E
3097 3097 d 8be9
3097 3097 s 	dw 	_CPM1_r_p_DMA2+1
3099 3099 s 	endm
3099 3099 s 	dwstore	_CPM1_r_p_DSK3+1	,0xDF88 	;readinfo
3099 3099 d 54
3099 3099 s 	db 	pW_STORE
309a 309a d 88df
309a 309a s 	dw 	0xDF88
309c 309c d 28ea
309c 309c s 	dw 	_CPM1_r_p_DSK3+1
309e 309e s 	endm
309e 309e s 	;custom checkers
309e 309e s 	dbpatch	0xE01D	,0x21 ,0x21
309e 309e d 52
309e 309e s 	db 	pB_CHK_PATCH
309f 309f d 1de0
309f 309f s 	dw 	0xE01D
30a1 30a1 d 2121
30a1 30a1 s 	db 	0x21,0x21
30a3 30a3 s 	endm
30a3 30a3 s 	dwpatch	0xE01D+1	,0xFB21 ,0xFB21
30a3 30a3 d 51
30a3 30a3 s 	db 	pW_CHK_PATCH
30a4 30a4 d 1ee0
30a4 30a4 s 	dw 	0xE01D+1
30a6 30a6 d 21fb21fb
30a6 30a6 s 	dw 	0xFB21,0xFB21
30aa 30aa s 	endm
30aa 30aa s 	stop 'CPM_12_88_3_alternativa'
30aa 30aa d 50
30aa 30aa s 	db 	p_STOP
30ab 30ab d 43504d5f31325f38385f335f616c7465726e6174697661
30ab 30ab s 	db 	'CPM_12_88_3_alternativa'
30c2 30c2 d 00
30c2 30c2 s 	db 	0
30c3 30c3 s 	endm
30c3 30c3 f out/include-patcher.asm
30c3 30c3 s 	include "generator/V0/out/patcher-cpm1-CPM_12_88_3_niijaf.asm"	; 78 images in collection
30c3 30c3 f generator/V0/out/patcher-cpm1-CPM_12_88_3_niijaf.asm
30c3 30c3 s _BIOS_CPM_12_88_3_niijaf:
30c3 30c3 s 	setSUBBIOS 1
30c3 30c3 d 5a
30c3 30c3 s 	db	pSubBios
30c4 30c4 d 01
30c4 30c4 s 	db 	1
30c5 30c5 s 	endm
30c5 30c5 s 	RQ_OPTS_ANY
30c5 30c5 s 	endm
30c5 30c5 s 	setCPM
30c5 30c5 s 	endm
30c5 30c5 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
30c5 30c5 d 59
30c5 30c5 s 	db 	pB_MAYBE_PATCH
30c6 30c6 d eeda
30c6 30c6 s 	dw 	0xDAEE
30c8 30c8 d 1f0d
30c8 30c8 s 	db 	0x1F,0x0d
30ca 30ca s 	endm
30ca 30ca s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
30ca 30ca d 59
30ca 30ca s 	db 	pB_MAYBE_PATCH
30cb 30cb d f0da
30cb 30cb s 	dw 	0xDAEE+2
30cd 30cd d 0a0d
30cd 30cd s 	db 	0x0a,0x0d
30cf 30cf s 	endm
30cf 30cf s 	dbpatch	0xE077+1	,0x49	,0xc9
30cf 30cf d 52
30cf 30cf s 	db 	pB_CHK_PATCH
30d0 30d0 d 78e0
30d0 30d0 s 	dw 	0xE077+1
30d2 30d2 d 49c9
30d2 30d2 s 	db 	0x49,0xc9
30d4 30d4 s 	endm
30d4 30d4 s 	dbpatch	0xDA88 	,0x01	,0x00
30d4 30d4 d 52
30d4 30d4 s 	db 	pB_CHK_PATCH
30d5 30d5 d 88da
30d5 30d5 s 	dw 	0xDA88
30d7 30d7 d 0100
30d7 30d7 s 	db 	0x01,0x00
30d9 30d9 s 	endm
30d9 30d9 s 	dbpatch	0xDA9F 	,0x02	,0x00
30d9 30d9 d 52
30d9 30d9 s 	db 	pB_CHK_PATCH
30da 30da d 9fda
30da 30da s 	dw 	0xDA9F
30dc 30dc d 0200
30dc 30dc s 	db 	0x02,0x00
30de 30de s 	endm
30de 30de s 	dbpatch	0xDAB6 	,0x04	,0x01
30de 30de d 52
30de 30de s 	db 	pB_CHK_PATCH
30df 30df d b6da
30df 30df s 	dw 	0xDAB6
30e1 30e1 d 0401
30e1 30e1 s 	db 	0x04,0x01
30e3 30e3 s 	endm
30e3 30e3 s 	dbpatch	0xDACD 	,0x08	,0x02
30e3 30e3 d 52
30e3 30e3 s 	db 	pB_CHK_PATCH
30e4 30e4 d cdda
30e4 30e4 s 	dw 	0xDACD
30e6 30e6 d 0802
30e6 30e6 s 	db 	0x08,0x02
30e8 30e8 s 	endm
30e8 30e8 s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
30e8 30e8 d 54
30e8 30e8 s 	db 	pW_STORE
30e9 30e9 d 88da
30e9 30e9 s 	dw 	0xDA88
30eb 30eb d ace8
30eb 30eb s 	dw 	_CPM1_res_DRIVE_TAB+0*2
30ed 30ed s 	endm
30ed 30ed s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
30ed 30ed d 54
30ed 30ed s 	db 	pW_STORE
30ee 30ee d 9fda
30ee 30ee s 	dw 	0xDA9F
30f0 30f0 d aee8
30f0 30f0 s 	dw 	_CPM1_res_DRIVE_TAB+1*2
30f2 30f2 s 	endm
30f2 30f2 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
30f2 30f2 d 54
30f2 30f2 s 	db 	pW_STORE
30f3 30f3 d b6da
30f3 30f3 s 	dw 	0xDAB6
30f5 30f5 d b0e8
30f5 30f5 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
30f7 30f7 s 	endm
30f7 30f7 s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
30f7 30f7 d 54
30f7 30f7 s 	db 	pW_STORE
30f8 30f8 d cdda
30f8 30f8 s 	dw 	0xDACD
30fa 30fa d b2e8
30fa 30fa s 	dw 	_CPM1_res_DRIVE_TAB+3*2
30fc 30fc s 	endm
30fc 30fc s 	dwpatch 0xDCBF+5*2 	,0x0000 ,_CPM1_dph_F
30fc 30fc d 51
30fc 30fc s 	db 	pW_CHK_PATCH
30fd 30fd d c9dc
30fd 30fd s 	dw 	0xDCBF+5*2
30ff 30ff d 0000b8e8
30ff 30ff s 	dw 	0x0000,_CPM1_dph_F
3103 3103 s 	endm
3103 3103 s 	dwstore _CPM1_dph_F+8	,0xEBA6
3103 3103 d 54
3103 3103 s 	db 	pW_STORE
3104 3104 d a6eb
3104 3104 s 	dw 	0xEBA6
3106 3106 d c0e8
3106 3106 s 	dw 	_CPM1_dph_F+8
3108 3108 s 	endm
3108 3108 s 	dwpatch 0xDA1B+1 	,0xDC7B	,_CPM1_res_seldsk
3108 3108 d 51
3108 3108 s 	db 	pW_CHK_PATCH
3109 3109 d 1cda
3109 3109 s 	dw 	0xDA1B+1
310b 310b d 7bdc11e9
310b 310b s 	dw 	0xDC7B,_CPM1_res_seldsk
310f 310f s 	endm
310f 310f s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC7B
310f 310f d 54
310f 310f s 	db 	pW_STORE
3110 3110 d 7bdc
3110 3110 s 	dw 	0xDC7B
3112 3112 d 15e9
3112 3112 s 	dw 	_CPM1_old_seld_dsk+1
3114 3114 s 	endm
3114 3114 s 	dbpatch	0xE63E	,0x77	,0x00
3114 3114 d 52
3114 3114 s 	db 	pB_CHK_PATCH
3115 3115 d 3ee6
3115 3115 s 	dw 	0xE63E
3117 3117 d 7700
3117 3117 s 	db 	0x77,0x00
3119 3119 s 	endm
3119 3119 s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDF92
3119 3119 d 54
3119 3119 s 	db 	pW_STORE
311a 311a d 92df
311a 311a s 	dw 	0xDF92
311c 311c d 2ee9
311c 311c s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
311e 311e s 	endm
311e 311e s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDF92
311e 311e d 54
311e 311e s 	db 	pW_STORE
311f 311f d 92df
311f 311f s 	dw 	0xDF92
3121 3121 d 6be9
3121 3121 s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
3123 3123 s 	endm
3123 3123 s 	dwpatch	0xDA27+1	,0xDCDE	,_CPM1_res_READ
3123 3123 d 51
3123 3123 s 	db 	pW_CHK_PATCH
3124 3124 d 28da
3124 3124 s 	dw 	0xDA27+1
3126 3126 d dedc1be9
3126 3126 s 	dw 	0xDCDE,_CPM1_res_READ
312a 312a s 	endm
312a 312a s 	dwpatch	0xDA2A+1	,0xDE14	,_CPM1_res_WRITE
312a 312a d 51
312a 312a s 	db 	pW_CHK_PATCH
312b 312b d 2bda
312b 312b s 	dw 	0xDA2A+1
312d 312d d 14de58e9
312d 312d s 	dw 	0xDE14,_CPM1_res_WRITE
3131 3131 s 	endm
3131 3131 s 	dwpatch	0xDB74+1	,0xDCDE	,_CPM1_res_READ
3131 3131 d 51
3131 3131 s 	db 	pW_CHK_PATCH
3132 3132 d 75db
3132 3132 s 	dw 	0xDB74+1
3134 3134 d dedc1be9
3134 3134 s 	dw 	0xDCDE,_CPM1_res_READ
3138 3138 s 	endm
3138 3138 s 	dwpatch	0xDCAD+1	,0xE574	,_CPM1_res_GETINFO
3138 3138 d 51
3138 3138 s 	db 	pW_CHK_PATCH
3139 3139 d aedc
3139 3139 s 	dw 	0xDCAD+1
313b 313b d 74e595e9
313b 313b s 	dw 	0xE574,_CPM1_res_GETINFO
313f 313f s 	endm
313f 313f s 	dwstore	_CPM1__old_read+1	,0xDCDE
313f 313f d 54
313f 313f s 	db 	pW_STORE
3140 3140 d dedc
3140 3140 s 	dw 	0xDCDE
3142 3142 d 56e9
3142 3142 s 	dw 	_CPM1__old_read+1
3144 3144 s 	endm
3144 3144 s 	dwstore	_CPM1__old_write+1	,0xDE14
3144 3144 d 54
3144 3144 s 	db 	pW_STORE
3145 3145 d 14de
3145 3145 s 	dw 	0xDE14
3147 3147 d 93e9
3147 3147 s 	dw 	_CPM1__old_write+1
3149 3149 s 	endm
3149 3149 s 	dwstore	_CPM1__old_getinfo+1	,0xE574
3149 3149 d 54
3149 3149 s 	db 	pW_STORE
314a 314a d 74e5
314a 314a s 	dw 	0xE574
314c 314c d a3e9
314c 314c s 	dw 	_CPM1__old_getinfo+1
314e 314e s 	endm
314e 314e s 	dbpatch	0xE5B4		,0x21	,0x21
314e 314e d 52
314e 314e s 	db 	pB_CHK_PATCH
314f 314f d b4e5
314f 314f s 	dw 	0xE5B4
3151 3151 d 2121
3151 3151 s 	db 	0x21,0x21
3153 3153 s 	endm
3153 3153 s 	dwpatch	0xE5B4+1 	,0xE5E4	,0xE5E4
3153 3153 d 51
3153 3153 s 	db 	pW_CHK_PATCH
3154 3154 d b5e5
3154 3154 s 	dw 	0xE5B4+1
3156 3156 d e4e5e4e5
3156 3156 s 	dw 	0xE5E4,0xE5E4
315a 315a s 	endm
315a 315a s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE5B4
315a 315a d 54
315a 315a s 	db 	pW_STORE
315b 315b d b4e5
315b 315b s 	dw 	0xE5B4
315d 315d d a0e9
315d 315d s 	dw 	_CPM1__old_getinfo_chkdo+1
315f 315f s 	endm
315f 315f s 	dwstore	_CPM1_r_p_DSK1+1	,0xDF88 	;read
315f 315f d 54
315f 315f s 	db 	pW_STORE
3160 3160 d 88df
3160 3160 s 	dw 	0xDF88
3162 3162 d 1ce9
3162 3162 s 	dw 	_CPM1_r_p_DSK1+1
3164 3164 s 	endm
3164 3164 s 	dwstore	_CPM1_r_p_TRK1+1	,0xDF8C 	
3164 3164 d 54
3164 3164 s 	db 	pW_STORE
3165 3165 d 8cdf
3165 3165 s 	dw 	0xDF8C
3167 3167 d 37e9
3167 3167 s 	dw 	_CPM1_r_p_TRK1+1
3169 3169 s 	endm
3169 3169 s 	dwstore	_CPM1_r_p_SEC1+1	,0xDF8D 	
3169 3169 d 54
3169 3169 s 	db 	pW_STORE
316a 316a d 8ddf
316a 316a s 	dw 	0xDF8D
316c 316c d 3de9
316c 316c s 	dw 	_CPM1_r_p_SEC1+1
316e 316e s 	endm
316e 316e s 	dwstore	_CPM1_r_p_DMA1+1	,0xDF8E 	
316e 316e d 54
316e 316e s 	db 	pW_STORE
316f 316f d 8edf
316f 316f s 	dw 	0xDF8E
3171 3171 d 4ee9
3171 3171 s 	dw 	_CPM1_r_p_DMA1+1
3173 3173 s 	endm
3173 3173 s 	dwstore	_CPM1_r_p_DSK2+1	,0xDF88 	;write
3173 3173 d 54
3173 3173 s 	db 	pW_STORE
3174 3174 d 88df
3174 3174 s 	dw 	0xDF88
3176 3176 d 59e9
3176 3176 s 	dw 	_CPM1_r_p_DSK2+1
3178 3178 s 	endm
3178 3178 s 	dwstore	_CPM1_r_p_TRK2+1	,0xDF8C 	
3178 3178 d 54
3178 3178 s 	db 	pW_STORE
3179 3179 d 8cdf
3179 3179 s 	dw 	0xDF8C
317b 317b d 74e9
317b 317b s 	dw 	_CPM1_r_p_TRK2+1
317d 317d s 	endm
317d 317d s 	dwstore	_CPM1_r_p_SEC2+1	,0xDF8D 	
317d 317d d 54
317d 317d s 	db 	pW_STORE
317e 317e d 8ddf
317e 317e s 	dw 	0xDF8D
3180 3180 d 7ae9
3180 3180 s 	dw 	_CPM1_r_p_SEC2+1
3182 3182 s 	endm
3182 3182 s 	dwstore	_CPM1_r_p_DMA2+1	,0xDF8E 	
3182 3182 d 54
3182 3182 s 	db 	pW_STORE
3183 3183 d 8edf
3183 3183 s 	dw 	0xDF8E
3185 3185 d 8be9
3185 3185 s 	dw 	_CPM1_r_p_DMA2+1
3187 3187 s 	endm
3187 3187 s 	dwstore	_CPM1_r_p_DSK3+1	,0xDF88 	;readinfo
3187 3187 d 54
3187 3187 s 	db 	pW_STORE
3188 3188 d 88df
3188 3188 s 	dw 	0xDF88
318a 318a d 28ea
318a 318a s 	dw 	_CPM1_r_p_DSK3+1
318c 318c s 	endm
318c 318c s 
318c 318c s 	stop 'CPM_12_88_3_niijaf'
318c 318c d 50
318c 318c s 	db 	p_STOP
318d 318d d 43504d5f31325f38385f335f6e69696a6166
318d 318d s 	db 	'CPM_12_88_3_niijaf'
319f 319f d 00
319f 319f s 	db 	0
31a0 31a0 s 	endm
31a0 31a0 f out/include-patcher.asm
31a0 31a0 s 	include "generator/V0/out/patcher-cpm1-CPM_21_89___wiza.asm"	; 42 images in collection
31a0 31a0 f generator/V0/out/patcher-cpm1-CPM_21_89___wiza.asm
31a0 31a0 s _BIOS_CPM_21_89___wiza:
31a0 31a0 s 	setSUBBIOS 1
31a0 31a0 d 5a
31a0 31a0 s 	db	pSubBios
31a1 31a1 d 01
31a1 31a1 s 	db 	1
31a2 31a2 s 	endm
31a2 31a2 s 
31a2 31a2 s 	;адресса актуальные для биоса 21_89___wiza
31a2 31a2 s 
31a2 31a2 s 	;BIOS_LOGO 		=> "0xDAEE",
31a2 31a2 s 	;PPI2C_BIOS_IIT 	=> "0xE49F",
31a2 31a2 s 	;DRVREG_A 		=> "0xDAA0",
31a2 31a2 s 	;DRVREG_B 		=> "0xDA90",
31a2 31a2 s 	;DRVREG_C 		=> "0xDAB7",
31a2 31a2 s 	;DRVREG_D 		=> "0xDACE",
31a2 31a2 s 	;SELDSK_STOREDRV	=> "0xE70A",
31a2 31a2 s 	;SELDSK_ADDR		=> "0xDC8D",
31a2 31a2 s 	;CURRENT_DISKPTR   	=> "0xE06E",
31a2 31a2 s 	;BIOS_READ 		=> "0xDCEB",
31a2 31a2 s 	;BIOS_WRITE 		=> "0xDEAF",
31a2 31a2 s 	;SELDSK_GETINO_CALL	=> "0xdcbf",
31a2 31a2 s 	;BIOS_GETINFO		=> "0xE648",
31a2 31a2 s 	;WBOOT_READ_CLL 	=> "0xDB84",
31a2 31a2 s 	;GETINFO_POSTTOM_ADDR 	=> "0xE67F",
31a2 31a2 s 	;GETINFO_POSTTOM_CHKW 	=> "0xE6AF",
31a2 31a2 s 	;BIOS_VAR_DSK		=> "0xE064",
31a2 31a2 s 	;BIOS_VAR_SEC		=> "0xE068",
31a2 31a2 s 	;BIOS_VAR_TRK		=> "0xE069",
31a2 31a2 s 	;BIOS_VAR_DMA		=> "0xE06A",
31a2 31a2 s 	;VINTKBDADDR 		=> "0xe3e3",
31a2 31a2 s 	;VINTKBDVALUE		=> "0xdc46",
31a2 31a2 s 	;KBD_HOOK_PRO 		=> "kbd_hook_2133",
31a2 31a2 s 	;NAME 			=> '21_89___wiza',
31a2 31a2 s 
31a2 31a2 s 	;Чекер/Патчер
31a2 31a2 s 	;есть три основных комманды
31a2 31a2 s 	;dbpatch addr oldbyte newbyte
31a2 31a2 s 	;dwpatch addr oldword newword
31a2 31a2 s 	;dwstore addr newword
31a2 31a2 s 	;и ряд вспомогательных
31a2 31a2 s 	;setCPM
31a2 31a2 s 	;setMICRODOS
31a2 31a2 s 	;checkOPTS1
31a2 31a2 s 	;checkOPTS2
31a2 31a2 s 	;unsupported
31a2 31a2 s 	;pSTOP 'biosname'
31a2 31a2 s 
31a2 31a2 s 	;на первом этапе патчер проверяет что в памяти именно этот биос
31a2 31a2 s 	;для этого он проходтся по d(b|w)patch и проверяет 
31a2 31a2 s 	;что по адрессу addr записано значени old(byte|word)
31a2 31a2 s 
31a2 31a2 s 	;если это не так (т.е. на первой же проверке которая не прошла)
31a2 31a2 s 	;то считаем что биос не соответсвует проверяемому и надо пробовать следующий
31a2 31a2 s 
31a2 31a2 s 	;если же все проверки прошли - то запускается второй проход
31a2 31a2 s 	;правим значения в памяти (собственно patch)
31a2 31a2 s 	;т.е для d(b|w)patch по addr записывается значение new(byte|word)
31a2 31a2 s 	;для dwstore просто по адрессу addr записывается newword
31a2 31a2 s 
31a2 31a2 s 	;если old = new - то это просто проверка, т.к. значение не изменяется
31a2 31a2 s 
31a2 31a2 s 	RQ_OPTS_ANY
31a2 31a2 s 	endm
31a2 31a2 s 
31a2 31a2 s 	;
31a2 31a2 s 	;ниже описан "TEMPLATE" для поддержки CP/M BIOS
31a2 31a2 s 	;все примеры кода ниже взяты для биоса '21_89___wiza'
31a2 31a2 s 	;
31a2 31a2 s 	;я попробую возле каждого параметра описать откуда он получен
31a2 31a2 s 	;если вдруг будет необходимость расширить набор поддерживаемых
31a2 31a2 s 	;bios.
31a2 31a2 s 	;на сегодня поддерживается 13 уникальных CP/M bios для Корвета
31a2 31a2 s 	;под "уникальными" понимается разные биосы, в которых отличается код
31a2 31a2 s 	;во времена когда использовали Корвет было нормально править биос прямо на дискете
31a2 31a2 s 	;обычно правили функциональные клавиши, таблицы перекодировки принтера
31a2 31a2 s 	;и надписи ;)
31a2 31a2 s 	;по этой причине разно выглядящие биосы могут быть одинаковыми внутри
31a2 31a2 s 	;предварительный анализ позволил выделить 13 уникальных биосов среди сотен дискет
31a2 31a2 s 	;что сильно упростило дальнейшую работу.
31a2 31a2 s 	;
31a2 31a2 s 	;patcher же делает необходимое кол-во проверок и изменений биоса
31a2 31a2 s 	;чтобы подготовить его к работе с EXTROM API
31a2 31a2 s 	;
31a2 31a2 s 	;значения вида CPM_21_89___wiza должны быть заменены на значения
31a2 31a2 s 	;соотвествующие конкретному биосу
31a2 31a2 s 
31a2 31a2 s 	;Lets go
31a2 31a2 s 
31a2 31a2 s 	;установим тип системы CP/M (нужно для случая когда биос опознан но не может быть использован)
31a2 31a2 s 	;в случае с cp/m это важно для '1x_88_EPSON_V104'	'1x_89_03_30_RAVI'
31a2 31a2 s 	;они работают только с ОПТС 1
31a2 31a2 s 	;и по этой причине на ОПТС 2 надо fallback to default CP/M
31a2 31a2 s 	setCPM
31a2 31a2 s 	endm
31a2 31a2 s 
31a2 31a2 s 	;BIOS_LOGO--------------------------------------------------------------
31a2 31a2 s 	;косметика,  
31a2 31a2 s 	;Биос при старте очищает экран, мы патчим его чтобы он это не делал
31a2 31a2 s 	;иначе он затрёт все сообщения патчера, а там много полезной информации
31a2 31a2 s 	;выгядит это в коде так
31a2 31a2 s 	
31a2 31a2 s 	;RAM:DA00          _BOOT:
31a2 31a2 s 	;RAM:DA00 C3 42 DB                 jp      j_BOOT
31a2 31a2 s 	;....
31a2 31a2 s 	;RAM:DB42          j_BOOT:                                 
31a2 31a2 s 	;RAM:DB42 F3                       di
31a2 31a2 s 	;RAM:DB43 31 80 00                 ld      sp, 80h 
31a2 31a2 s 	;RAM:DB46 3E 1C                    ld      a, 1Ch
31a2 31a2 s 	;RAM:DB48 32 7F FA                 ld      (_1C_SysReg1C), a
31a2 31a2 s 	;...
31a2 31a2 s 	;RAM:DB58 21 EE DA                 ld      hl, BIOS_LOGO   ; "\\x1F\\r\\nCP/M-80  vers. 2.2"
31a2 31a2 s 	;RAM:DB5B CD 2D E0                 call    putstr
31a2 31a2 s 	;...
31a2 31a2 s 	;RAM:DAEE 1F 0D 0A+BIOS_LOGO:      text "KOI8-R", '\\x1F\\r\\n'
31a2 31a2 s 	;RAM:DAEE 43 50 2F+                text "KOI8-R", 'CP/M-80  vers. 2.2 \\r\\n'
31a2 31a2 s 	;RAM:DAEE 4D 2D 38+                text "KOI8-R", 'BIOS  vers.2.1 (c) \\r\\n'
31a2 31a2 s 	;RAM:DAEE 30 20 20+                text "KOI8-R", 'МГУ н/п кооп."ВИЗА"\\r\\n'
31a2 31a2 s 	;RAM:DAEE 76 65 72+                text "KOI8-R", '   МОСКВА 1989 \\r\\n'
31a2 31a2 s 	;RAM:DAEE 73 2E 20+                text "KOI8-R", 0
31a2 31a2 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
31a2 31a2 d 59
31a2 31a2 s 	db 	pB_MAYBE_PATCH
31a3 31a3 d eeda
31a3 31a3 s 	dw 	0xDAEE
31a5 31a5 d 1f0d
31a5 31a5 s 	db 	0x1F,0x0d
31a7 31a7 s 	endm
31a7 31a7 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
31a7 31a7 d 59
31a7 31a7 s 	db 	pB_MAYBE_PATCH
31a8 31a8 d f0da
31a8 31a8 s 	dw 	0xDAEE+2
31aa 31aa d 0a0d
31aa 31aa s 	db 	0x0a,0x0d
31ac 31ac s 	endm
31ac 31ac s 
31ac 31ac s 	;PPI2C_BIOS_INIT--------------------------------------------------------
31ac 31ac s 	;Биос при старте производит инициализацию перифирии, разных контроллеров
31ac 31ac s 	;в том числе записывает значение 0x49 в порт PPI2.C 
31ac 31ac s 	;(разрешаем вывод звука, ~SE, ResetForJoy)
31ac 31ac s 	;для нас важно что тут он сбрабсывает PPI2.C.8 (ENABLE EXTROM)
31ac 31ac s 	;без которого наш контроллер не работает.
31ac 31ac s 	;мы модифицируем это значение чтобы бит8 был установлен 0x49 -> 0xC9 
31ac 31ac s 	;выгядит это в коде так
31ac 31ac s 	;нас интересует адресс E49F
31ac 31ac s 
31ac 31ac s 	;RAM:DA00          _BOOT:
31ac 31ac s 	;RAM:DA00 C3 42 DB                 jp      j_BOOT
31ac 31ac s 	;....
31ac 31ac s 	;RAM:DB42          j_BOOT:                                 
31ac 31ac s 	;RAM:DB42 F3                       di
31ac 31ac s 	;RAM:DB43 31 80 00                 ld      sp, 80h ; 'Ç'
31ac 31ac s 	;RAM:DB46 3E 1C                    ld      a, 1Ch
31ac 31ac s 	;RAM:DB48 32 7F FA                 ld      (_1C_SysReg1C), a
31ac 31ac s 	;RAM:DB4E CD 0A E4                 call    HW_Init
31ac 31ac s 	;...
31ac 31ac s 	;RAM:E40A          HW_Init:                                
31ac 31ac s 	;RAM:E40A                                                  
31ac 31ac s 	;RAM:E40A F3                       di
31ac 31ac s 	;RAM:E40B 11 D1 E3                 ld      de, IntstINTAB
31ac 31ac s 	;RAM:E40E 21 C6 F7                 ld      hl, _xVTRAP
31ac 31ac s 	;RAM:E411 01 3A 00                 ld      bc, 58
31ac 31ac s 	;RAM:E414 CD 3A E0                 call    _LDIR
31ac 31ac s 	;...
31ac 31ac s 	;RAM:E495 3E FF                    ld      a, 0FFh
31ac 31ac s 	;RAM:E497 32 31 F7                 ld      (SndFlag), a    ; flag key click (0 - no click)
31ac 31ac s 	;RAM:E49A 3E 02                    ld      a, 2
31ac 31ac s 	;RAM:E49C 32 2E F7                 ld      (F_Alft), a     ; 0 - russian
31ac 31ac s 	;RAM:E49F 3E 49                    ld      a, 49h ; 'I'
31ac 31ac s 	;RAM:E4A1 32 32 FB                 ld      (_1C_PPI2C_), a
31ac 31ac s 	;RAM:E4A4 C9                       ret
31ac 31ac s 	dbpatch	0xE49F+1	,0x49	,0xc9
31ac 31ac d 52
31ac 31ac s 	db 	pB_CHK_PATCH
31ad 31ad d a0e4
31ad 31ad s 	dw 	0xE49F+1
31af 31af d 49c9
31af 31af s 	db 	0x49,0xc9
31b1 31b1 s 	endm
31b1 31b1 s 
31b1 31b1 s 	;DRVREG_x---------------------------------------------------------------
31b1 31b1 s 	;DRVREG_A,DRVREG_B,DRVREG_C,DRVREG_D
31b1 31b1 s 	;драйверу дисковода необходимо знать какой логичесской букве соответствует какой диск
31b1 31b1 s 	;для этой цели мы используем байт который в оригинальном CP/M BIOS указывает
31b1 31b1 s 	;какое значение надо записать в DRVREG чтобы выбрать данный диск
31b1 31b1 s 	;это даёт возможность использовать и эмулятор и настоящие диски.
31b1 31b1 s 	;в нашем биосе если этот байт =0 то этот диск работает через EXTROM API
31b1 31b1 s 	;если же там не 0 то это физичесский диск.
31b1 31b1 s 	;эти значения также использует утилита MOUNT которая позволяет изменить это соответсвие
31b1 31b1 s 	;и подключить нужный образ диска к нужному дисководу.
31b1 31b1 s 	;по умолчанию 
31b1 31b1 s 	;при наличии дисковода
31b1 31b1 s 	;A: -> эмулятор образ disk/DISKA.KDI
31b1 31b1 s 	;B: -> эмулятор образ disk/DISKB.KDI
31b1 31b1 s 	;C: -> физичесский дисковод A:
31b1 31b1 s 	;D: -> физичесский дисковод B:
31b1 31b1 s 	;или при отсутствии дисковода
31b1 31b1 s 	;A: -> эмулятор образ disk/DISKA.KDI
31b1 31b1 s 	;B: -> эмулятор образ disk/DISKB.KDI
31b1 31b1 s 	;C: -> эмулятор образ disk/DISKC.KDI
31b1 31b1 s 	;D: -> эмулятор образ disk/DISKD.KDI
31b1 31b1 s 
31b1 31b1 s 	;этот адресс можно найти так (это справедливо для всех известных CP/M биосов)
31b1 31b1 s 	;для каждого диска в биосе есть таблица DPH (Disk Parameter Header)
31b1 31b1 s 	;в этой таблице по смещению +0x0A находится адрес DPB (Disk Parameter Block)
31b1 31b1 s 	;интересующий нас байт находится по адрессу DPH-2
31b1 31b1 s 	;звучит сложно, но на практике всё просто.
31b1 31b1 s 	;найти DPH для всех дисков можно достаточно просто
31b1 31b1 s 	;есть вызов биоса SELDSK (0xDA1B)
31b1 31b1 s 	;иначе он попытается сделает операцию "Выбор диска" для указанного в регистре C диска
31b1 31b1 s 	;а для этого ему надо получить параметры диска для своих целей
31b1 31b1 s 	;а мы этим и воспользуемся
31b1 31b1 s 	;в коде ниже по адрессу 0xDC99
31b1 31b1 s 	;собственно тут нас интересует ссылка на таблицу DPH_TABLE
31b1 31b1 s 	;в которой и есть ссылки на DPH для дисков (0xDCCC)
31b1 31b1 s 	;A-DA33,B-DA43,etc
31b1 31b1 s 	;RAM:DC8D          j_SELDSK:                               
31b1 31b1 s 	;RAM:DC8D 79                       ld      a, c
31b1 31b1 s 	;RAM:DC8E FE FF                    cp      0FFh
31b1 31b1 s 	;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
31b1 31b1 s 	;RAM:DC93 C8                       ret     z
31b1 31b1 s 	;RAM:DC94 FE 08                    cp      8
31b1 31b1 s 	;RAM:DC96 D2 C4 DC                 jp      nc, loc_DCC4
31b1 31b1 s 	;RAM:DC99 21 CC DC                 ld      hl, DPH_TABLE
31b1 31b1 s 	;RAM:DC9C 32 64 E0                 ld      (_DSK), a
31b1 31b1 s 	;....
31b1 31b1 s 	;RAM:DCCC 33 DA    DPH_TABLE:      dw dph_a                ; DATA XREF: j_SELDSK+Co
31b1 31b1 s 	;RAM:DCCE 43 DA                    dw dph_b
31b1 31b1 s 	;RAM:DCD0 53 DA                    dw dph_c
31b1 31b1 s 	;RAM:DCD2 63 DA                    dw dph_d
31b1 31b1 s 	;RAM:DCD4 73 DA                    dw dph_e
31b1 31b1 s 	;RAM:DCD6 00 00                    dw loc_0
31b1 31b1 s 	;RAM:DCD8 00 00                    dw loc_0
31b1 31b1 s 	;RAM:DCDA 00 00                    dw loc_0
31b1 31b1 s 	;...
31b1 31b1 s 
31b1 31b1 s 	;DPH             struc ; (sizeof=0x10)
31b1 31b1 s 	;_XLT:           dw ?
31b1 31b1 s 	;_1:             dw ?
31b1 31b1 s 	;_2:             dw ?
31b1 31b1 s 	;_3:             dw ?
31b1 31b1 s 	;DirBuf:         dw ?                    ; offset (00000000)
31b1 31b1 s 	;DPB:            dw ?                    ; offset (00000000)
31b1 31b1 s 	;CSV:            dw ?                    ; offset (00000000)
31b1 31b1 s 	;ALV:            dw ?                    ; offset (00000000)
31b1 31b1 s 	;DPH             ends
31b1 31b1 s 
31b1 31b1 s 	;RAM:DA33 00 00 03+dph_a:          DPH <0, 3, 0, 0, dirBUF, dpbA, csvA, alwA>
31b1 31b1 s 	;RAM:DA43 00 00 00+dph_b:          DPH <0, 0, 0, 0, dirBUF, dpbB, csvB, alwB>
31b1 31b1 s 	;RAM:DA53 00 00 00+dph_c:          DPH <0, 0, 0, 0, dirBUF, dpbC, csvC, alwC>
31b1 31b1 s 	;RAM:DA63 00 00 00+dph_d:          DPH <0, 0, 0, 0, dirBUF, dpbD, csvD, alwD>
31b1 31b1 s 	;RAM:DA73 00 00 00+dph_e:          DPH <0, 0, 0, 0, dirBUF, dpbE, loc_0, alwE>
31b1 31b1 s 	;RAM:DA83 50                       db  50h ; P
31b1 31b1 s 	;RAM:DA84 80                       db  80h ; Ç
31b1 31b1 s 	;RAM:DA85 05                       db    5
31b1 31b1 s 	;RAM:DA86 01                       db    1
31b1 31b1 s 	;RAM:DA87 03                       db    3
31b1 31b1 s 	;RAM:DA88 01                       db    1
31b1 31b1 s 	;RAM:DA89 01       unk_DA89:       db    1                 
31b1 31b1 s 	;RAM:DA8A FF       			       db 0FFh                 
31b1 31b1 s 	;RAM:DA8B 28 00 04+dpbA:           DPB <28h, 4, 0Fh, 0, 18Ah, 7Fh, 0C0h, 0, 20h, 2>
31b1 31b1 s 	;
31b1 31b1 s 	;собственно по адрессу DPB_A-2 и находится интересующая нас ячейка для диска A
31b1 31b1 s 	;для остальных дисков - аналогично
31b1 31b1 s 	;для физичесского дисковода A там значение 1
31b1 31b1 s 	;для физичесского дисковода B там значение 2
31b1 31b1 s 	;для физичесского дисковода C там значение 4
31b1 31b1 s 	;для физичесского дисковода D там значение 8
31b1 31b1 s 	;0 будет означать эмуляцию
31b1 31b1 s 
31b1 31b1 s 	dbpatch	0xDA89 	,0x01	,0x00
31b1 31b1 d 52
31b1 31b1 s 	db 	pB_CHK_PATCH
31b2 31b2 d 89da
31b2 31b2 s 	dw 	0xDA89
31b4 31b4 d 0100
31b4 31b4 s 	db 	0x01,0x00
31b6 31b6 s 	endm
31b6 31b6 s 	dbpatch	0xDAA0 	,0x02	,0x00
31b6 31b6 d 52
31b6 31b6 s 	db 	pB_CHK_PATCH
31b7 31b7 d a0da
31b7 31b7 s 	dw 	0xDAA0
31b9 31b9 d 0200
31b9 31b9 s 	db 	0x02,0x00
31bb 31bb s 	endm
31bb 31bb s 	dbpatch	0xDAB7 	,0x04	,0x01
31bb 31bb d 52
31bb 31bb s 	db 	pB_CHK_PATCH
31bc 31bc d b7da
31bc 31bc s 	dw 	0xDAB7
31be 31be d 0401
31be 31be s 	db 	0x04,0x01
31c0 31c0 s 	endm
31c0 31c0 s 	dbpatch	0xDACE 	,0x08	,0x02
31c0 31c0 d 52
31c0 31c0 s 	db 	pB_CHK_PATCH
31c1 31c1 d ceda
31c1 31c1 s 	dw 	0xDACE
31c3 31c3 d 0802
31c3 31c3 s 	db 	0x08,0x02
31c5 31c5 s 	endm
31c5 31c5 s 
31c5 31c5 s 	;для нормальной работы MOUNT в биос добавлена новая подфункция - получить таблицу
31c5 31c5 s 	;адресов DRVREGxx
31c5 31c5 s 	;call SELDSK с C=0xFE, которая возвращает указатель на таблицу с адресами DRVTRG_X
31c5 31c5 s 	;собтвенно готовим эту таблицу используя уже исзвестные нам данные
31c5 31c5 s 	;сохраняя адреса в таблицу внутри кода "резедента".
31c5 31c5 s 
31c5 31c5 s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
31c5 31c5 d 54
31c5 31c5 s 	db 	pW_STORE
31c6 31c6 d 89da
31c6 31c6 s 	dw 	0xDA89
31c8 31c8 d ace8
31c8 31c8 s 	dw 	_CPM1_res_DRIVE_TAB+0*2
31ca 31ca s 	endm
31ca 31ca s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
31ca 31ca d 54
31ca 31ca s 	db 	pW_STORE
31cb 31cb d a0da
31cb 31cb s 	dw 	0xDAA0
31cd 31cd d aee8
31cd 31cd s 	dw 	_CPM1_res_DRIVE_TAB+1*2
31cf 31cf s 	endm
31cf 31cf s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
31cf 31cf d 54
31cf 31cf s 	db 	pW_STORE
31d0 31d0 d b7da
31d0 31d0 s 	dw 	0xDAB7
31d2 31d2 d b0e8
31d2 31d2 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
31d4 31d4 s 	endm
31d4 31d4 s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
31d4 31d4 d 54
31d4 31d4 s 	db 	pW_STORE
31d5 31d5 d ceda
31d5 31d5 s 	dw 	0xDACE
31d7 31d7 d b2e8
31d7 31d7 s 	dw 	_CPM1_res_DRIVE_TAB+3*2
31d9 31d9 s 	endm
31d9 31d9 s 
31d9 31d9 s 
31d9 31d9 s 	;DPH_TABLE-----------------------------------------------------
31d9 31d9 s 	;добавляем поддержку диска F - образа с утилитами
31d9 31d9 s 	;как найти DPH_TABLE см выше
31d9 31d9 s 	dwpatch 0xDCCC+5*2 	,0x0000 ,_CPM1_dph_F
31d9 31d9 d 51
31d9 31d9 s 	db 	pW_CHK_PATCH
31da 31da d d6dc
31da 31da s 	dw 	0xDCCC+5*2
31dc 31dc d 0000b8e8
31dc 31dc s 	dw 	0x0000,_CPM1_dph_F
31e0 31e0 s 	endm
31e0 31e0 s 
31e0 31e0 s 	dwstore _CPM1_dph_F+8	,0xEBA6
31e0 31e0 d 54
31e0 31e0 s 	db 	pW_STORE
31e1 31e1 d a6eb
31e1 31e1 s 	dw 	0xEBA6
31e3 31e3 d c0e8
31e3 31e3 s 	dw 	_CPM1_dph_F+8
31e5 31e5 s 	endm
31e5 31e5 s 
31e5 31e5 s 	;SELDSK_ADDR------------------------------------------------------------
31e5 31e5 s 	;и модифицируем вызов SELDSK чтобы он поддерживал дополнительную проверку
31e5 31e5 s 	;модифицируем оригинальный перехо в SELDSK чтобы он переходил на наш код	
31e5 31e5 s 	;и сохраняем старый адресс (в данном коде нужный нам адресс 0xDCB6)
31e5 31e5 s 	;RAM:DA1B          _SELDSK:                         ; IN: C
31e5 31e5 s 	;RAM:DA1B C3 B6 DC          jp      __SELDSK        ; OUT: HL-DPB/0, HL=xVTRAP0 if c=0xff
31e5 31e5 s 
31e5 31e5 s 	dwpatch 0xDA1B+1 	,0xDC8D	,_CPM1_res_seldsk
31e5 31e5 d 51
31e5 31e5 s 	db 	pW_CHK_PATCH
31e6 31e6 d 1cda
31e6 31e6 s 	dw 	0xDA1B+1
31e8 31e8 d 8ddc11e9
31e8 31e8 s 	dw 	0xDC8D,_CPM1_res_seldsk
31ec 31ec s 	endm
31ec 31ec s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC8D
31ec 31ec d 54
31ec 31ec s 	db 	pW_STORE
31ed 31ed d 8ddc
31ed 31ed s 	dw 	0xDC8D
31ef 31ef d 15e9
31ef 31ef s 	dw 	_CPM1_old_seld_dsk+1
31f1 31f1 s 	endm
31f1 31f1 s 
31f1 31f1 s 	;SELDSK_STORE_DRV-------------------------------------------------------
31f1 31f1 s 	;в процессе работы SELDSK биос вызывает функцию GETINFO которая читает параметры диска
31f1 31f1 s 	;из первого сектора.
31f1 31f1 s 	;в процессе рабты она перезаписывает значение байта DRVREG_x
31f1 31f1 s 	;затрём эту комманду 
31f1 31f1 s 	;в примере ниже E70A 77 ld (hl), a - записав NOP на ее место.
31f1 31f1 s 
31f1 31f1 s 	;RAM:DC8D          j_SELDSK:                               
31f1 31f1 s 	;RAM:DC8D                                                  
31f1 31f1 s 	;RAM:DC8D 79                       ld      a, c
31f1 31f1 s 	;RAM:DC8E FE FF                    cp      0FFh
31f1 31f1 s 	;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
31f1 31f1 s 	;RAM:DC93 C8                       ret     z
31f1 31f1 s 	;...
31f1 31f1 s 	;RAM:DCBB 22 6E E0                 ld      (off_E06E), hl
31f1 31f1 s 	;RAM:DCBE 3C                       inc     a
31f1 31f1 s 	;RAM:DCBF C4 48 E6                 call    nz, GETINFO
31f1 31f1 s 	;RAM:DCC2 E1                       pop     hl
31f1 31f1 s 	;RAM:DCC3 C8                       ret     z
31f1 31f1 s 	;...
31f1 31f1 s 	;RAM:E648          GETINFO:                                
31f1 31f1 s 	;RAM:E648 E5                       push    hl
31f1 31f1 s 	;RAM:E649 CD 4E DF                 call    sub_DF4E
31f1 31f1 s 	;RAM:E64C E1                       pop     hl
31f1 31f1 s 	;...
31f1 31f1 s 	;RAM:E703          loc_E703:                               
31f1 31f1 s 	;RAM:E703 E1                       pop     hl
31f1 31f1 s 	;RAM:E704 E5                       push    hl
31f1 31f1 s 	;RAM:E705 3A 39 FB                 ld      a, (_1C_PPI1B_DrvReg)
31f1 31f1 s 	;RAM:E708 E6 CF                    and     ~_SIDE1|_MOTOR
31f1 31f1 s 	;RAM:E70A 77                       ld      (hl), a
31f1 31f1 s 	;RAM:E70B 23                       inc     hl
31f1 31f1 s 	;RAM:E70C 36 FF                    ld      (hl), 0FFh
31f1 31f1 s 	;RAM:E70E 23                       inc     hl
31f1 31f1 s 
31f1 31f1 s 	dbpatch	0xE70A	,0x77	,0x00
31f1 31f1 d 52
31f1 31f1 s 	db 	pB_CHK_PATCH
31f2 31f2 d 0ae7
31f2 31f2 s 	dw 	0xE70A
31f4 31f4 d 7700
31f4 31f4 s 	db 	0x77,0x00
31f6 31f6 s 	endm
31f6 31f6 s 
31f6 31f6 s 	;CURRENT_DISK_PTR-------------------------------------------------------
31f6 31f6 s 	;нашему резиденту для операций чтения и записи нужно знать к какому диску идёт обращение
31f6 31f6 s 	;и надо ли подменять обращение к эмулятору
31f6 31f6 s 	;у биоса есть переменная которая указывает на DRVREG_x для текушего диска
31f6 31f6 s 	;резидент читает из этого адресса и смотрит надо ли эмулировать диск
31f6 31f6 s 	;собственно в коде ниже по адрессу 0xDCBB комманда которая сохраняет в нужную нам переменную
31f6 31f6 s 	;ld      (off_E06E), hl
31f6 31f6 s 	;т.е. нужный нам адресс 0xE06E
31f6 31f6 s 
31f6 31f6 s 	;RAM:DC8D          j_SELDSK:                               
31f6 31f6 s 	;RAM:DC8D                                                  
31f6 31f6 s 	;RAM:DC8D 79                       ld      a, c
31f6 31f6 s 	;RAM:DC8E FE FF                    cp      0FFh
31f6 31f6 s 	;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
31f6 31f6 s 	;RAM:DC93 C8                       ret     z
31f6 31f6 s 	;...
31f6 31f6 s 	;RAM:DCBB 22 6E E0                 ld      (off_E06E), hl
31f6 31f6 s 	;RAM:DCBE 3C                       inc     a
31f6 31f6 s 	;RAM:DCBF C4 48 E6                 call    nz, GETINFO
31f6 31f6 s 
31f6 31f6 s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE06E
31f6 31f6 d 54
31f6 31f6 s 	db 	pW_STORE
31f7 31f7 d 6ee0
31f7 31f7 s 	dw 	0xE06E
31f9 31f9 d 2ee9
31f9 31f9 s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
31fb 31fb s 	endm
31fb 31fb s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE06E
31fb 31fb d 54
31fb 31fb s 	db 	pW_STORE
31fc 31fc d 6ee0
31fc 31fc s 	dw 	0xE06E
31fe 31fe d 6be9
31fe 31fe s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
3200 3200 s 	endm
3200 3200 s 
3200 3200 s 
3200 3200 s 	;CURRENT_DISK_PTR-------------------------------------------------------
3200 3200 s 	;патчим адресса в основной таблицк BIOS для READ и WRITE
3200 3200 s 	;теперь они указывают на наш "резидент"
3200 3200 s 
3200 3200 s 	;RAM:DA27          _READ:                                  
3200 3200 s 	;RAM:DA27 C3 EB DC                 jp      j_READ
3200 3200 s 	;RAM:DA2A          _WRITE:                                 
3200 3200 s 	;RAM:DA2A C3 AF DE                 jp      j_WRITE
3200 3200 s 
3200 3200 s 	dwpatch	0xDA27+1	,0xDCEB	,_CPM1_res_READ
3200 3200 d 51
3200 3200 s 	db 	pW_CHK_PATCH
3201 3201 d 28da
3201 3201 s 	dw 	0xDA27+1
3203 3203 d ebdc1be9
3203 3203 s 	dw 	0xDCEB,_CPM1_res_READ
3207 3207 s 	endm
3207 3207 s 	dwpatch	0xDA2A+1	,0xDEAF	,_CPM1_res_WRITE
3207 3207 d 51
3207 3207 s 	db 	pW_CHK_PATCH
3208 3208 d 2bda
3208 3208 s 	dw 	0xDA2A+1
320a 320a d afde58e9
320a 320a s 	dw 	0xDEAF,_CPM1_res_WRITE
320e 320e s 	endm
320e 320e s 
320e 320e s 	;WBOOT_READ_CALL--------------------------------------------------------
320e 320e s 	;биосовоский wboot напрямую делает вызов READ
320e 320e s 	;патчим его тоже
320e 320e s 	;RAM:DB5E          j_WBOOT:                                
320e 320e s 	;RAM:DB5E                                                  
320e 320e s 	;RAM:DB5E F3                       di
320e 320e s 	;RAM:DB5F 31 80 00                 ld      sp, 80h ; 'Ç'
320e 320e s 	;RAM:DB62 CD 0A E4                 call    HW_Init
320e 320e s 	;...
320e 320e s 	;RAM:DB80 C5                       push    bc
320e 320e s 	;RAM:DB81 CD E5 DC                 call    j_SETDMA
320e 320e s 	;RAM:DB84 CD EB DC                 call    j_READ
320e 320e s 	;RAM:DB87 B7                       or      a
320e 320e s 	;RAM:DB88 C2 5E DB                 jp      nz, j_WBOOT
320e 320e s 
320e 320e s 	dwpatch	0xDB84+1	,0xDCEB	,_CPM1_res_READ
320e 320e d 51
320e 320e s 	db 	pW_CHK_PATCH
320f 320f d 85db
320f 320f s 	dw 	0xDB84+1
3211 3211 d ebdc1be9
3211 3211 s 	dw 	0xDCEB,_CPM1_res_READ
3215 3215 s 	endm
3215 3215 s 
3215 3215 s 	;SELDSK_GETINFO_CALL------------------------------------------------------------------------
3215 3215 s 	;внутри  SELDSK есть вызов GETINFO
3215 3215 s 	;используется для чтения параметров диска с нового диска
3215 3215 s 	;мы его перехватываем, и для дисково которые работают через EXTROM API
3215 3215 s 	;делаем сами его функции (частично)
3215 3215 s 	;для физичесских дисков работает оригинальный код
3215 3215 s 	;причина в том, что GETINFO обращается к диску напрямую, а нас это не устраивает
3215 3215 s 	;в примере ниже это адресс DCBF
3215 3215 s 
3215 3215 s 	;RAM:DC8D          j_SELDSK:                               
3215 3215 s 	;RAM:DC8D                                                  
3215 3215 s 	;RAM:DC8D 79                       ld      a, c
3215 3215 s 	;RAM:DC8E FE FF                    cp      0FFh
3215 3215 s 	;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
3215 3215 s 	;RAM:DC93 C8                       ret     z
3215 3215 s 	;...
3215 3215 s 	;RAM:DCBB 22 6E E0                 ld      (off_E06E), hl
3215 3215 s 	;RAM:DCBE 3C                       inc     a
3215 3215 s 	;RAM:DCBF C4 48 E6                 call    nz, GETINFO
3215 3215 s 	;RAM:DCC2 E1                       pop     hl
3215 3215 s 	;RAM:DCC3 C8                       ret     z
3215 3215 s 
3215 3215 s 	dwpatch	0xdcbf+1	,0xE648	,_CPM1_res_GETINFO
3215 3215 d 51
3215 3215 s 	db 	pW_CHK_PATCH
3216 3216 d c0dc
3216 3216 s 	dw 	0xdcbf+1
3218 3218 d 48e695e9
3218 3218 s 	dw 	0xE648,_CPM1_res_GETINFO
321c 321c s 	endm
321c 321c s 
321c 321c s 	;BIOS_xxxx--------------------------------------------------------------
321c 321c s 	;сохраняем в "резидет" адреса оригинальных функций
321c 321c s 	;они вызываются если идёт обращение к физичесским дискам
321c 321c s 
321c 321c s 	dwstore	_CPM1__old_read+1	,0xDCEB
321c 321c d 54
321c 321c s 	db 	pW_STORE
321d 321d d ebdc
321d 321d s 	dw 	0xDCEB
321f 321f d 56e9
321f 321f s 	dw 	_CPM1__old_read+1
3221 3221 s 	endm
3221 3221 s 	dwstore	_CPM1__old_write+1	,0xDEAF
3221 3221 d 54
3221 3221 s 	db 	pW_STORE
3222 3222 d afde
3222 3222 s 	dw 	0xDEAF
3224 3224 d 93e9
3224 3224 s 	dw 	_CPM1__old_write+1
3226 3226 s 	endm
3226 3226 s 	dwstore	_CPM1__old_getinfo+1	,0xE648
3226 3226 d 54
3226 3226 s 	db 	pW_STORE
3227 3227 d 48e6
3227 3227 s 	dw 	0xE648
3229 3229 d a3e9
3229 3229 s 	dw 	_CPM1__old_getinfo+1
322b 322b s 	endm
322b 322b s 
322b 322b s 	;-------------------------------------------------------------------------------
322b 322b s 	;наш эмулятор GETINFO производит чтение первого сектора из образа диска
322b 322b s 	;в буфер чтения, остальную работу делает сатарый код
322b 322b s 	;т.е. мы читаем сектор в буффер и передаём управление на код который
322b 322b s 	;проверяет результат успешности чтения, проверяе контролльную сумму сектора 
322b 322b s 	;и готовит сектор к дальнейшей работе
322b 322b s 	;в коде ниже это 0xE67F 
322b 322b s 
322b 322b s 	;RAM:E648          GETINFO:                                ; CODE XREF: j_SELDSK+32p
322b 322b s 	;RAM:E648 E5                       push    hl
322b 322b s 	;RAM:E649 CD 4E DF                 call    sub_DF4E
322b 322b s 	;RAM:E64C E1                       pop     hl
322b 322b s 	;RAM:E64D 22 6E E0                 ld      (off_E06E), hl
322b 322b s 	;RAM:E650 E5                       push    hl
322b 322b s 	;RAM:E651 7E                       ld      a, (hl)
322b 322b s 	;RAM:E652 E6 0F                    and     0Fh
322b 322b s 	;RAM:E654 32 70 E0                 ld      (byte_E070), a
322b 322b s 	;RAM:E657 AF                       xor     a
322b 322b s 	;RAM:E658 32 71 E0                 ld      (byte_E071), a
322b 322b s 	;RAM:E65B 3C                       inc     a
322b 322b s 	;RAM:E65C 32 72 E0                 ld      (byte_E072), a
322b 322b s 	;RAM:E65F 21 6E E0                 ld      hl, off_E06E
322b 322b s 	;RAM:E662 CD D3 DF                 call    sub_DFD3
322b 322b s 	;RAM:E665 21 00 EE                 ld      hl, RD_BUF
322b 322b s 	;RAM:E668 CD 9A E7                 call    DTOM
322b 322b s 	;RAM:E66B CA 85 E6                 jp      z, CHKDO
322b 322b s 	;RAM:E66E 3A 39 FB                 ld      a, (_1C_PPI1B_DrvReg)
322b 322b s 	;RAM:E671 C6 40                    add     a, 40h ; '@'
322b 322b s 	;RAM:E673 32 39 FB                 ld      (_1C_PPI1B_DrvReg), a
322b 322b s 	;RAM:E676 CD 79 E8                 call    FDD_BREAK
322b 322b s 	;RAM:E679 21 00 EE                 ld      hl, RD_BUF
322b 322b s 	;RAM:E67C CD 9A E7                 call    DTOM
322b 322b s 	;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
322b 322b s 	;RAM:E67F 21 AF E6                 ld      hl, msgDiskNotRead 
322b 322b s 	;RAM:E682 C2 A7 E6                 jp      nz, loc_E6A7
322b 322b s 	;RAM:E685
322b 322b s 
322b 322b s 	;для надёжности проверим что по этому аддреск находтся то что ожидаем 
322b 322b s 
322b 322b s 	dbpatch	0xE67F		,0x21	,0x21
322b 322b d 52
322b 322b s 	db 	pB_CHK_PATCH
322c 322c d 7fe6
322c 322c s 	dw 	0xE67F
322e 322e d 2121
322e 322e s 	db 	0x21,0x21
3230 3230 s 	endm
3230 3230 s 	dwpatch	0xE67F+1 	,0xE6AF	,0xE6AF
3230 3230 d 51
3230 3230 s 	db 	pW_CHK_PATCH
3231 3231 d 80e6
3231 3231 s 	dw 	0xE67F+1
3233 3233 d afe6afe6
3233 3233 s 	dw 	0xE6AF,0xE6AF
3237 3237 s 	endm
3237 3237 s 
3237 3237 s 	;и устанавливаем в наш "резидент" переход на эту точку.
3237 3237 s 	
3237 3237 s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE67F
3237 3237 d 54
3237 3237 s 	db 	pW_STORE
3238 3238 d 7fe6
3238 3238 s 	dw 	0xE67F
323a 323a d a0e9
323a 323a s 	dw 	_CPM1__old_getinfo_chkdo+1
323c 323c s 	endm
323c 323c s 
323c 323c s 	;BIOS_VAR_xxx-----------------------------------------------------------------------
323c 323c s 	;BIOS_VAR_DSK,BIOS_VAR_TRK,BIOS_VAR_SEC,BIOS_VAR_DMA
323c 323c s 	;системные переменные BIOS которые необходимы "эмулятору" для работы 
323c 323c s 	;функций READ/WRITE, т.к. их параметры предварительно записываются именно в
323c 323c s 	;эти переменные 
323c 323c s 	;сохраняем в эмулятор значения характерные именно для текущего биоса
323c 323c s 	;
323c 323c s 	;найти их совсем просто
323c 323c s 	;
323c 323c s 	;в стандартном CPM BIOS есть набор соответсвующих вызовов
323c 323c s 	;TRK -> 0xE068 (инструкция по адрессу DC89)
323c 323c s 	;SEC -> 0xE069 (инструкция по адрессу DCDD)
323c 323c s 	;DMA -> 0xE06A (инструкция по адрессу DCE7)
323c 323c s 
323c 323c s 	;RAM:DA1E          _SELTRK:                                
323c 323c s 	;RAM:DA1E C3 88 DC                 jp      j_SELTRK
323c 323c s 	;RAM:DA21          _SETSEC:                                
323c 323c s 	;RAM:DA21 C3 DC DC                 jp      j_SETSEC
323c 323c s 	;RAM:DA24          _SETDMA:
323c 323c s 	;RAM:DA24 C3 E5 DC                 jp      j_SETDMA
323c 323c s 	;
323c 323c s 	;RAM:DC88          j_SELTRK:                               
323c 323c s 	;RAM:DC88                                                  
323c 323c s 	;RAM:DC88 79                       ld      a, c
323c 323c s 	;RAM:DC89 32 68 E0                 ld      (_TRK), a
323c 323c s 	;RAM:DC8C C9                       ret
323c 323c s 	;...
323c 323c s 	;RAM:DCDC          j_SETSEC:                               
323c 323c s 	;RAM:DCDC                                                  
323c 323c s 	;RAM:DCDC 79                       ld      a, c
323c 323c s 	;RAM:DCDD 32 69 E0                 ld      (_SEC), a
323c 323c s 	;RAM:DCE0 C9                       ret
323c 323c s 	;...
323c 323c s 	;RAM:DCE5          j_SETDMA:                               
323c 323c s 	;RAM:DCE5                                                  
323c 323c s 	;RAM:DCE5 69                       ld      l, c
323c 323c s 	;RAM:DCE6 60                       ld      h, b
323c 323c s 	;RAM:DCE7 22 6A E0                 ld      (_DMA), hl
323c 323c s 	;RAM:DCEA C9                       ret
323c 323c s 
323c 323c s 	;а с DSK - тоже, многострадальный код SELDSK
323c 323c s 	;тут нужная нам число 0xE064 в инструкции по адрессу 0xDC9C
323c 323c s 
323c 323c s 	;RAM:DC8D          j_SELDSK:                               
323c 323c s 	;RAM:DC8D 79                       ld      a, c
323c 323c s 	;RAM:DC8E FE FF                    cp      0FFh
323c 323c s 	;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
323c 323c s 	;RAM:DC93 C8                       ret     z
323c 323c s 	;RAM:DC94 FE 08                    cp      8
323c 323c s 	;RAM:DC96 D2 C4 DC                 jp      nc, loc_DCC4
323c 323c s 	;RAM:DC99 21 CC DC                 ld      hl, DPH_TABLE
323c 323c s 	;RAM:DC9C 32 64 E0                 ld      (_DSK), a
323c 323c s 
323c 323c s 	dwstore	_CPM1_r_p_DSK1+1	,0xE064 	;read
323c 323c d 54
323c 323c s 	db 	pW_STORE
323d 323d d 64e0
323d 323d s 	dw 	0xE064
323f 323f d 1ce9
323f 323f s 	dw 	_CPM1_r_p_DSK1+1
3241 3241 s 	endm
3241 3241 s 	dwstore	_CPM1_r_p_TRK1+1	,0xE068 	
3241 3241 d 54
3241 3241 s 	db 	pW_STORE
3242 3242 d 68e0
3242 3242 s 	dw 	0xE068
3244 3244 d 37e9
3244 3244 s 	dw 	_CPM1_r_p_TRK1+1
3246 3246 s 	endm
3246 3246 s 	dwstore	_CPM1_r_p_SEC1+1	,0xE069 	
3246 3246 d 54
3246 3246 s 	db 	pW_STORE
3247 3247 d 69e0
3247 3247 s 	dw 	0xE069
3249 3249 d 3de9
3249 3249 s 	dw 	_CPM1_r_p_SEC1+1
324b 324b s 	endm
324b 324b s 	dwstore	_CPM1_r_p_DMA1+1	,0xE06A 	
324b 324b d 54
324b 324b s 	db 	pW_STORE
324c 324c d 6ae0
324c 324c s 	dw 	0xE06A
324e 324e d 4ee9
324e 324e s 	dw 	_CPM1_r_p_DMA1+1
3250 3250 s 	endm
3250 3250 s 
3250 3250 s 	dwstore	_CPM1_r_p_DSK2+1	,0xE064 	;write
3250 3250 d 54
3250 3250 s 	db 	pW_STORE
3251 3251 d 64e0
3251 3251 s 	dw 	0xE064
3253 3253 d 59e9
3253 3253 s 	dw 	_CPM1_r_p_DSK2+1
3255 3255 s 	endm
3255 3255 s 	dwstore	_CPM1_r_p_TRK2+1	,0xE068 	
3255 3255 d 54
3255 3255 s 	db 	pW_STORE
3256 3256 d 68e0
3256 3256 s 	dw 	0xE068
3258 3258 d 74e9
3258 3258 s 	dw 	_CPM1_r_p_TRK2+1
325a 325a s 	endm
325a 325a s 	dwstore	_CPM1_r_p_SEC2+1	,0xE069 	
325a 325a d 54
325a 325a s 	db 	pW_STORE
325b 325b d 69e0
325b 325b s 	dw 	0xE069
325d 325d d 7ae9
325d 325d s 	dw 	_CPM1_r_p_SEC2+1
325f 325f s 	endm
325f 325f s 	dwstore	_CPM1_r_p_DMA2+1	,0xE06A 	
325f 325f d 54
325f 325f s 	db 	pW_STORE
3260 3260 d 6ae0
3260 3260 s 	dw 	0xE06A
3262 3262 d 8be9
3262 3262 s 	dw 	_CPM1_r_p_DMA2+1
3264 3264 s 	endm
3264 3264 s 
3264 3264 s 	dwstore	_CPM1_r_p_DSK3+1	,0xE064 	;readinfo
3264 3264 d 54
3264 3264 s 	db 	pW_STORE
3265 3265 d 64e0
3265 3265 s 	dw 	0xE064
3267 3267 d 28ea
3267 3267 s 	dw 	_CPM1_r_p_DSK3+1
3269 3269 s 	endm
3269 3269 s 
3269 3269 s 
3269 3269 s 	;KEY_HOOK:---------------------------------------------------------------------------
3269 3269 s 	;VINTKBDADDR,VINTKBDVALUE,KBD_HOOK_PROC
3269 3269 s 	;перехватываем нажатие комбинации клавиш CTRL+SHIFT+STOP
3269 3269 s 	;планируется что по нажатии этой комбинации - содержимое диска E
3269 3269 s 	;будет перезаписано содержимым на котором записан - 
3269 3269 s 	;MOUNT и другие служебные утилиты для работы с EXTROM API 
3269 3269 s 	;к сожадлению нет общего для всех кода
3269 3269 s 	;точнее самые старые биосы - требуют "особых" отношений
3269 3269 s 	;там немного по другому драйвер клавиатуры возвращает коды.
3269 3269 s 	;
3269 3269 s 	;kbd_hook_noCtrl_03 - '12_87_09_NIIJAF'	и производных от него '1x_88_EPSON_V104','1x_89_03_30_RAVI'
3269 3269 s 	;kbd_hook_noCtrl_33 - '12_87_11_niijaf'
3269 3269 s 	;kbd_hook_2133      - все остальные
3269 3269 s 
3269 3269 s 	;по сути, мы подменяем перехватываем обработчик VTRAP8_pseudoKBD
3269 3269 s 	;как найти 
3269 3269 s 
3269 3269 s 	;в HWINIT есть копирование стандартной таблицы векторов VTRAP в рабочее место
3269 3269 s 	;вот ее мы и патчим
3269 3269 s 	;в коде ниже это адрес 0xdc46 и значение 0xdc46
3269 3269 s 
3269 3269 s 	;RAM:DA00          _BOOT:
3269 3269 s 	;RAM:DA00 C3 42 DB                 jp      j_BOOT
3269 3269 s 	;...
3269 3269 s 	;RAM:DB42          j_BOOT:                                 
3269 3269 s 	;RAM:DB42 F3                       di
3269 3269 s 	;RAM:DB43 31 80 00                 ld      sp, 80h ; 'Ç'
3269 3269 s 	;RAM:DB46 3E 1C                    ld      a, 1Ch
3269 3269 s 	;RAM:DB48 32 7F FA                 ld      (_1C_SysReg1C), a
3269 3269 s 	;RAM:DB4B 32 03 F7                 ld      (SysCOPY), a
3269 3269 s 	;RAM:DB4E CD 0A E4                 call    HW_Init
3269 3269 s 	;....
3269 3269 s 	;RAM:E40A          HW_Init:                                
3269 3269 s 	;RAM:E40A                                                  
3269 3269 s 	;RAM:E40A F3                       di
3269 3269 s 	;RAM:E40B 11 D1 E3                 ld      de, IntstINTAB
3269 3269 s 	;RAM:E40E 21 C6 F7                 ld      hl, _xVTRAP
3269 3269 s 	;RAM:E411 01 3A 00                 ld      bc, 58
3269 3269 s 	;RAM:E414 CD 3A E0                 call    _LDIR
3269 3269 s 	;....
3269 3269 s 	;RAM:E3D1 D3 E3    IntstINTAB:     dw off_E3D3             
3269 3269 s 	;RAM:E3D3 0C DC    off_E3D3:       dw _EOI                 
3269 3269 s 	;RAM:E3D3                                                  
3269 3269 s 	;RAM:E3D5 0C DC                    dw _EOI
3269 3269 s 	;RAM:E3D7 0C DC                    dw _EOI
3269 3269 s 	;RAM:E3D9 0C DC                    dw _EOI
3269 3269 s 	;RAM:E3DB 1C DC                    dw VINT_VBL
3269 3269 s 	;RAM:E3DD 0C DC                    dw _EOI
3269 3269 s 	;RAM:E3DF 0C DC                    dw _EOI
3269 3269 s 	;RAM:E3E1 0C DC                    dw _EOI
3269 3269 s 	;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
3269 3269 s 	;RAM:E3E3 46 DC                    dw VINT_KBD
3269 3269 s 	;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
3269 3269 s 	;RAM:E3E5 00 00                    dw 0
3269 3269 s 	;RAM:E3E7 00 00                    dw 0
3269 3269 s 	;RAM:E3E9 00 00                    dw 0
3269 3269 s 	
3269 3269 s 	;support removed
3269 3269 s 	;dwpatch	#_CPM1_VINTKBDADDR#	,#_CPM1_VINTKBDVALUE#	,#_CPM1_KBD_HOOK_PROC#
3269 3269 s 	;dwstore	_CPM1_old_hook+1	,#_CPM1_VINTKBDVALUE#
3269 3269 s 
3269 3269 s 	;custom checkers
3269 3269 s 	dwpatch	0xDCBB+1	,0xE06E ,0xE06E
3269 3269 d 51
3269 3269 s 	db 	pW_CHK_PATCH
326a 326a d bcdc
326a 326a s 	dw 	0xDCBB+1
326c 326c d 6ee06ee0
326c 326c s 	dw 	0xE06E,0xE06E
3270 3270 s 	endm
3270 3270 s 
3270 3270 s 	;STOP-------------------------------------------------------------------------------
3270 3270 s 	stop 'CPM_21_89___wiza'
3270 3270 d 50
3270 3270 s 	db 	p_STOP
3271 3271 d 43504d5f32315f38395f5f5f77697a61
3271 3271 s 	db 	'CPM_21_89___wiza'
3281 3281 d 00
3281 3281 s 	db 	0
3282 3282 s 	endm
3282 3282 f out/include-patcher.asm
3282 3282 s 	include "generator/V0/out/patcher-microdos-MICRODOS_OPTS2_880630.asm"	; 42 images in collection
3282 3282 f generator/V0/out/patcher-microdos-MICRODOS_OPTS2_880630.asm
3282 3282 s _BIOS_MICRODOS_OPTS2_880630:
3282 3282 s 	setMICRODOS
3282 3282 d 56
3282 3282 s 	db 	pSETFLAG_MICRODOS
3283 3283 s 	endm
3283 3283 s 	RQ_OPTS2
3283 3283 d 58
3283 3283 s 	db 	pREQUIRED_OPTS2
3284 3284 s 	endm
3284 3284 s 	dbpatchmaybe	0xBEA3	,0x1B	,0x0d
3284 3284 d 59
3284 3284 s 	db 	pB_MAYBE_PATCH
3285 3285 d a3be
3285 3285 s 	dw 	0xBEA3
3287 3287 d 1b0d
3287 3287 s 	db 	0x1B,0x0d
3289 3289 s 	endm
3289 3289 s 	dbpatchmaybe	0xBEA3+1	,0x45	,0x0d
3289 3289 d 59
3289 3289 s 	db 	pB_MAYBE_PATCH
328a 328a d a4be
328a 328a s 	dw 	0xBEA3+1
328c 328c d 450d
328c 328c s 	db 	0x45,0x0d
328e 328e s 	endm
328e 328e s 	dwpatch	0xEAFD+1	,0xEB34	,MD_READ			
328e 328e d 51
328e 328e s 	db 	pW_CHK_PATCH
328f 328f d feea
328f 328f s 	dw 	0xEAFD+1
3291 3291 d 34eb3efa
3291 3291 s 	dw 	0xEB34,MD_READ
3295 3295 s 	endm
3295 3295 s 	dwpatch	0xEB02+1	,0xEB9E	,MD_WRITE
3295 3295 d 51
3295 3295 s 	db 	pW_CHK_PATCH
3296 3296 d 03eb
3296 3296 s 	dw 	0xEB02+1
3298 3298 d 9eeb53fa
3298 3298 s 	dw 	0xEB9E,MD_WRITE
329c 329c s 	endm
329c 329c s 	dbpatch	0xEC91	,0xcd	,0x00
329c 329c d 52
329c 329c s 	db 	pB_CHK_PATCH
329d 329d d 91ec
329d 329d s 	dw 	0xEC91
329f 329f d cd00
329f 329f s 	db 	0xcd,0x00
32a1 32a1 s 	endm
32a1 32a1 s 	dwpatch	0xEC91+1	,0xee27	,0x0000
32a1 32a1 d 51
32a1 32a1 s 	db 	pW_CHK_PATCH
32a2 32a2 d 92ec
32a2 32a2 s 	dw 	0xEC91+1
32a4 32a4 d 27ee0000
32a4 32a4 s 	dw 	0xee27,0x0000
32a8 32a8 s 	endm
32a8 32a8 s 	dwpatch	0xEC94+1	,0xEE2C	,MD_READ_INFOSECTOR
32a8 32a8 d 51
32a8 32a8 s 	db 	pW_CHK_PATCH
32a9 32a9 d 95ec
32a9 32a9 s 	dw 	0xEC94+1
32ab 32ab d 2cee68fa
32ab 32ab s 	dw 	0xEE2C,MD_READ_INFOSECTOR
32af 32af s 	endm
32af 32af s 	dwstore	MD_DRV2+1,	0xEF23
32af 32af d 54
32af 32af s 	db 	pW_STORE
32b0 32b0 d 23ef
32b0 32b0 s 	dw 	0xEF23
32b2 32b2 d f3fa
32b2 32b2 s 	dw 	MD_DRV2+1
32b4 32b4 s 	endm
32b4 32b4 s 	dwstore	MD_RDBUF2+1,	0xEF2B
32b4 32b4 d 54
32b4 32b4 s 	db 	pW_STORE
32b5 32b5 d 2bef
32b5 32b5 s 	dw 	0xEF2B
32b7 32b7 d 02fb
32b7 32b7 s 	dw 	MD_RDBUF2+1
32b9 32b9 s 	endm
32b9 32b9 s 	dwstore	MD_PARAM2+1,	0xEF16
32b9 32b9 d 54
32b9 32b9 s 	db 	pW_STORE
32ba 32ba d 16ef
32ba 32ba s 	dw 	0xEF16
32bc 32bc d 1dfa
32bc 32bc s 	dw 	MD_PARAM2+1
32be 32be s 	endm
32be 32be s 	dwpatch 0xc01b+1	 ,0xDD88	,md_res_seldsk
32be 32be d 51
32be 32be s 	db 	pW_CHK_PATCH
32bf 32bf d 1cc0
32bf 32bf s 	dw 	0xc01b+1
32c1 32c1 d 88dd0efa
32c1 32c1 s 	dw 	0xDD88,md_res_seldsk
32c5 32c5 s 	endm
32c5 32c5 s 	dwstore md_old_seld_dsk+1,0xDD88	,0xdd4c
32c5 32c5 d 54
32c5 32c5 s 	db 	pW_STORE
32c6 32c6 d 88dd
32c6 32c6 s 	dw 	0xDD88
32c8 32c8 d 12fa
32c8 32c8 s 	dw 	md_old_seld_dsk+1
32ca 32ca s 	endm
32ca 32ca s 	;custom checkers
32ca 32ca s 	dwpatch	0xBD80	,0xBD80 ,0xBD80
32ca 32ca d 51
32ca 32ca s 	db 	pW_CHK_PATCH
32cb 32cb d 80bd
32cb 32cb s 	dw 	0xBD80
32cd 32cd d 80bd80bd
32cd 32cd s 	dw 	0xBD80,0xBD80
32d1 32d1 s 	endm
32d1 32d1 s 	dwpatch	0xBD82	,0xBE00 ,0xBE00
32d1 32d1 d 51
32d1 32d1 s 	db 	pW_CHK_PATCH
32d2 32d2 d 82bd
32d2 32d2 s 	dw 	0xBD82
32d4 32d4 d 00be00be
32d4 32d4 s 	dw 	0xBE00,0xBE00
32d8 32d8 s 	endm
32d8 32d8 s 	dwpatch	0xc000+1	,0xC488 ,0xC488
32d8 32d8 d 51
32d8 32d8 s 	db 	pW_CHK_PATCH
32d9 32d9 d 01c0
32d9 32d9 s 	dw 	0xc000+1
32db 32db d 88c488c4
32db 32db s 	dw 	0xC488,0xC488
32df 32df s 	endm
32df 32df s 	dwpatch	0xc003+1	,0xDBFC ,0xDBFC
32df 32df d 51
32df 32df s 	db 	pW_CHK_PATCH
32e0 32e0 d 04c0
32e0 32e0 s 	dw 	0xc003+1
32e2 32e2 d fcdbfcdb
32e2 32e2 s 	dw 	0xDBFC,0xDBFC
32e6 32e6 s 	endm
32e6 32e6 s 	dbpatch	0xEC4C	,0x21 ,0x21
32e6 32e6 d 52
32e6 32e6 s 	db 	pB_CHK_PATCH
32e7 32e7 d 4cec
32e7 32e7 s 	dw 	0xEC4C
32e9 32e9 d 2121
32e9 32e9 s 	db 	0x21,0x21
32eb 32eb s 	endm
32eb 32eb s 	stop 'MICRODOS_OPTS2_880630'
32eb 32eb d 50
32eb 32eb s 	db 	p_STOP
32ec 32ec d 4d4943524f444f535f4f505453325f383830363330
32ec 32ec s 	db 	'MICRODOS_OPTS2_880630'
3301 3301 d 00
3301 3301 s 	db 	0
3302 3302 s 	endm
3302 3302 f out/include-patcher.asm
3302 3302 s 	include "generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf2.asm"	; 36 images in collection
3302 3302 f generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf2.asm
3302 3302 s _BIOS_CPM_21_89_2_niijaf2:
3302 3302 s 	setSUBBIOS 1
3302 3302 d 5a
3302 3302 s 	db	pSubBios
3303 3303 d 01
3303 3303 s 	db 	1
3304 3304 s 	endm
3304 3304 s 	RQ_OPTS_ANY
3304 3304 s 	endm
3304 3304 s 	setCPM
3304 3304 s 	endm
3304 3304 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
3304 3304 d 59
3304 3304 s 	db 	pB_MAYBE_PATCH
3305 3305 d eeda
3305 3305 s 	dw 	0xDAEE
3307 3307 d 1f0d
3307 3307 s 	db 	0x1F,0x0d
3309 3309 s 	endm
3309 3309 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
3309 3309 d 59
3309 3309 s 	db 	pB_MAYBE_PATCH
330a 330a d f0da
330a 330a s 	dw 	0xDAEE+2
330c 330c d 0a0d
330c 330c s 	db 	0x0a,0x0d
330e 330e s 	endm
330e 330e s 	dbpatch	0xE487+1	,0x49	,0xc9
330e 330e d 52
330e 330e s 	db 	pB_CHK_PATCH
330f 330f d 88e4
330f 330f s 	dw 	0xE487+1
3311 3311 d 49c9
3311 3311 s 	db 	0x49,0xc9
3313 3313 s 	endm
3313 3313 s 	dbpatch	0xDA89 	,0x01	,0x00
3313 3313 d 52
3313 3313 s 	db 	pB_CHK_PATCH
3314 3314 d 89da
3314 3314 s 	dw 	0xDA89
3316 3316 d 0100
3316 3316 s 	db 	0x01,0x00
3318 3318 s 	endm
3318 3318 s 	dbpatch	0xDAA0 	,0x02	,0x00
3318 3318 d 52
3318 3318 s 	db 	pB_CHK_PATCH
3319 3319 d a0da
3319 3319 s 	dw 	0xDAA0
331b 331b d 0200
331b 331b s 	db 	0x02,0x00
331d 331d s 	endm
331d 331d s 	dbpatch	0xDAB7 	,0x04	,0x01
331d 331d d 52
331d 331d s 	db 	pB_CHK_PATCH
331e 331e d b7da
331e 331e s 	dw 	0xDAB7
3320 3320 d 0401
3320 3320 s 	db 	0x04,0x01
3322 3322 s 	endm
3322 3322 s 	dbpatch	0xDACE 	,0x08	,0x02
3322 3322 d 52
3322 3322 s 	db 	pB_CHK_PATCH
3323 3323 d ceda
3323 3323 s 	dw 	0xDACE
3325 3325 d 0802
3325 3325 s 	db 	0x08,0x02
3327 3327 s 	endm
3327 3327 s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
3327 3327 d 54
3327 3327 s 	db 	pW_STORE
3328 3328 d 89da
3328 3328 s 	dw 	0xDA89
332a 332a d ace8
332a 332a s 	dw 	_CPM1_res_DRIVE_TAB+0*2
332c 332c s 	endm
332c 332c s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
332c 332c d 54
332c 332c s 	db 	pW_STORE
332d 332d d a0da
332d 332d s 	dw 	0xDAA0
332f 332f d aee8
332f 332f s 	dw 	_CPM1_res_DRIVE_TAB+1*2
3331 3331 s 	endm
3331 3331 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
3331 3331 d 54
3331 3331 s 	db 	pW_STORE
3332 3332 d b7da
3332 3332 s 	dw 	0xDAB7
3334 3334 d b0e8
3334 3334 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
3336 3336 s 	endm
3336 3336 s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
3336 3336 d 54
3336 3336 s 	db 	pW_STORE
3337 3337 d ceda
3337 3337 s 	dw 	0xDACE
3339 3339 d b2e8
3339 3339 s 	dw 	_CPM1_res_DRIVE_TAB+3*2
333b 333b s 	endm
333b 333b s 	dwpatch 0xDCBB+5*2 	,0x0000 ,_CPM1_dph_F
333b 333b d 51
333b 333b s 	db 	pW_CHK_PATCH
333c 333c d c5dc
333c 333c s 	dw 	0xDCBB+5*2
333e 333e d 0000b8e8
333e 333e s 	dw 	0x0000,_CPM1_dph_F
3342 3342 s 	endm
3342 3342 s 	dwstore _CPM1_dph_F+8	,0xEBA6
3342 3342 d 54
3342 3342 s 	db 	pW_STORE
3343 3343 d a6eb
3343 3343 s 	dw 	0xEBA6
3345 3345 d c0e8
3345 3345 s 	dw 	_CPM1_dph_F+8
3347 3347 s 	endm
3347 3347 s 	dwpatch 0xDA1B+1 	,0xDC7C	,_CPM1_res_seldsk
3347 3347 d 51
3347 3347 s 	db 	pW_CHK_PATCH
3348 3348 d 1cda
3348 3348 s 	dw 	0xDA1B+1
334a 334a d 7cdc11e9
334a 334a s 	dw 	0xDC7C,_CPM1_res_seldsk
334e 334e s 	endm
334e 334e s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC7C
334e 334e d 54
334e 334e s 	db 	pW_STORE
334f 334f d 7cdc
334f 334f s 	dw 	0xDC7C
3351 3351 d 15e9
3351 3351 s 	dw 	_CPM1_old_seld_dsk+1
3353 3353 s 	endm
3353 3353 s 	dbpatch	0xE6F2	,0x77	,0x00
3353 3353 d 52
3353 3353 s 	db 	pB_CHK_PATCH
3354 3354 d f2e6
3354 3354 s 	dw 	0xE6F2
3356 3356 d 7700
3356 3356 s 	db 	0x77,0x00
3358 3358 s 	endm
3358 3358 s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE056
3358 3358 d 54
3358 3358 s 	db 	pW_STORE
3359 3359 d 56e0
3359 3359 s 	dw 	0xE056
335b 335b d 2ee9
335b 335b s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
335d 335d s 	endm
335d 335d s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE056
335d 335d d 54
335d 335d s 	db 	pW_STORE
335e 335e d 56e0
335e 335e s 	dw 	0xE056
3360 3360 d 6be9
3360 3360 s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
3362 3362 s 	endm
3362 3362 s 	dwpatch	0xDA27+1	,0xDCDA	,_CPM1_res_READ
3362 3362 d 51
3362 3362 s 	db 	pW_CHK_PATCH
3363 3363 d 28da
3363 3363 s 	dw 	0xDA27+1
3365 3365 d dadc1be9
3365 3365 s 	dw 	0xDCDA,_CPM1_res_READ
3369 3369 s 	endm
3369 3369 s 	dwpatch	0xDA2A+1	,0xDE97	,_CPM1_res_WRITE
3369 3369 d 51
3369 3369 s 	db 	pW_CHK_PATCH
336a 336a d 2bda
336a 336a s 	dw 	0xDA2A+1
336c 336c d 97de58e9
336c 336c s 	dw 	0xDE97,_CPM1_res_WRITE
3370 3370 s 	endm
3370 3370 s 	dwpatch	0xDB73+1	,0xDCDA	,_CPM1_res_READ
3370 3370 d 51
3370 3370 s 	db 	pW_CHK_PATCH
3371 3371 d 74db
3371 3371 s 	dw 	0xDB73+1
3373 3373 d dadc1be9
3373 3373 s 	dw 	0xDCDA,_CPM1_res_READ
3377 3377 s 	endm
3377 3377 s 	dwpatch	0xdcae+1	,0xE630	,_CPM1_res_GETINFO
3377 3377 d 51
3377 3377 s 	db 	pW_CHK_PATCH
3378 3378 d afdc
3378 3378 s 	dw 	0xdcae+1
337a 337a d 30e695e9
337a 337a s 	dw 	0xE630,_CPM1_res_GETINFO
337e 337e s 	endm
337e 337e s 	dwstore	_CPM1__old_read+1	,0xDCDA
337e 337e d 54
337e 337e s 	db 	pW_STORE
337f 337f d dadc
337f 337f s 	dw 	0xDCDA
3381 3381 d 56e9
3381 3381 s 	dw 	_CPM1__old_read+1
3383 3383 s 	endm
3383 3383 s 	dwstore	_CPM1__old_write+1	,0xDE97
3383 3383 d 54
3383 3383 s 	db 	pW_STORE
3384 3384 d 97de
3384 3384 s 	dw 	0xDE97
3386 3386 d 93e9
3386 3386 s 	dw 	_CPM1__old_write+1
3388 3388 s 	endm
3388 3388 s 	dwstore	_CPM1__old_getinfo+1	,0xE630
3388 3388 d 54
3388 3388 s 	db 	pW_STORE
3389 3389 d 30e6
3389 3389 s 	dw 	0xE630
338b 338b d a3e9
338b 338b s 	dw 	_CPM1__old_getinfo+1
338d 338d s 	endm
338d 338d s 	dbpatch	0xE667		,0x21	,0x21
338d 338d d 52
338d 338d s 	db 	pB_CHK_PATCH
338e 338e d 67e6
338e 338e s 	dw 	0xE667
3390 3390 d 2121
3390 3390 s 	db 	0x21,0x21
3392 3392 s 	endm
3392 3392 s 	dwpatch	0xE667+1 	,0xE697	,0xE697
3392 3392 d 51
3392 3392 s 	db 	pW_CHK_PATCH
3393 3393 d 68e6
3393 3393 s 	dw 	0xE667+1
3395 3395 d 97e697e6
3395 3395 s 	dw 	0xE697,0xE697
3399 3399 s 	endm
3399 3399 s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE667
3399 3399 d 54
3399 3399 s 	db 	pW_STORE
339a 339a d 67e6
339a 339a s 	dw 	0xE667
339c 339c d a0e9
339c 339c s 	dw 	_CPM1__old_getinfo_chkdo+1
339e 339e s 	endm
339e 339e s 	dwstore	_CPM1_r_p_DSK1+1	,0xE04C 	;read
339e 339e d 54
339e 339e s 	db 	pW_STORE
339f 339f d 4ce0
339f 339f s 	dw 	0xE04C
33a1 33a1 d 1ce9
33a1 33a1 s 	dw 	_CPM1_r_p_DSK1+1
33a3 33a3 s 	endm
33a3 33a3 s 	dwstore	_CPM1_r_p_TRK1+1	,0xE050 	
33a3 33a3 d 54
33a3 33a3 s 	db 	pW_STORE
33a4 33a4 d 50e0
33a4 33a4 s 	dw 	0xE050
33a6 33a6 d 37e9
33a6 33a6 s 	dw 	_CPM1_r_p_TRK1+1
33a8 33a8 s 	endm
33a8 33a8 s 	dwstore	_CPM1_r_p_SEC1+1	,0xE051 	
33a8 33a8 d 54
33a8 33a8 s 	db 	pW_STORE
33a9 33a9 d 51e0
33a9 33a9 s 	dw 	0xE051
33ab 33ab d 3de9
33ab 33ab s 	dw 	_CPM1_r_p_SEC1+1
33ad 33ad s 	endm
33ad 33ad s 	dwstore	_CPM1_r_p_DMA1+1	,0xE052 	
33ad 33ad d 54
33ad 33ad s 	db 	pW_STORE
33ae 33ae d 52e0
33ae 33ae s 	dw 	0xE052
33b0 33b0 d 4ee9
33b0 33b0 s 	dw 	_CPM1_r_p_DMA1+1
33b2 33b2 s 	endm
33b2 33b2 s 	dwstore	_CPM1_r_p_DSK2+1	,0xE04C 	;write
33b2 33b2 d 54
33b2 33b2 s 	db 	pW_STORE
33b3 33b3 d 4ce0
33b3 33b3 s 	dw 	0xE04C
33b5 33b5 d 59e9
33b5 33b5 s 	dw 	_CPM1_r_p_DSK2+1
33b7 33b7 s 	endm
33b7 33b7 s 	dwstore	_CPM1_r_p_TRK2+1	,0xE050 	
33b7 33b7 d 54
33b7 33b7 s 	db 	pW_STORE
33b8 33b8 d 50e0
33b8 33b8 s 	dw 	0xE050
33ba 33ba d 74e9
33ba 33ba s 	dw 	_CPM1_r_p_TRK2+1
33bc 33bc s 	endm
33bc 33bc s 	dwstore	_CPM1_r_p_SEC2+1	,0xE051 	
33bc 33bc d 54
33bc 33bc s 	db 	pW_STORE
33bd 33bd d 51e0
33bd 33bd s 	dw 	0xE051
33bf 33bf d 7ae9
33bf 33bf s 	dw 	_CPM1_r_p_SEC2+1
33c1 33c1 s 	endm
33c1 33c1 s 	dwstore	_CPM1_r_p_DMA2+1	,0xE052 	
33c1 33c1 d 54
33c1 33c1 s 	db 	pW_STORE
33c2 33c2 d 52e0
33c2 33c2 s 	dw 	0xE052
33c4 33c4 d 8be9
33c4 33c4 s 	dw 	_CPM1_r_p_DMA2+1
33c6 33c6 s 	endm
33c6 33c6 s 	dwstore	_CPM1_r_p_DSK3+1	,0xE04C 	;readinfo
33c6 33c6 d 54
33c6 33c6 s 	db 	pW_STORE
33c7 33c7 d 4ce0
33c7 33c7 s 	dw 	0xE04C
33c9 33c9 d 28ea
33c9 33c9 s 	dw 	_CPM1_r_p_DSK3+1
33cb 33cb s 	endm
33cb 33cb s 
33cb 33cb s 	stop 'CPM_21_89_2_niijaf2'
33cb 33cb d 50
33cb 33cb s 	db 	p_STOP
33cc 33cc d 43504d5f32315f38395f325f6e69696a616632
33cc 33cc s 	db 	'CPM_21_89_2_niijaf2'
33df 33df d 00
33df 33df s 	db 	0
33e0 33e0 s 	endm
33e0 33e0 f out/include-patcher.asm
33e0 33e0 s 	include "generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf.asm"	; 28 images in collection
33e0 33e0 f generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf.asm
33e0 33e0 s _BIOS_CPM_21_89_2_niijaf:
33e0 33e0 s 	setSUBBIOS 1
33e0 33e0 d 5a
33e0 33e0 s 	db	pSubBios
33e1 33e1 d 01
33e1 33e1 s 	db 	1
33e2 33e2 s 	endm
33e2 33e2 s 	RQ_OPTS_ANY
33e2 33e2 s 	endm
33e2 33e2 s 	setCPM
33e2 33e2 s 	endm
33e2 33e2 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
33e2 33e2 d 59
33e2 33e2 s 	db 	pB_MAYBE_PATCH
33e3 33e3 d eeda
33e3 33e3 s 	dw 	0xDAEE
33e5 33e5 d 1f0d
33e5 33e5 s 	db 	0x1F,0x0d
33e7 33e7 s 	endm
33e7 33e7 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
33e7 33e7 d 59
33e7 33e7 s 	db 	pB_MAYBE_PATCH
33e8 33e8 d f0da
33e8 33e8 s 	dw 	0xDAEE+2
33ea 33ea d 0a0d
33ea 33ea s 	db 	0x0a,0x0d
33ec 33ec s 	endm
33ec 33ec s 	dbpatch	0xE48E+1	,0x49	,0xc9
33ec 33ec d 52
33ec 33ec s 	db 	pB_CHK_PATCH
33ed 33ed d 8fe4
33ed 33ed s 	dw 	0xE48E+1
33ef 33ef d 49c9
33ef 33ef s 	db 	0x49,0xc9
33f1 33f1 s 	endm
33f1 33f1 s 	dbpatch	0xDA89 	,0x01	,0x00
33f1 33f1 d 52
33f1 33f1 s 	db 	pB_CHK_PATCH
33f2 33f2 d 89da
33f2 33f2 s 	dw 	0xDA89
33f4 33f4 d 0100
33f4 33f4 s 	db 	0x01,0x00
33f6 33f6 s 	endm
33f6 33f6 s 	dbpatch	0xDAA0 	,0x02	,0x00
33f6 33f6 d 52
33f6 33f6 s 	db 	pB_CHK_PATCH
33f7 33f7 d a0da
33f7 33f7 s 	dw 	0xDAA0
33f9 33f9 d 0200
33f9 33f9 s 	db 	0x02,0x00
33fb 33fb s 	endm
33fb 33fb s 	dbpatch	0xDAB7 	,0x04	,0x01
33fb 33fb d 52
33fb 33fb s 	db 	pB_CHK_PATCH
33fc 33fc d b7da
33fc 33fc s 	dw 	0xDAB7
33fe 33fe d 0401
33fe 33fe s 	db 	0x04,0x01
3400 3400 s 	endm
3400 3400 s 	dbpatch	0xDACE 	,0x08	,0x02
3400 3400 d 52
3400 3400 s 	db 	pB_CHK_PATCH
3401 3401 d ceda
3401 3401 s 	dw 	0xDACE
3403 3403 d 0802
3403 3403 s 	db 	0x08,0x02
3405 3405 s 	endm
3405 3405 s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
3405 3405 d 54
3405 3405 s 	db 	pW_STORE
3406 3406 d 89da
3406 3406 s 	dw 	0xDA89
3408 3408 d ace8
3408 3408 s 	dw 	_CPM1_res_DRIVE_TAB+0*2
340a 340a s 	endm
340a 340a s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
340a 340a d 54
340a 340a s 	db 	pW_STORE
340b 340b d a0da
340b 340b s 	dw 	0xDAA0
340d 340d d aee8
340d 340d s 	dw 	_CPM1_res_DRIVE_TAB+1*2
340f 340f s 	endm
340f 340f s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
340f 340f d 54
340f 340f s 	db 	pW_STORE
3410 3410 d b7da
3410 3410 s 	dw 	0xDAB7
3412 3412 d b0e8
3412 3412 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
3414 3414 s 	endm
3414 3414 s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
3414 3414 d 54
3414 3414 s 	db 	pW_STORE
3415 3415 d ceda
3415 3415 s 	dw 	0xDACE
3417 3417 d b2e8
3417 3417 s 	dw 	_CPM1_res_DRIVE_TAB+3*2
3419 3419 s 	endm
3419 3419 s 	dwpatch 0xDCBB+5*2 	,0x0000 ,_CPM1_dph_F
3419 3419 d 51
3419 3419 s 	db 	pW_CHK_PATCH
341a 341a d c5dc
341a 341a s 	dw 	0xDCBB+5*2
341c 341c d 0000b8e8
341c 341c s 	dw 	0x0000,_CPM1_dph_F
3420 3420 s 	endm
3420 3420 s 	dwstore _CPM1_dph_F+8	,0xEBA6
3420 3420 d 54
3420 3420 s 	db 	pW_STORE
3421 3421 d a6eb
3421 3421 s 	dw 	0xEBA6
3423 3423 d c0e8
3423 3423 s 	dw 	_CPM1_dph_F+8
3425 3425 s 	endm
3425 3425 s 	dwpatch 0xDA1B+1 	,0xDC7C	,_CPM1_res_seldsk
3425 3425 d 51
3425 3425 s 	db 	pW_CHK_PATCH
3426 3426 d 1cda
3426 3426 s 	dw 	0xDA1B+1
3428 3428 d 7cdc11e9
3428 3428 s 	dw 	0xDC7C,_CPM1_res_seldsk
342c 342c s 	endm
342c 342c s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC7C
342c 342c d 54
342c 342c s 	db 	pW_STORE
342d 342d d 7cdc
342d 342d s 	dw 	0xDC7C
342f 342f d 15e9
342f 342f s 	dw 	_CPM1_old_seld_dsk+1
3431 3431 s 	endm
3431 3431 s 	dbpatch	0xE6F9	,0x77	,0x00
3431 3431 d 52
3431 3431 s 	db 	pB_CHK_PATCH
3432 3432 d f9e6
3432 3432 s 	dw 	0xE6F9
3434 3434 d 7700
3434 3434 s 	db 	0x77,0x00
3436 3436 s 	endm
3436 3436 s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE05D
3436 3436 d 54
3436 3436 s 	db 	pW_STORE
3437 3437 d 5de0
3437 3437 s 	dw 	0xE05D
3439 3439 d 2ee9
3439 3439 s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
343b 343b s 	endm
343b 343b s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE05D
343b 343b d 54
343b 343b s 	db 	pW_STORE
343c 343c d 5de0
343c 343c s 	dw 	0xE05D
343e 343e d 6be9
343e 343e s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
3440 3440 s 	endm
3440 3440 s 	dwpatch	0xDA27+1	,0xDCDA	,_CPM1_res_READ
3440 3440 d 51
3440 3440 s 	db 	pW_CHK_PATCH
3441 3441 d 28da
3441 3441 s 	dw 	0xDA27+1
3443 3443 d dadc1be9
3443 3443 s 	dw 	0xDCDA,_CPM1_res_READ
3447 3447 s 	endm
3447 3447 s 	dwpatch	0xDA2A+1	,0xDE9E	,_CPM1_res_WRITE
3447 3447 d 51
3447 3447 s 	db 	pW_CHK_PATCH
3448 3448 d 2bda
3448 3448 s 	dw 	0xDA2A+1
344a 344a d 9ede58e9
344a 344a s 	dw 	0xDE9E,_CPM1_res_WRITE
344e 344e s 	endm
344e 344e s 	dwpatch	0xDB73+1	,0xDCDA	,_CPM1_res_READ
344e 344e d 51
344e 344e s 	db 	pW_CHK_PATCH
344f 344f d 74db
344f 344f s 	dw 	0xDB73+1
3451 3451 d dadc1be9
3451 3451 s 	dw 	0xDCDA,_CPM1_res_READ
3455 3455 s 	endm
3455 3455 s 	dwpatch	0xdcae+1	,0xE637	,_CPM1_res_GETINFO
3455 3455 d 51
3455 3455 s 	db 	pW_CHK_PATCH
3456 3456 d afdc
3456 3456 s 	dw 	0xdcae+1
3458 3458 d 37e695e9
3458 3458 s 	dw 	0xE637,_CPM1_res_GETINFO
345c 345c s 	endm
345c 345c s 	dwstore	_CPM1__old_read+1	,0xDCDA
345c 345c d 54
345c 345c s 	db 	pW_STORE
345d 345d d dadc
345d 345d s 	dw 	0xDCDA
345f 345f d 56e9
345f 345f s 	dw 	_CPM1__old_read+1
3461 3461 s 	endm
3461 3461 s 	dwstore	_CPM1__old_write+1	,0xDE9E
3461 3461 d 54
3461 3461 s 	db 	pW_STORE
3462 3462 d 9ede
3462 3462 s 	dw 	0xDE9E
3464 3464 d 93e9
3464 3464 s 	dw 	_CPM1__old_write+1
3466 3466 s 	endm
3466 3466 s 	dwstore	_CPM1__old_getinfo+1	,0xE637
3466 3466 d 54
3466 3466 s 	db 	pW_STORE
3467 3467 d 37e6
3467 3467 s 	dw 	0xE637
3469 3469 d a3e9
3469 3469 s 	dw 	_CPM1__old_getinfo+1
346b 346b s 	endm
346b 346b s 	dbpatch	0xE66E		,0x21	,0x21
346b 346b d 52
346b 346b s 	db 	pB_CHK_PATCH
346c 346c d 6ee6
346c 346c s 	dw 	0xE66E
346e 346e d 2121
346e 346e s 	db 	0x21,0x21
3470 3470 s 	endm
3470 3470 s 	dwpatch	0xE66E+1 	,0xE69E	,0xE69E
3470 3470 d 51
3470 3470 s 	db 	pW_CHK_PATCH
3471 3471 d 6fe6
3471 3471 s 	dw 	0xE66E+1
3473 3473 d 9ee69ee6
3473 3473 s 	dw 	0xE69E,0xE69E
3477 3477 s 	endm
3477 3477 s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE66E
3477 3477 d 54
3477 3477 s 	db 	pW_STORE
3478 3478 d 6ee6
3478 3478 s 	dw 	0xE66E
347a 347a d a0e9
347a 347a s 	dw 	_CPM1__old_getinfo_chkdo+1
347c 347c s 	endm
347c 347c s 	dwstore	_CPM1_r_p_DSK1+1	,0xE053 	;read
347c 347c d 54
347c 347c s 	db 	pW_STORE
347d 347d d 53e0
347d 347d s 	dw 	0xE053
347f 347f d 1ce9
347f 347f s 	dw 	_CPM1_r_p_DSK1+1
3481 3481 s 	endm
3481 3481 s 	dwstore	_CPM1_r_p_TRK1+1	,0xE057 	
3481 3481 d 54
3481 3481 s 	db 	pW_STORE
3482 3482 d 57e0
3482 3482 s 	dw 	0xE057
3484 3484 d 37e9
3484 3484 s 	dw 	_CPM1_r_p_TRK1+1
3486 3486 s 	endm
3486 3486 s 	dwstore	_CPM1_r_p_SEC1+1	,0xE058 	
3486 3486 d 54
3486 3486 s 	db 	pW_STORE
3487 3487 d 58e0
3487 3487 s 	dw 	0xE058
3489 3489 d 3de9
3489 3489 s 	dw 	_CPM1_r_p_SEC1+1
348b 348b s 	endm
348b 348b s 	dwstore	_CPM1_r_p_DMA1+1	,0xE059 	
348b 348b d 54
348b 348b s 	db 	pW_STORE
348c 348c d 59e0
348c 348c s 	dw 	0xE059
348e 348e d 4ee9
348e 348e s 	dw 	_CPM1_r_p_DMA1+1
3490 3490 s 	endm
3490 3490 s 	dwstore	_CPM1_r_p_DSK2+1	,0xE053 	;write
3490 3490 d 54
3490 3490 s 	db 	pW_STORE
3491 3491 d 53e0
3491 3491 s 	dw 	0xE053
3493 3493 d 59e9
3493 3493 s 	dw 	_CPM1_r_p_DSK2+1
3495 3495 s 	endm
3495 3495 s 	dwstore	_CPM1_r_p_TRK2+1	,0xE057 	
3495 3495 d 54
3495 3495 s 	db 	pW_STORE
3496 3496 d 57e0
3496 3496 s 	dw 	0xE057
3498 3498 d 74e9
3498 3498 s 	dw 	_CPM1_r_p_TRK2+1
349a 349a s 	endm
349a 349a s 	dwstore	_CPM1_r_p_SEC2+1	,0xE058 	
349a 349a d 54
349a 349a s 	db 	pW_STORE
349b 349b d 58e0
349b 349b s 	dw 	0xE058
349d 349d d 7ae9
349d 349d s 	dw 	_CPM1_r_p_SEC2+1
349f 349f s 	endm
349f 349f s 	dwstore	_CPM1_r_p_DMA2+1	,0xE059 	
349f 349f d 54
349f 349f s 	db 	pW_STORE
34a0 34a0 d 59e0
34a0 34a0 s 	dw 	0xE059
34a2 34a2 d 8be9
34a2 34a2 s 	dw 	_CPM1_r_p_DMA2+1
34a4 34a4 s 	endm
34a4 34a4 s 	dwstore	_CPM1_r_p_DSK3+1	,0xE053 	;readinfo
34a4 34a4 d 54
34a4 34a4 s 	db 	pW_STORE
34a5 34a5 d 53e0
34a5 34a5 s 	dw 	0xE053
34a7 34a7 d 28ea
34a7 34a7 s 	dw 	_CPM1_r_p_DSK3+1
34a9 34a9 s 	endm
34a9 34a9 s 
34a9 34a9 s 	stop 'CPM_21_89_2_niijaf'
34a9 34a9 d 50
34a9 34a9 s 	db 	p_STOP
34aa 34aa d 43504d5f32315f38395f325f6e69696a6166
34aa 34aa s 	db 	'CPM_21_89_2_niijaf'
34bc 34bc d 00
34bc 34bc s 	db 	0
34bd 34bd s 	endm
34bd 34bd f out/include-patcher.asm
34bd 34bd s 	include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_870430.asm"	; 28 images in collection
34bd 34bd f generator/V0/out/patcher-microdos-MICRODOS_OPTS1_870430.asm
34bd 34bd s _BIOS_MICRODOS_OPTS1_870430:
34bd 34bd s 	setMICRODOS
34bd 34bd d 56
34bd 34bd s 	db 	pSETFLAG_MICRODOS
34be 34be s 	endm
34be 34be s 	RQ_OPTS1
34be 34be d 57
34be 34be s 	db 	pREQUIRED_OPTS1
34bf 34bf s 	endm
34bf 34bf s 	dbpatchmaybe	0xE5A2	,0x1B	,0x0d
34bf 34bf d 59
34bf 34bf s 	db 	pB_MAYBE_PATCH
34c0 34c0 d a2e5
34c0 34c0 s 	dw 	0xE5A2
34c2 34c2 d 1b0d
34c2 34c2 s 	db 	0x1B,0x0d
34c4 34c4 s 	endm
34c4 34c4 s 	dbpatchmaybe	0xE5A2+1	,0x45	,0x0d
34c4 34c4 d 59
34c4 34c4 s 	db 	pB_MAYBE_PATCH
34c5 34c5 d a3e5
34c5 34c5 s 	dw 	0xE5A2+1
34c7 34c7 d 450d
34c7 34c7 s 	db 	0x45,0x0d
34c9 34c9 s 	endm
34c9 34c9 s 	dwpatch	0xE497+1	,0xE627	,MD_READ			
34c9 34c9 d 51
34c9 34c9 s 	db 	pW_CHK_PATCH
34ca 34ca d 98e4
34ca 34ca s 	dw 	0xE497+1
34cc 34cc d 27e63efa
34cc 34cc s 	dw 	0xE627,MD_READ
34d0 34d0 s 	endm
34d0 34d0 s 	dwpatch	0xE4A0+1	,0xE62A	,MD_WRITE
34d0 34d0 d 51
34d0 34d0 s 	db 	pW_CHK_PATCH
34d1 34d1 d a1e4
34d1 34d1 s 	dw 	0xE4A0+1
34d3 34d3 d 2ae653fa
34d3 34d3 s 	dw 	0xE62A,MD_WRITE
34d7 34d7 s 	endm
34d7 34d7 s 	dbpatch	0xEAAE	,0xcd	,0x00
34d7 34d7 d 52
34d7 34d7 s 	db 	pB_CHK_PATCH
34d8 34d8 d aeea
34d8 34d8 s 	dw 	0xEAAE
34da 34da d cd00
34da 34da s 	db 	0xcd,0x00
34dc 34dc s 	endm
34dc 34dc s 	dwpatch	0xEAAE+1	,0xE9E9	,0x0000
34dc 34dc d 51
34dc 34dc s 	db 	pW_CHK_PATCH
34dd 34dd d afea
34dd 34dd s 	dw 	0xEAAE+1
34df 34df d e9e90000
34df 34df s 	dw 	0xE9E9,0x0000
34e3 34e3 s 	endm
34e3 34e3 s 	dwpatch	0xEAB4+1	,0xEC5D	,MD_READ_INFOSECTOR
34e3 34e3 d 51
34e3 34e3 s 	db 	pW_CHK_PATCH
34e4 34e4 d b5ea
34e4 34e4 s 	dw 	0xEAB4+1
34e6 34e6 d 5dec68fa
34e6 34e6 s 	dw 	0xEC5D,MD_READ_INFOSECTOR
34ea 34ea s 	endm
34ea 34ea s 	dwstore	MD_DRV2+1,	0xDF5A
34ea 34ea d 54
34ea 34ea s 	db 	pW_STORE
34eb 34eb d 5adf
34eb 34eb s 	dw 	0xDF5A
34ed 34ed d f3fa
34ed 34ed s 	dw 	MD_DRV2+1
34ef 34ef s 	endm
34ef 34ef s 	dwstore	MD_RDBUF2+1,	0xE09A
34ef 34ef d 54
34ef 34ef s 	db 	pW_STORE
34f0 34f0 d 9ae0
34f0 34f0 s 	dw 	0xE09A
34f2 34f2 d 02fb
34f2 34f2 s 	dw 	MD_RDBUF2+1
34f4 34f4 s 	endm
34f4 34f4 s 	dwstore	MD_PARAM2+1,	0xDDC1
34f4 34f4 d 54
34f4 34f4 s 	db 	pW_STORE
34f5 34f5 d c1dd
34f5 34f5 s 	dw 	0xDDC1
34f7 34f7 d 1dfa
34f7 34f7 s 	dw 	MD_PARAM2+1
34f9 34f9 s 	endm
34f9 34f9 s 	dwpatch 0xc01b+1	 ,0xDD8B	,md_res_seldsk
34f9 34f9 d 51
34f9 34f9 s 	db 	pW_CHK_PATCH
34fa 34fa d 1cc0
34fa 34fa s 	dw 	0xc01b+1
34fc 34fc d 8bdd0efa
34fc 34fc s 	dw 	0xDD8B,md_res_seldsk
3500 3500 s 	endm
3500 3500 s 	dwstore md_old_seld_dsk+1,0xDD8B	,0xdd4c
3500 3500 d 54
3500 3500 s 	db 	pW_STORE
3501 3501 d 8bdd
3501 3501 s 	dw 	0xDD8B
3503 3503 d 12fa
3503 3503 s 	dw 	md_old_seld_dsk+1
3505 3505 s 	endm
3505 3505 s 	;custom checkers
3505 3505 s 	dwpatch	0xBE80	,0xBE80 ,0xBE80
3505 3505 d 51
3505 3505 s 	db 	pW_CHK_PATCH
3506 3506 d 80be
3506 3506 s 	dw 	0xBE80
3508 3508 d 80be80be
3508 3508 s 	dw 	0xBE80,0xBE80
350c 350c s 	endm
350c 350c s 	dwpatch	0xBE82	,0xBF00 ,0xBF00
350c 350c d 51
350c 350c s 	db 	pW_CHK_PATCH
350d 350d d 82be
350d 350d s 	dw 	0xBE82
350f 350f d 00bf00bf
350f 350f s 	dw 	0xBF00,0xBF00
3513 3513 s 	endm
3513 3513 s 	dwpatch	0xc000+1	,0xC49A ,0xC49A
3513 3513 d 51
3513 3513 s 	db 	pW_CHK_PATCH
3514 3514 d 01c0
3514 3514 s 	dw 	0xc000+1
3516 3516 d 9ac49ac4
3516 3516 s 	dw 	0xC49A,0xC49A
351a 351a s 	endm
351a 351a s 	dwpatch	0xc003+1	,0xDBFD ,0xDBFD
351a 351a d 51
351a 351a s 	db 	pW_CHK_PATCH
351b 351b d 04c0
351b 351b s 	dw 	0xc003+1
351d 351d d fddbfddb
351d 351d s 	dw 	0xDBFD,0xDBFD
3521 3521 s 	endm
3521 3521 s 	stop 'MICRODOS_OPTS1_870430'
3521 3521 d 50
3521 3521 s 	db 	p_STOP
3522 3522 d 4d4943524f444f535f4f505453315f383730343330
3522 3522 s 	db 	'MICRODOS_OPTS1_870430'
3537 3537 d 00
3537 3537 s 	db 	0
3538 3538 s 	endm
3538 3538 f out/include-patcher.asm
3538 3538 s 	include "generator/V0/out/patcher-cpm2-CPM_1x_89_03_30_RAVI.asm"	; 17 images in collection
3538 3538 f generator/V0/out/patcher-cpm2-CPM_1x_89_03_30_RAVI.asm
3538 3538 s _BIOS_CPM_1x_89_03_30_RAVI:
3538 3538 s 	setSUBBIOS 2
3538 3538 d 5a
3538 3538 s 	db	pSubBios
3539 3539 d 02
3539 3539 s 	db 	2
353a 353a s 	endm
353a 353a s 	RQ_OPTS1
353a 353a d 57
353a 353a s 	db 	pREQUIRED_OPTS1
353b 353b s 	endm
353b 353b s 	setCPM
353b 353b s 	endm
353b 353b s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
353b 353b d 59
353b 353b s 	db 	pB_MAYBE_PATCH
353c 353c d eeda
353c 353c s 	dw 	0xDAEE
353e 353e d 1f0d
353e 353e s 	db 	0x1F,0x0d
3540 3540 s 	endm
3540 3540 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
3540 3540 d 59
3540 3540 s 	db 	pB_MAYBE_PATCH
3541 3541 d f0da
3541 3541 s 	dw 	0xDAEE+2
3543 3543 d 0a0d
3543 3543 s 	db 	0x0a,0x0d
3545 3545 s 	endm
3545 3545 s 	dbpatch	0xE8B8+1	,0x49	,0xc9
3545 3545 d 52
3545 3545 s 	db 	pB_CHK_PATCH
3546 3546 d b9e8
3546 3546 s 	dw 	0xE8B8+1
3548 3548 d 49c9
3548 3548 s 	db 	0x49,0xc9
354a 354a s 	endm
354a 354a s 	dbpatch	0xDA88 	,0x01	,0x00
354a 354a d 52
354a 354a s 	db 	pB_CHK_PATCH
354b 354b d 88da
354b 354b s 	dw 	0xDA88
354d 354d d 0100
354d 354d s 	db 	0x01,0x00
354f 354f s 	endm
354f 354f s 	dbpatch	0xDA9F 	,0x02	,0x00
354f 354f d 52
354f 354f s 	db 	pB_CHK_PATCH
3550 3550 d 9fda
3550 3550 s 	dw 	0xDA9F
3552 3552 d 0200
3552 3552 s 	db 	0x02,0x00
3554 3554 s 	endm
3554 3554 s 	dbpatch	0xDAB6 	,0x04	,0x01
3554 3554 d 52
3554 3554 s 	db 	pB_CHK_PATCH
3555 3555 d b6da
3555 3555 s 	dw 	0xDAB6
3557 3557 d 0401
3557 3557 s 	db 	0x04,0x01
3559 3559 s 	endm
3559 3559 s 	dbpatch	0xDACD 	,0x08	,0x02
3559 3559 d 52
3559 3559 s 	db 	pB_CHK_PATCH
355a 355a d cdda
355a 355a s 	dw 	0xDACD
355c 355c d 0802
355c 355c s 	db 	0x08,0x02
355e 355e s 	endm
355e 355e s 	dwstore	_CPM2_res_DRIVE_TAB+0*2	,0xDA88
355e 355e d 54
355e 355e s 	db 	pW_STORE
355f 355f d 88da
355f 355f s 	dw 	0xDA88
3561 3561 d 06ea
3561 3561 s 	dw 	_CPM2_res_DRIVE_TAB+0*2
3563 3563 s 	endm
3563 3563 s 	dwstore	_CPM2_res_DRIVE_TAB+1*2	,0xDA9F
3563 3563 d 54
3563 3563 s 	db 	pW_STORE
3564 3564 d 9fda
3564 3564 s 	dw 	0xDA9F
3566 3566 d 08ea
3566 3566 s 	dw 	_CPM2_res_DRIVE_TAB+1*2
3568 3568 s 	endm
3568 3568 s 	dwstore	_CPM2_res_DRIVE_TAB+2*2	,0xDAB6
3568 3568 d 54
3568 3568 s 	db 	pW_STORE
3569 3569 d b6da
3569 3569 s 	dw 	0xDAB6
356b 356b d 0aea
356b 356b s 	dw 	_CPM2_res_DRIVE_TAB+2*2
356d 356d s 	endm
356d 356d s 	dwstore	_CPM2_res_DRIVE_TAB+3*2	,0xDACD
356d 356d d 54
356d 356d s 	db 	pW_STORE
356e 356e d cdda
356e 356e s 	dw 	0xDACD
3570 3570 d 0cea
3570 3570 s 	dw 	_CPM2_res_DRIVE_TAB+3*2
3572 3572 s 	endm
3572 3572 s 	dwpatch 0xDEC6+5*2 	,0x0000 ,_CPM2_dph_F
3572 3572 d 51
3572 3572 s 	db 	pW_CHK_PATCH
3573 3573 d d0de
3573 3573 s 	dw 	0xDEC6+5*2
3575 3575 d 000012ea
3575 3575 s 	dw 	0x0000,_CPM2_dph_F
3579 3579 s 	endm
3579 3579 s 	dwstore _CPM2_dph_F+8	,0xE1AB
3579 3579 d 54
3579 3579 s 	db 	pW_STORE
357a 357a d abe1
357a 357a s 	dw 	0xE1AB
357c 357c d 1aea
357c 357c s 	dw 	_CPM2_dph_F+8
357e 357e s 	endm
357e 357e s 	dwpatch 0xDA1B+1 	,0xDE82	,_CPM2_res_seldsk
357e 357e d 51
357e 357e s 	db 	pW_CHK_PATCH
357f 357f d 1cda
357f 357f s 	dw 	0xDA1B+1
3581 3581 d 82de6bea
3581 3581 s 	dw 	0xDE82,_CPM2_res_seldsk
3585 3585 s 	endm
3585 3585 s 	dwstore	_CPM2_old_seld_dsk+1	,0xDE82
3585 3585 d 54
3585 3585 s 	db 	pW_STORE
3586 3586 d 82de
3586 3586 s 	dw 	0xDE82
3588 3588 d 6fea
3588 3588 s 	dw 	_CPM2_old_seld_dsk+1
358a 358a s 	endm
358a 358a s 	dbpatch	0xE6DF	,0x77	,0x00
358a 358a d 52
358a 358a s 	db 	pB_CHK_PATCH
358b 358b d dfe6
358b 358b s 	dw 	0xE6DF
358d 358d d 7700
358d 358d s 	db 	0x77,0x00
358f 358f s 	endm
358f 358f s 	dwstore	_CPM2_r_p_SELDSKDRIVER+1	,0xE199
358f 358f d 54
358f 358f s 	db 	pW_STORE
3590 3590 d 99e1
3590 3590 s 	dw 	0xE199
3592 3592 d 88ea
3592 3592 s 	dw 	_CPM2_r_p_SELDSKDRIVER+1
3594 3594 s 	endm
3594 3594 s 	dwstore	_CPM2_r_p_SELDSKDRIVEW+1	,0xE199
3594 3594 d 54
3594 3594 s 	db 	pW_STORE
3595 3595 d 99e1
3595 3595 s 	dw 	0xE199
3597 3597 d c5ea
3597 3597 s 	dw 	_CPM2_r_p_SELDSKDRIVEW+1
3599 3599 s 	endm
3599 3599 s 	dwpatch	0xDA27+1	,0xDEE5	,_CPM2_res_READ
3599 3599 d 51
3599 3599 s 	db 	pW_CHK_PATCH
359a 359a d 28da
359a 359a s 	dw 	0xDA27+1
359c 359c d e5de75ea
359c 359c s 	dw 	0xDEE5,_CPM2_res_READ
35a0 35a0 s 	endm
35a0 35a0 s 	dwpatch	0xDA2A+1	,0xE01B	,_CPM2_res_WRITE
35a0 35a0 d 51
35a0 35a0 s 	db 	pW_CHK_PATCH
35a1 35a1 d 2bda
35a1 35a1 s 	dw 	0xDA2A+1
35a3 35a3 d 1be0b2ea
35a3 35a3 s 	dw 	0xE01B,_CPM2_res_WRITE
35a7 35a7 s 	endm
35a7 35a7 s 	dwpatch	0xDBC2+1	,0xDEE5	,_CPM2_res_READ
35a7 35a7 d 51
35a7 35a7 s 	db 	pW_CHK_PATCH
35a8 35a8 d c3db
35a8 35a8 s 	dw 	0xDBC2+1
35aa 35aa d e5de75ea
35aa 35aa s 	dw 	0xDEE5,_CPM2_res_READ
35ae 35ae s 	endm
35ae 35ae s 	dwpatch	0xdeb4+1	,0xE615	,_CPM2_res_GETINFO
35ae 35ae d 51
35ae 35ae s 	db 	pW_CHK_PATCH
35af 35af d b5de
35af 35af s 	dw 	0xdeb4+1
35b1 35b1 d 15e6efea
35b1 35b1 s 	dw 	0xE615,_CPM2_res_GETINFO
35b5 35b5 s 	endm
35b5 35b5 s 	dwstore	_CPM2__old_read+1	,0xDEE5
35b5 35b5 d 54
35b5 35b5 s 	db 	pW_STORE
35b6 35b6 d e5de
35b6 35b6 s 	dw 	0xDEE5
35b8 35b8 d b0ea
35b8 35b8 s 	dw 	_CPM2__old_read+1
35ba 35ba s 	endm
35ba 35ba s 	dwstore	_CPM2__old_write+1	,0xE01B
35ba 35ba d 54
35ba 35ba s 	db 	pW_STORE
35bb 35bb d 1be0
35bb 35bb s 	dw 	0xE01B
35bd 35bd d edea
35bd 35bd s 	dw 	_CPM2__old_write+1
35bf 35bf s 	endm
35bf 35bf s 	dwstore	_CPM2__old_getinfo+1	,0xE615
35bf 35bf d 54
35bf 35bf s 	db 	pW_STORE
35c0 35c0 d 15e6
35c0 35c0 s 	dw 	0xE615
35c2 35c2 d fdea
35c2 35c2 s 	dw 	_CPM2__old_getinfo+1
35c4 35c4 s 	endm
35c4 35c4 s 	dbpatch	0xE655		,0x21	,0x21
35c4 35c4 d 52
35c4 35c4 s 	db 	pB_CHK_PATCH
35c5 35c5 d 55e6
35c5 35c5 s 	dw 	0xE655
35c7 35c7 d 2121
35c7 35c7 s 	db 	0x21,0x21
35c9 35c9 s 	endm
35c9 35c9 s 	dwpatch	0xE655+1 	,0xE685	,0xE685
35c9 35c9 d 51
35c9 35c9 s 	db 	pW_CHK_PATCH
35ca 35ca d 56e6
35ca 35ca s 	dw 	0xE655+1
35cc 35cc d 85e685e6
35cc 35cc s 	dw 	0xE685,0xE685
35d0 35d0 s 	endm
35d0 35d0 s 	dwstore	_CPM2__old_getinfo_chkdo+1	,0xE655
35d0 35d0 d 54
35d0 35d0 s 	db 	pW_STORE
35d1 35d1 d 55e6
35d1 35d1 s 	dw 	0xE655
35d3 35d3 d faea
35d3 35d3 s 	dw 	_CPM2__old_getinfo_chkdo+1
35d5 35d5 s 	endm
35d5 35d5 s 	dwstore	_CPM2_r_p_DSK1+1	,0xE18F 	;read
35d5 35d5 d 54
35d5 35d5 s 	db 	pW_STORE
35d6 35d6 d 8fe1
35d6 35d6 s 	dw 	0xE18F
35d8 35d8 d 76ea
35d8 35d8 s 	dw 	_CPM2_r_p_DSK1+1
35da 35da s 	endm
35da 35da s 	dwstore	_CPM2_r_p_TRK1+1	,0xE193 	
35da 35da d 54
35da 35da s 	db 	pW_STORE
35db 35db d 93e1
35db 35db s 	dw 	0xE193
35dd 35dd d 91ea
35dd 35dd s 	dw 	_CPM2_r_p_TRK1+1
35df 35df s 	endm
35df 35df s 	dwstore	_CPM2_r_p_SEC1+1	,0xE194 	
35df 35df d 54
35df 35df s 	db 	pW_STORE
35e0 35e0 d 94e1
35e0 35e0 s 	dw 	0xE194
35e2 35e2 d 97ea
35e2 35e2 s 	dw 	_CPM2_r_p_SEC1+1
35e4 35e4 s 	endm
35e4 35e4 s 	dwstore	_CPM2_r_p_DMA1+1	,0xE195 	
35e4 35e4 d 54
35e4 35e4 s 	db 	pW_STORE
35e5 35e5 d 95e1
35e5 35e5 s 	dw 	0xE195
35e7 35e7 d a8ea
35e7 35e7 s 	dw 	_CPM2_r_p_DMA1+1
35e9 35e9 s 	endm
35e9 35e9 s 	dwstore	_CPM2_r_p_DSK2+1	,0xE18F 	;write
35e9 35e9 d 54
35e9 35e9 s 	db 	pW_STORE
35ea 35ea d 8fe1
35ea 35ea s 	dw 	0xE18F
35ec 35ec d b3ea
35ec 35ec s 	dw 	_CPM2_r_p_DSK2+1
35ee 35ee s 	endm
35ee 35ee s 	dwstore	_CPM2_r_p_TRK2+1	,0xE193 	
35ee 35ee d 54
35ee 35ee s 	db 	pW_STORE
35ef 35ef d 93e1
35ef 35ef s 	dw 	0xE193
35f1 35f1 d ceea
35f1 35f1 s 	dw 	_CPM2_r_p_TRK2+1
35f3 35f3 s 	endm
35f3 35f3 s 	dwstore	_CPM2_r_p_SEC2+1	,0xE194 	
35f3 35f3 d 54
35f3 35f3 s 	db 	pW_STORE
35f4 35f4 d 94e1
35f4 35f4 s 	dw 	0xE194
35f6 35f6 d d4ea
35f6 35f6 s 	dw 	_CPM2_r_p_SEC2+1
35f8 35f8 s 	endm
35f8 35f8 s 	dwstore	_CPM2_r_p_DMA2+1	,0xE195 	
35f8 35f8 d 54
35f8 35f8 s 	db 	pW_STORE
35f9 35f9 d 95e1
35f9 35f9 s 	dw 	0xE195
35fb 35fb d e5ea
35fb 35fb s 	dw 	_CPM2_r_p_DMA2+1
35fd 35fd s 	endm
35fd 35fd s 	dwstore	_CPM2_r_p_DSK3+1	,0xE18F 	;readinfo
35fd 35fd d 54
35fd 35fd s 	db 	pW_STORE
35fe 35fe d 8fe1
35fe 35fe s 	dw 	0xE18F
3600 3600 d 82eb
3600 3600 s 	dw 	_CPM2_r_p_DSK3+1
3602 3602 s 	endm
3602 3602 s 
3602 3602 s 	stop 'CPM_1x_89_03_30_RAVI'
3602 3602 d 50
3602 3602 s 	db 	p_STOP
3603 3603 d 43504d5f31785f38395f30335f33305f52415649
3603 3603 s 	db 	'CPM_1x_89_03_30_RAVI'
3617 3617 d 00
3617 3617 s 	db 	0
3618 3618 s 	endm
3618 3618 f out/include-patcher.asm
3618 3618 s 	include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861011.asm"	;  7 images in collection
3618 3618 f generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861011.asm
3618 3618 s _BIOS_MICRODOS_OPTS1_861011:
3618 3618 s 	setMICRODOS
3618 3618 d 56
3618 3618 s 	db 	pSETFLAG_MICRODOS
3619 3619 s 	endm
3619 3619 s 	RQ_OPTS1
3619 3619 d 57
3619 3619 s 	db 	pREQUIRED_OPTS1
361a 361a s 	endm
361a 361a s 	dbpatchmaybe	0xE693	,0x1B	,0x0d
361a 361a d 59
361a 361a s 	db 	pB_MAYBE_PATCH
361b 361b d 93e6
361b 361b s 	dw 	0xE693
361d 361d d 1b0d
361d 361d s 	db 	0x1B,0x0d
361f 361f s 	endm
361f 361f s 	dbpatchmaybe	0xE693+1	,0x45	,0x0d
361f 361f d 59
361f 361f s 	db 	pB_MAYBE_PATCH
3620 3620 d 94e6
3620 3620 s 	dw 	0xE693+1
3622 3622 d 450d
3622 3622 s 	db 	0x45,0x0d
3624 3624 s 	endm
3624 3624 s 	dwpatch	0xE497+1	,0xE627	,MD_READ			
3624 3624 d 51
3624 3624 s 	db 	pW_CHK_PATCH
3625 3625 d 98e4
3625 3625 s 	dw 	0xE497+1
3627 3627 d 27e63efa
3627 3627 s 	dw 	0xE627,MD_READ
362b 362b s 	endm
362b 362b s 	dwpatch	0xE4A0+1	,0xE62A	,MD_WRITE
362b 362b d 51
362b 362b s 	db 	pW_CHK_PATCH
362c 362c d a1e4
362c 362c s 	dw 	0xE4A0+1
362e 362e d 2ae653fa
362e 362e s 	dw 	0xE62A,MD_WRITE
3632 3632 s 	endm
3632 3632 s 	dbpatch	0xEAAE	,0xcd	,0x00
3632 3632 d 52
3632 3632 s 	db 	pB_CHK_PATCH
3633 3633 d aeea
3633 3633 s 	dw 	0xEAAE
3635 3635 d cd00
3635 3635 s 	db 	0xcd,0x00
3637 3637 s 	endm
3637 3637 s 	dwpatch	0xEAAE+1	,0xE9E9	,0x0000
3637 3637 d 51
3637 3637 s 	db 	pW_CHK_PATCH
3638 3638 d afea
3638 3638 s 	dw 	0xEAAE+1
363a 363a d e9e90000
363a 363a s 	dw 	0xE9E9,0x0000
363e 363e s 	endm
363e 363e s 	dwpatch	0xEAB4+1	,0xEC5D	,MD_READ_INFOSECTOR
363e 363e d 51
363e 363e s 	db 	pW_CHK_PATCH
363f 363f d b5ea
363f 363f s 	dw 	0xEAB4+1
3641 3641 d 5dec68fa
3641 3641 s 	dw 	0xEC5D,MD_READ_INFOSECTOR
3645 3645 s 	endm
3645 3645 s 	dwstore	MD_DRV2+1,	0xDFC8
3645 3645 d 54
3645 3645 s 	db 	pW_STORE
3646 3646 d c8df
3646 3646 s 	dw 	0xDFC8
3648 3648 d f3fa
3648 3648 s 	dw 	MD_DRV2+1
364a 364a s 	endm
364a 364a s 	dwstore	MD_RDBUF2+1,	0xEEB0
364a 364a d 54
364a 364a s 	db 	pW_STORE
364b 364b d b0ee
364b 364b s 	dw 	0xEEB0
364d 364d d 02fb
364d 364d s 	dw 	MD_RDBUF2+1
364f 364f s 	endm
364f 364f s 	dwstore	MD_PARAM2+1,	0xDDBC
364f 364f d 54
364f 364f s 	db 	pW_STORE
3650 3650 d bcdd
3650 3650 s 	dw 	0xDDBC
3652 3652 d 1dfa
3652 3652 s 	dw 	MD_PARAM2+1
3654 3654 s 	endm
3654 3654 s 	dwpatch 0xc01b+1	 ,0xDD86	,md_res_seldsk
3654 3654 d 51
3654 3654 s 	db 	pW_CHK_PATCH
3655 3655 d 1cc0
3655 3655 s 	dw 	0xc01b+1
3657 3657 d 86dd0efa
3657 3657 s 	dw 	0xDD86,md_res_seldsk
365b 365b s 	endm
365b 365b s 	dwstore md_old_seld_dsk+1,0xDD86	,0xdd4c
365b 365b d 54
365b 365b s 	db 	pW_STORE
365c 365c d 86dd
365c 365c s 	dw 	0xDD86
365e 365e d 12fa
365e 365e s 	dw 	md_old_seld_dsk+1
3660 3660 s 	endm
3660 3660 s 	;custom checkers
3660 3660 s 	dwpatch	0xBC80	,0xBC80 ,0xBC80
3660 3660 d 51
3660 3660 s 	db 	pW_CHK_PATCH
3661 3661 d 80bc
3661 3661 s 	dw 	0xBC80
3663 3663 d 80bc80bc
3663 3663 s 	dw 	0xBC80,0xBC80
3667 3667 s 	endm
3667 3667 s 	dwpatch	0xBC82	,0xBD00 ,0xBD00
3667 3667 d 51
3667 3667 s 	db 	pW_CHK_PATCH
3668 3668 d 82bc
3668 3668 s 	dw 	0xBC82
366a 366a d 00bd00bd
366a 366a s 	dw 	0xBD00,0xBD00
366e 366e s 	endm
366e 366e s 	dwpatch	0xc000+1	,0xC4BF ,0xC4BF
366e 366e d 51
366e 366e s 	db 	pW_CHK_PATCH
366f 366f d 01c0
366f 366f s 	dw 	0xc000+1
3671 3671 d bfc4bfc4
3671 3671 s 	dw 	0xC4BF,0xC4BF
3675 3675 s 	endm
3675 3675 s 	dwpatch	0xc003+1	,0xDBFB ,0xDBFB
3675 3675 d 51
3675 3675 s 	db 	pW_CHK_PATCH
3676 3676 d 04c0
3676 3676 s 	dw 	0xc003+1
3678 3678 d fbdbfbdb
3678 3678 s 	dw 	0xDBFB,0xDBFB
367c 367c s 	endm
367c 367c s 	dbpatch	0xDF95	,0x50 ,0x50
367c 367c d 52
367c 367c s 	db 	pB_CHK_PATCH
367d 367d d 95df
367d 367d s 	dw 	0xDF95
367f 367f d 5050
367f 367f s 	db 	0x50,0x50
3681 3681 s 	endm
3681 3681 s 	dbpatch	0xDF97	,0x18 ,0x18
3681 3681 d 52
3681 3681 s 	db 	pB_CHK_PATCH
3682 3682 d 97df
3682 3682 s 	dw 	0xDF97
3684 3684 d 1818
3684 3684 s 	db 	0x18,0x18
3686 3686 s 	endm
3686 3686 s 	stop 'MICRODOS_OPTS1_861011'
3686 3686 d 50
3686 3686 s 	db 	p_STOP
3687 3687 d 4d4943524f444f535f4f505453315f383631303131
3687 3687 s 	db 	'MICRODOS_OPTS1_861011'
369c 369c d 00
369c 369c s 	db 	0
369d 369d s 	endm
369d 369d f out/include-patcher.asm
369d 369d s 	include "generator/V0/out/patcher-cpm1-CPM_21_91___LAP.asm"	;  4 images in collection
369d 369d f generator/V0/out/patcher-cpm1-CPM_21_91___LAP.asm
369d 369d s _BIOS_CPM_21_91___LAP:
369d 369d s 	setSUBBIOS 1
369d 369d d 5a
369d 369d s 	db	pSubBios
369e 369e d 01
369e 369e s 	db 	1
369f 369f s 	endm
369f 369f s 	RQ_OPTS_ANY
369f 369f s 	endm
369f 369f s 	setCPM
369f 369f s 	endm
369f 369f s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
369f 369f d 59
369f 369f s 	db 	pB_MAYBE_PATCH
36a0 36a0 d eeda
36a0 36a0 s 	dw 	0xDAEE
36a2 36a2 d 1f0d
36a2 36a2 s 	db 	0x1F,0x0d
36a4 36a4 s 	endm
36a4 36a4 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
36a4 36a4 d 59
36a4 36a4 s 	db 	pB_MAYBE_PATCH
36a5 36a5 d f0da
36a5 36a5 s 	dw 	0xDAEE+2
36a7 36a7 d 0a0d
36a7 36a7 s 	db 	0x0a,0x0d
36a9 36a9 s 	endm
36a9 36a9 s 	dbpatch	0xE0D2+1	,0x49	,0xc9
36a9 36a9 d 52
36a9 36a9 s 	db 	pB_CHK_PATCH
36aa 36aa d d3e0
36aa 36aa s 	dw 	0xE0D2+1
36ac 36ac d 49c9
36ac 36ac s 	db 	0x49,0xc9
36ae 36ae s 	endm
36ae 36ae s 	dbpatch	0xDA88 	,0x01	,0x00
36ae 36ae d 52
36ae 36ae s 	db 	pB_CHK_PATCH
36af 36af d 88da
36af 36af s 	dw 	0xDA88
36b1 36b1 d 0100
36b1 36b1 s 	db 	0x01,0x00
36b3 36b3 s 	endm
36b3 36b3 s 	dbpatch	0xDA9F 	,0x02	,0x00
36b3 36b3 d 52
36b3 36b3 s 	db 	pB_CHK_PATCH
36b4 36b4 d 9fda
36b4 36b4 s 	dw 	0xDA9F
36b6 36b6 d 0200
36b6 36b6 s 	db 	0x02,0x00
36b8 36b8 s 	endm
36b8 36b8 s 	dbpatch	0xDAB6 	,0x04	,0x01
36b8 36b8 d 52
36b8 36b8 s 	db 	pB_CHK_PATCH
36b9 36b9 d b6da
36b9 36b9 s 	dw 	0xDAB6
36bb 36bb d 0401
36bb 36bb s 	db 	0x04,0x01
36bd 36bd s 	endm
36bd 36bd s 	dbpatch	0xDACD 	,0x08	,0x02
36bd 36bd d 52
36bd 36bd s 	db 	pB_CHK_PATCH
36be 36be d cdda
36be 36be s 	dw 	0xDACD
36c0 36c0 d 0802
36c0 36c0 s 	db 	0x08,0x02
36c2 36c2 s 	endm
36c2 36c2 s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
36c2 36c2 d 54
36c2 36c2 s 	db 	pW_STORE
36c3 36c3 d 88da
36c3 36c3 s 	dw 	0xDA88
36c5 36c5 d ace8
36c5 36c5 s 	dw 	_CPM1_res_DRIVE_TAB+0*2
36c7 36c7 s 	endm
36c7 36c7 s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
36c7 36c7 d 54
36c7 36c7 s 	db 	pW_STORE
36c8 36c8 d 9fda
36c8 36c8 s 	dw 	0xDA9F
36ca 36ca d aee8
36ca 36ca s 	dw 	_CPM1_res_DRIVE_TAB+1*2
36cc 36cc s 	endm
36cc 36cc s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
36cc 36cc d 54
36cc 36cc s 	db 	pW_STORE
36cd 36cd d b6da
36cd 36cd s 	dw 	0xDAB6
36cf 36cf d b0e8
36cf 36cf s 	dw 	_CPM1_res_DRIVE_TAB+2*2
36d1 36d1 s 	endm
36d1 36d1 s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
36d1 36d1 d 54
36d1 36d1 s 	db 	pW_STORE
36d2 36d2 d cdda
36d2 36d2 s 	dw 	0xDACD
36d4 36d4 d b2e8
36d4 36d4 s 	dw 	_CPM1_res_DRIVE_TAB+3*2
36d6 36d6 s 	endm
36d6 36d6 s 	dwpatch 0xDCF2+5*2 	,0x0000 ,_CPM1_dph_F
36d6 36d6 d 51
36d6 36d6 s 	db 	pW_CHK_PATCH
36d7 36d7 d fcdc
36d7 36d7 s 	dw 	0xDCF2+5*2
36d9 36d9 d 0000b8e8
36d9 36d9 s 	dw 	0x0000,_CPM1_dph_F
36dd 36dd s 	endm
36dd 36dd s 	dwstore _CPM1_dph_F+8	,0xEBA6
36dd 36dd d 54
36dd 36dd s 	db 	pW_STORE
36de 36de d a6eb
36de 36de s 	dw 	0xEBA6
36e0 36e0 d c0e8
36e0 36e0 s 	dw 	_CPM1_dph_F+8
36e2 36e2 s 	endm
36e2 36e2 s 	dwpatch 0xDA1B+1 	,0xDCAE	,_CPM1_res_seldsk
36e2 36e2 d 51
36e2 36e2 s 	db 	pW_CHK_PATCH
36e3 36e3 d 1cda
36e3 36e3 s 	dw 	0xDA1B+1
36e5 36e5 d aedc11e9
36e5 36e5 s 	dw 	0xDCAE,_CPM1_res_seldsk
36e9 36e9 s 	endm
36e9 36e9 s 	dwstore	_CPM1_old_seld_dsk+1	,0xDCAE
36e9 36e9 d 54
36e9 36e9 s 	db 	pW_STORE
36ea 36ea d aedc
36ea 36ea s 	dw 	0xDCAE
36ec 36ec d 15e9
36ec 36ec s 	dw 	_CPM1_old_seld_dsk+1
36ee 36ee s 	endm
36ee 36ee s 	dbpatch	0xE69F	,0x77	,0x00
36ee 36ee d 52
36ee 36ee s 	db 	pB_CHK_PATCH
36ef 36ef d 9fe6
36ef 36ef s 	dw 	0xE69F
36f1 36f1 d 7700
36f1 36f1 s 	db 	0x77,0x00
36f3 36f3 s 	endm
36f3 36f3 s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFED
36f3 36f3 d 54
36f3 36f3 s 	db 	pW_STORE
36f4 36f4 d eddf
36f4 36f4 s 	dw 	0xDFED
36f6 36f6 d 2ee9
36f6 36f6 s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
36f8 36f8 s 	endm
36f8 36f8 s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFED
36f8 36f8 d 54
36f8 36f8 s 	db 	pW_STORE
36f9 36f9 d eddf
36f9 36f9 s 	dw 	0xDFED
36fb 36fb d 6be9
36fb 36fb s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
36fd 36fd s 	endm
36fd 36fd s 	dwpatch	0xDA27+1	,0xDD11	,_CPM1_res_READ
36fd 36fd d 51
36fd 36fd s 	db 	pW_CHK_PATCH
36fe 36fe d 28da
36fe 36fe s 	dw 	0xDA27+1
3700 3700 d 11dd1be9
3700 3700 s 	dw 	0xDD11,_CPM1_res_READ
3704 3704 s 	endm
3704 3704 s 	dwpatch	0xDA2A+1	,0xDE47	,_CPM1_res_WRITE
3704 3704 d 51
3704 3704 s 	db 	pW_CHK_PATCH
3705 3705 d 2bda
3705 3705 s 	dw 	0xDA2A+1
3707 3707 d 47de58e9
3707 3707 s 	dw 	0xDE47,_CPM1_res_WRITE
370b 370b s 	endm
370b 370b s 	dwpatch	0xDB5F+1	,0xDD11	,_CPM1_res_READ
370b 370b d 51
370b 370b s 	db 	pW_CHK_PATCH
370c 370c d 60db
370c 370c s 	dw 	0xDB5F+1
370e 370e d 11dd1be9
370e 370e s 	dw 	0xDD11,_CPM1_res_READ
3712 3712 s 	endm
3712 3712 s 	dwpatch	0xdce0+1	,0xE5D5	,_CPM1_res_GETINFO
3712 3712 d 51
3712 3712 s 	db 	pW_CHK_PATCH
3713 3713 d e1dc
3713 3713 s 	dw 	0xdce0+1
3715 3715 d d5e595e9
3715 3715 s 	dw 	0xE5D5,_CPM1_res_GETINFO
3719 3719 s 	endm
3719 3719 s 	dwstore	_CPM1__old_read+1	,0xDD11
3719 3719 d 54
3719 3719 s 	db 	pW_STORE
371a 371a d 11dd
371a 371a s 	dw 	0xDD11
371c 371c d 56e9
371c 371c s 	dw 	_CPM1__old_read+1
371e 371e s 	endm
371e 371e s 	dwstore	_CPM1__old_write+1	,0xDE47
371e 371e d 54
371e 371e s 	db 	pW_STORE
371f 371f d 47de
371f 371f s 	dw 	0xDE47
3721 3721 d 93e9
3721 3721 s 	dw 	_CPM1__old_write+1
3723 3723 s 	endm
3723 3723 s 	dwstore	_CPM1__old_getinfo+1	,0xE5D5
3723 3723 d 54
3723 3723 s 	db 	pW_STORE
3724 3724 d d5e5
3724 3724 s 	dw 	0xE5D5
3726 3726 d a3e9
3726 3726 s 	dw 	_CPM1__old_getinfo+1
3728 3728 s 	endm
3728 3728 s 	dbpatch	0xE615		,0x21	,0x21
3728 3728 d 52
3728 3728 s 	db 	pB_CHK_PATCH
3729 3729 d 15e6
3729 3729 s 	dw 	0xE615
372b 372b d 2121
372b 372b s 	db 	0x21,0x21
372d 372d s 	endm
372d 372d s 	dwpatch	0xE615+1 	,0xE645	,0xE645
372d 372d d 51
372d 372d s 	db 	pW_CHK_PATCH
372e 372e d 16e6
372e 372e s 	dw 	0xE615+1
3730 3730 d 45e645e6
3730 3730 s 	dw 	0xE645,0xE645
3734 3734 s 	endm
3734 3734 s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE615
3734 3734 d 54
3734 3734 s 	db 	pW_STORE
3735 3735 d 15e6
3735 3735 s 	dw 	0xE615
3737 3737 d a0e9
3737 3737 s 	dw 	_CPM1__old_getinfo_chkdo+1
3739 3739 s 	endm
3739 3739 s 	dwstore	_CPM1_r_p_DSK1+1	,0xDFE3 	;read
3739 3739 d 54
3739 3739 s 	db 	pW_STORE
373a 373a d e3df
373a 373a s 	dw 	0xDFE3
373c 373c d 1ce9
373c 373c s 	dw 	_CPM1_r_p_DSK1+1
373e 373e s 	endm
373e 373e s 	dwstore	_CPM1_r_p_TRK1+1	,0xDFE7 	
373e 373e d 54
373e 373e s 	db 	pW_STORE
373f 373f d e7df
373f 373f s 	dw 	0xDFE7
3741 3741 d 37e9
3741 3741 s 	dw 	_CPM1_r_p_TRK1+1
3743 3743 s 	endm
3743 3743 s 	dwstore	_CPM1_r_p_SEC1+1	,0xDFE8 	
3743 3743 d 54
3743 3743 s 	db 	pW_STORE
3744 3744 d e8df
3744 3744 s 	dw 	0xDFE8
3746 3746 d 3de9
3746 3746 s 	dw 	_CPM1_r_p_SEC1+1
3748 3748 s 	endm
3748 3748 s 	dwstore	_CPM1_r_p_DMA1+1	,0xDFE9 	
3748 3748 d 54
3748 3748 s 	db 	pW_STORE
3749 3749 d e9df
3749 3749 s 	dw 	0xDFE9
374b 374b d 4ee9
374b 374b s 	dw 	_CPM1_r_p_DMA1+1
374d 374d s 	endm
374d 374d s 	dwstore	_CPM1_r_p_DSK2+1	,0xDFE3 	;write
374d 374d d 54
374d 374d s 	db 	pW_STORE
374e 374e d e3df
374e 374e s 	dw 	0xDFE3
3750 3750 d 59e9
3750 3750 s 	dw 	_CPM1_r_p_DSK2+1
3752 3752 s 	endm
3752 3752 s 	dwstore	_CPM1_r_p_TRK2+1	,0xDFE7 	
3752 3752 d 54
3752 3752 s 	db 	pW_STORE
3753 3753 d e7df
3753 3753 s 	dw 	0xDFE7
3755 3755 d 74e9
3755 3755 s 	dw 	_CPM1_r_p_TRK2+1
3757 3757 s 	endm
3757 3757 s 	dwstore	_CPM1_r_p_SEC2+1	,0xDFE8 	
3757 3757 d 54
3757 3757 s 	db 	pW_STORE
3758 3758 d e8df
3758 3758 s 	dw 	0xDFE8
375a 375a d 7ae9
375a 375a s 	dw 	_CPM1_r_p_SEC2+1
375c 375c s 	endm
375c 375c s 	dwstore	_CPM1_r_p_DMA2+1	,0xDFE9 	
375c 375c d 54
375c 375c s 	db 	pW_STORE
375d 375d d e9df
375d 375d s 	dw 	0xDFE9
375f 375f d 8be9
375f 375f s 	dw 	_CPM1_r_p_DMA2+1
3761 3761 s 	endm
3761 3761 s 	dwstore	_CPM1_r_p_DSK3+1	,0xDFE3 	;readinfo
3761 3761 d 54
3761 3761 s 	db 	pW_STORE
3762 3762 d e3df
3762 3762 s 	dw 	0xDFE3
3764 3764 d 28ea
3764 3764 s 	dw 	_CPM1_r_p_DSK3+1
3766 3766 s 	endm
3766 3766 s 
3766 3766 s 	stop 'CPM_21_91___LAP'
3766 3766 d 50
3766 3766 s 	db 	p_STOP
3767 3767 d 43504d5f32315f39315f5f5f4c4150
3767 3767 s 	db 	'CPM_21_91___LAP'
3776 3776 d 00
3776 3776 s 	db 	0
3777 3777 s 	endm
3777 3777 f out/include-patcher.asm
3777 3777 s 	include "generator/V0/out/patcher-cpm1-CPM_20_88___miks.asm"	;  4 images in collection
3777 3777 f generator/V0/out/patcher-cpm1-CPM_20_88___miks.asm
3777 3777 s _BIOS_CPM_20_88___miks:
3777 3777 s 	setSUBBIOS 1
3777 3777 d 5a
3777 3777 s 	db	pSubBios
3778 3778 d 01
3778 3778 s 	db 	1
3779 3779 s 	endm
3779 3779 s 	RQ_OPTS_ANY
3779 3779 s 	endm
3779 3779 s 	setCPM
3779 3779 s 	endm
3779 3779 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
3779 3779 d 59
3779 3779 s 	db 	pB_MAYBE_PATCH
377a 377a d eeda
377a 377a s 	dw 	0xDAEE
377c 377c d 1f0d
377c 377c s 	db 	0x1F,0x0d
377e 377e s 	endm
377e 377e s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
377e 377e d 59
377e 377e s 	db 	pB_MAYBE_PATCH
377f 377f d f0da
377f 377f s 	dw 	0xDAEE+2
3781 3781 d 0a0d
3781 3781 s 	db 	0x0a,0x0d
3783 3783 s 	endm
3783 3783 s 	dbpatch	0xE3DC+1	,0x49	,0xc9
3783 3783 d 52
3783 3783 s 	db 	pB_CHK_PATCH
3784 3784 d dde3
3784 3784 s 	dw 	0xE3DC+1
3786 3786 d 49c9
3786 3786 s 	db 	0x49,0xc9
3788 3788 s 	endm
3788 3788 s 	dbpatch	0xDA88 	,0x01	,0x00
3788 3788 d 52
3788 3788 s 	db 	pB_CHK_PATCH
3789 3789 d 88da
3789 3789 s 	dw 	0xDA88
378b 378b d 0100
378b 378b s 	db 	0x01,0x00
378d 378d s 	endm
378d 378d s 	dbpatch	0xDA9F 	,0x02	,0x00
378d 378d d 52
378d 378d s 	db 	pB_CHK_PATCH
378e 378e d 9fda
378e 378e s 	dw 	0xDA9F
3790 3790 d 0200
3790 3790 s 	db 	0x02,0x00
3792 3792 s 	endm
3792 3792 s 	dbpatch	0xDAB6 	,0x04	,0x01
3792 3792 d 52
3792 3792 s 	db 	pB_CHK_PATCH
3793 3793 d b6da
3793 3793 s 	dw 	0xDAB6
3795 3795 d 0401
3795 3795 s 	db 	0x04,0x01
3797 3797 s 	endm
3797 3797 s 	dbpatch	0xDACD 	,0x08	,0x02
3797 3797 d 52
3797 3797 s 	db 	pB_CHK_PATCH
3798 3798 d cdda
3798 3798 s 	dw 	0xDACD
379a 379a d 0802
379a 379a s 	db 	0x08,0x02
379c 379c s 	endm
379c 379c s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
379c 379c d 54
379c 379c s 	db 	pW_STORE
379d 379d d 88da
379d 379d s 	dw 	0xDA88
379f 379f d ace8
379f 379f s 	dw 	_CPM1_res_DRIVE_TAB+0*2
37a1 37a1 s 	endm
37a1 37a1 s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
37a1 37a1 d 54
37a1 37a1 s 	db 	pW_STORE
37a2 37a2 d 9fda
37a2 37a2 s 	dw 	0xDA9F
37a4 37a4 d aee8
37a4 37a4 s 	dw 	_CPM1_res_DRIVE_TAB+1*2
37a6 37a6 s 	endm
37a6 37a6 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
37a6 37a6 d 54
37a6 37a6 s 	db 	pW_STORE
37a7 37a7 d b6da
37a7 37a7 s 	dw 	0xDAB6
37a9 37a9 d b0e8
37a9 37a9 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
37ab 37ab s 	endm
37ab 37ab s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
37ab 37ab d 54
37ab 37ab s 	db 	pW_STORE
37ac 37ac d cdda
37ac 37ac s 	dw 	0xDACD
37ae 37ae d b2e8
37ae 37ae s 	dw 	_CPM1_res_DRIVE_TAB+3*2
37b0 37b0 s 	endm
37b0 37b0 s 	dwpatch 0xDCD0+5*2 	,0x0000 ,_CPM1_dph_F
37b0 37b0 d 51
37b0 37b0 s 	db 	pW_CHK_PATCH
37b1 37b1 d dadc
37b1 37b1 s 	dw 	0xDCD0+5*2
37b3 37b3 d 0000b8e8
37b3 37b3 s 	dw 	0x0000,_CPM1_dph_F
37b7 37b7 s 	endm
37b7 37b7 s 	dwstore _CPM1_dph_F+8	,0xEBA6
37b7 37b7 d 54
37b7 37b7 s 	db 	pW_STORE
37b8 37b8 d a6eb
37b8 37b8 s 	dw 	0xEBA6
37ba 37ba d c0e8
37ba 37ba s 	dw 	_CPM1_dph_F+8
37bc 37bc s 	endm
37bc 37bc s 	dwpatch 0xDA1B+1 	,0xDC8C	,_CPM1_res_seldsk
37bc 37bc d 51
37bc 37bc s 	db 	pW_CHK_PATCH
37bd 37bd d 1cda
37bd 37bd s 	dw 	0xDA1B+1
37bf 37bf d 8cdc11e9
37bf 37bf s 	dw 	0xDC8C,_CPM1_res_seldsk
37c3 37c3 s 	endm
37c3 37c3 s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC8C
37c3 37c3 d 54
37c3 37c3 s 	db 	pW_STORE
37c4 37c4 d 8cdc
37c4 37c4 s 	dw 	0xDC8C
37c6 37c6 d 15e9
37c6 37c6 s 	dw 	_CPM1_old_seld_dsk+1
37c8 37c8 s 	endm
37c8 37c8 s 	dbpatch	0xE64F	,0x77	,0x00
37c8 37c8 d 52
37c8 37c8 s 	db 	pB_CHK_PATCH
37c9 37c9 d 4fe6
37c9 37c9 s 	dw 	0xE64F
37cb 37cb d 7700
37cb 37cb s 	db 	0x77,0x00
37cd 37cd s 	endm
37cd 37cd s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFA3
37cd 37cd d 54
37cd 37cd s 	db 	pW_STORE
37ce 37ce d a3df
37ce 37ce s 	dw 	0xDFA3
37d0 37d0 d 2ee9
37d0 37d0 s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
37d2 37d2 s 	endm
37d2 37d2 s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFA3
37d2 37d2 d 54
37d2 37d2 s 	db 	pW_STORE
37d3 37d3 d a3df
37d3 37d3 s 	dw 	0xDFA3
37d5 37d5 d 6be9
37d5 37d5 s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
37d7 37d7 s 	endm
37d7 37d7 s 	dwpatch	0xDA27+1	,0xDCEF	,_CPM1_res_READ
37d7 37d7 d 51
37d7 37d7 s 	db 	pW_CHK_PATCH
37d8 37d8 d 28da
37d8 37d8 s 	dw 	0xDA27+1
37da 37da d efdc1be9
37da 37da s 	dw 	0xDCEF,_CPM1_res_READ
37de 37de s 	endm
37de 37de s 	dwpatch	0xDA2A+1	,0xDE25	,_CPM1_res_WRITE
37de 37de d 51
37de 37de s 	db 	pW_CHK_PATCH
37df 37df d 2bda
37df 37df s 	dw 	0xDA2A+1
37e1 37e1 d 25de58e9
37e1 37e1 s 	dw 	0xDE25,_CPM1_res_WRITE
37e5 37e5 s 	endm
37e5 37e5 s 	dwpatch	0xDB85+1	,0xDCEF	,_CPM1_res_READ
37e5 37e5 d 51
37e5 37e5 s 	db 	pW_CHK_PATCH
37e6 37e6 d 86db
37e6 37e6 s 	dw 	0xDB85+1
37e8 37e8 d efdc1be9
37e8 37e8 s 	dw 	0xDCEF,_CPM1_res_READ
37ec 37ec s 	endm
37ec 37ec s 	dwpatch	0xdcbe+1	,0xE585	,_CPM1_res_GETINFO
37ec 37ec d 51
37ec 37ec s 	db 	pW_CHK_PATCH
37ed 37ed d bfdc
37ed 37ed s 	dw 	0xdcbe+1
37ef 37ef d 85e595e9
37ef 37ef s 	dw 	0xE585,_CPM1_res_GETINFO
37f3 37f3 s 	endm
37f3 37f3 s 	dwstore	_CPM1__old_read+1	,0xDCEF
37f3 37f3 d 54
37f3 37f3 s 	db 	pW_STORE
37f4 37f4 d efdc
37f4 37f4 s 	dw 	0xDCEF
37f6 37f6 d 56e9
37f6 37f6 s 	dw 	_CPM1__old_read+1
37f8 37f8 s 	endm
37f8 37f8 s 	dwstore	_CPM1__old_write+1	,0xDE25
37f8 37f8 d 54
37f8 37f8 s 	db 	pW_STORE
37f9 37f9 d 25de
37f9 37f9 s 	dw 	0xDE25
37fb 37fb d 93e9
37fb 37fb s 	dw 	_CPM1__old_write+1
37fd 37fd s 	endm
37fd 37fd s 	dwstore	_CPM1__old_getinfo+1	,0xE585
37fd 37fd d 54
37fd 37fd s 	db 	pW_STORE
37fe 37fe d 85e5
37fe 37fe s 	dw 	0xE585
3800 3800 d a3e9
3800 3800 s 	dw 	_CPM1__old_getinfo+1
3802 3802 s 	endm
3802 3802 s 	dbpatch	0xE5C5		,0x21	,0x21
3802 3802 d 52
3802 3802 s 	db 	pB_CHK_PATCH
3803 3803 d c5e5
3803 3803 s 	dw 	0xE5C5
3805 3805 d 2121
3805 3805 s 	db 	0x21,0x21
3807 3807 s 	endm
3807 3807 s 	dwpatch	0xE5C5+1 	,0xE5F5	,0xE5F5
3807 3807 d 51
3807 3807 s 	db 	pW_CHK_PATCH
3808 3808 d c6e5
3808 3808 s 	dw 	0xE5C5+1
380a 380a d f5e5f5e5
380a 380a s 	dw 	0xE5F5,0xE5F5
380e 380e s 	endm
380e 380e s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE5C5
380e 380e d 54
380e 380e s 	db 	pW_STORE
380f 380f d c5e5
380f 380f s 	dw 	0xE5C5
3811 3811 d a0e9
3811 3811 s 	dw 	_CPM1__old_getinfo_chkdo+1
3813 3813 s 	endm
3813 3813 s 	dwstore	_CPM1_r_p_DSK1+1	,0xDF99 	;read
3813 3813 d 54
3813 3813 s 	db 	pW_STORE
3814 3814 d 99df
3814 3814 s 	dw 	0xDF99
3816 3816 d 1ce9
3816 3816 s 	dw 	_CPM1_r_p_DSK1+1
3818 3818 s 	endm
3818 3818 s 	dwstore	_CPM1_r_p_TRK1+1	,0xDF9D 	
3818 3818 d 54
3818 3818 s 	db 	pW_STORE
3819 3819 d 9ddf
3819 3819 s 	dw 	0xDF9D
381b 381b d 37e9
381b 381b s 	dw 	_CPM1_r_p_TRK1+1
381d 381d s 	endm
381d 381d s 	dwstore	_CPM1_r_p_SEC1+1	,0xDF9E 	
381d 381d d 54
381d 381d s 	db 	pW_STORE
381e 381e d 9edf
381e 381e s 	dw 	0xDF9E
3820 3820 d 3de9
3820 3820 s 	dw 	_CPM1_r_p_SEC1+1
3822 3822 s 	endm
3822 3822 s 	dwstore	_CPM1_r_p_DMA1+1	,0xDF9F 	
3822 3822 d 54
3822 3822 s 	db 	pW_STORE
3823 3823 d 9fdf
3823 3823 s 	dw 	0xDF9F
3825 3825 d 4ee9
3825 3825 s 	dw 	_CPM1_r_p_DMA1+1
3827 3827 s 	endm
3827 3827 s 	dwstore	_CPM1_r_p_DSK2+1	,0xDF99 	;write
3827 3827 d 54
3827 3827 s 	db 	pW_STORE
3828 3828 d 99df
3828 3828 s 	dw 	0xDF99
382a 382a d 59e9
382a 382a s 	dw 	_CPM1_r_p_DSK2+1
382c 382c s 	endm
382c 382c s 	dwstore	_CPM1_r_p_TRK2+1	,0xDF9D 	
382c 382c d 54
382c 382c s 	db 	pW_STORE
382d 382d d 9ddf
382d 382d s 	dw 	0xDF9D
382f 382f d 74e9
382f 382f s 	dw 	_CPM1_r_p_TRK2+1
3831 3831 s 	endm
3831 3831 s 	dwstore	_CPM1_r_p_SEC2+1	,0xDF9E 	
3831 3831 d 54
3831 3831 s 	db 	pW_STORE
3832 3832 d 9edf
3832 3832 s 	dw 	0xDF9E
3834 3834 d 7ae9
3834 3834 s 	dw 	_CPM1_r_p_SEC2+1
3836 3836 s 	endm
3836 3836 s 	dwstore	_CPM1_r_p_DMA2+1	,0xDF9F 	
3836 3836 d 54
3836 3836 s 	db 	pW_STORE
3837 3837 d 9fdf
3837 3837 s 	dw 	0xDF9F
3839 3839 d 8be9
3839 3839 s 	dw 	_CPM1_r_p_DMA2+1
383b 383b s 	endm
383b 383b s 	dwstore	_CPM1_r_p_DSK3+1	,0xDF99 	;readinfo
383b 383b d 54
383b 383b s 	db 	pW_STORE
383c 383c d 99df
383c 383c s 	dw 	0xDF99
383e 383e d 28ea
383e 383e s 	dw 	_CPM1_r_p_DSK3+1
3840 3840 s 	endm
3840 3840 s 
3840 3840 s 	stop 'CPM_20_88___miks'
3840 3840 d 50
3840 3840 s 	db 	p_STOP
3841 3841 d 43504d5f32305f38385f5f5f6d696b73
3841 3841 s 	db 	'CPM_20_88___miks'
3851 3851 d 00
3851 3851 s 	db 	0
3852 3852 s 	endm
3852 3852 f out/include-patcher.asm
3852 3852 s 	include "generator/V0/out/patcher-cpm1-CPM_12_90_5_kontur.asm"	;  4 images in collection
3852 3852 f generator/V0/out/patcher-cpm1-CPM_12_90_5_kontur.asm
3852 3852 s _BIOS_CPM_12_90_5_kontur:
3852 3852 s 	setSUBBIOS 1
3852 3852 d 5a
3852 3852 s 	db	pSubBios
3853 3853 d 01
3853 3853 s 	db 	1
3854 3854 s 	endm
3854 3854 s 	RQ_OPTS_ANY
3854 3854 s 	endm
3854 3854 s 	setCPM
3854 3854 s 	endm
3854 3854 s 	dbpatchmaybe	0xDAEF	,0x1F	,0x0d
3854 3854 d 59
3854 3854 s 	db 	pB_MAYBE_PATCH
3855 3855 d efda
3855 3855 s 	dw 	0xDAEF
3857 3857 d 1f0d
3857 3857 s 	db 	0x1F,0x0d
3859 3859 s 	endm
3859 3859 s 	dbpatchmaybe	0xDAEF+2	,0x0a	,0x0d
3859 3859 d 59
3859 3859 s 	db 	pB_MAYBE_PATCH
385a 385a d f1da
385a 385a s 	dw 	0xDAEF+2
385c 385c d 0a0d
385c 385c s 	db 	0x0a,0x0d
385e 385e s 	endm
385e 385e s 	dbpatch	0xE09B+1	,0x49	,0xc9
385e 385e d 52
385e 385e s 	db 	pB_CHK_PATCH
385f 385f d 9ce0
385f 385f s 	dw 	0xE09B+1
3861 3861 d 49c9
3861 3861 s 	db 	0x49,0xc9
3863 3863 s 	endm
3863 3863 s 	dbpatch	0xDA88 	,0x01	,0x00
3863 3863 d 52
3863 3863 s 	db 	pB_CHK_PATCH
3864 3864 d 88da
3864 3864 s 	dw 	0xDA88
3866 3866 d 0100
3866 3866 s 	db 	0x01,0x00
3868 3868 s 	endm
3868 3868 s 	dbpatch	0xDA9F 	,0x02	,0x00
3868 3868 d 52
3868 3868 s 	db 	pB_CHK_PATCH
3869 3869 d 9fda
3869 3869 s 	dw 	0xDA9F
386b 386b d 0200
386b 386b s 	db 	0x02,0x00
386d 386d s 	endm
386d 386d s 	dbpatch	0xDAB6 	,0x04	,0x01
386d 386d d 52
386d 386d s 	db 	pB_CHK_PATCH
386e 386e d b6da
386e 386e s 	dw 	0xDAB6
3870 3870 d 0401
3870 3870 s 	db 	0x04,0x01
3872 3872 s 	endm
3872 3872 s 	dbpatch	0xDACD 	,0x08	,0x02
3872 3872 d 52
3872 3872 s 	db 	pB_CHK_PATCH
3873 3873 d cdda
3873 3873 s 	dw 	0xDACD
3875 3875 d 0802
3875 3875 s 	db 	0x08,0x02
3877 3877 s 	endm
3877 3877 s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
3877 3877 d 54
3877 3877 s 	db 	pW_STORE
3878 3878 d 88da
3878 3878 s 	dw 	0xDA88
387a 387a d ace8
387a 387a s 	dw 	_CPM1_res_DRIVE_TAB+0*2
387c 387c s 	endm
387c 387c s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
387c 387c d 54
387c 387c s 	db 	pW_STORE
387d 387d d 9fda
387d 387d s 	dw 	0xDA9F
387f 387f d aee8
387f 387f s 	dw 	_CPM1_res_DRIVE_TAB+1*2
3881 3881 s 	endm
3881 3881 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
3881 3881 d 54
3881 3881 s 	db 	pW_STORE
3882 3882 d b6da
3882 3882 s 	dw 	0xDAB6
3884 3884 d b0e8
3884 3884 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
3886 3886 s 	endm
3886 3886 s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
3886 3886 d 54
3886 3886 s 	db 	pW_STORE
3887 3887 d cdda
3887 3887 s 	dw 	0xDACD
3889 3889 d b2e8
3889 3889 s 	dw 	_CPM1_res_DRIVE_TAB+3*2
388b 388b s 	endm
388b 388b s 	dwpatch 0xDCB6+5*2 	,0x0000 ,_CPM1_dph_F
388b 388b d 51
388b 388b s 	db 	pW_CHK_PATCH
388c 388c d c0dc
388c 388c s 	dw 	0xDCB6+5*2
388e 388e d 0000b8e8
388e 388e s 	dw 	0x0000,_CPM1_dph_F
3892 3892 s 	endm
3892 3892 s 	dwstore _CPM1_dph_F+8	,0xEBA6
3892 3892 d 54
3892 3892 s 	db 	pW_STORE
3893 3893 d a6eb
3893 3893 s 	dw 	0xEBA6
3895 3895 d c0e8
3895 3895 s 	dw 	_CPM1_dph_F+8
3897 3897 s 	endm
3897 3897 s 	dwpatch 0xDA1B+1 	,0xDC72	,_CPM1_res_seldsk
3897 3897 d 51
3897 3897 s 	db 	pW_CHK_PATCH
3898 3898 d 1cda
3898 3898 s 	dw 	0xDA1B+1
389a 389a d 72dc11e9
389a 389a s 	dw 	0xDC72,_CPM1_res_seldsk
389e 389e s 	endm
389e 389e s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC72
389e 389e d 54
389e 389e s 	db 	pW_STORE
389f 389f d 72dc
389f 389f s 	dw 	0xDC72
38a1 38a1 d 15e9
38a1 38a1 s 	dw 	_CPM1_old_seld_dsk+1
38a3 38a3 s 	endm
38a3 38a3 s 	dbpatch	0xE6C0	,0x77	,0x00
38a3 38a3 d 52
38a3 38a3 s 	db 	pB_CHK_PATCH
38a4 38a4 d c0e6
38a4 38a4 s 	dw 	0xE6C0
38a6 38a6 d 7700
38a6 38a6 s 	db 	0x77,0x00
38a8 38a8 s 	endm
38a8 38a8 s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFB6
38a8 38a8 d 54
38a8 38a8 s 	db 	pW_STORE
38a9 38a9 d b6df
38a9 38a9 s 	dw 	0xDFB6
38ab 38ab d 2ee9
38ab 38ab s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
38ad 38ad s 	endm
38ad 38ad s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFB6
38ad 38ad d 54
38ad 38ad s 	db 	pW_STORE
38ae 38ae d b6df
38ae 38ae s 	dw 	0xDFB6
38b0 38b0 d 6be9
38b0 38b0 s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
38b2 38b2 s 	endm
38b2 38b2 s 	dwpatch	0xDA27+1	,0xDCD5	,_CPM1_res_READ
38b2 38b2 d 51
38b2 38b2 s 	db 	pW_CHK_PATCH
38b3 38b3 d 28da
38b3 38b3 s 	dw 	0xDA27+1
38b5 38b5 d d5dc1be9
38b5 38b5 s 	dw 	0xDCD5,_CPM1_res_READ
38b9 38b9 s 	endm
38b9 38b9 s 	dwpatch	0xDA2A+1	,0xDE22	,_CPM1_res_WRITE
38b9 38b9 d 51
38b9 38b9 s 	db 	pW_CHK_PATCH
38ba 38ba d 2bda
38ba 38ba s 	dw 	0xDA2A+1
38bc 38bc d 22de58e9
38bc 38bc s 	dw 	0xDE22,_CPM1_res_WRITE
38c0 38c0 s 	endm
38c0 38c0 s 	dwpatch	0xDB6B+1	,0xDCD5	,_CPM1_res_READ
38c0 38c0 d 51
38c0 38c0 s 	db 	pW_CHK_PATCH
38c1 38c1 d 6cdb
38c1 38c1 s 	dw 	0xDB6B+1
38c3 38c3 d d5dc1be9
38c3 38c3 s 	dw 	0xDCD5,_CPM1_res_READ
38c7 38c7 s 	endm
38c7 38c7 s 	dwpatch	0xdca4+1	,0xE5F6	,_CPM1_res_GETINFO
38c7 38c7 d 51
38c7 38c7 s 	db 	pW_CHK_PATCH
38c8 38c8 d a5dc
38c8 38c8 s 	dw 	0xdca4+1
38ca 38ca d f6e595e9
38ca 38ca s 	dw 	0xE5F6,_CPM1_res_GETINFO
38ce 38ce s 	endm
38ce 38ce s 	dwstore	_CPM1__old_read+1	,0xDCD5
38ce 38ce d 54
38ce 38ce s 	db 	pW_STORE
38cf 38cf d d5dc
38cf 38cf s 	dw 	0xDCD5
38d1 38d1 d 56e9
38d1 38d1 s 	dw 	_CPM1__old_read+1
38d3 38d3 s 	endm
38d3 38d3 s 	dwstore	_CPM1__old_write+1	,0xDE22
38d3 38d3 d 54
38d3 38d3 s 	db 	pW_STORE
38d4 38d4 d 22de
38d4 38d4 s 	dw 	0xDE22
38d6 38d6 d 93e9
38d6 38d6 s 	dw 	_CPM1__old_write+1
38d8 38d8 s 	endm
38d8 38d8 s 	dwstore	_CPM1__old_getinfo+1	,0xE5F6
38d8 38d8 d 54
38d8 38d8 s 	db 	pW_STORE
38d9 38d9 d f6e5
38d9 38d9 s 	dw 	0xE5F6
38db 38db d a3e9
38db 38db s 	dw 	_CPM1__old_getinfo+1
38dd 38dd s 	endm
38dd 38dd s 	dbpatch	0xE636		,0x21	,0x21
38dd 38dd d 52
38dd 38dd s 	db 	pB_CHK_PATCH
38de 38de d 36e6
38de 38de s 	dw 	0xE636
38e0 38e0 d 2121
38e0 38e0 s 	db 	0x21,0x21
38e2 38e2 s 	endm
38e2 38e2 s 	dwpatch	0xE636+1 	,0xE666	,0xE666
38e2 38e2 d 51
38e2 38e2 s 	db 	pW_CHK_PATCH
38e3 38e3 d 37e6
38e3 38e3 s 	dw 	0xE636+1
38e5 38e5 d 66e666e6
38e5 38e5 s 	dw 	0xE666,0xE666
38e9 38e9 s 	endm
38e9 38e9 s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE636
38e9 38e9 d 54
38e9 38e9 s 	db 	pW_STORE
38ea 38ea d 36e6
38ea 38ea s 	dw 	0xE636
38ec 38ec d a0e9
38ec 38ec s 	dw 	_CPM1__old_getinfo_chkdo+1
38ee 38ee s 	endm
38ee 38ee s 	dwstore	_CPM1_r_p_DSK1+1	,0xDFAC 	;read
38ee 38ee d 54
38ee 38ee s 	db 	pW_STORE
38ef 38ef d acdf
38ef 38ef s 	dw 	0xDFAC
38f1 38f1 d 1ce9
38f1 38f1 s 	dw 	_CPM1_r_p_DSK1+1
38f3 38f3 s 	endm
38f3 38f3 s 	dwstore	_CPM1_r_p_TRK1+1	,0xDFB0 	
38f3 38f3 d 54
38f3 38f3 s 	db 	pW_STORE
38f4 38f4 d b0df
38f4 38f4 s 	dw 	0xDFB0
38f6 38f6 d 37e9
38f6 38f6 s 	dw 	_CPM1_r_p_TRK1+1
38f8 38f8 s 	endm
38f8 38f8 s 	dwstore	_CPM1_r_p_SEC1+1	,0xDFB1 	
38f8 38f8 d 54
38f8 38f8 s 	db 	pW_STORE
38f9 38f9 d b1df
38f9 38f9 s 	dw 	0xDFB1
38fb 38fb d 3de9
38fb 38fb s 	dw 	_CPM1_r_p_SEC1+1
38fd 38fd s 	endm
38fd 38fd s 	dwstore	_CPM1_r_p_DMA1+1	,0xDFB2 	
38fd 38fd d 54
38fd 38fd s 	db 	pW_STORE
38fe 38fe d b2df
38fe 38fe s 	dw 	0xDFB2
3900 3900 d 4ee9
3900 3900 s 	dw 	_CPM1_r_p_DMA1+1
3902 3902 s 	endm
3902 3902 s 	dwstore	_CPM1_r_p_DSK2+1	,0xDFAC 	;write
3902 3902 d 54
3902 3902 s 	db 	pW_STORE
3903 3903 d acdf
3903 3903 s 	dw 	0xDFAC
3905 3905 d 59e9
3905 3905 s 	dw 	_CPM1_r_p_DSK2+1
3907 3907 s 	endm
3907 3907 s 	dwstore	_CPM1_r_p_TRK2+1	,0xDFB0 	
3907 3907 d 54
3907 3907 s 	db 	pW_STORE
3908 3908 d b0df
3908 3908 s 	dw 	0xDFB0
390a 390a d 74e9
390a 390a s 	dw 	_CPM1_r_p_TRK2+1
390c 390c s 	endm
390c 390c s 	dwstore	_CPM1_r_p_SEC2+1	,0xDFB1 	
390c 390c d 54
390c 390c s 	db 	pW_STORE
390d 390d d b1df
390d 390d s 	dw 	0xDFB1
390f 390f d 7ae9
390f 390f s 	dw 	_CPM1_r_p_SEC2+1
3911 3911 s 	endm
3911 3911 s 	dwstore	_CPM1_r_p_DMA2+1	,0xDFB2 	
3911 3911 d 54
3911 3911 s 	db 	pW_STORE
3912 3912 d b2df
3912 3912 s 	dw 	0xDFB2
3914 3914 d 8be9
3914 3914 s 	dw 	_CPM1_r_p_DMA2+1
3916 3916 s 	endm
3916 3916 s 	dwstore	_CPM1_r_p_DSK3+1	,0xDFAC 	;readinfo
3916 3916 d 54
3916 3916 s 	db 	pW_STORE
3917 3917 d acdf
3917 3917 s 	dw 	0xDFAC
3919 3919 d 28ea
3919 3919 s 	dw 	_CPM1_r_p_DSK3+1
391b 391b s 	endm
391b 391b s 
391b 391b s 	stop 'CPM_12_90_5_kontur'
391b 391b d 50
391b 391b s 	db 	p_STOP
391c 391c d 43504d5f31325f39305f355f6b6f6e747572
391c 391c s 	db 	'CPM_12_90_5_kontur'
392e 392e d 00
392e 392e s 	db 	0
392f 392f s 	endm
392f 392f f out/include-patcher.asm
392f 392f s 	include "generator/V0/out/patcher-microdos-MICRODOS_OPTS2_900105.asm"	;  4 images in collection
392f 392f f generator/V0/out/patcher-microdos-MICRODOS_OPTS2_900105.asm
392f 392f s _BIOS_MICRODOS_OPTS2_900105:
392f 392f s 	
392f 392f s 	setMICRODOS
392f 392f d 56
392f 392f s 	db 	pSETFLAG_MICRODOS
3930 3930 s 	endm
3930 3930 s 	RQ_OPTS_ANY
3930 3930 s 	endm
3930 3930 s 
3930 3930 s 	;BIOS_LOAD_ADDR-------------------------------------------------------------------
3930 3930 s 	;BIOS_START_ADDR
3930 3930 s 	;правилнее проверять прямо в 8000 ????
3930 3930 s 	;копия бутсектора из 8000, 
3930 3930 s 	;
3930 3930 s 	;адресс загрузки, куда биос загружает сектора с диска
3930 3930 s 	;	dwpatch	0xBD80,	0xBD80, 0xBD80
3930 3930 s 	;адресс старта, куда биос передаёт управление
3930 3930 s 	;	dwpatch	0xBD82,	0xBE00,	0xBE00
3930 3930 s 
3930 3930 s 	
3930 3930 s 	;BDOS_ENTRY_POINT---------------------------------------------------------
3930 3930 s 	;BDOS_ENTRY_POINT2
3930 3930 s 	;значение перехода, проверяим их для надёжности
3930 3930 s 	;0005 jp c000
3930 3930 s 	;RAM:C000          _BDOS:                                  
3930 3930 s 	;RAM:C000                                                  
3930 3930 s 	;RAM:C000 C3 87 C4                 jp      loc_C487
3930 3930 s 	;RAM:C003 C3 C0 DB                 jp      loc_DBC0
3930 3930 s 	; 	dwpatch	0xc000+1,0xC487,0xC487
3930 3930 s 	; 	dwpatch	0xc003+1,0xDBC0,0xDBC0
3930 3930 s 
3930 3930 s 	;BIOS_LOGO_ADDR--------------------------------------------------------------
3930 3930 s 	;косметика,  
3930 3930 s 	;Биос при старте очищает экран, мы патчим его чтобы он это не делал
3930 3930 s 	;иначе он затрёт все сообщения патчера, а там много полезной информации
3930 3930 s 	;выгядит это в коде так
3930 3930 s 	;это значение там только во время старта, дальше там буфер .....
3930 3930 s 
3930 3930 s 	; RAM:F04E 1B 45 EB+BOOT_LOGO:      text "koi8-r", '\\x1BКОРВЕТ ПК8020\\r\\n'
3930 3930 s 	; RAM:F04E E5 F4 20+                text "koi8-r", 'НИИСЧЁТМАШ 01.05.90\\r\\n'
3930 3930 s 	; RAM:F04E F0 EB 38+                text "koi8-r", '$'
3930 3930 s 	dbpatchmaybe	0xF04E	,0x1B	,0x0d
3930 3930 d 59
3930 3930 s 	db 	pB_MAYBE_PATCH
3931 3931 d 4ef0
3931 3931 s 	dw 	0xF04E
3933 3933 d 1b0d
3933 3933 s 	db 	0x1B,0x0d
3935 3935 s 	endm
3935 3935 s 	dbpatchmaybe	0xF04E+1	,0x45	,0x0d
3935 3935 d 59
3935 3935 s 	db 	pB_MAYBE_PATCH
3936 3936 d 4ff0
3936 3936 s 	dw 	0xF04E+1
3938 3938 d 450d
3938 3938 s 	db 	0x45,0x0d
393a 393a s 	endm
393a 393a s 
393a 393a s 	;JP_READ-----------------------------------------------------------------------
393a 393a s 	;JP_WRITE
393a 393a s 	; перехватываем обращение к чтению/записи в биос
393a 393a s 	; подменяем адресса для чтения/записи
393a 393a s 	; собственно во всех это куче кода нас интересует адресса EAFF и EB04
393a 393a s 	
393a 393a s 	; точки входа обычного биоса
393a 393a s 	; RAM:C027 C3 7B DD                 jp      do_READ
393a 393a s 	; RAM:C02A C3 78 DD                 jp      do_WRITE
393a 393a s 	;.....
393a 393a s 	; RAM:DD78          do_WRITE:                               
393a 393a s 	; RAM:DD78 3E 06                    ld      a, 6
393a 393a s 	; RAM:DD7A 21                       db 21h
393a 393a s 	; RAM:DD7B          do_READ:                                
393a 393a s 	; RAM:DD7B                                                  
393a 393a s 	; RAM:DD7B 3E 04                    ld      a, 4
393a 393a s 	; RAM:DD7D 32 1D DF                 ld      (dsk_description.Fucntion), a
393a 393a s 	; RAM:DD80 21 1B DF                 ld      hl, dsk_description
393a 393a s 	; RAM:DD83 C3 12 E4                 jp      RW_DISK
393a 393a s 	; ...
393a 393a s 	; RAM:E412          RW_DISK:                                
393a 393a s 	; RAM:E412                                                  
393a 393a s 	; RAM:E412 C3 A5 EA                 jp      j_DSKIO
393a 393a s 
393a 393a s 	; RAM:EAA5          j_DSKIO:                                
393a 393a s 	; RAM:EAA5 3A 03 F7                 ld      a, (SysCOPY)
393a 393a s 	; RAM:EAA8 F5                       push    af
393a 393a s 	; RAM:EAA9 EB                       ex      de, hl
393a 393a s 	; RAM:EAAA 06 5C                    ld      b, 5Ch ; '\'
393a 393a s 	; RAM:EAAC CD 9F E4                 call    setSYSREG
393a 393a s 	; RAM:EAAF EB                       ex      de, hl
393a 393a s 	; RAM:EAB0 CD BF EA                 call    do_DSKIO
393a 393a s 	; RAM:EAB3 47                       ld      b, a
393a 393a s 	; RAM:EAB4 F1                       pop     af
393a 393a s 	; RAM:EAB5 F3                       di
393a 393a s 	; RAM:EAB6 32 7F FF                 ld      (_5C_SysReg1C), a
393a 393a s 	; RAM:EAB9 32 03 F7                 ld      (SysCOPY), a
393a 393a s 	; RAM:EABC FB                       ei
393a 393a s 	; RAM:EABD 78                       ld      a, b
393a 393a s 	; RAM:EABE C9                       ret
393a 393a s 	; ....
393a 393a s 	; RAM:EABF          do_DSKIO:                               
393a 393a s 	; RAM:EABF 79                       ld      a, c
393a 393a s 	; RAM:EAC0 32 F7 EE                 ld      (DSK_IO_WriteType), a ; 0       (normal sector write)
393a 393a s 	; RAM:EAC0                                                  ; 1       (write to directory sector)
393a 393a s 	; RAM:EAC0                                                  ; 2       (write to the first sector of a new data block)
393a 393a s 	; RAM:EAC3 22 F8 EE                 ld      (DSC_IO_HL), hl ; DSCDESCR
393a 393a s 	; RAM:EAC6          ;
393a 393a s 	; RAM:EAC6 3A F6 EE                 ld      a, (E_DRIVE_FLAG)
393a 393a s 	; RAM:EAC9 A6                       and     (hl)            ; DRIVE?
393a 393a s 	; RAM:EACA FE 04                    cp      4
393a 393a s 	; RAM:EACC CA 80 FC                 jp      z, E_DRIVE
393a 393a s 	; RAM:EACF          ;
393a 393a s 	; RAM:EACF 7E                       ld      a, (hl)
393a 393a s 	; RAM:EAD0 FE 02                    cp      2
393a 393a s 	; RAM:EAD2 D2 07 EB                 jp      nc, invalidDrive
393a 393a s 	; RAM:EAD5          ;
393a 393a s 	; ....
393a 393a s 	; RAM:EAFA 22 FA EE                 ld      (_DMA??), hl
393a 393a s 	; RAM:EAFD FE 04                    cp      4
393a 393a s 	; RAM:EAFF CA 36 EB                 jp      z, jREAD
393a 393a s 	; RAM:EB02 FE 06                    cp      6
393a 393a s 	; RAM:EB04 CA A0 EB                 jp      z, jWRITE
393a 393a s 	; RAM:EB07
393a 393a s 	; RAM:EB07          invalidDrive:                           
393a 393a s 	; RAM:EB07                                                  
393a 393a s 	; RAM:EB07 3E FF                    ld      a, 0FFh
393a 393a s 	; RAM:EB09 C9                       ret
393a 393a s 
393a 393a s 	; а так как пока в резиденте нет поддержки работы с реальными дисками то 
393a 393a s 	; адресса оригинальных пока не сохраняем к себе ....
393a 393a s 	; TODO: microdos real disk support
393a 393a s 
393a 393a s 	dwpatch	0xEAFF+1	,0xEB36	,MD_READ			
393a 393a d 51
393a 393a s 	db 	pW_CHK_PATCH
393b 393b d 00eb
393b 393b s 	dw 	0xEAFF+1
393d 393d d 36eb3efa
393d 393d s 	dw 	0xEB36,MD_READ
3941 3941 s 	endm
3941 3941 s 	dwpatch	0xEB04+1	,0xEBA0	,MD_WRITE
3941 3941 d 51
3941 3941 s 	db 	pW_CHK_PATCH
3942 3942 d 05eb
3942 3942 s 	dw 	0xEB04+1
3944 3944 d a0eb53fa
3944 3944 s 	dw 	0xEBA0,MD_WRITE
3948 3948 s 	endm
3948 3948 s 
3948 3948 s 	;GET_INFO_FDC_SEEK -------------------------------------------------------------
3948 3948 s 	;GET_INFO_CALL_READ
3948 3948 s 	;кусок GET_INFO_C, подменяем чтение инфосектора
3948 3948 s 	; RAM:EC56          GET_INFO_C:                             ; CODE XREF: jGetDPH_Addr+29p
3948 3948 s 	; RAM:EC56 79                       ld      a, c            ; drive
3948 3948 s 	; RAM:EC57 B7                       or      a
3948 3948 s 	; RAM:EC58 3A 93 E6                 ld      a, (dsk_info_a.intiFlag)
3948 3948 s 	; RAM:EC5B CA 61 EC                 jp      z, loc_EC61
3948 3948 s 	; RAM:EC61
3948 3948 s 	;....
3948 3948 s 	; RAM:EC86 2B                       dec     hl
3948 3948 s 	; RAM:EC87 CD 14 EE                 call    SEL_DSK_SEEK0
3948 3948 s 	; RAM:EC8A CD 1E EE                 call    ReadToRDBUF
3948 3948 s 	; RAM:EC8D          ;
3948 3948 s 	; RAM:EC8D 3E 04                    ld      a, 4
3948 3948 s 	; RAM:EC8F 32 FF EE                 ld      (DSK_TRY_Count), a
3948 3948 s 
3948 3948 s 	; для начала удаляем комманду которая готовит чтение с физичесского дисковода
3948 3948 s 	dbpatch	0xEC87	,0xcd	,0x00
3948 3948 d 52
3948 3948 s 	db 	pB_CHK_PATCH
3949 3949 d 87ec
3949 3949 s 	dw 	0xEC87
394b 394b d cd00
394b 394b s 	db 	0xcd,0x00
394d 394d s 	endm
394d 394d s 	dwpatch	0xEC87+1	,0xEE14	,0x0000
394d 394d d 51
394d 394d s 	db 	pW_CHK_PATCH
394e 394e d 88ec
394e 394e s 	dw 	0xEC87+1
3950 3950 d 14ee0000
3950 3950 s 	dw 	0xEE14,0x0000
3954 3954 s 	endm
3954 3954 s 
3954 3954 s 	;GET_INFO_CALL_READ------------------------------------------------------
3954 3954 s 	;подменяем чтение сектора с диска на нашу функцию
3954 3954 s 	dwpatch	0xEC8A+1	,0xEE1E	,MD_READ_INFOSECTOR
3954 3954 d 51
3954 3954 s 	db 	pW_CHK_PATCH
3955 3955 d 8bec
3955 3955 s 	dw 	0xEC8A+1
3957 3957 d 1eee68fa
3957 3957 s 	dw 	0xEE1E,MD_READ_INFOSECTOR
395b 395b s 	endm
395b 395b s 
395b 395b s 	;DISKINFO_DRIVE--------------------------------------------------------------------------------
395b 395b s 	;эти два адресса нужны для DISKINFO
395b 395b s 	;rdBufDiskInfo - это очередной блок параметров, по нужному адрессу там текущий диск для операции DISKINFO
395b 395b s 	; в примере ниже чтение нашего байта по адрессу 0xED82
395b 395b s 	; а собственно адресс по адрессу 0xEB7E (значение 0xEF06)
395b 395b s 	; RAM:EB36          jREAD:                                  
395b 395b s 	; RAM:EB36 2A F8 EE                 ld      hl, (DSC_IO_HL) 
395b 395b s 	; ...
395b 395b s 	; RAM:EB7E          ;
395b 395b s 	; RAM:EB7E 21 06 EF                 ld      hl, rdBufDiskInfo
395b 395b s 	; RAM:EB81 CD 7D ED                 call    FDD_Setup
395b 395b s 	; ...
395b 395b s 	; RAM:ED7D          FDD_Setup:                              
395b 395b s 	; RAM:ED7D                                                  
395b 395b s 	; RAM:ED7D 3E D0                    ld      a, FDC_3_FORCE_STOP
395b 395b s 	; RAM:ED7F 32 18 FE                 ld      (_5C_FDC_Cmd), a
395b 395b s 	; RAM:ED82          ;
395b 395b s 	; RAM:ED82 7E                       ld      a, (hl)         ; drive
395b 395b s 	; RAM:ED83 B7                       or      a
395b 395b s 	; RAM:ED84 06 01                    ld      b, 1
395b 395b s 	; RAM:ED86 CA 8B ED                 jp      z, loc_ED8B
395b 395b s 
395b 395b s 	dwstore	MD_DRV2+1,	0xEF06
395b 395b d 54
395b 395b s 	db 	pW_STORE
395c 395c d 06ef
395c 395c s 	dw 	0xEF06
395e 395e d f3fa
395e 395e s 	dw 	MD_DRV2+1
3960 3960 s 	endm
3960 3960 s 
3960 3960 s 	;DISKINFO_READ_BUFFER--------------------------------------------------------------------------
3960 3960 s 	;BUF_RD_1k
3960 3960 s 	;адресс буфера кудв мы читаем 0й сектор а дальше уже старый код в биосе
3960 3960 s 	;делает всё остальное
3960 3960 s 	; тут он присутсвует по адрессу 0xEC97 (значение 0xF04E)
3960 3960 s 	; собственно это подсчёт Контрольной суммы
3960 3960 s 	; RAM:EC56          GET_INFO_C:                             
3960 3960 s 	; RAM:EC56 79                       ld      a, c            
3960 3960 s 	; RAM:EC57 B7                       or      a
3960 3960 s 	; RAM:EC58 3A 93 E6                 ld      a, (dsk_info_a.intiFlag)
3960 3960 s 	; RAM:EC5B CA 61 EC                 jp      z, loc_EC61
3960 3960 s 	; RAM:EC5E 3A 97 E6                 ld      a, (dsk_info_b.intiFlag)
3960 3960 s 	; RAM:EC61
3960 3960 s 	; RAM:EC61          loc_EC61:                               
3960 3960 s 	; RAM:EC61 B7                       or      a
3960 3960 s 	; RAM:EC62 C2 EC EC                 jp      nz, diskAlreadyInit
3960 3960 s 	; RAM:EC65          ;
3960 3960 s 	; ...
3960 3960 s 	; RAM:EC97          ;
3960 3960 s 	; RAM:EC97 21 4E F0                 ld      hl, BUF_RD_1k
3960 3960 s 	; RAM:EC9A 0E 1F                    ld      c, 1Fh
3960 3960 s 	; RAM:EC9C 3E 66                    ld      a, 66h ; 'f'
3960 3960 s 	; RAM:EC9E
3960 3960 s 	; RAM:EC9E          CalcCRC_Loop:                           
3960 3960 s 	; RAM:EC9E 86                       add     a, (hl)
3960 3960 s 	; RAM:EC9F 23                       inc     hl
3960 3960 s 	; RAM:ECA0 0D                       dec     c
3960 3960 s 	; RAM:ECA1 C2 9E EC                 jp      nz, CalcCRC_Loop
3960 3960 s 	; RAM:ECA4 BE                       cp      (hl)
3960 3960 s 	; RAM:ECA5          ;
3960 3960 s 	; RAM:ECA5 3E 02                    ld      a, 2            ; CRC Error
3960 3960 s 	; RAM:ECA7 C0                       ret     nz
3960 3960 s 
3960 3960 s 	dwstore	MD_RDBUF2+1,	0xF04E
3960 3960 d 54
3960 3960 s 	db 	pW_STORE
3961 3961 d 4ef0
3961 3961 s 	dw 	0xF04E
3963 3963 d 02fb
3963 3963 s 	dw 	MD_RDBUF2+1
3965 3965 s 	endm
3965 3965 s 	
3965 3965 s 	;DISK_IO_PARAM_BLOCK_ADDR------------------------------------------------------------------------
3965 3965 s 	;адресс таблички с параметрами дисководой операции
3965 3965 s 	;dsk,trk,sec,dma берутся тут
3965 3965 s 	;DSC_IO_HL
3965 3965 s 	dwstore	MD_PARAM2+1,	0xEEF8
3965 3965 d 54
3965 3965 s 	db 	pW_STORE
3966 3966 d f8ee
3966 3966 s 	dw 	0xEEF8
3968 3968 d 1dfa
3968 3968 s 	dw 	MD_PARAM2+1
396a 396a s 	endm
396a 396a s 
396a 396a s 	;DISABLE_DISK_CHECK------------------------------------------------------------------------------
396a 396a s 	;убираем проверку в биосе на наличие дисководов
396a 396a s 	; RAM:BE00          _BOOT:                                  
396a 396a s 	; RAM:BE00                                                  
396a 396a s 	; RAM:BE00 F3                       di
396a 396a s 	; RAM:BE01 31 00 BE                 ld      sp, 0BE00h
396a 396a s 	; RAM:BE04 3A 01 F7                 ld      a, (FDDFLAG)
396a 396a s 	; RAM:BE07 E6 02                    and     2
396a 396a s 	; RAM:BE09 C2 40 00                 jp      nz, R_RunBasic??	
396a 396a s 	;dbpatch 0xbe07+1	,0x02	,0x00
396a 396a s 	
396a 396a s 	;FLUSH_WRITE_ADDR-------------------------------------------------------------------------------
396a 396a s 	; FLUSH нам не нужен, т.к. наша запись идёт без буферезации.
396a 396a s 	; TODO: JP invalidateWRBUF ???
396a 396a s 	; RAM:EC3A          Flush?:                                 
396a 396a s 	; RAM:EC3A                                                  
396a 396a s 	; RAM:EC3A 21 FD EE                 ld      hl, flagWriteReuired?
396a 396a s 	; RAM:EC3D 7E                       ld      a, (hl)
396a 396a s 	; RAM:EC3E B7                       or      a
396a 396a s 	; RAM:EC3F C8                       ret     z
396a 396a s 	; RAM:EC40          ;
396a 396a s 	; RAM:EC40 36 00                    ld      (hl), 0
396a 396a s 	; RAM:EC42          ;
396a 396a s 	; RAM:EC42 21 0A EF                 ld      hl, WrBufDiskInfo
396a 396a s 	; RAM:EC45 CD 7D ED                 call    FDD_Setup
396a 396a s 	; RAM:EC48          ;
396a 396a s 	; RAM:EC48 CD 66 EE                 call    FDD_Write
396a 396a s 	; RAM:EC4B C8                       ret     z
396a 396a s 	; RAM:EC4C          invalidateWRBUF:                        
396a 396a s 	; RAM:EC4C                                                  
396a 396a s 	; RAM:EC4C 21 0A EF                 ld      hl, WrBufDiskInfo
396a 396a s 	; RAM:EC4F 36 FF                    ld      (hl), 0FFh
396a 396a s 	; RAM:EC51 C9                       ret	
396a 396a s 	;dbpatch 0xEC42		,0x21	,0xC9
396a 396a s 
396a 396a s 	;SELDSK_ADDR------------------------------------------------------------
396a 396a s 	;и модифицируем вызов SELDSK чтобы он поддерживал дополнительную проверку
396a 396a s 	;модифицируем оригинальный перехо в SELDSK чтобы он переходил на наш код	
396a 396a s 	;и сохраняем старый адресс (в данном коде нужный нам адресс 0xDCB6)
396a 396a s 	;RAM:DA1B          _SELDSK:                         ; IN: C
396a 396a s 	;RAM:DA1B C3 B6 DC          jp      __SELDSK        ; OUT: HL-DPB/0, HL=xVTRAP0 if c=0xff
396a 396a s 
396a 396a s 	dwpatch 0xc01b+1	 ,0xdd4c	,md_res_seldsk
396a 396a d 51
396a 396a s 	db 	pW_CHK_PATCH
396b 396b d 1cc0
396b 396b s 	dw 	0xc01b+1
396d 396d d 4cdd0efa
396d 396d s 	dw 	0xdd4c,md_res_seldsk
3971 3971 s 	endm
3971 3971 s 	dwstore md_old_seld_dsk+1,0xdd4c	,0xdd4c
3971 3971 d 54
3971 3971 s 	db 	pW_STORE
3972 3972 d 4cdd
3972 3972 s 	dw 	0xdd4c
3974 3974 d 12fa
3974 3974 s 	dw 	md_old_seld_dsk+1
3976 3976 s 	endm
3976 3976 s 
3976 3976 s 	;custom checkers
3976 3976 s 	dwpatch	0xBD80	,0xBD80 ,0xBD80
3976 3976 d 51
3976 3976 s 	db 	pW_CHK_PATCH
3977 3977 d 80bd
3977 3977 s 	dw 	0xBD80
3979 3979 d 80bd80bd
3979 3979 s 	dw 	0xBD80,0xBD80
397d 397d s 	endm
397d 397d s 	dwpatch	0xBD82	,0xBE00 ,0xBE00
397d 397d d 51
397d 397d s 	db 	pW_CHK_PATCH
397e 397e d 82bd
397e 397e s 	dw 	0xBD82
3980 3980 d 00be00be
3980 3980 s 	dw 	0xBE00,0xBE00
3984 3984 s 	endm
3984 3984 s 	dwpatch	0xc000+1	,0xC487 ,0xC487
3984 3984 d 51
3984 3984 s 	db 	pW_CHK_PATCH
3985 3985 d 01c0
3985 3985 s 	dw 	0xc000+1
3987 3987 d 87c487c4
3987 3987 s 	dw 	0xC487,0xC487
398b 398b s 	endm
398b 398b s 	dwpatch	0xc003+1	,0xDBC0 ,0xDBC0
398b 398b d 51
398b 398b s 	db 	pW_CHK_PATCH
398c 398c d 04c0
398c 398c s 	dw 	0xc003+1
398e 398e d c0dbc0db
398e 398e s 	dw 	0xDBC0,0xDBC0
3992 3992 s 	endm
3992 3992 s 	dbpatch	0xbe07+1	,0x02 ,0x02
3992 3992 d 52
3992 3992 s 	db 	pB_CHK_PATCH
3993 3993 d 08be
3993 3993 s 	dw 	0xbe07+1
3995 3995 d 0202
3995 3995 s 	db 	0x02,0x02
3997 3997 s 	endm
3997 3997 s 	dbpatch	0xEC42	,0x21 ,0x21
3997 3997 d 52
3997 3997 s 	db 	pB_CHK_PATCH
3998 3998 d 42ec
3998 3998 s 	dw 	0xEC42
399a 399a d 2121
399a 399a s 	db 	0x21,0x21
399c 399c s 	endm
399c 399c s 
399c 399c s 	;STOP-------------------------------------------------------------------------------
399c 399c s 	stop 'MICRODOS_OPTS2_900105'
399c 399c d 50
399c 399c s 	db 	p_STOP
399d 399d d 4d4943524f444f535f4f505453325f393030313035
399d 399d s 	db 	'MICRODOS_OPTS2_900105'
39b2 39b2 d 00
39b2 39b2 s 	db 	0
39b3 39b3 s 	endm
39b3 39b3 s 	;'MICRODOS_2_900105'
39b3 39b3 f out/include-patcher.asm
39b3 39b3 s 	include "generator/V0/out/patcher-cpm2-CPM_12_87_11_niijaf.asm"	;  3 images in collection
39b3 39b3 f generator/V0/out/patcher-cpm2-CPM_12_87_11_niijaf.asm
39b3 39b3 s _BIOS_CPM_12_87_11_niijaf:
39b3 39b3 s 	setSUBBIOS 2
39b3 39b3 d 5a
39b3 39b3 s 	db	pSubBios
39b4 39b4 d 02
39b4 39b4 s 	db 	2
39b5 39b5 s 	endm
39b5 39b5 s 	RQ_OPTS_ANY
39b5 39b5 s 	endm
39b5 39b5 s 	setCPM
39b5 39b5 s 	endm
39b5 39b5 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
39b5 39b5 d 59
39b5 39b5 s 	db 	pB_MAYBE_PATCH
39b6 39b6 d eeda
39b6 39b6 s 	dw 	0xDAEE
39b8 39b8 d 1f0d
39b8 39b8 s 	db 	0x1F,0x0d
39ba 39ba s 	endm
39ba 39ba s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
39ba 39ba d 59
39ba 39ba s 	db 	pB_MAYBE_PATCH
39bb 39bb d f0da
39bb 39bb s 	dw 	0xDAEE+2
39bd 39bd d 0a0d
39bd 39bd s 	db 	0x0a,0x0d
39bf 39bf s 	endm
39bf 39bf s 	dbpatch	0xE30E+1	,0x49	,0xc9
39bf 39bf d 52
39bf 39bf s 	db 	pB_CHK_PATCH
39c0 39c0 d 0fe3
39c0 39c0 s 	dw 	0xE30E+1
39c2 39c2 d 49c9
39c2 39c2 s 	db 	0x49,0xc9
39c4 39c4 s 	endm
39c4 39c4 s 	dbpatch	0xDA88 	,0x01	,0x00
39c4 39c4 d 52
39c4 39c4 s 	db 	pB_CHK_PATCH
39c5 39c5 d 88da
39c5 39c5 s 	dw 	0xDA88
39c7 39c7 d 0100
39c7 39c7 s 	db 	0x01,0x00
39c9 39c9 s 	endm
39c9 39c9 s 	dbpatch	0xDA9F 	,0x02	,0x00
39c9 39c9 d 52
39c9 39c9 s 	db 	pB_CHK_PATCH
39ca 39ca d 9fda
39ca 39ca s 	dw 	0xDA9F
39cc 39cc d 0200
39cc 39cc s 	db 	0x02,0x00
39ce 39ce s 	endm
39ce 39ce s 	dbpatch	0xDAB6 	,0x04	,0x01
39ce 39ce d 52
39ce 39ce s 	db 	pB_CHK_PATCH
39cf 39cf d b6da
39cf 39cf s 	dw 	0xDAB6
39d1 39d1 d 0401
39d1 39d1 s 	db 	0x04,0x01
39d3 39d3 s 	endm
39d3 39d3 s 	dbpatch	0xDACD 	,0x08	,0x02
39d3 39d3 d 52
39d3 39d3 s 	db 	pB_CHK_PATCH
39d4 39d4 d cdda
39d4 39d4 s 	dw 	0xDACD
39d6 39d6 d 0802
39d6 39d6 s 	db 	0x08,0x02
39d8 39d8 s 	endm
39d8 39d8 s 	dwstore	_CPM2_res_DRIVE_TAB+0*2	,0xDA88
39d8 39d8 d 54
39d8 39d8 s 	db 	pW_STORE
39d9 39d9 d 88da
39d9 39d9 s 	dw 	0xDA88
39db 39db d 06ea
39db 39db s 	dw 	_CPM2_res_DRIVE_TAB+0*2
39dd 39dd s 	endm
39dd 39dd s 	dwstore	_CPM2_res_DRIVE_TAB+1*2	,0xDA9F
39dd 39dd d 54
39dd 39dd s 	db 	pW_STORE
39de 39de d 9fda
39de 39de s 	dw 	0xDA9F
39e0 39e0 d 08ea
39e0 39e0 s 	dw 	_CPM2_res_DRIVE_TAB+1*2
39e2 39e2 s 	endm
39e2 39e2 s 	dwstore	_CPM2_res_DRIVE_TAB+2*2	,0xDAB6
39e2 39e2 d 54
39e2 39e2 s 	db 	pW_STORE
39e3 39e3 d b6da
39e3 39e3 s 	dw 	0xDAB6
39e5 39e5 d 0aea
39e5 39e5 s 	dw 	_CPM2_res_DRIVE_TAB+2*2
39e7 39e7 s 	endm
39e7 39e7 s 	dwstore	_CPM2_res_DRIVE_TAB+3*2	,0xDACD
39e7 39e7 d 54
39e7 39e7 s 	db 	pW_STORE
39e8 39e8 d cdda
39e8 39e8 s 	dw 	0xDACD
39ea 39ea d 0cea
39ea 39ea s 	dw 	_CPM2_res_DRIVE_TAB+3*2
39ec 39ec s 	endm
39ec 39ec s 	dwpatch 0xDCF6+5*2 	,0x0000 ,_CPM2_dph_F
39ec 39ec d 51
39ec 39ec s 	db 	pW_CHK_PATCH
39ed 39ed d 00dd
39ed 39ed s 	dw 	0xDCF6+5*2
39ef 39ef d 000012ea
39ef 39ef s 	dw 	0x0000,_CPM2_dph_F
39f3 39f3 s 	endm
39f3 39f3 s 	dwstore _CPM2_dph_F+8	,0xDFDB
39f3 39f3 d 54
39f3 39f3 s 	db 	pW_STORE
39f4 39f4 d dbdf
39f4 39f4 s 	dw 	0xDFDB
39f6 39f6 d 1aea
39f6 39f6 s 	dw 	_CPM2_dph_F+8
39f8 39f8 s 	endm
39f8 39f8 s 	dwpatch 0xDA1B+1 	,0xDCB2	,_CPM2_res_seldsk
39f8 39f8 d 51
39f8 39f8 s 	db 	pW_CHK_PATCH
39f9 39f9 d 1cda
39f9 39f9 s 	dw 	0xDA1B+1
39fb 39fb d b2dc6bea
39fb 39fb s 	dw 	0xDCB2,_CPM2_res_seldsk
39ff 39ff s 	endm
39ff 39ff s 	dwstore	_CPM2_old_seld_dsk+1	,0xDCB2
39ff 39ff d 54
39ff 39ff s 	db 	pW_STORE
3a00 3a00 d b2dc
3a00 3a00 s 	dw 	0xDCB2
3a02 3a02 d 6fea
3a02 3a02 s 	dw 	_CPM2_old_seld_dsk+1
3a04 3a04 s 	endm
3a04 3a04 s 	dbpatch	0xE789	,0x77	,0x00
3a04 3a04 d 52
3a04 3a04 s 	db 	pB_CHK_PATCH
3a05 3a05 d 89e7
3a05 3a05 s 	dw 	0xE789
3a07 3a07 d 7700
3a07 3a07 s 	db 	0x77,0x00
3a09 3a09 s 	endm
3a09 3a09 s 	dwstore	_CPM2_r_p_SELDSKDRIVER+1	,0xDFC9
3a09 3a09 d 54
3a09 3a09 s 	db 	pW_STORE
3a0a 3a0a d c9df
3a0a 3a0a s 	dw 	0xDFC9
3a0c 3a0c d 88ea
3a0c 3a0c s 	dw 	_CPM2_r_p_SELDSKDRIVER+1
3a0e 3a0e s 	endm
3a0e 3a0e s 	dwstore	_CPM2_r_p_SELDSKDRIVEW+1	,0xDFC9
3a0e 3a0e d 54
3a0e 3a0e s 	db 	pW_STORE
3a0f 3a0f d c9df
3a0f 3a0f s 	dw 	0xDFC9
3a11 3a11 d c5ea
3a11 3a11 s 	dw 	_CPM2_r_p_SELDSKDRIVEW+1
3a13 3a13 s 	endm
3a13 3a13 s 	dwpatch	0xDA27+1	,0xDD15	,_CPM2_res_READ
3a13 3a13 d 51
3a13 3a13 s 	db 	pW_CHK_PATCH
3a14 3a14 d 28da
3a14 3a14 s 	dw 	0xDA27+1
3a16 3a16 d 15dd75ea
3a16 3a16 s 	dw 	0xDD15,_CPM2_res_READ
3a1a 3a1a s 	endm
3a1a 3a1a s 	dwpatch	0xDA2A+1	,0xDE4B	,_CPM2_res_WRITE
3a1a 3a1a d 51
3a1a 3a1a s 	db 	pW_CHK_PATCH
3a1b 3a1b d 2bda
3a1b 3a1b s 	dw 	0xDA2A+1
3a1d 3a1d d 4bdeb2ea
3a1d 3a1d s 	dw 	0xDE4B,_CPM2_res_WRITE
3a21 3a21 s 	endm
3a21 3a21 s 	dwpatch	0xDB70+1	,0xDD15	,_CPM2_res_READ
3a21 3a21 d 51
3a21 3a21 s 	db 	pW_CHK_PATCH
3a22 3a22 d 71db
3a22 3a22 s 	dw 	0xDB70+1
3a24 3a24 d 15dd75ea
3a24 3a24 s 	dw 	0xDD15,_CPM2_res_READ
3a28 3a28 s 	endm
3a28 3a28 s 	dwpatch	0xDCE4+1	,0xE6BF	,_CPM2_res_GETINFO
3a28 3a28 d 51
3a28 3a28 s 	db 	pW_CHK_PATCH
3a29 3a29 d e5dc
3a29 3a29 s 	dw 	0xDCE4+1
3a2b 3a2b d bfe6efea
3a2b 3a2b s 	dw 	0xE6BF,_CPM2_res_GETINFO
3a2f 3a2f s 	endm
3a2f 3a2f s 	dwstore	_CPM2__old_read+1	,0xDD15
3a2f 3a2f d 54
3a2f 3a2f s 	db 	pW_STORE
3a30 3a30 d 15dd
3a30 3a30 s 	dw 	0xDD15
3a32 3a32 d b0ea
3a32 3a32 s 	dw 	_CPM2__old_read+1
3a34 3a34 s 	endm
3a34 3a34 s 	dwstore	_CPM2__old_write+1	,0xDE4B
3a34 3a34 d 54
3a34 3a34 s 	db 	pW_STORE
3a35 3a35 d 4bde
3a35 3a35 s 	dw 	0xDE4B
3a37 3a37 d edea
3a37 3a37 s 	dw 	_CPM2__old_write+1
3a39 3a39 s 	endm
3a39 3a39 s 	dwstore	_CPM2__old_getinfo+1	,0xE6BF
3a39 3a39 d 54
3a39 3a39 s 	db 	pW_STORE
3a3a 3a3a d bfe6
3a3a 3a3a s 	dw 	0xE6BF
3a3c 3a3c d fdea
3a3c 3a3c s 	dw 	_CPM2__old_getinfo+1
3a3e 3a3e s 	endm
3a3e 3a3e s 	dbpatch	0xE6FF		,0x21	,0x21
3a3e 3a3e d 52
3a3e 3a3e s 	db 	pB_CHK_PATCH
3a3f 3a3f d ffe6
3a3f 3a3f s 	dw 	0xE6FF
3a41 3a41 d 2121
3a41 3a41 s 	db 	0x21,0x21
3a43 3a43 s 	endm
3a43 3a43 s 	dwpatch	0xE6FF+1 	,0xe72F	,0xe72F
3a43 3a43 d 51
3a43 3a43 s 	db 	pW_CHK_PATCH
3a44 3a44 d 00e7
3a44 3a44 s 	dw 	0xE6FF+1
3a46 3a46 d 2fe72fe7
3a46 3a46 s 	dw 	0xe72F,0xe72F
3a4a 3a4a s 	endm
3a4a 3a4a s 	dwstore	_CPM2__old_getinfo_chkdo+1	,0xE6FF
3a4a 3a4a d 54
3a4a 3a4a s 	db 	pW_STORE
3a4b 3a4b d ffe6
3a4b 3a4b s 	dw 	0xE6FF
3a4d 3a4d d faea
3a4d 3a4d s 	dw 	_CPM2__old_getinfo_chkdo+1
3a4f 3a4f s 	endm
3a4f 3a4f s 	dwstore	_CPM2_r_p_DSK1+1	,0xDFBF 	;read
3a4f 3a4f d 54
3a4f 3a4f s 	db 	pW_STORE
3a50 3a50 d bfdf
3a50 3a50 s 	dw 	0xDFBF
3a52 3a52 d 76ea
3a52 3a52 s 	dw 	_CPM2_r_p_DSK1+1
3a54 3a54 s 	endm
3a54 3a54 s 	dwstore	_CPM2_r_p_TRK1+1	,0xDFC3 	
3a54 3a54 d 54
3a54 3a54 s 	db 	pW_STORE
3a55 3a55 d c3df
3a55 3a55 s 	dw 	0xDFC3
3a57 3a57 d 91ea
3a57 3a57 s 	dw 	_CPM2_r_p_TRK1+1
3a59 3a59 s 	endm
3a59 3a59 s 	dwstore	_CPM2_r_p_SEC1+1	,0xDFC4 	
3a59 3a59 d 54
3a59 3a59 s 	db 	pW_STORE
3a5a 3a5a d c4df
3a5a 3a5a s 	dw 	0xDFC4
3a5c 3a5c d 97ea
3a5c 3a5c s 	dw 	_CPM2_r_p_SEC1+1
3a5e 3a5e s 	endm
3a5e 3a5e s 	dwstore	_CPM2_r_p_DMA1+1	,0xDFC5 	
3a5e 3a5e d 54
3a5e 3a5e s 	db 	pW_STORE
3a5f 3a5f d c5df
3a5f 3a5f s 	dw 	0xDFC5
3a61 3a61 d a8ea
3a61 3a61 s 	dw 	_CPM2_r_p_DMA1+1
3a63 3a63 s 	endm
3a63 3a63 s 	dwstore	_CPM2_r_p_DSK2+1	,0xDFBF 	;write
3a63 3a63 d 54
3a63 3a63 s 	db 	pW_STORE
3a64 3a64 d bfdf
3a64 3a64 s 	dw 	0xDFBF
3a66 3a66 d b3ea
3a66 3a66 s 	dw 	_CPM2_r_p_DSK2+1
3a68 3a68 s 	endm
3a68 3a68 s 	dwstore	_CPM2_r_p_TRK2+1	,0xDFC3 	
3a68 3a68 d 54
3a68 3a68 s 	db 	pW_STORE
3a69 3a69 d c3df
3a69 3a69 s 	dw 	0xDFC3
3a6b 3a6b d ceea
3a6b 3a6b s 	dw 	_CPM2_r_p_TRK2+1
3a6d 3a6d s 	endm
3a6d 3a6d s 	dwstore	_CPM2_r_p_SEC2+1	,0xDFC4 	
3a6d 3a6d d 54
3a6d 3a6d s 	db 	pW_STORE
3a6e 3a6e d c4df
3a6e 3a6e s 	dw 	0xDFC4
3a70 3a70 d d4ea
3a70 3a70 s 	dw 	_CPM2_r_p_SEC2+1
3a72 3a72 s 	endm
3a72 3a72 s 	dwstore	_CPM2_r_p_DMA2+1	,0xDFC5 	
3a72 3a72 d 54
3a72 3a72 s 	db 	pW_STORE
3a73 3a73 d c5df
3a73 3a73 s 	dw 	0xDFC5
3a75 3a75 d e5ea
3a75 3a75 s 	dw 	_CPM2_r_p_DMA2+1
3a77 3a77 s 	endm
3a77 3a77 s 	dwstore	_CPM2_r_p_DSK3+1	,0xDFBF 	;readinfo
3a77 3a77 d 54
3a77 3a77 s 	db 	pW_STORE
3a78 3a78 d bfdf
3a78 3a78 s 	dw 	0xDFBF
3a7a 3a7a d 82eb
3a7a 3a7a s 	dw 	_CPM2_r_p_DSK3+1
3a7c 3a7c s 	endm
3a7c 3a7c s 
3a7c 3a7c s 	stop 'CPM_12_87_11_niijaf'
3a7c 3a7c d 50
3a7c 3a7c s 	db 	p_STOP
3a7d 3a7d d 43504d5f31325f38375f31315f6e69696a6166
3a7d 3a7d s 	db 	'CPM_12_87_11_niijaf'
3a90 3a90 d 00
3a90 3a90 s 	db 	0
3a91 3a91 s 	endm
3a91 3a91 f out/include-patcher.asm
3a91 3a91 s 	include "generator/V0/out/patcher-cpm1-CPM_21m_____Shkanov.asm"	;  2 images in collection
3a91 3a91 f generator/V0/out/patcher-cpm1-CPM_21m_____Shkanov.asm
3a91 3a91 s _BIOS_CPM_21m_____Shkanov:
3a91 3a91 s 	setSUBBIOS 1
3a91 3a91 d 5a
3a91 3a91 s 	db	pSubBios
3a92 3a92 d 01
3a92 3a92 s 	db 	1
3a93 3a93 s 	endm
3a93 3a93 s 	RQ_OPTS_ANY
3a93 3a93 s 	endm
3a93 3a93 s 	setCPM
3a93 3a93 s 	endm
3a93 3a93 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
3a93 3a93 d 59
3a93 3a93 s 	db 	pB_MAYBE_PATCH
3a94 3a94 d eeda
3a94 3a94 s 	dw 	0xDAEE
3a96 3a96 d 1f0d
3a96 3a96 s 	db 	0x1F,0x0d
3a98 3a98 s 	endm
3a98 3a98 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
3a98 3a98 d 59
3a98 3a98 s 	db 	pB_MAYBE_PATCH
3a99 3a99 d f0da
3a99 3a99 s 	dw 	0xDAEE+2
3a9b 3a9b d 0a0d
3a9b 3a9b s 	db 	0x0a,0x0d
3a9d 3a9d s 	endm
3a9d 3a9d s 	dbpatch	0xE135+1	,0x49	,0xc9
3a9d 3a9d d 52
3a9d 3a9d s 	db 	pB_CHK_PATCH
3a9e 3a9e d 36e1
3a9e 3a9e s 	dw 	0xE135+1
3aa0 3aa0 d 49c9
3aa0 3aa0 s 	db 	0x49,0xc9
3aa2 3aa2 s 	endm
3aa2 3aa2 s 	dbpatch	0xDA89 	,0x01	,0x00
3aa2 3aa2 d 52
3aa2 3aa2 s 	db 	pB_CHK_PATCH
3aa3 3aa3 d 89da
3aa3 3aa3 s 	dw 	0xDA89
3aa5 3aa5 d 0100
3aa5 3aa5 s 	db 	0x01,0x00
3aa7 3aa7 s 	endm
3aa7 3aa7 s 	dbpatch	0xDAA0 	,0x02	,0x00
3aa7 3aa7 d 52
3aa7 3aa7 s 	db 	pB_CHK_PATCH
3aa8 3aa8 d a0da
3aa8 3aa8 s 	dw 	0xDAA0
3aaa 3aaa d 0200
3aaa 3aaa s 	db 	0x02,0x00
3aac 3aac s 	endm
3aac 3aac s 	dbpatch	0xDAB7 	,0x04	,0x01
3aac 3aac d 52
3aac 3aac s 	db 	pB_CHK_PATCH
3aad 3aad d b7da
3aad 3aad s 	dw 	0xDAB7
3aaf 3aaf d 0401
3aaf 3aaf s 	db 	0x04,0x01
3ab1 3ab1 s 	endm
3ab1 3ab1 s 	dbpatch	0xDACE 	,0x08	,0x02
3ab1 3ab1 d 52
3ab1 3ab1 s 	db 	pB_CHK_PATCH
3ab2 3ab2 d ceda
3ab2 3ab2 s 	dw 	0xDACE
3ab4 3ab4 d 0802
3ab4 3ab4 s 	db 	0x08,0x02
3ab6 3ab6 s 	endm
3ab6 3ab6 s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
3ab6 3ab6 d 54
3ab6 3ab6 s 	db 	pW_STORE
3ab7 3ab7 d 89da
3ab7 3ab7 s 	dw 	0xDA89
3ab9 3ab9 d ace8
3ab9 3ab9 s 	dw 	_CPM1_res_DRIVE_TAB+0*2
3abb 3abb s 	endm
3abb 3abb s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
3abb 3abb d 54
3abb 3abb s 	db 	pW_STORE
3abc 3abc d a0da
3abc 3abc s 	dw 	0xDAA0
3abe 3abe d aee8
3abe 3abe s 	dw 	_CPM1_res_DRIVE_TAB+1*2
3ac0 3ac0 s 	endm
3ac0 3ac0 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
3ac0 3ac0 d 54
3ac0 3ac0 s 	db 	pW_STORE
3ac1 3ac1 d b7da
3ac1 3ac1 s 	dw 	0xDAB7
3ac3 3ac3 d b0e8
3ac3 3ac3 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
3ac5 3ac5 s 	endm
3ac5 3ac5 s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
3ac5 3ac5 d 54
3ac5 3ac5 s 	db 	pW_STORE
3ac6 3ac6 d ceda
3ac6 3ac6 s 	dw 	0xDACE
3ac8 3ac8 d b2e8
3ac8 3ac8 s 	dw 	_CPM1_res_DRIVE_TAB+3*2
3aca 3aca s 	endm
3aca 3aca s 	dwpatch 0xDCB5+5*2 	,0x0000 ,_CPM1_dph_F
3aca 3aca d 51
3aca 3aca s 	db 	pW_CHK_PATCH
3acb 3acb d bfdc
3acb 3acb s 	dw 	0xDCB5+5*2
3acd 3acd d 0000b8e8
3acd 3acd s 	dw 	0x0000,_CPM1_dph_F
3ad1 3ad1 s 	endm
3ad1 3ad1 s 	dwstore _CPM1_dph_F+8	,0xEBA6
3ad1 3ad1 d 54
3ad1 3ad1 s 	db 	pW_STORE
3ad2 3ad2 d a6eb
3ad2 3ad2 s 	dw 	0xEBA6
3ad4 3ad4 d c0e8
3ad4 3ad4 s 	dw 	_CPM1_dph_F+8
3ad6 3ad6 s 	endm
3ad6 3ad6 s 	dwpatch 0xDA1B+1 	,0xDC73	,_CPM1_res_seldsk
3ad6 3ad6 d 51
3ad6 3ad6 s 	db 	pW_CHK_PATCH
3ad7 3ad7 d 1cda
3ad7 3ad7 s 	dw 	0xDA1B+1
3ad9 3ad9 d 73dc11e9
3ad9 3ad9 s 	dw 	0xDC73,_CPM1_res_seldsk
3add 3add s 	endm
3add 3add s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC73
3add 3add d 54
3add 3add s 	db 	pW_STORE
3ade 3ade d 73dc
3ade 3ade s 	dw 	0xDC73
3ae0 3ae0 d 15e9
3ae0 3ae0 s 	dw 	_CPM1_old_seld_dsk+1
3ae2 3ae2 s 	endm
3ae2 3ae2 s 	dbpatch	0xE6FE	,0x77	,0x00
3ae2 3ae2 d 52
3ae2 3ae2 s 	db 	pB_CHK_PATCH
3ae3 3ae3 d fee6
3ae3 3ae3 s 	dw 	0xE6FE
3ae5 3ae5 d 7700
3ae5 3ae5 s 	db 	0x77,0x00
3ae7 3ae7 s 	endm
3ae7 3ae7 s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE058
3ae7 3ae7 d 54
3ae7 3ae7 s 	db 	pW_STORE
3ae8 3ae8 d 58e0
3ae8 3ae8 s 	dw 	0xE058
3aea 3aea d 2ee9
3aea 3aea s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
3aec 3aec s 	endm
3aec 3aec s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE058
3aec 3aec d 54
3aec 3aec s 	db 	pW_STORE
3aed 3aed d 58e0
3aed 3aed s 	dw 	0xE058
3aef 3aef d 6be9
3aef 3aef s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
3af1 3af1 s 	endm
3af1 3af1 s 	dwpatch	0xDA27+1	,0xDCD5	,_CPM1_res_READ
3af1 3af1 d 51
3af1 3af1 s 	db 	pW_CHK_PATCH
3af2 3af2 d 28da
3af2 3af2 s 	dw 	0xDA27+1
3af4 3af4 d d5dc1be9
3af4 3af4 s 	dw 	0xDCD5,_CPM1_res_READ
3af8 3af8 s 	endm
3af8 3af8 s 	dwpatch	0xDA2A+1	,0xDE99	,_CPM1_res_WRITE
3af8 3af8 d 51
3af8 3af8 s 	db 	pW_CHK_PATCH
3af9 3af9 d 2bda
3af9 3af9 s 	dw 	0xDA2A+1
3afb 3afb d 99de58e9
3afb 3afb s 	dw 	0xDE99,_CPM1_res_WRITE
3aff 3aff s 	endm
3aff 3aff s 	dwpatch	0xDB6A+1	,0xDCD5	,_CPM1_res_READ
3aff 3aff d 51
3aff 3aff s 	db 	pW_CHK_PATCH
3b00 3b00 d 6bdb
3b00 3b00 s 	dw 	0xDB6A+1
3b02 3b02 d d5dc1be9
3b02 3b02 s 	dw 	0xDCD5,_CPM1_res_READ
3b06 3b06 s 	endm
3b06 3b06 s 	dwpatch	0xdca8+1	,0xE632	,_CPM1_res_GETINFO
3b06 3b06 d 51
3b06 3b06 s 	db 	pW_CHK_PATCH
3b07 3b07 d a9dc
3b07 3b07 s 	dw 	0xdca8+1
3b09 3b09 d 32e695e9
3b09 3b09 s 	dw 	0xE632,_CPM1_res_GETINFO
3b0d 3b0d s 	endm
3b0d 3b0d s 	dwstore	_CPM1__old_read+1	,0xDCD5
3b0d 3b0d d 54
3b0d 3b0d s 	db 	pW_STORE
3b0e 3b0e d d5dc
3b0e 3b0e s 	dw 	0xDCD5
3b10 3b10 d 56e9
3b10 3b10 s 	dw 	_CPM1__old_read+1
3b12 3b12 s 	endm
3b12 3b12 s 	dwstore	_CPM1__old_write+1	,0xDE99
3b12 3b12 d 54
3b12 3b12 s 	db 	pW_STORE
3b13 3b13 d 99de
3b13 3b13 s 	dw 	0xDE99
3b15 3b15 d 93e9
3b15 3b15 s 	dw 	_CPM1__old_write+1
3b17 3b17 s 	endm
3b17 3b17 s 	dwstore	_CPM1__old_getinfo+1	,0xE632
3b17 3b17 d 54
3b17 3b17 s 	db 	pW_STORE
3b18 3b18 d 32e6
3b18 3b18 s 	dw 	0xE632
3b1a 3b1a d a3e9
3b1a 3b1a s 	dw 	_CPM1__old_getinfo+1
3b1c 3b1c s 	endm
3b1c 3b1c s 	dbpatch	0xE669		,0x21	,0x21
3b1c 3b1c d 52
3b1c 3b1c s 	db 	pB_CHK_PATCH
3b1d 3b1d d 69e6
3b1d 3b1d s 	dw 	0xE669
3b1f 3b1f d 2121
3b1f 3b1f s 	db 	0x21,0x21
3b21 3b21 s 	endm
3b21 3b21 s 	dwpatch	0xE669+1 	,0xE6A3	,0xE6A3
3b21 3b21 d 51
3b21 3b21 s 	db 	pW_CHK_PATCH
3b22 3b22 d 6ae6
3b22 3b22 s 	dw 	0xE669+1
3b24 3b24 d a3e6a3e6
3b24 3b24 s 	dw 	0xE6A3,0xE6A3
3b28 3b28 s 	endm
3b28 3b28 s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE669
3b28 3b28 d 54
3b28 3b28 s 	db 	pW_STORE
3b29 3b29 d 69e6
3b29 3b29 s 	dw 	0xE669
3b2b 3b2b d a0e9
3b2b 3b2b s 	dw 	_CPM1__old_getinfo_chkdo+1
3b2d 3b2d s 	endm
3b2d 3b2d s 	dwstore	_CPM1_r_p_DSK1+1	,0xE04E 	;read
3b2d 3b2d d 54
3b2d 3b2d s 	db 	pW_STORE
3b2e 3b2e d 4ee0
3b2e 3b2e s 	dw 	0xE04E
3b30 3b30 d 1ce9
3b30 3b30 s 	dw 	_CPM1_r_p_DSK1+1
3b32 3b32 s 	endm
3b32 3b32 s 	dwstore	_CPM1_r_p_TRK1+1	,0xE052 	
3b32 3b32 d 54
3b32 3b32 s 	db 	pW_STORE
3b33 3b33 d 52e0
3b33 3b33 s 	dw 	0xE052
3b35 3b35 d 37e9
3b35 3b35 s 	dw 	_CPM1_r_p_TRK1+1
3b37 3b37 s 	endm
3b37 3b37 s 	dwstore	_CPM1_r_p_SEC1+1	,0xE053 	
3b37 3b37 d 54
3b37 3b37 s 	db 	pW_STORE
3b38 3b38 d 53e0
3b38 3b38 s 	dw 	0xE053
3b3a 3b3a d 3de9
3b3a 3b3a s 	dw 	_CPM1_r_p_SEC1+1
3b3c 3b3c s 	endm
3b3c 3b3c s 	dwstore	_CPM1_r_p_DMA1+1	,0xE054 	
3b3c 3b3c d 54
3b3c 3b3c s 	db 	pW_STORE
3b3d 3b3d d 54e0
3b3d 3b3d s 	dw 	0xE054
3b3f 3b3f d 4ee9
3b3f 3b3f s 	dw 	_CPM1_r_p_DMA1+1
3b41 3b41 s 	endm
3b41 3b41 s 	dwstore	_CPM1_r_p_DSK2+1	,0xE04E 	;write
3b41 3b41 d 54
3b41 3b41 s 	db 	pW_STORE
3b42 3b42 d 4ee0
3b42 3b42 s 	dw 	0xE04E
3b44 3b44 d 59e9
3b44 3b44 s 	dw 	_CPM1_r_p_DSK2+1
3b46 3b46 s 	endm
3b46 3b46 s 	dwstore	_CPM1_r_p_TRK2+1	,0xE052 	
3b46 3b46 d 54
3b46 3b46 s 	db 	pW_STORE
3b47 3b47 d 52e0
3b47 3b47 s 	dw 	0xE052
3b49 3b49 d 74e9
3b49 3b49 s 	dw 	_CPM1_r_p_TRK2+1
3b4b 3b4b s 	endm
3b4b 3b4b s 	dwstore	_CPM1_r_p_SEC2+1	,0xE053 	
3b4b 3b4b d 54
3b4b 3b4b s 	db 	pW_STORE
3b4c 3b4c d 53e0
3b4c 3b4c s 	dw 	0xE053
3b4e 3b4e d 7ae9
3b4e 3b4e s 	dw 	_CPM1_r_p_SEC2+1
3b50 3b50 s 	endm
3b50 3b50 s 	dwstore	_CPM1_r_p_DMA2+1	,0xE054 	
3b50 3b50 d 54
3b50 3b50 s 	db 	pW_STORE
3b51 3b51 d 54e0
3b51 3b51 s 	dw 	0xE054
3b53 3b53 d 8be9
3b53 3b53 s 	dw 	_CPM1_r_p_DMA2+1
3b55 3b55 s 	endm
3b55 3b55 s 	dwstore	_CPM1_r_p_DSK3+1	,0xE04E 	;readinfo
3b55 3b55 d 54
3b55 3b55 s 	db 	pW_STORE
3b56 3b56 d 4ee0
3b56 3b56 s 	dw 	0xE04E
3b58 3b58 d 28ea
3b58 3b58 s 	dw 	_CPM1_r_p_DSK3+1
3b5a 3b5a s 	endm
3b5a 3b5a s 
3b5a 3b5a s 	stop 'CPM_21m_____Shkanov'
3b5a 3b5a d 50
3b5a 3b5a s 	db 	p_STOP
3b5b 3b5b d 43504d5f32316d5f5f5f5f5f53686b616e6f76
3b5b 3b5b s 	db 	'CPM_21m_____Shkanov'
3b6e 3b6e d 00
3b6e 3b6e s 	db 	0
3b6f 3b6f s 	endm
3b6f 3b6f f out/include-patcher.asm
3b6f 3b6f s 	include "generator/V0/out/patcher-cpm1-CPM_12_87_09_NIIJAF.asm"	;  2 images in collection
3b6f 3b6f f generator/V0/out/patcher-cpm1-CPM_12_87_09_NIIJAF.asm
3b6f 3b6f s _BIOS_CPM_12_87_09_NIIJAF:
3b6f 3b6f s 	setSUBBIOS 1
3b6f 3b6f d 5a
3b6f 3b6f s 	db	pSubBios
3b70 3b70 d 01
3b70 3b70 s 	db 	1
3b71 3b71 s 	endm
3b71 3b71 s 	RQ_OPTS_ANY
3b71 3b71 s 	endm
3b71 3b71 s 	setCPM
3b71 3b71 s 	endm
3b71 3b71 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
3b71 3b71 d 59
3b71 3b71 s 	db 	pB_MAYBE_PATCH
3b72 3b72 d eeda
3b72 3b72 s 	dw 	0xDAEE
3b74 3b74 d 1f0d
3b74 3b74 s 	db 	0x1F,0x0d
3b76 3b76 s 	endm
3b76 3b76 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
3b76 3b76 d 59
3b76 3b76 s 	db 	pB_MAYBE_PATCH
3b77 3b77 d f0da
3b77 3b77 s 	dw 	0xDAEE+2
3b79 3b79 d 0a0d
3b79 3b79 s 	db 	0x0a,0x0d
3b7b 3b7b s 	endm
3b7b 3b7b s 	dbpatch	0xE738+1	,0x49	,0xc9
3b7b 3b7b d 52
3b7b 3b7b s 	db 	pB_CHK_PATCH
3b7c 3b7c d 39e7
3b7c 3b7c s 	dw 	0xE738+1
3b7e 3b7e d 49c9
3b7e 3b7e s 	db 	0x49,0xc9
3b80 3b80 s 	endm
3b80 3b80 s 	dbpatch	0xDA88 	,0x01	,0x00
3b80 3b80 d 52
3b80 3b80 s 	db 	pB_CHK_PATCH
3b81 3b81 d 88da
3b81 3b81 s 	dw 	0xDA88
3b83 3b83 d 0100
3b83 3b83 s 	db 	0x01,0x00
3b85 3b85 s 	endm
3b85 3b85 s 	dbpatch	0xDA9F 	,0x02	,0x00
3b85 3b85 d 52
3b85 3b85 s 	db 	pB_CHK_PATCH
3b86 3b86 d 9fda
3b86 3b86 s 	dw 	0xDA9F
3b88 3b88 d 0200
3b88 3b88 s 	db 	0x02,0x00
3b8a 3b8a s 	endm
3b8a 3b8a s 	dbpatch	0xDAB6 	,0x04	,0x01
3b8a 3b8a d 52
3b8a 3b8a s 	db 	pB_CHK_PATCH
3b8b 3b8b d b6da
3b8b 3b8b s 	dw 	0xDAB6
3b8d 3b8d d 0401
3b8d 3b8d s 	db 	0x04,0x01
3b8f 3b8f s 	endm
3b8f 3b8f s 	dbpatch	0xDACD 	,0x08	,0x02
3b8f 3b8f d 52
3b8f 3b8f s 	db 	pB_CHK_PATCH
3b90 3b90 d cdda
3b90 3b90 s 	dw 	0xDACD
3b92 3b92 d 0802
3b92 3b92 s 	db 	0x08,0x02
3b94 3b94 s 	endm
3b94 3b94 s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
3b94 3b94 d 54
3b94 3b94 s 	db 	pW_STORE
3b95 3b95 d 88da
3b95 3b95 s 	dw 	0xDA88
3b97 3b97 d ace8
3b97 3b97 s 	dw 	_CPM1_res_DRIVE_TAB+0*2
3b99 3b99 s 	endm
3b99 3b99 s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
3b99 3b99 d 54
3b99 3b99 s 	db 	pW_STORE
3b9a 3b9a d 9fda
3b9a 3b9a s 	dw 	0xDA9F
3b9c 3b9c d aee8
3b9c 3b9c s 	dw 	_CPM1_res_DRIVE_TAB+1*2
3b9e 3b9e s 	endm
3b9e 3b9e s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
3b9e 3b9e d 54
3b9e 3b9e s 	db 	pW_STORE
3b9f 3b9f d b6da
3b9f 3b9f s 	dw 	0xDAB6
3ba1 3ba1 d b0e8
3ba1 3ba1 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
3ba3 3ba3 s 	endm
3ba3 3ba3 s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
3ba3 3ba3 d 54
3ba3 3ba3 s 	db 	pW_STORE
3ba4 3ba4 d cdda
3ba4 3ba4 s 	dw 	0xDACD
3ba6 3ba6 d b2e8
3ba6 3ba6 s 	dw 	_CPM1_res_DRIVE_TAB+3*2
3ba8 3ba8 s 	endm
3ba8 3ba8 s 	dwpatch 0xDCFA+5*2 	,0x0000 ,_CPM1_dph_F
3ba8 3ba8 d 51
3ba8 3ba8 s 	db 	pW_CHK_PATCH
3ba9 3ba9 d 04dd
3ba9 3ba9 s 	dw 	0xDCFA+5*2
3bab 3bab d 0000b8e8
3bab 3bab s 	dw 	0x0000,_CPM1_dph_F
3baf 3baf s 	endm
3baf 3baf s 	dwstore _CPM1_dph_F+8	,0xDFDF
3baf 3baf d 54
3baf 3baf s 	db 	pW_STORE
3bb0 3bb0 d dfdf
3bb0 3bb0 s 	dw 	0xDFDF
3bb2 3bb2 d c0e8
3bb2 3bb2 s 	dw 	_CPM1_dph_F+8
3bb4 3bb4 s 	endm
3bb4 3bb4 s 	dwpatch 0xDA1B+1 	,0xDCB6	,_CPM1_res_seldsk
3bb4 3bb4 d 51
3bb4 3bb4 s 	db 	pW_CHK_PATCH
3bb5 3bb5 d 1cda
3bb5 3bb5 s 	dw 	0xDA1B+1
3bb7 3bb7 d b6dc11e9
3bb7 3bb7 s 	dw 	0xDCB6,_CPM1_res_seldsk
3bbb 3bbb s 	endm
3bbb 3bbb s 	dwstore	_CPM1_old_seld_dsk+1	,0xDCB6
3bbb 3bbb d 54
3bbb 3bbb s 	db 	pW_STORE
3bbc 3bbc d b6dc
3bbc 3bbc s 	dw 	0xDCB6
3bbe 3bbe d 15e9
3bbe 3bbe s 	dw 	_CPM1_old_seld_dsk+1
3bc0 3bc0 s 	endm
3bc0 3bc0 s 	dbpatch	0xE531	,0x77	,0x00
3bc0 3bc0 d 52
3bc0 3bc0 s 	db 	pB_CHK_PATCH
3bc1 3bc1 d 31e5
3bc1 3bc1 s 	dw 	0xE531
3bc3 3bc3 d 7700
3bc3 3bc3 s 	db 	0x77,0x00
3bc5 3bc5 s 	endm
3bc5 3bc5 s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFCD
3bc5 3bc5 d 54
3bc5 3bc5 s 	db 	pW_STORE
3bc6 3bc6 d cddf
3bc6 3bc6 s 	dw 	0xDFCD
3bc8 3bc8 d 2ee9
3bc8 3bc8 s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
3bca 3bca s 	endm
3bca 3bca s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFCD
3bca 3bca d 54
3bca 3bca s 	db 	pW_STORE
3bcb 3bcb d cddf
3bcb 3bcb s 	dw 	0xDFCD
3bcd 3bcd d 6be9
3bcd 3bcd s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
3bcf 3bcf s 	endm
3bcf 3bcf s 	dwpatch	0xDA27+1	,0xDD19	,_CPM1_res_READ
3bcf 3bcf d 51
3bcf 3bcf s 	db 	pW_CHK_PATCH
3bd0 3bd0 d 28da
3bd0 3bd0 s 	dw 	0xDA27+1
3bd2 3bd2 d 19dd1be9
3bd2 3bd2 s 	dw 	0xDD19,_CPM1_res_READ
3bd6 3bd6 s 	endm
3bd6 3bd6 s 	dwpatch	0xDA2A+1	,0xDE4F	,_CPM1_res_WRITE
3bd6 3bd6 d 51
3bd6 3bd6 s 	db 	pW_CHK_PATCH
3bd7 3bd7 d 2bda
3bd7 3bd7 s 	dw 	0xDA2A+1
3bd9 3bd9 d 4fde58e9
3bd9 3bd9 s 	dw 	0xDE4F,_CPM1_res_WRITE
3bdd 3bdd s 	endm
3bdd 3bdd s 	dwpatch	0xDB6D+1	,0xDD19	,_CPM1_res_READ
3bdd 3bdd d 51
3bdd 3bdd s 	db 	pW_CHK_PATCH
3bde 3bde d 6edb
3bde 3bde s 	dw 	0xDB6D+1
3be0 3be0 d 19dd1be9
3be0 3be0 s 	dw 	0xDD19,_CPM1_res_READ
3be4 3be4 s 	endm
3be4 3be4 s 	dwpatch	0xDCE8+1	,0xE467	,_CPM1_res_GETINFO
3be4 3be4 d 51
3be4 3be4 s 	db 	pW_CHK_PATCH
3be5 3be5 d e9dc
3be5 3be5 s 	dw 	0xDCE8+1
3be7 3be7 d 67e495e9
3be7 3be7 s 	dw 	0xE467,_CPM1_res_GETINFO
3beb 3beb s 	endm
3beb 3beb s 	dwstore	_CPM1__old_read+1	,0xDD19
3beb 3beb d 54
3beb 3beb s 	db 	pW_STORE
3bec 3bec d 19dd
3bec 3bec s 	dw 	0xDD19
3bee 3bee d 56e9
3bee 3bee s 	dw 	_CPM1__old_read+1
3bf0 3bf0 s 	endm
3bf0 3bf0 s 	dwstore	_CPM1__old_write+1	,0xDE4F
3bf0 3bf0 d 54
3bf0 3bf0 s 	db 	pW_STORE
3bf1 3bf1 d 4fde
3bf1 3bf1 s 	dw 	0xDE4F
3bf3 3bf3 d 93e9
3bf3 3bf3 s 	dw 	_CPM1__old_write+1
3bf5 3bf5 s 	endm
3bf5 3bf5 s 	dwstore	_CPM1__old_getinfo+1	,0xE467
3bf5 3bf5 d 54
3bf5 3bf5 s 	db 	pW_STORE
3bf6 3bf6 d 67e4
3bf6 3bf6 s 	dw 	0xE467
3bf8 3bf8 d a3e9
3bf8 3bf8 s 	dw 	_CPM1__old_getinfo+1
3bfa 3bfa s 	endm
3bfa 3bfa s 	dbpatch	0xE4A7		,0x21	,0x21
3bfa 3bfa d 52
3bfa 3bfa s 	db 	pB_CHK_PATCH
3bfb 3bfb d a7e4
3bfb 3bfb s 	dw 	0xE4A7
3bfd 3bfd d 2121
3bfd 3bfd s 	db 	0x21,0x21
3bff 3bff s 	endm
3bff 3bff s 	dwpatch	0xE4A7+1 	,0xE4D7	,0xE4D7
3bff 3bff d 51
3bff 3bff s 	db 	pW_CHK_PATCH
3c00 3c00 d a8e4
3c00 3c00 s 	dw 	0xE4A7+1
3c02 3c02 d d7e4d7e4
3c02 3c02 s 	dw 	0xE4D7,0xE4D7
3c06 3c06 s 	endm
3c06 3c06 s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE4A7
3c06 3c06 d 54
3c06 3c06 s 	db 	pW_STORE
3c07 3c07 d a7e4
3c07 3c07 s 	dw 	0xE4A7
3c09 3c09 d a0e9
3c09 3c09 s 	dw 	_CPM1__old_getinfo_chkdo+1
3c0b 3c0b s 	endm
3c0b 3c0b s 	dwstore	_CPM1_r_p_DSK1+1	,0xDFC3 	;read
3c0b 3c0b d 54
3c0b 3c0b s 	db 	pW_STORE
3c0c 3c0c d c3df
3c0c 3c0c s 	dw 	0xDFC3
3c0e 3c0e d 1ce9
3c0e 3c0e s 	dw 	_CPM1_r_p_DSK1+1
3c10 3c10 s 	endm
3c10 3c10 s 	dwstore	_CPM1_r_p_TRK1+1	,0xDFC7 	
3c10 3c10 d 54
3c10 3c10 s 	db 	pW_STORE
3c11 3c11 d c7df
3c11 3c11 s 	dw 	0xDFC7
3c13 3c13 d 37e9
3c13 3c13 s 	dw 	_CPM1_r_p_TRK1+1
3c15 3c15 s 	endm
3c15 3c15 s 	dwstore	_CPM1_r_p_SEC1+1	,0xDFC8 	
3c15 3c15 d 54
3c15 3c15 s 	db 	pW_STORE
3c16 3c16 d c8df
3c16 3c16 s 	dw 	0xDFC8
3c18 3c18 d 3de9
3c18 3c18 s 	dw 	_CPM1_r_p_SEC1+1
3c1a 3c1a s 	endm
3c1a 3c1a s 	dwstore	_CPM1_r_p_DMA1+1	,0xDFC9 	
3c1a 3c1a d 54
3c1a 3c1a s 	db 	pW_STORE
3c1b 3c1b d c9df
3c1b 3c1b s 	dw 	0xDFC9
3c1d 3c1d d 4ee9
3c1d 3c1d s 	dw 	_CPM1_r_p_DMA1+1
3c1f 3c1f s 	endm
3c1f 3c1f s 	dwstore	_CPM1_r_p_DSK2+1	,0xDFC3 	;write
3c1f 3c1f d 54
3c1f 3c1f s 	db 	pW_STORE
3c20 3c20 d c3df
3c20 3c20 s 	dw 	0xDFC3
3c22 3c22 d 59e9
3c22 3c22 s 	dw 	_CPM1_r_p_DSK2+1
3c24 3c24 s 	endm
3c24 3c24 s 	dwstore	_CPM1_r_p_TRK2+1	,0xDFC7 	
3c24 3c24 d 54
3c24 3c24 s 	db 	pW_STORE
3c25 3c25 d c7df
3c25 3c25 s 	dw 	0xDFC7
3c27 3c27 d 74e9
3c27 3c27 s 	dw 	_CPM1_r_p_TRK2+1
3c29 3c29 s 	endm
3c29 3c29 s 	dwstore	_CPM1_r_p_SEC2+1	,0xDFC8 	
3c29 3c29 d 54
3c29 3c29 s 	db 	pW_STORE
3c2a 3c2a d c8df
3c2a 3c2a s 	dw 	0xDFC8
3c2c 3c2c d 7ae9
3c2c 3c2c s 	dw 	_CPM1_r_p_SEC2+1
3c2e 3c2e s 	endm
3c2e 3c2e s 	dwstore	_CPM1_r_p_DMA2+1	,0xDFC9 	
3c2e 3c2e d 54
3c2e 3c2e s 	db 	pW_STORE
3c2f 3c2f d c9df
3c2f 3c2f s 	dw 	0xDFC9
3c31 3c31 d 8be9
3c31 3c31 s 	dw 	_CPM1_r_p_DMA2+1
3c33 3c33 s 	endm
3c33 3c33 s 	dwstore	_CPM1_r_p_DSK3+1	,0xDFC3 	;readinfo
3c33 3c33 d 54
3c33 3c33 s 	db 	pW_STORE
3c34 3c34 d c3df
3c34 3c34 s 	dw 	0xDFC3
3c36 3c36 d 28ea
3c36 3c36 s 	dw 	_CPM1_r_p_DSK3+1
3c38 3c38 s 	endm
3c38 3c38 s 
3c38 3c38 s 	stop 'CPM_12_87_09_NIIJAF'
3c38 3c38 d 50
3c38 3c38 s 	db 	p_STOP
3c39 3c39 d 43504d5f31325f38375f30395f4e49494a4146
3c39 3c39 s 	db 	'CPM_12_87_09_NIIJAF'
3c4c 3c4c d 00
3c4c 3c4c s 	db 	0
3c4d 3c4d s 	endm
3c4d 3c4d f out/include-patcher.asm
3c4d 3c4d s 	include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_871220.asm"	;  2 images in collection
3c4d 3c4d f generator/V0/out/patcher-microdos-MICRODOS_OPTS1_871220.asm
3c4d 3c4d s _BIOS_MICRODOS_OPTS1_871220:
3c4d 3c4d s 	setMICRODOS
3c4d 3c4d d 56
3c4d 3c4d s 	db 	pSETFLAG_MICRODOS
3c4e 3c4e s 	endm
3c4e 3c4e s 	RQ_OPTS1
3c4e 3c4e d 57
3c4e 3c4e s 	db 	pREQUIRED_OPTS1
3c4f 3c4f s 	endm
3c4f 3c4f s 	dbpatchmaybe	0xBE4C	,0x1B	,0x0d
3c4f 3c4f d 59
3c4f 3c4f s 	db 	pB_MAYBE_PATCH
3c50 3c50 d 4cbe
3c50 3c50 s 	dw 	0xBE4C
3c52 3c52 d 1b0d
3c52 3c52 s 	db 	0x1B,0x0d
3c54 3c54 s 	endm
3c54 3c54 s 	dbpatchmaybe	0xBE4C+1	,0x45	,0x0d
3c54 3c54 d 59
3c54 3c54 s 	db 	pB_MAYBE_PATCH
3c55 3c55 d 4dbe
3c55 3c55 s 	dw 	0xBE4C+1
3c57 3c57 d 450d
3c57 3c57 s 	db 	0x45,0x0d
3c59 3c59 s 	endm
3c59 3c59 s 	dwpatch	0xE97F+1	,0xE9B6	,MD_READ			
3c59 3c59 d 51
3c59 3c59 s 	db 	pW_CHK_PATCH
3c5a 3c5a d 80e9
3c5a 3c5a s 	dw 	0xE97F+1
3c5c 3c5c d b6e93efa
3c5c 3c5c s 	dw 	0xE9B6,MD_READ
3c60 3c60 s 	endm
3c60 3c60 s 	dwpatch	0xE984+1	,0xEA20	,MD_WRITE
3c60 3c60 d 51
3c60 3c60 s 	db 	pW_CHK_PATCH
3c61 3c61 d 85e9
3c61 3c61 s 	dw 	0xE984+1
3c63 3c63 d 20ea53fa
3c63 3c63 s 	dw 	0xEA20,MD_WRITE
3c67 3c67 s 	endm
3c67 3c67 s 	dbpatch	0xEB13	,0xcd	,0x00
3c67 3c67 d 52
3c67 3c67 s 	db 	pB_CHK_PATCH
3c68 3c68 d 13eb
3c68 3c68 s 	dw 	0xEB13
3c6a 3c6a d cd00
3c6a 3c6a s 	db 	0xcd,0x00
3c6c 3c6c s 	endm
3c6c 3c6c s 	dwpatch	0xEB13+1	,0xECA9	,0x0000
3c6c 3c6c d 51
3c6c 3c6c s 	db 	pW_CHK_PATCH
3c6d 3c6d d 14eb
3c6d 3c6d s 	dw 	0xEB13+1
3c6f 3c6f d a9ec0000
3c6f 3c6f s 	dw 	0xECA9,0x0000
3c73 3c73 s 	endm
3c73 3c73 s 	dwpatch	0xEB16+1	,0xECAE	,MD_READ_INFOSECTOR
3c73 3c73 d 51
3c73 3c73 s 	db 	pW_CHK_PATCH
3c74 3c74 d 17eb
3c74 3c74 s 	dw 	0xEB16+1
3c76 3c76 d aeec68fa
3c76 3c76 s 	dw 	0xECAE,MD_READ_INFOSECTOR
3c7a 3c7a s 	endm
3c7a 3c7a s 	dwstore	MD_DRV2+1,	0xEDA4
3c7a 3c7a d 54
3c7a 3c7a s 	db 	pW_STORE
3c7b 3c7b d a4ed
3c7b 3c7b s 	dw 	0xEDA4
3c7d 3c7d d f3fa
3c7d 3c7d s 	dw 	MD_DRV2+1
3c7f 3c7f s 	endm
3c7f 3c7f s 	dwstore	MD_RDBUF2+1,	0xEDAC
3c7f 3c7f d 54
3c7f 3c7f s 	db 	pW_STORE
3c80 3c80 d aced
3c80 3c80 s 	dw 	0xEDAC
3c82 3c82 d 02fb
3c82 3c82 s 	dw 	MD_RDBUF2+1
3c84 3c84 s 	endm
3c84 3c84 s 	dwstore	MD_PARAM2+1,	0xED97
3c84 3c84 d 54
3c84 3c84 s 	db 	pW_STORE
3c85 3c85 d 97ed
3c85 3c85 s 	dw 	0xED97
3c87 3c87 d 1dfa
3c87 3c87 s 	dw 	MD_PARAM2+1
3c89 3c89 s 	endm
3c89 3c89 s 	dwpatch 0xc01b+1	 ,0xDDB1	,md_res_seldsk
3c89 3c89 d 51
3c89 3c89 s 	db 	pW_CHK_PATCH
3c8a 3c8a d 1cc0
3c8a 3c8a s 	dw 	0xc01b+1
3c8c 3c8c d b1dd0efa
3c8c 3c8c s 	dw 	0xDDB1,md_res_seldsk
3c90 3c90 s 	endm
3c90 3c90 s 	dwstore md_old_seld_dsk+1,0xDDB1	,0xdd4c
3c90 3c90 d 54
3c90 3c90 s 	db 	pW_STORE
3c91 3c91 d b1dd
3c91 3c91 s 	dw 	0xDDB1
3c93 3c93 d 12fa
3c93 3c93 s 	dw 	md_old_seld_dsk+1
3c95 3c95 s 	endm
3c95 3c95 s 	;custom checkers
3c95 3c95 s 	dwpatch	0xBD80	,0xBD80 ,0xBD80
3c95 3c95 d 51
3c95 3c95 s 	db 	pW_CHK_PATCH
3c96 3c96 d 80bd
3c96 3c96 s 	dw 	0xBD80
3c98 3c98 d 80bd80bd
3c98 3c98 s 	dw 	0xBD80,0xBD80
3c9c 3c9c s 	endm
3c9c 3c9c s 	dwpatch	0xBD82	,0xBE00 ,0xBE00
3c9c 3c9c d 51
3c9c 3c9c s 	db 	pW_CHK_PATCH
3c9d 3c9d d 82bd
3c9d 3c9d s 	dw 	0xBD82
3c9f 3c9f d 00be00be
3c9f 3c9f s 	dw 	0xBE00,0xBE00
3ca3 3ca3 s 	endm
3ca3 3ca3 s 	dwpatch	0xc000+1	,0xC495 ,0xC495
3ca3 3ca3 d 51
3ca3 3ca3 s 	db 	pW_CHK_PATCH
3ca4 3ca4 d 01c0
3ca4 3ca4 s 	dw 	0xc000+1
3ca6 3ca6 d 95c495c4
3ca6 3ca6 s 	dw 	0xC495,0xC495
3caa 3caa s 	endm
3caa 3caa s 	dwpatch	0xc003+1	,0xDC25 ,0xDC25
3caa 3caa d 51
3caa 3caa s 	db 	pW_CHK_PATCH
3cab 3cab d 04c0
3cab 3cab s 	dw 	0xc003+1
3cad 3cad d 25dc25dc
3cad 3cad s 	dw 	0xDC25,0xDC25
3cb1 3cb1 s 	endm
3cb1 3cb1 s 	dbpatch	0xEACE	,0x21 ,0x21
3cb1 3cb1 d 52
3cb1 3cb1 s 	db 	pB_CHK_PATCH
3cb2 3cb2 d ceea
3cb2 3cb2 s 	dw 	0xEACE
3cb4 3cb4 d 2121
3cb4 3cb4 s 	db 	0x21,0x21
3cb6 3cb6 s 	endm
3cb6 3cb6 s 	stop 'MICRODOS_OPTS1_871220'
3cb6 3cb6 d 50
3cb6 3cb6 s 	db 	p_STOP
3cb7 3cb7 d 4d4943524f444f535f4f505453315f383731323230
3cb7 3cb7 s 	db 	'MICRODOS_OPTS1_871220'
3ccc 3ccc d 00
3ccc 3ccc s 	db 	0
3ccd 3ccd s 	endm
3ccd 3ccd f out/include-patcher.asm
3ccd 3ccd s 	include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861115.asm"	;  2 images in collection
3ccd 3ccd f generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861115.asm
3ccd 3ccd s _BIOS_MICRODOS_OPTS1_861115:
3ccd 3ccd s 	setMICRODOS
3ccd 3ccd d 56
3ccd 3ccd s 	db 	pSETFLAG_MICRODOS
3cce 3cce s 	endm
3cce 3cce s 	RQ_OPTS1
3cce 3cce d 57
3cce 3cce s 	db 	pREQUIRED_OPTS1
3ccf 3ccf s 	endm
3ccf 3ccf s 	dbpatchmaybe	0xE693	,0x1B	,0x0d
3ccf 3ccf d 59
3ccf 3ccf s 	db 	pB_MAYBE_PATCH
3cd0 3cd0 d 93e6
3cd0 3cd0 s 	dw 	0xE693
3cd2 3cd2 d 1b0d
3cd2 3cd2 s 	db 	0x1B,0x0d
3cd4 3cd4 s 	endm
3cd4 3cd4 s 	dbpatchmaybe	0xE693+1	,0x45	,0x0d
3cd4 3cd4 d 59
3cd4 3cd4 s 	db 	pB_MAYBE_PATCH
3cd5 3cd5 d 94e6
3cd5 3cd5 s 	dw 	0xE693+1
3cd7 3cd7 d 450d
3cd7 3cd7 s 	db 	0x45,0x0d
3cd9 3cd9 s 	endm
3cd9 3cd9 s 	dwpatch	0xE497+1	,0xE627	,MD_READ			
3cd9 3cd9 d 51
3cd9 3cd9 s 	db 	pW_CHK_PATCH
3cda 3cda d 98e4
3cda 3cda s 	dw 	0xE497+1
3cdc 3cdc d 27e63efa
3cdc 3cdc s 	dw 	0xE627,MD_READ
3ce0 3ce0 s 	endm
3ce0 3ce0 s 	dwpatch	0xE4A0+1	,0xE62A	,MD_WRITE
3ce0 3ce0 d 51
3ce0 3ce0 s 	db 	pW_CHK_PATCH
3ce1 3ce1 d a1e4
3ce1 3ce1 s 	dw 	0xE4A0+1
3ce3 3ce3 d 2ae653fa
3ce3 3ce3 s 	dw 	0xE62A,MD_WRITE
3ce7 3ce7 s 	endm
3ce7 3ce7 s 	dbpatch	0xEAAE	,0xcd	,0x00
3ce7 3ce7 d 52
3ce7 3ce7 s 	db 	pB_CHK_PATCH
3ce8 3ce8 d aeea
3ce8 3ce8 s 	dw 	0xEAAE
3cea 3cea d cd00
3cea 3cea s 	db 	0xcd,0x00
3cec 3cec s 	endm
3cec 3cec s 	dwpatch	0xEAAE+1	,0xE9E9	,0x0000
3cec 3cec d 51
3cec 3cec s 	db 	pW_CHK_PATCH
3ced 3ced d afea
3ced 3ced s 	dw 	0xEAAE+1
3cef 3cef d e9e90000
3cef 3cef s 	dw 	0xE9E9,0x0000
3cf3 3cf3 s 	endm
3cf3 3cf3 s 	dwpatch	0xEAB4+1	,0xEC5D	,MD_READ_INFOSECTOR
3cf3 3cf3 d 51
3cf3 3cf3 s 	db 	pW_CHK_PATCH
3cf4 3cf4 d b5ea
3cf4 3cf4 s 	dw 	0xEAB4+1
3cf6 3cf6 d 5dec68fa
3cf6 3cf6 s 	dw 	0xEC5D,MD_READ_INFOSECTOR
3cfa 3cfa s 	endm
3cfa 3cfa s 	dwstore	MD_DRV2+1,	0xDFC8
3cfa 3cfa d 54
3cfa 3cfa s 	db 	pW_STORE
3cfb 3cfb d c8df
3cfb 3cfb s 	dw 	0xDFC8
3cfd 3cfd d f3fa
3cfd 3cfd s 	dw 	MD_DRV2+1
3cff 3cff s 	endm
3cff 3cff s 	dwstore	MD_RDBUF2+1,	0xEEB0
3cff 3cff d 54
3cff 3cff s 	db 	pW_STORE
3d00 3d00 d b0ee
3d00 3d00 s 	dw 	0xEEB0
3d02 3d02 d 02fb
3d02 3d02 s 	dw 	MD_RDBUF2+1
3d04 3d04 s 	endm
3d04 3d04 s 	dwstore	MD_PARAM2+1,	0xDDBC
3d04 3d04 d 54
3d04 3d04 s 	db 	pW_STORE
3d05 3d05 d bcdd
3d05 3d05 s 	dw 	0xDDBC
3d07 3d07 d 1dfa
3d07 3d07 s 	dw 	MD_PARAM2+1
3d09 3d09 s 	endm
3d09 3d09 s 	dwpatch 0xc01b+1	 ,0xDD86	,md_res_seldsk
3d09 3d09 d 51
3d09 3d09 s 	db 	pW_CHK_PATCH
3d0a 3d0a d 1cc0
3d0a 3d0a s 	dw 	0xc01b+1
3d0c 3d0c d 86dd0efa
3d0c 3d0c s 	dw 	0xDD86,md_res_seldsk
3d10 3d10 s 	endm
3d10 3d10 s 	dwstore md_old_seld_dsk+1,0xDD86	,0xdd4c
3d10 3d10 d 54
3d10 3d10 s 	db 	pW_STORE
3d11 3d11 d 86dd
3d11 3d11 s 	dw 	0xDD86
3d13 3d13 d 12fa
3d13 3d13 s 	dw 	md_old_seld_dsk+1
3d15 3d15 s 	endm
3d15 3d15 s 	;custom checkers
3d15 3d15 s 	dwpatch	0xBC80	,0xBC80 ,0xBC80
3d15 3d15 d 51
3d15 3d15 s 	db 	pW_CHK_PATCH
3d16 3d16 d 80bc
3d16 3d16 s 	dw 	0xBC80
3d18 3d18 d 80bc80bc
3d18 3d18 s 	dw 	0xBC80,0xBC80
3d1c 3d1c s 	endm
3d1c 3d1c s 	dwpatch	0xBC82	,0xBD00 ,0xBD00
3d1c 3d1c d 51
3d1c 3d1c s 	db 	pW_CHK_PATCH
3d1d 3d1d d 82bc
3d1d 3d1d s 	dw 	0xBC82
3d1f 3d1f d 00bd00bd
3d1f 3d1f s 	dw 	0xBD00,0xBD00
3d23 3d23 s 	endm
3d23 3d23 s 	dwpatch	0xc000+1	,0xC4BF ,0xC4BF
3d23 3d23 d 51
3d23 3d23 s 	db 	pW_CHK_PATCH
3d24 3d24 d 01c0
3d24 3d24 s 	dw 	0xc000+1
3d26 3d26 d bfc4bfc4
3d26 3d26 s 	dw 	0xC4BF,0xC4BF
3d2a 3d2a s 	endm
3d2a 3d2a s 	dwpatch	0xc003+1	,0xDBFB ,0xDBFB
3d2a 3d2a d 51
3d2a 3d2a s 	db 	pW_CHK_PATCH
3d2b 3d2b d 04c0
3d2b 3d2b s 	dw 	0xc003+1
3d2d 3d2d d fbdbfbdb
3d2d 3d2d s 	dw 	0xDBFB,0xDBFB
3d31 3d31 s 	endm
3d31 3d31 s 	dbpatch	0xDF95	,0x40 ,0x40
3d31 3d31 d 52
3d31 3d31 s 	db 	pB_CHK_PATCH
3d32 3d32 d 95df
3d32 3d32 s 	dw 	0xDF95
3d34 3d34 d 4040
3d34 3d34 s 	db 	0x40,0x40
3d36 3d36 s 	endm
3d36 3d36 s 	dbpatch	0xDF97	,0x10 ,0x10
3d36 3d36 d 52
3d36 3d36 s 	db 	pB_CHK_PATCH
3d37 3d37 d 97df
3d37 3d37 s 	dw 	0xDF97
3d39 3d39 d 1010
3d39 3d39 s 	db 	0x10,0x10
3d3b 3d3b s 	endm
3d3b 3d3b s 	stop 'MICRODOS_OPTS1_861115'
3d3b 3d3b d 50
3d3b 3d3b s 	db 	p_STOP
3d3c 3d3c d 4d4943524f444f535f4f505453315f383631313135
3d3c 3d3c s 	db 	'MICRODOS_OPTS1_861115'
3d51 3d51 d 00
3d51 3d51 s 	db 	0
3d52 3d52 s 	endm
3d52 3d52 f out/include-patcher.asm
3d52 3d52 s 	include "generator/V0/out/patcher-unsopported-CPM_NET_SFERA1.asm"	;  2 images in collection
3d52 3d52 f generator/V0/out/patcher-unsopported-CPM_NET_SFERA1.asm
3d52 3d52 s _BIOS_CPM_NET_SFERA1:
3d52 3d52 s 	setUNSUPPORTED
3d52 3d52 d 55
3d52 3d52 s 	db 	pNotSupported
3d53 3d53 s 	endm
3d53 3d53 s 	;custom checkers
3d53 3d53 s 	dwpatch	0xC380  	,0xC380  ,0xC380 
3d53 3d53 d 51
3d53 3d53 s 	db 	pW_CHK_PATCH
3d54 3d54 d 80c3
3d54 3d54 s 	dw 	0xC380
3d56 3d56 d 80c380c3
3d56 3d56 s 	dw 	0xC380,0xC380
3d5a 3d5a s 	endm
3d5a 3d5a s 	dwpatch	0xC382  	,0xDa00 ,0xDa00
3d5a 3d5a d 51
3d5a 3d5a s 	db 	pW_CHK_PATCH
3d5b 3d5b d 82c3
3d5b 3d5b s 	dw 	0xC382
3d5d 3d5d d 00da00da
3d5d 3d5d s 	dw 	0xDa00,0xDa00
3d61 3d61 s 	endm
3d61 3d61 s 	dwpatch	0xC384  	,0x000A ,0x000A
3d61 3d61 d 51
3d61 3d61 s 	db 	pW_CHK_PATCH
3d62 3d62 d 84c3
3d62 3d62 s 	dw 	0xC384
3d64 3d64 d 0a000a00
3d64 3d64 s 	dw 	0x000A,0x000A
3d68 3d68 s 	endm
3d68 3d68 s 	dwpatch	0xDB5C+1	,0xDAC3 ,0xDAC3
3d68 3d68 d 51
3d68 3d68 s 	db 	pW_CHK_PATCH
3d69 3d69 d 5ddb
3d69 3d69 s 	dw 	0xDB5C+1
3d6b 3d6b d c3dac3da
3d6b 3d6b s 	dw 	0xDAC3,0xDAC3
3d6f 3d6f s 	endm
3d6f 3d6f s 	dwpatch	0xDA03+1	,0xDB6E ,0xDB6E
3d6f 3d6f d 51
3d6f 3d6f s 	db 	pW_CHK_PATCH
3d70 3d70 d 04da
3d70 3d70 s 	dw 	0xDA03+1
3d72 3d72 d 6edb6edb
3d72 3d72 s 	dw 	0xDB6E,0xDB6E
3d76 3d76 s 	endm
3d76 3d76 s 	dwpatch	0xDA27+1	,0xDED4 ,0xDED4
3d76 3d76 d 51
3d76 3d76 s 	db 	pW_CHK_PATCH
3d77 3d77 d 28da
3d77 3d77 s 	dw 	0xDA27+1
3d79 3d79 d d4ded4de
3d79 3d79 s 	dw 	0xDED4,0xDED4
3d7d 3d7d s 	endm
3d7d 3d7d s 	dwpatch	0xDA2A+1	,0xE193 ,0xE193
3d7d 3d7d d 51
3d7d 3d7d s 	db 	pW_CHK_PATCH
3d7e 3d7e d 2bda
3d7e 3d7e s 	dw 	0xDA2A+1
3d80 3d80 d 93e193e1
3d80 3d80 s 	dw 	0xE193,0xE193
3d84 3d84 s 	endm
3d84 3d84 s 	dwpatch	0xDA3C+1	,0xDD06 ,0xDD06
3d84 3d84 d 51
3d84 3d84 s 	db 	pW_CHK_PATCH
3d85 3d85 d 3dda
3d85 3d85 s 	dw 	0xDA3C+1
3d87 3d87 d 06dd06dd
3d87 3d87 s 	dw 	0xDD06,0xDD06
3d8b 3d8b s 	endm
3d8b 3d8b s 	stop 'CPM_NET_SFERA1'
3d8b 3d8b d 50
3d8b 3d8b s 	db 	p_STOP
3d8c 3d8c d 43504d5f4e45545f534645524131
3d8c 3d8c s 	db 	'CPM_NET_SFERA1'
3d9a 3d9a d 00
3d9a 3d9a s 	db 	0
3d9b 3d9b s 	endm
3d9b 3d9b f out/include-patcher.asm
3d9b 3d9b s 	include "generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_b.asm"	;  2 images in collection
3d9b 3d9b f generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_b.asm
3d9b 3d9b s _BIOS_CPM_NET_KORNET_drive_b:
3d9b 3d9b s 	setUNSUPPORTED
3d9b 3d9b d 55
3d9b 3d9b s 	db 	pNotSupported
3d9c 3d9c s 	endm
3d9c 3d9c s 	;custom checkers
3d9c 3d9c s 	dwpatch	0x8000  	,0x00EE  ,0x00EE 
3d9c 3d9c d 51
3d9c 3d9c s 	db 	pW_CHK_PATCH
3d9d 3d9d d 0080
3d9d 3d9d s 	dw 	0x8000
3d9f 3d9f d ee00ee00
3d9f 3d9f s 	dw 	0x00EE,0x00EE
3da3 3da3 s 	endm
3da3 3da3 s 	dwpatch	0x8000+2	,0x0000 ,0x0000
3da3 3da3 d 51
3da3 3da3 s 	db 	pW_CHK_PATCH
3da4 3da4 d 0280
3da4 3da4 s 	dw 	0x8000+2
3da6 3da6 d 00000000
3da6 3da6 s 	dw 	0x0000,0x0000
3daa 3daa s 	endm
3daa 3daa s 	dwpatch	0x8000+4	,0x000E ,0x000E
3daa 3daa d 51
3daa 3daa s 	db 	pW_CHK_PATCH
3dab 3dab d 0480
3dab 3dab s 	dw 	0x8000+4
3dad 3dad d 0e000e00
3dad 3dad s 	dw 	0x000E,0x000E
3db1 3db1 s 	endm
3db1 3db1 s 	stop 'CPM_NET_KORNET_drive_b'
3db1 3db1 d 50
3db1 3db1 s 	db 	p_STOP
3db2 3db2 d 43504d5f4e45545f4b4f524e45545f64726976655f62
3db2 3db2 s 	db 	'CPM_NET_KORNET_drive_b'
3dc8 3dc8 d 00
3dc8 3dc8 s 	db 	0
3dc9 3dc9 s 	endm
3dc9 3dc9 f out/include-patcher.asm
3dc9 3dc9 s 	include "generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_a.asm"	;  2 images in collection
3dc9 3dc9 f generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_a.asm
3dc9 3dc9 s _BIOS_CPM_NET_KORNET_drive_a:
3dc9 3dc9 s 	setUNSUPPORTED
3dc9 3dc9 d 55
3dc9 3dc9 s 	db 	pNotSupported
3dca 3dca s 	endm
3dca 3dca s 	;custom checkers
3dca 3dca s 	dwpatch	0xDB59+1	,0xDAAA ,0xDAAA
3dca 3dca d 51
3dca 3dca s 	db 	pW_CHK_PATCH
3dcb 3dcb d 5adb
3dcb 3dcb s 	dw 	0xDB59+1
3dcd 3dcd d aadaaada
3dcd 3dcd s 	dw 	0xDAAA,0xDAAA
3dd1 3dd1 s 	endm
3dd1 3dd1 s 	dwpatch	0xD980	,0xD980 ,0xD980
3dd1 3dd1 d 51
3dd1 3dd1 s 	db 	pW_CHK_PATCH
3dd2 3dd2 d 80d9
3dd2 3dd2 s 	dw 	0xD980
3dd4 3dd4 d 80d980d9
3dd4 3dd4 s 	dw 	0xD980,0xD980
3dd8 3dd8 s 	endm
3dd8 3dd8 s 	dwpatch	0xD982	,0xDa00 ,0xDa00
3dd8 3dd8 d 51
3dd8 3dd8 s 	db 	pW_CHK_PATCH
3dd9 3dd9 d 82d9
3dd9 3dd9 s 	dw 	0xD982
3ddb 3ddb d 00da00da
3ddb 3ddb s 	dw 	0xDa00,0xDa00
3ddf 3ddf s 	endm
3ddf 3ddf s 	dwpatch	0xD984	,0x0006 ,0x0006
3ddf 3ddf d 51
3ddf 3ddf s 	db 	pW_CHK_PATCH
3de0 3de0 d 84d9
3de0 3de0 s 	dw 	0xD984
3de2 3de2 d 06000600
3de2 3de2 s 	dw 	0x0006,0x0006
3de6 3de6 s 	endm
3de6 3de6 s 	dwpatch	0xDA03+1	,0xDBA1 ,0xDBA1
3de6 3de6 d 51
3de6 3de6 s 	db 	pW_CHK_PATCH
3de7 3de7 d 04da
3de7 3de7 s 	dw 	0xDA03+1
3de9 3de9 d a1dba1db
3de9 3de9 s 	dw 	0xDBA1,0xDBA1
3ded 3ded s 	endm
3ded 3ded s 	dwpatch	0xDA27+1	,0xDEB0 ,0xDEB0
3ded 3ded d 51
3ded 3ded s 	db 	pW_CHK_PATCH
3dee 3dee d 28da
3dee 3dee s 	dw 	0xDA27+1
3df0 3df0 d b0deb0de
3df0 3df0 s 	dw 	0xDEB0,0xDEB0
3df4 3df4 s 	endm
3df4 3df4 s 	dwpatch	0xDA2A+1	,0xE19A ,0xE19A
3df4 3df4 d 51
3df4 3df4 s 	db 	pW_CHK_PATCH
3df5 3df5 d 2bda
3df5 3df5 s 	dw 	0xDA2A+1
3df7 3df7 d 9ae19ae1
3df7 3df7 s 	dw 	0xE19A,0xE19A
3dfb 3dfb s 	endm
3dfb 3dfb s 	dwpatch	0xDA33+1	,0xDFC8 ,0xDFC8
3dfb 3dfb d 51
3dfb 3dfb s 	db 	pW_CHK_PATCH
3dfc 3dfc d 34da
3dfc 3dfc s 	dw 	0xDA33+1
3dfe 3dfe d c8dfc8df
3dfe 3dfe s 	dw 	0xDFC8,0xDFC8
3e02 3e02 s 	endm
3e02 3e02 s 	stop 'CPM_NET_KORNET_drive_a'
3e02 3e02 d 50
3e02 3e02 s 	db 	p_STOP
3e03 3e03 d 43504d5f4e45545f4b4f524e45545f64726976655f61
3e03 3e03 s 	db 	'CPM_NET_KORNET_drive_a'
3e19 3e19 d 00
3e19 3e19 s 	db 	0
3e1a 3e1a s 	endm
3e1a 3e1a f out/include-patcher.asm
3e1a 3e1a s 	include "generator/V0/out/patcher-cpm2-CPM_1x_88_EPSON_V104.asm"	;  1 images in collection
3e1a 3e1a f generator/V0/out/patcher-cpm2-CPM_1x_88_EPSON_V104.asm
3e1a 3e1a s _BIOS_CPM_1x_88_EPSON_V104:
3e1a 3e1a s 	setSUBBIOS 2
3e1a 3e1a d 5a
3e1a 3e1a s 	db	pSubBios
3e1b 3e1b d 02
3e1b 3e1b s 	db 	2
3e1c 3e1c s 	endm
3e1c 3e1c s 	RQ_OPTS1
3e1c 3e1c d 57
3e1c 3e1c s 	db 	pREQUIRED_OPTS1
3e1d 3e1d s 	endm
3e1d 3e1d s 	setCPM
3e1d 3e1d s 	endm
3e1d 3e1d s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
3e1d 3e1d d 59
3e1d 3e1d s 	db 	pB_MAYBE_PATCH
3e1e 3e1e d eeda
3e1e 3e1e s 	dw 	0xDAEE
3e20 3e20 d 1f0d
3e20 3e20 s 	db 	0x1F,0x0d
3e22 3e22 s 	endm
3e22 3e22 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
3e22 3e22 d 59
3e22 3e22 s 	db 	pB_MAYBE_PATCH
3e23 3e23 d f0da
3e23 3e23 s 	dw 	0xDAEE+2
3e25 3e25 d 0a0d
3e25 3e25 s 	db 	0x0a,0x0d
3e27 3e27 s 	endm
3e27 3e27 s 	dbpatch	0xE8B7+1	,0x49	,0xc9
3e27 3e27 d 52
3e27 3e27 s 	db 	pB_CHK_PATCH
3e28 3e28 d b8e8
3e28 3e28 s 	dw 	0xE8B7+1
3e2a 3e2a d 49c9
3e2a 3e2a s 	db 	0x49,0xc9
3e2c 3e2c s 	endm
3e2c 3e2c s 	dbpatch	0xDA88 	,0x01	,0x00
3e2c 3e2c d 52
3e2c 3e2c s 	db 	pB_CHK_PATCH
3e2d 3e2d d 88da
3e2d 3e2d s 	dw 	0xDA88
3e2f 3e2f d 0100
3e2f 3e2f s 	db 	0x01,0x00
3e31 3e31 s 	endm
3e31 3e31 s 	dbpatch	0xDA9F 	,0x02	,0x00
3e31 3e31 d 52
3e31 3e31 s 	db 	pB_CHK_PATCH
3e32 3e32 d 9fda
3e32 3e32 s 	dw 	0xDA9F
3e34 3e34 d 0200
3e34 3e34 s 	db 	0x02,0x00
3e36 3e36 s 	endm
3e36 3e36 s 	dbpatch	0xDAB6 	,0x04	,0x01
3e36 3e36 d 52
3e36 3e36 s 	db 	pB_CHK_PATCH
3e37 3e37 d b6da
3e37 3e37 s 	dw 	0xDAB6
3e39 3e39 d 0401
3e39 3e39 s 	db 	0x04,0x01
3e3b 3e3b s 	endm
3e3b 3e3b s 	dbpatch	0xDACD 	,0x08	,0x02
3e3b 3e3b d 52
3e3b 3e3b s 	db 	pB_CHK_PATCH
3e3c 3e3c d cdda
3e3c 3e3c s 	dw 	0xDACD
3e3e 3e3e d 0802
3e3e 3e3e s 	db 	0x08,0x02
3e40 3e40 s 	endm
3e40 3e40 s 	dwstore	_CPM2_res_DRIVE_TAB+0*2	,0xDA88
3e40 3e40 d 54
3e40 3e40 s 	db 	pW_STORE
3e41 3e41 d 88da
3e41 3e41 s 	dw 	0xDA88
3e43 3e43 d 06ea
3e43 3e43 s 	dw 	_CPM2_res_DRIVE_TAB+0*2
3e45 3e45 s 	endm
3e45 3e45 s 	dwstore	_CPM2_res_DRIVE_TAB+1*2	,0xDA9F
3e45 3e45 d 54
3e45 3e45 s 	db 	pW_STORE
3e46 3e46 d 9fda
3e46 3e46 s 	dw 	0xDA9F
3e48 3e48 d 08ea
3e48 3e48 s 	dw 	_CPM2_res_DRIVE_TAB+1*2
3e4a 3e4a s 	endm
3e4a 3e4a s 	dwstore	_CPM2_res_DRIVE_TAB+2*2	,0xDAB6
3e4a 3e4a d 54
3e4a 3e4a s 	db 	pW_STORE
3e4b 3e4b d b6da
3e4b 3e4b s 	dw 	0xDAB6
3e4d 3e4d d 0aea
3e4d 3e4d s 	dw 	_CPM2_res_DRIVE_TAB+2*2
3e4f 3e4f s 	endm
3e4f 3e4f s 	dwstore	_CPM2_res_DRIVE_TAB+3*2	,0xDACD
3e4f 3e4f d 54
3e4f 3e4f s 	db 	pW_STORE
3e50 3e50 d cdda
3e50 3e50 s 	dw 	0xDACD
3e52 3e52 d 0cea
3e52 3e52 s 	dw 	_CPM2_res_DRIVE_TAB+3*2
3e54 3e54 s 	endm
3e54 3e54 s 	dwpatch 0xDEC6+5*2 	,0x0000 ,_CPM2_dph_F
3e54 3e54 d 51
3e54 3e54 s 	db 	pW_CHK_PATCH
3e55 3e55 d d0de
3e55 3e55 s 	dw 	0xDEC6+5*2
3e57 3e57 d 000012ea
3e57 3e57 s 	dw 	0x0000,_CPM2_dph_F
3e5b 3e5b s 	endm
3e5b 3e5b s 	dwstore _CPM2_dph_F+8	,0xE1AB
3e5b 3e5b d 54
3e5b 3e5b s 	db 	pW_STORE
3e5c 3e5c d abe1
3e5c 3e5c s 	dw 	0xE1AB
3e5e 3e5e d 1aea
3e5e 3e5e s 	dw 	_CPM2_dph_F+8
3e60 3e60 s 	endm
3e60 3e60 s 	dwpatch 0xDA1B+1 	,0xDE82	,_CPM2_res_seldsk
3e60 3e60 d 51
3e60 3e60 s 	db 	pW_CHK_PATCH
3e61 3e61 d 1cda
3e61 3e61 s 	dw 	0xDA1B+1
3e63 3e63 d 82de6bea
3e63 3e63 s 	dw 	0xDE82,_CPM2_res_seldsk
3e67 3e67 s 	endm
3e67 3e67 s 	dwstore	_CPM2_old_seld_dsk+1	,0xDE82
3e67 3e67 d 54
3e67 3e67 s 	db 	pW_STORE
3e68 3e68 d 82de
3e68 3e68 s 	dw 	0xDE82
3e6a 3e6a d 6fea
3e6a 3e6a s 	dw 	_CPM2_old_seld_dsk+1
3e6c 3e6c s 	endm
3e6c 3e6c s 	dbpatch	0xE6DE	,0x77	,0x00
3e6c 3e6c d 52
3e6c 3e6c s 	db 	pB_CHK_PATCH
3e6d 3e6d d dee6
3e6d 3e6d s 	dw 	0xE6DE
3e6f 3e6f d 7700
3e6f 3e6f s 	db 	0x77,0x00
3e71 3e71 s 	endm
3e71 3e71 s 	dwstore	_CPM2_r_p_SELDSKDRIVER+1	,0xE199
3e71 3e71 d 54
3e71 3e71 s 	db 	pW_STORE
3e72 3e72 d 99e1
3e72 3e72 s 	dw 	0xE199
3e74 3e74 d 88ea
3e74 3e74 s 	dw 	_CPM2_r_p_SELDSKDRIVER+1
3e76 3e76 s 	endm
3e76 3e76 s 	dwstore	_CPM2_r_p_SELDSKDRIVEW+1	,0xE199
3e76 3e76 d 54
3e76 3e76 s 	db 	pW_STORE
3e77 3e77 d 99e1
3e77 3e77 s 	dw 	0xE199
3e79 3e79 d c5ea
3e79 3e79 s 	dw 	_CPM2_r_p_SELDSKDRIVEW+1
3e7b 3e7b s 	endm
3e7b 3e7b s 	dwpatch	0xDA27+1	,0xDEE5	,_CPM2_res_READ
3e7b 3e7b d 51
3e7b 3e7b s 	db 	pW_CHK_PATCH
3e7c 3e7c d 28da
3e7c 3e7c s 	dw 	0xDA27+1
3e7e 3e7e d e5de75ea
3e7e 3e7e s 	dw 	0xDEE5,_CPM2_res_READ
3e82 3e82 s 	endm
3e82 3e82 s 	dwpatch	0xDA2A+1	,0xE01B	,_CPM2_res_WRITE
3e82 3e82 d 51
3e82 3e82 s 	db 	pW_CHK_PATCH
3e83 3e83 d 2bda
3e83 3e83 s 	dw 	0xDA2A+1
3e85 3e85 d 1be0b2ea
3e85 3e85 s 	dw 	0xE01B,_CPM2_res_WRITE
3e89 3e89 s 	endm
3e89 3e89 s 	dwpatch	0xDBC2+1	,0xDEE5	,_CPM2_res_READ
3e89 3e89 d 51
3e89 3e89 s 	db 	pW_CHK_PATCH
3e8a 3e8a d c3db
3e8a 3e8a s 	dw 	0xDBC2+1
3e8c 3e8c d e5de75ea
3e8c 3e8c s 	dw 	0xDEE5,_CPM2_res_READ
3e90 3e90 s 	endm
3e90 3e90 s 	dwpatch	0xdeb4+1	,0xE614	,_CPM2_res_GETINFO
3e90 3e90 d 51
3e90 3e90 s 	db 	pW_CHK_PATCH
3e91 3e91 d b5de
3e91 3e91 s 	dw 	0xdeb4+1
3e93 3e93 d 14e6efea
3e93 3e93 s 	dw 	0xE614,_CPM2_res_GETINFO
3e97 3e97 s 	endm
3e97 3e97 s 	dwstore	_CPM2__old_read+1	,0xDEE5
3e97 3e97 d 54
3e97 3e97 s 	db 	pW_STORE
3e98 3e98 d e5de
3e98 3e98 s 	dw 	0xDEE5
3e9a 3e9a d b0ea
3e9a 3e9a s 	dw 	_CPM2__old_read+1
3e9c 3e9c s 	endm
3e9c 3e9c s 	dwstore	_CPM2__old_write+1	,0xE01B
3e9c 3e9c d 54
3e9c 3e9c s 	db 	pW_STORE
3e9d 3e9d d 1be0
3e9d 3e9d s 	dw 	0xE01B
3e9f 3e9f d edea
3e9f 3e9f s 	dw 	_CPM2__old_write+1
3ea1 3ea1 s 	endm
3ea1 3ea1 s 	dwstore	_CPM2__old_getinfo+1	,0xE614
3ea1 3ea1 d 54
3ea1 3ea1 s 	db 	pW_STORE
3ea2 3ea2 d 14e6
3ea2 3ea2 s 	dw 	0xE614
3ea4 3ea4 d fdea
3ea4 3ea4 s 	dw 	_CPM2__old_getinfo+1
3ea6 3ea6 s 	endm
3ea6 3ea6 s 	dbpatch	0xE654		,0x21	,0x21
3ea6 3ea6 d 52
3ea6 3ea6 s 	db 	pB_CHK_PATCH
3ea7 3ea7 d 54e6
3ea7 3ea7 s 	dw 	0xE654
3ea9 3ea9 d 2121
3ea9 3ea9 s 	db 	0x21,0x21
3eab 3eab s 	endm
3eab 3eab s 	dwpatch	0xE654+1 	,0xE684	,0xE684
3eab 3eab d 51
3eab 3eab s 	db 	pW_CHK_PATCH
3eac 3eac d 55e6
3eac 3eac s 	dw 	0xE654+1
3eae 3eae d 84e684e6
3eae 3eae s 	dw 	0xE684,0xE684
3eb2 3eb2 s 	endm
3eb2 3eb2 s 	dwstore	_CPM2__old_getinfo_chkdo+1	,0xE654
3eb2 3eb2 d 54
3eb2 3eb2 s 	db 	pW_STORE
3eb3 3eb3 d 54e6
3eb3 3eb3 s 	dw 	0xE654
3eb5 3eb5 d faea
3eb5 3eb5 s 	dw 	_CPM2__old_getinfo_chkdo+1
3eb7 3eb7 s 	endm
3eb7 3eb7 s 	dwstore	_CPM2_r_p_DSK1+1	,0xE18F 	;read
3eb7 3eb7 d 54
3eb7 3eb7 s 	db 	pW_STORE
3eb8 3eb8 d 8fe1
3eb8 3eb8 s 	dw 	0xE18F
3eba 3eba d 76ea
3eba 3eba s 	dw 	_CPM2_r_p_DSK1+1
3ebc 3ebc s 	endm
3ebc 3ebc s 	dwstore	_CPM2_r_p_TRK1+1	,0xE193 	
3ebc 3ebc d 54
3ebc 3ebc s 	db 	pW_STORE
3ebd 3ebd d 93e1
3ebd 3ebd s 	dw 	0xE193
3ebf 3ebf d 91ea
3ebf 3ebf s 	dw 	_CPM2_r_p_TRK1+1
3ec1 3ec1 s 	endm
3ec1 3ec1 s 	dwstore	_CPM2_r_p_SEC1+1	,0xE194 	
3ec1 3ec1 d 54
3ec1 3ec1 s 	db 	pW_STORE
3ec2 3ec2 d 94e1
3ec2 3ec2 s 	dw 	0xE194
3ec4 3ec4 d 97ea
3ec4 3ec4 s 	dw 	_CPM2_r_p_SEC1+1
3ec6 3ec6 s 	endm
3ec6 3ec6 s 	dwstore	_CPM2_r_p_DMA1+1	,0xE195 	
3ec6 3ec6 d 54
3ec6 3ec6 s 	db 	pW_STORE
3ec7 3ec7 d 95e1
3ec7 3ec7 s 	dw 	0xE195
3ec9 3ec9 d a8ea
3ec9 3ec9 s 	dw 	_CPM2_r_p_DMA1+1
3ecb 3ecb s 	endm
3ecb 3ecb s 	dwstore	_CPM2_r_p_DSK2+1	,0xE18F 	;write
3ecb 3ecb d 54
3ecb 3ecb s 	db 	pW_STORE
3ecc 3ecc d 8fe1
3ecc 3ecc s 	dw 	0xE18F
3ece 3ece d b3ea
3ece 3ece s 	dw 	_CPM2_r_p_DSK2+1
3ed0 3ed0 s 	endm
3ed0 3ed0 s 	dwstore	_CPM2_r_p_TRK2+1	,0xE193 	
3ed0 3ed0 d 54
3ed0 3ed0 s 	db 	pW_STORE
3ed1 3ed1 d 93e1
3ed1 3ed1 s 	dw 	0xE193
3ed3 3ed3 d ceea
3ed3 3ed3 s 	dw 	_CPM2_r_p_TRK2+1
3ed5 3ed5 s 	endm
3ed5 3ed5 s 	dwstore	_CPM2_r_p_SEC2+1	,0xE194 	
3ed5 3ed5 d 54
3ed5 3ed5 s 	db 	pW_STORE
3ed6 3ed6 d 94e1
3ed6 3ed6 s 	dw 	0xE194
3ed8 3ed8 d d4ea
3ed8 3ed8 s 	dw 	_CPM2_r_p_SEC2+1
3eda 3eda s 	endm
3eda 3eda s 	dwstore	_CPM2_r_p_DMA2+1	,0xE195 	
3eda 3eda d 54
3eda 3eda s 	db 	pW_STORE
3edb 3edb d 95e1
3edb 3edb s 	dw 	0xE195
3edd 3edd d e5ea
3edd 3edd s 	dw 	_CPM2_r_p_DMA2+1
3edf 3edf s 	endm
3edf 3edf s 	dwstore	_CPM2_r_p_DSK3+1	,0xE18F 	;readinfo
3edf 3edf d 54
3edf 3edf s 	db 	pW_STORE
3ee0 3ee0 d 8fe1
3ee0 3ee0 s 	dw 	0xE18F
3ee2 3ee2 d 82eb
3ee2 3ee2 s 	dw 	_CPM2_r_p_DSK3+1
3ee4 3ee4 s 	endm
3ee4 3ee4 s 
3ee4 3ee4 s 	stop 'CPM_1x_88_EPSON_V104'
3ee4 3ee4 d 50
3ee4 3ee4 s 	db 	p_STOP
3ee5 3ee5 d 43504d5f31785f38385f4550534f4e5f56313034
3ee5 3ee5 s 	db 	'CPM_1x_88_EPSON_V104'
3ef9 3ef9 d 00
3ef9 3ef9 s 	db 	0
3efa 3efa s 	endm
3efa 3efa f out/include-patcher.asm
3efa 3efa s 	include "generator/V0/out/patcher-unsopported-CPM_NET_SFERA2.asm"	;  1 images in collection
3efa 3efa f generator/V0/out/patcher-unsopported-CPM_NET_SFERA2.asm
3efa 3efa s _BIOS_CPM_NET_SFERA2:
3efa 3efa s 	setUNSUPPORTED
3efa 3efa d 55
3efa 3efa s 	db 	pNotSupported
3efb 3efb s 	endm
3efb 3efb s 	;custom checkers
3efb 3efb s 	dwpatch	0xC380  	,0xC380  ,0xC380 
3efb 3efb d 51
3efb 3efb s 	db 	pW_CHK_PATCH
3efc 3efc d 80c3
3efc 3efc s 	dw 	0xC380
3efe 3efe d 80c380c3
3efe 3efe s 	dw 	0xC380,0xC380
3f02 3f02 s 	endm
3f02 3f02 s 	dwpatch	0xC382  	,0xDa00 ,0xDa00
3f02 3f02 d 51
3f02 3f02 s 	db 	pW_CHK_PATCH
3f03 3f03 d 82c3
3f03 3f03 s 	dw 	0xC382
3f05 3f05 d 00da00da
3f05 3f05 s 	dw 	0xDa00,0xDa00
3f09 3f09 s 	endm
3f09 3f09 s 	dwpatch	0xC384  	,0x000A ,0x000A
3f09 3f09 d 51
3f09 3f09 s 	db 	pW_CHK_PATCH
3f0a 3f0a d 84c3
3f0a 3f0a s 	dw 	0xC384
3f0c 3f0c d 0a000a00
3f0c 3f0c s 	dw 	0x000A,0x000A
3f10 3f10 s 	endm
3f10 3f10 s 	dwpatch	0xDB5C+1	,0xDAC3 ,0xDAC3
3f10 3f10 d 51
3f10 3f10 s 	db 	pW_CHK_PATCH
3f11 3f11 d 5ddb
3f11 3f11 s 	dw 	0xDB5C+1
3f13 3f13 d c3dac3da
3f13 3f13 s 	dw 	0xDAC3,0xDAC3
3f17 3f17 s 	endm
3f17 3f17 s 	dwpatch	0xDA03+1	,0xDB6E ,0xDB6E
3f17 3f17 d 51
3f17 3f17 s 	db 	pW_CHK_PATCH
3f18 3f18 d 04da
3f18 3f18 s 	dw 	0xDA03+1
3f1a 3f1a d 6edb6edb
3f1a 3f1a s 	dw 	0xDB6E,0xDB6E
3f1e 3f1e s 	endm
3f1e 3f1e s 	dwpatch	0xDA27+1	,0xDED0 ,0xDED0
3f1e 3f1e d 51
3f1e 3f1e s 	db 	pW_CHK_PATCH
3f1f 3f1f d 28da
3f1f 3f1f s 	dw 	0xDA27+1
3f21 3f21 d d0ded0de
3f21 3f21 s 	dw 	0xDED0,0xDED0
3f25 3f25 s 	endm
3f25 3f25 s 	dwpatch	0xDA2A+1	,0xE18F ,0xE18F
3f25 3f25 d 51
3f25 3f25 s 	db 	pW_CHK_PATCH
3f26 3f26 d 2bda
3f26 3f26 s 	dw 	0xDA2A+1
3f28 3f28 d 8fe18fe1
3f28 3f28 s 	dw 	0xE18F,0xE18F
3f2c 3f2c s 	endm
3f2c 3f2c s 	dwpatch	0xDA3C+1	,0xDD02 ,0xDD02
3f2c 3f2c d 51
3f2c 3f2c s 	db 	pW_CHK_PATCH
3f2d 3f2d d 3dda
3f2d 3f2d s 	dw 	0xDA3C+1
3f2f 3f2f d 02dd02dd
3f2f 3f2f s 	dw 	0xDD02,0xDD02
3f33 3f33 s 	endm
3f33 3f33 s 	stop 'CPM_NET_SFERA2'
3f33 3f33 d 50
3f33 3f33 s 	db 	p_STOP
3f34 3f34 d 43504d5f4e45545f534645524132
3f34 3f34 s 	db 	'CPM_NET_SFERA2'
3f42 3f42 d 00
3f42 3f42 s 	db 	0
3f43 3f43 s 	endm
3f43 3f43 f out/include-patcher.asm
3f43 3f43 d ff
3f43 3f43 s 	db 0xff
3f44 3f44 f generator/V0/extrom-patcher.asm
3f44 3f44 s 
3f44 3f44 f stage2.asm
3f44 3f44 s 	
3f44 3f44 s 
3f44 3f44 s 
3f44 3f44 s ; Округляем размер всей секции до ближайших 256 байт вверх	
3f44 3f44 s         DS      ((($>>8)+1)<<8)-$,0
3f44 3f44 d 00000000000000000000000000000000
3f54 3f54 d 00000000000000000000000000000000
3f64 3f64 d 00000000000000000000000000000000
3f74 3f74 d 00000000000000000000000000000000
3f84 3f84 d 00000000000000000000000000000000
3f94 3f94 d 00000000000000000000000000000000
3fa4 3fa4 d 00000000000000000000000000000000
3fb4 3fb4 d 00000000000000000000000000000000
3fc4 3fc4 d 00000000000000000000000000000000
3fd4 3fd4 d 00000000000000000000000000000000
3fe4 3fe4 d 00000000000000000000000000000000
3ff4 3ff4 d 000000000000000000000000
4000 4000 s FTOP	EQU	$			; верхний адрес памяти, занимаемый загружаемым блоком
4000 4000 s ;--------------------------------------------------------------------------
4000 4000 s ; Конец загружаемой области
4000 4000 s ; Далее идет область рабочих данных, не входящая в тело файла загрузчика
4000 4000 s ;--------------------------------------------------------------------------
4000 4000 s 
4000 4000 s ; Буфер сектора
4000 4000 s SECBUF	EQU	$
4080 4080 s 	ORG	$+128	; буфер 128 байт, DS использовать нельзя, чтобы не порождать объектный код
4080 4080 s 
4080 4080 s loader	END 	
20d7 a il
2235 a wg
2245 a wp
225c a h1d
29b0 a .rw
22e6 a cmd
22e9 a sec
2293 a scl
22b2 a gsl
22e7 a drv
22e8 a trk
28ac a tmp
2251 a hex1
2260 a hex2
226f a hex4
2108 a ssl1
2110 a ssl2
ffff v _dma
ffff v _sec
2000 v base
ffff v _dsk
22f1 a hmsg
ffff v _trk
fc00 v tram
2354 a hmls
233a a hmps
4000 v ftop
234d a hmsp
2345 a hmss
227a a hexw
22f0 a lspt
22c5 a pstr
2078 a .chkm
2469 a putx8
22da a getch
235f a hcrlf
fe3a v ncreg
22ea a loadr
ffff v _oper
0049 v conin
ffbf v vireg
22cf a putch
fb08 v porta
fb0a v portc
2332 a hmrun
2008 a start
22ef a ssize
fb0b v rpcwr
282a a .phalt
2044 a .print
fb0e a md_dma
232c a hmbase
4080 a loader
4000 v secbuf
22aa a getsec
2a65 a get_lp
fa71 a md_pwg
004c v pchdrv
2364 a msgcpm
fa81 a md_pwp
2503 a .zgu192k
22ec a runadr
2a2c a copy_z
0050 v p_stop
fb08 v rporta
2363 a tmpkey
fb0a v rportc
22ee a scount
faf2 a md_drv2
2528 a .romcrc
2a42 a .skiplp
2222 a .inilut
fa3e a md_read
2453 a msg_fdc
2aa4 a msg_fdd
28ce a _p_ldir
228a a sendcmd
fad4 a md_pscl
ee00 v _rrbuff
fa96 a md_pgsl
2139 a ld_loop
2464 a putstr8
2628 a msgcrlf
fab2 a md_ppsl
2231 a getbyte
24af a hw_test
204d a waitkey
fa7f v sysreg14
221d a initlut
2a56 a .endfill
2240 a putbyte
246d a putstr_
245b a putstr16
28a6 a cp_de_bc
ff7f v sysreg3c
ff7f v sysreg5c
272c a do_patch
277d a l_pw_chk
2a19 a append_z
fa53 a md_write
fe0b v md_rpcwr
25e4 a msgfound
005a v psubbios
2673 a try_bios
0054 v pw_store
fa1c a md_param2
fb01 a md_rdbuf2
2372 a msgsubst
2670 a work_ptr
e9a9 a _cpm1_pwg
eb03 a _cpm2_pwg
e9b9 a _cpm1_pwp
eb13 a _cpm2_pwp
2a4e a .fillloop
27db a .psubbios
205e a .printkey
2167 a load_done
297b a fdd_found
2474 a .putnospc
2362 a mute_flag
0000 v md_rrbuff
2997 a skip_disk
2a3d a fix_width
fe08 v md_rporta
fe0a v md_rportc
2982 a .cpfddname
2a7e a mount_msg
2082 a set_subst
ea0a a _cpm1_pscl
eb64 a _cpm2_pscl
e9ce a _cpm1_pgsl
eb28 a _cpm2_pgsl
20fe a skip_msg_1
212c a skip_msg_2
e9e9 a _cpm1_ppsl
eb43 a _cpm2_ppsl
254d a .rom_found
2672 a patch_flag
222a a .inilutgrp
fb0a a md_exr_cmd
2725 a patch_done
fb0d a md_exr_sec
2ad8 a msgdrive_f
2588 a bios_found
2737 a patch_loop
e8d0 a _cpm1_dpb_f
ea2a a _cpm2_dpb_f
fb0b a md_exr_drv
25c0 a msgpatcher
fb0c a md_exr_trk
e8b8 a _cpm1_dph_f
2a83 a out_buffer
ea12 a _cpm2_dph_f
e8df a _cpm1_alw_f
2ad5 a mount_crlf
ea39 a _cpm2_alw_f
27a2 a l_pw_store
26e9 a .cpmremapcd
2597 a .found_cont
2a1f a .skipappend
275f a b_chk_maybe
273c a b_chk_patch
2aad a msg_fdd_err
256a a chk_bios_lp
2aab a msg_fdd_drv
20a5 a .noprintkey
2505 a .setgzusize
2e45 a resident_md
269d a .cpmsubbios1
26af a .cpmsubbios2
25be a msg_warning
2030 a force_subst
2369 a msgmicrodos
23ea a hw_gzu_size
2135 a ld_loop_sec0
25ef a msgnotfound
262b a msgreq_opts
2822 a unsupported
2428 a msg_tab16_fdc
26be a .subbiosldir
0052 v pb_chk_patch
2522 a hw_check_rom
0051 v pw_chk_patch
25bd a flag_subbios
23e9 a hw_rom_model
ea3f a _cpm1_exr_cmd
eb99 a _cpm2_exr_cmd
2380 a msgask_subst
244a a msg_gzu_size
ea42 a _cpm1_exr_sec
eb9c a _cpm2_exr_sec
2195 a .badbootparam
2a80 a mount_msg_rw
ea40 a _cpm1_exr_drv
eb9a a _cpm2_exr_drv
2b17 v resident_cpm1
2cae v resident_cpm2
ea41 a _cpm1_exr_trk
eb9b a _cpm2_exr_trk
28cb a fetch_db_to_b
e94d a _cpm1_r_p_dma1
e98a a _cpm1_r_p_dma2
eaa7 a _cpm2_r_p_dma1
eae4 a _cpm2_r_p_dma2
e93c a _cpm1_r_p_sec1
e979 a _cpm1_r_p_sec2
ea96 a _cpm2_r_p_sec1
ead3 a _cpm2_r_p_sec2
0001 v _hw_rom_opts1
0002 v _hw_rom_opts2
e91b a _cpm1_r_p_dsk1
e958 a _cpm1_r_p_dsk2
ea27 a _cpm1_r_p_dsk3
ea75 a _cpm2_r_p_dsk1
eab2 a _cpm2_r_p_dsk2
eb81 a _cpm2_r_p_dsk3
e936 a _cpm1_r_p_trk1
e973 a _cpm1_r_p_trk2
ea90 a _cpm2_r_p_trk1
eacd a _cpm2_r_p_trk2
fa00 a md_res_drivea
fa01 a md_res_driveb
25bc a flag_microdos
fa8d a md_exr_getsec
2285 a fetchdefromhl
fa0e a md_res_seldsk
2444 a msg_rom_model
faa9 a md_exr_putsec
2f55 a bios_variants
e91b a _cpm1_res_read
214b a skip_msg_star
ea75 a _cpm2_res_read
2a7e a mount_msg_drv
23ec a hw_fdd_drive_a
23ed a hw_fdd_drive_b
23ee a hw_fdd_drive_c
23ef a hw_fdd_drive_d
0055 v pnotsupported
26c1 a .cpmnoresident
28c9 a fetch_dw_to_bc
28c0 a read_de_at_tmp
0059 v pb_maybe_patch
29f6 a build_emu_name
fac5 a md_exr_sendcmd
e955 a _cpm1__old_read
eaaf a _cpm2__old_read
23eb a hw_fdc_present
fa6d a md_exr_getbyte
27bf a .pnotsupported
298c a show_disk_info
257f a bios_not_found
2a58 a get_mount_info
fa7c a md_exr_putbyte
21dd a showbootparams
e958 a _cpm1_res_write
2954 a .physical_drive
eab2 a _cpm2_res_write
fa11 a md_old_seld_dsk
2998 a build_disk_name
fa18 a md_fetch_params
faec a md_exr_readinfo
0057 v prequired_opts1
0058 v prequired_opts2
0110 v resident_md_len
21a1 a msgbadbootparam
24bc a hw_check_floppy
216e a checkbootparams
28b7 a store_bc_at_tmp
2086 a restart_disable
0001 v _hw_gzu_size_48k
28ae a store_bc_to_tmp
29c1 a get_drvinfo_ptr
27e8 a .prequired_opts1
2801 a .prequired_opts2
e992 a _cpm1__old_write
e9c5 a _cpm1_exr_getsec
eb1f a _cpm2_exr_getsec
eaec a _cpm2__old_write
290f a show_mount_info
e911 a _cpm1_res_seldsk
ea6b a _cpm2_res_seldsk
2ab7 a drive_rw_status
e9e0 a _cpm1_exr_putsec
eb3a a _cpm2_exr_putsec
0002 v _hw_gzu_size_192k
fa00 v resident_md_addr
fa02 a md_res_drive_tab
2556 a cpm_bios_patcher
28d9 a msgbootfromimage
e9fb a _cpm1_exr_sendcmd
eb55 a _cpm2_exr_sendcmd
25bb a flag_unsupported
e995 a _cpm1_res_getinfo
eaef a _cpm2_res_getinfo
2817 a set_opts_warning
0197 v resident_cpm1_len
0197 v resident_cpm2_len
2935 a show_mount_drive
e9a5 a _cpm1_exr_getbyte
eaff a _cpm2_exr_getbyte
2410 a msg_tab8_gzu_size
e9b4 a _cpm1_exr_putbyte
eb0e a _cpm2_exr_putbyte
24cf a hw_check_gzu_size
0056 v psetflag_microdos
e914 a _cpm1_old_seld_dsk
ea6e a _cpm2_old_seld_dsk
e9a2 a _cpm1__old_getinfo
eafc a _cpm2__old_getinfo
2a71 a msg_default_mount
2643 a msgreq_opts_digit
ea21 a _cpm1_exr_readinfo
23e8 a hw_rom_opts_class
eb7b a _cpm2_exr_readinfo
e8ac v resident_cpm1_addr
ea06 v resident_cpm2_addr
23f0 a msg_tab8_rom_model
29e0 a msgzerodrvinfotab
29d9 a errzerodrvinfotab
e929 a _cpm1_.r_no_drv_dec
ea83 a _cpm2_.r_no_drv_dec
27ce a .psetflag_microdos
e966 a _cpm1_.w_no_drv_dec
eac0 a _cpm2_.w_no_drv_dec
202a a force_default_bios
fa68 a md_read_infosector
0080 v api_get_mount_name
2f95 a _bios_cpm_21_extrom
247b a show_hardware_info
e8ac a _cpm1_res_drive_tab
ea06 a _cpm2_res_drive_tab
369d a _bios_cpm_21_91___lap
0000 v debug_trace_patcher
0001 v _hw_rom_model_opts11
0002 v _hw_rom_model_opts20
2a6f a drivetab_mount_info
3d52 a _bios_cpm_net_sfera1
3efa a _bios_cpm_net_sfera2
2ab7 a mount_info_from_emu
3777 a _bios_cpm_20_88___miks
31a0 a _bios_cpm_21_89___wiza
0003 v _hw_rom_model_kvant8
28f8 a show_boot_image_name
2832 a msg_invalidpatchcode
23a6 a msgforceddefaultbios
2857 a msgundefindedsubbios
0082 v api_get_mount_status
02fa v max_resident_cpm1_len
03f7 v max_resident_cpm2_len
30c3 a _bios_cpm_12_88_3_niijaf
33e0 a _bios_cpm_21_89_2_niijaf
2a62 a receive_c_bytes_to_hl
3852 a _bios_cpm_12_90_5_kontur
39b3 a _bios_cpm_12_87_11_niijaf
3302 a _bios_cpm_21_89_2_niijaf2
3b6f a _bios_cpm_12_87_09_niijaf
e92d a _cpm1_r_p_seldskdriver
ea87 a _cpm2_r_p_seldskdriver
e96a a _cpm1_r_p_seldskdrivew
eac4 a _cpm2_r_p_seldskdrivew
3538 a _bios_cpm_1x_89_03_30_ravi
26fe a move_microdos_resident
272a a hl_after_do_patch_patch
3e1a a _bios_cpm_1x_88_epson_v104
e99f a _cpm1__old_getinfo_chkdo
eaf9 a _cpm2__old_getinfo_chkdo
287a a msg_strangehlafterpatch
3a91 a _bios_cpm_21m_____shkanov
392f a _bios_microdos_opts2_900105
3618 a _bios_microdos_opts1_861011
3c4d a _bios_microdos_opts1_871220
34bd a _bios_microdos_opts1_870430
3ccd a _bios_microdos_opts1_861115
3282 a _bios_microdos_opts2_880630
2fd5 a _bios_cpm_12_88_3_alternativa
0163 v available_resident_cpm1_len
0260 v available_resident_cpm2_len
3dc9 a _bios_cpm_net_kornet_drive_a
3d9b a _bios_cpm_net_kornet_drive_b
