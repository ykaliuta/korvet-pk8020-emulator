binary-debuggable-source
0000 0000 f stage2.asm
0000 0000 s ;**********************************************************************************************
0000 0000 s ;*  Загрузчик 2 фазы дискового эмулятора Korvet-Extrom
0000 0000 s ;*  Работает только в паре с контроллером Extrom через боковой разъем корвета
0000 0000 s ;*
0000 0000 s ;*  Загружает в память системные дорожки диска А и передает управление на код инициализации BIOS
0000 0000 s ;*   Сборка с помощью кросс-ассемблера z80asm, контрольная сумма рассчитывается утилитой ercs
0000 0000 s ;*
0000 0000 s ;*   Программа записывается на карту SD контроллера в файл LOADER.BIN
0000 0000 s ;**********************************************************************************************
0000 0000 s BASE	EQU	2000H		; База для размещения этого кода
0000 0000 s PORTA	EQU     0FB08H		; Порт A ВВ55 #3
0000 0000 s PORTC	EQU     0FB0AH		; Порт C ВВ55 #3
0000 0000 s TRAM	EQU	0FC00H		; Начало видеопамяти
0000 0000 s 
0000 0000 s SYSREG14  EQU	0FA7FH		; регистр карты памяти
0000 0000 s SYSREG5C  EQU	0FF7FH		; регистр карты памяти
0000 0000 s ; SYSREG6C  EQU	0BF7FH
0000 0000 s SYSREG3C  EQU	0FF7FH
0000 0000 s 
0000 0000 s PCHDRV	EQU	4Ch		; подпрограмма печати байта через драйвер консоли ОПТС
0000 0000 s CONIN	EQU	49h		; подпрограмма ввода символа через драйвер консоли ОПТС
0000 0000 s 
0000 0000 s 
0000 0000 s ; started in config 14
0000 0000 s ; 	14  NDOS   0-1FFF  2000-F7FF                   F800  FA00  FC00  FB00
0000 0000 s 
2000 2000 s 	ORG   	BASE
2000 2000 s 
2000 2000 s ; Стандартный заголовок внешнего ПЗУ корвета
2000 2000 d c30820
2000 2000 s 	JP	START	        ; +0
2003 2003 d 00
2003 2003 s 	DB      0		; +3
2004 2004 d 0820
2004 2004 s 	DW	START           ; +4 - адрес запуска 
2006 2006 d 20
2006 2006 s 	DB	BASE>>8         ; +6 - старшие 8 бит адреса загрузки (младшие всегда 00)
2007 2007 d 20
2007 2007 s 	DB	(FTOP-BASE)>>8  ; +7 - количество загружаемых 256-байтовых блоков
2008 2008 s 
2008 2008 s 
2008 2008 s ; Далее идет непосредственный программный код	
2008 2008 s START:
2008 2008 d f3
2008 2008 s 	DI
2009 2009 d 3100f7
2009 2009 s 	LD	SP,0F700h	; рабочий стек, размещаем в области F-макросов драйвера клавиатуры
200c 200c s 
200c 200c d cd1a22
200c 200c s 	call 	initLUT
200f 200f s 
200f 200f s ; Печать промпта 	
200f 200f d 21ee22
200f 200f s 	LD	HL,HMSG
2012 2012 d cdc222
2012 2012 s 	CALL	PSTR
2015 2015 s 
2015 2015 d cdac24
2015 2015 s 	call 	hw_test
2018 2018 s ; 	halt
2018 2018 s 
2018 2018 s 
2018 2018 d af
2018 2018 s 	xor 	a
2019 2019 d 32b925
2019 2019 s 	ld 	(flag_microdos),a
201c 201c s 
201c 201c d 3a80f8
201c 201c s 	ld 	a,(0xf880)
201f 201f d e621
201f 201f s 	and 	0x21 		;ctrl+shift
2021 2021 d fe21
2021 2021 s 	cp 	0x21
2023 2023 s 
2023 2023 d ca2a20
2023 2023 s 	jp 	z,force_default_bios
2026 2026 d af
2026 2026 s 	xor 	a		;turn off system substitution
2027 2027 d c38620
2027 2027 s 	jp 	restart_disable
202a 202a s 
202a 202a s force_default_bios:
202a 202a d 21a323
202a 202a s 	ld 	hl,msgFORCEDDEFAULTBIOS
202d 202d d cdc222
202d 202d s 	call 	PSTR
2030 2030 s ; 	jp 	set_subst
2030 2030 s 
2030 2030 s force_subst:
2030 2030 s ; 	ld 	hl,msgFORCEDDEFAULTBIOS
2030 2030 s ; 	call 	PSTR
2030 2030 s 
2030 2030 d 216f23
2030 2030 s 	ld 	hl,msgSUBST
2033 2033 d cdc222
2033 2033 s 	call 	PSTR
2036 2036 s 
2036 2036 d 3ab925
2036 2036 s 	ld 	a,(flag_microdos)
2039 2039 s 
2039 2039 d 216623
2039 2039 s 	ld 	hl,msgMICRODOS
203c 203c d fe01
203c 203c s 	cp 	1
203e 203e d ca4420
203e 203e s 	jp 	z,.print
2041 2041 d 216123
2041 2041 s 	ld 	hl,msgCPM
2044 2044 s .print:
2044 2044 d cdc222
2044 2044 s 	call 	PSTR
2047 2047 s 
2047 2047 d 217d23
2047 2047 s 	ld 	hl,msgASK_SUBST
204a 204a d cdc222
204a 204a s 	call 	PSTR
204d 204d s 
204d 204d s WaitKey:
204d 204d d 3e07
204d 204d s 	ld 	a,7
204f 204f d cdcc22
204f 204f s 	call 	PUTCH
2052 2052 d cdd722
2052 2052 s 	call 	GETCH
2055 2055 d e65f
2055 2055 s 	and 	0x5F
2057 2057 s 
2057 2057 d fe0d
2057 2057 s 	cp 	0x0d 	;CR
2059 2059 d c25e20
2059 2059 s 	jp 	nz,.printKEY
205c 205c s 
205c 205c d 3e59
205c 205c s 	ld 	a,'Y'
205e 205e s 
205e 205e s .printKEY:
205e 205e d 326023
205e 205e s 	ld 	(tmpKEY),a
2061 2061 s 
2061 2061 d fe59
2061 2061 s 	cp 	'Y'
2063 2063 d ca8220
2063 2063 s 	jp 	z,set_subst
2066 2066 d fe44
2066 2066 s 	cp 	'D'
2068 2068 d ca8220
2068 2068 s 	jp 	z,set_subst
206b 206b s 
206b 206b d fe43
206b 206b s 	cp 	a,'C'
206d 206d d c27820
206d 206d s 	jp 	nz,.chkM
2070 2070 s 
2070 2070 d 3e00
2070 2070 s 	ld 	a,0
2072 2072 d 32b925
2072 2072 s 	ld 	(flag_microdos),a
2075 2075 d c38220
2075 2075 s 	jp 	set_subst
2078 2078 s .chkM:
2078 2078 d fe4d
2078 2078 s 	cp 	'M'
207a 207a d c24d20
207a 207a s 	jp 	nz,WaitKey
207d 207d d 3e01
207d 207d s 	ld 	a,1	
207f 207f d 32b925
207f 207f s 	ld 	(flag_microdos),a
2082 2082 s 
2082 2082 s 
2082 2082 s set_subst:
2082 2082 d 3ab925
2082 2082 s 	ld 	a,(flag_microdos)
2085 2085 d 3c
2085 2085 s 	inc 	a
2086 2086 s 
2086 2086 s restart_disable:
2086 2086 d 32e522
2086 2086 s 	ld 	(TRK),A
2089 2089 d 3ea0
2089 2089 s 	ld 	a,0xA0 		;system substitution
208b 208b d 32e322
208b 208b s 	ld 	(CMD),a
208e 208e d af
208e 208e s 	xor 	a
208f 208f d 32e422
208f 208f s 	ld 	(DRV),a
2092 2092 d cd8722
2092 2092 s 	call 	SENDCMD
2095 2095 s 
2095 2095 d 3a6023
2095 2095 s 	ld 	a,(tmpKEY)
2098 2098 d b7
2098 2098 s 	or 	a
2099 2099 d caa520
2099 2099 s 	jp 	z,.noPrintKey
209c 209c d cdcc22
209c 209c s 	call 	PUTCH
209f 209f d 215c23
209f 209f s 	ld 	hl,HCRLF
20a2 20a2 d cdc222
20a2 20a2 s 	call	PSTR 	
20a5 20a5 s 
20a5 20a5 s .noPrintKey:
20a5 20a5 s 
20a5 20a5 s 
20a5 20a5 d 3e00
20a5 20a5 s 	ld 	a,0
20a7 20a7 d 32b825
20a7 20a7 s 	ld 	(flag_unsupported),a
20aa 20aa d 32b925
20aa 20aa s 	ld 	(flag_microdos),a
20ad 20ad d 210000
20ad 20ad s 	ld 	hl,0
20b0 20b0 d 22bb25
20b0 20b0 s 	ld 	(msg_warning),hl
20b3 20b3 s 
20b3 20b3 d f3
20b3 20b3 s 	DI
20b4 20b4 d 3100f7
20b4 20b4 s 	LD	SP,0F700h	; рабочий стек, размещаем в области F-макросов драйвера клавиатуры
20b7 20b7 s 
20b7 20b7 s 
20b7 20b7 s ; Загрузка инфосектора
20b7 20b7 s 
20b7 20b7 d 3e01
20b7 20b7 s 	ld 	a,0x1 		;read
20b9 20b9 d 32e322
20b9 20b9 s 	ld 	(CMD),a
20bc 20bc d af
20bc 20bc s 	xor 	a
20bd 20bd d 32e522
20bd 20bd s 	ld 	(TRK),A
20c0 20c0 d 32e622
20c0 20c0 s 	ld 	(SEC),A
20c3 20c3 s 
20c3 20c3 s 
20c3 20c3 d cd8722
20c3 20c3 s 	CALL	SENDCMD		; отсылаем команду загрузки сектора, параметры уже прописаны в командном блоке
20c6 20c6 d 210040
20c6 20c6 s 	LD	HL,SECBUF
20c9 20c9 d cda722
20c9 20c9 s 	CALL	GETSEC		; забираем 256 байт сектора 0
20cc 20cc s 
20cc 20cc s ; Разбор инфосектора
20cc 20cc s ;
20cc 20cc s ; Вынимаем идущие подряд переменные LOADR, RUNADR, COUNT
20cc 20cc s ;
20cc 20cc s 
20cc 20cc s ;TODO: add crc check!!!!!!!!!!!!!!!
20cc 20cc s 
20cc 20cc d 210040
20cc 20cc s 	LD	HL,SECBUF
20cf 20cf d 11e722
20cf 20cf s 	LD	DE,LOADR	; начало блока переменных в памяти
20d2 20d2 d 0e05
20d2 20d2 s 	LD	C,5		; всего 5 байтов
20d4 20d4 s IL:
20d4 20d4 d 7e
20d4 20d4 s 	LD	A,(HL)		; копируем блок переменных
20d5 20d5 d 12
20d5 20d5 s 	LD	(DE),A
20d6 20d6 d 23
20d6 20d6 s 	INC	HL
20d7 20d7 d 13
20d7 20d7 s 	INC	DE
20d8 20d8 d 0d
20d8 20d8 s 	DEC	C
20d9 20d9 d c2d420
20d9 20d9 s 	JP	NZ,IL
20dc 20dc s 
20dc 20dc s ; Получаем индекс размера сектора
20dc 20dc d 210a40
20dc 20dc s 	LD	HL,SECBUF+10	;  +10 - коэффициент блокирования секторов
20df 20df d 7e
20df 20df s 	LD	A,(HL)
20e0 20e0 d 12
20e0 20e0 s 	LD	(DE),A
20e1 20e1 d 13
20e1 20e1 s 	INC	DE
20e2 20e2 d 211040
20e2 20e2 s 	LD	HL,SECBUF+16	;  +16 - LSPT
20e5 20e5 d 7e
20e5 20e5 s 	LD	A,(HL)
20e6 20e6 d 12
20e6 20e6 s 	LD	(DE),A
20e7 20e7 s 
20e7 20e7 d cd6b21
20e7 20e7 s 	call 	CheckBootParams
20ea 20ea d c23020
20ea 20ea s 	jp 	nz,force_subst
20ed 20ed s 	
20ed 20ed d 3a80f8
20ed 20ed s 	ld 	a,(0xf880)
20f0 20f0 d e601
20f0 20f0 s 	and 	0x1
20f2 20f2 d 325f23
20f2 20f2 s 	ld 	(mute_flag),a
20f5 20f5 d cafb20
20f5 20f5 s 	jp 	z,skip_msg_1
20f8 20f8 s 
20f8 20f8 d cdda21
20f8 20f8 s 	call 	ShowBootParams
20fb 20fb s 
20fb 20fb s skip_msg_1:
20fb 20fb s 		
20fb 20fb s ; Вычисление числа полных дорожек для загрузки	
20fb 20fb s 	
20fb 20fb d 21eb22
20fb 20fb s 	LD	HL,SCOUNT	
20fe 20fe d 5e
20fe 20fe s 	LD	E,(HL)		; число загружаемых физических секторов
20ff 20ff d 1600
20ff 20ff s 	LD	D,0		; -> DE
2101 2101 d 23
2101 2101 s 	INC	HL
2102 2102 d 4e
2102 2102 s 	LD	C,(HL)		; индекс размера сектора
2103 2103 s ;
2103 2103 s ; Индекс размера - очень удобная величина, определяющая коэффициент блокирования секторов, то есть число логических секторов в физическом
2103 2103 s ; Размер логического сектора CP/M - всегда 128 байт.
2103 2103 s ;
2103 2103 s ;  Физ.сектор   SSIZE    коэффициент блокирования
2103 2103 s ;----------------------------------------------------
2103 2103 s ;     128         0                1
2103 2103 s ;     256         1                2
2103 2103 s ;     512         2                4
2103 2103 s ;     1024        3                8 
2103 2103 s ;
2103 2103 s ;
2103 2103 s ; Далее выполняется операция DE << C, что приводит к умножению числа физических секторов
2103 2103 s ; на коэффициент блокирования - получаем число загружаемых логических секторов
2103 2103 d eb
2103 2103 s 	ex 	de,hl
2104 2104 d 0c
2104 2104 s 	INC	C		; Коррекция SSIZE, чтобы начинался с 1
2105 2105 s SSL1:	
2105 2105 d 0d
2105 2105 s 	DEC	C		; счетчик сдвига--
2106 2106 d ca0d21
2106 2106 s 	JP	Z,SSL2		; сдвиг окончен
2109 2109 s ; 	XOR	A		; CF=0
2109 2109 s ; 	LD	A,E
2109 2109 s ; 	RLA			; сдвигаем младший байт
2109 2109 s ; 	LD	E,A
2109 2109 s ; 	LD	A,D
2109 2109 s ; 	RLA			; сдвигаем старший байт
2109 2109 s ; 	LD	D,A
2109 2109 d 29
2109 2109 s 	add 	hl,hl
210a 210a d c30521
210a 210a s 	JP	SSL1
210d 210d s ;
210d 210d s ;  Выводим на экран число логических секторов
210d 210d s ;
210d 210d s SSL2:
210d 210d d eb
210d 210d s 	ex 	de,hl
210e 210e d 3a5f23
210e 210e s 	ld 	a,(mute_flag)
2111 2111 d b7
2111 2111 s 	or 	a
2112 2112 d ca2921
2112 2112 s 	jp 	z,skip_msg_2
2115 2115 s 
2115 2115 d 215123
2115 2115 s 	LD	HL,HMLS
2118 2118 d cdc222
2118 2118 s 	CALL	PSTR
211b 211b d 7a
211b 211b s 	LD	A,D
211c 211c d cd5d22
211c 211c s 	CALL	HEX2
211f 211f d 7b
211f 211f s 	LD	A,E
2120 2120 d cd5d22
2120 2120 s 	CALL	HEX2
2123 2123 s 
2123 2123 d 215c23
2123 2123 s 	LD	HL,HCRLF
2126 2126 d cdc222
2126 2126 s 	CALL	PSTR
2129 2129 s 
2129 2129 s 	;de - sectors to load
2129 2129 s 
2129 2129 s skip_msg_2:
2129 2129 s 
2129 2129 s 	;DE - sectors to load
2129 2129 s 
2129 2129 d 4b
2129 2129 s 	ld 	c,e 		; C - sectors to load (up to 32k)
212a 212a d 2ae722
212a 212a s 	LD	HL,(LOADR)	; HL - указатель позиции загрузки в памяти
212d 212d s 
212d 212d d af
212d 212d s 	xor 	a
212e 212e d 32e522
212e 212e s 	ld 	(TRK),a
2131 2131 s 
2131 2131 d 0c
2131 2131 s 	inc 	c
2132 2132 s 
2132 2132 s ld_loop_sec0:
2132 2132 d af
2132 2132 s 	xor 	a
2133 2133 d 32e622
2133 2133 s 	ld 	(SEC),a
2136 2136 s 
2136 2136 s ld_loop:
2136 2136 s 
2136 2136 d 0d
2136 2136 s 	dec 	c
2137 2137 d 79
2137 2137 s 	ld 	a,c
2138 2138 d b7
2138 2138 s 	or 	a
2139 2139 d ca6421
2139 2139 s 	jp 	z,load_done
213c 213c s 
213c 213c d 3a5f23
213c 213c s 	ld 	a,(mute_flag)
213f 213f d b7
213f 213f s 	or 	a
2140 2140 d ca4821
2140 2140 s 	jp 	z,skip_msg_star
2143 2143 s 
2143 2143 d 3e2a
2143 2143 s 	LD	A,'*'		; прогресс-бар загружаемых секторов
2145 2145 d cdcc22
2145 2145 s 	CALL	PUTCH
2148 2148 s skip_msg_star:
2148 2148 s 	
2148 2148 s 
2148 2148 d cd8722
2148 2148 s 	CALL	SENDCMD		; отправляем команду
214b 214b d cda722
214b 214b s 	CALL	GETSEC		; получаем и размещаем сектор
214e 214e s 
214e 214e d e5
214e 214e s 	PUSH	HL
214f 214f d 21e622
214f 214f s 	LD	HL,SEC
2152 2152 d 34
2152 2152 s 	INC	(HL)		; номер сектора ++
2153 2153 s 
2153 2153 d 3aed22
2153 2153 s 	ld 	a,(LSPT)
2156 2156 d be
2156 2156 s 	cp 	(hl)
2157 2157 d e1
2157 2157 s 	POP	HL
2158 2158 s 
2158 2158 d c23621
2158 2158 s 	jp 	nz,ld_loop
215b 215b s 
215b 215b d e5
215b 215b s 	PUSH	HL
215c 215c d 21e522
215c 215c s 	LD	HL,TRK
215f 215f d 34
215f 215f s 	INC	(HL)		; номер сектора ++
2160 2160 d e1
2160 2160 s 	POP	HL
2161 2161 d c33221
2161 2161 s 	jp 	ld_loop_sec0
2164 2164 s 
2164 2164 s load_done:
2164 2164 s ; 	halt
2164 2164 s 
2164 2164 s ; Вся системная область диска загружена - можно запускать ОС
2164 2164 s ;	
2164 2164 s ; 	LD	A,'@'		; Признак окончания загрузки - на экран
2164 2164 s ; 	CALL	PUTCH
2164 2164 s 
2164 2164 d cd5325
2164 2164 s 	call 	cpm_bios_patcher
2167 2167 s 
2167 2167 s ; 	LD	HL,SYSREG14	
2167 2167 s ; 	LD	(HL),1Ch	; Включаем карту памяти 1С, для CP/M
2167 2167 s 	
2167 2167 s 	;start with sysreg=14
2167 2167 s 
2167 2167 d 2ae922
2167 2167 s 	LD	HL,(RUNADR)
216a 216a d e9
216a 216a s 	JP	(HL)		; уходим по адресу запуска
216b 216b s 	
216b 216b s CheckBootParams:
216b 216b s 
216b 216b d 21e722
216b 216b s 	LD	HL,LOADR
216e 216e d cd8222
216e 216e s 	call 	FetchDEfromHL
2171 2171 s 
2171 2171 d 7a
2171 2171 s 	ld 	a,d
2172 2172 d fe22
2172 2172 s 	cp 	0x22 		; load addr shiould be >0x2200
2174 2174 d da9221
2174 2174 s 	jp 	c,.BadBootParam
2177 2177 s 
2177 2177 d 21e922
2177 2177 s 	LD	HL,RUNADR
217a 217a d cd8222
217a 217a s 	call 	FetchDEfromHL
217d 217d d 7a
217d 217d s 	ld 	a,d
217e 217e d fe22
217e 217e s 	cp 	0x22 		; run addr shiould be >0x2200
2180 2180 d da9221
2180 2180 s 	jp 	c,.BadBootParam
2183 2183 s 
2183 2183 d 21eb22
2183 2183 s 	LD	HL,SCOUNT
2186 2186 d 7e
2186 2186 s 	LD	A,(HL)
2187 2187 d b7
2187 2187 s 	or 	a
2188 2188 d ca9221
2188 2188 s 	jp 	z,.BadBootParam
218b 218b d fe30
218b 218b s 	cp 	48 		;sectors to load < 48
218d 218d d d29221
218d 218d s 	jp 	nc,.BadBootParam
2190 2190 s 
2190 2190 d af
2190 2190 s 	xor 	a
2191 2191 d c9
2191 2191 s 	ret
2192 2192 s 
2192 2192 s .BadBootParam:
2192 2192 d cdda21
2192 2192 s 	call 	ShowBootParams
2195 2195 d 219e21
2195 2195 s 	ld 	hl,msgBadBootParam
2198 2198 d cdc222
2198 2198 s 	CALL	PSTR
219b 219b d af
219b 219b s 	xor 	a
219c 219c d 3c
219c 219c s 	inc 	a
219d 219d d c9
219d 219d s 	ret
219e 219e s 
219e 219e s msgBadBootParam:
219e 219e d 0d0a
219e 219e s 	db 	0x0d,0x0a
21a0 21a0 d 496e636f727265637420626f6f7420706172616d65746572732064657465637465642c2066616c6c6261636b20746f2064656661756c74
21a0 21a0 s 	db 	'Incorrect boot parameters detected, fallback to default'
21d7 21d7 d 0d0a00
21d7 21d7 s 	db 	0x0d,0x0a,0
21da 21da s 
21da 21da s ShowBootParams:
21da 21da s 	; Вывод параметров загрузки на экран
21da 21da d 212923
21da 21da s 	LD	HL,HMBASE
21dd 21dd d cdc222
21dd 21dd s 	CALL	PSTR
21e0 21e0 d 21e722
21e0 21e0 s 	LD	HL,LOADR
21e3 21e3 d cd7722
21e3 21e3 s 	CALL	HEXW
21e6 21e6 d 212f23
21e6 21e6 s 	LD	HL,HMRUN
21e9 21e9 d cdc222
21e9 21e9 s 	CALL	PSTR
21ec 21ec d 21e922
21ec 21ec s 	LD	HL,RUNADR
21ef 21ef d cd7722
21ef 21ef s 	CALL	HEXW
21f2 21f2 d 213723
21f2 21f2 s 	LD	HL,HMPS
21f5 21f5 d cdc222
21f5 21f5 s 	CALL	PSTR
21f8 21f8 d 21eb22
21f8 21f8 s 	LD	HL,SCOUNT
21fb 21fb d 7e
21fb 21fb s 	LD	A,(HL)
21fc 21fc d cd5d22
21fc 21fc s 	CALL	HEX2
21ff 21ff d 214223
21ff 21ff s 	LD	HL,HMSS
2202 2202 d cdc222
2202 2202 s 	CALL	PSTR
2205 2205 d 21ec22
2205 2205 s 	LD	HL,SSIZE
2208 2208 d 7e
2208 2208 s 	LD	A,(HL)
2209 2209 d cd5d22
2209 2209 s 	CALL	HEX2
220c 220c d 214a23
220c 220c s 	LD	HL,HMSP
220f 220f d cdc222
220f 220f s 	CALL	PSTR
2212 2212 d 21ed22
2212 2212 s 	LD	HL,LSPT
2215 2215 d 7e
2215 2215 s 	LD	A,(HL)
2216 2216 d cd5d22
2216 2216 s 	CALL	HEX2
2219 2219 d c9
2219 2219 s 	ret
221a 221a s 
221a 221a s initLUT:
221a 221a d 21fbfa
221a 221a s 	ld      hl, 0xFAFB
221d 221d d 3ef8
221d 221d s 	ld      a, 0F8h 
221f 221f s 
221f 221f s .iniLUT:                  
221f 221f d 77
221f 221f s 	ld      (hl), a         ; F8,F9,FA,FB,FC,FD,FE,FF
2220 2220 d 3c
2220 2220 s 	inc     a
2221 2221 d c21f22
2221 2221 s 	jp      nz, .iniLUT      ; F8,F9,FA,FB,FC,FD,FE,FF
2224 2224 s 	
2224 2224 d 010811
2224 2224 s 	ld      bc, 1108h       ; A=0
2227 2227 s 	
2227 2227 s .iniLUTGRP:                  
2227 2227 d 77
2227 2227 s 	ld      (hl), a         ; 00,11,22,33,44,55,66,77
2228 2228 d 80
2228 2228 s 	add     a, b
2229 2229 d 0d
2229 2229 s 	dec     c
222a 222a d c22722
222a 222a s 	jp      nz, .iniLUTGRP   ; 00,11,22,33,44,55,66,77
222d 222d s 
222d 222d d c9
222d 222d s 	ret
222e 222e s 
222e 222e s 
222e 222e s ;****************************************
222e 222e s ;*  Прием байта из порта А по стробу    *
222e 222e s ;****************************************
222e 222e s GETBYTE:
222e 222e d e5
222e 222e s 	PUSH	HL
222f 222f d 210afb
222f 222f s 	LD	HL,PORTC
2232 2232 s WG:
2232 2232 d 7e
2232 2232 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2233 2233 d e620
2233 2233 s 	AND	20h		; выделяем сигнал IBF
2235 2235 d ca3222
2235 2235 s 	JP	Z,WG		; IBF=0 - данных еще нет
2238 2238 d 2d
2238 2238 s 	DEC	L
2239 2239 d 2d
2239 2239 s 	DEC	L
223a 223a d 7e
223a 223a s 	LD	A,(HL)		; данные поступили - выбираем их из порта А
223b 223b d e1
223b 223b s 	POP	HL
223c 223c d c9
223c 223c s 	RET
223d 223d s 
223d 223d s ;****************************************
223d 223d s ;*  Отправка байта в порт A             *
223d 223d s ;****************************************
223d 223d s PUTBYTE:
223d 223d d e5
223d 223d s 	PUSH	HL
223e 223e d f5
223e 223e s 	PUSH	AF
223f 223f d 210afb
223f 223f s 	LD	HL,PORTC
2242 2242 s WP:
2242 2242 d 7e
2242 2242 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2243 2243 d e680
2243 2243 s 	AND	80h		; выделяем сигнал -OBF
2245 2245 d ca4222
2245 2245 s 	JP	Z,WP		; -OBF=0 - в передатчике сидит незабранный байт
2248 2248 d 2d
2248 2248 s 	DEC	L
2249 2249 d 2d
2249 2249 s 	DEC	L
224a 224a d f1
224a 224a s 	POP	AF
224b 224b d 77
224b 224b s 	LD	(HL),A		; отправляем данные в порт данных
224c 224c d e1
224c 224c s 	POP	HL
224d 224d d c9
224d 224d s 	RET
224e 224e s 
224e 224e s ;****************************************
224e 224e s ;*      Печать полубайта в HEX          *
224e 224e s ;****************************************
224e 224e s 
224e 224e s HEX1:
224e 224e d e60f
224e 224e s 	AND	0Fh		; младший полубайт 
2250 2250 d c630
2250 2250 s 	ADD	'0'		; в ASCII
2252 2252 d fe3a
2252 2252 s 	CP	3Ah		; 0-9?
2254 2254 d da5922
2254 2254 s 	JP	C,H1D		; да
2257 2257 d c607
2257 2257 s 	ADD	7		; коррекция до A-F
2259 2259 d cdcc22
2259 2259 s H1D:	CALL	PUTCH		; Печать байта
225c 225c d c9
225c 225c s 	RET
225d 225d s 
225d 225d s ;****************************************
225d 225d s ;*      Печать байта в HEX              *
225d 225d s ;****************************************
225d 225d s 
225d 225d d f5
225d 225d s HEX2:	PUSH	AF
225e 225e d 0f
225e 225e s 	RRCA
225f 225f d 0f
225f 225f s 	RRCA			; сдвигаем старший полубайт в младший
2260 2260 d 0f
2260 2260 s 	RRCA
2261 2261 d 0f
2261 2261 s 	RRCA
2262 2262 d cd4e22
2262 2262 s 	CALL	HEX1		; печатаем его
2265 2265 d f1
2265 2265 s 	POP	AF
2266 2266 d e60f
2266 2266 s 	AND	0Fh		
2268 2268 d cd4e22
2268 2268 s 	CALL	HEX1		; печатаем младший полубайт
226b 226b d c9
226b 226b s 	RET
226c 226c s 
226c 226c s HEX4:
226c 226c d f5
226c 226c s 	push 	AF
226d 226d d 7c
226d 226d s 	ld 	a,h
226e 226e d cd5d22
226e 226e s 	call 	HEX2
2271 2271 d 7d
2271 2271 s 	ld 	a,l
2272 2272 d cd5d22
2272 2272 s 	call 	HEX2
2275 2275 d f1
2275 2275 s 	pop 	AF
2276 2276 d c9
2276 2276 s 	ret
2277 2277 s ;****************************************
2277 2277 s ;*  Печать слова (2 байта) из (HL)      *
2277 2277 s ;****************************************
2277 2277 s HEXW:
2277 2277 d 23
2277 2277 s 	INC	HL
2278 2278 d 7e
2278 2278 s 	LD	A,(HL)		; старший байт
2279 2279 d cd5d22
2279 2279 s 	CALL	HEX2
227c 227c d 2b
227c 227c s 	DEC	HL		; младший байт
227d 227d d 7e
227d 227d s 	LD	A,(HL)
227e 227e d cd5d22
227e 227e s 	CALL	HEX2
2281 2281 d c9
2281 2281 s 	RET
2282 2282 s 
2282 2282 s FetchDEfromHL:
2282 2282 d 5e
2282 2282 s 	LD	E,(HL)
2283 2283 d 23
2283 2283 s 	INC	HL
2284 2284 d 56
2284 2284 s 	LD	D,(HL)		; старший байт
2285 2285 d 2b
2285 2285 s 	DEC	HL		; младший байт
2286 2286 d c9
2286 2286 s 	RET
2287 2287 s 	
2287 2287 s 		
2287 2287 s ;****************************************
2287 2287 s ;*     Отправка командного пакета       *
2287 2287 s ;****************************************
2287 2287 s SENDCMD:
2287 2287 d e5
2287 2287 s 	PUSH	HL
2288 2288 d c5
2288 2288 s 	PUSH	BC
2289 2289 d 21e322
2289 2289 s 	LD	HL,CMD
228c 228c d 0e04
228c 228c s 	LD	C,4		; пакет - 4 байта
228e 228e d 0600
228e 228e s 	LD	B,0		; заготовка контрольной суммы
2290 2290 s SCL:
2290 2290 d 7e
2290 2290 s 	LD	A,(HL)		; очередной байт пакета 
2291 2291 d 80
2291 2291 s 	ADD 	B		; добавляем к КС
2292 2292 d 47
2292 2292 s 	LD	B,A
2293 2293 d 7e
2293 2293 s 	LD	A,(HL)		; очередной байт пакета 
2294 2294 d cd3d22
2294 2294 s 	CALL	PUTBYTE		; - в порт
2297 2297 d 23
2297 2297 s 	INC	HL
2298 2298 d 0d
2298 2298 s 	DEC	C
2299 2299 d c29022
2299 2299 s 	JP	NZ,SCL
229c 229c d 78
229c 229c s 	LD	A,B
229d 229d d 3d
229d 229d s 	DEC 	A		; КС-1
229e 229e d cd3d22
229e 229e s 	CALL	PUTBYTE     ; контрольная сумма
22a1 22a1 d cd2e22
22a1 22a1 s 	CALL	GETBYTE	    ; ответ контроллера
22a4 22a4 d c1
22a4 22a4 s 	POP	BC
22a5 22a5 d e1
22a5 22a5 s 	POP	HL
22a6 22a6 d c9
22a6 22a6 s 	RET
22a7 22a7 s 	
22a7 22a7 s 	
22a7 22a7 s ;*******************************************
22a7 22a7 s ;*      Прием сектора                      *
22a7 22a7 s ;* HL - адрес размещения сектора в памяти  *
22a7 22a7 s ;*  Размер сектора - 128 байт              *
22a7 22a7 s ;*******************************************
22a7 22a7 s GETSEC:
22a7 22a7 d c5
22a7 22a7 s 	PUSH	BC
22a8 22a8 d d5
22a8 22a8 s 	PUSH	DE
22a9 22a9 d 0e80
22a9 22a9 s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
22ab 22ab d eb
22ab 22ab s 	EX	DE,HL		; адрес буфера -> DE
22ac 22ac d 210afb
22ac 22ac s 	LD	HL,PORTC
22af 22af s GSL:
22af 22af d 7e
22af 22af s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
22b0 22b0 d e620
22b0 22b0 s 	AND	20h		; выделяем сигнал IBF
22b2 22b2 d caaf22
22b2 22b2 s 	JP	Z,GSL		; IBF=0 - данных еще нет
22b5 22b5 d 3a08fb
22b5 22b5 s 	LD	A,(PORTA)		; данные поступили - выбираем их из порта А
22b8 22b8 d 12
22b8 22b8 s 	LD	(DE),A		; принимаем и размещаем очередной байт
22b9 22b9 d 13
22b9 22b9 s 	INC	DE		; указатель буфера ++
22ba 22ba d 0d
22ba 22ba s 	DEC	C		; принимаем остальные байты
22bb 22bb d c2af22
22bb 22bb s 	JP	NZ,GSL
22be 22be d eb
22be 22be s 	EX	DE,HL		; адрес буфера -> HL
22bf 22bf d d1
22bf 22bf s 	POP	DE
22c0 22c0 d c1
22c0 22c0 s 	POP	BC
22c1 22c1 d c9
22c1 22c1 s 	RET
22c2 22c2 s 	
22c2 22c2 s 	
22c2 22c2 s 	
22c2 22c2 s ;****************************************
22c2 22c2 s ;  Печать строки на текстовый экран     *
22c2 22c2 s ;****************************************
22c2 22c2 s PSTR:
22c2 22c2 d 7e
22c2 22c2 s 	LD	A,(HL)
22c3 22c3 d 23
22c3 22c3 s 	INC	HL
22c4 22c4 d b7
22c4 22c4 s 	OR	A		; 0 - конец строки
22c5 22c5 d c8
22c5 22c5 s 	RET	Z
22c6 22c6 d cdcc22
22c6 22c6 s 	CALL	PUTCH		; выводим байт через вызов ОПТС
22c9 22c9 d c3c222
22c9 22c9 s 	JP	PSTR
22cc 22cc s 	
22cc 22cc s ;****************************************
22cc 22cc s ;   Вывод байта на экран через ОПТС
22cc 22cc s ;****************************************
22cc 22cc s PUTCH:
22cc 22cc d e5
22cc 22cc s 	PUSH	HL
22cd 22cd d c5
22cd 22cd s 	PUSH	BC
22ce 22ce d d5
22ce 22ce s 	PUSH	DE
22cf 22cf d 4f
22cf 22cf s 	LD	C,A
22d0 22d0 d cd4c00
22d0 22d0 s 	CALL	PCHDRV
22d3 22d3 d d1
22d3 22d3 s 	POP	DE
22d4 22d4 d c1
22d4 22d4 s 	POP	BC
22d5 22d5 d e1
22d5 22d5 s 	POP	HL
22d6 22d6 d c9
22d6 22d6 s 	RET
22d7 22d7 s 
22d7 22d7 s ;A - chr
22d7 22d7 s GETCH:
22d7 22d7 d fb
22d7 22d7 s 	EI
22d8 22d8 d e5
22d8 22d8 s 	PUSH	HL
22d9 22d9 d c5
22d9 22d9 s 	PUSH	BC
22da 22da d d5
22da 22da s 	PUSH	DE
22db 22db d cd4900
22db 22db s 	CALL	CONIN
22de 22de d d1
22de 22de s 	POP	DE
22df 22df d c1
22df 22df s 	POP	BC
22e0 22e0 d e1
22e0 22e0 s 	POP	HL
22e1 22e1 d f3
22e1 22e1 s 	DI
22e2 22e2 d c9
22e2 22e2 s 	RET
22e3 22e3 s 
22e3 22e3 s 
22e3 22e3 s ; Командный пакет	
22e3 22e3 d 01
22e3 22e3 s CMD:	DB	1		; Команда чтения
22e4 22e4 d 00
22e4 22e4 s DRV:	DB	0
22e5 22e5 d 00
22e5 22e5 s TRK:	DB	0
22e6 22e6 d 00
22e6 22e6 s SEC:	DB	0
22e7 22e7 s 
22e7 22e7 s ; Параметры загрузки из инфосектора
22e7 22e7 s LOADR:	DS	2	; адрес загрузки
22e9 22e9 s RUNADR:	DS	2	; адрес запуска
22eb 22eb s SCOUNT:	DS	1	; число загружаемых физических секторов
22ec 22ec s SSIZE:	DS	1	; коэффициент размера физического сектора
22ed 22ed s LSPT:	DS	1	; число логических секторов на дорожку
22ee 22ee s 
22ee 22ee s ; Текстовые строки для вывода на экран
22ee 22ee d 1f
22ee 22ee s HMSG:   DB	1Fh ; очистка экрана
22ef 22ef d 2d2d455854524f4d2053746167653220626f6f742076657273696f6e20312e3020627920466f7268333220262045534c20323031342d2d0d0a00
22ef 22ef s 	DB	"--EXTROM Stage2 boot version 1.0 by Forh32 & ESL 2014--",0dh,0ah,0	; текстовое сообщение на экран
2329 2329 d 424153453a00
2329 2329 s HMBASE: DB	"BASE:",0
232f 232f d 2053544152543a00
232f 232f s HMRUN:  DB	" START:",0
2337 2337 d 2050534543544f52533a00
2337 2337 s HMPS:   DB	" PSECTORS:",0
2342 2342 d 205353495a453a00
2342 2342 s HMSS:   DB	" SSIZE:",0
234a 234a d 204c5350543a00
234a 234a s HMSP:   DB	" LSPT:",0
2351 2351 d 204c534543544f52533a00
2351 2351 s HMLS:   DB	" LSECTORS:",0
235c 235c s ; HMTR:   DB	" TRACKS:",0
235c 235c d 0d0a00
235c 235c s HCRLF:	DB	0dh,0ah,0
235f 235f s mute_flag:
235f 235f d 00
235f 235f s 	db 	0
2360 2360 s tmpKEY:
2360 2360 d 00
2360 2360 s 	db 	0
2361 2361 s msgCPM:
2361 2361 d 43502f4d00
2361 2361 s  	db 	'CP/M',0
2366 2366 s msgMICRODOS:
2366 2366 d 4d4943524f444f5300
2366 2366 s 	db 	'MICRODOS',0
236f 236f s msgSUBST:
236f 236f d 4c6f61642064656661756c742000
236f 236f s  	db 	'Load default ',0 
237d 237d s msgASK_SUBST:
237d 237d d 203f28456e7465722f592d7965732c20432d43502f4d2c204d2d6d6963726f646f7329203f00
237d 237d s 	db 	' ?(Enter/Y-yes, C-CP/M, M-microdos) ?',0	
23a3 23a3 s 
23a3 23a3 s msgFORCEDDEFAULTBIOS:
23a3 23a3 d 0d0a2121204374726c2b5368696674202d20707265737365642c20666f7263656420746f207573652042494f5320535542535449545554494f4e2021210d0a0d0a00
23a3 23a3 s 	db 	0dh,0ah,'!! Ctrl+Shift - pressed, forced to use BIOS SUBSTITUTION !!',0dh,0ah,0dh,0ah,0
23e5 23e5 s 
23e5 23e5 s 	include 	"hw_test.asm"
23e5 23e5 f hw_test.asm
23e5 23e5 s _HW_ROM_OPTS1		equ 	1
23e5 23e5 s _HW_ROM_OPTS2		equ 	2
23e5 23e5 s 
23e5 23e5 s _HW_ROM_MODEL_OPTS11 	equ 	1
23e5 23e5 s _HW_ROM_MODEL_OPTS20 	equ 	2
23e5 23e5 s _HW_ROM_MODEL_KVANT8	equ 	3
23e5 23e5 s 
23e5 23e5 s _HW_GZU_SIZE_48K 	equ 	1
23e5 23e5 s _HW_GZU_SIZE_192K 	equ 	2
23e5 23e5 s 
23e5 23e5 s ;0 - undefined
23e5 23e5 s ;1 - OPTS 1.x
23e5 23e5 s ;2 - OPTS 2.x
23e5 23e5 s HW_ROM_OPTS_CLASS:
23e5 23e5 d 00
23e5 23e5 s 	db 	0 	
23e6 23e6 s 
23e6 23e6 s 
23e6 23e6 s ;0 - undefined
23e6 23e6 s ;1 - ОПТС 1.1
23e6 23e6 s ;2 - ОПТС 2.0
23e6 23e6 s ;3 - КОНТУР
23e6 23e6 s ;4 - КВАНТ-8 - Терминал
23e6 23e6 s ;5 - КВАНТ-8 - Тигрис
23e6 23e6 s ;6 - CPM.ROM
23e6 23e6 s HW_ROM_MODEL:
23e6 23e6 d 00
23e6 23e6 s 	db 	0
23e7 23e7 s 
23e7 23e7 s ;0 - undefined
23e7 23e7 s ;1 - 48k
23e7 23e7 s ;2 - 192k
23e7 23e7 d 00
23e7 23e7 s HW_GZU_SIZE:	db 	0
23e8 23e8 s 
23e8 23e8 s 
23e8 23e8 d 00
23e8 23e8 s HW_FDC_PRESENT:	db 	0
23e9 23e9 d 00
23e9 23e9 s HW_FDD_DRIVE_A:	db 	0		
23ea 23ea d 00
23ea 23ea s HW_FDD_DRIVE_B:	db 	0		
23eb 23eb d 00
23eb 23eb s HW_FDD_DRIVE_C:	db 	0		
23ec 23ec d 00
23ec 23ec s HW_FDD_DRIVE_D:	db 	0		
23ed 23ed s 
23ed 23ed s msg_tab8_rom_model:
23ed 23ed s 	;        01234567
23ed 23ed d 3f3f524f4d3f3f20
23ed 23ed s 	db 	'??ROM?? '
23f5 23f5 d 4f50545320312e31
23f5 23f5 s 	db 	'OPTS 1.1'
23fd 23fd d 4f50545320322e30
23fd 23fd s 	db 	'OPTS 2.0'
2405 2405 d 4b76616e74382020
2405 2405 s 	db 	'Kvant8  '
240d 240d s ;нет поддержки загрузки EXTROM
240d 240d s ; 	db 	'Kontur  ' 	
240d 240d s ; 	db 	'Kvant8-T'
240d 240d s ; 	db 	'CPM     '
240d 240d s 
240d 240d s msg_tab8_gzu_size:
240d 240d s 	;        01234567
240d 240d d 3f3f3f6b20000000
240d 240d s 	db 	'???k ',0,0,0
2415 2415 d 34386b2000000000
2415 2415 s 	db 	'48k ',0,0,0,0
241d 241d d 3139326b20000000
241d 241d s 	db 	'192k ',0,0,0
2425 2425 s 
2425 2425 s msg_tab16_fdc:
2425 2425 s 	;        01234  5     6   789012  3     4  5
2425 2425 d 3130202d201b366e6f204644431b3700
2425 2425 s 	db 	'10 - ',01bh,'6','no FDC',01bh,'7',0
2435 2435 s 	;        0123456789012345
2435 2435 d 323020776974682046444300
2435 2435 s 	db 	'20 with FDC',0
2441 2441 s 
2441 2441 s msg_rom_model:
2441 2441 d 524f4d3a2000
2441 2441 s 	db 	'ROM: ',0
2447 2447 s msg_gzu_size:
2447 2447 d 207c20475a553a2000
2447 2447 s 	db 	' | GZU: ',0
2450 2450 s msg_fdc:
2450 2450 d 207c20504b383000
2450 2450 s 	db 	' | PK80',0
2458 2458 s 
2458 2458 s ; CP/M-80  
2458 2458 s ; v. 2.2..SHCOMP BIOS Ver. 1.0 1991
2458 2458 s 
2458 2458 s putstr16:
2458 2458 d 0e10
2458 2458 s 	ld 	c,16
245a 245a d 6f
245a 245a s 	ld 	l,a
245b 245b d 2600
245b 245b s 	ld 	h,0
245d 245d d 29
245d 245d s 	add 	hl,hl 	
245e 245e d c36624
245e 245e s 	jp 	putx8
2461 2461 s ; a - n
2461 2461 s ;DE - base addr
2461 2461 s putstr8:
2461 2461 d 0e08
2461 2461 s 	ld 	c,8
2463 2463 d 6f
2463 2463 s 	ld 	l,a
2464 2464 d 2600
2464 2464 s 	ld 	h,0
2466 2466 s putx8:
2466 2466 d 29
2466 2466 s 	add 	hl,hl 	
2467 2467 d 29
2467 2467 s 	add 	hl,hl 	
2468 2468 d 29
2468 2468 s 	add 	hl,hl 	
2469 2469 d 19
2469 2469 s 	add 	hl,de
246a 246a s 
246a 246a s putstr_:
246a 246a d 79
246a 246a s 	ld 	a,c
246b 246b d b7
246b 246b s 	or 	a
246c 246c d c8
246c 246c s 	ret 	z
246d 246d d 0d
246d 246d s 	dec 	c
246e 246e d 7e
246e 246e s 	LD	A,(HL)
246f 246f d b7
246f 246f s 	or 	a
2470 2470 d c8
2470 2470 s 	ret 	z
2471 2471 s ; 	jp 	nz,.putNoSpc
2471 2471 s ; 	ld 	a,'_'
2471 2471 s ; 	dec 	hl
2471 2471 s .putNoSpc:
2471 2471 d 23
2471 2471 s 	INC	HL
2472 2472 d cdcc22
2472 2472 s 	CALL	PUTCH		
2475 2475 d c36a24
2475 2475 s 	JP	putstr_
2478 2478 s 
2478 2478 s show_hardware_info:
2478 2478 d 214124
2478 2478 s 	ld 	hl,msg_rom_model
247b 247b d cdc222
247b 247b s 	call 	PSTR
247e 247e s 
247e 247e d 3ae623
247e 247e s 	ld 	a,(HW_ROM_MODEL)
2481 2481 d 11ed23
2481 2481 s 	ld 	de,msg_tab8_rom_model
2484 2484 d cd6124
2484 2484 s 	call 	putstr8
2487 2487 s 
2487 2487 d 215024
2487 2487 s 	ld 	hl,msg_fdc
248a 248a d cdc222
248a 248a s 	call 	PSTR
248d 248d s 
248d 248d d 3ae823
248d 248d s 	ld 	a,(HW_FDC_PRESENT)
2490 2490 d 112524
2490 2490 s 	ld 	de,msg_tab16_fdc
2493 2493 d cd5824
2493 2493 s 	call 	putstr16
2496 2496 s 
2496 2496 s ; 	ld 	a,'/'
2496 2496 s ; 	call 	PUTCH
2496 2496 s 
2496 2496 s ; 	ld 	a,(HW_ROM_OPTS_CLASS)
2496 2496 s ; 	call 	HEX2
2496 2496 s 
2496 2496 d 214724
2496 2496 s 	ld 	hl,msg_gzu_size
2499 2499 d cdc222
2499 2499 s 	call 	PSTR
249c 249c s 
249c 249c d 3ae723
249c 249c s 	ld 	a,(HW_GZU_SIZE)
249f 249f d 110d24
249f 249f s 	ld 	de,msg_tab8_gzu_size
24a2 24a2 d cd6124
24a2 24a2 s 	call 	putstr8
24a5 24a5 s 
24a5 24a5 d 215c23
24a5 24a5 s 	LD	HL,HCRLF
24a8 24a8 d cdc222
24a8 24a8 s 	CALL	PSTR
24ab 24ab s 
24ab 24ab d c9
24ab 24ab s 	ret
24ac 24ac s 
24ac 24ac s 
24ac 24ac s hw_test:
24ac 24ac d cd1f25
24ac 24ac s 	call 	hw_check_rom
24af 24af d cdcc24
24af 24af s 	call 	hw_check_gzu_size
24b2 24b2 d cdb924
24b2 24b2 s 	call 	hw_check_floppy
24b5 24b5 d cd7824
24b5 24b5 s 	call 	show_hardware_info
24b8 24b8 s 
24b8 24b8 s ; 	halt
24b8 24b8 d c9
24b8 24b8 s 	ret
24b9 24b9 s 
24b9 24b9 s hw_check_floppy:
24b9 24b9 d 3e01
24b9 24b9 s 	ld 	a,1
24bb 24bb d 11e823
24bb 24bb s 	ld 	de,HW_FDC_PRESENT
24be 24be d 12
24be 24be s 	ld 	(de),a
24bf 24bf s 
24bf 24bf s ; Проверка наличия дисководов
24bf 24bf d 2119fb
24bf 24bf s 	LD	HL,0FB19H 	; регистр дорожки
24c2 24c2 d 3605
24c2 24c2 s 	LD	(HL),5		; записываем образец
24c4 24c4 d 7e
24c4 24c4 s 	LD	A,(HL)
24c5 24c5 d fe05
24c5 24c5 s 	CP	5		; проверяем
24c7 24c7 d c8
24c7 24c7 s 	RET 	Z		; совпал - FDC у нас есть
24c8 24c8 d 3e00
24c8 24c8 s 	ld 	a,0
24ca 24ca d 12
24ca 24ca s 	ld 	(de),a
24cb 24cb d c9
24cb 24cb s 	ret
24cc 24cc s ; В машине нет FDC
24cc 24cc s ; 	XOR	A	
24cc 24cc s ; 	LD	(CPMT02-2),A	; Очищаем маски дисков C и D
24cc 24cc s ; 	LD	(CPMT03-2),A	; Они становятся эмулируемыми
24cc 24cc s ; 	RET	ret 
24cc 24cc s 
24cc 24cc s NCREG 	equ 	0xFE3A
24cc 24cc s VIREG 	equ 	0xFFBF
24cc 24cc s 
24cc 24cc s hw_check_gzu_size:
24cc 24cc s ; 	проверка ГЗУ, не убивая рамдиск в 1+ страницах
24cc 24cc s ; 	включаем 0 страницу на доступ
24cc 24cc s ; 	в последние 3 байта пишем значения
24cc 24cc s ; 	включаем 3 страницу на доступ
24cc 24cc s ; 	проверяем содержимое этих байт
24cc 24cc s ; 	если совпало то 48к (т.к. переключение не проихошло)
24cc 24cc s ; 	иначе счетаем что 192к
24cc 24cc s 
24cc 24cc s 
24cc 24cc s ;3C  DOSG1          0000-3FFF  4000  8000-FDFF        FF00        FE00
24cc 24cc d 3e3c
24cc 24cc s 	ld 	a,0x3C
24ce 24ce d 327ffa
24ce 24ce s 	ld 	(SYSREG14),a
24d1 24d1 s 
24d1 24d1 d 21ff7f
24d1 24d1 s         ld      hl, 07FFFh 	;last gzu byte
24d4 24d4 s 
24d4 24d4 s 	; vireg pointed to RW page 0
24d4 24d4 s 
24d4 24d4 d 3ea4
24d4 24d4 s         ld      a,0x80 | 4 | 0x20 ;color 2 - green (должен быть не 1)
24d6 24d6 d 32bfff
24d6 24d6 s         ld      (VIREG), a
24d9 24d9 s 
24d9 24d9 d 01aa55
24d9 24d9 s         ld 	bc,0x55aa
24dc 24dc d 70
24dc 24dc s         ld      (hl), b   
24dd 24dd d 2b
24dd 24dd s         dec 	hl
24de 24de d 71
24de 24de s         ld 	(hl), c
24df 24df d 2b
24df 24df s         dec 	hl
24e0 24e0 d 75
24e0 24e0 s         ld 	(hl), l
24e1 24e1 d 23
24e1 24e1 s         inc 	hl
24e2 24e2 d 23
24e2 24e2 s         inc 	hl
24e3 24e3 s 
24e3 24e3 d 3ee0
24e3 24e3 s         ld      a, 0xE0 	;SCR_PAGE0|ATTR_RESET|RW_PAGE3
24e5 24e5 d 323afe
24e5 24e5 s         ld      (NCREG), a
24e8 24e8 s 
24e8 24e8 s         ;читаем инвертированные значения не 0x55aa а 0xaa55
24e8 24e8 d 79
24e8 24e8 s         ld 	a,c 		
24e9 24e9 d be
24e9 24e9 s         cp 	m
24ea 24ea d c20025
24ea 24ea s         jp 	nz,.zgu192k
24ed 24ed d 2b
24ed 24ed s         dec 	hl
24ee 24ee d 78
24ee 24ee s         ld 	a,b
24ef 24ef d be
24ef 24ef s         cp 	m
24f0 24f0 d c20025
24f0 24f0 s         jp 	nz,.zgu192k
24f3 24f3 d 2b
24f3 24f3 s         dec 	hl
24f4 24f4 d 7d
24f4 24f4 s         ld 	a,l
24f5 24f5 d eeff
24f5 24f5 s         xor 	0xff
24f7 24f7 d be
24f7 24f7 s         cp 	m
24f8 24f8 d c20025
24f8 24f8 s         jp 	nz,.zgu192k
24fb 24fb s 
24fb 24fb d 3e01
24fb 24fb s         ld 	a,_HW_GZU_SIZE_48K
24fd 24fd d c30225
24fd 24fd s         jp      .setgzusize 
2500 2500 s 
2500 2500 s .zgu192k:
2500 2500 d 3e02
2500 2500 s         ld 	a,_HW_GZU_SIZE_192K
2502 2502 s 
2502 2502 s .setgzusize:
2502 2502 d 32e723
2502 2502 s         ld      (HW_GZU_SIZE),a
2505 2505 s 
2505 2505 d 3e20
2505 2505 s         ld 	a,0x20		;SCR_PAGE0|ATTR_RESET|RW_PAGE0
2507 2507 d 323afe
2507 2507 s         ld      (NCREG),a  	
250a 250a s 
250a 250a s         ;стереть следы проверки
250a 250a d 3e92
250a 250a s         ld      a,0x80 | 2 | 0x10 ;color 1 - blue
250c 250c d 32bfff
250c 250c s         ld      (VIREG), a
250f 250f d 21ff7f
250f 250f s         ld 	hl,0x7fff
2512 2512 d 3eff
2512 2512 s         ld 	a,0xff
2514 2514 d 77
2514 2514 s         ld 	(hl),a
2515 2515 d 2b
2515 2515 s         dec 	hl
2516 2516 d 77
2516 2516 s         ld 	(hl),a
2517 2517 d 2b
2517 2517 s         dec 	hl
2518 2518 d 77
2518 2518 s         ld 	(hl),a
2519 2519 s 
2519 2519 d 3e14
2519 2519 s 	ld 	a,0x14;
251b 251b d 327fff
251b 251b s 	ld 	(SYSREG3C),a
251e 251e s 
251e 251e d c9
251e 251e s 	ret
251f 251f s 
251f 251f s hw_check_rom:
251f 251f d 210000
251f 251f s 	ld 	hl,0
2522 2522 d 0e00
2522 2522 s 	ld 	c,0
2524 2524 d 3f
2524 2524 s 	ccf
2525 2525 s .romcrc:
2525 2525 d 79
2525 2525 s 	ld 	a,c
2526 2526 d 8e
2526 2526 s 	adc 	a,(hl)
2527 2527 d 4f
2527 2527 s 	ld 	c,a
2528 2528 d 23
2528 2528 s 	inc 	hl
2529 2529 d 7d
2529 2529 s 	ld 	a,l
252a 252a d b7
252a 252a s 	or 	a
252b 252b d c22525
252b 252b s 	jp 	nz,.romcrc
252e 252e d 79
252e 252e s 	ld 	a,c
252f 252f s 
252f 252f d 0601
252f 252f s 	ld 	b,_HW_ROM_OPTS1
2531 2531 d 0e01
2531 2531 s 	ld 	c,_HW_ROM_MODEL_OPTS11
2533 2533 d fe9a
2533 2533 s 	cp 	0x9A
2535 2535 d ca4a25
2535 2535 s 	jp 	z,.rom_found
2538 2538 s 
2538 2538 d 0e03
2538 2538 s 	ld 	c,_HW_ROM_MODEL_KVANT8
253a 253a d fe66
253a 253a s 	cp 	0x66
253c 253c d ca4a25
253c 253c s 	jp 	z,.rom_found
253f 253f s 
253f 253f d 0602
253f 253f s 	ld 	b,_HW_ROM_OPTS2
2541 2541 d 0e02
2541 2541 s 	ld 	c,_HW_ROM_MODEL_OPTS20
2543 2543 d febb
2543 2543 s 	cp 	0xBB
2545 2545 d ca4a25
2545 2545 s 	jp 	z,.rom_found
2548 2548 s 
2548 2548 d 0e00
2548 2548 s 	ld 	c,0
254a 254a s .rom_found:
254a 254a d 78
254a 254a s 	ld 	a,b
254b 254b d 32e523
254b 254b s 	ld 	(HW_ROM_OPTS_CLASS),a
254e 254e d 79
254e 254e s 	ld 	a,c
254f 254f d 32e623
254f 254f s 	ld 	(HW_ROM_MODEL),a
2552 2552 s 
2552 2552 f stage2.asm
2552 2552 d c9
2552 2552 s 	ret
2553 2553 s 	include 	"generator/V0/extrom-patcher.asm"
2553 2553 f generator/V0/extrom-patcher.asm
2553 2553 s ;по адресу bios_variants табличка ссылок на все известные биосы
2553 2553 s ;пробуем выяснить какой биос загружен сейчас.
2553 2553 s ;если не нашли - fallback to default forth32 cp/m bios
2553 2553 s ;TODO: fallback to microdos if required
2553 2553 s ;TODO: ask user about fallback
2553 2553 s 
2553 2553 s ;алгоритм патчера
2553 2553 s ;на момент статрта в памяти уже есть загруженый в свои адреса биос, проверим что это нужный и пропатчим его
2553 2553 s ;проход 1, проверка, читаем байткоды (с доп параметрами) и проверяем что "первый параметр" совпадает, 
2553 2553 s ;если нет то считаем что это не нужный нам биос, и надо проверять следующий.
2553 2553 s ;проход 2, если на превом проходе всё проверки совпали
2553 2553 s ;то проходим и записываем занчение из "второго параметра"
2553 2553 s ;заодно выставляем флаги.
2553 2553 s ;чеки надо ставить в начале цепочки (по идее)
2553 2553 s ;последний байт обязательно p_STOP
2553 2553 s ;ругаемся на невалидный токен, для отладки.
2553 2553 s 
2553 2553 s ;токены патчера и их значения
2553 2553 s 
2553 2553 s p_STOP 			EQU 	0x50	;должен быть последним токено в цепочке, патчер
2553 2553 s 					;за ним следует строка с 0 - имя биоса
2553 2553 s 					; 	db 	p_STOP
2553 2553 s 					; 	db 	'21_89___wiza',0
2553 2553 s pW_CHK_PATCH 		EQU	0x51 	;проверить значение СЛОВА, записать новое значение, параметры DW ADDR, OLDVALUE, NEWVALUE
2553 2553 s 					;на этапе чека проверяем 1й параметр, на этапе патча записываем 2й
2553 2553 s 					; 	db 	pW_CHK_PATCH
2553 2553 s 					; 	dw 	0xDCBB+1,0xE06E,0xE06E
2553 2553 s pB_CHK_PATCH 		EQU 	0x52 	;проверить значение БАЙТА, записать новое значение, параметры DW ADDR, DB OLDVALUE, NEWVALUE
2553 2553 s 					;на этапе чека проверяем 1й параметр, на этапе патча записываем 2й
2553 2553 s 					; 	db 	pB_CHK_PATCH
2553 2553 s 					; 	dw 	0xE70A
2553 2553 s 					; 	db	0x77,0x00
2553 2553 s pW_STORE		EQU 	0x54 	;записать значение СЛОВА, параметры DW ADDR, NEWVALUE
2553 2553 s 					;на этапе чека игнорируется, на этапе патча - применяем
2553 2553 s 					; 	db 	pW_STORE
2553 2553 s 					; 	dw 	0xE06E,r_p_SELDSKDRIVER+1	 
2553 2553 s pNotSupported 		EQU 	0x55 	;выставляет флаг что биос не поддерживается
2553 2553 s 					;используется для биосов которые детектятся но сейчас не поддерживаются
2553 2553 s 					;на этапе чека игнорируется
2553 2553 s 					;	db 	pNotSupported
2553 2553 s pSETFLAG_MICRODOS 	EQU 	0x56	;выставляет флаг что биос текущий биос - микродос (по умолчанию считаем что cp/m)
2553 2553 s 					;на этапе чека игнорируется
2553 2553 s 					; 	db 	pSETFLAG_MICRODOS
2553 2553 s pREQUIRED_OPTS1 	EQU 	0x57	;проверить версию ROM, если не ОПТС 1 то вывести сообщение и поставить флг Unsupported
2553 2553 s 					;на этапе чека игнорируется
2553 2553 s 					;	db 	pREQUIRED_OPTS2
2553 2553 s pREQUIRED_OPTS2 	EQU 	0x58	;проверить версию ROM, если не ОПТС 2 то вывести сообщение и поставить флг Unsupported
2553 2553 s 					;на этапе чека игнорируется
2553 2553 s 					;	db 	pREQUIRED_OPTS2
2553 2553 s pB_MAYBE_PATCH 		EQU 	0x59 	;записать новое значение если старое совпадает, параметры DW ADDR, DB OLDVALUE, NEWVALUE
2553 2553 s 					;на этапе чека не проверяем
2553 2553 s 					;на этапа патча проверяем 1й параметр и если совпал записываем 2й
2553 2553 s 					;применяется для патча текстовых строк которые могут быть изменены
2553 2553 s 					; 	db 	pB_CHK_PATCH
2553 2553 s 					; 	dw 	0xE70A
2553 2553 s 					; 	db	0x77,0x00
2553 2553 s pSubBios		EQU 	0x5A	;записывает значение в переменную flag_subbios 
2553 2553 s 					;используется чтобы указать какой вариант резидента использовать
2553 2553 s 					; 	db 	pSubBios
2553 2553 s 					; 	db 	0
2553 2553 s 
2553 2553 s 
2553 2553 s DEBUG_TRACE_PATCHER	EQU 	0
2553 2553 s 
2553 2553 s stop 	macro msg
2553 2553 s 	db 	p_STOP
2553 2553 s 	db 	msg
2553 2553 s 	db 	0
2553 2553 s 	endm
2553 2553 s 
2553 2553 s dbpatch macro addr,oldbyte,newbyte
2553 2553 s 	db 	pB_CHK_PATCH
2553 2553 s 	dw 	addr
2553 2553 s 	db 	oldbyte,newbyte
2553 2553 s 	endm
2553 2553 s 
2553 2553 s dbpatchmaybe macro addr,oldbyte,newbyte
2553 2553 s 	db 	pB_MAYBE_PATCH
2553 2553 s 	dw 	addr
2553 2553 s 	db 	oldbyte,newbyte
2553 2553 s 	endm
2553 2553 s 
2553 2553 s dwpatch macro addr,oldword,newword
2553 2553 s 	db 	pW_CHK_PATCH
2553 2553 s 	dw 	addr
2553 2553 s 	dw 	oldword,newword
2553 2553 s 	endm
2553 2553 s 
2553 2553 s dwstore macro addr,newword
2553 2553 s 	db 	pW_STORE
2553 2553 s 	dw 	newword
2553 2553 s 	dw 	addr
2553 2553 s 	endm
2553 2553 s 
2553 2553 s setCPM 	macro 	
2553 2553 s 	endm
2553 2553 s 
2553 2553 s setSUBBIOS 	macro  id
2553 2553 s 	db	pSubBios
2553 2553 s 	db 	id
2553 2553 s 	endm
2553 2553 s 
2553 2553 s setMICRODOS macro
2553 2553 s 	db 	pSETFLAG_MICRODOS
2553 2553 s 	endm
2553 2553 s 
2553 2553 s setUNSUPPORTED macro
2553 2553 s 	db 	pNotSupported
2553 2553 s 	endm
2553 2553 s 
2553 2553 s RQ_OPTS1	macro
2553 2553 s 	db 	pREQUIRED_OPTS1
2553 2553 s 	endm
2553 2553 s 
2553 2553 s RQ_OPTS2	macro
2553 2553 s 	db 	pREQUIRED_OPTS2
2553 2553 s 	endm
2553 2553 s 
2553 2553 s RQ_OPTS_ANY	macro
2553 2553 s 	endm
2553 2553 s 
2553 2553 s 
2553 2553 s cpm_bios_patcher:
2553 2553 s 
2553 2553 s 	;dirty hasck
2553 2553 s 	;set jp 0 as first jp
2553 2553 s 	;strange dos behaviour,
2553 2553 s 	;sometime hangon when dir
2553 2553 d 210000
2553 2553 s 	ld 	hl,0
2556 2556 d 220120
2556 2556 s 	ld 	(BASE+1),hl 	;
2559 2559 s 
2559 2559 d 21bd25
2559 2559 s 	ld 	hl,msgPATCHER
255c 255c d cdc222
255c 255c s 	call 	PSTR
255f 255f s 
255f 255f s 	; mute message for second time (fallback code)
255f 255f d 3e00
255f 255f s 	ld 	a,0
2561 2561 d 32bd25
2561 2561 s 	ld 	(msgPATCHER),a
2564 2564 s 
2564 2564 s 
2564 2564 s ; 	call 	get_rom_version
2564 2564 s 
2564 2564 d 111c2f
2564 2564 s 	ld 	de,bios_variants
2567 2567 s chk_bios_lp:
2567 2567 d 1a
2567 2567 s 	ld 	a,(de)
2568 2568 d 6f
2568 2568 s 	ld 	l,a
2569 2569 d 13
2569 2569 s 	inc 	de
256a 256a d 1a
256a 256a s 	ld 	a,(de)
256b 256b d 67
256b 256b s 	ld 	h,a
256c 256c d 13
256c 256c s 	inc 	de
256d 256d d b5
256d 256d s 	or 	l
256e 256e d ca7c25
256e 256e s 	jp 	z,bios_not_found
2571 2571 s 
2571 2571 d d5
2571 2571 s 	push 	de
2572 2572 d cd7026
2572 2572 s 	call 	try_bios
2575 2575 d d1
2575 2575 s 	pop 	de
2576 2576 s 
2576 2576 d ca8525
2576 2576 s 	jp 	z,bios_found
2579 2579 s 
2579 2579 d c36725
2579 2579 s 	jp 	chk_bios_lp
257c 257c s 
257c 257c s 
257c 257c s bios_not_found:
257c 257c s 
257c 257c d 21ec25
257c 257c s 	ld 	hl,msgNOTFOUND
257f 257f d cdc222
257f 257f s 	call 	PSTR
2582 2582 s 	
2582 2582 s ; 	halt
2582 2582 s 
2582 2582 d c33020
2582 2582 s 	jp 	force_subst
2585 2585 s 
2585 2585 s bios_found:
2585 2585 d 2b
2585 2585 s 	dec 	hl
2586 2586 d 7e
2586 2586 s 	ld 	a,(hl)
2587 2587 d 23
2587 2587 s 	inc 	hl
2588 2588 d fe50
2588 2588 s 	cp 	p_STOP
258a 258a d ca9425
258a 258a s 	jp 	z,.found_cont
258d 258d s 
258d 258d d 217728
258d 258d s 	ld 	hl,msg_StrangeHLAfterPatch
2590 2590 d cdc222
2590 2590 s 	call 	PSTR
2593 2593 d 76
2593 2593 s 	halt
2594 2594 s 
2594 2594 s .found_cont:
2594 2594 d e5
2594 2594 s 	push 	hl 		;bios name
2595 2595 d 21e125
2595 2595 s 	ld 	hl,msgFOUND
2598 2598 d cdc222
2598 2598 s 	call 	PSTR
259b 259b d e1
259b 259b s 	pop 	hl
259c 259c d cdc222
259c 259c s 	call 	PSTR
259f 259f d 212526
259f 259f s 	ld 	hl,msgCRLF
25a2 25a2 d cdc222
25a2 25a2 s 	call 	PSTR
25a5 25a5 s 
25a5 25a5 d 2abb25
25a5 25a5 s 	ld 	hl,(msg_warning)
25a8 25a8 d 7d
25a8 25a8 s 	ld 	a,l
25a9 25a9 d b4
25a9 25a9 s 	or 	h
25aa 25aa d c4c222
25aa 25aa s 	call 	nz,PSTR
25ad 25ad s 
25ad 25ad d 3ab825
25ad 25ad s 	ld 	a,(flag_unsupported)
25b0 25b0 d b7
25b0 25b0 s 	or 	a
25b1 25b1 d c27c25
25b1 25b1 s 	jp 	nz,bios_not_found
25b4 25b4 s 
25b4 25b4 d cdd628
25b4 25b4 s 	call 	show_mount_info
25b7 25b7 s 
25b7 25b7 s ; 	halt
25b7 25b7 d c9
25b7 25b7 s 	ret
25b8 25b8 s 
25b8 25b8 s ; get_rom_version:
25b8 25b8 s ; ;opts1.1
25b8 25b8 s ; ; RAM:003B FF                       db 0FFh
25b8 25b8 s ; ;opts2.0
25b8 25b8 s ; ; RAM:003B 02                       db    2
25b8 25b8 s ; ; kontur
25b8 25b8 s ; ; RAM:003B 05                       dec     b
25b8 25b8 s ; ;kvant8 terminal 
25b8 25b8 s ; ; RAM:003B 00                       db    0
25b8 25b8 s ; ;kvant8 - tigris
25b8 25b8 s ; ; RAM:003B FF                       db 0FFh
25b8 25b8 s 
25b8 25b8 s ; ; RAM:050F EF F0 F4+msgOPTS:        text "KOI8-R", 'OPTS  1.1',0
25b8 25b8 s ; ; RAM:051B EF F0 F4+Logo1:          text "KOI8-R", 'OPTS  2.0',0 
25b8 25b8 s ; 	ld 	a,(0x003b)
25b8 25b8 s ; 	cp 	0xff
25b8 25b8 s ; 	jp 	z,.opts1
25b8 25b8 s 
25b8 25b8 s ; 	cp 	2
25b8 25b8 s ; 	jp 	z,.opts2
25b8 25b8 s 
25b8 25b8 s ; .opts1:
25b8 25b8 s ; 	ld 	a,'1'
25b8 25b8 s ; 	db 	0x21
25b8 25b8 s ; .opts2:
25b8 25b8 s ; 	ld 	a,'2'	
25b8 25b8 s ; 	ld 	(rom_version),a
25b8 25b8 s ; 	ret
25b8 25b8 s 
25b8 25b8 s ; rom_version:
25b8 25b8 s ; 	db 	0 	;1 - opts1, 2-opts2
25b8 25b8 s 
25b8 25b8 s 
25b8 25b8 s 
25b8 25b8 s flag_unsupported:
25b8 25b8 d 00
25b8 25b8 s 	db 	0
25b9 25b9 s flag_microdos:
25b9 25b9 d 00
25b9 25b9 s 	db 	0	
25ba 25ba s flag_subbios:
25ba 25ba d 00
25ba 25ba s 	db 	0
25bb 25bb s msg_warning:
25bb 25bb d 0000
25bb 25bb s 	dw 	0
25bd 25bd s 
25bd 25bd s 
25bd 25bd s msgPATCHER:
25bd 25bd d 0d0a42494f532050415443484552205620312e35322062792045534c20323031340d0a00
25bd 25bd s 	db 	0dh,0ah,'BIOS PATCHER V 1.52 by ESL 2014',0dh,0ah,0
25e1 25e1 s msgFOUND:
25e1 25e1 d 44657465637465643a2000
25e1 25e1 s 	db 	'Detected: ',0
25ec 25ec s msgNOTFOUND:
25ec 25ec d 42494f5320556e737570706f72746564206f722042726f6b656e2c20
25ec 25ec s 	db 	'BIOS Unsupported or Broken, '
2608 2608 d 1b36
2608 2608 s 	db 	01bh,'6'
260a 260a d 66616c6c6261636b20746f2044454641554c542062696f732e
260a 260a s 	db 	'fallback to DEFAULT bios.'
2623 2623 d 1b37
2623 2623 s 	db 	01bh,'7'
2625 2625 s msgCRLF:
2625 2625 d 0d0a00
2625 2625 s 	db 	0dh,0ah,0
2628 2628 s 
2628 2628 s msgREQ_OPTS:
2628 2628 d 20212120
2628 2628 s 	db 	' !! '
262c 262c d 1b36
262c 262c s 	db 	01bh,'6'
262e 262e d 42494f532072657175697265204f50545320
262e 262e s 	db 	'BIOS require OPTS '
2640 2640 s msgREQ_OPTS_digit:
2640 2640 d 312e7820524f4d
2640 2640 s 	db 	'1.x ROM'
2647 2647 d 1b37
2647 2647 s 	db 	01bh,'7'
2649 2649 d 20616e64206e6f7420636f6d70617469626c6520776974682063757272656e742e
2649 2649 s 	db 	' and not compatible with current.'
266a 266a d 0d0a
266a 266a s 	db 	0dh,0ah
266c 266c d 00
266c 266c s 	db 	0
266d 266d s 
266d 266d s work_ptr:
266d 266d d 0000
266d 266d s 	dw 	0;
266f 266f s patch_flag:
266f 266f d 00
266f 266f s 	db 	0
2670 2670 s 
2670 2670 s ;проверит совпадает ли биос с табличкой
2670 2670 s ;на входе в HL табличка для биоса
2670 2670 s ;если совпало то HL укзывает на имя биоса
2670 2670 s try_bios:
2670 2670 d 226d26
2670 2670 s 	ld 	(work_ptr),hl
2673 2673 s 
2673 2673 s 	;check
2673 2673 d af
2673 2673 s 	xor 	a
2674 2674 d 2a6d26
2674 2674 s 	ld 	hl,(work_ptr)
2677 2677 d cd2927
2677 2677 s 	call 	do_patch
267a 267a d c0
267a 267a s 	ret nz
267b 267b s 
267b 267b s ; 	halt
267b 267b s 
267b 267b s 	;скопировали резидент в дырку
267b 267b s 
267b 267b s 	;preprare to PATCH
267b 267b s 
267b 267b s 	;copy resident
267b 267b s 
267b 267b d 3ab925
267b 267b s 	ld 	a,(flag_microdos)
267e 267e d b7
267e 267e s 	or 	a
267f 267f d c2fb26
267f 267f s 	jp 	nz,move_microdos_resident
2682 2682 s 
2682 2682 d 3aba25
2682 2682 s 	ld 	a,(flag_subbios)
2685 2685 d fe01
2685 2685 s 	cp 	1
2687 2687 d ca9a26
2687 2687 s 	jp 	z,.cpmsubBios1
268a 268a d fe02
268a 268a s 	cp 	2
268c 268c d caac26
268c 268c s 	jp 	z,.cpmsubBios2
268f 268f d fe03
268f 268f s 	cp 	3 			;no resident part
2691 2691 d cabe26
2691 2691 s 	jp 	z,.cpmNoResident
2694 2694 s 
2694 2694 d 215428
2694 2694 s 	ld 	hl,msgUndefindedsubBios
2697 2697 d cdc222
2697 2697 s 	call 	PSTR
269a 269a s ; 	halt
269a 269a s 
269a 269a s 
269a 269a s .cpmsubBios1:
269a 269a s 
269a 269a d 21ace8
269a 269a s 	ld 	hl,_CPM1_res_DRIVE_TAB
269d 269d d 22362a
269d 269d s 	ld 	(drivetab_mount_info),hl
26a0 26a0 s 
26a0 26a0 d 21de2a
26a0 26a0 s 	ld 	hl,resident_cpm1
26a3 26a3 d 11ace8
26a3 26a3 s 	ld 	de,resident_cpm1_addr
26a6 26a6 d 019701
26a6 26a6 s 	ld 	bc,resident_cpm1_len
26a9 26a9 s 
26a9 26a9 d c3bb26
26a9 26a9 s 	jp 	.subBiosldir
26ac 26ac s 
26ac 26ac s .cpmsubBios2:
26ac 26ac d 2106ea
26ac 26ac s 	ld 	hl,_CPM2_res_DRIVE_TAB
26af 26af d 22362a
26af 26af s 	ld 	(drivetab_mount_info),hl
26b2 26b2 s 
26b2 26b2 d 21752c
26b2 26b2 s 	ld 	hl,resident_cpm2
26b5 26b5 d 1106ea
26b5 26b5 s 	ld 	de,resident_cpm2_addr
26b8 26b8 d 019701
26b8 26b8 s 	ld 	bc,resident_cpm2_len
26bb 26bb s 
26bb 26bb s .subBiosldir:
26bb 26bb d cdcb28
26bb 26bb s 	call	_p_ldir
26be 26be s 
26be 26be s .cpmNoResident:
26be 26be d 3e01
26be 26be s 	ld 	a,1
26c0 26c0 d 2a6d26
26c0 26c0 s 	ld 	hl,(work_ptr)
26c3 26c3 d cd2927
26c3 26c3 s 	call 	do_patch
26c6 26c6 s 
26c6 26c6 s ; 	halt
26c6 26c6 s 
26c6 26c6 d 222727
26c6 26c6 s 	ld 	(hl_after_do_patch_patch),hl
26c9 26c9 s 
26c9 26c9 s 	;если дисководов нет то диски C и D - эмулируемые
26c9 26c9 d 3ae823
26c9 26c9 s 	ld 	a,(HW_FDC_PRESENT)
26cc 26cc d b7
26cc 26cc s 	or 	a
26cd 26cd d c22227
26cd 26cd s 	jp 	nz,patch_done
26d0 26d0 s 
26d0 26d0 s 
26d0 26d0 d 3aba25
26d0 26d0 s 	ld 	a,(flag_subbios)
26d3 26d3 d 21ace8
26d3 26d3 s 	ld 	hl,_CPM1_res_DRIVE_TAB
26d6 26d6 d fe01
26d6 26d6 s 	cp 	1
26d8 26d8 d cae626
26d8 26d8 s 	jp 	z,.cpmRemapCD
26db 26db s 
26db 26db d 2106ea
26db 26db s 	ld 	hl,_CPM2_res_DRIVE_TAB
26de 26de d fe02
26de 26de s 	cp 	2
26e0 26e0 d cae626
26e0 26e0 s 	jp 	z,.cpmRemapCD
26e3 26e3 s 
26e3 26e3 d c32227
26e3 26e3 s 	jp 	patch_done 	;no need to patch
26e6 26e6 s 
26e6 26e6 s 
26e6 26e6 s .cpmRemapCD:
26e6 26e6 s 
26e6 26e6 s 
26e6 26e6 d d5
26e6 26e6 s 	push 	de
26e7 26e7 d 110400
26e7 26e7 s 	ld	de,2*2
26ea 26ea d 19
26ea 26ea s 	add 	hl,de
26eb 26eb d 3e00
26eb 26eb s 	ld 	a,0 ;0=use emu
26ed 26ed s 
26ed 26ed d 5e
26ed 26ed s 	ld 	e,(hl)
26ee 26ee d 23
26ee 26ee s 	inc 	hl
26ef 26ef d 56
26ef 26ef s 	ld 	d,(hl)
26f0 26f0 d 23
26f0 26f0 s 	inc 	hl
26f1 26f1 d 12
26f1 26f1 s 	ld 	(de),a 	;drive C - emu
26f2 26f2 s 
26f2 26f2 s 
26f2 26f2 d 5e
26f2 26f2 s 	ld 	e,(hl)
26f3 26f3 d 23
26f3 26f3 s 	inc 	hl
26f4 26f4 d 56
26f4 26f4 s 	ld 	d,(hl)
26f5 26f5 d 23
26f5 26f5 s 	inc 	hl
26f6 26f6 d 12
26f6 26f6 s 	ld 	(de),a	;drive D - emu
26f7 26f7 s 
26f7 26f7 d d1
26f7 26f7 s 	pop 	de
26f8 26f8 s 
26f8 26f8 d c32227
26f8 26f8 s 	jp 	patch_done
26fb 26fb s 
26fb 26fb s move_microdos_resident:
26fb 26fb s 
26fb 26fb s 
26fb 26fb d 2102fa
26fb 26fb s 	ld 	hl,md_res_DRIVE_TAB
26fe 26fe d 22362a
26fe 26fe s 	ld 	(drivetab_mount_info),hl
2701 2701 s 
2701 2701 s 	;microdos
2701 2701 d 3e5c
2701 2701 s 	ld 	a,0x5c
2703 2703 d 327ffa
2703 2703 s 	ld 	(SYSREG14),a
2706 2706 s 
2706 2706 d 210c2e
2706 2706 s 	ld 	hl,resident_md
2709 2709 d 1100fa
2709 2709 s 	ld 	de,resident_md_addr
270c 270c d 011001
270c 270c s 	ld 	bc,resident_md_len
270f 270f d cdcb28
270f 270f s 	call	_p_ldir
2712 2712 s 
2712 2712 d 3e01
2712 2712 s 	ld 	a,1
2714 2714 d 2a6d26
2714 2714 s 	ld 	hl,(work_ptr)
2717 2717 d cd2927
2717 2717 s 	call 	do_patch
271a 271a d 222727
271a 271a s 	ld 	(hl_after_do_patch_patch),hl
271d 271d s 
271d 271d d 3e14
271d 271d s 	ld 	a,0x14
271f 271f d 327fff
271f 271f s 	ld 	(SYSREG5C),a
2722 2722 s 
2722 2722 s 
2722 2722 s ; 	HALT
2722 2722 s patch_done:
2722 2722 d 2a2727
2722 2722 s 	ld 	hl,(hl_after_do_patch_patch)
2725 2725 s 
2725 2725 d af
2725 2725 s 	xor 	a
2726 2726 d c9
2726 2726 s 	ret
2727 2727 s hl_after_do_patch_patch:
2727 2727 d 0000
2727 2727 s 	dw 	0
2729 2729 s do_patch:
2729 2729 d 326f26
2729 2729 s 	ld 	(patch_flag),a
272c 272c s 
272c 272c s 	if DEBUG_TRACE_PATCHER
272c 272c s 		;debug
272c 272c s ; 		or 	a
272c 272c s ; 		jp 	nz,.noTrace1
272c 272c s 
272c 272c s 		push 	hl
272c 272c s 
272c 272c s 
272c 272c s 		LD	HL,HCRLF
272c 272c s 		CALL	PSTR
272c 272c s 		pop	hl
272c 272c s 
272c 272c s 		push 	hl
272c 272c s 		CALL	HEX4
272c 272c s 		ld 	a,':'
272c 272c s 		call 	PUTCH
272c 272c s 		;DEBUG
272c 272c s 
272c 272c s 		ld 	a,'>'
272c 272c s 		call 	PUTCH
272c 272c s 		ld 	a,(patch_flag)
272c 272c s 		call 	HEX2
272c 272c s 		ld 	a,':'
272c 272c s 		call 	PUTCH
272c 272c s 
272c 272c s 		pop 	hl
272c 272c s .noTrace1:
272c 272c s 		; 	debug
272c 272c s 	endif
272c 272c s 
272c 272c d 3e00
272c 272c s 	ld 	a,0
272e 272e d 32b925
272e 272e s 	ld 	(flag_microdos),a
2731 2731 d 32ba25
2731 2731 s 	ld 	(flag_subbios),a
2734 2734 s 
2734 2734 s patch_loop:
2734 2734 s 
2734 2734 d 7e
2734 2734 s 	ld 	a,(hl)
2735 2735 d 23
2735 2735 s 	inc 	hl
2736 2736 s 	if DEBUG_TRACE_PATCHER
2736 2736 s 
2736 2736 s ; 		;debug
2736 2736 s ; 		push 	af
2736 2736 s ; 		ld 	a,(patch_flag)
2736 2736 s ; 		or 	a
2736 2736 s ; 		jp 	nz,.noTrace2
2736 2736 s ; 		pop 	af
2736 2736 s 		push 	af
2736 2736 s 		call 	HEX2
2736 2736 s 	.noTrace2:
2736 2736 s 		pop 	af
2736 2736 s 		;debug
2736 2736 s 	endif
2736 2736 s 
2736 2736 d fe50
2736 2736 s 	cp 	p_STOP
2738 2738 d c8
2738 2738 s 	ret 	z 	;FOUND
2739 2739 s 
2739 2739 s B_CHK_PATCH:
2739 2739 d fe52
2739 2739 s 	cp 	pB_CHK_PATCH
273b 273b d c25c27
273b 273b s 	jp 	nz,B_CHK_MAYBE
273e 273e s 
273e 273e d cdc628
273e 273e s 	call 	fetch_dw_to_bc 	;BC addr
2741 2741 d c5
2741 2741 s 	push 	bc
2742 2742 d cdc828
2742 2742 s 	call 	fetch_db_to_b 	;b
2745 2745 s 
2745 2745 d eb
2745 2745 s 	ex 	de,hl
2746 2746 d e1
2746 2746 s 	pop 	hl
2747 2747 d 7e
2747 2747 s 	ld 	a,(hl)
2748 2748 d eb
2748 2748 s 	ex 	de,hl 		;de - addr
2749 2749 s 
2749 2749 d 48
2749 2749 s 	ld 	c,b
274a 274a s 
274a 274a d cdc828
274a 274a s 	call 	fetch_db_to_b 	;b store
274d 274d s 
274d 274d d b9
274d 274d s 	cp 	c
274e 274e d c0
274e 274e s 	ret 	nz
274f 274f s 
274f 274f s 
274f 274f d 3a6f26
274f 274f s 	ld 	a,(patch_flag)
2752 2752 d b7
2752 2752 s 	or 	a
2753 2753 d ca3427
2753 2753 s 	jp 	z,patch_loop
2756 2756 s 
2756 2756 d eb
2756 2756 s 	ex 	de,hl
2757 2757 d 70
2757 2757 s 	ld 	(hl),b
2758 2758 d eb
2758 2758 s 	ex 	de,hl
2759 2759 d c33427
2759 2759 s 	jp 	patch_loop
275c 275c s 
275c 275c s 
275c 275c s B_CHK_MAYBE:
275c 275c d fe59
275c 275c s 	cp 	pB_MAYBE_PATCH
275e 275e d c27a27
275e 275e s 	jp 	nz,l_pW_CHK
2761 2761 s 
2761 2761 d cdc628
2761 2761 s 	call 	fetch_dw_to_bc 	;BC addr
2764 2764 d c5
2764 2764 s 	push 	bc
2765 2765 d cdc828
2765 2765 s 	call 	fetch_db_to_b 	;b
2768 2768 s 
2768 2768 d eb
2768 2768 s 	ex 	de,hl
2769 2769 d e1
2769 2769 s 	pop 	hl
276a 276a d 7e
276a 276a s 	ld 	a,(hl)
276b 276b d eb
276b 276b s 	ex 	de,hl 		;de - addr
276c 276c s 
276c 276c d 48
276c 276c s 	ld 	c,b
276d 276d s 
276d 276d d cdc828
276d 276d s 	call 	fetch_db_to_b 	;b store
2770 2770 s 
2770 2770 d b9
2770 2770 s 	cp 	c
2771 2771 d c23427
2771 2771 s 	jp  	nz,patch_loop
2774 2774 s 
2774 2774 d eb
2774 2774 s 	ex 	de,hl
2775 2775 d 70
2775 2775 s 	ld 	(hl),b
2776 2776 d eb
2776 2776 s 	ex 	de,hl
2777 2777 d c33427
2777 2777 s 	jp 	patch_loop
277a 277a s 
277a 277a s 
277a 277a s l_pW_CHK:
277a 277a d fe51
277a 277a s 	cp 	pW_CHK_PATCH
277c 277c d c29f27
277c 277c s 	jp 	nz,l_pW_STORE
277f 277f s 
277f 277f d cdc628
277f 277f s 	call 	fetch_dw_to_bc 	
2782 2782 d cdab28
2782 2782 s 	call 	store_bc_to_tmp
2785 2785 s 
2785 2785 d cdc628
2785 2785 s 	call 	fetch_dw_to_bc 	;BC OLD value
2788 2788 s 
2788 2788 d cdbd28
2788 2788 s 	call 	read_de_at_tmp 	;de - value
278b 278b d cda328
278b 278b s 	call 	cp_de_bc
278e 278e s 
278e 278e d cdc628
278e 278e s 	call 	fetch_dw_to_bc 	;bc NEW value
2791 2791 s 
2791 2791 d c0
2791 2791 s 	ret 	nz
2792 2792 s 
2792 2792 d 3a6f26
2792 2792 s 	ld 	a,(patch_flag)
2795 2795 d b7
2795 2795 s 	or 	a
2796 2796 d ca3427
2796 2796 s 	jp 	z,patch_loop
2799 2799 s 
2799 2799 d cdb428
2799 2799 s 	call 	store_bc_at_tmp
279c 279c s 
279c 279c d c33427
279c 279c s 	jp 	patch_loop
279f 279f s 
279f 279f s l_pW_STORE:
279f 279f d fe54
279f 279f s 	cp 	pW_STORE
27a1 27a1 d c2bc27
27a1 27a1 s 	jp 	nz,.pNotSupported
27a4 27a4 s 
27a4 27a4 s 
27a4 27a4 d cdc628
27a4 27a4 s 	call 	fetch_dw_to_bc 	;BC value
27a7 27a7 d c5
27a7 27a7 s 	push 	bc
27a8 27a8 s 
27a8 27a8 d cdc628
27a8 27a8 s 	call 	fetch_dw_to_bc 	
27ab 27ab d cdab28
27ab 27ab s 	call 	store_bc_to_tmp
27ae 27ae s 
27ae 27ae d c1
27ae 27ae s 	pop 	bc
27af 27af s 
27af 27af d 3a6f26
27af 27af s 	ld 	a,(patch_flag)
27b2 27b2 d b7
27b2 27b2 s 	or 	a
27b3 27b3 d ca3427
27b3 27b3 s 	jp 	z,patch_loop
27b6 27b6 s 
27b6 27b6 d cdb428
27b6 27b6 s 	call 	store_bc_at_tmp
27b9 27b9 s 
27b9 27b9 d c33427
27b9 27b9 s 	jp 	patch_loop
27bc 27bc s 
27bc 27bc s .pNotSupported:
27bc 27bc d fe55
27bc 27bc s 	cp 	pNotSupported
27be 27be d c2cb27
27be 27be s 	jp 	nz,.pSETFLAG_MICRODOS
27c1 27c1 s 
27c1 27c1 s 
27c1 27c1 d 3a6f26
27c1 27c1 s 	ld 	a,(patch_flag)
27c4 27c4 d b7
27c4 27c4 s 	or 	a
27c5 27c5 d ca3427
27c5 27c5 s 	jp 	z,patch_loop
27c8 27c8 s 
27c8 27c8 d c31f28
27c8 27c8 s 	jp 	Unsupported	
27cb 27cb s 
27cb 27cb s .pSETFLAG_MICRODOS:
27cb 27cb d fe56
27cb 27cb s 	cp 	pSETFLAG_MICRODOS
27cd 27cd d c2d827
27cd 27cd s 	jp 	nz,.pSubBios
27d0 27d0 s 
27d0 27d0 s ; 	ld 	a,(patch_flag)
27d0 27d0 s ; 	or 	a
27d0 27d0 s ; 	jp 	z,patch_loop
27d0 27d0 s 
27d0 27d0 d 3e01
27d0 27d0 s 	ld 	a,1
27d2 27d2 d 32b925
27d2 27d2 s 	ld 	(flag_microdos),a
27d5 27d5 d c33427
27d5 27d5 s 	jp 	patch_loop
27d8 27d8 s 
27d8 27d8 s .pSubBios:
27d8 27d8 d fe5a
27d8 27d8 s 	cp 	pSubBios
27da 27da d c2e527
27da 27da s 	jp 	nz,.pREQUIRED_OPTS1
27dd 27dd s 
27dd 27dd d 7e
27dd 27dd s 	ld 	a,(hl)
27de 27de d 23
27de 27de s 	inc 	hl
27df 27df d 32ba25
27df 27df s 	ld 	(flag_subbios),a
27e2 27e2 d c33427
27e2 27e2 s 	jp 	patch_loop
27e5 27e5 s 
27e5 27e5 s .pREQUIRED_OPTS1:
27e5 27e5 d fe57
27e5 27e5 s 	cp 	pREQUIRED_OPTS1
27e7 27e7 d c2fe27
27e7 27e7 s 	jp 	nz,.pREQUIRED_OPTS2
27ea 27ea s 
27ea 27ea d 3a6f26
27ea 27ea s 	ld 	a,(patch_flag)
27ed 27ed d b7
27ed 27ed s 	or 	a
27ee 27ee d ca3427
27ee 27ee s 	jp 	z,patch_loop
27f1 27f1 s 
27f1 27f1 s ; 	ld 	a,(rom_version)
27f1 27f1 d 3ae523
27f1 27f1 s 	ld 	a,(HW_ROM_OPTS_CLASS)
27f4 27f4 d fe01
27f4 27f4 s 	cp 	_HW_ROM_OPTS1
27f6 27f6 d ca3427
27f6 27f6 s 	jp 	z,patch_loop
27f9 27f9 s 
27f9 27f9 d 3e31
27f9 27f9 s 	ld 	a,'1'
27fb 27fb d c31428
27fb 27fb s 	jp 	set_opts_warning
27fe 27fe s 
27fe 27fe s ; 	jp 	patch_loop
27fe 27fe s 
27fe 27fe s .pREQUIRED_OPTS2:
27fe 27fe d fe58
27fe 27fe s 	cp 	pREQUIRED_OPTS2
2800 2800 d c22728
2800 2800 s 	jp 	nz,.pHALT
2803 2803 s 
2803 2803 d 3a6f26
2803 2803 s 	ld 	a,(patch_flag)
2806 2806 d b7
2806 2806 s 	or 	a
2807 2807 d ca3427
2807 2807 s 	jp 	z,patch_loop
280a 280a s 
280a 280a s ; 	ld 	a,(rom_version)
280a 280a d 3ae523
280a 280a s 	ld 	a,(HW_ROM_OPTS_CLASS)
280d 280d d fe02
280d 280d s 	cp 	_HW_ROM_OPTS2
280f 280f d ca3427
280f 280f s 	jp 	z,patch_loop
2812 2812 s 
2812 2812 d 3e32
2812 2812 s 	ld 	a,'2'
2814 2814 s 
2814 2814 s set_opts_warning:
2814 2814 d 324026
2814 2814 s 	ld 	(msgREQ_OPTS_digit),a
2817 2817 s 
2817 2817 d e5
2817 2817 s 	push 	hl
2818 2818 d 212826
2818 2818 s 	ld 	hl,msgREQ_OPTS
281b 281b d 22bb25
281b 281b s 	ld 	(msg_warning),hl
281e 281e d e1
281e 281e s 	pop 	hl
281f 281f s 
281f 281f s Unsupported:
281f 281f d 3e01
281f 281f s 	ld 	a,1
2821 2821 d 32b825
2821 2821 s 	ld 	(flag_unsupported),a
2824 2824 d c33427
2824 2824 s 	jp 	patch_loop
2827 2827 s 
2827 2827 s .pHALT:
2827 2827 d 212f28
2827 2827 s 	ld 	hl,msg_InvalidPatchCode
282a 282a d cdc222
282a 282a s 	call 	PSTR
282d 282d s 
282d 282d d 76
282d 282d s 	halt
282e 282e s 
282e 282e d c9
282e 282e s 	ret
282f 282f s 
282f 282f s msg_InvalidPatchCode:
282f 282f d 496e76616c6964207061746368636f64652c20636865636b207265676973746572730d0a00
282f 282f s 	db 	'Invalid patchcode, check registers',0dh,0ah,0
2854 2854 s msgUndefindedSubBios:
2854 2854 d 43502f4d2073756262696f73206e6f7420646566696e65642c2068616c7465640d0a00
2854 2854 s 	db 	'CP/M subbios not defined, halted',0dh,0ah,0
2877 2877 s msg_StrangeHLAfterPatch:
2877 2877 d 496e76616c696420484c2061667465722070617463682c206e6f20705f53544f50206265666f7265210d0a00
2877 2877 s 	db 	'Invalid HL after patch, no p_STOP before!',0dh,0ah,0
28a3 28a3 s cp_de_bc:
28a3 28a3 d 7b
28a3 28a3 s 	ld 	a,e
28a4 28a4 d b9
28a4 28a4 s 	cp 	c
28a5 28a5 d c0
28a5 28a5 s 	ret 	nz
28a6 28a6 d 7a
28a6 28a6 s 	ld 	a,d
28a7 28a7 d b8
28a7 28a7 s 	cp 	b
28a8 28a8 d c9
28a8 28a8 s 	ret
28a9 28a9 s 
28a9 28a9 d 0000
28a9 28a9 s tmp: 	dw 	0
28ab 28ab s 
28ab 28ab s ;stor bc to tmp
28ab 28ab s store_bc_to_tmp:
28ab 28ab d 79
28ab 28ab s 	ld 	a,c
28ac 28ac d 32a928
28ac 28ac s 	ld 	(tmp),a
28af 28af s 
28af 28af d 78
28af 28af s 	ld 	a,b
28b0 28b0 d 32aa28
28b0 28b0 s 	ld 	(tmp+1),a
28b3 28b3 d c9
28b3 28b3 s 	ret
28b4 28b4 s 
28b4 28b4 s store_bc_at_tmp:
28b4 28b4 d e5
28b4 28b4 s 	push 	hl
28b5 28b5 d 2aa928
28b5 28b5 s 	ld 	hl,(tmp)
28b8 28b8 d 71
28b8 28b8 s 	ld 	(hl),c
28b9 28b9 d 23
28b9 28b9 s 	inc 	hl
28ba 28ba d 70
28ba 28ba s 	ld 	(hl),b
28bb 28bb d e1
28bb 28bb s 	pop 	hl
28bc 28bc d c9
28bc 28bc s 	ret
28bd 28bd s 
28bd 28bd s ;de - value at (tmp)
28bd 28bd s read_de_at_tmp:
28bd 28bd d e5
28bd 28bd s 	push 	hl
28be 28be d 2aa928
28be 28be s 	ld 	hl,(tmp)
28c1 28c1 s 
28c1 28c1 d 5e
28c1 28c1 s 	ld 	e,(hl)
28c2 28c2 d 23
28c2 28c2 s 	inc 	hl
28c3 28c3 d 56
28c3 28c3 s 	ld 	d,(hl)
28c4 28c4 s 
28c4 28c4 d e1
28c4 28c4 s 	pop 	hl
28c5 28c5 d c9
28c5 28c5 s 	ret
28c6 28c6 s 
28c6 28c6 s 
28c6 28c6 s fetch_dw_to_bc:
28c6 28c6 d 4e
28c6 28c6 s 	ld 	c,(hl)
28c7 28c7 d 23
28c7 28c7 s 	inc 	hl
28c8 28c8 s fetch_db_to_b:
28c8 28c8 d 46
28c8 28c8 s 	ld 	b,(hl)
28c9 28c9 d 23
28c9 28c9 s 	inc 	hl
28ca 28ca d c9
28ca 28ca s 	ret
28cb 28cb s 
28cb 28cb s _p_ldir:
28cb 28cb d 7e
28cb 28cb s 	ld 	a,(hl)
28cc 28cc d 12
28cc 28cc s 	ld 	(de),a
28cd 28cd d 23
28cd 28cd s 	inc 	hl
28ce 28ce d 13
28ce 28ce s 	inc 	de
28cf 28cf d 0b
28cf 28cf s 	dec 	bc
28d0 28d0 d 79
28d0 28d0 s 	ld 	a,c
28d1 28d1 d b0
28d1 28d1 s 	or 	b
28d2 28d2 d c2cb28
28d2 28d2 s 	jp 	nz,_p_ldir
28d5 28d5 d c9
28d5 28d5 s 	ret
28d6 28d6 s 
28d6 28d6 s 	include 	"mount_info.asm"
28d6 28d6 f mount_info.asm
28d6 28d6 s API_GET_MOUNT_NAME	EQU	0x80
28d6 28d6 s API_GET_MOUNT_STATUS 	EQU	0x82
28d6 28d6 s 
28d6 28d6 s ; x123:
28d6 28d6 s ; 	db 0dh,0ah
28d6 28d6 s ; 	db '0         1         2         3         4         5         6   '
28d6 28d6 s ; 	db '0123456789012345678901234567890123456789012345678901234567890123'
28d6 28d6 s ; 	db 0
28d6 28d6 s show_mount_info:
28d6 28d6 s 
28d6 28d6 d 21382a
28d6 28d6 s 	ld 	hl,msg_default_mount
28d9 28d9 d cdc222
28d9 28d9 s 	call 	PSTR
28dc 28dc s 	
28dc 28dc d 3e00
28dc 28dc s 	ld 	a,0
28de 28de d cdfc28
28de 28de s 	call 	show_mount_drive
28e1 28e1 s 
28e1 28e1 d 3e01
28e1 28e1 s 	ld 	a,1
28e3 28e3 d cdfc28
28e3 28e3 s 	call 	show_mount_drive
28e6 28e6 s 
28e6 28e6 d 3e02
28e6 28e6 s 	ld 	a,2
28e8 28e8 d cdfc28
28e8 28e8 s 	call 	show_mount_drive
28eb 28eb s 
28eb 28eb d 3e03
28eb 28eb s 	ld 	a,3
28ed 28ed d cdfc28
28ed 28ed s 	call 	show_mount_drive
28f0 28f0 s 
28f0 28f0 s ; 	ld 	hl,mount_crlf
28f0 28f0 s ; 	call 	PSTR
28f0 28f0 s 
28f0 28f0 s 	;show info about drive F 	
28f0 28f0 d 3ab925
28f0 28f0 s 	ld 	a,(flag_microdos)
28f3 28f3 d b7
28f3 28f3 s 	or 	a
28f4 28f4 d c0
28f4 28f4 s 	ret 	nz	
28f5 28f5 s 
28f5 28f5 d 219f2a
28f5 28f5 s 	ld 	hl,msgDRIVE_F
28f8 28f8 d cdc222
28f8 28f8 s 	call 	PSTR
28fb 28fb s 
28fb 28fb d c9
28fb 28fb s 	ret
28fc 28fc s 
28fc 28fc s show_mount_drive:
28fc 28fc d 32e422
28fc 28fc s 	ld 	(DRV),a
28ff 28ff s 
28ff 28ff d 3e00
28ff 28ff s 	ld 	a,0
2901 2901 d 327e2a
2901 2901 s 	ld 	(drive_rw_status),a
2904 2904 s 
2904 2904 d cd8829
2904 2904 s 	call 	get_drvinfo_ptr
2907 2907 d ca5e29
2907 2907 s 	jp 	z,skip_disk 	;de=0, no drive at all
290a 290a s 
290a 290a d 1a
290a 290a s 	ld 	a,(de)
290b 290b d b7
290b 290b s 	or 	a
290c 290c d c21b29
290c 290c s 	jp 	nz,.physical_drive
290f 290f s 
290f 290f d cd1f2a
290f 290f s 	call 	get_mount_info
2912 2912 d cd5f29
2912 2912 s 	call 	build_disk_name
2915 2915 d cdbd29
2915 2915 s 	call 	build_emu_name
2918 2918 s 
2918 2918 d c35329
2918 2918 s 	jp 	show_disk_info
291b 291b s 
291b 291b s .physical_drive:
291b 291b s 
291b 291b d f5
291b 291b s 	push 	af
291c 291c d cd5f29
291c 291c s 	call 	build_disk_name
291f 291f d f1
291f 291f s 	pop 	af
2920 2920 s 
2920 2920 d 0e41
2920 2920 s 	ld 	c,'A'
2922 2922 d fe01
2922 2922 s 	cp 	0001b
2924 2924 d ca4229
2924 2924 s 	jp 	z,fdd_found
2927 2927 d 0e42
2927 2927 s 	ld 	c,'B'
2929 2929 d fe02
2929 2929 s 	cp 	0010b
292b 292b d ca4229
292b 292b s 	jp 	z,fdd_found
292e 292e d 0e43
292e 292e s 	ld 	c,'C'
2930 2930 d fe04
2930 2930 s 	cp 	0100b
2932 2932 d ca4229
2932 2932 s 	jp 	z,fdd_found
2935 2935 d 0e44
2935 2935 s 	ld 	c,'D'
2937 2937 d fe08
2937 2937 s 	cp 	1000b
2939 2939 d ca4229
2939 2939 s 	jp 	z,fdd_found
293c 293c s 
293c 293c d 21742a
293c 293c s 	ld 	hl,msg_fdd_err
293f 293f d c34929
293f 293f s 	jp 	.cpfddname
2942 2942 s 
2942 2942 s fdd_found:
2942 2942 d 79
2942 2942 s 	ld 	a,c
2943 2943 d 32722a
2943 2943 s 	ld 	(msg_fdd_drv),a
2946 2946 s 
2946 2946 d 216b2a
2946 2946 s 	ld 	hl,msg_fdd
2949 2949 s 
2949 2949 s .cpfddname
2949 2949 s 
2949 2949 d 114a2a
2949 2949 s 	ld 	de,out_buffer
294c 294c d 0e20
294c 294c s 	ld 	c,32
294e 294e d 060e
294e 294e s 	ld 	b,14
2950 2950 d cde029
2950 2950 s 	call 	append_z
2953 2953 s 
2953 2953 s show_disk_info:
2953 2953 s 
2953 2953 d 214a2a
2953 2953 s 	ld 	hl,out_buffer
2956 2956 d 0e21
2956 2956 s 	ld 	c,32+1
2958 2958 d cd042a
2958 2958 s 	call 	fix_width
295b 295b d cdc222
295b 295b s 	call 	PSTR
295e 295e s 
295e 295e s ; 	ld 	hl,mount_crlf
295e 295e s ; 	call 	PSTR
295e 295e s 
295e 295e s skip_disk:
295e 295e d c9
295e 295e s 	ret
295f 295f s 
295f 295f s build_disk_name:
295f 295f d af
295f 295f s 	xor 	a
2960 2960 d 324a2a
2960 2960 s 	ld 	(out_buffer+00),a
2963 2963 s ; 	ld 	(out_buffer+32),a
2963 2963 s 
2963 2963 d 3ae422
2963 2963 s 	ld 	a,(DRV)
2966 2966 d c641
2966 2966 s 	add 	a,'A'
2968 2968 d 32452a
2968 2968 s 	ld 	(mount_msg_drv),a
296b 296b s 
296b 296b d 015257
296b 296b s 	ld 	bc,'RW'
296e 296e d 3a7e2a
296e 296e s 	ld 	a,(drive_rw_status)
2971 2971 d b7
2971 2971 s 	or 	a
2972 2972 d 79
2972 2972 s 	ld 	a,c
2973 2973 d c27729
2973 2973 s 	jp 	nz,.rw
2976 2976 d 78
2976 2976 s 	ld 	a,b
2977 2977 s .rw:
2977 2977 d 32472a
2977 2977 s 	ld 	(mount_msg_rw),a
297a 297a s 
297a 297a s ;--
297a 297a d 114a2a
297a 297a s 	ld 	de,out_buffer
297d 297d d 21452a
297d 297d s 	ld 	hl,mount_msg
2980 2980 d 0e20
2980 2980 s 	ld 	c,32
2982 2982 d 060e
2982 2982 s 	ld 	b,14
2984 2984 d cde029
2984 2984 s 	call 	append_z
2987 2987 s 
2987 2987 d c9
2987 2987 s 	ret
2988 2988 s 
2988 2988 s ;in (DRV)
2988 2988 s ;de - addr
2988 2988 s ;z=0 if de=0
2988 2988 s get_drvinfo_ptr:
2988 2988 d e5
2988 2988 s 	push 	hl
2989 2989 d 3ae422
2989 2989 s 	ld 	a,(DRV)
298c 298c d 87
298c 298c s 	add 	a,a
298d 298d d 5f
298d 298d s 	ld 	e,a
298e 298e d 1600
298e 298e s 	ld 	d,0
2990 2990 d 2a362a
2990 2990 s 	ld 	hl,(drivetab_mount_info)
2993 2993 s 	
2993 2993 d 7c
2993 2993 s 	ld 	a,h
2994 2994 d b5
2994 2994 s 	or 	l
2995 2995 d caa029
2995 2995 s 	jp 	z,errZeroDrvInfoTab
2998 2998 d 19
2998 2998 s 	add 	hl,de
2999 2999 d 5e
2999 2999 s 	ld 	e,(hl)
299a 299a d 23
299a 299a s 	inc 	hl
299b 299b d 56
299b 299b s 	ld 	d,(hl)
299c 299c d 7b
299c 299c s 	ld 	a,e
299d 299d d b2
299d 299d s 	or 	d
299e 299e d e1
299e 299e s 	pop 	hl
299f 299f d c9
299f 299f s 	ret
29a0 29a0 s errZeroDrvInfoTab:
29a0 29a0 d 21a729
29a0 29a0 s 	ld 	hl,msgZeroDrvInfoTab
29a3 29a3 d cdc222
29a3 29a3 s 	call 	PSTR
29a6 29a6 d 76
29a6 29a6 s 	halt
29a7 29a7 s msgZeroDrvInfoTab:
29a7 29a7 d 53686f77496e666f3a204472765461623d3030303000
29a7 29a7 s 	db 	'ShowInfo: DrvTab=0000',0
29bd 29bd s 
29bd 29bd s build_emu_name:
29bd 29bd s 
29bd 29bd d 114a2a
29bd 29bd s 	ld 	de,out_buffer
29c0 29c0 d 0e20
29c0 29c0 s 	ld 	c,32
29c2 29c2 d 060e
29c2 29c2 s 	ld 	b,14
29c4 29c4 s 
29c4 29c4 d 217f2a
29c4 29c4 s 	ld 	hl,mount_info_from_emu+1
29c7 29c7 d cde029
29c7 29c7 s 	call 	append_z
29ca 29ca s 	
29ca 29ca d 3e2f
29ca 29ca s 	ld 	a,'/'
29cc 29cc d 12
29cc 29cc s 	ld 	(de),a
29cd 29cd d 13
29cd 29cd s 	inc 	de
29ce 29ce d af
29ce 29ce s 	xor 	a
29cf 29cf d 12
29cf 29cf s 	ld 	(de),a
29d0 29d0 s 
29d0 29d0 s 
29d0 29d0 d 114a2a
29d0 29d0 s 	ld 	de,out_buffer
29d3 29d3 d 218d2a
29d3 29d3 s 	ld 	hl,mount_info_from_emu+1+14
29d6 29d6 d 0e20
29d6 29d6 s 	ld 	c,32
29d8 29d8 d 060e
29d8 29d8 s 	ld 	b,14
29da 29da d cde029
29da 29da s 	call 	append_z
29dd 29dd s 
29dd 29dd d af
29dd 29dd s 	xor 	a
29de 29de d 12
29de 29de s 	ld 	(de),a
29df 29df s 
29df 29df d c9
29df 29df s 	ret
29e0 29e0 s 
29e0 29e0 s 
29e0 29e0 s 
29e0 29e0 s 
29e0 29e0 s ;append (skip all not 0 and then copy_z)
29e0 29e0 s append_z:
29e0 29e0 d 79
29e0 29e0 s 	ld 	a,c
29e1 29e1 d b7
29e1 29e1 s 	or 	a
29e2 29e2 d c8
29e2 29e2 s 	ret 	z
29e3 29e3 s 
29e3 29e3 d 7e
29e3 29e3 s 	ld 	a,(hl)
29e4 29e4 d b7
29e4 29e4 s 	or 	a
29e5 29e5 d c8
29e5 29e5 s 	ret 	z
29e6 29e6 s 
29e6 29e6 s .skipAppend:
29e6 29e6 d 1a
29e6 29e6 s 	ld 	a,(de)
29e7 29e7 d b7
29e7 29e7 s 	or 	a
29e8 29e8 d caf329
29e8 29e8 s 	jp 	z,copy_z
29eb 29eb d 13
29eb 29eb s 	inc 	de
29ec 29ec d 0d
29ec 29ec s 	dec 	c
29ed 29ed d caf329
29ed 29ed s 	jp 	z,copy_z	
29f0 29f0 s 
29f0 29f0 d c3e629
29f0 29f0 s 	jp 	.skipAppend
29f3 29f3 s 
29f3 29f3 s ;copy upto C char (or till 0) from HL to DE
29f3 29f3 s ;c - dstbuf sizw
29f3 29f3 s ;b - from buf size
29f3 29f3 s ;hl pointed to NULL terminated string
29f3 29f3 s 
29f3 29f3 s copy_z:
29f3 29f3 d 79
29f3 29f3 s 	ld 	a,c	;to str size left =0
29f4 29f4 d b7
29f4 29f4 s 	or 	a
29f5 29f5 d c8
29f5 29f5 s 	ret 	z
29f6 29f6 s 
29f6 29f6 d 78
29f6 29f6 s 	ld 	a,b 	;from str size left =0
29f7 29f7 d b7
29f7 29f7 s 	or 	a
29f8 29f8 d c8
29f8 29f8 s 	ret 	z
29f9 29f9 s 
29f9 29f9 d 7e
29f9 29f9 s 	ld 	a,(hl)
29fa 29fa d 12
29fa 29fa s 	ld 	(de),a
29fb 29fb d b7
29fb 29fb s 	or 	a
29fc 29fc d c8
29fc 29fc s 	ret 	z
29fd 29fd s ; 	jp 	nz,.copy_z_store
29fd 29fd s ; 	ld 	a,'_'
29fd 29fd s ; .copy_z_store:
29fd 29fd d 23
29fd 29fd s 	inc 	hl
29fe 29fe d 13
29fe 29fe s 	inc 	de
29ff 29ff d 0d
29ff 29ff s 	dec 	c
2a00 2a00 d 05
2a00 2a00 s 	dec 	b
2a01 2a01 d c3f329
2a01 2a01 s 	jp 	copy_z
2a04 2a04 s 
2a04 2a04 s ;hl ptr
2a04 2a04 s ;c  len
2a04 2a04 s ;дополняет хвост строки пробелами делая её длинной len
2a04 2a04 s fix_width:
2a04 2a04 d 79
2a04 2a04 s 	ld 	a,c
2a05 2a05 d b7
2a05 2a05 s 	or 	a
2a06 2a06 d c8
2a06 2a06 s 	ret 	z
2a07 2a07 s 
2a07 2a07 d e5
2a07 2a07 s 	push 	hl
2a08 2a08 s 
2a08 2a08 d 2b
2a08 2a08 s 	dec 	hl
2a09 2a09 s .skipLP:	
2a09 2a09 d 0d
2a09 2a09 s 	dec 	c
2a0a 2a0a d ca1d2a
2a0a 2a0a s 	jp 	z,.endfill
2a0d 2a0d d 23
2a0d 2a0d s 	inc 	hl
2a0e 2a0e d 7e
2a0e 2a0e s 	ld 	a,(hl)
2a0f 2a0f d b7
2a0f 2a0f s 	or 	a
2a10 2a10 d c2092a
2a10 2a10 s 	jp 	nz, .skipLP
2a13 2a13 s 
2a13 2a13 d 3e20
2a13 2a13 s 	ld 	a,' '
2a15 2a15 s 
2a15 2a15 s .fillLoop:
2a15 2a15 d 77
2a15 2a15 s 	ld 	(hl),a
2a16 2a16 d 23
2a16 2a16 s 	inc 	hl
2a17 2a17 d 0d
2a17 2a17 s 	dec 	c
2a18 2a18 d c2152a
2a18 2a18 s 	jp 	nz,.fillLoop
2a1b 2a1b s 
2a1b 2a1b d af
2a1b 2a1b s 	xor 	a
2a1c 2a1c d 77
2a1c 2a1c s 	ld 	(hl),a 	;0
2a1d 2a1d s .endfill:
2a1d 2a1d d e1
2a1d 2a1d s 	pop 	hl
2a1e 2a1e d c9
2a1e 2a1e s 	ret
2a1f 2a1f s 
2a1f 2a1f s get_mount_info:
2a1f 2a1f d 3e80
2a1f 2a1f s 	ld 	a,API_GET_MOUNT_NAME
2a21 2a21 d 32e322
2a21 2a21 s 	ld 	(CMD),a
2a24 2a24 d cd8722
2a24 2a24 s 	call 	SENDCMD
2a27 2a27 s 
2a27 2a27 d 0e1d
2a27 2a27 s 	ld 	c,29
2a29 2a29 s 
2a29 2a29 s receive_c_bytes_to_hl:
2a29 2a29 s 
2a29 2a29 d 217e2a
2a29 2a29 s 	ld 	hl,mount_info_from_emu
2a2c 2a2c s get_lp:
2a2c 2a2c d cd2e22
2a2c 2a2c s 	call 	GETBYTE
2a2f 2a2f d 77
2a2f 2a2f s 	ld 	(HL),a
2a30 2a30 d 23
2a30 2a30 s 	inc 	hl
2a31 2a31 d 0d
2a31 2a31 s 	dec 	c
2a32 2a32 d c22c2a
2a32 2a32 s 	jp 	nz,get_lp
2a35 2a35 d c9
2a35 2a35 s 	ret
2a36 2a36 s 
2a36 2a36 s ;GETBYTE:
2a36 2a36 s ; 	PUSH	HL
2a36 2a36 s ; 	LD	HL,PORTC
2a36 2a36 s ; WG:
2a36 2a36 s ; 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2a36 2a36 s ; 	AND	20h		; выделяем сигнал IBF
2a36 2a36 s ; 	JP	Z,WG		; IBF=0 - данных еще нет
2a36 2a36 s ; 	DEC	L
2a36 2a36 s ; 	DEC	L
2a36 2a36 s ; 	LD	A,(HL)		; данные поступили - выбираем их из порта А
2a36 2a36 s ; 	POP	HL
2a36 2a36 s ; 	RET
2a36 2a36 s 
2a36 2a36 s 
2a36 2a36 s drivetab_mount_info:
2a36 2a36 d 0000
2a36 2a36 s 		dw 	0
2a38 2a38 s 
2a38 2a38 s msg_default_mount:
2a38 2a38 d 4472697665206d61703a0d0a
2a38 2a38 s 		db 	'Drive map:',0dh,0ah
2a44 2a44 s ;		db 	'          1         2         3         4         5         6   '
2a44 2a44 s ;		db 	'0123456789012345678901234567890123456789012345678901234567890123'
2a44 2a44 d 00
2a44 2a44 s 		db 	0
2a45 2a45 s mount_msg:	
2a45 2a45 d 413a
2a45 2a45 s mount_msg_drv: 	db 	'A:'
2a47 2a47 d 5720
2a47 2a47 s mount_msg_rw:	db 	'W '
2a49 2a49 d 00
2a49 2a49 s 		db 	0
2a4a 2a4a s out_buffer:
2a4a 2a4a s 		ds 	32
2a6a 2a6a d 00
2a6a 2a6a s 		db 	0
2a6b 2a6b s msg_fdd:
2a6b 2a6b d 24464444202d20
2a6b 2a6b s 		db	'$FDD - '
2a72 2a72 d 4100
2a72 2a72 s msg_fdd_drv:	db 	'A',0
2a74 2a74 s 
2a74 2a74 s msg_fdd_err:
2a74 2a74 d 3f3f4552524f523f3f00
2a74 2a74 s 		db 	'??ERROR??',0
2a7e 2a7e s 
2a7e 2a7e s mount_info_from_emu: 	
2a7e 2a7e s drive_rw_status:
2a7e 2a7e d 00
2a7e 2a7e s 		db 	0 			;=1 if R/O
2a7f 2a7f d 2020202020202020202020202020
2a7f 2a7f s 		db 	'              ' 	;Folder 14 asciiZ 
2a8d 2a8d d 2020202020202020202020202020
2a8d 2a8d s 		db 	'              ' 	;Name   14 asciiZ
2a9b 2a9b d 00
2a9b 2a9b s 		db 	0
2a9c 2a9c s 
2a9c 2a9c d 0d0a00
2a9c 2a9c s mount_crlf: 	db 	0dh,0ah,0	
2a9f 2a9f s 
2a9f 2a9f s msgDRIVE_F:
2a9f 2a9f d 463a202d202f455852544f4f4c532e4b44492077697468204d4f554e5420616e64206f7468657220455854524f4d2072656c61746564207574696c73
2a9f 2a9f s 		db 	'F: - /EXRTOOLS.KDI with MOUNT and other EXTROM related utils'
2adb 2adb d 0d0a00
2adb 2adb s 		db 	0x0d,0x0a,0
2ade 2ade s 
2ade 2ade s ; CMD:	DB	1		; Команда чтения
2ade 2ade s ; DRV:	DB	0
2ade 2ade s ; TRK:	DB	0
2ade 2ade s ; SEC:	DB	0
2ade 2ade s 
2ade 2ade s 
2ade 2ade s ; 80 — получить имя образа
2ade 2ade s 
2ade 2ade s ; Команда предназначена для получения имени KDI-файла, смонтированного в данный момент на логическом устройстве A-D.  
2ade 2ade s ;  Номер устройства задается в поле DRV. Возвращается буфер размером 29 байт, содержащий следующую информацию:
2ade 2ade s 
2ade 2ade s ; 1 байт флага разрешение записи (0 — чтение/запись, 1 — только чтение)
2ade 2ade s ; 14-байтовый буфер с именем каталога, из которого смонтирован файл образа, заканчивающийся 0.
2ade 2ade s ; 14-байтовый буфер с именем файла, заканчивающийся 0.
2ade 2ade s 
2ade 2ade s ; 82 — проверка состояния устройства
2ade 2ade s ; 	Команда возвращает ответ ОК, если устройство смонтировано, или Fail, если не смонтировано. 
2ade 2ade s ; Флаг состояния автоматически опускается в случае ошибок ввода-вывода на данном устройстве. 
2ade 2ade s ; С помощью этой команды можно проверить результат предыдущего вызова mount (81)
2ade 2ade f generator/V0/extrom-patcher.asm
2ade 2ade s 	include 	"extrom-patcher-resident-cpm-body.asm"
2ade 2ade f extrom-patcher-resident-cpm-body.asm
2ade 2ade s rPORTA	EQU	0FB08H		; Порт Канала A интерфейса расширения
2ade 2ade s rPORTC	EQU	0FB0AH		; Порт Канала С интерфейса расширения
2ade 2ade s rPCWR	EQU	0FB0BH		; Порт управляющих команд
2ade 2ade s 
2ade 2ade s _DSK 	EQU 	0xFFFF
2ade 2ade s _OPER 	EQU 	0xFFFF
2ade 2ade s _TRK 	EQU 	0xFFFF
2ade 2ade s _SEC 	EQU 	0xFFFF
2ade 2ade s _DMA 	EQU 	0xFFFF
2ade 2ade s 
2ade 2ade s _RRBUFF	EQU 	0xEE00
2ade 2ade s 
2ade 2ade s cpm_resident_body 	macro	preffix
2ade 2ade s 
2ade 2ade s ;keyhook support removed 2014-10-22
2ade 2ade s ;больше нет нужды в ней, т.к. есть диск F
2ade 2ade s ; preffix&kbd_hook_noCtrl_03;
2ade 2ade s ; 	ld 	(preffix&save_a),a
2ade 2ade s ; 	cp 	0x03
2ade 2ade s ; 	jp 	preffix&kbd_hook_noCtrl_chk
2ade 2ade s 
2ade 2ade s ; preffix&kbd_hook_noCtrl_33:
2ade 2ade s ; 	ld 	(preffix&save_a),a
2ade 2ade s ; 	cp 	0x33
2ade 2ade s 
2ade 2ade s ; preffix&kbd_hook_noCtrl_chk:
2ade 2ade s ; 	jp 	nz,preffix&bios_hook
2ade 2ade s 
2ade 2ade s ; 	ld 	a,(0xf880)
2ade 2ade s ; 	and 	00100001b
2ade 2ade s ; 	cp 	00100001b
2ade 2ade s 
2ade 2ade s ; 	jp 	nz,preffix&bios_hook
2ade 2ade s 
2ade 2ade s ; 	jp 	preffix&do_key_action
2ade 2ade s 
2ade 2ade s ; preffix&kbd_hook_2133:
2ade 2ade s ; 	ld 	(preffix&save_a),a
2ade 2ade s ; 	ld 	a,c
2ade 2ade s ; 	cp 	0x33 	;stop
2ade 2ade s ; 	jp 	nz,preffix&bios_hook
2ade 2ade s 
2ade 2ade s ; 	ld 	a,b
2ade 2ade s ; 	cp 	0x21 	;ctrl+stop
2ade 2ade s ; 	jp 	nz,preffix&bios_hook
2ade 2ade s 
2ade 2ade s ; preffix&do_key_action:
2ade 2ade s ; 	push 	hl
2ade 2ade s ; 	push 	de
2ade 2ade s ; 	push 	bc
2ade 2ade s ; 	ld 	hl,preffix&msg_hook
2ade 2ade s ; 	ld 	de,0xfc00
2ade 2ade s ; preffix&.kmlp:	
2ade 2ade s ; 	ld 	a,(hl)
2ade 2ade s ; 	or 	a
2ade 2ade s ; 	jp 	z,preffix&.kmlp_ext
2ade 2ade s ; 	ld 	(de),a
2ade 2ade s ; 	inc 	hl
2ade 2ade s ; 	inc 	de
2ade 2ade s ; 	jp 	preffix&.kmlp
2ade 2ade s 
2ade 2ade s ; preffix&.kmlp_ext:
2ade 2ade s ; 	pop 	bc
2ade 2ade s ; 	pop 	de
2ade 2ade s ; 	pop 	hl
2ade 2ade s 
2ade 2ade s ; 	ld 	bc,0 	;simulate no key
2ade 2ade s ; 	ld 	a,0
2ade 2ade s ; 	jp 	preffix&old_hook
2ade 2ade s ; ; 	halt
2ade 2ade s 
2ade 2ade s 
2ade 2ade s ; preffix&bios_hook:
2ade 2ade s ; 	ld 	a,(preffix&save_a)
2ade 2ade s 
2ade 2ade s ; preffix&old_hook:
2ade 2ade s ; 	jp 	$
2ade 2ade s ; preffix&save_a:
2ade 2ade s ; 	db 	0	
2ade 2ade s ; preffix&msg_hook:
2ade 2ade s ; 	db 	'CTRL+SHIFT+STOP pressed',0
2ade 2ade s 
2ade 2ade s ;ptrs to drive drvreg bytes 
2ade 2ade s preffix&res_DRIVE_TAB:
2ade 2ade s 	dw 	0 	;A
2ade 2ade s 	dw 	0 	;B
2ade 2ade s 	dw 	0 	;C
2ade 2ade s 	dw 	0 	;D
2ade 2ade s 	dw 	0 	;E
2ade 2ade s 	dw 	0 	;F
2ade 2ade s 
2ade 2ade s 
2ade 2ade s preffix&dph_F:
2ade 2ade s 	dw	0	;_XLT:           
2ade 2ade s 	dw	0	;_1:             
2ade 2ade s 	dw	0	;_2:             
2ade 2ade s 	dw	0	;_3:             
2ade 2ade s 	dw	0xFC00	;DirBuf: value store here via patcher 0xfc00 - debug
2ade 2ade s 	dw	preffix&dpb_F	;DPB:   
2ade 2ade s 	dw	0	;CSV: - fixed drive   
2ade 2ade s 	dw	preffix&alw_F	;ALV:   
2ade 2ade s 
2ade 2ade s 
2ade 2ade s ;  ФИЗИЧЕСКИЕ ПАРАМЕТРЫ ДИСКА
2ade 2ade s ;--------------------------------------
2ade 2ade s       DB 50H	;контрольная сумма
2ade 2ade s 
2ade 2ade s       DB 080H ;константа скорости движения головки.
2ade 2ade s ;	; 3 - 30 мс на шаг, 2 - 20 мс, 1 - 12 мс,
2ade 2ade s ;	; 0 - 6 мс и 80H - 3 мс.
2ade 2ade s       DB 05H  ; число физических секторов на дорожке
2ade 2ade s       DB 01H  ; информация о сторонах диска
2ade 2ade s ;	;( 00 - односторонный диск
2ade 2ade s ;	;  01 - двухсторонний диск
2ade 2ade s       DB 03	; 512 bytes/sector
2ade 2ade s ;	;( 00 - 128 байт/сектор
2ade 2ade s ;	;  01 - 256 байт/сектор
2ade 2ade s ;	;  02 - 512 байт/сектор
2ade 2ade s ;	;  03 - 1024 байт/сектор
2ade 2ade s       DB 0	; номер текущей дорожки.
2ade 2ade s       DB 0	; позиционный номер устройства (00000100) - для записи в регистр выбора
2ade 2ade s ;---------------------------------------------------
2ade 2ade s       DB 0	;INFO	; флаг успешного считывания
2ade 2ade s 
2ade 2ade s preffix&dpb_F:
2ade 2ade s ; kdi params
2ade 2ade s       DW 40	;128 байтовых секторов/трек ; SPT
2ade 2ade s       DB 4	; размер блока миним.кбайт  ; BSH
2ade 2ade s ;	; фактор сдвига блока распределения данных
2ade 2ade s ;	; определяется размером блока данных. Блок 
2ade 2ade s ;	; данных - минимально возможная частица файла.
2ade 2ade s ;	; Размер блока - 1, 2, 4, 8 или 16 Кбайт. Если
2ade 2ade s ;	; блок имеет большой размер, в каждом файле 
2ade 2ade s ;	; теряется значительное число неиспользуемых
2ade 2ade s ;	; секторов. При уменьшении размера блока
2ade 2ade s ;	; увеличивается размер директории, описывающий
2ade 2ade s ;	; расположение частей файла. BSH = log2[число
2ade 2ade s ;	; логических секторов в блоке].
2ade 2ade s       DB 15	; число логических сек/блок  ; BLM
2ade 2ade s ;	; маска блока распределения данных.
2ade 2ade s ;	; BLM = (число логических секторов в блоке)-1.
2ade 2ade s       DB 0	; extent mask                ; EXM
2ade 2ade s ;	; = (BLM+1)*128/1024 - 1 - [DSM/256]. EXM - 
2ade 2ade s ;	; вспомогательная величина для определения
2ade 2ade s ;	; номера extent'а.
2ade 2ade s ;	; extent - часть файла, описываемая одним 
2ade 2ade s ;	; входом в директорию.
2ade 2ade s       DW 394	; обьем диска в блоках-1     ; DSM
2ade 2ade s       DW 127	; входов в директорий-1      ; DRM
2ade 2ade s       DB 192	; определяет, какие блоки    ; AL0
2ade 2ade s ;	; зарезервированы
2ade 2ade s       DB 0	; alloc 1                    ; AL1
2ade 2ade s ;	; под директорию. Каждый  бит AL0,AL1, 
2ade 2ade s ;	; начиная со старшего бита AL0 и кончая 
2ade 2ade s ;	; младшим битом AL1, значением 1 резервирует
2ade 2ade s ;	; один блок данных для директории. Нужно
2ade 2ade s ;	; резервировать необходимое число блоков
2ade 2ade s ;	; для хранения входов в директорию: 32*DRM/BLS
2ade 2ade s       DW 0	; размер вектора контроля директории. ; CKS
2ade 2ade s ;	; CKS=(DRM+1)/4. Если диск не сменяем, CKS=0.
2ade 2ade s       DW 2	; число системных дорожек    ; OFS
2ade 2ade s 
2ade 2ade s 
2ade 2ade s ; preffix&alw_F: 	ds 	50
2ade 2ade s preffix&alw_F: 	ds 	50
2ade 2ade s 
2ade 2ade s 
2ade 2ade s preffix&res_seldsk:
2ade 2ade s 	ld 	a,c
2ade 2ade s 	cp 	0xfe
2ade 2ade s preffix&old_seld_dsk:
2ade 2ade s 	jp 	nz,$	
2ade 2ade s 	ld 	hl,preffix&res_DRIVE_TAB
2ade 2ade s 	ret
2ade 2ade s 
2ade 2ade s 
2ade 2ade s ;RAM:DA27 C3 EB DC                 jp      j_READ
2ade 2ade s 
2ade 2ade s ;RAM:DCEB          j_READ:                                 ; CODE XREF: RAM:_READj
2ade 2ade s ;RAM:DCEB                                                  ; RAM:DB84p
2ade 2ade s ;RAM:DCEB
2ade 2ade s ;RAM:DCEB          ; FUNCTION CHUNK AT RAM:DDC4 SIZE 0000007B BYTES
2ade 2ade s ;RAM:DCEB
2ade 2ade s ;RAM:DCEB 3E 04                    ld      a, 4
2ade 2ade s ;RAM:DCED 32 66 E0                 ld      (_OPERATION), a
2ade 2ade s ;RAM:DCF0 3A 64 E0                 ld      a, (_DSK)
2ade 2ade s ;RAM:DCF3 FE 04                    cp      4
2ade 2ade s ;RAM:DCF5 CA C4 DD                 jp      z, loc_DDC4
2ade 2ade s 
2ade 2ade s ;сюда попадает из биоса JP READ
2ade 2ade s ;а если не наше то прыгаем на старый read
2ade 2ade s preffix&res_READ:
2ade 2ade s ; 	ld	 A,4	;Режим чтения
2ade 2ade s ; 	ld  	(_OPER),a
2ade 2ade s preffix&r_p_DSK1:
2ade 2ade s 	ld 	a,(_DSK) 	;_DSK
2ade 2ade s 	cp 	4
2ade 2ade s 	jp 	z,preffix&_old_read
2ade 2ade s 
2ade 2ade s 	cp 	5 		;disk F mapped to EMU drive E
2ade 2ade s 	jp 	nz,preffix&.r_no_drv_dec
2ade 2ade s 	dec 	a
2ade 2ade s 
2ade 2ade s preffix&.r_no_drv_dec:
2ade 2ade s 	LD	(preffix&EXR_DRV),A	; # устройства
2ade 2ade s 
2ade 2ade s 	push 	hl
2ade 2ade s preffix&r_p_SELDSKDRIVER:
2ade 2ade s 	ld 	hl,(0)	;EXR_SELDSK_DRIVE
2ade 2ade s 	ld 	a,(hl)
2ade 2ade s 	pop 	hl
2ade 2ade s 	or 	a
2ade 2ade s 	jp 	nz,preffix&_old_read
2ade 2ade s 
2ade 2ade s preffix&r_p_TRK1:
2ade 2ade s 	LD	A,(_TRK)	
2ade 2ade s 	LD	(preffix&EXR_TRK),A	; дорожка
2ade 2ade s preffix&r_p_SEC1:
2ade 2ade s 	LD	A,(_SEC)	; сектор
2ade 2ade s 	DEC	A		; у нас номер сектора начинается с 0
2ade 2ade s 	LD	(preffix&EXR_SEC),A
2ade 2ade s 
2ade 2ade s 	LD	A,1
2ade 2ade s 	LD	(preffix&EXR_CMD),A	; 1 - команда чтения
2ade 2ade s 
2ade 2ade s 	CALL	preffix&EXR_SENDCMD	; отсылаем команду
2ade 2ade s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
2ade 2ade s 	RET	NZ		; 0 - ошибка
2ade 2ade s preffix&r_p_DMA1:
2ade 2ade s 	LD	HL,(_DMA)	; адрес буфера для приема данных
2ade 2ade s 	CALL	preffix&EXR_GETSEC	; принимаем данные
2ade 2ade s 	XOR	A		; завершение всегда успешно
2ade 2ade s 	RET
2ade 2ade s ;
2ade 2ade s 
2ade 2ade s preffix&_old_read:
2ade 2ade s 	jp 	$
2ade 2ade s 
2ade 2ade s preffix&res_WRITE:
2ade 2ade s ; 	ld	 A,6	;Режим чтения
2ade 2ade s ; 	ld  	(_OPER),a
2ade 2ade s 
2ade 2ade s preffix&r_p_DSK2:
2ade 2ade s 	ld 	a,(_DSK) 	;_DSK
2ade 2ade s 	cp 	4
2ade 2ade s 	jp 	z,preffix&_old_write
2ade 2ade s 	cp 	5 		;disk F mapped to EMU drive E
2ade 2ade s 	jp 	nz,preffix&.w_no_drv_dec
2ade 2ade s 	dec 	a
2ade 2ade s preffix&.w_no_drv_dec:
2ade 2ade s 	LD	(preffix&EXR_DRV),A
2ade 2ade s 
2ade 2ade s 
2ade 2ade s 	push 	hl
2ade 2ade s preffix&r_p_SELDSKDRIVEW:
2ade 2ade s 	ld 	hl,(0)	;EXR_SELDSK_DRIVE
2ade 2ade s 	ld 	a,(hl)
2ade 2ade s 	pop 	hl
2ade 2ade s 	or 	a
2ade 2ade s 	jp 	nz,preffix&_old_write
2ade 2ade s 
2ade 2ade s preffix&r_p_TRK2:
2ade 2ade s 	LD	A,(_TRK)
2ade 2ade s 	LD	(preffix&EXR_TRK),A
2ade 2ade s preffix&r_p_SEC2:
2ade 2ade s 	LD	A,(_SEC)
2ade 2ade s 	DEC	A
2ade 2ade s 	LD	(preffix&EXR_SEC),A
2ade 2ade s 
2ade 2ade s 	LD	A,2		; 2 - команда записи
2ade 2ade s 	LD	(preffix&EXR_CMD),A
2ade 2ade s 
2ade 2ade s 	CALL	preffix&EXR_SENDCMD
2ade 2ade s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
2ade 2ade s 	RET	NZ		; 0 - ошибка
2ade 2ade s preffix&r_p_DMA2:
2ade 2ade s 	LD	HL,(_DMA)
2ade 2ade s 	CALL	preffix&EXR_PUTSEC
2ade 2ade s 	XOR	A		; запись успешна
2ade 2ade s 	RET
2ade 2ade s 
2ade 2ade s preffix&_old_write:
2ade 2ade s 	jp 	$
2ade 2ade s 
2ade 2ade s 
2ade 2ade s preffix&res_GETINFO:
2ade 2ade s 
2ade 2ade s 	LD 	A,(HL)	; A= маска выбора привода
2ade 2ade s 	or 	a
2ade 2ade s 	jp 	nz,preffix&_old_getinfo 	;=0 if emulated
2ade 2ade s 
2ade 2ade s ;
2ade 2ade s ;  Чтение с эмулируемых дисков A или B
2ade 2ade s ;
2ade 2ade s 	push 	hl
2ade 2ade s 	CALL	preffix&EXR_READINFO
2ade 2ade s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
2ade 2ade s ; 	JP	NZ,0xE6ff	;IERR		; 0 - ошибка
2ade 2ade s preffix&_old_getinfo_chkdo:
2ade 2ade s 	JP	$ 		;IERR jnz xxx, CHKDO
2ade 2ade s ; ;
2ade 2ade s preffix&_old_getinfo:
2ade 2ade s 	jp 	$ 		;GETINFO
2ade 2ade s 
2ade 2ade s 
2ade 2ade s ;==================  Драйвер ExtROM-API ====================================
2ade 2ade s 	
2ade 2ade s 	
2ade 2ade s ;****************************************
2ade 2ade s ;*  Прием байта из порта А по стробу    *
2ade 2ade s ;****************************************
2ade 2ade s preffix&EXR_GETBYTE:
2ade 2ade s 	PUSH	HL
2ade 2ade s 	LD	HL,rPORTC
2ade 2ade s preffix&pWG:
2ade 2ade s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2ade 2ade s 	AND	20h		; выделяем сигнал IBF
2ade 2ade s 	JP	Z,preffix&pWG		; IBF=0 - данных еще нет
2ade 2ade s 	LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
2ade 2ade s 	POP	HL
2ade 2ade s 	RET
2ade 2ade s 
2ade 2ade s ;****************************************
2ade 2ade s ;*  Отправка байта в порт A             *
2ade 2ade s ;****************************************
2ade 2ade s preffix&EXR_PUTBYTE:
2ade 2ade s 	PUSH	HL
2ade 2ade s 	PUSH	AF
2ade 2ade s 	LD	HL,rPORTC
2ade 2ade s preffix&pWP:
2ade 2ade s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2ade 2ade s 	AND	80h		; выделяем сигнал -OBF
2ade 2ade s 	JP	Z,preffix&pWP		; -OBF=0 - в передатчике сидит незабранный байт
2ade 2ade s 	POP	AF
2ade 2ade s 	LD	(rPORTA),A		; данные поступили - выбираем их из порта А
2ade 2ade s 	POP	HL
2ade 2ade s 	RET
2ade 2ade s 
2ade 2ade s ;*******************************************
2ade 2ade s ;*      Прием сектора                      *
2ade 2ade s ;* HL - адрес размещения сектора в памяти  *
2ade 2ade s ;*  Размер сектора - 128 байт              *
2ade 2ade s ;*******************************************
2ade 2ade s preffix&EXR_GETSEC:
2ade 2ade s 	di
2ade 2ade s 	PUSH	BC
2ade 2ade s 	PUSH	DE
2ade 2ade s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
2ade 2ade s 	EX	DE,HL		; адрес буфера -> DE
2ade 2ade s 	LD	HL,rPORTC
2ade 2ade s preffix&pGSL:
2ade 2ade s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2ade 2ade s 	AND	20h		; выделяем сигнал IBF
2ade 2ade s 	JP	Z,preffix&pGSL		; IBF=0 - данных еще нет
2ade 2ade s 	LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
2ade 2ade s 	LD	(DE),A		; принимаем и размещаем очередной байт
2ade 2ade s 	INC	DE		; указатель буфера ++
2ade 2ade s 	DEC	C		; принимаем остальные байты
2ade 2ade s 	JP	NZ,preffix&pGSL
2ade 2ade s 	POP	DE
2ade 2ade s 	POP	BC
2ade 2ade s ; 	ei - int should be still disabled 
2ade 2ade s 	RET
2ade 2ade s 
2ade 2ade s ;*******************************************
2ade 2ade s ;*      Передача сектора                   *
2ade 2ade s ;* HL - адрес размещения сектора в памяти  *
2ade 2ade s ;*  Размер сектора - 128 байт              *
2ade 2ade s ;*******************************************
2ade 2ade s preffix&EXR_PUTSEC:
2ade 2ade s 	di
2ade 2ade s 	PUSH	BC
2ade 2ade s 	PUSH	DE
2ade 2ade s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
2ade 2ade s 	EX	DE,HL		; адрес буфера -> DE
2ade 2ade s 	LD	HL,rPORTC
2ade 2ade s preffix&pPSL:
2ade 2ade s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
2ade 2ade s 	AND	80h		; выделяем сигнал -OBF
2ade 2ade s 	JP	Z,preffix&pPSL		; -OBF=0 - в передатчике сидит незабранный байт
2ade 2ade s 	LD	A,(DE)		; принимаем и размещаем очередной байт
2ade 2ade s 	LD	(rPORTA),A		; данные поступили - выбираем их из порта А
2ade 2ade s 	INC	DE
2ade 2ade s 	DEC	C		; принимаем остальные байты
2ade 2ade s 	JP	NZ,preffix&pPSL
2ade 2ade s 	POP	DE
2ade 2ade s 	POP	BC
2ade 2ade s ; 	ei - int should be still disabled 
2ade 2ade s 	RET
2ade 2ade s 
2ade 2ade s ;****************************************
2ade 2ade s ;*     Отправка командного пакета       *
2ade 2ade s ;****************************************
2ade 2ade s preffix&EXR_SENDCMD:
2ade 2ade s 
2ade 2ade s 	di
2ade 2ade s 	PUSH	HL
2ade 2ade s 	PUSH	BC
2ade 2ade s 	LD	A,0Ch
2ade 2ade s 	LD	(rPCWR),A	; переключаем порт в режим 2
2ade 2ade s 	LD	HL,preffix&EXR_CMD
2ade 2ade s 	LD	C,4		; пакет - 4 байта
2ade 2ade s 	LD	B,0		; заготовка контрольной суммы
2ade 2ade s preffix&pSCL:
2ade 2ade s 	LD	A,(HL)		; очередной байт пакета 
2ade 2ade s 	ADD 	B		; добавляем к КС
2ade 2ade s 	LD	B,A
2ade 2ade s 	LD	A,(HL)		; очередной байт пакета 
2ade 2ade s 	CALL	preffix&EXR_PUTBYTE		; - в порт
2ade 2ade s 	INC	HL
2ade 2ade s 	DEC	C
2ade 2ade s 	JP	NZ,preffix&pSCL
2ade 2ade s 	LD	A,B
2ade 2ade s 	DEC 	A		; КС-1
2ade 2ade s 	CALL	preffix&EXR_PUTBYTE     ; контрольная сумма
2ade 2ade s 	CALL	preffix&EXR_GETBYTE	; ответ контроллера
2ade 2ade s 	POP	BC
2ade 2ade s 	POP	HL
2ade 2ade s ; 	ei - int should be still disabled 
2ade 2ade s 	RET
2ade 2ade s 
2ade 2ade s ;*******************************************
2ade 2ade s ;*  Чтение информационного сектора
2ade 2ade s ;*******************************************
2ade 2ade s preffix&EXR_READINFO:
2ade 2ade s 	LD	HL,preffix&EXR_CMD	; командный пакет
2ade 2ade s 	LD	(HL),1		; команда чтения
2ade 2ade s 	INC	HL
2ade 2ade s preffix&r_p_DSK3:
2ade 2ade s 	LD	A,(_DSK)	; вписываем # устройства
2ade 2ade s 	LD	(HL),A
2ade 2ade s 	INC	HL
2ade 2ade s 	LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
2ade 2ade s 	INC	HL
2ade 2ade s 	LD	(HL),0		
2ade 2ade s 	CALL	preffix&EXR_SENDCMD	; отправляем команду
2ade 2ade s 	OR	A
2ade 2ade s 	RET 	Z		; ошибка
2ade 2ade s 	LD	HL,_RRBUFF	; принимаем данные
2ade 2ade s 	CALL	preffix&EXR_GETSEC
2ade 2ade s 	LD	A,1
2ade 2ade s 	RET
2ade 2ade s 
2ade 2ade s 
2ade 2ade s ; Командный пакет интерфейса Extrom-API
2ade 2ade s ;===============================================
2ade 2ade s preffix&EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
2ade 2ade s preffix&EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
2ade 2ade s preffix&EXR_TRK:	DB	0	; логическая дорожка
2ade 2ade s preffix&EXR_SEC:	DB	0	; логический сектор (128b)
2ade 2ade s 
2ade 2ade f generator/V0/extrom-patcher.asm
2ade 2ade s 	endm
2ade 2ade s 	include 	"extrom-patcher-resident-cpm1.asm"
2ade 2ade f extrom-patcher-resident-cpm1.asm
2ade 2ade s 	;    12_87_11_niijaf
2ade 2ade s 	;     E8AC-EBA6  = 762 
2ade 2ade s 	;     
2ade 2ade s 
2ade 2ade s resident_cpm1	equ $
2ade 2ade s 
e8ac 2ade s 	.phase 0xE8AC
e8ac 2ade s 
e8ac 2ade s resident_cpm1_addr 	EQU 	$
e8ac 2ade s 
e8ac 2ade s 	cpm_resident_body _cpm1_
e8ac 2ade s 
e8ac 2ade s ;keyhook support removed 2014-10-22
e8ac 2ade s ;больше нет нужды в ней, т.к. есть диск F
e8ac 2ade s ; preffix&kbd_hook_noCtrl_03;
e8ac 2ade s ; 	ld 	(preffix&save_a),a
e8ac 2ade s ; 	cp 	0x03
e8ac 2ade s ; 	jp 	preffix&kbd_hook_noCtrl_chk
e8ac 2ade s 
e8ac 2ade s ; preffix&kbd_hook_noCtrl_33:
e8ac 2ade s ; 	ld 	(preffix&save_a),a
e8ac 2ade s ; 	cp 	0x33
e8ac 2ade s 
e8ac 2ade s ; preffix&kbd_hook_noCtrl_chk:
e8ac 2ade s ; 	jp 	nz,preffix&bios_hook
e8ac 2ade s 
e8ac 2ade s ; 	ld 	a,(0xf880)
e8ac 2ade s ; 	and 	00100001b
e8ac 2ade s ; 	cp 	00100001b
e8ac 2ade s 
e8ac 2ade s ; 	jp 	nz,preffix&bios_hook
e8ac 2ade s 
e8ac 2ade s ; 	jp 	preffix&do_key_action
e8ac 2ade s 
e8ac 2ade s ; preffix&kbd_hook_2133:
e8ac 2ade s ; 	ld 	(preffix&save_a),a
e8ac 2ade s ; 	ld 	a,c
e8ac 2ade s ; 	cp 	0x33 	;stop
e8ac 2ade s ; 	jp 	nz,preffix&bios_hook
e8ac 2ade s 
e8ac 2ade s ; 	ld 	a,b
e8ac 2ade s ; 	cp 	0x21 	;ctrl+stop
e8ac 2ade s ; 	jp 	nz,preffix&bios_hook
e8ac 2ade s 
e8ac 2ade s ; preffix&do_key_action:
e8ac 2ade s ; 	push 	hl
e8ac 2ade s ; 	push 	de
e8ac 2ade s ; 	push 	bc
e8ac 2ade s ; 	ld 	hl,preffix&msg_hook
e8ac 2ade s ; 	ld 	de,0xfc00
e8ac 2ade s ; preffix&.kmlp:	
e8ac 2ade s ; 	ld 	a,(hl)
e8ac 2ade s ; 	or 	a
e8ac 2ade s ; 	jp 	z,preffix&.kmlp_ext
e8ac 2ade s ; 	ld 	(de),a
e8ac 2ade s ; 	inc 	hl
e8ac 2ade s ; 	inc 	de
e8ac 2ade s ; 	jp 	preffix&.kmlp
e8ac 2ade s 
e8ac 2ade s ; preffix&.kmlp_ext:
e8ac 2ade s ; 	pop 	bc
e8ac 2ade s ; 	pop 	de
e8ac 2ade s ; 	pop 	hl
e8ac 2ade s 
e8ac 2ade s ; 	ld 	bc,0 	;simulate no key
e8ac 2ade s ; 	ld 	a,0
e8ac 2ade s ; 	jp 	preffix&old_hook
e8ac 2ade s ; ; 	halt
e8ac 2ade s 
e8ac 2ade s 
e8ac 2ade s ; preffix&bios_hook:
e8ac 2ade s ; 	ld 	a,(preffix&save_a)
e8ac 2ade s 
e8ac 2ade s ; preffix&old_hook:
e8ac 2ade s ; 	jp 	$
e8ac 2ade s ; preffix&save_a:
e8ac 2ade s ; 	db 	0	
e8ac 2ade s ; preffix&msg_hook:
e8ac 2ade s ; 	db 	'CTRL+SHIFT+STOP pressed',0
e8ac 2ade s 
e8ac 2ade s ;ptrs to drive drvreg bytes 
e8ac 2ade s _cpm1_res_DRIVE_TAB:
e8ac 2ade d 0000
e8ac 2ade s 	dw 	0 	;A
e8ae 2ae0 d 0000
e8ae 2ae0 s 	dw 	0 	;B
e8b0 2ae2 d 0000
e8b0 2ae2 s 	dw 	0 	;C
e8b2 2ae4 d 0000
e8b2 2ae4 s 	dw 	0 	;D
e8b4 2ae6 d 0000
e8b4 2ae6 s 	dw 	0 	;E
e8b6 2ae8 d 0000
e8b6 2ae8 s 	dw 	0 	;F
e8b8 2aea s 
e8b8 2aea s 
e8b8 2aea s _cpm1_dph_F:
e8b8 2aea d 0000
e8b8 2aea s 	dw	0	;_XLT:           
e8ba 2aec d 0000
e8ba 2aec s 	dw	0	;_1:             
e8bc 2aee d 0000
e8bc 2aee s 	dw	0	;_2:             
e8be 2af0 d 0000
e8be 2af0 s 	dw	0	;_3:             
e8c0 2af2 d 00fc
e8c0 2af2 s 	dw	0xFC00	;DirBuf: value store here via patcher 0xfc00 - debug
e8c2 2af4 d d0e8
e8c2 2af4 s 	dw	_cpm1_dpb_F	;DPB:   
e8c4 2af6 d 0000
e8c4 2af6 s 	dw	0	;CSV: - fixed drive   
e8c6 2af8 d dfe8
e8c6 2af8 s 	dw	_cpm1_alw_F	;ALV:   
e8c8 2afa s 
e8c8 2afa s 
e8c8 2afa s ;  ФИЗИЧЕСКИЕ ПАРАМЕТРЫ ДИСКА
e8c8 2afa s ;--------------------------------------
e8c8 2afa d 50
e8c8 2afa s       DB 50H	;контрольная сумма
e8c9 2afb s 
e8c9 2afb d 80
e8c9 2afb s       DB 080H ;константа скорости движения головки.
e8ca 2afc s ;	; 3 - 30 мс на шаг, 2 - 20 мс, 1 - 12 мс,
e8ca 2afc s ;	; 0 - 6 мс и 80H - 3 мс.
e8ca 2afc d 05
e8ca 2afc s       DB 05H  ; число физических секторов на дорожке
e8cb 2afd d 01
e8cb 2afd s       DB 01H  ; информация о сторонах диска
e8cc 2afe s ;	;( 00 - односторонный диск
e8cc 2afe s ;	;  01 - двухсторонний диск
e8cc 2afe d 03
e8cc 2afe s       DB 03	; 512 bytes/sector
e8cd 2aff s ;	;( 00 - 128 байт/сектор
e8cd 2aff s ;	;  01 - 256 байт/сектор
e8cd 2aff s ;	;  02 - 512 байт/сектор
e8cd 2aff s ;	;  03 - 1024 байт/сектор
e8cd 2aff d 00
e8cd 2aff s       DB 0	; номер текущей дорожки.
e8ce 2b00 d 00
e8ce 2b00 s       DB 0	; позиционный номер устройства (00000100) - для записи в регистр выбора
e8cf 2b01 s ;---------------------------------------------------
e8cf 2b01 d 00
e8cf 2b01 s       DB 0	;INFO	; флаг успешного считывания
e8d0 2b02 s 
e8d0 2b02 s _cpm1_dpb_F:
e8d0 2b02 s ; kdi params
e8d0 2b02 d 2800
e8d0 2b02 s       DW 40	;128 байтовых секторов/трек ; SPT
e8d2 2b04 d 04
e8d2 2b04 s       DB 4	; размер блока миним.кбайт  ; BSH
e8d3 2b05 s ;	; фактор сдвига блока распределения данных
e8d3 2b05 s ;	; определяется размером блока данных. Блок 
e8d3 2b05 s ;	; данных - минимально возможная частица файла.
e8d3 2b05 s ;	; Размер блока - 1, 2, 4, 8 или 16 Кбайт. Если
e8d3 2b05 s ;	; блок имеет большой размер, в каждом файле 
e8d3 2b05 s ;	; теряется значительное число неиспользуемых
e8d3 2b05 s ;	; секторов. При уменьшении размера блока
e8d3 2b05 s ;	; увеличивается размер директории, описывающий
e8d3 2b05 s ;	; расположение частей файла. BSH = log2[число
e8d3 2b05 s ;	; логических секторов в блоке].
e8d3 2b05 d 0f
e8d3 2b05 s       DB 15	; число логических сек/блок  ; BLM
e8d4 2b06 s ;	; маска блока распределения данных.
e8d4 2b06 s ;	; BLM = (число логических секторов в блоке)-1.
e8d4 2b06 d 00
e8d4 2b06 s       DB 0	; extent mask                ; EXM
e8d5 2b07 s ;	; = (BLM+1)*128/1024 - 1 - [DSM/256]. EXM - 
e8d5 2b07 s ;	; вспомогательная величина для определения
e8d5 2b07 s ;	; номера extent'а.
e8d5 2b07 s ;	; extent - часть файла, описываемая одним 
e8d5 2b07 s ;	; входом в директорию.
e8d5 2b07 d 8a01
e8d5 2b07 s       DW 394	; обьем диска в блоках-1     ; DSM
e8d7 2b09 d 7f00
e8d7 2b09 s       DW 127	; входов в директорий-1      ; DRM
e8d9 2b0b d c0
e8d9 2b0b s       DB 192	; определяет, какие блоки    ; AL0
e8da 2b0c s ;	; зарезервированы
e8da 2b0c d 00
e8da 2b0c s       DB 0	; alloc 1                    ; AL1
e8db 2b0d s ;	; под директорию. Каждый  бит AL0,AL1, 
e8db 2b0d s ;	; начиная со старшего бита AL0 и кончая 
e8db 2b0d s ;	; младшим битом AL1, значением 1 резервирует
e8db 2b0d s ;	; один блок данных для директории. Нужно
e8db 2b0d s ;	; резервировать необходимое число блоков
e8db 2b0d s ;	; для хранения входов в директорию: 32*DRM/BLS
e8db 2b0d d 0000
e8db 2b0d s       DW 0	; размер вектора контроля директории. ; CKS
e8dd 2b0f s ;	; CKS=(DRM+1)/4. Если диск не сменяем, CKS=0.
e8dd 2b0f d 0200
e8dd 2b0f s       DW 2	; число системных дорожек    ; OFS
e8df 2b11 s 
e8df 2b11 s 
e8df 2b11 s ; preffix&alw_F: 	ds 	50
e8df 2b11 s _cpm1_alw_F: 	ds 	50
e8df 2b11 d 00000000000000000000000000000000
e8ef 2b21 d 00000000000000000000000000000000
e8ff 2b31 d 00000000000000000000000000000000
e90f 2b41 d 0000
e911 2b43 s 
e911 2b43 s 
e911 2b43 s _cpm1_res_seldsk:
e911 2b43 d 79
e911 2b43 s 	ld 	a,c
e912 2b44 d fefe
e912 2b44 s 	cp 	0xfe
e914 2b46 s _cpm1_old_seld_dsk:
e914 2b46 d c214e9
e914 2b46 s 	jp 	nz,$	
e917 2b49 d 21ace8
e917 2b49 s 	ld 	hl,_cpm1_res_DRIVE_TAB
e91a 2b4c d c9
e91a 2b4c s 	ret
e91b 2b4d s 
e91b 2b4d s 
e91b 2b4d s ;RAM:DA27 C3 EB DC                 jp      j_READ
e91b 2b4d s 
e91b 2b4d s ;RAM:DCEB          j_READ:                                 ; CODE XREF: RAM:_READj
e91b 2b4d s ;RAM:DCEB                                                  ; RAM:DB84p
e91b 2b4d s ;RAM:DCEB
e91b 2b4d s ;RAM:DCEB          ; FUNCTION CHUNK AT RAM:DDC4 SIZE 0000007B BYTES
e91b 2b4d s ;RAM:DCEB
e91b 2b4d s ;RAM:DCEB 3E 04                    ld      a, 4
e91b 2b4d s ;RAM:DCED 32 66 E0                 ld      (_OPERATION), a
e91b 2b4d s ;RAM:DCF0 3A 64 E0                 ld      a, (_DSK)
e91b 2b4d s ;RAM:DCF3 FE 04                    cp      4
e91b 2b4d s ;RAM:DCF5 CA C4 DD                 jp      z, loc_DDC4
e91b 2b4d s 
e91b 2b4d s ;сюда попадает из биоса JP READ
e91b 2b4d s ;а если не наше то прыгаем на старый read
e91b 2b4d s _cpm1_res_READ:
e91b 2b4d s ; 	ld	 A,4	;Режим чтения
e91b 2b4d s ; 	ld  	(_OPER),a
e91b 2b4d s _cpm1_r_p_DSK1:
e91b 2b4d d 3affff
e91b 2b4d s 	ld 	a,(_DSK) 	;_DSK
e91e 2b50 d fe04
e91e 2b50 s 	cp 	4
e920 2b52 d ca55e9
e920 2b52 s 	jp 	z,_cpm1__old_read
e923 2b55 s 
e923 2b55 d fe05
e923 2b55 s 	cp 	5 		;disk F mapped to EMU drive E
e925 2b57 d c229e9
e925 2b57 s 	jp 	nz,_cpm1_.r_no_drv_dec
e928 2b5a d 3d
e928 2b5a s 	dec 	a
e929 2b5b s 
e929 2b5b s _cpm1_.r_no_drv_dec:
e929 2b5b d 3240ea
e929 2b5b s 	LD	(_cpm1_EXR_DRV),A	; # устройства
e92c 2b5e s 
e92c 2b5e d e5
e92c 2b5e s 	push 	hl
e92d 2b5f s _cpm1_r_p_SELDSKDRIVER:
e92d 2b5f d 2a0000
e92d 2b5f s 	ld 	hl,(0)	;EXR_SELDSK_DRIVE
e930 2b62 d 7e
e930 2b62 s 	ld 	a,(hl)
e931 2b63 d e1
e931 2b63 s 	pop 	hl
e932 2b64 d b7
e932 2b64 s 	or 	a
e933 2b65 d c255e9
e933 2b65 s 	jp 	nz,_cpm1__old_read
e936 2b68 s 
e936 2b68 s _cpm1_r_p_TRK1:
e936 2b68 d 3affff
e936 2b68 s 	LD	A,(_TRK)	
e939 2b6b d 3241ea
e939 2b6b s 	LD	(_cpm1_EXR_TRK),A	; дорожка
e93c 2b6e s _cpm1_r_p_SEC1:
e93c 2b6e d 3affff
e93c 2b6e s 	LD	A,(_SEC)	; сектор
e93f 2b71 d 3d
e93f 2b71 s 	DEC	A		; у нас номер сектора начинается с 0
e940 2b72 d 3242ea
e940 2b72 s 	LD	(_cpm1_EXR_SEC),A
e943 2b75 s 
e943 2b75 d 3e01
e943 2b75 s 	LD	A,1
e945 2b77 d 323fea
e945 2b77 s 	LD	(_cpm1_EXR_CMD),A	; 1 - команда чтения
e948 2b7a s 
e948 2b7a d cdfbe9
e948 2b7a s 	CALL	_cpm1_EXR_SENDCMD	; отсылаем команду
e94b 2b7d d 3d
e94b 2b7d s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
e94c 2b7e d c0
e94c 2b7e s 	RET	NZ		; 0 - ошибка
e94d 2b7f s _cpm1_r_p_DMA1:
e94d 2b7f d 2affff
e94d 2b7f s 	LD	HL,(_DMA)	; адрес буфера для приема данных
e950 2b82 d cdc5e9
e950 2b82 s 	CALL	_cpm1_EXR_GETSEC	; принимаем данные
e953 2b85 d af
e953 2b85 s 	XOR	A		; завершение всегда успешно
e954 2b86 d c9
e954 2b86 s 	RET
e955 2b87 s ;
e955 2b87 s 
e955 2b87 s _cpm1__old_read:
e955 2b87 d c355e9
e955 2b87 s 	jp 	$
e958 2b8a s 
e958 2b8a s _cpm1_res_WRITE:
e958 2b8a s ; 	ld	 A,6	;Режим чтения
e958 2b8a s ; 	ld  	(_OPER),a
e958 2b8a s 
e958 2b8a s _cpm1_r_p_DSK2:
e958 2b8a d 3affff
e958 2b8a s 	ld 	a,(_DSK) 	;_DSK
e95b 2b8d d fe04
e95b 2b8d s 	cp 	4
e95d 2b8f d ca92e9
e95d 2b8f s 	jp 	z,_cpm1__old_write
e960 2b92 d fe05
e960 2b92 s 	cp 	5 		;disk F mapped to EMU drive E
e962 2b94 d c266e9
e962 2b94 s 	jp 	nz,_cpm1_.w_no_drv_dec
e965 2b97 d 3d
e965 2b97 s 	dec 	a
e966 2b98 s _cpm1_.w_no_drv_dec:
e966 2b98 d 3240ea
e966 2b98 s 	LD	(_cpm1_EXR_DRV),A
e969 2b9b s 
e969 2b9b s 
e969 2b9b d e5
e969 2b9b s 	push 	hl
e96a 2b9c s _cpm1_r_p_SELDSKDRIVEW:
e96a 2b9c d 2a0000
e96a 2b9c s 	ld 	hl,(0)	;EXR_SELDSK_DRIVE
e96d 2b9f d 7e
e96d 2b9f s 	ld 	a,(hl)
e96e 2ba0 d e1
e96e 2ba0 s 	pop 	hl
e96f 2ba1 d b7
e96f 2ba1 s 	or 	a
e970 2ba2 d c292e9
e970 2ba2 s 	jp 	nz,_cpm1__old_write
e973 2ba5 s 
e973 2ba5 s _cpm1_r_p_TRK2:
e973 2ba5 d 3affff
e973 2ba5 s 	LD	A,(_TRK)
e976 2ba8 d 3241ea
e976 2ba8 s 	LD	(_cpm1_EXR_TRK),A
e979 2bab s _cpm1_r_p_SEC2:
e979 2bab d 3affff
e979 2bab s 	LD	A,(_SEC)
e97c 2bae d 3d
e97c 2bae s 	DEC	A
e97d 2baf d 3242ea
e97d 2baf s 	LD	(_cpm1_EXR_SEC),A
e980 2bb2 s 
e980 2bb2 d 3e02
e980 2bb2 s 	LD	A,2		; 2 - команда записи
e982 2bb4 d 323fea
e982 2bb4 s 	LD	(_cpm1_EXR_CMD),A
e985 2bb7 s 
e985 2bb7 d cdfbe9
e985 2bb7 s 	CALL	_cpm1_EXR_SENDCMD
e988 2bba d 3d
e988 2bba s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
e989 2bbb d c0
e989 2bbb s 	RET	NZ		; 0 - ошибка
e98a 2bbc s _cpm1_r_p_DMA2:
e98a 2bbc d 2affff
e98a 2bbc s 	LD	HL,(_DMA)
e98d 2bbf d cde0e9
e98d 2bbf s 	CALL	_cpm1_EXR_PUTSEC
e990 2bc2 d af
e990 2bc2 s 	XOR	A		; запись успешна
e991 2bc3 d c9
e991 2bc3 s 	RET
e992 2bc4 s 
e992 2bc4 s _cpm1__old_write:
e992 2bc4 d c392e9
e992 2bc4 s 	jp 	$
e995 2bc7 s 
e995 2bc7 s 
e995 2bc7 s _cpm1_res_GETINFO:
e995 2bc7 s 
e995 2bc7 d 7e
e995 2bc7 s 	LD 	A,(HL)	; A= маска выбора привода
e996 2bc8 d b7
e996 2bc8 s 	or 	a
e997 2bc9 d c2a2e9
e997 2bc9 s 	jp 	nz,_cpm1__old_getinfo 	;=0 if emulated
e99a 2bcc s 
e99a 2bcc s ;
e99a 2bcc s ;  Чтение с эмулируемых дисков A или B
e99a 2bcc s ;
e99a 2bcc d e5
e99a 2bcc s 	push 	hl
e99b 2bcd d cd21ea
e99b 2bcd s 	CALL	_cpm1_EXR_READINFO
e99e 2bd0 d 3d
e99e 2bd0 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
e99f 2bd1 s ; 	JP	NZ,0xE6ff	;IERR		; 0 - ошибка
e99f 2bd1 s _cpm1__old_getinfo_chkdo:
e99f 2bd1 d c39fe9
e99f 2bd1 s 	JP	$ 		;IERR jnz xxx, CHKDO
e9a2 2bd4 s ; ;
e9a2 2bd4 s _cpm1__old_getinfo:
e9a2 2bd4 d c3a2e9
e9a2 2bd4 s 	jp 	$ 		;GETINFO
e9a5 2bd7 s 
e9a5 2bd7 s 
e9a5 2bd7 s ;==================  Драйвер ExtROM-API ====================================
e9a5 2bd7 s 	
e9a5 2bd7 s 	
e9a5 2bd7 s ;****************************************
e9a5 2bd7 s ;*  Прием байта из порта А по стробу    *
e9a5 2bd7 s ;****************************************
e9a5 2bd7 s _cpm1_EXR_GETBYTE:
e9a5 2bd7 d e5
e9a5 2bd7 s 	PUSH	HL
e9a6 2bd8 d 210afb
e9a6 2bd8 s 	LD	HL,rPORTC
e9a9 2bdb s _cpm1_pWG:
e9a9 2bdb d 7e
e9a9 2bdb s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
e9aa 2bdc d e620
e9aa 2bdc s 	AND	20h		; выделяем сигнал IBF
e9ac 2bde d caa9e9
e9ac 2bde s 	JP	Z,_cpm1_pWG		; IBF=0 - данных еще нет
e9af 2be1 d 3a08fb
e9af 2be1 s 	LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
e9b2 2be4 d e1
e9b2 2be4 s 	POP	HL
e9b3 2be5 d c9
e9b3 2be5 s 	RET
e9b4 2be6 s 
e9b4 2be6 s ;****************************************
e9b4 2be6 s ;*  Отправка байта в порт A             *
e9b4 2be6 s ;****************************************
e9b4 2be6 s _cpm1_EXR_PUTBYTE:
e9b4 2be6 d e5
e9b4 2be6 s 	PUSH	HL
e9b5 2be7 d f5
e9b5 2be7 s 	PUSH	AF
e9b6 2be8 d 210afb
e9b6 2be8 s 	LD	HL,rPORTC
e9b9 2beb s _cpm1_pWP:
e9b9 2beb d 7e
e9b9 2beb s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
e9ba 2bec d e680
e9ba 2bec s 	AND	80h		; выделяем сигнал -OBF
e9bc 2bee d cab9e9
e9bc 2bee s 	JP	Z,_cpm1_pWP		; -OBF=0 - в передатчике сидит незабранный байт
e9bf 2bf1 d f1
e9bf 2bf1 s 	POP	AF
e9c0 2bf2 d 3208fb
e9c0 2bf2 s 	LD	(rPORTA),A		; данные поступили - выбираем их из порта А
e9c3 2bf5 d e1
e9c3 2bf5 s 	POP	HL
e9c4 2bf6 d c9
e9c4 2bf6 s 	RET
e9c5 2bf7 s 
e9c5 2bf7 s ;*******************************************
e9c5 2bf7 s ;*      Прием сектора                      *
e9c5 2bf7 s ;* HL - адрес размещения сектора в памяти  *
e9c5 2bf7 s ;*  Размер сектора - 128 байт              *
e9c5 2bf7 s ;*******************************************
e9c5 2bf7 s _cpm1_EXR_GETSEC:
e9c5 2bf7 d f3
e9c5 2bf7 s 	di
e9c6 2bf8 d c5
e9c6 2bf8 s 	PUSH	BC
e9c7 2bf9 d d5
e9c7 2bf9 s 	PUSH	DE
e9c8 2bfa d 0e80
e9c8 2bfa s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
e9ca 2bfc d eb
e9ca 2bfc s 	EX	DE,HL		; адрес буфера -> DE
e9cb 2bfd d 210afb
e9cb 2bfd s 	LD	HL,rPORTC
e9ce 2c00 s _cpm1_pGSL:
e9ce 2c00 d 7e
e9ce 2c00 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
e9cf 2c01 d e620
e9cf 2c01 s 	AND	20h		; выделяем сигнал IBF
e9d1 2c03 d cacee9
e9d1 2c03 s 	JP	Z,_cpm1_pGSL		; IBF=0 - данных еще нет
e9d4 2c06 d 3a08fb
e9d4 2c06 s 	LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
e9d7 2c09 d 12
e9d7 2c09 s 	LD	(DE),A		; принимаем и размещаем очередной байт
e9d8 2c0a d 13
e9d8 2c0a s 	INC	DE		; указатель буфера ++
e9d9 2c0b d 0d
e9d9 2c0b s 	DEC	C		; принимаем остальные байты
e9da 2c0c d c2cee9
e9da 2c0c s 	JP	NZ,_cpm1_pGSL
e9dd 2c0f d d1
e9dd 2c0f s 	POP	DE
e9de 2c10 d c1
e9de 2c10 s 	POP	BC
e9df 2c11 s ; 	ei - int should be still disabled 
e9df 2c11 d c9
e9df 2c11 s 	RET
e9e0 2c12 s 
e9e0 2c12 s ;*******************************************
e9e0 2c12 s ;*      Передача сектора                   *
e9e0 2c12 s ;* HL - адрес размещения сектора в памяти  *
e9e0 2c12 s ;*  Размер сектора - 128 байт              *
e9e0 2c12 s ;*******************************************
e9e0 2c12 s _cpm1_EXR_PUTSEC:
e9e0 2c12 d f3
e9e0 2c12 s 	di
e9e1 2c13 d c5
e9e1 2c13 s 	PUSH	BC
e9e2 2c14 d d5
e9e2 2c14 s 	PUSH	DE
e9e3 2c15 d 0e80
e9e3 2c15 s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
e9e5 2c17 d eb
e9e5 2c17 s 	EX	DE,HL		; адрес буфера -> DE
e9e6 2c18 d 210afb
e9e6 2c18 s 	LD	HL,rPORTC
e9e9 2c1b s _cpm1_pPSL:
e9e9 2c1b d 7e
e9e9 2c1b s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
e9ea 2c1c d e680
e9ea 2c1c s 	AND	80h		; выделяем сигнал -OBF
e9ec 2c1e d cae9e9
e9ec 2c1e s 	JP	Z,_cpm1_pPSL		; -OBF=0 - в передатчике сидит незабранный байт
e9ef 2c21 d 1a
e9ef 2c21 s 	LD	A,(DE)		; принимаем и размещаем очередной байт
e9f0 2c22 d 3208fb
e9f0 2c22 s 	LD	(rPORTA),A		; данные поступили - выбираем их из порта А
e9f3 2c25 d 13
e9f3 2c25 s 	INC	DE
e9f4 2c26 d 0d
e9f4 2c26 s 	DEC	C		; принимаем остальные байты
e9f5 2c27 d c2e9e9
e9f5 2c27 s 	JP	NZ,_cpm1_pPSL
e9f8 2c2a d d1
e9f8 2c2a s 	POP	DE
e9f9 2c2b d c1
e9f9 2c2b s 	POP	BC
e9fa 2c2c s ; 	ei - int should be still disabled 
e9fa 2c2c d c9
e9fa 2c2c s 	RET
e9fb 2c2d s 
e9fb 2c2d s ;****************************************
e9fb 2c2d s ;*     Отправка командного пакета       *
e9fb 2c2d s ;****************************************
e9fb 2c2d s _cpm1_EXR_SENDCMD:
e9fb 2c2d s 
e9fb 2c2d d f3
e9fb 2c2d s 	di
e9fc 2c2e d e5
e9fc 2c2e s 	PUSH	HL
e9fd 2c2f d c5
e9fd 2c2f s 	PUSH	BC
e9fe 2c30 d 3e0c
e9fe 2c30 s 	LD	A,0Ch
ea00 2c32 d 320bfb
ea00 2c32 s 	LD	(rPCWR),A	; переключаем порт в режим 2
ea03 2c35 d 213fea
ea03 2c35 s 	LD	HL,_cpm1_EXR_CMD
ea06 2c38 d 0e04
ea06 2c38 s 	LD	C,4		; пакет - 4 байта
ea08 2c3a d 0600
ea08 2c3a s 	LD	B,0		; заготовка контрольной суммы
ea0a 2c3c s _cpm1_pSCL:
ea0a 2c3c d 7e
ea0a 2c3c s 	LD	A,(HL)		; очередной байт пакета 
ea0b 2c3d d 80
ea0b 2c3d s 	ADD 	B		; добавляем к КС
ea0c 2c3e d 47
ea0c 2c3e s 	LD	B,A
ea0d 2c3f d 7e
ea0d 2c3f s 	LD	A,(HL)		; очередной байт пакета 
ea0e 2c40 d cdb4e9
ea0e 2c40 s 	CALL	_cpm1_EXR_PUTBYTE		; - в порт
ea11 2c43 d 23
ea11 2c43 s 	INC	HL
ea12 2c44 d 0d
ea12 2c44 s 	DEC	C
ea13 2c45 d c20aea
ea13 2c45 s 	JP	NZ,_cpm1_pSCL
ea16 2c48 d 78
ea16 2c48 s 	LD	A,B
ea17 2c49 d 3d
ea17 2c49 s 	DEC 	A		; КС-1
ea18 2c4a d cdb4e9
ea18 2c4a s 	CALL	_cpm1_EXR_PUTBYTE     ; контрольная сумма
ea1b 2c4d d cda5e9
ea1b 2c4d s 	CALL	_cpm1_EXR_GETBYTE	; ответ контроллера
ea1e 2c50 d c1
ea1e 2c50 s 	POP	BC
ea1f 2c51 d e1
ea1f 2c51 s 	POP	HL
ea20 2c52 s ; 	ei - int should be still disabled 
ea20 2c52 d c9
ea20 2c52 s 	RET
ea21 2c53 s 
ea21 2c53 s ;*******************************************
ea21 2c53 s ;*  Чтение информационного сектора
ea21 2c53 s ;*******************************************
ea21 2c53 s _cpm1_EXR_READINFO:
ea21 2c53 d 213fea
ea21 2c53 s 	LD	HL,_cpm1_EXR_CMD	; командный пакет
ea24 2c56 d 3601
ea24 2c56 s 	LD	(HL),1		; команда чтения
ea26 2c58 d 23
ea26 2c58 s 	INC	HL
ea27 2c59 s _cpm1_r_p_DSK3:
ea27 2c59 d 3affff
ea27 2c59 s 	LD	A,(_DSK)	; вписываем # устройства
ea2a 2c5c d 77
ea2a 2c5c s 	LD	(HL),A
ea2b 2c5d d 23
ea2b 2c5d s 	INC	HL
ea2c 2c5e d 3600
ea2c 2c5e s 	LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
ea2e 2c60 d 23
ea2e 2c60 s 	INC	HL
ea2f 2c61 d 3600
ea2f 2c61 s 	LD	(HL),0		
ea31 2c63 d cdfbe9
ea31 2c63 s 	CALL	_cpm1_EXR_SENDCMD	; отправляем команду
ea34 2c66 d b7
ea34 2c66 s 	OR	A
ea35 2c67 d c8
ea35 2c67 s 	RET 	Z		; ошибка
ea36 2c68 d 2100ee
ea36 2c68 s 	LD	HL,_RRBUFF	; принимаем данные
ea39 2c6b d cdc5e9
ea39 2c6b s 	CALL	_cpm1_EXR_GETSEC
ea3c 2c6e d 3e01
ea3c 2c6e s 	LD	A,1
ea3e 2c70 d c9
ea3e 2c70 s 	RET
ea3f 2c71 s 
ea3f 2c71 s 
ea3f 2c71 s ; Командный пакет интерфейса Extrom-API
ea3f 2c71 s ;===============================================
ea3f 2c71 d 00
ea3f 2c71 s _cpm1_EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
ea40 2c72 d 00
ea40 2c72 s _cpm1_EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
ea41 2c73 d 00
ea41 2c73 s _cpm1_EXR_TRK:	DB	0	; логическая дорожка
ea42 2c74 d 00
ea42 2c74 s _cpm1_EXR_SEC:	DB	0	; логический сектор (128b)
ea43 2c75 s 
ea43 2c75 s 	endm
ea43 2c75 s 
2c75 2c75 s 	.dephase
2c75 2c75 s 
2c75 2c75 s resident_cpm1_len 		equ	$-resident_cpm1
2c75 2c75 s 
2c75 2c75 s ; minimum hole_start .. min hole_end
2c75 2c75 s max_resident_cpm1_len 	equ 	0xEBA6-0xE8AC ;=762
2c75 2c75 s 
2c75 2c75 s available_resident_cpm1_len	equ 	max_resident_cpm1_len-resident_cpm1_len
2c75 2c75 s 
2c75 2c75 s 	.assert max_resident_cpm1_len>=resident_cpm1_len
2c75 2c75 f generator/V0/extrom-patcher.asm
2c75 2c75 s 	include 	"extrom-patcher-resident-cpm2.asm"
2c75 2c75 f extrom-patcher-resident-cpm2.asm
2c75 2c75 s 	;    12_87_11_niijaf
2c75 2c75 s 	;  EA06-EDFD = 1015  
2c75 2c75 s 	;
2c75 2c75 s 	
2c75 2c75 s resident_cpm2	equ $
2c75 2c75 s 
ea06 2c75 s 	.phase 0xea06
ea06 2c75 s 
ea06 2c75 s resident_cpm2_addr 	EQU 	$
ea06 2c75 s 
ea06 2c75 s 	cpm_resident_body _cpm2_
ea06 2c75 s 
ea06 2c75 s ;keyhook support removed 2014-10-22
ea06 2c75 s ;больше нет нужды в ней, т.к. есть диск F
ea06 2c75 s ; preffix&kbd_hook_noCtrl_03;
ea06 2c75 s ; 	ld 	(preffix&save_a),a
ea06 2c75 s ; 	cp 	0x03
ea06 2c75 s ; 	jp 	preffix&kbd_hook_noCtrl_chk
ea06 2c75 s 
ea06 2c75 s ; preffix&kbd_hook_noCtrl_33:
ea06 2c75 s ; 	ld 	(preffix&save_a),a
ea06 2c75 s ; 	cp 	0x33
ea06 2c75 s 
ea06 2c75 s ; preffix&kbd_hook_noCtrl_chk:
ea06 2c75 s ; 	jp 	nz,preffix&bios_hook
ea06 2c75 s 
ea06 2c75 s ; 	ld 	a,(0xf880)
ea06 2c75 s ; 	and 	00100001b
ea06 2c75 s ; 	cp 	00100001b
ea06 2c75 s 
ea06 2c75 s ; 	jp 	nz,preffix&bios_hook
ea06 2c75 s 
ea06 2c75 s ; 	jp 	preffix&do_key_action
ea06 2c75 s 
ea06 2c75 s ; preffix&kbd_hook_2133:
ea06 2c75 s ; 	ld 	(preffix&save_a),a
ea06 2c75 s ; 	ld 	a,c
ea06 2c75 s ; 	cp 	0x33 	;stop
ea06 2c75 s ; 	jp 	nz,preffix&bios_hook
ea06 2c75 s 
ea06 2c75 s ; 	ld 	a,b
ea06 2c75 s ; 	cp 	0x21 	;ctrl+stop
ea06 2c75 s ; 	jp 	nz,preffix&bios_hook
ea06 2c75 s 
ea06 2c75 s ; preffix&do_key_action:
ea06 2c75 s ; 	push 	hl
ea06 2c75 s ; 	push 	de
ea06 2c75 s ; 	push 	bc
ea06 2c75 s ; 	ld 	hl,preffix&msg_hook
ea06 2c75 s ; 	ld 	de,0xfc00
ea06 2c75 s ; preffix&.kmlp:	
ea06 2c75 s ; 	ld 	a,(hl)
ea06 2c75 s ; 	or 	a
ea06 2c75 s ; 	jp 	z,preffix&.kmlp_ext
ea06 2c75 s ; 	ld 	(de),a
ea06 2c75 s ; 	inc 	hl
ea06 2c75 s ; 	inc 	de
ea06 2c75 s ; 	jp 	preffix&.kmlp
ea06 2c75 s 
ea06 2c75 s ; preffix&.kmlp_ext:
ea06 2c75 s ; 	pop 	bc
ea06 2c75 s ; 	pop 	de
ea06 2c75 s ; 	pop 	hl
ea06 2c75 s 
ea06 2c75 s ; 	ld 	bc,0 	;simulate no key
ea06 2c75 s ; 	ld 	a,0
ea06 2c75 s ; 	jp 	preffix&old_hook
ea06 2c75 s ; ; 	halt
ea06 2c75 s 
ea06 2c75 s 
ea06 2c75 s ; preffix&bios_hook:
ea06 2c75 s ; 	ld 	a,(preffix&save_a)
ea06 2c75 s 
ea06 2c75 s ; preffix&old_hook:
ea06 2c75 s ; 	jp 	$
ea06 2c75 s ; preffix&save_a:
ea06 2c75 s ; 	db 	0	
ea06 2c75 s ; preffix&msg_hook:
ea06 2c75 s ; 	db 	'CTRL+SHIFT+STOP pressed',0
ea06 2c75 s 
ea06 2c75 s ;ptrs to drive drvreg bytes 
ea06 2c75 s _cpm2_res_DRIVE_TAB:
ea06 2c75 d 0000
ea06 2c75 s 	dw 	0 	;A
ea08 2c77 d 0000
ea08 2c77 s 	dw 	0 	;B
ea0a 2c79 d 0000
ea0a 2c79 s 	dw 	0 	;C
ea0c 2c7b d 0000
ea0c 2c7b s 	dw 	0 	;D
ea0e 2c7d d 0000
ea0e 2c7d s 	dw 	0 	;E
ea10 2c7f d 0000
ea10 2c7f s 	dw 	0 	;F
ea12 2c81 s 
ea12 2c81 s 
ea12 2c81 s _cpm2_dph_F:
ea12 2c81 d 0000
ea12 2c81 s 	dw	0	;_XLT:           
ea14 2c83 d 0000
ea14 2c83 s 	dw	0	;_1:             
ea16 2c85 d 0000
ea16 2c85 s 	dw	0	;_2:             
ea18 2c87 d 0000
ea18 2c87 s 	dw	0	;_3:             
ea1a 2c89 d 00fc
ea1a 2c89 s 	dw	0xFC00	;DirBuf: value store here via patcher 0xfc00 - debug
ea1c 2c8b d 2aea
ea1c 2c8b s 	dw	_cpm2_dpb_F	;DPB:   
ea1e 2c8d d 0000
ea1e 2c8d s 	dw	0	;CSV: - fixed drive   
ea20 2c8f d 39ea
ea20 2c8f s 	dw	_cpm2_alw_F	;ALV:   
ea22 2c91 s 
ea22 2c91 s 
ea22 2c91 s ;  ФИЗИЧЕСКИЕ ПАРАМЕТРЫ ДИСКА
ea22 2c91 s ;--------------------------------------
ea22 2c91 d 50
ea22 2c91 s       DB 50H	;контрольная сумма
ea23 2c92 s 
ea23 2c92 d 80
ea23 2c92 s       DB 080H ;константа скорости движения головки.
ea24 2c93 s ;	; 3 - 30 мс на шаг, 2 - 20 мс, 1 - 12 мс,
ea24 2c93 s ;	; 0 - 6 мс и 80H - 3 мс.
ea24 2c93 d 05
ea24 2c93 s       DB 05H  ; число физических секторов на дорожке
ea25 2c94 d 01
ea25 2c94 s       DB 01H  ; информация о сторонах диска
ea26 2c95 s ;	;( 00 - односторонный диск
ea26 2c95 s ;	;  01 - двухсторонний диск
ea26 2c95 d 03
ea26 2c95 s       DB 03	; 512 bytes/sector
ea27 2c96 s ;	;( 00 - 128 байт/сектор
ea27 2c96 s ;	;  01 - 256 байт/сектор
ea27 2c96 s ;	;  02 - 512 байт/сектор
ea27 2c96 s ;	;  03 - 1024 байт/сектор
ea27 2c96 d 00
ea27 2c96 s       DB 0	; номер текущей дорожки.
ea28 2c97 d 00
ea28 2c97 s       DB 0	; позиционный номер устройства (00000100) - для записи в регистр выбора
ea29 2c98 s ;---------------------------------------------------
ea29 2c98 d 00
ea29 2c98 s       DB 0	;INFO	; флаг успешного считывания
ea2a 2c99 s 
ea2a 2c99 s _cpm2_dpb_F:
ea2a 2c99 s ; kdi params
ea2a 2c99 d 2800
ea2a 2c99 s       DW 40	;128 байтовых секторов/трек ; SPT
ea2c 2c9b d 04
ea2c 2c9b s       DB 4	; размер блока миним.кбайт  ; BSH
ea2d 2c9c s ;	; фактор сдвига блока распределения данных
ea2d 2c9c s ;	; определяется размером блока данных. Блок 
ea2d 2c9c s ;	; данных - минимально возможная частица файла.
ea2d 2c9c s ;	; Размер блока - 1, 2, 4, 8 или 16 Кбайт. Если
ea2d 2c9c s ;	; блок имеет большой размер, в каждом файле 
ea2d 2c9c s ;	; теряется значительное число неиспользуемых
ea2d 2c9c s ;	; секторов. При уменьшении размера блока
ea2d 2c9c s ;	; увеличивается размер директории, описывающий
ea2d 2c9c s ;	; расположение частей файла. BSH = log2[число
ea2d 2c9c s ;	; логических секторов в блоке].
ea2d 2c9c d 0f
ea2d 2c9c s       DB 15	; число логических сек/блок  ; BLM
ea2e 2c9d s ;	; маска блока распределения данных.
ea2e 2c9d s ;	; BLM = (число логических секторов в блоке)-1.
ea2e 2c9d d 00
ea2e 2c9d s       DB 0	; extent mask                ; EXM
ea2f 2c9e s ;	; = (BLM+1)*128/1024 - 1 - [DSM/256]. EXM - 
ea2f 2c9e s ;	; вспомогательная величина для определения
ea2f 2c9e s ;	; номера extent'а.
ea2f 2c9e s ;	; extent - часть файла, описываемая одним 
ea2f 2c9e s ;	; входом в директорию.
ea2f 2c9e d 8a01
ea2f 2c9e s       DW 394	; обьем диска в блоках-1     ; DSM
ea31 2ca0 d 7f00
ea31 2ca0 s       DW 127	; входов в директорий-1      ; DRM
ea33 2ca2 d c0
ea33 2ca2 s       DB 192	; определяет, какие блоки    ; AL0
ea34 2ca3 s ;	; зарезервированы
ea34 2ca3 d 00
ea34 2ca3 s       DB 0	; alloc 1                    ; AL1
ea35 2ca4 s ;	; под директорию. Каждый  бит AL0,AL1, 
ea35 2ca4 s ;	; начиная со старшего бита AL0 и кончая 
ea35 2ca4 s ;	; младшим битом AL1, значением 1 резервирует
ea35 2ca4 s ;	; один блок данных для директории. Нужно
ea35 2ca4 s ;	; резервировать необходимое число блоков
ea35 2ca4 s ;	; для хранения входов в директорию: 32*DRM/BLS
ea35 2ca4 d 0000
ea35 2ca4 s       DW 0	; размер вектора контроля директории. ; CKS
ea37 2ca6 s ;	; CKS=(DRM+1)/4. Если диск не сменяем, CKS=0.
ea37 2ca6 d 0200
ea37 2ca6 s       DW 2	; число системных дорожек    ; OFS
ea39 2ca8 s 
ea39 2ca8 s 
ea39 2ca8 s ; preffix&alw_F: 	ds 	50
ea39 2ca8 s _cpm2_alw_F: 	ds 	50
ea39 2ca8 d 00000000000000000000000000000000
ea49 2cb8 d 00000000000000000000000000000000
ea59 2cc8 d 00000000000000000000000000000000
ea69 2cd8 d 0000
ea6b 2cda s 
ea6b 2cda s 
ea6b 2cda s _cpm2_res_seldsk:
ea6b 2cda d 79
ea6b 2cda s 	ld 	a,c
ea6c 2cdb d fefe
ea6c 2cdb s 	cp 	0xfe
ea6e 2cdd s _cpm2_old_seld_dsk:
ea6e 2cdd d c26eea
ea6e 2cdd s 	jp 	nz,$	
ea71 2ce0 d 2106ea
ea71 2ce0 s 	ld 	hl,_cpm2_res_DRIVE_TAB
ea74 2ce3 d c9
ea74 2ce3 s 	ret
ea75 2ce4 s 
ea75 2ce4 s 
ea75 2ce4 s ;RAM:DA27 C3 EB DC                 jp      j_READ
ea75 2ce4 s 
ea75 2ce4 s ;RAM:DCEB          j_READ:                                 ; CODE XREF: RAM:_READj
ea75 2ce4 s ;RAM:DCEB                                                  ; RAM:DB84p
ea75 2ce4 s ;RAM:DCEB
ea75 2ce4 s ;RAM:DCEB          ; FUNCTION CHUNK AT RAM:DDC4 SIZE 0000007B BYTES
ea75 2ce4 s ;RAM:DCEB
ea75 2ce4 s ;RAM:DCEB 3E 04                    ld      a, 4
ea75 2ce4 s ;RAM:DCED 32 66 E0                 ld      (_OPERATION), a
ea75 2ce4 s ;RAM:DCF0 3A 64 E0                 ld      a, (_DSK)
ea75 2ce4 s ;RAM:DCF3 FE 04                    cp      4
ea75 2ce4 s ;RAM:DCF5 CA C4 DD                 jp      z, loc_DDC4
ea75 2ce4 s 
ea75 2ce4 s ;сюда попадает из биоса JP READ
ea75 2ce4 s ;а если не наше то прыгаем на старый read
ea75 2ce4 s _cpm2_res_READ:
ea75 2ce4 s ; 	ld	 A,4	;Режим чтения
ea75 2ce4 s ; 	ld  	(_OPER),a
ea75 2ce4 s _cpm2_r_p_DSK1:
ea75 2ce4 d 3affff
ea75 2ce4 s 	ld 	a,(_DSK) 	;_DSK
ea78 2ce7 d fe04
ea78 2ce7 s 	cp 	4
ea7a 2ce9 d caafea
ea7a 2ce9 s 	jp 	z,_cpm2__old_read
ea7d 2cec s 
ea7d 2cec d fe05
ea7d 2cec s 	cp 	5 		;disk F mapped to EMU drive E
ea7f 2cee d c283ea
ea7f 2cee s 	jp 	nz,_cpm2_.r_no_drv_dec
ea82 2cf1 d 3d
ea82 2cf1 s 	dec 	a
ea83 2cf2 s 
ea83 2cf2 s _cpm2_.r_no_drv_dec:
ea83 2cf2 d 329aeb
ea83 2cf2 s 	LD	(_cpm2_EXR_DRV),A	; # устройства
ea86 2cf5 s 
ea86 2cf5 d e5
ea86 2cf5 s 	push 	hl
ea87 2cf6 s _cpm2_r_p_SELDSKDRIVER:
ea87 2cf6 d 2a0000
ea87 2cf6 s 	ld 	hl,(0)	;EXR_SELDSK_DRIVE
ea8a 2cf9 d 7e
ea8a 2cf9 s 	ld 	a,(hl)
ea8b 2cfa d e1
ea8b 2cfa s 	pop 	hl
ea8c 2cfb d b7
ea8c 2cfb s 	or 	a
ea8d 2cfc d c2afea
ea8d 2cfc s 	jp 	nz,_cpm2__old_read
ea90 2cff s 
ea90 2cff s _cpm2_r_p_TRK1:
ea90 2cff d 3affff
ea90 2cff s 	LD	A,(_TRK)	
ea93 2d02 d 329beb
ea93 2d02 s 	LD	(_cpm2_EXR_TRK),A	; дорожка
ea96 2d05 s _cpm2_r_p_SEC1:
ea96 2d05 d 3affff
ea96 2d05 s 	LD	A,(_SEC)	; сектор
ea99 2d08 d 3d
ea99 2d08 s 	DEC	A		; у нас номер сектора начинается с 0
ea9a 2d09 d 329ceb
ea9a 2d09 s 	LD	(_cpm2_EXR_SEC),A
ea9d 2d0c s 
ea9d 2d0c d 3e01
ea9d 2d0c s 	LD	A,1
ea9f 2d0e d 3299eb
ea9f 2d0e s 	LD	(_cpm2_EXR_CMD),A	; 1 - команда чтения
eaa2 2d11 s 
eaa2 2d11 d cd55eb
eaa2 2d11 s 	CALL	_cpm2_EXR_SENDCMD	; отсылаем команду
eaa5 2d14 d 3d
eaa5 2d14 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
eaa6 2d15 d c0
eaa6 2d15 s 	RET	NZ		; 0 - ошибка
eaa7 2d16 s _cpm2_r_p_DMA1:
eaa7 2d16 d 2affff
eaa7 2d16 s 	LD	HL,(_DMA)	; адрес буфера для приема данных
eaaa 2d19 d cd1feb
eaaa 2d19 s 	CALL	_cpm2_EXR_GETSEC	; принимаем данные
eaad 2d1c d af
eaad 2d1c s 	XOR	A		; завершение всегда успешно
eaae 2d1d d c9
eaae 2d1d s 	RET
eaaf 2d1e s ;
eaaf 2d1e s 
eaaf 2d1e s _cpm2__old_read:
eaaf 2d1e d c3afea
eaaf 2d1e s 	jp 	$
eab2 2d21 s 
eab2 2d21 s _cpm2_res_WRITE:
eab2 2d21 s ; 	ld	 A,6	;Режим чтения
eab2 2d21 s ; 	ld  	(_OPER),a
eab2 2d21 s 
eab2 2d21 s _cpm2_r_p_DSK2:
eab2 2d21 d 3affff
eab2 2d21 s 	ld 	a,(_DSK) 	;_DSK
eab5 2d24 d fe04
eab5 2d24 s 	cp 	4
eab7 2d26 d caecea
eab7 2d26 s 	jp 	z,_cpm2__old_write
eaba 2d29 d fe05
eaba 2d29 s 	cp 	5 		;disk F mapped to EMU drive E
eabc 2d2b d c2c0ea
eabc 2d2b s 	jp 	nz,_cpm2_.w_no_drv_dec
eabf 2d2e d 3d
eabf 2d2e s 	dec 	a
eac0 2d2f s _cpm2_.w_no_drv_dec:
eac0 2d2f d 329aeb
eac0 2d2f s 	LD	(_cpm2_EXR_DRV),A
eac3 2d32 s 
eac3 2d32 s 
eac3 2d32 d e5
eac3 2d32 s 	push 	hl
eac4 2d33 s _cpm2_r_p_SELDSKDRIVEW:
eac4 2d33 d 2a0000
eac4 2d33 s 	ld 	hl,(0)	;EXR_SELDSK_DRIVE
eac7 2d36 d 7e
eac7 2d36 s 	ld 	a,(hl)
eac8 2d37 d e1
eac8 2d37 s 	pop 	hl
eac9 2d38 d b7
eac9 2d38 s 	or 	a
eaca 2d39 d c2ecea
eaca 2d39 s 	jp 	nz,_cpm2__old_write
eacd 2d3c s 
eacd 2d3c s _cpm2_r_p_TRK2:
eacd 2d3c d 3affff
eacd 2d3c s 	LD	A,(_TRK)
ead0 2d3f d 329beb
ead0 2d3f s 	LD	(_cpm2_EXR_TRK),A
ead3 2d42 s _cpm2_r_p_SEC2:
ead3 2d42 d 3affff
ead3 2d42 s 	LD	A,(_SEC)
ead6 2d45 d 3d
ead6 2d45 s 	DEC	A
ead7 2d46 d 329ceb
ead7 2d46 s 	LD	(_cpm2_EXR_SEC),A
eada 2d49 s 
eada 2d49 d 3e02
eada 2d49 s 	LD	A,2		; 2 - команда записи
eadc 2d4b d 3299eb
eadc 2d4b s 	LD	(_cpm2_EXR_CMD),A
eadf 2d4e s 
eadf 2d4e d cd55eb
eadf 2d4e s 	CALL	_cpm2_EXR_SENDCMD
eae2 2d51 d 3d
eae2 2d51 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
eae3 2d52 d c0
eae3 2d52 s 	RET	NZ		; 0 - ошибка
eae4 2d53 s _cpm2_r_p_DMA2:
eae4 2d53 d 2affff
eae4 2d53 s 	LD	HL,(_DMA)
eae7 2d56 d cd3aeb
eae7 2d56 s 	CALL	_cpm2_EXR_PUTSEC
eaea 2d59 d af
eaea 2d59 s 	XOR	A		; запись успешна
eaeb 2d5a d c9
eaeb 2d5a s 	RET
eaec 2d5b s 
eaec 2d5b s _cpm2__old_write:
eaec 2d5b d c3ecea
eaec 2d5b s 	jp 	$
eaef 2d5e s 
eaef 2d5e s 
eaef 2d5e s _cpm2_res_GETINFO:
eaef 2d5e s 
eaef 2d5e d 7e
eaef 2d5e s 	LD 	A,(HL)	; A= маска выбора привода
eaf0 2d5f d b7
eaf0 2d5f s 	or 	a
eaf1 2d60 d c2fcea
eaf1 2d60 s 	jp 	nz,_cpm2__old_getinfo 	;=0 if emulated
eaf4 2d63 s 
eaf4 2d63 s ;
eaf4 2d63 s ;  Чтение с эмулируемых дисков A или B
eaf4 2d63 s ;
eaf4 2d63 d e5
eaf4 2d63 s 	push 	hl
eaf5 2d64 d cd7beb
eaf5 2d64 s 	CALL	_cpm2_EXR_READINFO
eaf8 2d67 d 3d
eaf8 2d67 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
eaf9 2d68 s ; 	JP	NZ,0xE6ff	;IERR		; 0 - ошибка
eaf9 2d68 s _cpm2__old_getinfo_chkdo:
eaf9 2d68 d c3f9ea
eaf9 2d68 s 	JP	$ 		;IERR jnz xxx, CHKDO
eafc 2d6b s ; ;
eafc 2d6b s _cpm2__old_getinfo:
eafc 2d6b d c3fcea
eafc 2d6b s 	jp 	$ 		;GETINFO
eaff 2d6e s 
eaff 2d6e s 
eaff 2d6e s ;==================  Драйвер ExtROM-API ====================================
eaff 2d6e s 	
eaff 2d6e s 	
eaff 2d6e s ;****************************************
eaff 2d6e s ;*  Прием байта из порта А по стробу    *
eaff 2d6e s ;****************************************
eaff 2d6e s _cpm2_EXR_GETBYTE:
eaff 2d6e d e5
eaff 2d6e s 	PUSH	HL
eb00 2d6f d 210afb
eb00 2d6f s 	LD	HL,rPORTC
eb03 2d72 s _cpm2_pWG:
eb03 2d72 d 7e
eb03 2d72 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
eb04 2d73 d e620
eb04 2d73 s 	AND	20h		; выделяем сигнал IBF
eb06 2d75 d ca03eb
eb06 2d75 s 	JP	Z,_cpm2_pWG		; IBF=0 - данных еще нет
eb09 2d78 d 3a08fb
eb09 2d78 s 	LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
eb0c 2d7b d e1
eb0c 2d7b s 	POP	HL
eb0d 2d7c d c9
eb0d 2d7c s 	RET
eb0e 2d7d s 
eb0e 2d7d s ;****************************************
eb0e 2d7d s ;*  Отправка байта в порт A             *
eb0e 2d7d s ;****************************************
eb0e 2d7d s _cpm2_EXR_PUTBYTE:
eb0e 2d7d d e5
eb0e 2d7d s 	PUSH	HL
eb0f 2d7e d f5
eb0f 2d7e s 	PUSH	AF
eb10 2d7f d 210afb
eb10 2d7f s 	LD	HL,rPORTC
eb13 2d82 s _cpm2_pWP:
eb13 2d82 d 7e
eb13 2d82 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
eb14 2d83 d e680
eb14 2d83 s 	AND	80h		; выделяем сигнал -OBF
eb16 2d85 d ca13eb
eb16 2d85 s 	JP	Z,_cpm2_pWP		; -OBF=0 - в передатчике сидит незабранный байт
eb19 2d88 d f1
eb19 2d88 s 	POP	AF
eb1a 2d89 d 3208fb
eb1a 2d89 s 	LD	(rPORTA),A		; данные поступили - выбираем их из порта А
eb1d 2d8c d e1
eb1d 2d8c s 	POP	HL
eb1e 2d8d d c9
eb1e 2d8d s 	RET
eb1f 2d8e s 
eb1f 2d8e s ;*******************************************
eb1f 2d8e s ;*      Прием сектора                      *
eb1f 2d8e s ;* HL - адрес размещения сектора в памяти  *
eb1f 2d8e s ;*  Размер сектора - 128 байт              *
eb1f 2d8e s ;*******************************************
eb1f 2d8e s _cpm2_EXR_GETSEC:
eb1f 2d8e d f3
eb1f 2d8e s 	di
eb20 2d8f d c5
eb20 2d8f s 	PUSH	BC
eb21 2d90 d d5
eb21 2d90 s 	PUSH	DE
eb22 2d91 d 0e80
eb22 2d91 s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
eb24 2d93 d eb
eb24 2d93 s 	EX	DE,HL		; адрес буфера -> DE
eb25 2d94 d 210afb
eb25 2d94 s 	LD	HL,rPORTC
eb28 2d97 s _cpm2_pGSL:
eb28 2d97 d 7e
eb28 2d97 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
eb29 2d98 d e620
eb29 2d98 s 	AND	20h		; выделяем сигнал IBF
eb2b 2d9a d ca28eb
eb2b 2d9a s 	JP	Z,_cpm2_pGSL		; IBF=0 - данных еще нет
eb2e 2d9d d 3a08fb
eb2e 2d9d s 	LD	A,(rPORTA)		; данные поступили - выбираем их из порта А
eb31 2da0 d 12
eb31 2da0 s 	LD	(DE),A		; принимаем и размещаем очередной байт
eb32 2da1 d 13
eb32 2da1 s 	INC	DE		; указатель буфера ++
eb33 2da2 d 0d
eb33 2da2 s 	DEC	C		; принимаем остальные байты
eb34 2da3 d c228eb
eb34 2da3 s 	JP	NZ,_cpm2_pGSL
eb37 2da6 d d1
eb37 2da6 s 	POP	DE
eb38 2da7 d c1
eb38 2da7 s 	POP	BC
eb39 2da8 s ; 	ei - int should be still disabled 
eb39 2da8 d c9
eb39 2da8 s 	RET
eb3a 2da9 s 
eb3a 2da9 s ;*******************************************
eb3a 2da9 s ;*      Передача сектора                   *
eb3a 2da9 s ;* HL - адрес размещения сектора в памяти  *
eb3a 2da9 s ;*  Размер сектора - 128 байт              *
eb3a 2da9 s ;*******************************************
eb3a 2da9 s _cpm2_EXR_PUTSEC:
eb3a 2da9 d f3
eb3a 2da9 s 	di
eb3b 2daa d c5
eb3b 2daa s 	PUSH	BC
eb3c 2dab d d5
eb3c 2dab s 	PUSH	DE
eb3d 2dac d 0e80
eb3d 2dac s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
eb3f 2dae d eb
eb3f 2dae s 	EX	DE,HL		; адрес буфера -> DE
eb40 2daf d 210afb
eb40 2daf s 	LD	HL,rPORTC
eb43 2db2 s _cpm2_pPSL:
eb43 2db2 d 7e
eb43 2db2 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
eb44 2db3 d e680
eb44 2db3 s 	AND	80h		; выделяем сигнал -OBF
eb46 2db5 d ca43eb
eb46 2db5 s 	JP	Z,_cpm2_pPSL		; -OBF=0 - в передатчике сидит незабранный байт
eb49 2db8 d 1a
eb49 2db8 s 	LD	A,(DE)		; принимаем и размещаем очередной байт
eb4a 2db9 d 3208fb
eb4a 2db9 s 	LD	(rPORTA),A		; данные поступили - выбираем их из порта А
eb4d 2dbc d 13
eb4d 2dbc s 	INC	DE
eb4e 2dbd d 0d
eb4e 2dbd s 	DEC	C		; принимаем остальные байты
eb4f 2dbe d c243eb
eb4f 2dbe s 	JP	NZ,_cpm2_pPSL
eb52 2dc1 d d1
eb52 2dc1 s 	POP	DE
eb53 2dc2 d c1
eb53 2dc2 s 	POP	BC
eb54 2dc3 s ; 	ei - int should be still disabled 
eb54 2dc3 d c9
eb54 2dc3 s 	RET
eb55 2dc4 s 
eb55 2dc4 s ;****************************************
eb55 2dc4 s ;*     Отправка командного пакета       *
eb55 2dc4 s ;****************************************
eb55 2dc4 s _cpm2_EXR_SENDCMD:
eb55 2dc4 s 
eb55 2dc4 d f3
eb55 2dc4 s 	di
eb56 2dc5 d e5
eb56 2dc5 s 	PUSH	HL
eb57 2dc6 d c5
eb57 2dc6 s 	PUSH	BC
eb58 2dc7 d 3e0c
eb58 2dc7 s 	LD	A,0Ch
eb5a 2dc9 d 320bfb
eb5a 2dc9 s 	LD	(rPCWR),A	; переключаем порт в режим 2
eb5d 2dcc d 2199eb
eb5d 2dcc s 	LD	HL,_cpm2_EXR_CMD
eb60 2dcf d 0e04
eb60 2dcf s 	LD	C,4		; пакет - 4 байта
eb62 2dd1 d 0600
eb62 2dd1 s 	LD	B,0		; заготовка контрольной суммы
eb64 2dd3 s _cpm2_pSCL:
eb64 2dd3 d 7e
eb64 2dd3 s 	LD	A,(HL)		; очередной байт пакета 
eb65 2dd4 d 80
eb65 2dd4 s 	ADD 	B		; добавляем к КС
eb66 2dd5 d 47
eb66 2dd5 s 	LD	B,A
eb67 2dd6 d 7e
eb67 2dd6 s 	LD	A,(HL)		; очередной байт пакета 
eb68 2dd7 d cd0eeb
eb68 2dd7 s 	CALL	_cpm2_EXR_PUTBYTE		; - в порт
eb6b 2dda d 23
eb6b 2dda s 	INC	HL
eb6c 2ddb d 0d
eb6c 2ddb s 	DEC	C
eb6d 2ddc d c264eb
eb6d 2ddc s 	JP	NZ,_cpm2_pSCL
eb70 2ddf d 78
eb70 2ddf s 	LD	A,B
eb71 2de0 d 3d
eb71 2de0 s 	DEC 	A		; КС-1
eb72 2de1 d cd0eeb
eb72 2de1 s 	CALL	_cpm2_EXR_PUTBYTE     ; контрольная сумма
eb75 2de4 d cdffea
eb75 2de4 s 	CALL	_cpm2_EXR_GETBYTE	; ответ контроллера
eb78 2de7 d c1
eb78 2de7 s 	POP	BC
eb79 2de8 d e1
eb79 2de8 s 	POP	HL
eb7a 2de9 s ; 	ei - int should be still disabled 
eb7a 2de9 d c9
eb7a 2de9 s 	RET
eb7b 2dea s 
eb7b 2dea s ;*******************************************
eb7b 2dea s ;*  Чтение информационного сектора
eb7b 2dea s ;*******************************************
eb7b 2dea s _cpm2_EXR_READINFO:
eb7b 2dea d 2199eb
eb7b 2dea s 	LD	HL,_cpm2_EXR_CMD	; командный пакет
eb7e 2ded d 3601
eb7e 2ded s 	LD	(HL),1		; команда чтения
eb80 2def d 23
eb80 2def s 	INC	HL
eb81 2df0 s _cpm2_r_p_DSK3:
eb81 2df0 d 3affff
eb81 2df0 s 	LD	A,(_DSK)	; вписываем # устройства
eb84 2df3 d 77
eb84 2df3 s 	LD	(HL),A
eb85 2df4 d 23
eb85 2df4 s 	INC	HL
eb86 2df5 d 3600
eb86 2df5 s 	LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
eb88 2df7 d 23
eb88 2df7 s 	INC	HL
eb89 2df8 d 3600
eb89 2df8 s 	LD	(HL),0		
eb8b 2dfa d cd55eb
eb8b 2dfa s 	CALL	_cpm2_EXR_SENDCMD	; отправляем команду
eb8e 2dfd d b7
eb8e 2dfd s 	OR	A
eb8f 2dfe d c8
eb8f 2dfe s 	RET 	Z		; ошибка
eb90 2dff d 2100ee
eb90 2dff s 	LD	HL,_RRBUFF	; принимаем данные
eb93 2e02 d cd1feb
eb93 2e02 s 	CALL	_cpm2_EXR_GETSEC
eb96 2e05 d 3e01
eb96 2e05 s 	LD	A,1
eb98 2e07 d c9
eb98 2e07 s 	RET
eb99 2e08 s 
eb99 2e08 s 
eb99 2e08 s ; Командный пакет интерфейса Extrom-API
eb99 2e08 s ;===============================================
eb99 2e08 d 00
eb99 2e08 s _cpm2_EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
eb9a 2e09 d 00
eb9a 2e09 s _cpm2_EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
eb9b 2e0a d 00
eb9b 2e0a s _cpm2_EXR_TRK:	DB	0	; логическая дорожка
eb9c 2e0b d 00
eb9c 2e0b s _cpm2_EXR_SEC:	DB	0	; логический сектор (128b)
eb9d 2e0c s 
eb9d 2e0c s 	endm
eb9d 2e0c s 
2e0c 2e0c s 	.dephase
2e0c 2e0c s 
2e0c 2e0c s resident_cpm2_len 		equ	$-resident_cpm2
2e0c 2e0c s 
2e0c 2e0c s ; minimum hole_start .. min hole_end
2e0c 2e0c s max_resident_cpm2_len 	equ 	0xEDFD-0xEA06 ;=1015
2e0c 2e0c s 
2e0c 2e0c s available_resident_cpm2_len	equ 	max_resident_cpm2_len-resident_cpm2_len
2e0c 2e0c s 
2e0c 2e0c s 	.assert max_resident_cpm2_len>=resident_cpm2_len
2e0c 2e0c f generator/V0/extrom-patcher.asm
2e0c 2e0c s 	include 	"extrom-patcher-resident-microdos.asm"
2e0c 2e0c f extrom-patcher-resident-microdos.asm
2e0c 2e0c s MD_rPORTA	EQU	0FE08H		; Порт Канала A интерфейса расширения
2e0c 2e0c s MD_rPORTC	EQU	0FE0AH		; Порт Канала С интерфейса расширения
2e0c 2e0c s MD_rPCWR	EQU	0FE0BH		; Порт управляющих команд
2e0c 2e0c s 
2e0c 2e0c s MD_RRBUFF 	EQU 	0
2e0c 2e0c s 
2e0c 2e0c s resident_md:
2e0c 2e0c s 
2e0c 2e0c s ; 	.phase 	0xFD80
fa00 2e0c s 	.phase 	0xFA00
fa00 2e0c s resident_md_addr 	EQU 	$
fa00 2e0c s 
fa00 2e0c s 
fa00 2e0c s ;мы тут в конфигуации 0x5C
fa00 2e0c s 
fa00 2e0c s ;Код Cfg    ПЗУ     ОЗУ        ГЗУ   ОЗУ2       Клав  Рег2  А/Ц   Рег1
fa00 2e0c s ;ID  Name   ROM     RAM        GZU   Ram2       KBD   REGS  ACZU  DEV
fa00 2e0c s ;______________________________________________________________________
fa00 2e0c s ;1C  ODOSA          0000-F7FF                   F800  FA00  FC00  FB00
fa00 2e0c s ;5C  DOSA           0000-FDFF                         FF00        FE00
fa00 2e0c s 
fa00 2e0c s 
fa00 2e0c s 
fa00 2e0c s ;PATCH --------------------------------------------------------------------------
fa00 2e0c s 
fa00 2e0c s ;do_dskIO
fa00 2e0c s 
fa00 2e0c s ; RAM:EAFD FE 04                    cp      4 		
fa00 2e0c s ; RAM:EAFF CA 36 EB                 jp      z, jREAD 		<--- MY write
fa00 2e0c s ; RAM:EB02 FE 06                    cp      6
fa00 2e0c s ; RAM:EB04 CA A0 EB                 jp      z, jWRITE 		<--- MY write
fa00 2e0c s 
fa00 2e0c s 
fa00 2e0c s ; SELDSK:
fa00 2e0c s ; RAM:EC87 CD 14 EE                 call    SEL_DSK_SEEK0       <--- 00 00 00
fa00 2e0c s ; RAM:EC8A CD 1E EE                 call    ReadToRDBUF 	<--- MY read info into F04E. nz if err 
fa00 2e0c s 
fa00 2e0c s ; RAM:EC3A          Flush?:                                 ; CODE XREF: do_DSKIO+6Ap
fa00 2e0c s ; RAM:EC3A                                                  ; do_DSKIO+9Ap ...
fa00 2e0c s ; RAM:EC3A 21 FD EE                 ld      hl, flagWriteReuired?
fa00 2e0c s ; RAM:EC3D 7E                       ld      a, (hl)
fa00 2e0c s ; RAM:EC3E B7                       or      a
fa00 2e0c s ; RAM:EC3F C8                       ret     z  			<--- C9, newer flush
fa00 2e0c s ; RAM:EC42 21 0A EF                 ld      hl, WrBufDiskInfo   <--- or C9 HERE
fa00 2e0c s 
fa00 2e0c s 
fa00 2e0c s ;DISKINFO -----------------------------------------------------------------------
fa00 2e0c s 
fa00 2e0c s ; RAM:EB36          jREAD:                                  ; CODE XREF: do_DSKIO+40j
fa00 2e0c s ; RAM:EB36 2A F8 EE                 ld      hl, (DSC_IO_HL) ; DSCDESCR
fa00 2e0c s ; RAM:EB39 46                       ld      b, (hl)         ; Drive
fa00 2e0c s ; RAM:EB3A 23                       inc     hl
fa00 2e0c s 
fa00 2e0c s ; RAM:EAF1 7E                       ld      a, (hl) 	    ;operation 3-reset?, 4-read,6-write
fa00 2e0c s ; RAM:EAF2 23                       inc     hl
fa00 2e0c s 
fa00 2e0c s ; RAM:EB3C 23                       inc     hl 		    ; ?chword?
fa00 2e0c s ; RAM:EB3D 23                       inc     hl              ; ?NumB?
fa00 2e0c s 
fa00 2e0c s ; RAM:EB3E 4E                       ld      c, (hl)         ; track
fa00 2e0c s ; RAM:EB3F 23                       inc     hl
fa00 2e0c s 
fa00 2e0c s ; RAM:EB40 7E                       ld      a, (hl)         ; sector
fa00 2e0c s ; RAM:EB3F 23                       inc     hl
fa00 2e0c s 
fa00 2e0c s ; RAM:EAF6 5E                       ld      e, (hl)
fa00 2e0c s ; RAM:EAF7 23                       inc     hl
fa00 2e0c s ; RAM:EAF8 56                       ld      d, (hl)
fa00 2e0c s ; RAM:EAF9 EB                       ex      de, hl
fa00 2e0c s ; RAM:EAFA 22 FA EE                 ld      (_DMA??), hl
fa00 2e0c s ;DISKINFO -----------------------------------------------------------------------
fa00 2e0c s md_res_DRIVEA:
fa00 2e0c d 00
fa00 2e0c s 	db 	0
fa01 2e0d s md_res_DRIVEB:
fa01 2e0d d 00
fa01 2e0d s 	db 	0
fa02 2e0e s 
fa02 2e0e s md_res_DRIVE_TAB:
fa02 2e0e d 00fa
fa02 2e0e s 	dw 	md_res_DRIVEA 	;A
fa04 2e10 d 01fa
fa04 2e10 s 	dw 	md_res_DRIVEB 	;B
fa06 2e12 d 0000
fa06 2e12 s 	dw 	0 	;C
fa08 2e14 d 0000
fa08 2e14 s 	dw 	0 	;D
fa0a 2e16 d 0000
fa0a 2e16 s 	dw 	0 	;E
fa0c 2e18 d 0000
fa0c 2e18 s 	dw 	0 	;F
fa0e 2e1a s 
fa0e 2e1a s md_res_seldsk:
fa0e 2e1a d 79
fa0e 2e1a s 	ld 	a,c
fa0f 2e1b d fefe
fa0f 2e1b s 	cp 	0xfe
fa11 2e1d s md_old_seld_dsk:
fa11 2e1d d c211fa
fa11 2e1d s 	jp 	nz,$	
fa14 2e20 d 2102fa
fa14 2e20 s 	ld 	hl,md_res_DRIVE_TAB
fa17 2e23 d c9
fa17 2e23 s 	ret
fa18 2e24 s 
fa18 2e24 s md_fetch_params:
fa18 2e24 s 
fa18 2e24 d f5
fa18 2e24 s 	push 	af
fa19 2e25 d c5
fa19 2e25 s 	push 	bc
fa1a 2e26 d d5
fa1a 2e26 s 	push 	de
fa1b 2e27 d e5
fa1b 2e27 s 	push 	hl
fa1c 2e28 s 
fa1c 2e28 s MD_PARAM2:
fa1c 2e28 d 2af8ee
fa1c 2e28 s 	ld      hl, (0xEEF8) ; DSCDESCR
fa1f 2e2b d 7e
fa1f 2e2b s 	ld      a, (hl)         ; Drive
fa20 2e2c d 23
fa20 2e2c s 	inc     hl
fa21 2e2d d 320bfb
fa21 2e2d s 	ld 	(MD_EXR_DRV),a
fa24 2e30 s 
fa24 2e30 s ; 	ld      a, (hl)		;operation 3-reset?, 4-read,6-write
fa24 2e30 d 23
fa24 2e30 s 	inc     hl
fa25 2e31 s 
fa25 2e31 d 23
fa25 2e31 s 	inc     hl		; ?chword?
fa26 2e32 d 23
fa26 2e32 s 	inc     hl              ; ?NumB?
fa27 2e33 s 
fa27 2e33 d 7e
fa27 2e33 s 	ld      a, (hl)         ; track
fa28 2e34 d 23
fa28 2e34 s 	inc     hl
fa29 2e35 d 320cfb
fa29 2e35 s 	ld 	(MD_EXR_TRK),a
fa2c 2e38 s 
fa2c 2e38 d 7e
fa2c 2e38 s 	ld      a, (hl)         ; sector
fa2d 2e39 d 3d
fa2d 2e39 s 	DEC	A
fa2e 2e3a d 23
fa2e 2e3a s 	inc     hl
fa2f 2e3b d 320dfb
fa2f 2e3b s 	ld 	(MD_EXR_SEC),a
fa32 2e3e s 
fa32 2e3e d 5e
fa32 2e3e s 	ld      e, (hl)
fa33 2e3f d 23
fa33 2e3f s 	inc     hl
fa34 2e40 d 56
fa34 2e40 s 	ld      d, (hl)
fa35 2e41 d eb
fa35 2e41 s 	ex      de, hl
fa36 2e42 d 220efb
fa36 2e42 s 	ld      (MD_DMA), hl
fa39 2e45 s 
fa39 2e45 d e1
fa39 2e45 s 	pop 	hl
fa3a 2e46 d d1
fa3a 2e46 s 	pop 	de
fa3b 2e47 d c1
fa3b 2e47 s 	pop 	bc
fa3c 2e48 d f1
fa3c 2e48 s 	pop 	af
fa3d 2e49 s 
fa3d 2e49 d c9
fa3d 2e49 s 	ret
fa3e 2e4a s 
fa3e 2e4a s MD_READ:
fa3e 2e4a d cd18fa
fa3e 2e4a s 	call 	md_fetch_params
fa41 2e4d s 	
fa41 2e4d d 3e01
fa41 2e4d s 	LD	A,1
fa43 2e4f d 320afb
fa43 2e4f s 	LD	(MD_EXR_CMD),A	; 1 - команда чтения
fa46 2e52 s 
fa46 2e52 d cdc5fa
fa46 2e52 s 	CALL	MD_EXR_SENDCMD	; отсылаем команду
fa49 2e55 d 3d
fa49 2e55 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
fa4a 2e56 d c0
fa4a 2e56 s 	RET	NZ		; 0 - ошибка
fa4b 2e57 d 2a0efb
fa4b 2e57 s 	LD	HL,(MD_DMA)	; адрес буфера для приема данных
fa4e 2e5a d cd8dfa
fa4e 2e5a s 	CALL	MD_EXR_GETSEC	; принимаем данные
fa51 2e5d d af
fa51 2e5d s 	XOR	A		; завершение всегда успешно
fa52 2e5e d c9
fa52 2e5e s 	RET
fa53 2e5f s 
fa53 2e5f s MD_WRITE:
fa53 2e5f d cd18fa
fa53 2e5f s 	call	md_fetch_params
fa56 2e62 s 
fa56 2e62 d 3e02
fa56 2e62 s 	LD	A,2		; 2 - команда записи
fa58 2e64 d 320afb
fa58 2e64 s 	LD	(MD_EXR_CMD),A
fa5b 2e67 s 
fa5b 2e67 d cdc5fa
fa5b 2e67 s 	CALL	MD_EXR_SENDCMD
fa5e 2e6a d 3d
fa5e 2e6a s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
fa5f 2e6b d c0
fa5f 2e6b s 	RET	NZ		; 0 - ошибка
fa60 2e6c d 2a0efb
fa60 2e6c s 	LD	HL,(MD_DMA)
fa63 2e6f d cda9fa
fa63 2e6f s 	CALL	MD_EXR_PUTSEC
fa66 2e72 d af
fa66 2e72 s 	XOR	A		; запись успешна
fa67 2e73 d c9
fa67 2e73 s 	RET
fa68 2e74 s 
fa68 2e74 s MD_READ_INFOSECTOR:
fa68 2e74 d cdecfa
fa68 2e74 s 	CALL	MD_EXR_READINFO
fa6b 2e77 d 3d
fa6b 2e77 s 	DEC	A		; ответ, 0 - ошибка, 1 - ОК
fa6c 2e78 d c9
fa6c 2e78 s 	ret
fa6d 2e79 s 
fa6d 2e79 s 
fa6d 2e79 s ;==================  Драйвер ExtROM-API ====================================
fa6d 2e79 s 	
fa6d 2e79 s 	
fa6d 2e79 s ;****************************************
fa6d 2e79 s ;*  Прием байта из порта А по стробу    *
fa6d 2e79 s ;****************************************
fa6d 2e79 s MD_EXR_GETBYTE:
fa6d 2e79 d e5
fa6d 2e79 s 	PUSH	HL
fa6e 2e7a d 210afe
fa6e 2e7a s 	LD	HL,MD_rPORTC
fa71 2e7d s MD_pWG:
fa71 2e7d d 7e
fa71 2e7d s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
fa72 2e7e d e620
fa72 2e7e s 	AND	20h		; выделяем сигнал IBF
fa74 2e80 d ca71fa
fa74 2e80 s 	JP	Z,MD_pWG		; IBF=0 - данных еще нет
fa77 2e83 d 3a08fe
fa77 2e83 s 	LD	A,(MD_rPORTA)		; данные поступили - выбираем их из порта А
fa7a 2e86 d e1
fa7a 2e86 s 	POP	HL
fa7b 2e87 d c9
fa7b 2e87 s 	RET
fa7c 2e88 s 
fa7c 2e88 s ;****************************************
fa7c 2e88 s ;*  Отправка байта в порт A             *
fa7c 2e88 s ;****************************************
fa7c 2e88 s MD_EXR_PUTBYTE:
fa7c 2e88 d e5
fa7c 2e88 s 	PUSH	HL
fa7d 2e89 d f5
fa7d 2e89 s 	PUSH	AF
fa7e 2e8a d 210afe
fa7e 2e8a s 	LD	HL,MD_rPORTC
fa81 2e8d s MD_pWP:
fa81 2e8d d 7e
fa81 2e8d s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
fa82 2e8e d e680
fa82 2e8e s 	AND	80h		; выделяем сигнал -OBF
fa84 2e90 d ca81fa
fa84 2e90 s 	JP	Z,MD_pWP		; -OBF=0 - в передатчике сидит незабранный байт
fa87 2e93 d f1
fa87 2e93 s 	POP	AF
fa88 2e94 d 3208fe
fa88 2e94 s 	LD	(MD_rPORTA),A		; данные поступили - выбираем их из порта А
fa8b 2e97 d e1
fa8b 2e97 s 	POP	HL
fa8c 2e98 d c9
fa8c 2e98 s 	RET
fa8d 2e99 s 
fa8d 2e99 s ;*******************************************
fa8d 2e99 s ;*      Прием сектора                      *
fa8d 2e99 s ;* HL - адрес размещения сектора в памяти  *
fa8d 2e99 s ;*  Размер сектора - 128 байт              *
fa8d 2e99 s ;*******************************************
fa8d 2e99 s MD_EXR_GETSEC:
fa8d 2e99 d f3
fa8d 2e99 s 	di
fa8e 2e9a d c5
fa8e 2e9a s 	PUSH	BC
fa8f 2e9b d d5
fa8f 2e9b s 	PUSH	DE
fa90 2e9c d 0e80
fa90 2e9c s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
fa92 2e9e d eb
fa92 2e9e s 	EX	DE,HL		; адрес буфера -> DE
fa93 2e9f d 210afe
fa93 2e9f s 	LD	HL,MD_rPORTC
fa96 2ea2 s MD_pGSL:
fa96 2ea2 d 7e
fa96 2ea2 s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
fa97 2ea3 d e620
fa97 2ea3 s 	AND	20h		; выделяем сигнал IBF
fa99 2ea5 d ca96fa
fa99 2ea5 s 	JP	Z,MD_pGSL		; IBF=0 - данных еще нет
fa9c 2ea8 d 3a08fe
fa9c 2ea8 s 	LD	A,(MD_rPORTA)		; данные поступили - выбираем их из порта А
fa9f 2eab d 12
fa9f 2eab s 	LD	(DE),A		; принимаем и размещаем очередной байт
faa0 2eac d 13
faa0 2eac s 	INC	DE		; указатель буфера ++
faa1 2ead d 0d
faa1 2ead s 	DEC	C		; принимаем остальные байты
faa2 2eae d c296fa
faa2 2eae s 	JP	NZ,MD_pGSL
faa5 2eb1 d d1
faa5 2eb1 s 	POP	DE
faa6 2eb2 d c1
faa6 2eb2 s 	POP	BC
faa7 2eb3 d fb
faa7 2eb3 s 	ei 		
faa8 2eb4 d c9
faa8 2eb4 s 	RET
faa9 2eb5 s 
faa9 2eb5 s ;*******************************************
faa9 2eb5 s ;*      Передача сектора                   *
faa9 2eb5 s ;* HL - адрес размещения сектора в памяти  *
faa9 2eb5 s ;*  Размер сектора - 128 байт              *
faa9 2eb5 s ;*******************************************
faa9 2eb5 s MD_EXR_PUTSEC:
faa9 2eb5 d f3
faa9 2eb5 s 	di
faaa 2eb6 d c5
faaa 2eb6 s 	PUSH	BC
faab 2eb7 d d5
faab 2eb7 s 	PUSH	DE
faac 2eb8 d 0e80
faac 2eb8 s 	LD	C,128		; счетчик байтов сектора, всего 128 байт
faae 2eba d eb
faae 2eba s 	EX	DE,HL		; адрес буфера -> DE
faaf 2ebb d 210afe
faaf 2ebb s 	LD	HL,MD_rPORTC
fab2 2ebe s MD_pPSL:
fab2 2ebe d 7e
fab2 2ebe s 	LD	A,(HL)		; слово состояния ВВ55 - берется из порта С
fab3 2ebf d e680
fab3 2ebf s 	AND	80h		; выделяем сигнал -OBF
fab5 2ec1 d cab2fa
fab5 2ec1 s 	JP	Z,MD_pPSL		; -OBF=0 - в передатчике сидит незабранный байт
fab8 2ec4 d 1a
fab8 2ec4 s 	LD	A,(DE)		; принимаем и размещаем очередной байт
fab9 2ec5 d 3208fe
fab9 2ec5 s 	LD	(MD_rPORTA),A		; данные поступили - выбираем их из порта А
fabc 2ec8 d 13
fabc 2ec8 s 	INC	DE
fabd 2ec9 d 0d
fabd 2ec9 s 	DEC	C		; принимаем остальные байты
fabe 2eca d c2b2fa
fabe 2eca s 	JP	NZ,MD_pPSL
fac1 2ecd d d1
fac1 2ecd s 	POP	DE
fac2 2ece d c1
fac2 2ece s 	POP	BC
fac3 2ecf d fb
fac3 2ecf s 	ei 		
fac4 2ed0 d c9
fac4 2ed0 s 	RET
fac5 2ed1 s 
fac5 2ed1 s ;****************************************
fac5 2ed1 s ;*     Отправка командного пакета       *
fac5 2ed1 s ;****************************************
fac5 2ed1 s MD_EXR_SENDCMD:
fac5 2ed1 s 
fac5 2ed1 d f3
fac5 2ed1 s 	di
fac6 2ed2 d e5
fac6 2ed2 s 	PUSH	HL
fac7 2ed3 d c5
fac7 2ed3 s 	PUSH	BC
fac8 2ed4 d 3e0c
fac8 2ed4 s 	LD	A,0Ch
faca 2ed6 d 320bfe
faca 2ed6 s 	LD	(MD_rPCWR),A	; переключаем порт в режим 2
facd 2ed9 d 210afb
facd 2ed9 s 	LD	HL,MD_EXR_CMD
fad0 2edc d 0e04
fad0 2edc s 	LD	C,4		; пакет - 4 байта
fad2 2ede d 0600
fad2 2ede s 	LD	B,0		; заготовка контрольной суммы
fad4 2ee0 s MD_pSCL:
fad4 2ee0 d 7e
fad4 2ee0 s 	LD	A,(HL)		; очередной байт пакета 
fad5 2ee1 d 80
fad5 2ee1 s 	ADD 	B		; добавляем к КС
fad6 2ee2 d 47
fad6 2ee2 s 	LD	B,A
fad7 2ee3 d 7e
fad7 2ee3 s 	LD	A,(HL)		; очередной байт пакета 
fad8 2ee4 d cd7cfa
fad8 2ee4 s 	CALL	MD_EXR_PUTBYTE		; - в порт
fadb 2ee7 d 23
fadb 2ee7 s 	INC	HL
fadc 2ee8 d 0d
fadc 2ee8 s 	DEC	C
fadd 2ee9 d c2d4fa
fadd 2ee9 s 	JP	NZ,MD_pSCL
fae0 2eec d 78
fae0 2eec s 	LD	A,B
fae1 2eed d 3d
fae1 2eed s 	DEC 	A		; КС-1
fae2 2eee d cd7cfa
fae2 2eee s 	CALL	MD_EXR_PUTBYTE     ; контрольная сумма
fae5 2ef1 d cd6dfa
fae5 2ef1 s 	CALL	MD_EXR_GETBYTE	; ответ контроллера
fae8 2ef4 d c1
fae8 2ef4 s 	POP	BC
fae9 2ef5 d e1
fae9 2ef5 s 	POP	HL
faea 2ef6 d fb
faea 2ef6 s 	ei 		
faeb 2ef7 d c9
faeb 2ef7 s 	RET
faec 2ef8 s 
faec 2ef8 s ;*******************************************
faec 2ef8 s ;*  Чтение информационного сектора
faec 2ef8 s ;*******************************************
faec 2ef8 s MD_EXR_READINFO:
faec 2ef8 d 210afb
faec 2ef8 s 	LD	HL,MD_EXR_CMD	; командный пакет
faef 2efb d 3601
faef 2efb s 	LD	(HL),1		; команда чтения
faf1 2efd d 23
faf1 2efd s 	INC	HL
faf2 2efe s MD_DRV2:
faf2 2efe d 3a06ef
faf2 2efe s 	LD	A,(0xEF06)	; вписываем # устройства
faf5 2f01 d 77
faf5 2f01 s 	LD	(HL),A
faf6 2f02 d 23
faf6 2f02 s 	INC	HL
faf7 2f03 d 3600
faf7 2f03 s 	LD	(HL),0		; обнуляем, поскольку читаем сектор 0 дорожки 0 
faf9 2f05 d 23
faf9 2f05 s 	INC	HL
fafa 2f06 d 3600
fafa 2f06 s 	LD	(HL),0		
fafc 2f08 d cdc5fa
fafc 2f08 s 	CALL	MD_EXR_SENDCMD	; отправляем команду
faff 2f0b d b7
faff 2f0b s 	OR	A
fb00 2f0c d c8
fb00 2f0c s 	RET 	Z		; ошибка
fb01 2f0d s MD_RDBUF2:
fb01 2f0d d 210000
fb01 2f0d s 	LD	HL,MD_RRBUFF	; принимаем данные
fb04 2f10 d cd8dfa
fb04 2f10 s 	CALL	MD_EXR_GETSEC
fb07 2f13 d 3e01
fb07 2f13 s 	LD	A,1
fb09 2f15 d c9
fb09 2f15 s 	RET
fb0a 2f16 s 
fb0a 2f16 s 
fb0a 2f16 s ; Командный пакет интерфейса Extrom-API
fb0a 2f16 s ;===============================================
fb0a 2f16 d 00
fb0a 2f16 s MD_EXR_CMD:	DB	0	; Команда чтения(0)-записи(1)
fb0b 2f17 d 00
fb0b 2f17 s MD_EXR_DRV:	DB	0	; Устройство - A(0), B(1)	
fb0c 2f18 d 00
fb0c 2f18 s MD_EXR_TRK:	DB	0	; логическая дорожка
fb0d 2f19 d 00
fb0d 2f19 s MD_EXR_SEC:	DB	0	; логический сектор (128b)
fb0e 2f1a d 0000
fb0e 2f1a s MD_DMA: 	DW 	0 	; адресс куда/откуда
fb10 2f1c s 
2f1c 2f1c s 	.dephase
2f1c 2f1c s resident_md_len 	equ $-resident_md
2f1c 2f1c s 
2f1c 2f1c s 
2f1c 2f1c f generator/V0/extrom-patcher.asm
2f1c 2f1c s 	include 	"out/include-patcher.asm"
2f1c 2f1c f out/include-patcher.asm
2f1c 2f1c s bios_variants:
2f1c 2f1c d 5c2f
2f1c 2f1c s 	dw	_BIOS_CPM_21_EXTROM
2f1e 2f1e d 9c2f
2f1e 2f1e s 	dw	_BIOS_CPM_12_88_3_alternativa
2f20 2f20 d 8a30
2f20 2f20 s 	dw	_BIOS_CPM_12_88_3_niijaf
2f22 2f22 d 6731
2f22 2f22 s 	dw	_BIOS_CPM_21_89___wiza
2f24 2f24 d 4932
2f24 2f24 s 	dw	_BIOS_MICRODOS_OPTS2_880630
2f26 2f26 d c932
2f26 2f26 s 	dw	_BIOS_CPM_21_89_2_niijaf2
2f28 2f28 d a733
2f28 2f28 s 	dw	_BIOS_CPM_21_89_2_niijaf
2f2a 2f2a d 8434
2f2a 2f2a s 	dw	_BIOS_MICRODOS_OPTS1_870430
2f2c 2f2c d ff34
2f2c 2f2c s 	dw	_BIOS_CPM_1x_89_03_30_RAVI
2f2e 2f2e d df35
2f2e 2f2e s 	dw	_BIOS_MICRODOS_OPTS1_861011
2f30 2f30 d 6436
2f30 2f30 s 	dw	_BIOS_CPM_21_91___LAP
2f32 2f32 d 3e37
2f32 2f32 s 	dw	_BIOS_CPM_20_88___miks
2f34 2f34 d 1938
2f34 2f34 s 	dw	_BIOS_CPM_12_90_5_kontur
2f36 2f36 d f638
2f36 2f36 s 	dw	_BIOS_MICRODOS_OPTS2_900105
2f38 2f38 d 7a39
2f38 2f38 s 	dw	_BIOS_CPM_12_87_11_niijaf
2f3a 2f3a d 583a
2f3a 2f3a s 	dw	_BIOS_CPM_21m_____Shkanov
2f3c 2f3c d 363b
2f3c 2f3c s 	dw	_BIOS_CPM_12_87_09_NIIJAF
2f3e 2f3e d 143c
2f3e 2f3e s 	dw	_BIOS_MICRODOS_OPTS1_871220
2f40 2f40 d 943c
2f40 2f40 s 	dw	_BIOS_MICRODOS_OPTS1_861115
2f42 2f42 d 193d
2f42 2f42 s 	dw	_BIOS_CPM_NET_SFERA1
2f44 2f44 d 623d
2f44 2f44 s 	dw	_BIOS_CPM_NET_KORNET_drive_b
2f46 2f46 d 903d
2f46 2f46 s 	dw	_BIOS_CPM_NET_KORNET_drive_a
2f48 2f48 d e13d
2f48 2f48 s 	dw	_BIOS_CPM_1x_88_EPSON_V104
2f4a 2f4a d c13e
2f4a 2f4a s 	dw	_BIOS_CPM_NET_SFERA2
2f4c 2f4c d 0000
2f4c 2f4c s 	dw	0
2f4e 2f4e s 
2f4e 2f4e d 5041544348455220444154413e3e
2f4e 2f4e s 	db 	"PATCHER DATA>>"
2f5c 2f5c s 
2f5c 2f5c s 	include "generator/V0/out/patcher-cpm_chk-CPM_21_EXTROM.asm"
2f5c 2f5c f generator/V0/out/patcher-cpm_chk-CPM_21_EXTROM.asm
2f5c 2f5c s _BIOS_CPM_21_EXTROM:
2f5c 2f5c s 	setCPM
2f5c 2f5c s 	endm
2f5c 2f5c s 	setSUBBIOS 3
2f5c 2f5c d 5a
2f5c 2f5c s 	db	pSubBios
2f5d 2f5d d 03
2f5d 2f5d s 	db 	3
2f5e 2f5e s 	endm
2f5e 2f5e s 	dwstore	drivetab_mount_info	,0xDA3F
2f5e 2f5e d 54
2f5e 2f5e s 	db 	pW_STORE
2f5f 2f5f d 3fda
2f5f 2f5f s 	dw 	0xDA3F
2f61 2f61 d 362a
2f61 2f61 s 	dw 	drivetab_mount_info
2f63 2f63 s 	endm
2f63 2f63 s 	;custom checkers
2f63 2f63 s 	dwpatch	0xDA33+0	,0x5845 ,0x5845
2f63 2f63 d 51
2f63 2f63 s 	db 	pW_CHK_PATCH
2f64 2f64 d 33da
2f64 2f64 s 	dw 	0xDA33+0
2f66 2f66 d 45584558
2f66 2f66 s 	dw 	0x5845,0x5845
2f6a 2f6a s 	endm
2f6a 2f6a s 	dwpatch	0xDA33+2	,0x5254 ,0x5254
2f6a 2f6a d 51
2f6a 2f6a s 	db 	pW_CHK_PATCH
2f6b 2f6b d 35da
2f6b 2f6b s 	dw 	0xDA33+2
2f6d 2f6d d 54525452
2f6d 2f6d s 	dw 	0x5254,0x5254
2f71 2f71 s 	endm
2f71 2f71 s 	dwpatch	0xDA33+4	,0x4D4F ,0x4D4F
2f71 2f71 d 51
2f71 2f71 s 	db 	pW_CHK_PATCH
2f72 2f72 d 37da
2f72 2f72 s 	dw 	0xDA33+4
2f74 2f74 d 4f4d4f4d
2f74 2f74 s 	dw 	0x4D4F,0x4D4F
2f78 2f78 s 	endm
2f78 2f78 s 	dwpatch	0xDA33+6	,0x4942 ,0x4942
2f78 2f78 d 51
2f78 2f78 s 	db 	pW_CHK_PATCH
2f79 2f79 d 39da
2f79 2f79 s 	dw 	0xDA33+6
2f7b 2f7b d 42494249
2f7b 2f7b s 	dw 	0x4942,0x4942
2f7f 2f7f s 	endm
2f7f 2f7f s 	dwpatch	0xDA33+8	,0x534F ,0x534F
2f7f 2f7f d 51
2f7f 2f7f s 	db 	pW_CHK_PATCH
2f80 2f80 d 3bda
2f80 2f80 s 	dw 	0xDA33+8
2f82 2f82 d 4f534f53
2f82 2f82 s 	dw 	0x534F,0x534F
2f86 2f86 s 	endm
2f86 2f86 s 	dwpatch	0xDA33+10	,0x3156 ,0x3156
2f86 2f86 d 51
2f86 2f86 s 	db 	pW_CHK_PATCH
2f87 2f87 d 3dda
2f87 2f87 s 	dw 	0xDA33+10
2f89 2f89 d 56315631
2f89 2f89 s 	dw 	0x3156,0x3156
2f8d 2f8d s 	endm
2f8d 2f8d s 	stop 'CPM_21_EXTROM'
2f8d 2f8d d 50
2f8d 2f8d s 	db 	p_STOP
2f8e 2f8e d 43504d5f32315f455854524f4d
2f8e 2f8e s 	db 	'CPM_21_EXTROM'
2f9b 2f9b d 00
2f9b 2f9b s 	db 	0
2f9c 2f9c s 	endm
2f9c 2f9c f out/include-patcher.asm
2f9c 2f9c s 	include "generator/V0/out/patcher-cpm1-CPM_12_88_3_alternativa.asm"	; 25 images in collection
2f9c 2f9c f generator/V0/out/patcher-cpm1-CPM_12_88_3_alternativa.asm
2f9c 2f9c s _BIOS_CPM_12_88_3_alternativa:
2f9c 2f9c s 	setSUBBIOS 1
2f9c 2f9c d 5a
2f9c 2f9c s 	db	pSubBios
2f9d 2f9d d 01
2f9d 2f9d s 	db 	1
2f9e 2f9e s 	endm
2f9e 2f9e s 	RQ_OPTS_ANY
2f9e 2f9e s 	endm
2f9e 2f9e s 	setCPM
2f9e 2f9e s 	endm
2f9e 2f9e s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
2f9e 2f9e d 59
2f9e 2f9e s 	db 	pB_MAYBE_PATCH
2f9f 2f9f d eeda
2f9f 2f9f s 	dw 	0xDAEE
2fa1 2fa1 d 1f0d
2fa1 2fa1 s 	db 	0x1F,0x0d
2fa3 2fa3 s 	endm
2fa3 2fa3 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
2fa3 2fa3 d 59
2fa3 2fa3 s 	db 	pB_MAYBE_PATCH
2fa4 2fa4 d f0da
2fa4 2fa4 s 	dw 	0xDAEE+2
2fa6 2fa6 d 0a0d
2fa6 2fa6 s 	db 	0x0a,0x0d
2fa8 2fa8 s 	endm
2fa8 2fa8 s 	dbpatch	0xE077+1	,0x49	,0xc9
2fa8 2fa8 d 52
2fa8 2fa8 s 	db 	pB_CHK_PATCH
2fa9 2fa9 d 78e0
2fa9 2fa9 s 	dw 	0xE077+1
2fab 2fab d 49c9
2fab 2fab s 	db 	0x49,0xc9
2fad 2fad s 	endm
2fad 2fad s 	dbpatch	0xDA88 	,0x01	,0x00
2fad 2fad d 52
2fad 2fad s 	db 	pB_CHK_PATCH
2fae 2fae d 88da
2fae 2fae s 	dw 	0xDA88
2fb0 2fb0 d 0100
2fb0 2fb0 s 	db 	0x01,0x00
2fb2 2fb2 s 	endm
2fb2 2fb2 s 	dbpatch	0xDA9F 	,0x02	,0x00
2fb2 2fb2 d 52
2fb2 2fb2 s 	db 	pB_CHK_PATCH
2fb3 2fb3 d 9fda
2fb3 2fb3 s 	dw 	0xDA9F
2fb5 2fb5 d 0200
2fb5 2fb5 s 	db 	0x02,0x00
2fb7 2fb7 s 	endm
2fb7 2fb7 s 	dbpatch	0xDAB6 	,0x04	,0x01
2fb7 2fb7 d 52
2fb7 2fb7 s 	db 	pB_CHK_PATCH
2fb8 2fb8 d b6da
2fb8 2fb8 s 	dw 	0xDAB6
2fba 2fba d 0401
2fba 2fba s 	db 	0x04,0x01
2fbc 2fbc s 	endm
2fbc 2fbc s 	dbpatch	0xDACD 	,0x08	,0x02
2fbc 2fbc d 52
2fbc 2fbc s 	db 	pB_CHK_PATCH
2fbd 2fbd d cdda
2fbd 2fbd s 	dw 	0xDACD
2fbf 2fbf d 0802
2fbf 2fbf s 	db 	0x08,0x02
2fc1 2fc1 s 	endm
2fc1 2fc1 s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
2fc1 2fc1 d 54
2fc1 2fc1 s 	db 	pW_STORE
2fc2 2fc2 d 88da
2fc2 2fc2 s 	dw 	0xDA88
2fc4 2fc4 d ace8
2fc4 2fc4 s 	dw 	_CPM1_res_DRIVE_TAB+0*2
2fc6 2fc6 s 	endm
2fc6 2fc6 s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
2fc6 2fc6 d 54
2fc6 2fc6 s 	db 	pW_STORE
2fc7 2fc7 d 9fda
2fc7 2fc7 s 	dw 	0xDA9F
2fc9 2fc9 d aee8
2fc9 2fc9 s 	dw 	_CPM1_res_DRIVE_TAB+1*2
2fcb 2fcb s 	endm
2fcb 2fcb s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
2fcb 2fcb d 54
2fcb 2fcb s 	db 	pW_STORE
2fcc 2fcc d b6da
2fcc 2fcc s 	dw 	0xDAB6
2fce 2fce d b0e8
2fce 2fce s 	dw 	_CPM1_res_DRIVE_TAB+2*2
2fd0 2fd0 s 	endm
2fd0 2fd0 s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
2fd0 2fd0 d 54
2fd0 2fd0 s 	db 	pW_STORE
2fd1 2fd1 d cdda
2fd1 2fd1 s 	dw 	0xDACD
2fd3 2fd3 d b2e8
2fd3 2fd3 s 	dw 	_CPM1_res_DRIVE_TAB+3*2
2fd5 2fd5 s 	endm
2fd5 2fd5 s 	dwpatch 0xDCBF+5*2 	,0x0000 ,_CPM1_dph_F
2fd5 2fd5 d 51
2fd5 2fd5 s 	db 	pW_CHK_PATCH
2fd6 2fd6 d c9dc
2fd6 2fd6 s 	dw 	0xDCBF+5*2
2fd8 2fd8 d 0000b8e8
2fd8 2fd8 s 	dw 	0x0000,_CPM1_dph_F
2fdc 2fdc s 	endm
2fdc 2fdc s 	dwstore _CPM1_dph_F+8	,0xEBA6
2fdc 2fdc d 54
2fdc 2fdc s 	db 	pW_STORE
2fdd 2fdd d a6eb
2fdd 2fdd s 	dw 	0xEBA6
2fdf 2fdf d c0e8
2fdf 2fdf s 	dw 	_CPM1_dph_F+8
2fe1 2fe1 s 	endm
2fe1 2fe1 s 	dwpatch 0xDA1B+1 	,0xDC7B	,_CPM1_res_seldsk
2fe1 2fe1 d 51
2fe1 2fe1 s 	db 	pW_CHK_PATCH
2fe2 2fe2 d 1cda
2fe2 2fe2 s 	dw 	0xDA1B+1
2fe4 2fe4 d 7bdc11e9
2fe4 2fe4 s 	dw 	0xDC7B,_CPM1_res_seldsk
2fe8 2fe8 s 	endm
2fe8 2fe8 s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC7B
2fe8 2fe8 d 54
2fe8 2fe8 s 	db 	pW_STORE
2fe9 2fe9 d 7bdc
2fe9 2fe9 s 	dw 	0xDC7B
2feb 2feb d 15e9
2feb 2feb s 	dw 	_CPM1_old_seld_dsk+1
2fed 2fed s 	endm
2fed 2fed s 	dbpatch	0xE63E	,0x77	,0x00
2fed 2fed d 52
2fed 2fed s 	db 	pB_CHK_PATCH
2fee 2fee d 3ee6
2fee 2fee s 	dw 	0xE63E
2ff0 2ff0 d 7700
2ff0 2ff0 s 	db 	0x77,0x00
2ff2 2ff2 s 	endm
2ff2 2ff2 s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDF92
2ff2 2ff2 d 54
2ff2 2ff2 s 	db 	pW_STORE
2ff3 2ff3 d 92df
2ff3 2ff3 s 	dw 	0xDF92
2ff5 2ff5 d 2ee9
2ff5 2ff5 s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
2ff7 2ff7 s 	endm
2ff7 2ff7 s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDF92
2ff7 2ff7 d 54
2ff7 2ff7 s 	db 	pW_STORE
2ff8 2ff8 d 92df
2ff8 2ff8 s 	dw 	0xDF92
2ffa 2ffa d 6be9
2ffa 2ffa s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
2ffc 2ffc s 	endm
2ffc 2ffc s 	dwpatch	0xDA27+1	,0xDCDE	,_CPM1_res_READ
2ffc 2ffc d 51
2ffc 2ffc s 	db 	pW_CHK_PATCH
2ffd 2ffd d 28da
2ffd 2ffd s 	dw 	0xDA27+1
2fff 2fff d dedc1be9
2fff 2fff s 	dw 	0xDCDE,_CPM1_res_READ
3003 3003 s 	endm
3003 3003 s 	dwpatch	0xDA2A+1	,0xDE14	,_CPM1_res_WRITE
3003 3003 d 51
3003 3003 s 	db 	pW_CHK_PATCH
3004 3004 d 2bda
3004 3004 s 	dw 	0xDA2A+1
3006 3006 d 14de58e9
3006 3006 s 	dw 	0xDE14,_CPM1_res_WRITE
300a 300a s 	endm
300a 300a s 	dwpatch	0xDB74+1	,0xDCDE	,_CPM1_res_READ
300a 300a d 51
300a 300a s 	db 	pW_CHK_PATCH
300b 300b d 75db
300b 300b s 	dw 	0xDB74+1
300d 300d d dedc1be9
300d 300d s 	dw 	0xDCDE,_CPM1_res_READ
3011 3011 s 	endm
3011 3011 s 	dwpatch	0xDCAD+1	,0xE574	,_CPM1_res_GETINFO
3011 3011 d 51
3011 3011 s 	db 	pW_CHK_PATCH
3012 3012 d aedc
3012 3012 s 	dw 	0xDCAD+1
3014 3014 d 74e595e9
3014 3014 s 	dw 	0xE574,_CPM1_res_GETINFO
3018 3018 s 	endm
3018 3018 s 	dwstore	_CPM1__old_read+1	,0xDCDE
3018 3018 d 54
3018 3018 s 	db 	pW_STORE
3019 3019 d dedc
3019 3019 s 	dw 	0xDCDE
301b 301b d 56e9
301b 301b s 	dw 	_CPM1__old_read+1
301d 301d s 	endm
301d 301d s 	dwstore	_CPM1__old_write+1	,0xDE14
301d 301d d 54
301d 301d s 	db 	pW_STORE
301e 301e d 14de
301e 301e s 	dw 	0xDE14
3020 3020 d 93e9
3020 3020 s 	dw 	_CPM1__old_write+1
3022 3022 s 	endm
3022 3022 s 	dwstore	_CPM1__old_getinfo+1	,0xE574
3022 3022 d 54
3022 3022 s 	db 	pW_STORE
3023 3023 d 74e5
3023 3023 s 	dw 	0xE574
3025 3025 d a3e9
3025 3025 s 	dw 	_CPM1__old_getinfo+1
3027 3027 s 	endm
3027 3027 s 	dbpatch	0xE5B4		,0x21	,0x21
3027 3027 d 52
3027 3027 s 	db 	pB_CHK_PATCH
3028 3028 d b4e5
3028 3028 s 	dw 	0xE5B4
302a 302a d 2121
302a 302a s 	db 	0x21,0x21
302c 302c s 	endm
302c 302c s 	dwpatch	0xE5B4+1 	,0xE5E4	,0xE5E4
302c 302c d 51
302c 302c s 	db 	pW_CHK_PATCH
302d 302d d b5e5
302d 302d s 	dw 	0xE5B4+1
302f 302f d e4e5e4e5
302f 302f s 	dw 	0xE5E4,0xE5E4
3033 3033 s 	endm
3033 3033 s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE5B4
3033 3033 d 54
3033 3033 s 	db 	pW_STORE
3034 3034 d b4e5
3034 3034 s 	dw 	0xE5B4
3036 3036 d a0e9
3036 3036 s 	dw 	_CPM1__old_getinfo_chkdo+1
3038 3038 s 	endm
3038 3038 s 	dwstore	_CPM1_r_p_DSK1+1	,0xDF88 	;read
3038 3038 d 54
3038 3038 s 	db 	pW_STORE
3039 3039 d 88df
3039 3039 s 	dw 	0xDF88
303b 303b d 1ce9
303b 303b s 	dw 	_CPM1_r_p_DSK1+1
303d 303d s 	endm
303d 303d s 	dwstore	_CPM1_r_p_TRK1+1	,0xDF8C 	
303d 303d d 54
303d 303d s 	db 	pW_STORE
303e 303e d 8cdf
303e 303e s 	dw 	0xDF8C
3040 3040 d 37e9
3040 3040 s 	dw 	_CPM1_r_p_TRK1+1
3042 3042 s 	endm
3042 3042 s 	dwstore	_CPM1_r_p_SEC1+1	,0xDF8D 	
3042 3042 d 54
3042 3042 s 	db 	pW_STORE
3043 3043 d 8ddf
3043 3043 s 	dw 	0xDF8D
3045 3045 d 3de9
3045 3045 s 	dw 	_CPM1_r_p_SEC1+1
3047 3047 s 	endm
3047 3047 s 	dwstore	_CPM1_r_p_DMA1+1	,0xDF8E 	
3047 3047 d 54
3047 3047 s 	db 	pW_STORE
3048 3048 d 8edf
3048 3048 s 	dw 	0xDF8E
304a 304a d 4ee9
304a 304a s 	dw 	_CPM1_r_p_DMA1+1
304c 304c s 	endm
304c 304c s 	dwstore	_CPM1_r_p_DSK2+1	,0xDF88 	;write
304c 304c d 54
304c 304c s 	db 	pW_STORE
304d 304d d 88df
304d 304d s 	dw 	0xDF88
304f 304f d 59e9
304f 304f s 	dw 	_CPM1_r_p_DSK2+1
3051 3051 s 	endm
3051 3051 s 	dwstore	_CPM1_r_p_TRK2+1	,0xDF8C 	
3051 3051 d 54
3051 3051 s 	db 	pW_STORE
3052 3052 d 8cdf
3052 3052 s 	dw 	0xDF8C
3054 3054 d 74e9
3054 3054 s 	dw 	_CPM1_r_p_TRK2+1
3056 3056 s 	endm
3056 3056 s 	dwstore	_CPM1_r_p_SEC2+1	,0xDF8D 	
3056 3056 d 54
3056 3056 s 	db 	pW_STORE
3057 3057 d 8ddf
3057 3057 s 	dw 	0xDF8D
3059 3059 d 7ae9
3059 3059 s 	dw 	_CPM1_r_p_SEC2+1
305b 305b s 	endm
305b 305b s 	dwstore	_CPM1_r_p_DMA2+1	,0xDF8E 	
305b 305b d 54
305b 305b s 	db 	pW_STORE
305c 305c d 8edf
305c 305c s 	dw 	0xDF8E
305e 305e d 8be9
305e 305e s 	dw 	_CPM1_r_p_DMA2+1
3060 3060 s 	endm
3060 3060 s 	dwstore	_CPM1_r_p_DSK3+1	,0xDF88 	;readinfo
3060 3060 d 54
3060 3060 s 	db 	pW_STORE
3061 3061 d 88df
3061 3061 s 	dw 	0xDF88
3063 3063 d 28ea
3063 3063 s 	dw 	_CPM1_r_p_DSK3+1
3065 3065 s 	endm
3065 3065 s 	;custom checkers
3065 3065 s 	dbpatch	0xE01D	,0x21 ,0x21
3065 3065 d 52
3065 3065 s 	db 	pB_CHK_PATCH
3066 3066 d 1de0
3066 3066 s 	dw 	0xE01D
3068 3068 d 2121
3068 3068 s 	db 	0x21,0x21
306a 306a s 	endm
306a 306a s 	dwpatch	0xE01D+1	,0xFB21 ,0xFB21
306a 306a d 51
306a 306a s 	db 	pW_CHK_PATCH
306b 306b d 1ee0
306b 306b s 	dw 	0xE01D+1
306d 306d d 21fb21fb
306d 306d s 	dw 	0xFB21,0xFB21
3071 3071 s 	endm
3071 3071 s 	stop 'CPM_12_88_3_alternativa'
3071 3071 d 50
3071 3071 s 	db 	p_STOP
3072 3072 d 43504d5f31325f38385f335f616c7465726e6174697661
3072 3072 s 	db 	'CPM_12_88_3_alternativa'
3089 3089 d 00
3089 3089 s 	db 	0
308a 308a s 	endm
308a 308a f out/include-patcher.asm
308a 308a s 	include "generator/V0/out/patcher-cpm1-CPM_12_88_3_niijaf.asm"	; 78 images in collection
308a 308a f generator/V0/out/patcher-cpm1-CPM_12_88_3_niijaf.asm
308a 308a s _BIOS_CPM_12_88_3_niijaf:
308a 308a s 	setSUBBIOS 1
308a 308a d 5a
308a 308a s 	db	pSubBios
308b 308b d 01
308b 308b s 	db 	1
308c 308c s 	endm
308c 308c s 	RQ_OPTS_ANY
308c 308c s 	endm
308c 308c s 	setCPM
308c 308c s 	endm
308c 308c s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
308c 308c d 59
308c 308c s 	db 	pB_MAYBE_PATCH
308d 308d d eeda
308d 308d s 	dw 	0xDAEE
308f 308f d 1f0d
308f 308f s 	db 	0x1F,0x0d
3091 3091 s 	endm
3091 3091 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
3091 3091 d 59
3091 3091 s 	db 	pB_MAYBE_PATCH
3092 3092 d f0da
3092 3092 s 	dw 	0xDAEE+2
3094 3094 d 0a0d
3094 3094 s 	db 	0x0a,0x0d
3096 3096 s 	endm
3096 3096 s 	dbpatch	0xE077+1	,0x49	,0xc9
3096 3096 d 52
3096 3096 s 	db 	pB_CHK_PATCH
3097 3097 d 78e0
3097 3097 s 	dw 	0xE077+1
3099 3099 d 49c9
3099 3099 s 	db 	0x49,0xc9
309b 309b s 	endm
309b 309b s 	dbpatch	0xDA88 	,0x01	,0x00
309b 309b d 52
309b 309b s 	db 	pB_CHK_PATCH
309c 309c d 88da
309c 309c s 	dw 	0xDA88
309e 309e d 0100
309e 309e s 	db 	0x01,0x00
30a0 30a0 s 	endm
30a0 30a0 s 	dbpatch	0xDA9F 	,0x02	,0x00
30a0 30a0 d 52
30a0 30a0 s 	db 	pB_CHK_PATCH
30a1 30a1 d 9fda
30a1 30a1 s 	dw 	0xDA9F
30a3 30a3 d 0200
30a3 30a3 s 	db 	0x02,0x00
30a5 30a5 s 	endm
30a5 30a5 s 	dbpatch	0xDAB6 	,0x04	,0x01
30a5 30a5 d 52
30a5 30a5 s 	db 	pB_CHK_PATCH
30a6 30a6 d b6da
30a6 30a6 s 	dw 	0xDAB6
30a8 30a8 d 0401
30a8 30a8 s 	db 	0x04,0x01
30aa 30aa s 	endm
30aa 30aa s 	dbpatch	0xDACD 	,0x08	,0x02
30aa 30aa d 52
30aa 30aa s 	db 	pB_CHK_PATCH
30ab 30ab d cdda
30ab 30ab s 	dw 	0xDACD
30ad 30ad d 0802
30ad 30ad s 	db 	0x08,0x02
30af 30af s 	endm
30af 30af s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
30af 30af d 54
30af 30af s 	db 	pW_STORE
30b0 30b0 d 88da
30b0 30b0 s 	dw 	0xDA88
30b2 30b2 d ace8
30b2 30b2 s 	dw 	_CPM1_res_DRIVE_TAB+0*2
30b4 30b4 s 	endm
30b4 30b4 s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
30b4 30b4 d 54
30b4 30b4 s 	db 	pW_STORE
30b5 30b5 d 9fda
30b5 30b5 s 	dw 	0xDA9F
30b7 30b7 d aee8
30b7 30b7 s 	dw 	_CPM1_res_DRIVE_TAB+1*2
30b9 30b9 s 	endm
30b9 30b9 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
30b9 30b9 d 54
30b9 30b9 s 	db 	pW_STORE
30ba 30ba d b6da
30ba 30ba s 	dw 	0xDAB6
30bc 30bc d b0e8
30bc 30bc s 	dw 	_CPM1_res_DRIVE_TAB+2*2
30be 30be s 	endm
30be 30be s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
30be 30be d 54
30be 30be s 	db 	pW_STORE
30bf 30bf d cdda
30bf 30bf s 	dw 	0xDACD
30c1 30c1 d b2e8
30c1 30c1 s 	dw 	_CPM1_res_DRIVE_TAB+3*2
30c3 30c3 s 	endm
30c3 30c3 s 	dwpatch 0xDCBF+5*2 	,0x0000 ,_CPM1_dph_F
30c3 30c3 d 51
30c3 30c3 s 	db 	pW_CHK_PATCH
30c4 30c4 d c9dc
30c4 30c4 s 	dw 	0xDCBF+5*2
30c6 30c6 d 0000b8e8
30c6 30c6 s 	dw 	0x0000,_CPM1_dph_F
30ca 30ca s 	endm
30ca 30ca s 	dwstore _CPM1_dph_F+8	,0xEBA6
30ca 30ca d 54
30ca 30ca s 	db 	pW_STORE
30cb 30cb d a6eb
30cb 30cb s 	dw 	0xEBA6
30cd 30cd d c0e8
30cd 30cd s 	dw 	_CPM1_dph_F+8
30cf 30cf s 	endm
30cf 30cf s 	dwpatch 0xDA1B+1 	,0xDC7B	,_CPM1_res_seldsk
30cf 30cf d 51
30cf 30cf s 	db 	pW_CHK_PATCH
30d0 30d0 d 1cda
30d0 30d0 s 	dw 	0xDA1B+1
30d2 30d2 d 7bdc11e9
30d2 30d2 s 	dw 	0xDC7B,_CPM1_res_seldsk
30d6 30d6 s 	endm
30d6 30d6 s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC7B
30d6 30d6 d 54
30d6 30d6 s 	db 	pW_STORE
30d7 30d7 d 7bdc
30d7 30d7 s 	dw 	0xDC7B
30d9 30d9 d 15e9
30d9 30d9 s 	dw 	_CPM1_old_seld_dsk+1
30db 30db s 	endm
30db 30db s 	dbpatch	0xE63E	,0x77	,0x00
30db 30db d 52
30db 30db s 	db 	pB_CHK_PATCH
30dc 30dc d 3ee6
30dc 30dc s 	dw 	0xE63E
30de 30de d 7700
30de 30de s 	db 	0x77,0x00
30e0 30e0 s 	endm
30e0 30e0 s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDF92
30e0 30e0 d 54
30e0 30e0 s 	db 	pW_STORE
30e1 30e1 d 92df
30e1 30e1 s 	dw 	0xDF92
30e3 30e3 d 2ee9
30e3 30e3 s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
30e5 30e5 s 	endm
30e5 30e5 s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDF92
30e5 30e5 d 54
30e5 30e5 s 	db 	pW_STORE
30e6 30e6 d 92df
30e6 30e6 s 	dw 	0xDF92
30e8 30e8 d 6be9
30e8 30e8 s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
30ea 30ea s 	endm
30ea 30ea s 	dwpatch	0xDA27+1	,0xDCDE	,_CPM1_res_READ
30ea 30ea d 51
30ea 30ea s 	db 	pW_CHK_PATCH
30eb 30eb d 28da
30eb 30eb s 	dw 	0xDA27+1
30ed 30ed d dedc1be9
30ed 30ed s 	dw 	0xDCDE,_CPM1_res_READ
30f1 30f1 s 	endm
30f1 30f1 s 	dwpatch	0xDA2A+1	,0xDE14	,_CPM1_res_WRITE
30f1 30f1 d 51
30f1 30f1 s 	db 	pW_CHK_PATCH
30f2 30f2 d 2bda
30f2 30f2 s 	dw 	0xDA2A+1
30f4 30f4 d 14de58e9
30f4 30f4 s 	dw 	0xDE14,_CPM1_res_WRITE
30f8 30f8 s 	endm
30f8 30f8 s 	dwpatch	0xDB74+1	,0xDCDE	,_CPM1_res_READ
30f8 30f8 d 51
30f8 30f8 s 	db 	pW_CHK_PATCH
30f9 30f9 d 75db
30f9 30f9 s 	dw 	0xDB74+1
30fb 30fb d dedc1be9
30fb 30fb s 	dw 	0xDCDE,_CPM1_res_READ
30ff 30ff s 	endm
30ff 30ff s 	dwpatch	0xDCAD+1	,0xE574	,_CPM1_res_GETINFO
30ff 30ff d 51
30ff 30ff s 	db 	pW_CHK_PATCH
3100 3100 d aedc
3100 3100 s 	dw 	0xDCAD+1
3102 3102 d 74e595e9
3102 3102 s 	dw 	0xE574,_CPM1_res_GETINFO
3106 3106 s 	endm
3106 3106 s 	dwstore	_CPM1__old_read+1	,0xDCDE
3106 3106 d 54
3106 3106 s 	db 	pW_STORE
3107 3107 d dedc
3107 3107 s 	dw 	0xDCDE
3109 3109 d 56e9
3109 3109 s 	dw 	_CPM1__old_read+1
310b 310b s 	endm
310b 310b s 	dwstore	_CPM1__old_write+1	,0xDE14
310b 310b d 54
310b 310b s 	db 	pW_STORE
310c 310c d 14de
310c 310c s 	dw 	0xDE14
310e 310e d 93e9
310e 310e s 	dw 	_CPM1__old_write+1
3110 3110 s 	endm
3110 3110 s 	dwstore	_CPM1__old_getinfo+1	,0xE574
3110 3110 d 54
3110 3110 s 	db 	pW_STORE
3111 3111 d 74e5
3111 3111 s 	dw 	0xE574
3113 3113 d a3e9
3113 3113 s 	dw 	_CPM1__old_getinfo+1
3115 3115 s 	endm
3115 3115 s 	dbpatch	0xE5B4		,0x21	,0x21
3115 3115 d 52
3115 3115 s 	db 	pB_CHK_PATCH
3116 3116 d b4e5
3116 3116 s 	dw 	0xE5B4
3118 3118 d 2121
3118 3118 s 	db 	0x21,0x21
311a 311a s 	endm
311a 311a s 	dwpatch	0xE5B4+1 	,0xE5E4	,0xE5E4
311a 311a d 51
311a 311a s 	db 	pW_CHK_PATCH
311b 311b d b5e5
311b 311b s 	dw 	0xE5B4+1
311d 311d d e4e5e4e5
311d 311d s 	dw 	0xE5E4,0xE5E4
3121 3121 s 	endm
3121 3121 s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE5B4
3121 3121 d 54
3121 3121 s 	db 	pW_STORE
3122 3122 d b4e5
3122 3122 s 	dw 	0xE5B4
3124 3124 d a0e9
3124 3124 s 	dw 	_CPM1__old_getinfo_chkdo+1
3126 3126 s 	endm
3126 3126 s 	dwstore	_CPM1_r_p_DSK1+1	,0xDF88 	;read
3126 3126 d 54
3126 3126 s 	db 	pW_STORE
3127 3127 d 88df
3127 3127 s 	dw 	0xDF88
3129 3129 d 1ce9
3129 3129 s 	dw 	_CPM1_r_p_DSK1+1
312b 312b s 	endm
312b 312b s 	dwstore	_CPM1_r_p_TRK1+1	,0xDF8C 	
312b 312b d 54
312b 312b s 	db 	pW_STORE
312c 312c d 8cdf
312c 312c s 	dw 	0xDF8C
312e 312e d 37e9
312e 312e s 	dw 	_CPM1_r_p_TRK1+1
3130 3130 s 	endm
3130 3130 s 	dwstore	_CPM1_r_p_SEC1+1	,0xDF8D 	
3130 3130 d 54
3130 3130 s 	db 	pW_STORE
3131 3131 d 8ddf
3131 3131 s 	dw 	0xDF8D
3133 3133 d 3de9
3133 3133 s 	dw 	_CPM1_r_p_SEC1+1
3135 3135 s 	endm
3135 3135 s 	dwstore	_CPM1_r_p_DMA1+1	,0xDF8E 	
3135 3135 d 54
3135 3135 s 	db 	pW_STORE
3136 3136 d 8edf
3136 3136 s 	dw 	0xDF8E
3138 3138 d 4ee9
3138 3138 s 	dw 	_CPM1_r_p_DMA1+1
313a 313a s 	endm
313a 313a s 	dwstore	_CPM1_r_p_DSK2+1	,0xDF88 	;write
313a 313a d 54
313a 313a s 	db 	pW_STORE
313b 313b d 88df
313b 313b s 	dw 	0xDF88
313d 313d d 59e9
313d 313d s 	dw 	_CPM1_r_p_DSK2+1
313f 313f s 	endm
313f 313f s 	dwstore	_CPM1_r_p_TRK2+1	,0xDF8C 	
313f 313f d 54
313f 313f s 	db 	pW_STORE
3140 3140 d 8cdf
3140 3140 s 	dw 	0xDF8C
3142 3142 d 74e9
3142 3142 s 	dw 	_CPM1_r_p_TRK2+1
3144 3144 s 	endm
3144 3144 s 	dwstore	_CPM1_r_p_SEC2+1	,0xDF8D 	
3144 3144 d 54
3144 3144 s 	db 	pW_STORE
3145 3145 d 8ddf
3145 3145 s 	dw 	0xDF8D
3147 3147 d 7ae9
3147 3147 s 	dw 	_CPM1_r_p_SEC2+1
3149 3149 s 	endm
3149 3149 s 	dwstore	_CPM1_r_p_DMA2+1	,0xDF8E 	
3149 3149 d 54
3149 3149 s 	db 	pW_STORE
314a 314a d 8edf
314a 314a s 	dw 	0xDF8E
314c 314c d 8be9
314c 314c s 	dw 	_CPM1_r_p_DMA2+1
314e 314e s 	endm
314e 314e s 	dwstore	_CPM1_r_p_DSK3+1	,0xDF88 	;readinfo
314e 314e d 54
314e 314e s 	db 	pW_STORE
314f 314f d 88df
314f 314f s 	dw 	0xDF88
3151 3151 d 28ea
3151 3151 s 	dw 	_CPM1_r_p_DSK3+1
3153 3153 s 	endm
3153 3153 s 
3153 3153 s 	stop 'CPM_12_88_3_niijaf'
3153 3153 d 50
3153 3153 s 	db 	p_STOP
3154 3154 d 43504d5f31325f38385f335f6e69696a6166
3154 3154 s 	db 	'CPM_12_88_3_niijaf'
3166 3166 d 00
3166 3166 s 	db 	0
3167 3167 s 	endm
3167 3167 f out/include-patcher.asm
3167 3167 s 	include "generator/V0/out/patcher-cpm1-CPM_21_89___wiza.asm"	; 42 images in collection
3167 3167 f generator/V0/out/patcher-cpm1-CPM_21_89___wiza.asm
3167 3167 s _BIOS_CPM_21_89___wiza:
3167 3167 s 	setSUBBIOS 1
3167 3167 d 5a
3167 3167 s 	db	pSubBios
3168 3168 d 01
3168 3168 s 	db 	1
3169 3169 s 	endm
3169 3169 s 
3169 3169 s 	;адресса актуальные для биоса 21_89___wiza
3169 3169 s 
3169 3169 s 	;BIOS_LOGO 		=> "0xDAEE",
3169 3169 s 	;PPI2C_BIOS_IIT 	=> "0xE49F",
3169 3169 s 	;DRVREG_A 		=> "0xDAA0",
3169 3169 s 	;DRVREG_B 		=> "0xDA90",
3169 3169 s 	;DRVREG_C 		=> "0xDAB7",
3169 3169 s 	;DRVREG_D 		=> "0xDACE",
3169 3169 s 	;SELDSK_STOREDRV	=> "0xE70A",
3169 3169 s 	;SELDSK_ADDR		=> "0xDC8D",
3169 3169 s 	;CURRENT_DISKPTR   	=> "0xE06E",
3169 3169 s 	;BIOS_READ 		=> "0xDCEB",
3169 3169 s 	;BIOS_WRITE 		=> "0xDEAF",
3169 3169 s 	;SELDSK_GETINO_CALL	=> "0xdcbf",
3169 3169 s 	;BIOS_GETINFO		=> "0xE648",
3169 3169 s 	;WBOOT_READ_CLL 	=> "0xDB84",
3169 3169 s 	;GETINFO_POSTTOM_ADDR 	=> "0xE67F",
3169 3169 s 	;GETINFO_POSTTOM_CHKW 	=> "0xE6AF",
3169 3169 s 	;BIOS_VAR_DSK		=> "0xE064",
3169 3169 s 	;BIOS_VAR_SEC		=> "0xE068",
3169 3169 s 	;BIOS_VAR_TRK		=> "0xE069",
3169 3169 s 	;BIOS_VAR_DMA		=> "0xE06A",
3169 3169 s 	;VINTKBDADDR 		=> "0xe3e3",
3169 3169 s 	;VINTKBDVALUE		=> "0xdc46",
3169 3169 s 	;KBD_HOOK_PRO 		=> "kbd_hook_2133",
3169 3169 s 	;NAME 			=> '21_89___wiza',
3169 3169 s 
3169 3169 s 	;Чекер/Патчер
3169 3169 s 	;есть три основных комманды
3169 3169 s 	;dbpatch addr oldbyte newbyte
3169 3169 s 	;dwpatch addr oldword newword
3169 3169 s 	;dwstore addr newword
3169 3169 s 	;и ряд вспомогательных
3169 3169 s 	;setCPM
3169 3169 s 	;setMICRODOS
3169 3169 s 	;checkOPTS1
3169 3169 s 	;checkOPTS2
3169 3169 s 	;unsupported
3169 3169 s 	;pSTOP 'biosname'
3169 3169 s 
3169 3169 s 	;на первом этапе патчер проверяет что в памяти именно этот биос
3169 3169 s 	;для этого он проходтся по d(b|w)patch и проверяет 
3169 3169 s 	;что по адрессу addr записано значени old(byte|word)
3169 3169 s 
3169 3169 s 	;если это не так (т.е. на первой же проверке которая не прошла)
3169 3169 s 	;то считаем что биос не соответсвует проверяемому и надо пробовать следующий
3169 3169 s 
3169 3169 s 	;если же все проверки прошли - то запускается второй проход
3169 3169 s 	;правим значения в памяти (собственно patch)
3169 3169 s 	;т.е для d(b|w)patch по addr записывается значение new(byte|word)
3169 3169 s 	;для dwstore просто по адрессу addr записывается newword
3169 3169 s 
3169 3169 s 	;если old = new - то это просто проверка, т.к. значение не изменяется
3169 3169 s 
3169 3169 s 	RQ_OPTS_ANY
3169 3169 s 	endm
3169 3169 s 
3169 3169 s 	;
3169 3169 s 	;ниже описан "TEMPLATE" для поддержки CP/M BIOS
3169 3169 s 	;все примеры кода ниже взяты для биоса '21_89___wiza'
3169 3169 s 	;
3169 3169 s 	;я попробую возле каждого параметра описать откуда он получен
3169 3169 s 	;если вдруг будет необходимость расширить набор поддерживаемых
3169 3169 s 	;bios.
3169 3169 s 	;на сегодня поддерживается 13 уникальных CP/M bios для Корвета
3169 3169 s 	;под "уникальными" понимается разные биосы, в которых отличается код
3169 3169 s 	;во времена когда использовали Корвет было нормально править биос прямо на дискете
3169 3169 s 	;обычно правили функциональные клавиши, таблицы перекодировки принтера
3169 3169 s 	;и надписи ;)
3169 3169 s 	;по этой причине разно выглядящие биосы могут быть одинаковыми внутри
3169 3169 s 	;предварительный анализ позволил выделить 13 уникальных биосов среди сотен дискет
3169 3169 s 	;что сильно упростило дальнейшую работу.
3169 3169 s 	;
3169 3169 s 	;patcher же делает необходимое кол-во проверок и изменений биоса
3169 3169 s 	;чтобы подготовить его к работе с EXTROM API
3169 3169 s 	;
3169 3169 s 	;значения вида CPM_21_89___wiza должны быть заменены на значения
3169 3169 s 	;соотвествующие конкретному биосу
3169 3169 s 
3169 3169 s 	;Lets go
3169 3169 s 
3169 3169 s 	;установим тип системы CP/M (нужно для случая когда биос опознан но не может быть использован)
3169 3169 s 	;в случае с cp/m это важно для '1x_88_EPSON_V104'	'1x_89_03_30_RAVI'
3169 3169 s 	;они работают только с ОПТС 1
3169 3169 s 	;и по этой причине на ОПТС 2 надо fallback to default CP/M
3169 3169 s 	setCPM
3169 3169 s 	endm
3169 3169 s 
3169 3169 s 	;BIOS_LOGO--------------------------------------------------------------
3169 3169 s 	;косметика,  
3169 3169 s 	;Биос при старте очищает экран, мы патчим его чтобы он это не делал
3169 3169 s 	;иначе он затрёт все сообщения патчера, а там много полезной информации
3169 3169 s 	;выгядит это в коде так
3169 3169 s 	
3169 3169 s 	;RAM:DA00          _BOOT:
3169 3169 s 	;RAM:DA00 C3 42 DB                 jp      j_BOOT
3169 3169 s 	;....
3169 3169 s 	;RAM:DB42          j_BOOT:                                 
3169 3169 s 	;RAM:DB42 F3                       di
3169 3169 s 	;RAM:DB43 31 80 00                 ld      sp, 80h 
3169 3169 s 	;RAM:DB46 3E 1C                    ld      a, 1Ch
3169 3169 s 	;RAM:DB48 32 7F FA                 ld      (_1C_SysReg1C), a
3169 3169 s 	;...
3169 3169 s 	;RAM:DB58 21 EE DA                 ld      hl, BIOS_LOGO   ; "\\x1F\\r\\nCP/M-80  vers. 2.2"
3169 3169 s 	;RAM:DB5B CD 2D E0                 call    putstr
3169 3169 s 	;...
3169 3169 s 	;RAM:DAEE 1F 0D 0A+BIOS_LOGO:      text "KOI8-R", '\\x1F\\r\\n'
3169 3169 s 	;RAM:DAEE 43 50 2F+                text "KOI8-R", 'CP/M-80  vers. 2.2 \\r\\n'
3169 3169 s 	;RAM:DAEE 4D 2D 38+                text "KOI8-R", 'BIOS  vers.2.1 (c) \\r\\n'
3169 3169 s 	;RAM:DAEE 30 20 20+                text "KOI8-R", 'МГУ н/п кооп."ВИЗА"\\r\\n'
3169 3169 s 	;RAM:DAEE 76 65 72+                text "KOI8-R", '   МОСКВА 1989 \\r\\n'
3169 3169 s 	;RAM:DAEE 73 2E 20+                text "KOI8-R", 0
3169 3169 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
3169 3169 d 59
3169 3169 s 	db 	pB_MAYBE_PATCH
316a 316a d eeda
316a 316a s 	dw 	0xDAEE
316c 316c d 1f0d
316c 316c s 	db 	0x1F,0x0d
316e 316e s 	endm
316e 316e s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
316e 316e d 59
316e 316e s 	db 	pB_MAYBE_PATCH
316f 316f d f0da
316f 316f s 	dw 	0xDAEE+2
3171 3171 d 0a0d
3171 3171 s 	db 	0x0a,0x0d
3173 3173 s 	endm
3173 3173 s 
3173 3173 s 	;PPI2C_BIOS_INIT--------------------------------------------------------
3173 3173 s 	;Биос при старте производит инициализацию перифирии, разных контроллеров
3173 3173 s 	;в том числе записывает значение 0x49 в порт PPI2.C 
3173 3173 s 	;(разрешаем вывод звука, ~SE, ResetForJoy)
3173 3173 s 	;для нас важно что тут он сбрабсывает PPI2.C.8 (ENABLE EXTROM)
3173 3173 s 	;без которого наш контроллер не работает.
3173 3173 s 	;мы модифицируем это значение чтобы бит8 был установлен 0x49 -> 0xC9 
3173 3173 s 	;выгядит это в коде так
3173 3173 s 	;нас интересует адресс E49F
3173 3173 s 
3173 3173 s 	;RAM:DA00          _BOOT:
3173 3173 s 	;RAM:DA00 C3 42 DB                 jp      j_BOOT
3173 3173 s 	;....
3173 3173 s 	;RAM:DB42          j_BOOT:                                 
3173 3173 s 	;RAM:DB42 F3                       di
3173 3173 s 	;RAM:DB43 31 80 00                 ld      sp, 80h ; 'Ç'
3173 3173 s 	;RAM:DB46 3E 1C                    ld      a, 1Ch
3173 3173 s 	;RAM:DB48 32 7F FA                 ld      (_1C_SysReg1C), a
3173 3173 s 	;RAM:DB4E CD 0A E4                 call    HW_Init
3173 3173 s 	;...
3173 3173 s 	;RAM:E40A          HW_Init:                                
3173 3173 s 	;RAM:E40A                                                  
3173 3173 s 	;RAM:E40A F3                       di
3173 3173 s 	;RAM:E40B 11 D1 E3                 ld      de, IntstINTAB
3173 3173 s 	;RAM:E40E 21 C6 F7                 ld      hl, _xVTRAP
3173 3173 s 	;RAM:E411 01 3A 00                 ld      bc, 58
3173 3173 s 	;RAM:E414 CD 3A E0                 call    _LDIR
3173 3173 s 	;...
3173 3173 s 	;RAM:E495 3E FF                    ld      a, 0FFh
3173 3173 s 	;RAM:E497 32 31 F7                 ld      (SndFlag), a    ; flag key click (0 - no click)
3173 3173 s 	;RAM:E49A 3E 02                    ld      a, 2
3173 3173 s 	;RAM:E49C 32 2E F7                 ld      (F_Alft), a     ; 0 - russian
3173 3173 s 	;RAM:E49F 3E 49                    ld      a, 49h ; 'I'
3173 3173 s 	;RAM:E4A1 32 32 FB                 ld      (_1C_PPI2C_), a
3173 3173 s 	;RAM:E4A4 C9                       ret
3173 3173 s 	dbpatch	0xE49F+1	,0x49	,0xc9
3173 3173 d 52
3173 3173 s 	db 	pB_CHK_PATCH
3174 3174 d a0e4
3174 3174 s 	dw 	0xE49F+1
3176 3176 d 49c9
3176 3176 s 	db 	0x49,0xc9
3178 3178 s 	endm
3178 3178 s 
3178 3178 s 	;DRVREG_x---------------------------------------------------------------
3178 3178 s 	;DRVREG_A,DRVREG_B,DRVREG_C,DRVREG_D
3178 3178 s 	;драйверу дисковода необходимо знать какой логичесской букве соответствует какой диск
3178 3178 s 	;для этой цели мы используем байт который в оригинальном CP/M BIOS указывает
3178 3178 s 	;какое значение надо записать в DRVREG чтобы выбрать данный диск
3178 3178 s 	;это даёт возможность использовать и эмулятор и настоящие диски.
3178 3178 s 	;в нашем биосе если этот байт =0 то этот диск работает через EXTROM API
3178 3178 s 	;если же там не 0 то это физичесский диск.
3178 3178 s 	;эти значения также использует утилита MOUNT которая позволяет изменить это соответсвие
3178 3178 s 	;и подключить нужный образ диска к нужному дисководу.
3178 3178 s 	;по умолчанию 
3178 3178 s 	;при наличии дисковода
3178 3178 s 	;A: -> эмулятор образ disk/DISKA.KDI
3178 3178 s 	;B: -> эмулятор образ disk/DISKB.KDI
3178 3178 s 	;C: -> физичесский дисковод A:
3178 3178 s 	;D: -> физичесский дисковод B:
3178 3178 s 	;или при отсутствии дисковода
3178 3178 s 	;A: -> эмулятор образ disk/DISKA.KDI
3178 3178 s 	;B: -> эмулятор образ disk/DISKB.KDI
3178 3178 s 	;C: -> эмулятор образ disk/DISKC.KDI
3178 3178 s 	;D: -> эмулятор образ disk/DISKD.KDI
3178 3178 s 
3178 3178 s 	;этот адресс можно найти так (это справедливо для всех известных CP/M биосов)
3178 3178 s 	;для каждого диска в биосе есть таблица DPH (Disk Parameter Header)
3178 3178 s 	;в этой таблице по смещению +0x0A находится адрес DPB (Disk Parameter Block)
3178 3178 s 	;интересующий нас байт находится по адрессу DPH-2
3178 3178 s 	;звучит сложно, но на практике всё просто.
3178 3178 s 	;найти DPH для всех дисков можно достаточно просто
3178 3178 s 	;есть вызов биоса SELDSK (0xDA1B)
3178 3178 s 	;иначе он попытается сделает операцию "Выбор диска" для указанного в регистре C диска
3178 3178 s 	;а для этого ему надо получить параметры диска для своих целей
3178 3178 s 	;а мы этим и воспользуемся
3178 3178 s 	;в коде ниже по адрессу 0xDC99
3178 3178 s 	;собственно тут нас интересует ссылка на таблицу DPH_TABLE
3178 3178 s 	;в которой и есть ссылки на DPH для дисков (0xDCCC)
3178 3178 s 	;A-DA33,B-DA43,etc
3178 3178 s 	;RAM:DC8D          j_SELDSK:                               
3178 3178 s 	;RAM:DC8D 79                       ld      a, c
3178 3178 s 	;RAM:DC8E FE FF                    cp      0FFh
3178 3178 s 	;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
3178 3178 s 	;RAM:DC93 C8                       ret     z
3178 3178 s 	;RAM:DC94 FE 08                    cp      8
3178 3178 s 	;RAM:DC96 D2 C4 DC                 jp      nc, loc_DCC4
3178 3178 s 	;RAM:DC99 21 CC DC                 ld      hl, DPH_TABLE
3178 3178 s 	;RAM:DC9C 32 64 E0                 ld      (_DSK), a
3178 3178 s 	;....
3178 3178 s 	;RAM:DCCC 33 DA    DPH_TABLE:      dw dph_a                ; DATA XREF: j_SELDSK+Co
3178 3178 s 	;RAM:DCCE 43 DA                    dw dph_b
3178 3178 s 	;RAM:DCD0 53 DA                    dw dph_c
3178 3178 s 	;RAM:DCD2 63 DA                    dw dph_d
3178 3178 s 	;RAM:DCD4 73 DA                    dw dph_e
3178 3178 s 	;RAM:DCD6 00 00                    dw loc_0
3178 3178 s 	;RAM:DCD8 00 00                    dw loc_0
3178 3178 s 	;RAM:DCDA 00 00                    dw loc_0
3178 3178 s 	;...
3178 3178 s 
3178 3178 s 	;DPH             struc ; (sizeof=0x10)
3178 3178 s 	;_XLT:           dw ?
3178 3178 s 	;_1:             dw ?
3178 3178 s 	;_2:             dw ?
3178 3178 s 	;_3:             dw ?
3178 3178 s 	;DirBuf:         dw ?                    ; offset (00000000)
3178 3178 s 	;DPB:            dw ?                    ; offset (00000000)
3178 3178 s 	;CSV:            dw ?                    ; offset (00000000)
3178 3178 s 	;ALV:            dw ?                    ; offset (00000000)
3178 3178 s 	;DPH             ends
3178 3178 s 
3178 3178 s 	;RAM:DA33 00 00 03+dph_a:          DPH <0, 3, 0, 0, dirBUF, dpbA, csvA, alwA>
3178 3178 s 	;RAM:DA43 00 00 00+dph_b:          DPH <0, 0, 0, 0, dirBUF, dpbB, csvB, alwB>
3178 3178 s 	;RAM:DA53 00 00 00+dph_c:          DPH <0, 0, 0, 0, dirBUF, dpbC, csvC, alwC>
3178 3178 s 	;RAM:DA63 00 00 00+dph_d:          DPH <0, 0, 0, 0, dirBUF, dpbD, csvD, alwD>
3178 3178 s 	;RAM:DA73 00 00 00+dph_e:          DPH <0, 0, 0, 0, dirBUF, dpbE, loc_0, alwE>
3178 3178 s 	;RAM:DA83 50                       db  50h ; P
3178 3178 s 	;RAM:DA84 80                       db  80h ; Ç
3178 3178 s 	;RAM:DA85 05                       db    5
3178 3178 s 	;RAM:DA86 01                       db    1
3178 3178 s 	;RAM:DA87 03                       db    3
3178 3178 s 	;RAM:DA88 01                       db    1
3178 3178 s 	;RAM:DA89 01       unk_DA89:       db    1                 
3178 3178 s 	;RAM:DA8A FF       			       db 0FFh                 
3178 3178 s 	;RAM:DA8B 28 00 04+dpbA:           DPB <28h, 4, 0Fh, 0, 18Ah, 7Fh, 0C0h, 0, 20h, 2>
3178 3178 s 	;
3178 3178 s 	;собственно по адрессу DPB_A-2 и находится интересующая нас ячейка для диска A
3178 3178 s 	;для остальных дисков - аналогично
3178 3178 s 	;для физичесского дисковода A там значение 1
3178 3178 s 	;для физичесского дисковода B там значение 2
3178 3178 s 	;для физичесского дисковода C там значение 4
3178 3178 s 	;для физичесского дисковода D там значение 8
3178 3178 s 	;0 будет означать эмуляцию
3178 3178 s 
3178 3178 s 	dbpatch	0xDA89 	,0x01	,0x00
3178 3178 d 52
3178 3178 s 	db 	pB_CHK_PATCH
3179 3179 d 89da
3179 3179 s 	dw 	0xDA89
317b 317b d 0100
317b 317b s 	db 	0x01,0x00
317d 317d s 	endm
317d 317d s 	dbpatch	0xDAA0 	,0x02	,0x00
317d 317d d 52
317d 317d s 	db 	pB_CHK_PATCH
317e 317e d a0da
317e 317e s 	dw 	0xDAA0
3180 3180 d 0200
3180 3180 s 	db 	0x02,0x00
3182 3182 s 	endm
3182 3182 s 	dbpatch	0xDAB7 	,0x04	,0x01
3182 3182 d 52
3182 3182 s 	db 	pB_CHK_PATCH
3183 3183 d b7da
3183 3183 s 	dw 	0xDAB7
3185 3185 d 0401
3185 3185 s 	db 	0x04,0x01
3187 3187 s 	endm
3187 3187 s 	dbpatch	0xDACE 	,0x08	,0x02
3187 3187 d 52
3187 3187 s 	db 	pB_CHK_PATCH
3188 3188 d ceda
3188 3188 s 	dw 	0xDACE
318a 318a d 0802
318a 318a s 	db 	0x08,0x02
318c 318c s 	endm
318c 318c s 
318c 318c s 	;для нормальной работы MOUNT в биос добавлена новая подфункция - получить таблицу
318c 318c s 	;адресов DRVREGxx
318c 318c s 	;call SELDSK с C=0xFE, которая возвращает указатель на таблицу с адресами DRVTRG_X
318c 318c s 	;собтвенно готовим эту таблицу используя уже исзвестные нам данные
318c 318c s 	;сохраняя адреса в таблицу внутри кода "резедента".
318c 318c s 
318c 318c s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
318c 318c d 54
318c 318c s 	db 	pW_STORE
318d 318d d 89da
318d 318d s 	dw 	0xDA89
318f 318f d ace8
318f 318f s 	dw 	_CPM1_res_DRIVE_TAB+0*2
3191 3191 s 	endm
3191 3191 s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
3191 3191 d 54
3191 3191 s 	db 	pW_STORE
3192 3192 d a0da
3192 3192 s 	dw 	0xDAA0
3194 3194 d aee8
3194 3194 s 	dw 	_CPM1_res_DRIVE_TAB+1*2
3196 3196 s 	endm
3196 3196 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
3196 3196 d 54
3196 3196 s 	db 	pW_STORE
3197 3197 d b7da
3197 3197 s 	dw 	0xDAB7
3199 3199 d b0e8
3199 3199 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
319b 319b s 	endm
319b 319b s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
319b 319b d 54
319b 319b s 	db 	pW_STORE
319c 319c d ceda
319c 319c s 	dw 	0xDACE
319e 319e d b2e8
319e 319e s 	dw 	_CPM1_res_DRIVE_TAB+3*2
31a0 31a0 s 	endm
31a0 31a0 s 
31a0 31a0 s 
31a0 31a0 s 	;DPH_TABLE-----------------------------------------------------
31a0 31a0 s 	;добавляем поддержку диска F - образа с утилитами
31a0 31a0 s 	;как найти DPH_TABLE см выше
31a0 31a0 s 	dwpatch 0xDCCC+5*2 	,0x0000 ,_CPM1_dph_F
31a0 31a0 d 51
31a0 31a0 s 	db 	pW_CHK_PATCH
31a1 31a1 d d6dc
31a1 31a1 s 	dw 	0xDCCC+5*2
31a3 31a3 d 0000b8e8
31a3 31a3 s 	dw 	0x0000,_CPM1_dph_F
31a7 31a7 s 	endm
31a7 31a7 s 
31a7 31a7 s 	dwstore _CPM1_dph_F+8	,0xEBA6
31a7 31a7 d 54
31a7 31a7 s 	db 	pW_STORE
31a8 31a8 d a6eb
31a8 31a8 s 	dw 	0xEBA6
31aa 31aa d c0e8
31aa 31aa s 	dw 	_CPM1_dph_F+8
31ac 31ac s 	endm
31ac 31ac s 
31ac 31ac s 	;SELDSK_ADDR------------------------------------------------------------
31ac 31ac s 	;и модифицируем вызов SELDSK чтобы он поддерживал дополнительную проверку
31ac 31ac s 	;модифицируем оригинальный перехо в SELDSK чтобы он переходил на наш код	
31ac 31ac s 	;и сохраняем старый адресс (в данном коде нужный нам адресс 0xDCB6)
31ac 31ac s 	;RAM:DA1B          _SELDSK:                         ; IN: C
31ac 31ac s 	;RAM:DA1B C3 B6 DC          jp      __SELDSK        ; OUT: HL-DPB/0, HL=xVTRAP0 if c=0xff
31ac 31ac s 
31ac 31ac s 	dwpatch 0xDA1B+1 	,0xDC8D	,_CPM1_res_seldsk
31ac 31ac d 51
31ac 31ac s 	db 	pW_CHK_PATCH
31ad 31ad d 1cda
31ad 31ad s 	dw 	0xDA1B+1
31af 31af d 8ddc11e9
31af 31af s 	dw 	0xDC8D,_CPM1_res_seldsk
31b3 31b3 s 	endm
31b3 31b3 s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC8D
31b3 31b3 d 54
31b3 31b3 s 	db 	pW_STORE
31b4 31b4 d 8ddc
31b4 31b4 s 	dw 	0xDC8D
31b6 31b6 d 15e9
31b6 31b6 s 	dw 	_CPM1_old_seld_dsk+1
31b8 31b8 s 	endm
31b8 31b8 s 
31b8 31b8 s 	;SELDSK_STORE_DRV-------------------------------------------------------
31b8 31b8 s 	;в процессе работы SELDSK биос вызывает функцию GETINFO которая читает параметры диска
31b8 31b8 s 	;из первого сектора.
31b8 31b8 s 	;в процессе рабты она перезаписывает значение байта DRVREG_x
31b8 31b8 s 	;затрём эту комманду 
31b8 31b8 s 	;в примере ниже E70A 77 ld (hl), a - записав NOP на ее место.
31b8 31b8 s 
31b8 31b8 s 	;RAM:DC8D          j_SELDSK:                               
31b8 31b8 s 	;RAM:DC8D                                                  
31b8 31b8 s 	;RAM:DC8D 79                       ld      a, c
31b8 31b8 s 	;RAM:DC8E FE FF                    cp      0FFh
31b8 31b8 s 	;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
31b8 31b8 s 	;RAM:DC93 C8                       ret     z
31b8 31b8 s 	;...
31b8 31b8 s 	;RAM:DCBB 22 6E E0                 ld      (off_E06E), hl
31b8 31b8 s 	;RAM:DCBE 3C                       inc     a
31b8 31b8 s 	;RAM:DCBF C4 48 E6                 call    nz, GETINFO
31b8 31b8 s 	;RAM:DCC2 E1                       pop     hl
31b8 31b8 s 	;RAM:DCC3 C8                       ret     z
31b8 31b8 s 	;...
31b8 31b8 s 	;RAM:E648          GETINFO:                                
31b8 31b8 s 	;RAM:E648 E5                       push    hl
31b8 31b8 s 	;RAM:E649 CD 4E DF                 call    sub_DF4E
31b8 31b8 s 	;RAM:E64C E1                       pop     hl
31b8 31b8 s 	;...
31b8 31b8 s 	;RAM:E703          loc_E703:                               
31b8 31b8 s 	;RAM:E703 E1                       pop     hl
31b8 31b8 s 	;RAM:E704 E5                       push    hl
31b8 31b8 s 	;RAM:E705 3A 39 FB                 ld      a, (_1C_PPI1B_DrvReg)
31b8 31b8 s 	;RAM:E708 E6 CF                    and     ~_SIDE1|_MOTOR
31b8 31b8 s 	;RAM:E70A 77                       ld      (hl), a
31b8 31b8 s 	;RAM:E70B 23                       inc     hl
31b8 31b8 s 	;RAM:E70C 36 FF                    ld      (hl), 0FFh
31b8 31b8 s 	;RAM:E70E 23                       inc     hl
31b8 31b8 s 
31b8 31b8 s 	dbpatch	0xE70A	,0x77	,0x00
31b8 31b8 d 52
31b8 31b8 s 	db 	pB_CHK_PATCH
31b9 31b9 d 0ae7
31b9 31b9 s 	dw 	0xE70A
31bb 31bb d 7700
31bb 31bb s 	db 	0x77,0x00
31bd 31bd s 	endm
31bd 31bd s 
31bd 31bd s 	;CURRENT_DISK_PTR-------------------------------------------------------
31bd 31bd s 	;нашему резиденту для операций чтения и записи нужно знать к какому диску идёт обращение
31bd 31bd s 	;и надо ли подменять обращение к эмулятору
31bd 31bd s 	;у биоса есть переменная которая указывает на DRVREG_x для текушего диска
31bd 31bd s 	;резидент читает из этого адресса и смотрит надо ли эмулировать диск
31bd 31bd s 	;собственно в коде ниже по адрессу 0xDCBB комманда которая сохраняет в нужную нам переменную
31bd 31bd s 	;ld      (off_E06E), hl
31bd 31bd s 	;т.е. нужный нам адресс 0xE06E
31bd 31bd s 
31bd 31bd s 	;RAM:DC8D          j_SELDSK:                               
31bd 31bd s 	;RAM:DC8D                                                  
31bd 31bd s 	;RAM:DC8D 79                       ld      a, c
31bd 31bd s 	;RAM:DC8E FE FF                    cp      0FFh
31bd 31bd s 	;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
31bd 31bd s 	;RAM:DC93 C8                       ret     z
31bd 31bd s 	;...
31bd 31bd s 	;RAM:DCBB 22 6E E0                 ld      (off_E06E), hl
31bd 31bd s 	;RAM:DCBE 3C                       inc     a
31bd 31bd s 	;RAM:DCBF C4 48 E6                 call    nz, GETINFO
31bd 31bd s 
31bd 31bd s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE06E
31bd 31bd d 54
31bd 31bd s 	db 	pW_STORE
31be 31be d 6ee0
31be 31be s 	dw 	0xE06E
31c0 31c0 d 2ee9
31c0 31c0 s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
31c2 31c2 s 	endm
31c2 31c2 s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE06E
31c2 31c2 d 54
31c2 31c2 s 	db 	pW_STORE
31c3 31c3 d 6ee0
31c3 31c3 s 	dw 	0xE06E
31c5 31c5 d 6be9
31c5 31c5 s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
31c7 31c7 s 	endm
31c7 31c7 s 
31c7 31c7 s 
31c7 31c7 s 	;CURRENT_DISK_PTR-------------------------------------------------------
31c7 31c7 s 	;патчим адресса в основной таблицк BIOS для READ и WRITE
31c7 31c7 s 	;теперь они указывают на наш "резидент"
31c7 31c7 s 
31c7 31c7 s 	;RAM:DA27          _READ:                                  
31c7 31c7 s 	;RAM:DA27 C3 EB DC                 jp      j_READ
31c7 31c7 s 	;RAM:DA2A          _WRITE:                                 
31c7 31c7 s 	;RAM:DA2A C3 AF DE                 jp      j_WRITE
31c7 31c7 s 
31c7 31c7 s 	dwpatch	0xDA27+1	,0xDCEB	,_CPM1_res_READ
31c7 31c7 d 51
31c7 31c7 s 	db 	pW_CHK_PATCH
31c8 31c8 d 28da
31c8 31c8 s 	dw 	0xDA27+1
31ca 31ca d ebdc1be9
31ca 31ca s 	dw 	0xDCEB,_CPM1_res_READ
31ce 31ce s 	endm
31ce 31ce s 	dwpatch	0xDA2A+1	,0xDEAF	,_CPM1_res_WRITE
31ce 31ce d 51
31ce 31ce s 	db 	pW_CHK_PATCH
31cf 31cf d 2bda
31cf 31cf s 	dw 	0xDA2A+1
31d1 31d1 d afde58e9
31d1 31d1 s 	dw 	0xDEAF,_CPM1_res_WRITE
31d5 31d5 s 	endm
31d5 31d5 s 
31d5 31d5 s 	;WBOOT_READ_CALL--------------------------------------------------------
31d5 31d5 s 	;биосовоский wboot напрямую делает вызов READ
31d5 31d5 s 	;патчим его тоже
31d5 31d5 s 	;RAM:DB5E          j_WBOOT:                                
31d5 31d5 s 	;RAM:DB5E                                                  
31d5 31d5 s 	;RAM:DB5E F3                       di
31d5 31d5 s 	;RAM:DB5F 31 80 00                 ld      sp, 80h ; 'Ç'
31d5 31d5 s 	;RAM:DB62 CD 0A E4                 call    HW_Init
31d5 31d5 s 	;...
31d5 31d5 s 	;RAM:DB80 C5                       push    bc
31d5 31d5 s 	;RAM:DB81 CD E5 DC                 call    j_SETDMA
31d5 31d5 s 	;RAM:DB84 CD EB DC                 call    j_READ
31d5 31d5 s 	;RAM:DB87 B7                       or      a
31d5 31d5 s 	;RAM:DB88 C2 5E DB                 jp      nz, j_WBOOT
31d5 31d5 s 
31d5 31d5 s 	dwpatch	0xDB84+1	,0xDCEB	,_CPM1_res_READ
31d5 31d5 d 51
31d5 31d5 s 	db 	pW_CHK_PATCH
31d6 31d6 d 85db
31d6 31d6 s 	dw 	0xDB84+1
31d8 31d8 d ebdc1be9
31d8 31d8 s 	dw 	0xDCEB,_CPM1_res_READ
31dc 31dc s 	endm
31dc 31dc s 
31dc 31dc s 	;SELDSK_GETINFO_CALL------------------------------------------------------------------------
31dc 31dc s 	;внутри  SELDSK есть вызов GETINFO
31dc 31dc s 	;используется для чтения параметров диска с нового диска
31dc 31dc s 	;мы его перехватываем, и для дисково которые работают через EXTROM API
31dc 31dc s 	;делаем сами его функции (частично)
31dc 31dc s 	;для физичесских дисков работает оригинальный код
31dc 31dc s 	;причина в том, что GETINFO обращается к диску напрямую, а нас это не устраивает
31dc 31dc s 	;в примере ниже это адресс DCBF
31dc 31dc s 
31dc 31dc s 	;RAM:DC8D          j_SELDSK:                               
31dc 31dc s 	;RAM:DC8D                                                  
31dc 31dc s 	;RAM:DC8D 79                       ld      a, c
31dc 31dc s 	;RAM:DC8E FE FF                    cp      0FFh
31dc 31dc s 	;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
31dc 31dc s 	;RAM:DC93 C8                       ret     z
31dc 31dc s 	;...
31dc 31dc s 	;RAM:DCBB 22 6E E0                 ld      (off_E06E), hl
31dc 31dc s 	;RAM:DCBE 3C                       inc     a
31dc 31dc s 	;RAM:DCBF C4 48 E6                 call    nz, GETINFO
31dc 31dc s 	;RAM:DCC2 E1                       pop     hl
31dc 31dc s 	;RAM:DCC3 C8                       ret     z
31dc 31dc s 
31dc 31dc s 	dwpatch	0xdcbf+1	,0xE648	,_CPM1_res_GETINFO
31dc 31dc d 51
31dc 31dc s 	db 	pW_CHK_PATCH
31dd 31dd d c0dc
31dd 31dd s 	dw 	0xdcbf+1
31df 31df d 48e695e9
31df 31df s 	dw 	0xE648,_CPM1_res_GETINFO
31e3 31e3 s 	endm
31e3 31e3 s 
31e3 31e3 s 	;BIOS_xxxx--------------------------------------------------------------
31e3 31e3 s 	;сохраняем в "резидет" адреса оригинальных функций
31e3 31e3 s 	;они вызываются если идёт обращение к физичесским дискам
31e3 31e3 s 
31e3 31e3 s 	dwstore	_CPM1__old_read+1	,0xDCEB
31e3 31e3 d 54
31e3 31e3 s 	db 	pW_STORE
31e4 31e4 d ebdc
31e4 31e4 s 	dw 	0xDCEB
31e6 31e6 d 56e9
31e6 31e6 s 	dw 	_CPM1__old_read+1
31e8 31e8 s 	endm
31e8 31e8 s 	dwstore	_CPM1__old_write+1	,0xDEAF
31e8 31e8 d 54
31e8 31e8 s 	db 	pW_STORE
31e9 31e9 d afde
31e9 31e9 s 	dw 	0xDEAF
31eb 31eb d 93e9
31eb 31eb s 	dw 	_CPM1__old_write+1
31ed 31ed s 	endm
31ed 31ed s 	dwstore	_CPM1__old_getinfo+1	,0xE648
31ed 31ed d 54
31ed 31ed s 	db 	pW_STORE
31ee 31ee d 48e6
31ee 31ee s 	dw 	0xE648
31f0 31f0 d a3e9
31f0 31f0 s 	dw 	_CPM1__old_getinfo+1
31f2 31f2 s 	endm
31f2 31f2 s 
31f2 31f2 s 	;-------------------------------------------------------------------------------
31f2 31f2 s 	;наш эмулятор GETINFO производит чтение первого сектора из образа диска
31f2 31f2 s 	;в буфер чтения, остальную работу делает сатарый код
31f2 31f2 s 	;т.е. мы читаем сектор в буффер и передаём управление на код который
31f2 31f2 s 	;проверяет результат успешности чтения, проверяе контролльную сумму сектора 
31f2 31f2 s 	;и готовит сектор к дальнейшей работе
31f2 31f2 s 	;в коде ниже это 0xE67F 
31f2 31f2 s 
31f2 31f2 s 	;RAM:E648          GETINFO:                                ; CODE XREF: j_SELDSK+32p
31f2 31f2 s 	;RAM:E648 E5                       push    hl
31f2 31f2 s 	;RAM:E649 CD 4E DF                 call    sub_DF4E
31f2 31f2 s 	;RAM:E64C E1                       pop     hl
31f2 31f2 s 	;RAM:E64D 22 6E E0                 ld      (off_E06E), hl
31f2 31f2 s 	;RAM:E650 E5                       push    hl
31f2 31f2 s 	;RAM:E651 7E                       ld      a, (hl)
31f2 31f2 s 	;RAM:E652 E6 0F                    and     0Fh
31f2 31f2 s 	;RAM:E654 32 70 E0                 ld      (byte_E070), a
31f2 31f2 s 	;RAM:E657 AF                       xor     a
31f2 31f2 s 	;RAM:E658 32 71 E0                 ld      (byte_E071), a
31f2 31f2 s 	;RAM:E65B 3C                       inc     a
31f2 31f2 s 	;RAM:E65C 32 72 E0                 ld      (byte_E072), a
31f2 31f2 s 	;RAM:E65F 21 6E E0                 ld      hl, off_E06E
31f2 31f2 s 	;RAM:E662 CD D3 DF                 call    sub_DFD3
31f2 31f2 s 	;RAM:E665 21 00 EE                 ld      hl, RD_BUF
31f2 31f2 s 	;RAM:E668 CD 9A E7                 call    DTOM
31f2 31f2 s 	;RAM:E66B CA 85 E6                 jp      z, CHKDO
31f2 31f2 s 	;RAM:E66E 3A 39 FB                 ld      a, (_1C_PPI1B_DrvReg)
31f2 31f2 s 	;RAM:E671 C6 40                    add     a, 40h ; '@'
31f2 31f2 s 	;RAM:E673 32 39 FB                 ld      (_1C_PPI1B_DrvReg), a
31f2 31f2 s 	;RAM:E676 CD 79 E8                 call    FDD_BREAK
31f2 31f2 s 	;RAM:E679 21 00 EE                 ld      hl, RD_BUF
31f2 31f2 s 	;RAM:E67C CD 9A E7                 call    DTOM
31f2 31f2 s 	;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
31f2 31f2 s 	;RAM:E67F 21 AF E6                 ld      hl, msgDiskNotRead 
31f2 31f2 s 	;RAM:E682 C2 A7 E6                 jp      nz, loc_E6A7
31f2 31f2 s 	;RAM:E685
31f2 31f2 s 
31f2 31f2 s 	;для надёжности проверим что по этому аддреск находтся то что ожидаем 
31f2 31f2 s 
31f2 31f2 s 	dbpatch	0xE67F		,0x21	,0x21
31f2 31f2 d 52
31f2 31f2 s 	db 	pB_CHK_PATCH
31f3 31f3 d 7fe6
31f3 31f3 s 	dw 	0xE67F
31f5 31f5 d 2121
31f5 31f5 s 	db 	0x21,0x21
31f7 31f7 s 	endm
31f7 31f7 s 	dwpatch	0xE67F+1 	,0xE6AF	,0xE6AF
31f7 31f7 d 51
31f7 31f7 s 	db 	pW_CHK_PATCH
31f8 31f8 d 80e6
31f8 31f8 s 	dw 	0xE67F+1
31fa 31fa d afe6afe6
31fa 31fa s 	dw 	0xE6AF,0xE6AF
31fe 31fe s 	endm
31fe 31fe s 
31fe 31fe s 	;и устанавливаем в наш "резидент" переход на эту точку.
31fe 31fe s 	
31fe 31fe s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE67F
31fe 31fe d 54
31fe 31fe s 	db 	pW_STORE
31ff 31ff d 7fe6
31ff 31ff s 	dw 	0xE67F
3201 3201 d a0e9
3201 3201 s 	dw 	_CPM1__old_getinfo_chkdo+1
3203 3203 s 	endm
3203 3203 s 
3203 3203 s 	;BIOS_VAR_xxx-----------------------------------------------------------------------
3203 3203 s 	;BIOS_VAR_DSK,BIOS_VAR_TRK,BIOS_VAR_SEC,BIOS_VAR_DMA
3203 3203 s 	;системные переменные BIOS которые необходимы "эмулятору" для работы 
3203 3203 s 	;функций READ/WRITE, т.к. их параметры предварительно записываются именно в
3203 3203 s 	;эти переменные 
3203 3203 s 	;сохраняем в эмулятор значения характерные именно для текущего биоса
3203 3203 s 	;
3203 3203 s 	;найти их совсем просто
3203 3203 s 	;
3203 3203 s 	;в стандартном CPM BIOS есть набор соответсвующих вызовов
3203 3203 s 	;TRK -> 0xE068 (инструкция по адрессу DC89)
3203 3203 s 	;SEC -> 0xE069 (инструкция по адрессу DCDD)
3203 3203 s 	;DMA -> 0xE06A (инструкция по адрессу DCE7)
3203 3203 s 
3203 3203 s 	;RAM:DA1E          _SELTRK:                                
3203 3203 s 	;RAM:DA1E C3 88 DC                 jp      j_SELTRK
3203 3203 s 	;RAM:DA21          _SETSEC:                                
3203 3203 s 	;RAM:DA21 C3 DC DC                 jp      j_SETSEC
3203 3203 s 	;RAM:DA24          _SETDMA:
3203 3203 s 	;RAM:DA24 C3 E5 DC                 jp      j_SETDMA
3203 3203 s 	;
3203 3203 s 	;RAM:DC88          j_SELTRK:                               
3203 3203 s 	;RAM:DC88                                                  
3203 3203 s 	;RAM:DC88 79                       ld      a, c
3203 3203 s 	;RAM:DC89 32 68 E0                 ld      (_TRK), a
3203 3203 s 	;RAM:DC8C C9                       ret
3203 3203 s 	;...
3203 3203 s 	;RAM:DCDC          j_SETSEC:                               
3203 3203 s 	;RAM:DCDC                                                  
3203 3203 s 	;RAM:DCDC 79                       ld      a, c
3203 3203 s 	;RAM:DCDD 32 69 E0                 ld      (_SEC), a
3203 3203 s 	;RAM:DCE0 C9                       ret
3203 3203 s 	;...
3203 3203 s 	;RAM:DCE5          j_SETDMA:                               
3203 3203 s 	;RAM:DCE5                                                  
3203 3203 s 	;RAM:DCE5 69                       ld      l, c
3203 3203 s 	;RAM:DCE6 60                       ld      h, b
3203 3203 s 	;RAM:DCE7 22 6A E0                 ld      (_DMA), hl
3203 3203 s 	;RAM:DCEA C9                       ret
3203 3203 s 
3203 3203 s 	;а с DSK - тоже, многострадальный код SELDSK
3203 3203 s 	;тут нужная нам число 0xE064 в инструкции по адрессу 0xDC9C
3203 3203 s 
3203 3203 s 	;RAM:DC8D          j_SELDSK:                               
3203 3203 s 	;RAM:DC8D 79                       ld      a, c
3203 3203 s 	;RAM:DC8E FE FF                    cp      0FFh
3203 3203 s 	;RAM:DC90 21 C8 F7                 ld      hl, _xVTRAP0_EXT
3203 3203 s 	;RAM:DC93 C8                       ret     z
3203 3203 s 	;RAM:DC94 FE 08                    cp      8
3203 3203 s 	;RAM:DC96 D2 C4 DC                 jp      nc, loc_DCC4
3203 3203 s 	;RAM:DC99 21 CC DC                 ld      hl, DPH_TABLE
3203 3203 s 	;RAM:DC9C 32 64 E0                 ld      (_DSK), a
3203 3203 s 
3203 3203 s 	dwstore	_CPM1_r_p_DSK1+1	,0xE064 	;read
3203 3203 d 54
3203 3203 s 	db 	pW_STORE
3204 3204 d 64e0
3204 3204 s 	dw 	0xE064
3206 3206 d 1ce9
3206 3206 s 	dw 	_CPM1_r_p_DSK1+1
3208 3208 s 	endm
3208 3208 s 	dwstore	_CPM1_r_p_TRK1+1	,0xE068 	
3208 3208 d 54
3208 3208 s 	db 	pW_STORE
3209 3209 d 68e0
3209 3209 s 	dw 	0xE068
320b 320b d 37e9
320b 320b s 	dw 	_CPM1_r_p_TRK1+1
320d 320d s 	endm
320d 320d s 	dwstore	_CPM1_r_p_SEC1+1	,0xE069 	
320d 320d d 54
320d 320d s 	db 	pW_STORE
320e 320e d 69e0
320e 320e s 	dw 	0xE069
3210 3210 d 3de9
3210 3210 s 	dw 	_CPM1_r_p_SEC1+1
3212 3212 s 	endm
3212 3212 s 	dwstore	_CPM1_r_p_DMA1+1	,0xE06A 	
3212 3212 d 54
3212 3212 s 	db 	pW_STORE
3213 3213 d 6ae0
3213 3213 s 	dw 	0xE06A
3215 3215 d 4ee9
3215 3215 s 	dw 	_CPM1_r_p_DMA1+1
3217 3217 s 	endm
3217 3217 s 
3217 3217 s 	dwstore	_CPM1_r_p_DSK2+1	,0xE064 	;write
3217 3217 d 54
3217 3217 s 	db 	pW_STORE
3218 3218 d 64e0
3218 3218 s 	dw 	0xE064
321a 321a d 59e9
321a 321a s 	dw 	_CPM1_r_p_DSK2+1
321c 321c s 	endm
321c 321c s 	dwstore	_CPM1_r_p_TRK2+1	,0xE068 	
321c 321c d 54
321c 321c s 	db 	pW_STORE
321d 321d d 68e0
321d 321d s 	dw 	0xE068
321f 321f d 74e9
321f 321f s 	dw 	_CPM1_r_p_TRK2+1
3221 3221 s 	endm
3221 3221 s 	dwstore	_CPM1_r_p_SEC2+1	,0xE069 	
3221 3221 d 54
3221 3221 s 	db 	pW_STORE
3222 3222 d 69e0
3222 3222 s 	dw 	0xE069
3224 3224 d 7ae9
3224 3224 s 	dw 	_CPM1_r_p_SEC2+1
3226 3226 s 	endm
3226 3226 s 	dwstore	_CPM1_r_p_DMA2+1	,0xE06A 	
3226 3226 d 54
3226 3226 s 	db 	pW_STORE
3227 3227 d 6ae0
3227 3227 s 	dw 	0xE06A
3229 3229 d 8be9
3229 3229 s 	dw 	_CPM1_r_p_DMA2+1
322b 322b s 	endm
322b 322b s 
322b 322b s 	dwstore	_CPM1_r_p_DSK3+1	,0xE064 	;readinfo
322b 322b d 54
322b 322b s 	db 	pW_STORE
322c 322c d 64e0
322c 322c s 	dw 	0xE064
322e 322e d 28ea
322e 322e s 	dw 	_CPM1_r_p_DSK3+1
3230 3230 s 	endm
3230 3230 s 
3230 3230 s 
3230 3230 s 	;KEY_HOOK:---------------------------------------------------------------------------
3230 3230 s 	;VINTKBDADDR,VINTKBDVALUE,KBD_HOOK_PROC
3230 3230 s 	;перехватываем нажатие комбинации клавиш CTRL+SHIFT+STOP
3230 3230 s 	;планируется что по нажатии этой комбинации - содержимое диска E
3230 3230 s 	;будет перезаписано содержимым на котором записан - 
3230 3230 s 	;MOUNT и другие служебные утилиты для работы с EXTROM API 
3230 3230 s 	;к сожадлению нет общего для всех кода
3230 3230 s 	;точнее самые старые биосы - требуют "особых" отношений
3230 3230 s 	;там немного по другому драйвер клавиатуры возвращает коды.
3230 3230 s 	;
3230 3230 s 	;kbd_hook_noCtrl_03 - '12_87_09_NIIJAF'	и производных от него '1x_88_EPSON_V104','1x_89_03_30_RAVI'
3230 3230 s 	;kbd_hook_noCtrl_33 - '12_87_11_niijaf'
3230 3230 s 	;kbd_hook_2133      - все остальные
3230 3230 s 
3230 3230 s 	;по сути, мы подменяем перехватываем обработчик VTRAP8_pseudoKBD
3230 3230 s 	;как найти 
3230 3230 s 
3230 3230 s 	;в HWINIT есть копирование стандартной таблицы векторов VTRAP в рабочее место
3230 3230 s 	;вот ее мы и патчим
3230 3230 s 	;в коде ниже это адрес 0xdc46 и значение 0xdc46
3230 3230 s 
3230 3230 s 	;RAM:DA00          _BOOT:
3230 3230 s 	;RAM:DA00 C3 42 DB                 jp      j_BOOT
3230 3230 s 	;...
3230 3230 s 	;RAM:DB42          j_BOOT:                                 
3230 3230 s 	;RAM:DB42 F3                       di
3230 3230 s 	;RAM:DB43 31 80 00                 ld      sp, 80h ; 'Ç'
3230 3230 s 	;RAM:DB46 3E 1C                    ld      a, 1Ch
3230 3230 s 	;RAM:DB48 32 7F FA                 ld      (_1C_SysReg1C), a
3230 3230 s 	;RAM:DB4B 32 03 F7                 ld      (SysCOPY), a
3230 3230 s 	;RAM:DB4E CD 0A E4                 call    HW_Init
3230 3230 s 	;....
3230 3230 s 	;RAM:E40A          HW_Init:                                
3230 3230 s 	;RAM:E40A                                                  
3230 3230 s 	;RAM:E40A F3                       di
3230 3230 s 	;RAM:E40B 11 D1 E3                 ld      de, IntstINTAB
3230 3230 s 	;RAM:E40E 21 C6 F7                 ld      hl, _xVTRAP
3230 3230 s 	;RAM:E411 01 3A 00                 ld      bc, 58
3230 3230 s 	;RAM:E414 CD 3A E0                 call    _LDIR
3230 3230 s 	;....
3230 3230 s 	;RAM:E3D1 D3 E3    IntstINTAB:     dw off_E3D3             
3230 3230 s 	;RAM:E3D3 0C DC    off_E3D3:       dw _EOI                 
3230 3230 s 	;RAM:E3D3                                                  
3230 3230 s 	;RAM:E3D5 0C DC                    dw _EOI
3230 3230 s 	;RAM:E3D7 0C DC                    dw _EOI
3230 3230 s 	;RAM:E3D9 0C DC                    dw _EOI
3230 3230 s 	;RAM:E3DB 1C DC                    dw VINT_VBL
3230 3230 s 	;RAM:E3DD 0C DC                    dw _EOI
3230 3230 s 	;RAM:E3DF 0C DC                    dw _EOI
3230 3230 s 	;RAM:E3E1 0C DC                    dw _EOI
3230 3230 s 	;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
3230 3230 s 	;RAM:E3E3 46 DC                    dw VINT_KBD
3230 3230 s 	;!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
3230 3230 s 	;RAM:E3E5 00 00                    dw 0
3230 3230 s 	;RAM:E3E7 00 00                    dw 0
3230 3230 s 	;RAM:E3E9 00 00                    dw 0
3230 3230 s 	
3230 3230 s 	;support removed
3230 3230 s 	;dwpatch	#_CPM1_VINTKBDADDR#	,#_CPM1_VINTKBDVALUE#	,#_CPM1_KBD_HOOK_PROC#
3230 3230 s 	;dwstore	_CPM1_old_hook+1	,#_CPM1_VINTKBDVALUE#
3230 3230 s 
3230 3230 s 	;custom checkers
3230 3230 s 	dwpatch	0xDCBB+1	,0xE06E ,0xE06E
3230 3230 d 51
3230 3230 s 	db 	pW_CHK_PATCH
3231 3231 d bcdc
3231 3231 s 	dw 	0xDCBB+1
3233 3233 d 6ee06ee0
3233 3233 s 	dw 	0xE06E,0xE06E
3237 3237 s 	endm
3237 3237 s 
3237 3237 s 	;STOP-------------------------------------------------------------------------------
3237 3237 s 	stop 'CPM_21_89___wiza'
3237 3237 d 50
3237 3237 s 	db 	p_STOP
3238 3238 d 43504d5f32315f38395f5f5f77697a61
3238 3238 s 	db 	'CPM_21_89___wiza'
3248 3248 d 00
3248 3248 s 	db 	0
3249 3249 s 	endm
3249 3249 f out/include-patcher.asm
3249 3249 s 	include "generator/V0/out/patcher-microdos-MICRODOS_OPTS2_880630.asm"	; 42 images in collection
3249 3249 f generator/V0/out/patcher-microdos-MICRODOS_OPTS2_880630.asm
3249 3249 s _BIOS_MICRODOS_OPTS2_880630:
3249 3249 s 	setMICRODOS
3249 3249 d 56
3249 3249 s 	db 	pSETFLAG_MICRODOS
324a 324a s 	endm
324a 324a s 	RQ_OPTS2
324a 324a d 58
324a 324a s 	db 	pREQUIRED_OPTS2
324b 324b s 	endm
324b 324b s 	dbpatchmaybe	0xBEA3	,0x1B	,0x0d
324b 324b d 59
324b 324b s 	db 	pB_MAYBE_PATCH
324c 324c d a3be
324c 324c s 	dw 	0xBEA3
324e 324e d 1b0d
324e 324e s 	db 	0x1B,0x0d
3250 3250 s 	endm
3250 3250 s 	dbpatchmaybe	0xBEA3+1	,0x45	,0x0d
3250 3250 d 59
3250 3250 s 	db 	pB_MAYBE_PATCH
3251 3251 d a4be
3251 3251 s 	dw 	0xBEA3+1
3253 3253 d 450d
3253 3253 s 	db 	0x45,0x0d
3255 3255 s 	endm
3255 3255 s 	dwpatch	0xEAFD+1	,0xEB34	,MD_READ			
3255 3255 d 51
3255 3255 s 	db 	pW_CHK_PATCH
3256 3256 d feea
3256 3256 s 	dw 	0xEAFD+1
3258 3258 d 34eb3efa
3258 3258 s 	dw 	0xEB34,MD_READ
325c 325c s 	endm
325c 325c s 	dwpatch	0xEB02+1	,0xEB9E	,MD_WRITE
325c 325c d 51
325c 325c s 	db 	pW_CHK_PATCH
325d 325d d 03eb
325d 325d s 	dw 	0xEB02+1
325f 325f d 9eeb53fa
325f 325f s 	dw 	0xEB9E,MD_WRITE
3263 3263 s 	endm
3263 3263 s 	dbpatch	0xEC91	,0xcd	,0x00
3263 3263 d 52
3263 3263 s 	db 	pB_CHK_PATCH
3264 3264 d 91ec
3264 3264 s 	dw 	0xEC91
3266 3266 d cd00
3266 3266 s 	db 	0xcd,0x00
3268 3268 s 	endm
3268 3268 s 	dwpatch	0xEC91+1	,0xee27	,0x0000
3268 3268 d 51
3268 3268 s 	db 	pW_CHK_PATCH
3269 3269 d 92ec
3269 3269 s 	dw 	0xEC91+1
326b 326b d 27ee0000
326b 326b s 	dw 	0xee27,0x0000
326f 326f s 	endm
326f 326f s 	dwpatch	0xEC94+1	,0xEE2C	,MD_READ_INFOSECTOR
326f 326f d 51
326f 326f s 	db 	pW_CHK_PATCH
3270 3270 d 95ec
3270 3270 s 	dw 	0xEC94+1
3272 3272 d 2cee68fa
3272 3272 s 	dw 	0xEE2C,MD_READ_INFOSECTOR
3276 3276 s 	endm
3276 3276 s 	dwstore	MD_DRV2+1,	0xEF23
3276 3276 d 54
3276 3276 s 	db 	pW_STORE
3277 3277 d 23ef
3277 3277 s 	dw 	0xEF23
3279 3279 d f3fa
3279 3279 s 	dw 	MD_DRV2+1
327b 327b s 	endm
327b 327b s 	dwstore	MD_RDBUF2+1,	0xEF2B
327b 327b d 54
327b 327b s 	db 	pW_STORE
327c 327c d 2bef
327c 327c s 	dw 	0xEF2B
327e 327e d 02fb
327e 327e s 	dw 	MD_RDBUF2+1
3280 3280 s 	endm
3280 3280 s 	dwstore	MD_PARAM2+1,	0xEF16
3280 3280 d 54
3280 3280 s 	db 	pW_STORE
3281 3281 d 16ef
3281 3281 s 	dw 	0xEF16
3283 3283 d 1dfa
3283 3283 s 	dw 	MD_PARAM2+1
3285 3285 s 	endm
3285 3285 s 	dwpatch 0xc01b+1	 ,0xDD88	,md_res_seldsk
3285 3285 d 51
3285 3285 s 	db 	pW_CHK_PATCH
3286 3286 d 1cc0
3286 3286 s 	dw 	0xc01b+1
3288 3288 d 88dd0efa
3288 3288 s 	dw 	0xDD88,md_res_seldsk
328c 328c s 	endm
328c 328c s 	dwstore md_old_seld_dsk+1,0xDD88	,0xdd4c
328c 328c d 54
328c 328c s 	db 	pW_STORE
328d 328d d 88dd
328d 328d s 	dw 	0xDD88
328f 328f d 12fa
328f 328f s 	dw 	md_old_seld_dsk+1
3291 3291 s 	endm
3291 3291 s 	;custom checkers
3291 3291 s 	dwpatch	0xBD80	,0xBD80 ,0xBD80
3291 3291 d 51
3291 3291 s 	db 	pW_CHK_PATCH
3292 3292 d 80bd
3292 3292 s 	dw 	0xBD80
3294 3294 d 80bd80bd
3294 3294 s 	dw 	0xBD80,0xBD80
3298 3298 s 	endm
3298 3298 s 	dwpatch	0xBD82	,0xBE00 ,0xBE00
3298 3298 d 51
3298 3298 s 	db 	pW_CHK_PATCH
3299 3299 d 82bd
3299 3299 s 	dw 	0xBD82
329b 329b d 00be00be
329b 329b s 	dw 	0xBE00,0xBE00
329f 329f s 	endm
329f 329f s 	dwpatch	0xc000+1	,0xC488 ,0xC488
329f 329f d 51
329f 329f s 	db 	pW_CHK_PATCH
32a0 32a0 d 01c0
32a0 32a0 s 	dw 	0xc000+1
32a2 32a2 d 88c488c4
32a2 32a2 s 	dw 	0xC488,0xC488
32a6 32a6 s 	endm
32a6 32a6 s 	dwpatch	0xc003+1	,0xDBFC ,0xDBFC
32a6 32a6 d 51
32a6 32a6 s 	db 	pW_CHK_PATCH
32a7 32a7 d 04c0
32a7 32a7 s 	dw 	0xc003+1
32a9 32a9 d fcdbfcdb
32a9 32a9 s 	dw 	0xDBFC,0xDBFC
32ad 32ad s 	endm
32ad 32ad s 	dbpatch	0xEC4C	,0x21 ,0x21
32ad 32ad d 52
32ad 32ad s 	db 	pB_CHK_PATCH
32ae 32ae d 4cec
32ae 32ae s 	dw 	0xEC4C
32b0 32b0 d 2121
32b0 32b0 s 	db 	0x21,0x21
32b2 32b2 s 	endm
32b2 32b2 s 	stop 'MICRODOS_OPTS2_880630'
32b2 32b2 d 50
32b2 32b2 s 	db 	p_STOP
32b3 32b3 d 4d4943524f444f535f4f505453325f383830363330
32b3 32b3 s 	db 	'MICRODOS_OPTS2_880630'
32c8 32c8 d 00
32c8 32c8 s 	db 	0
32c9 32c9 s 	endm
32c9 32c9 f out/include-patcher.asm
32c9 32c9 s 	include "generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf2.asm"	; 36 images in collection
32c9 32c9 f generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf2.asm
32c9 32c9 s _BIOS_CPM_21_89_2_niijaf2:
32c9 32c9 s 	setSUBBIOS 1
32c9 32c9 d 5a
32c9 32c9 s 	db	pSubBios
32ca 32ca d 01
32ca 32ca s 	db 	1
32cb 32cb s 	endm
32cb 32cb s 	RQ_OPTS_ANY
32cb 32cb s 	endm
32cb 32cb s 	setCPM
32cb 32cb s 	endm
32cb 32cb s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
32cb 32cb d 59
32cb 32cb s 	db 	pB_MAYBE_PATCH
32cc 32cc d eeda
32cc 32cc s 	dw 	0xDAEE
32ce 32ce d 1f0d
32ce 32ce s 	db 	0x1F,0x0d
32d0 32d0 s 	endm
32d0 32d0 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
32d0 32d0 d 59
32d0 32d0 s 	db 	pB_MAYBE_PATCH
32d1 32d1 d f0da
32d1 32d1 s 	dw 	0xDAEE+2
32d3 32d3 d 0a0d
32d3 32d3 s 	db 	0x0a,0x0d
32d5 32d5 s 	endm
32d5 32d5 s 	dbpatch	0xE487+1	,0x49	,0xc9
32d5 32d5 d 52
32d5 32d5 s 	db 	pB_CHK_PATCH
32d6 32d6 d 88e4
32d6 32d6 s 	dw 	0xE487+1
32d8 32d8 d 49c9
32d8 32d8 s 	db 	0x49,0xc9
32da 32da s 	endm
32da 32da s 	dbpatch	0xDA89 	,0x01	,0x00
32da 32da d 52
32da 32da s 	db 	pB_CHK_PATCH
32db 32db d 89da
32db 32db s 	dw 	0xDA89
32dd 32dd d 0100
32dd 32dd s 	db 	0x01,0x00
32df 32df s 	endm
32df 32df s 	dbpatch	0xDAA0 	,0x02	,0x00
32df 32df d 52
32df 32df s 	db 	pB_CHK_PATCH
32e0 32e0 d a0da
32e0 32e0 s 	dw 	0xDAA0
32e2 32e2 d 0200
32e2 32e2 s 	db 	0x02,0x00
32e4 32e4 s 	endm
32e4 32e4 s 	dbpatch	0xDAB7 	,0x04	,0x01
32e4 32e4 d 52
32e4 32e4 s 	db 	pB_CHK_PATCH
32e5 32e5 d b7da
32e5 32e5 s 	dw 	0xDAB7
32e7 32e7 d 0401
32e7 32e7 s 	db 	0x04,0x01
32e9 32e9 s 	endm
32e9 32e9 s 	dbpatch	0xDACE 	,0x08	,0x02
32e9 32e9 d 52
32e9 32e9 s 	db 	pB_CHK_PATCH
32ea 32ea d ceda
32ea 32ea s 	dw 	0xDACE
32ec 32ec d 0802
32ec 32ec s 	db 	0x08,0x02
32ee 32ee s 	endm
32ee 32ee s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
32ee 32ee d 54
32ee 32ee s 	db 	pW_STORE
32ef 32ef d 89da
32ef 32ef s 	dw 	0xDA89
32f1 32f1 d ace8
32f1 32f1 s 	dw 	_CPM1_res_DRIVE_TAB+0*2
32f3 32f3 s 	endm
32f3 32f3 s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
32f3 32f3 d 54
32f3 32f3 s 	db 	pW_STORE
32f4 32f4 d a0da
32f4 32f4 s 	dw 	0xDAA0
32f6 32f6 d aee8
32f6 32f6 s 	dw 	_CPM1_res_DRIVE_TAB+1*2
32f8 32f8 s 	endm
32f8 32f8 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
32f8 32f8 d 54
32f8 32f8 s 	db 	pW_STORE
32f9 32f9 d b7da
32f9 32f9 s 	dw 	0xDAB7
32fb 32fb d b0e8
32fb 32fb s 	dw 	_CPM1_res_DRIVE_TAB+2*2
32fd 32fd s 	endm
32fd 32fd s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
32fd 32fd d 54
32fd 32fd s 	db 	pW_STORE
32fe 32fe d ceda
32fe 32fe s 	dw 	0xDACE
3300 3300 d b2e8
3300 3300 s 	dw 	_CPM1_res_DRIVE_TAB+3*2
3302 3302 s 	endm
3302 3302 s 	dwpatch 0xDCBB+5*2 	,0x0000 ,_CPM1_dph_F
3302 3302 d 51
3302 3302 s 	db 	pW_CHK_PATCH
3303 3303 d c5dc
3303 3303 s 	dw 	0xDCBB+5*2
3305 3305 d 0000b8e8
3305 3305 s 	dw 	0x0000,_CPM1_dph_F
3309 3309 s 	endm
3309 3309 s 	dwstore _CPM1_dph_F+8	,0xEBA6
3309 3309 d 54
3309 3309 s 	db 	pW_STORE
330a 330a d a6eb
330a 330a s 	dw 	0xEBA6
330c 330c d c0e8
330c 330c s 	dw 	_CPM1_dph_F+8
330e 330e s 	endm
330e 330e s 	dwpatch 0xDA1B+1 	,0xDC7C	,_CPM1_res_seldsk
330e 330e d 51
330e 330e s 	db 	pW_CHK_PATCH
330f 330f d 1cda
330f 330f s 	dw 	0xDA1B+1
3311 3311 d 7cdc11e9
3311 3311 s 	dw 	0xDC7C,_CPM1_res_seldsk
3315 3315 s 	endm
3315 3315 s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC7C
3315 3315 d 54
3315 3315 s 	db 	pW_STORE
3316 3316 d 7cdc
3316 3316 s 	dw 	0xDC7C
3318 3318 d 15e9
3318 3318 s 	dw 	_CPM1_old_seld_dsk+1
331a 331a s 	endm
331a 331a s 	dbpatch	0xE6F2	,0x77	,0x00
331a 331a d 52
331a 331a s 	db 	pB_CHK_PATCH
331b 331b d f2e6
331b 331b s 	dw 	0xE6F2
331d 331d d 7700
331d 331d s 	db 	0x77,0x00
331f 331f s 	endm
331f 331f s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE056
331f 331f d 54
331f 331f s 	db 	pW_STORE
3320 3320 d 56e0
3320 3320 s 	dw 	0xE056
3322 3322 d 2ee9
3322 3322 s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
3324 3324 s 	endm
3324 3324 s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE056
3324 3324 d 54
3324 3324 s 	db 	pW_STORE
3325 3325 d 56e0
3325 3325 s 	dw 	0xE056
3327 3327 d 6be9
3327 3327 s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
3329 3329 s 	endm
3329 3329 s 	dwpatch	0xDA27+1	,0xDCDA	,_CPM1_res_READ
3329 3329 d 51
3329 3329 s 	db 	pW_CHK_PATCH
332a 332a d 28da
332a 332a s 	dw 	0xDA27+1
332c 332c d dadc1be9
332c 332c s 	dw 	0xDCDA,_CPM1_res_READ
3330 3330 s 	endm
3330 3330 s 	dwpatch	0xDA2A+1	,0xDE97	,_CPM1_res_WRITE
3330 3330 d 51
3330 3330 s 	db 	pW_CHK_PATCH
3331 3331 d 2bda
3331 3331 s 	dw 	0xDA2A+1
3333 3333 d 97de58e9
3333 3333 s 	dw 	0xDE97,_CPM1_res_WRITE
3337 3337 s 	endm
3337 3337 s 	dwpatch	0xDB73+1	,0xDCDA	,_CPM1_res_READ
3337 3337 d 51
3337 3337 s 	db 	pW_CHK_PATCH
3338 3338 d 74db
3338 3338 s 	dw 	0xDB73+1
333a 333a d dadc1be9
333a 333a s 	dw 	0xDCDA,_CPM1_res_READ
333e 333e s 	endm
333e 333e s 	dwpatch	0xdcae+1	,0xE630	,_CPM1_res_GETINFO
333e 333e d 51
333e 333e s 	db 	pW_CHK_PATCH
333f 333f d afdc
333f 333f s 	dw 	0xdcae+1
3341 3341 d 30e695e9
3341 3341 s 	dw 	0xE630,_CPM1_res_GETINFO
3345 3345 s 	endm
3345 3345 s 	dwstore	_CPM1__old_read+1	,0xDCDA
3345 3345 d 54
3345 3345 s 	db 	pW_STORE
3346 3346 d dadc
3346 3346 s 	dw 	0xDCDA
3348 3348 d 56e9
3348 3348 s 	dw 	_CPM1__old_read+1
334a 334a s 	endm
334a 334a s 	dwstore	_CPM1__old_write+1	,0xDE97
334a 334a d 54
334a 334a s 	db 	pW_STORE
334b 334b d 97de
334b 334b s 	dw 	0xDE97
334d 334d d 93e9
334d 334d s 	dw 	_CPM1__old_write+1
334f 334f s 	endm
334f 334f s 	dwstore	_CPM1__old_getinfo+1	,0xE630
334f 334f d 54
334f 334f s 	db 	pW_STORE
3350 3350 d 30e6
3350 3350 s 	dw 	0xE630
3352 3352 d a3e9
3352 3352 s 	dw 	_CPM1__old_getinfo+1
3354 3354 s 	endm
3354 3354 s 	dbpatch	0xE667		,0x21	,0x21
3354 3354 d 52
3354 3354 s 	db 	pB_CHK_PATCH
3355 3355 d 67e6
3355 3355 s 	dw 	0xE667
3357 3357 d 2121
3357 3357 s 	db 	0x21,0x21
3359 3359 s 	endm
3359 3359 s 	dwpatch	0xE667+1 	,0xE697	,0xE697
3359 3359 d 51
3359 3359 s 	db 	pW_CHK_PATCH
335a 335a d 68e6
335a 335a s 	dw 	0xE667+1
335c 335c d 97e697e6
335c 335c s 	dw 	0xE697,0xE697
3360 3360 s 	endm
3360 3360 s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE667
3360 3360 d 54
3360 3360 s 	db 	pW_STORE
3361 3361 d 67e6
3361 3361 s 	dw 	0xE667
3363 3363 d a0e9
3363 3363 s 	dw 	_CPM1__old_getinfo_chkdo+1
3365 3365 s 	endm
3365 3365 s 	dwstore	_CPM1_r_p_DSK1+1	,0xE04C 	;read
3365 3365 d 54
3365 3365 s 	db 	pW_STORE
3366 3366 d 4ce0
3366 3366 s 	dw 	0xE04C
3368 3368 d 1ce9
3368 3368 s 	dw 	_CPM1_r_p_DSK1+1
336a 336a s 	endm
336a 336a s 	dwstore	_CPM1_r_p_TRK1+1	,0xE050 	
336a 336a d 54
336a 336a s 	db 	pW_STORE
336b 336b d 50e0
336b 336b s 	dw 	0xE050
336d 336d d 37e9
336d 336d s 	dw 	_CPM1_r_p_TRK1+1
336f 336f s 	endm
336f 336f s 	dwstore	_CPM1_r_p_SEC1+1	,0xE051 	
336f 336f d 54
336f 336f s 	db 	pW_STORE
3370 3370 d 51e0
3370 3370 s 	dw 	0xE051
3372 3372 d 3de9
3372 3372 s 	dw 	_CPM1_r_p_SEC1+1
3374 3374 s 	endm
3374 3374 s 	dwstore	_CPM1_r_p_DMA1+1	,0xE052 	
3374 3374 d 54
3374 3374 s 	db 	pW_STORE
3375 3375 d 52e0
3375 3375 s 	dw 	0xE052
3377 3377 d 4ee9
3377 3377 s 	dw 	_CPM1_r_p_DMA1+1
3379 3379 s 	endm
3379 3379 s 	dwstore	_CPM1_r_p_DSK2+1	,0xE04C 	;write
3379 3379 d 54
3379 3379 s 	db 	pW_STORE
337a 337a d 4ce0
337a 337a s 	dw 	0xE04C
337c 337c d 59e9
337c 337c s 	dw 	_CPM1_r_p_DSK2+1
337e 337e s 	endm
337e 337e s 	dwstore	_CPM1_r_p_TRK2+1	,0xE050 	
337e 337e d 54
337e 337e s 	db 	pW_STORE
337f 337f d 50e0
337f 337f s 	dw 	0xE050
3381 3381 d 74e9
3381 3381 s 	dw 	_CPM1_r_p_TRK2+1
3383 3383 s 	endm
3383 3383 s 	dwstore	_CPM1_r_p_SEC2+1	,0xE051 	
3383 3383 d 54
3383 3383 s 	db 	pW_STORE
3384 3384 d 51e0
3384 3384 s 	dw 	0xE051
3386 3386 d 7ae9
3386 3386 s 	dw 	_CPM1_r_p_SEC2+1
3388 3388 s 	endm
3388 3388 s 	dwstore	_CPM1_r_p_DMA2+1	,0xE052 	
3388 3388 d 54
3388 3388 s 	db 	pW_STORE
3389 3389 d 52e0
3389 3389 s 	dw 	0xE052
338b 338b d 8be9
338b 338b s 	dw 	_CPM1_r_p_DMA2+1
338d 338d s 	endm
338d 338d s 	dwstore	_CPM1_r_p_DSK3+1	,0xE04C 	;readinfo
338d 338d d 54
338d 338d s 	db 	pW_STORE
338e 338e d 4ce0
338e 338e s 	dw 	0xE04C
3390 3390 d 28ea
3390 3390 s 	dw 	_CPM1_r_p_DSK3+1
3392 3392 s 	endm
3392 3392 s 
3392 3392 s 	stop 'CPM_21_89_2_niijaf2'
3392 3392 d 50
3392 3392 s 	db 	p_STOP
3393 3393 d 43504d5f32315f38395f325f6e69696a616632
3393 3393 s 	db 	'CPM_21_89_2_niijaf2'
33a6 33a6 d 00
33a6 33a6 s 	db 	0
33a7 33a7 s 	endm
33a7 33a7 f out/include-patcher.asm
33a7 33a7 s 	include "generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf.asm"	; 28 images in collection
33a7 33a7 f generator/V0/out/patcher-cpm1-CPM_21_89_2_niijaf.asm
33a7 33a7 s _BIOS_CPM_21_89_2_niijaf:
33a7 33a7 s 	setSUBBIOS 1
33a7 33a7 d 5a
33a7 33a7 s 	db	pSubBios
33a8 33a8 d 01
33a8 33a8 s 	db 	1
33a9 33a9 s 	endm
33a9 33a9 s 	RQ_OPTS_ANY
33a9 33a9 s 	endm
33a9 33a9 s 	setCPM
33a9 33a9 s 	endm
33a9 33a9 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
33a9 33a9 d 59
33a9 33a9 s 	db 	pB_MAYBE_PATCH
33aa 33aa d eeda
33aa 33aa s 	dw 	0xDAEE
33ac 33ac d 1f0d
33ac 33ac s 	db 	0x1F,0x0d
33ae 33ae s 	endm
33ae 33ae s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
33ae 33ae d 59
33ae 33ae s 	db 	pB_MAYBE_PATCH
33af 33af d f0da
33af 33af s 	dw 	0xDAEE+2
33b1 33b1 d 0a0d
33b1 33b1 s 	db 	0x0a,0x0d
33b3 33b3 s 	endm
33b3 33b3 s 	dbpatch	0xE48E+1	,0x49	,0xc9
33b3 33b3 d 52
33b3 33b3 s 	db 	pB_CHK_PATCH
33b4 33b4 d 8fe4
33b4 33b4 s 	dw 	0xE48E+1
33b6 33b6 d 49c9
33b6 33b6 s 	db 	0x49,0xc9
33b8 33b8 s 	endm
33b8 33b8 s 	dbpatch	0xDA89 	,0x01	,0x00
33b8 33b8 d 52
33b8 33b8 s 	db 	pB_CHK_PATCH
33b9 33b9 d 89da
33b9 33b9 s 	dw 	0xDA89
33bb 33bb d 0100
33bb 33bb s 	db 	0x01,0x00
33bd 33bd s 	endm
33bd 33bd s 	dbpatch	0xDAA0 	,0x02	,0x00
33bd 33bd d 52
33bd 33bd s 	db 	pB_CHK_PATCH
33be 33be d a0da
33be 33be s 	dw 	0xDAA0
33c0 33c0 d 0200
33c0 33c0 s 	db 	0x02,0x00
33c2 33c2 s 	endm
33c2 33c2 s 	dbpatch	0xDAB7 	,0x04	,0x01
33c2 33c2 d 52
33c2 33c2 s 	db 	pB_CHK_PATCH
33c3 33c3 d b7da
33c3 33c3 s 	dw 	0xDAB7
33c5 33c5 d 0401
33c5 33c5 s 	db 	0x04,0x01
33c7 33c7 s 	endm
33c7 33c7 s 	dbpatch	0xDACE 	,0x08	,0x02
33c7 33c7 d 52
33c7 33c7 s 	db 	pB_CHK_PATCH
33c8 33c8 d ceda
33c8 33c8 s 	dw 	0xDACE
33ca 33ca d 0802
33ca 33ca s 	db 	0x08,0x02
33cc 33cc s 	endm
33cc 33cc s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
33cc 33cc d 54
33cc 33cc s 	db 	pW_STORE
33cd 33cd d 89da
33cd 33cd s 	dw 	0xDA89
33cf 33cf d ace8
33cf 33cf s 	dw 	_CPM1_res_DRIVE_TAB+0*2
33d1 33d1 s 	endm
33d1 33d1 s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
33d1 33d1 d 54
33d1 33d1 s 	db 	pW_STORE
33d2 33d2 d a0da
33d2 33d2 s 	dw 	0xDAA0
33d4 33d4 d aee8
33d4 33d4 s 	dw 	_CPM1_res_DRIVE_TAB+1*2
33d6 33d6 s 	endm
33d6 33d6 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
33d6 33d6 d 54
33d6 33d6 s 	db 	pW_STORE
33d7 33d7 d b7da
33d7 33d7 s 	dw 	0xDAB7
33d9 33d9 d b0e8
33d9 33d9 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
33db 33db s 	endm
33db 33db s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
33db 33db d 54
33db 33db s 	db 	pW_STORE
33dc 33dc d ceda
33dc 33dc s 	dw 	0xDACE
33de 33de d b2e8
33de 33de s 	dw 	_CPM1_res_DRIVE_TAB+3*2
33e0 33e0 s 	endm
33e0 33e0 s 	dwpatch 0xDCBB+5*2 	,0x0000 ,_CPM1_dph_F
33e0 33e0 d 51
33e0 33e0 s 	db 	pW_CHK_PATCH
33e1 33e1 d c5dc
33e1 33e1 s 	dw 	0xDCBB+5*2
33e3 33e3 d 0000b8e8
33e3 33e3 s 	dw 	0x0000,_CPM1_dph_F
33e7 33e7 s 	endm
33e7 33e7 s 	dwstore _CPM1_dph_F+8	,0xEBA6
33e7 33e7 d 54
33e7 33e7 s 	db 	pW_STORE
33e8 33e8 d a6eb
33e8 33e8 s 	dw 	0xEBA6
33ea 33ea d c0e8
33ea 33ea s 	dw 	_CPM1_dph_F+8
33ec 33ec s 	endm
33ec 33ec s 	dwpatch 0xDA1B+1 	,0xDC7C	,_CPM1_res_seldsk
33ec 33ec d 51
33ec 33ec s 	db 	pW_CHK_PATCH
33ed 33ed d 1cda
33ed 33ed s 	dw 	0xDA1B+1
33ef 33ef d 7cdc11e9
33ef 33ef s 	dw 	0xDC7C,_CPM1_res_seldsk
33f3 33f3 s 	endm
33f3 33f3 s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC7C
33f3 33f3 d 54
33f3 33f3 s 	db 	pW_STORE
33f4 33f4 d 7cdc
33f4 33f4 s 	dw 	0xDC7C
33f6 33f6 d 15e9
33f6 33f6 s 	dw 	_CPM1_old_seld_dsk+1
33f8 33f8 s 	endm
33f8 33f8 s 	dbpatch	0xE6F9	,0x77	,0x00
33f8 33f8 d 52
33f8 33f8 s 	db 	pB_CHK_PATCH
33f9 33f9 d f9e6
33f9 33f9 s 	dw 	0xE6F9
33fb 33fb d 7700
33fb 33fb s 	db 	0x77,0x00
33fd 33fd s 	endm
33fd 33fd s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE05D
33fd 33fd d 54
33fd 33fd s 	db 	pW_STORE
33fe 33fe d 5de0
33fe 33fe s 	dw 	0xE05D
3400 3400 d 2ee9
3400 3400 s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
3402 3402 s 	endm
3402 3402 s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE05D
3402 3402 d 54
3402 3402 s 	db 	pW_STORE
3403 3403 d 5de0
3403 3403 s 	dw 	0xE05D
3405 3405 d 6be9
3405 3405 s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
3407 3407 s 	endm
3407 3407 s 	dwpatch	0xDA27+1	,0xDCDA	,_CPM1_res_READ
3407 3407 d 51
3407 3407 s 	db 	pW_CHK_PATCH
3408 3408 d 28da
3408 3408 s 	dw 	0xDA27+1
340a 340a d dadc1be9
340a 340a s 	dw 	0xDCDA,_CPM1_res_READ
340e 340e s 	endm
340e 340e s 	dwpatch	0xDA2A+1	,0xDE9E	,_CPM1_res_WRITE
340e 340e d 51
340e 340e s 	db 	pW_CHK_PATCH
340f 340f d 2bda
340f 340f s 	dw 	0xDA2A+1
3411 3411 d 9ede58e9
3411 3411 s 	dw 	0xDE9E,_CPM1_res_WRITE
3415 3415 s 	endm
3415 3415 s 	dwpatch	0xDB73+1	,0xDCDA	,_CPM1_res_READ
3415 3415 d 51
3415 3415 s 	db 	pW_CHK_PATCH
3416 3416 d 74db
3416 3416 s 	dw 	0xDB73+1
3418 3418 d dadc1be9
3418 3418 s 	dw 	0xDCDA,_CPM1_res_READ
341c 341c s 	endm
341c 341c s 	dwpatch	0xdcae+1	,0xE637	,_CPM1_res_GETINFO
341c 341c d 51
341c 341c s 	db 	pW_CHK_PATCH
341d 341d d afdc
341d 341d s 	dw 	0xdcae+1
341f 341f d 37e695e9
341f 341f s 	dw 	0xE637,_CPM1_res_GETINFO
3423 3423 s 	endm
3423 3423 s 	dwstore	_CPM1__old_read+1	,0xDCDA
3423 3423 d 54
3423 3423 s 	db 	pW_STORE
3424 3424 d dadc
3424 3424 s 	dw 	0xDCDA
3426 3426 d 56e9
3426 3426 s 	dw 	_CPM1__old_read+1
3428 3428 s 	endm
3428 3428 s 	dwstore	_CPM1__old_write+1	,0xDE9E
3428 3428 d 54
3428 3428 s 	db 	pW_STORE
3429 3429 d 9ede
3429 3429 s 	dw 	0xDE9E
342b 342b d 93e9
342b 342b s 	dw 	_CPM1__old_write+1
342d 342d s 	endm
342d 342d s 	dwstore	_CPM1__old_getinfo+1	,0xE637
342d 342d d 54
342d 342d s 	db 	pW_STORE
342e 342e d 37e6
342e 342e s 	dw 	0xE637
3430 3430 d a3e9
3430 3430 s 	dw 	_CPM1__old_getinfo+1
3432 3432 s 	endm
3432 3432 s 	dbpatch	0xE66E		,0x21	,0x21
3432 3432 d 52
3432 3432 s 	db 	pB_CHK_PATCH
3433 3433 d 6ee6
3433 3433 s 	dw 	0xE66E
3435 3435 d 2121
3435 3435 s 	db 	0x21,0x21
3437 3437 s 	endm
3437 3437 s 	dwpatch	0xE66E+1 	,0xE69E	,0xE69E
3437 3437 d 51
3437 3437 s 	db 	pW_CHK_PATCH
3438 3438 d 6fe6
3438 3438 s 	dw 	0xE66E+1
343a 343a d 9ee69ee6
343a 343a s 	dw 	0xE69E,0xE69E
343e 343e s 	endm
343e 343e s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE66E
343e 343e d 54
343e 343e s 	db 	pW_STORE
343f 343f d 6ee6
343f 343f s 	dw 	0xE66E
3441 3441 d a0e9
3441 3441 s 	dw 	_CPM1__old_getinfo_chkdo+1
3443 3443 s 	endm
3443 3443 s 	dwstore	_CPM1_r_p_DSK1+1	,0xE053 	;read
3443 3443 d 54
3443 3443 s 	db 	pW_STORE
3444 3444 d 53e0
3444 3444 s 	dw 	0xE053
3446 3446 d 1ce9
3446 3446 s 	dw 	_CPM1_r_p_DSK1+1
3448 3448 s 	endm
3448 3448 s 	dwstore	_CPM1_r_p_TRK1+1	,0xE057 	
3448 3448 d 54
3448 3448 s 	db 	pW_STORE
3449 3449 d 57e0
3449 3449 s 	dw 	0xE057
344b 344b d 37e9
344b 344b s 	dw 	_CPM1_r_p_TRK1+1
344d 344d s 	endm
344d 344d s 	dwstore	_CPM1_r_p_SEC1+1	,0xE058 	
344d 344d d 54
344d 344d s 	db 	pW_STORE
344e 344e d 58e0
344e 344e s 	dw 	0xE058
3450 3450 d 3de9
3450 3450 s 	dw 	_CPM1_r_p_SEC1+1
3452 3452 s 	endm
3452 3452 s 	dwstore	_CPM1_r_p_DMA1+1	,0xE059 	
3452 3452 d 54
3452 3452 s 	db 	pW_STORE
3453 3453 d 59e0
3453 3453 s 	dw 	0xE059
3455 3455 d 4ee9
3455 3455 s 	dw 	_CPM1_r_p_DMA1+1
3457 3457 s 	endm
3457 3457 s 	dwstore	_CPM1_r_p_DSK2+1	,0xE053 	;write
3457 3457 d 54
3457 3457 s 	db 	pW_STORE
3458 3458 d 53e0
3458 3458 s 	dw 	0xE053
345a 345a d 59e9
345a 345a s 	dw 	_CPM1_r_p_DSK2+1
345c 345c s 	endm
345c 345c s 	dwstore	_CPM1_r_p_TRK2+1	,0xE057 	
345c 345c d 54
345c 345c s 	db 	pW_STORE
345d 345d d 57e0
345d 345d s 	dw 	0xE057
345f 345f d 74e9
345f 345f s 	dw 	_CPM1_r_p_TRK2+1
3461 3461 s 	endm
3461 3461 s 	dwstore	_CPM1_r_p_SEC2+1	,0xE058 	
3461 3461 d 54
3461 3461 s 	db 	pW_STORE
3462 3462 d 58e0
3462 3462 s 	dw 	0xE058
3464 3464 d 7ae9
3464 3464 s 	dw 	_CPM1_r_p_SEC2+1
3466 3466 s 	endm
3466 3466 s 	dwstore	_CPM1_r_p_DMA2+1	,0xE059 	
3466 3466 d 54
3466 3466 s 	db 	pW_STORE
3467 3467 d 59e0
3467 3467 s 	dw 	0xE059
3469 3469 d 8be9
3469 3469 s 	dw 	_CPM1_r_p_DMA2+1
346b 346b s 	endm
346b 346b s 	dwstore	_CPM1_r_p_DSK3+1	,0xE053 	;readinfo
346b 346b d 54
346b 346b s 	db 	pW_STORE
346c 346c d 53e0
346c 346c s 	dw 	0xE053
346e 346e d 28ea
346e 346e s 	dw 	_CPM1_r_p_DSK3+1
3470 3470 s 	endm
3470 3470 s 
3470 3470 s 	stop 'CPM_21_89_2_niijaf'
3470 3470 d 50
3470 3470 s 	db 	p_STOP
3471 3471 d 43504d5f32315f38395f325f6e69696a6166
3471 3471 s 	db 	'CPM_21_89_2_niijaf'
3483 3483 d 00
3483 3483 s 	db 	0
3484 3484 s 	endm
3484 3484 f out/include-patcher.asm
3484 3484 s 	include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_870430.asm"	; 28 images in collection
3484 3484 f generator/V0/out/patcher-microdos-MICRODOS_OPTS1_870430.asm
3484 3484 s _BIOS_MICRODOS_OPTS1_870430:
3484 3484 s 	setMICRODOS
3484 3484 d 56
3484 3484 s 	db 	pSETFLAG_MICRODOS
3485 3485 s 	endm
3485 3485 s 	RQ_OPTS1
3485 3485 d 57
3485 3485 s 	db 	pREQUIRED_OPTS1
3486 3486 s 	endm
3486 3486 s 	dbpatchmaybe	0xE5A2	,0x1B	,0x0d
3486 3486 d 59
3486 3486 s 	db 	pB_MAYBE_PATCH
3487 3487 d a2e5
3487 3487 s 	dw 	0xE5A2
3489 3489 d 1b0d
3489 3489 s 	db 	0x1B,0x0d
348b 348b s 	endm
348b 348b s 	dbpatchmaybe	0xE5A2+1	,0x45	,0x0d
348b 348b d 59
348b 348b s 	db 	pB_MAYBE_PATCH
348c 348c d a3e5
348c 348c s 	dw 	0xE5A2+1
348e 348e d 450d
348e 348e s 	db 	0x45,0x0d
3490 3490 s 	endm
3490 3490 s 	dwpatch	0xE497+1	,0xE627	,MD_READ			
3490 3490 d 51
3490 3490 s 	db 	pW_CHK_PATCH
3491 3491 d 98e4
3491 3491 s 	dw 	0xE497+1
3493 3493 d 27e63efa
3493 3493 s 	dw 	0xE627,MD_READ
3497 3497 s 	endm
3497 3497 s 	dwpatch	0xE4A0+1	,0xE62A	,MD_WRITE
3497 3497 d 51
3497 3497 s 	db 	pW_CHK_PATCH
3498 3498 d a1e4
3498 3498 s 	dw 	0xE4A0+1
349a 349a d 2ae653fa
349a 349a s 	dw 	0xE62A,MD_WRITE
349e 349e s 	endm
349e 349e s 	dbpatch	0xEAAE	,0xcd	,0x00
349e 349e d 52
349e 349e s 	db 	pB_CHK_PATCH
349f 349f d aeea
349f 349f s 	dw 	0xEAAE
34a1 34a1 d cd00
34a1 34a1 s 	db 	0xcd,0x00
34a3 34a3 s 	endm
34a3 34a3 s 	dwpatch	0xEAAE+1	,0xE9E9	,0x0000
34a3 34a3 d 51
34a3 34a3 s 	db 	pW_CHK_PATCH
34a4 34a4 d afea
34a4 34a4 s 	dw 	0xEAAE+1
34a6 34a6 d e9e90000
34a6 34a6 s 	dw 	0xE9E9,0x0000
34aa 34aa s 	endm
34aa 34aa s 	dwpatch	0xEAB4+1	,0xEC5D	,MD_READ_INFOSECTOR
34aa 34aa d 51
34aa 34aa s 	db 	pW_CHK_PATCH
34ab 34ab d b5ea
34ab 34ab s 	dw 	0xEAB4+1
34ad 34ad d 5dec68fa
34ad 34ad s 	dw 	0xEC5D,MD_READ_INFOSECTOR
34b1 34b1 s 	endm
34b1 34b1 s 	dwstore	MD_DRV2+1,	0xDF5A
34b1 34b1 d 54
34b1 34b1 s 	db 	pW_STORE
34b2 34b2 d 5adf
34b2 34b2 s 	dw 	0xDF5A
34b4 34b4 d f3fa
34b4 34b4 s 	dw 	MD_DRV2+1
34b6 34b6 s 	endm
34b6 34b6 s 	dwstore	MD_RDBUF2+1,	0xE09A
34b6 34b6 d 54
34b6 34b6 s 	db 	pW_STORE
34b7 34b7 d 9ae0
34b7 34b7 s 	dw 	0xE09A
34b9 34b9 d 02fb
34b9 34b9 s 	dw 	MD_RDBUF2+1
34bb 34bb s 	endm
34bb 34bb s 	dwstore	MD_PARAM2+1,	0xDDC1
34bb 34bb d 54
34bb 34bb s 	db 	pW_STORE
34bc 34bc d c1dd
34bc 34bc s 	dw 	0xDDC1
34be 34be d 1dfa
34be 34be s 	dw 	MD_PARAM2+1
34c0 34c0 s 	endm
34c0 34c0 s 	dwpatch 0xc01b+1	 ,0xDD8B	,md_res_seldsk
34c0 34c0 d 51
34c0 34c0 s 	db 	pW_CHK_PATCH
34c1 34c1 d 1cc0
34c1 34c1 s 	dw 	0xc01b+1
34c3 34c3 d 8bdd0efa
34c3 34c3 s 	dw 	0xDD8B,md_res_seldsk
34c7 34c7 s 	endm
34c7 34c7 s 	dwstore md_old_seld_dsk+1,0xDD8B	,0xdd4c
34c7 34c7 d 54
34c7 34c7 s 	db 	pW_STORE
34c8 34c8 d 8bdd
34c8 34c8 s 	dw 	0xDD8B
34ca 34ca d 12fa
34ca 34ca s 	dw 	md_old_seld_dsk+1
34cc 34cc s 	endm
34cc 34cc s 	;custom checkers
34cc 34cc s 	dwpatch	0xBE80	,0xBE80 ,0xBE80
34cc 34cc d 51
34cc 34cc s 	db 	pW_CHK_PATCH
34cd 34cd d 80be
34cd 34cd s 	dw 	0xBE80
34cf 34cf d 80be80be
34cf 34cf s 	dw 	0xBE80,0xBE80
34d3 34d3 s 	endm
34d3 34d3 s 	dwpatch	0xBE82	,0xBF00 ,0xBF00
34d3 34d3 d 51
34d3 34d3 s 	db 	pW_CHK_PATCH
34d4 34d4 d 82be
34d4 34d4 s 	dw 	0xBE82
34d6 34d6 d 00bf00bf
34d6 34d6 s 	dw 	0xBF00,0xBF00
34da 34da s 	endm
34da 34da s 	dwpatch	0xc000+1	,0xC49A ,0xC49A
34da 34da d 51
34da 34da s 	db 	pW_CHK_PATCH
34db 34db d 01c0
34db 34db s 	dw 	0xc000+1
34dd 34dd d 9ac49ac4
34dd 34dd s 	dw 	0xC49A,0xC49A
34e1 34e1 s 	endm
34e1 34e1 s 	dwpatch	0xc003+1	,0xDBFD ,0xDBFD
34e1 34e1 d 51
34e1 34e1 s 	db 	pW_CHK_PATCH
34e2 34e2 d 04c0
34e2 34e2 s 	dw 	0xc003+1
34e4 34e4 d fddbfddb
34e4 34e4 s 	dw 	0xDBFD,0xDBFD
34e8 34e8 s 	endm
34e8 34e8 s 	stop 'MICRODOS_OPTS1_870430'
34e8 34e8 d 50
34e8 34e8 s 	db 	p_STOP
34e9 34e9 d 4d4943524f444f535f4f505453315f383730343330
34e9 34e9 s 	db 	'MICRODOS_OPTS1_870430'
34fe 34fe d 00
34fe 34fe s 	db 	0
34ff 34ff s 	endm
34ff 34ff f out/include-patcher.asm
34ff 34ff s 	include "generator/V0/out/patcher-cpm2-CPM_1x_89_03_30_RAVI.asm"	; 17 images in collection
34ff 34ff f generator/V0/out/patcher-cpm2-CPM_1x_89_03_30_RAVI.asm
34ff 34ff s _BIOS_CPM_1x_89_03_30_RAVI:
34ff 34ff s 	setSUBBIOS 2
34ff 34ff d 5a
34ff 34ff s 	db	pSubBios
3500 3500 d 02
3500 3500 s 	db 	2
3501 3501 s 	endm
3501 3501 s 	RQ_OPTS1
3501 3501 d 57
3501 3501 s 	db 	pREQUIRED_OPTS1
3502 3502 s 	endm
3502 3502 s 	setCPM
3502 3502 s 	endm
3502 3502 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
3502 3502 d 59
3502 3502 s 	db 	pB_MAYBE_PATCH
3503 3503 d eeda
3503 3503 s 	dw 	0xDAEE
3505 3505 d 1f0d
3505 3505 s 	db 	0x1F,0x0d
3507 3507 s 	endm
3507 3507 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
3507 3507 d 59
3507 3507 s 	db 	pB_MAYBE_PATCH
3508 3508 d f0da
3508 3508 s 	dw 	0xDAEE+2
350a 350a d 0a0d
350a 350a s 	db 	0x0a,0x0d
350c 350c s 	endm
350c 350c s 	dbpatch	0xE8B8+1	,0x49	,0xc9
350c 350c d 52
350c 350c s 	db 	pB_CHK_PATCH
350d 350d d b9e8
350d 350d s 	dw 	0xE8B8+1
350f 350f d 49c9
350f 350f s 	db 	0x49,0xc9
3511 3511 s 	endm
3511 3511 s 	dbpatch	0xDA88 	,0x01	,0x00
3511 3511 d 52
3511 3511 s 	db 	pB_CHK_PATCH
3512 3512 d 88da
3512 3512 s 	dw 	0xDA88
3514 3514 d 0100
3514 3514 s 	db 	0x01,0x00
3516 3516 s 	endm
3516 3516 s 	dbpatch	0xDA9F 	,0x02	,0x00
3516 3516 d 52
3516 3516 s 	db 	pB_CHK_PATCH
3517 3517 d 9fda
3517 3517 s 	dw 	0xDA9F
3519 3519 d 0200
3519 3519 s 	db 	0x02,0x00
351b 351b s 	endm
351b 351b s 	dbpatch	0xDAB6 	,0x04	,0x01
351b 351b d 52
351b 351b s 	db 	pB_CHK_PATCH
351c 351c d b6da
351c 351c s 	dw 	0xDAB6
351e 351e d 0401
351e 351e s 	db 	0x04,0x01
3520 3520 s 	endm
3520 3520 s 	dbpatch	0xDACD 	,0x08	,0x02
3520 3520 d 52
3520 3520 s 	db 	pB_CHK_PATCH
3521 3521 d cdda
3521 3521 s 	dw 	0xDACD
3523 3523 d 0802
3523 3523 s 	db 	0x08,0x02
3525 3525 s 	endm
3525 3525 s 	dwstore	_CPM2_res_DRIVE_TAB+0*2	,0xDA88
3525 3525 d 54
3525 3525 s 	db 	pW_STORE
3526 3526 d 88da
3526 3526 s 	dw 	0xDA88
3528 3528 d 06ea
3528 3528 s 	dw 	_CPM2_res_DRIVE_TAB+0*2
352a 352a s 	endm
352a 352a s 	dwstore	_CPM2_res_DRIVE_TAB+1*2	,0xDA9F
352a 352a d 54
352a 352a s 	db 	pW_STORE
352b 352b d 9fda
352b 352b s 	dw 	0xDA9F
352d 352d d 08ea
352d 352d s 	dw 	_CPM2_res_DRIVE_TAB+1*2
352f 352f s 	endm
352f 352f s 	dwstore	_CPM2_res_DRIVE_TAB+2*2	,0xDAB6
352f 352f d 54
352f 352f s 	db 	pW_STORE
3530 3530 d b6da
3530 3530 s 	dw 	0xDAB6
3532 3532 d 0aea
3532 3532 s 	dw 	_CPM2_res_DRIVE_TAB+2*2
3534 3534 s 	endm
3534 3534 s 	dwstore	_CPM2_res_DRIVE_TAB+3*2	,0xDACD
3534 3534 d 54
3534 3534 s 	db 	pW_STORE
3535 3535 d cdda
3535 3535 s 	dw 	0xDACD
3537 3537 d 0cea
3537 3537 s 	dw 	_CPM2_res_DRIVE_TAB+3*2
3539 3539 s 	endm
3539 3539 s 	dwpatch 0xDEC6+5*2 	,0x0000 ,_CPM2_dph_F
3539 3539 d 51
3539 3539 s 	db 	pW_CHK_PATCH
353a 353a d d0de
353a 353a s 	dw 	0xDEC6+5*2
353c 353c d 000012ea
353c 353c s 	dw 	0x0000,_CPM2_dph_F
3540 3540 s 	endm
3540 3540 s 	dwstore _CPM2_dph_F+8	,0xE1AB
3540 3540 d 54
3540 3540 s 	db 	pW_STORE
3541 3541 d abe1
3541 3541 s 	dw 	0xE1AB
3543 3543 d 1aea
3543 3543 s 	dw 	_CPM2_dph_F+8
3545 3545 s 	endm
3545 3545 s 	dwpatch 0xDA1B+1 	,0xDE82	,_CPM2_res_seldsk
3545 3545 d 51
3545 3545 s 	db 	pW_CHK_PATCH
3546 3546 d 1cda
3546 3546 s 	dw 	0xDA1B+1
3548 3548 d 82de6bea
3548 3548 s 	dw 	0xDE82,_CPM2_res_seldsk
354c 354c s 	endm
354c 354c s 	dwstore	_CPM2_old_seld_dsk+1	,0xDE82
354c 354c d 54
354c 354c s 	db 	pW_STORE
354d 354d d 82de
354d 354d s 	dw 	0xDE82
354f 354f d 6fea
354f 354f s 	dw 	_CPM2_old_seld_dsk+1
3551 3551 s 	endm
3551 3551 s 	dbpatch	0xE6DF	,0x77	,0x00
3551 3551 d 52
3551 3551 s 	db 	pB_CHK_PATCH
3552 3552 d dfe6
3552 3552 s 	dw 	0xE6DF
3554 3554 d 7700
3554 3554 s 	db 	0x77,0x00
3556 3556 s 	endm
3556 3556 s 	dwstore	_CPM2_r_p_SELDSKDRIVER+1	,0xE199
3556 3556 d 54
3556 3556 s 	db 	pW_STORE
3557 3557 d 99e1
3557 3557 s 	dw 	0xE199
3559 3559 d 88ea
3559 3559 s 	dw 	_CPM2_r_p_SELDSKDRIVER+1
355b 355b s 	endm
355b 355b s 	dwstore	_CPM2_r_p_SELDSKDRIVEW+1	,0xE199
355b 355b d 54
355b 355b s 	db 	pW_STORE
355c 355c d 99e1
355c 355c s 	dw 	0xE199
355e 355e d c5ea
355e 355e s 	dw 	_CPM2_r_p_SELDSKDRIVEW+1
3560 3560 s 	endm
3560 3560 s 	dwpatch	0xDA27+1	,0xDEE5	,_CPM2_res_READ
3560 3560 d 51
3560 3560 s 	db 	pW_CHK_PATCH
3561 3561 d 28da
3561 3561 s 	dw 	0xDA27+1
3563 3563 d e5de75ea
3563 3563 s 	dw 	0xDEE5,_CPM2_res_READ
3567 3567 s 	endm
3567 3567 s 	dwpatch	0xDA2A+1	,0xE01B	,_CPM2_res_WRITE
3567 3567 d 51
3567 3567 s 	db 	pW_CHK_PATCH
3568 3568 d 2bda
3568 3568 s 	dw 	0xDA2A+1
356a 356a d 1be0b2ea
356a 356a s 	dw 	0xE01B,_CPM2_res_WRITE
356e 356e s 	endm
356e 356e s 	dwpatch	0xDBC2+1	,0xDEE5	,_CPM2_res_READ
356e 356e d 51
356e 356e s 	db 	pW_CHK_PATCH
356f 356f d c3db
356f 356f s 	dw 	0xDBC2+1
3571 3571 d e5de75ea
3571 3571 s 	dw 	0xDEE5,_CPM2_res_READ
3575 3575 s 	endm
3575 3575 s 	dwpatch	0xdeb4+1	,0xE615	,_CPM2_res_GETINFO
3575 3575 d 51
3575 3575 s 	db 	pW_CHK_PATCH
3576 3576 d b5de
3576 3576 s 	dw 	0xdeb4+1
3578 3578 d 15e6efea
3578 3578 s 	dw 	0xE615,_CPM2_res_GETINFO
357c 357c s 	endm
357c 357c s 	dwstore	_CPM2__old_read+1	,0xDEE5
357c 357c d 54
357c 357c s 	db 	pW_STORE
357d 357d d e5de
357d 357d s 	dw 	0xDEE5
357f 357f d b0ea
357f 357f s 	dw 	_CPM2__old_read+1
3581 3581 s 	endm
3581 3581 s 	dwstore	_CPM2__old_write+1	,0xE01B
3581 3581 d 54
3581 3581 s 	db 	pW_STORE
3582 3582 d 1be0
3582 3582 s 	dw 	0xE01B
3584 3584 d edea
3584 3584 s 	dw 	_CPM2__old_write+1
3586 3586 s 	endm
3586 3586 s 	dwstore	_CPM2__old_getinfo+1	,0xE615
3586 3586 d 54
3586 3586 s 	db 	pW_STORE
3587 3587 d 15e6
3587 3587 s 	dw 	0xE615
3589 3589 d fdea
3589 3589 s 	dw 	_CPM2__old_getinfo+1
358b 358b s 	endm
358b 358b s 	dbpatch	0xE655		,0x21	,0x21
358b 358b d 52
358b 358b s 	db 	pB_CHK_PATCH
358c 358c d 55e6
358c 358c s 	dw 	0xE655
358e 358e d 2121
358e 358e s 	db 	0x21,0x21
3590 3590 s 	endm
3590 3590 s 	dwpatch	0xE655+1 	,0xE685	,0xE685
3590 3590 d 51
3590 3590 s 	db 	pW_CHK_PATCH
3591 3591 d 56e6
3591 3591 s 	dw 	0xE655+1
3593 3593 d 85e685e6
3593 3593 s 	dw 	0xE685,0xE685
3597 3597 s 	endm
3597 3597 s 	dwstore	_CPM2__old_getinfo_chkdo+1	,0xE655
3597 3597 d 54
3597 3597 s 	db 	pW_STORE
3598 3598 d 55e6
3598 3598 s 	dw 	0xE655
359a 359a d faea
359a 359a s 	dw 	_CPM2__old_getinfo_chkdo+1
359c 359c s 	endm
359c 359c s 	dwstore	_CPM2_r_p_DSK1+1	,0xE18F 	;read
359c 359c d 54
359c 359c s 	db 	pW_STORE
359d 359d d 8fe1
359d 359d s 	dw 	0xE18F
359f 359f d 76ea
359f 359f s 	dw 	_CPM2_r_p_DSK1+1
35a1 35a1 s 	endm
35a1 35a1 s 	dwstore	_CPM2_r_p_TRK1+1	,0xE193 	
35a1 35a1 d 54
35a1 35a1 s 	db 	pW_STORE
35a2 35a2 d 93e1
35a2 35a2 s 	dw 	0xE193
35a4 35a4 d 91ea
35a4 35a4 s 	dw 	_CPM2_r_p_TRK1+1
35a6 35a6 s 	endm
35a6 35a6 s 	dwstore	_CPM2_r_p_SEC1+1	,0xE194 	
35a6 35a6 d 54
35a6 35a6 s 	db 	pW_STORE
35a7 35a7 d 94e1
35a7 35a7 s 	dw 	0xE194
35a9 35a9 d 97ea
35a9 35a9 s 	dw 	_CPM2_r_p_SEC1+1
35ab 35ab s 	endm
35ab 35ab s 	dwstore	_CPM2_r_p_DMA1+1	,0xE195 	
35ab 35ab d 54
35ab 35ab s 	db 	pW_STORE
35ac 35ac d 95e1
35ac 35ac s 	dw 	0xE195
35ae 35ae d a8ea
35ae 35ae s 	dw 	_CPM2_r_p_DMA1+1
35b0 35b0 s 	endm
35b0 35b0 s 	dwstore	_CPM2_r_p_DSK2+1	,0xE18F 	;write
35b0 35b0 d 54
35b0 35b0 s 	db 	pW_STORE
35b1 35b1 d 8fe1
35b1 35b1 s 	dw 	0xE18F
35b3 35b3 d b3ea
35b3 35b3 s 	dw 	_CPM2_r_p_DSK2+1
35b5 35b5 s 	endm
35b5 35b5 s 	dwstore	_CPM2_r_p_TRK2+1	,0xE193 	
35b5 35b5 d 54
35b5 35b5 s 	db 	pW_STORE
35b6 35b6 d 93e1
35b6 35b6 s 	dw 	0xE193
35b8 35b8 d ceea
35b8 35b8 s 	dw 	_CPM2_r_p_TRK2+1
35ba 35ba s 	endm
35ba 35ba s 	dwstore	_CPM2_r_p_SEC2+1	,0xE194 	
35ba 35ba d 54
35ba 35ba s 	db 	pW_STORE
35bb 35bb d 94e1
35bb 35bb s 	dw 	0xE194
35bd 35bd d d4ea
35bd 35bd s 	dw 	_CPM2_r_p_SEC2+1
35bf 35bf s 	endm
35bf 35bf s 	dwstore	_CPM2_r_p_DMA2+1	,0xE195 	
35bf 35bf d 54
35bf 35bf s 	db 	pW_STORE
35c0 35c0 d 95e1
35c0 35c0 s 	dw 	0xE195
35c2 35c2 d e5ea
35c2 35c2 s 	dw 	_CPM2_r_p_DMA2+1
35c4 35c4 s 	endm
35c4 35c4 s 	dwstore	_CPM2_r_p_DSK3+1	,0xE18F 	;readinfo
35c4 35c4 d 54
35c4 35c4 s 	db 	pW_STORE
35c5 35c5 d 8fe1
35c5 35c5 s 	dw 	0xE18F
35c7 35c7 d 82eb
35c7 35c7 s 	dw 	_CPM2_r_p_DSK3+1
35c9 35c9 s 	endm
35c9 35c9 s 
35c9 35c9 s 	stop 'CPM_1x_89_03_30_RAVI'
35c9 35c9 d 50
35c9 35c9 s 	db 	p_STOP
35ca 35ca d 43504d5f31785f38395f30335f33305f52415649
35ca 35ca s 	db 	'CPM_1x_89_03_30_RAVI'
35de 35de d 00
35de 35de s 	db 	0
35df 35df s 	endm
35df 35df f out/include-patcher.asm
35df 35df s 	include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861011.asm"	;  7 images in collection
35df 35df f generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861011.asm
35df 35df s _BIOS_MICRODOS_OPTS1_861011:
35df 35df s 	setMICRODOS
35df 35df d 56
35df 35df s 	db 	pSETFLAG_MICRODOS
35e0 35e0 s 	endm
35e0 35e0 s 	RQ_OPTS1
35e0 35e0 d 57
35e0 35e0 s 	db 	pREQUIRED_OPTS1
35e1 35e1 s 	endm
35e1 35e1 s 	dbpatchmaybe	0xE693	,0x1B	,0x0d
35e1 35e1 d 59
35e1 35e1 s 	db 	pB_MAYBE_PATCH
35e2 35e2 d 93e6
35e2 35e2 s 	dw 	0xE693
35e4 35e4 d 1b0d
35e4 35e4 s 	db 	0x1B,0x0d
35e6 35e6 s 	endm
35e6 35e6 s 	dbpatchmaybe	0xE693+1	,0x45	,0x0d
35e6 35e6 d 59
35e6 35e6 s 	db 	pB_MAYBE_PATCH
35e7 35e7 d 94e6
35e7 35e7 s 	dw 	0xE693+1
35e9 35e9 d 450d
35e9 35e9 s 	db 	0x45,0x0d
35eb 35eb s 	endm
35eb 35eb s 	dwpatch	0xE497+1	,0xE627	,MD_READ			
35eb 35eb d 51
35eb 35eb s 	db 	pW_CHK_PATCH
35ec 35ec d 98e4
35ec 35ec s 	dw 	0xE497+1
35ee 35ee d 27e63efa
35ee 35ee s 	dw 	0xE627,MD_READ
35f2 35f2 s 	endm
35f2 35f2 s 	dwpatch	0xE4A0+1	,0xE62A	,MD_WRITE
35f2 35f2 d 51
35f2 35f2 s 	db 	pW_CHK_PATCH
35f3 35f3 d a1e4
35f3 35f3 s 	dw 	0xE4A0+1
35f5 35f5 d 2ae653fa
35f5 35f5 s 	dw 	0xE62A,MD_WRITE
35f9 35f9 s 	endm
35f9 35f9 s 	dbpatch	0xEAAE	,0xcd	,0x00
35f9 35f9 d 52
35f9 35f9 s 	db 	pB_CHK_PATCH
35fa 35fa d aeea
35fa 35fa s 	dw 	0xEAAE
35fc 35fc d cd00
35fc 35fc s 	db 	0xcd,0x00
35fe 35fe s 	endm
35fe 35fe s 	dwpatch	0xEAAE+1	,0xE9E9	,0x0000
35fe 35fe d 51
35fe 35fe s 	db 	pW_CHK_PATCH
35ff 35ff d afea
35ff 35ff s 	dw 	0xEAAE+1
3601 3601 d e9e90000
3601 3601 s 	dw 	0xE9E9,0x0000
3605 3605 s 	endm
3605 3605 s 	dwpatch	0xEAB4+1	,0xEC5D	,MD_READ_INFOSECTOR
3605 3605 d 51
3605 3605 s 	db 	pW_CHK_PATCH
3606 3606 d b5ea
3606 3606 s 	dw 	0xEAB4+1
3608 3608 d 5dec68fa
3608 3608 s 	dw 	0xEC5D,MD_READ_INFOSECTOR
360c 360c s 	endm
360c 360c s 	dwstore	MD_DRV2+1,	0xDFC8
360c 360c d 54
360c 360c s 	db 	pW_STORE
360d 360d d c8df
360d 360d s 	dw 	0xDFC8
360f 360f d f3fa
360f 360f s 	dw 	MD_DRV2+1
3611 3611 s 	endm
3611 3611 s 	dwstore	MD_RDBUF2+1,	0xEEB0
3611 3611 d 54
3611 3611 s 	db 	pW_STORE
3612 3612 d b0ee
3612 3612 s 	dw 	0xEEB0
3614 3614 d 02fb
3614 3614 s 	dw 	MD_RDBUF2+1
3616 3616 s 	endm
3616 3616 s 	dwstore	MD_PARAM2+1,	0xDDBC
3616 3616 d 54
3616 3616 s 	db 	pW_STORE
3617 3617 d bcdd
3617 3617 s 	dw 	0xDDBC
3619 3619 d 1dfa
3619 3619 s 	dw 	MD_PARAM2+1
361b 361b s 	endm
361b 361b s 	dwpatch 0xc01b+1	 ,0xDD86	,md_res_seldsk
361b 361b d 51
361b 361b s 	db 	pW_CHK_PATCH
361c 361c d 1cc0
361c 361c s 	dw 	0xc01b+1
361e 361e d 86dd0efa
361e 361e s 	dw 	0xDD86,md_res_seldsk
3622 3622 s 	endm
3622 3622 s 	dwstore md_old_seld_dsk+1,0xDD86	,0xdd4c
3622 3622 d 54
3622 3622 s 	db 	pW_STORE
3623 3623 d 86dd
3623 3623 s 	dw 	0xDD86
3625 3625 d 12fa
3625 3625 s 	dw 	md_old_seld_dsk+1
3627 3627 s 	endm
3627 3627 s 	;custom checkers
3627 3627 s 	dwpatch	0xBC80	,0xBC80 ,0xBC80
3627 3627 d 51
3627 3627 s 	db 	pW_CHK_PATCH
3628 3628 d 80bc
3628 3628 s 	dw 	0xBC80
362a 362a d 80bc80bc
362a 362a s 	dw 	0xBC80,0xBC80
362e 362e s 	endm
362e 362e s 	dwpatch	0xBC82	,0xBD00 ,0xBD00
362e 362e d 51
362e 362e s 	db 	pW_CHK_PATCH
362f 362f d 82bc
362f 362f s 	dw 	0xBC82
3631 3631 d 00bd00bd
3631 3631 s 	dw 	0xBD00,0xBD00
3635 3635 s 	endm
3635 3635 s 	dwpatch	0xc000+1	,0xC4BF ,0xC4BF
3635 3635 d 51
3635 3635 s 	db 	pW_CHK_PATCH
3636 3636 d 01c0
3636 3636 s 	dw 	0xc000+1
3638 3638 d bfc4bfc4
3638 3638 s 	dw 	0xC4BF,0xC4BF
363c 363c s 	endm
363c 363c s 	dwpatch	0xc003+1	,0xDBFB ,0xDBFB
363c 363c d 51
363c 363c s 	db 	pW_CHK_PATCH
363d 363d d 04c0
363d 363d s 	dw 	0xc003+1
363f 363f d fbdbfbdb
363f 363f s 	dw 	0xDBFB,0xDBFB
3643 3643 s 	endm
3643 3643 s 	dbpatch	0xDF95	,0x50 ,0x50
3643 3643 d 52
3643 3643 s 	db 	pB_CHK_PATCH
3644 3644 d 95df
3644 3644 s 	dw 	0xDF95
3646 3646 d 5050
3646 3646 s 	db 	0x50,0x50
3648 3648 s 	endm
3648 3648 s 	dbpatch	0xDF97	,0x18 ,0x18
3648 3648 d 52
3648 3648 s 	db 	pB_CHK_PATCH
3649 3649 d 97df
3649 3649 s 	dw 	0xDF97
364b 364b d 1818
364b 364b s 	db 	0x18,0x18
364d 364d s 	endm
364d 364d s 	stop 'MICRODOS_OPTS1_861011'
364d 364d d 50
364d 364d s 	db 	p_STOP
364e 364e d 4d4943524f444f535f4f505453315f383631303131
364e 364e s 	db 	'MICRODOS_OPTS1_861011'
3663 3663 d 00
3663 3663 s 	db 	0
3664 3664 s 	endm
3664 3664 f out/include-patcher.asm
3664 3664 s 	include "generator/V0/out/patcher-cpm1-CPM_21_91___LAP.asm"	;  4 images in collection
3664 3664 f generator/V0/out/patcher-cpm1-CPM_21_91___LAP.asm
3664 3664 s _BIOS_CPM_21_91___LAP:
3664 3664 s 	setSUBBIOS 1
3664 3664 d 5a
3664 3664 s 	db	pSubBios
3665 3665 d 01
3665 3665 s 	db 	1
3666 3666 s 	endm
3666 3666 s 	RQ_OPTS_ANY
3666 3666 s 	endm
3666 3666 s 	setCPM
3666 3666 s 	endm
3666 3666 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
3666 3666 d 59
3666 3666 s 	db 	pB_MAYBE_PATCH
3667 3667 d eeda
3667 3667 s 	dw 	0xDAEE
3669 3669 d 1f0d
3669 3669 s 	db 	0x1F,0x0d
366b 366b s 	endm
366b 366b s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
366b 366b d 59
366b 366b s 	db 	pB_MAYBE_PATCH
366c 366c d f0da
366c 366c s 	dw 	0xDAEE+2
366e 366e d 0a0d
366e 366e s 	db 	0x0a,0x0d
3670 3670 s 	endm
3670 3670 s 	dbpatch	0xE0D2+1	,0x49	,0xc9
3670 3670 d 52
3670 3670 s 	db 	pB_CHK_PATCH
3671 3671 d d3e0
3671 3671 s 	dw 	0xE0D2+1
3673 3673 d 49c9
3673 3673 s 	db 	0x49,0xc9
3675 3675 s 	endm
3675 3675 s 	dbpatch	0xDA88 	,0x01	,0x00
3675 3675 d 52
3675 3675 s 	db 	pB_CHK_PATCH
3676 3676 d 88da
3676 3676 s 	dw 	0xDA88
3678 3678 d 0100
3678 3678 s 	db 	0x01,0x00
367a 367a s 	endm
367a 367a s 	dbpatch	0xDA9F 	,0x02	,0x00
367a 367a d 52
367a 367a s 	db 	pB_CHK_PATCH
367b 367b d 9fda
367b 367b s 	dw 	0xDA9F
367d 367d d 0200
367d 367d s 	db 	0x02,0x00
367f 367f s 	endm
367f 367f s 	dbpatch	0xDAB6 	,0x04	,0x01
367f 367f d 52
367f 367f s 	db 	pB_CHK_PATCH
3680 3680 d b6da
3680 3680 s 	dw 	0xDAB6
3682 3682 d 0401
3682 3682 s 	db 	0x04,0x01
3684 3684 s 	endm
3684 3684 s 	dbpatch	0xDACD 	,0x08	,0x02
3684 3684 d 52
3684 3684 s 	db 	pB_CHK_PATCH
3685 3685 d cdda
3685 3685 s 	dw 	0xDACD
3687 3687 d 0802
3687 3687 s 	db 	0x08,0x02
3689 3689 s 	endm
3689 3689 s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
3689 3689 d 54
3689 3689 s 	db 	pW_STORE
368a 368a d 88da
368a 368a s 	dw 	0xDA88
368c 368c d ace8
368c 368c s 	dw 	_CPM1_res_DRIVE_TAB+0*2
368e 368e s 	endm
368e 368e s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
368e 368e d 54
368e 368e s 	db 	pW_STORE
368f 368f d 9fda
368f 368f s 	dw 	0xDA9F
3691 3691 d aee8
3691 3691 s 	dw 	_CPM1_res_DRIVE_TAB+1*2
3693 3693 s 	endm
3693 3693 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
3693 3693 d 54
3693 3693 s 	db 	pW_STORE
3694 3694 d b6da
3694 3694 s 	dw 	0xDAB6
3696 3696 d b0e8
3696 3696 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
3698 3698 s 	endm
3698 3698 s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
3698 3698 d 54
3698 3698 s 	db 	pW_STORE
3699 3699 d cdda
3699 3699 s 	dw 	0xDACD
369b 369b d b2e8
369b 369b s 	dw 	_CPM1_res_DRIVE_TAB+3*2
369d 369d s 	endm
369d 369d s 	dwpatch 0xDCF2+5*2 	,0x0000 ,_CPM1_dph_F
369d 369d d 51
369d 369d s 	db 	pW_CHK_PATCH
369e 369e d fcdc
369e 369e s 	dw 	0xDCF2+5*2
36a0 36a0 d 0000b8e8
36a0 36a0 s 	dw 	0x0000,_CPM1_dph_F
36a4 36a4 s 	endm
36a4 36a4 s 	dwstore _CPM1_dph_F+8	,0xEBA6
36a4 36a4 d 54
36a4 36a4 s 	db 	pW_STORE
36a5 36a5 d a6eb
36a5 36a5 s 	dw 	0xEBA6
36a7 36a7 d c0e8
36a7 36a7 s 	dw 	_CPM1_dph_F+8
36a9 36a9 s 	endm
36a9 36a9 s 	dwpatch 0xDA1B+1 	,0xDCAE	,_CPM1_res_seldsk
36a9 36a9 d 51
36a9 36a9 s 	db 	pW_CHK_PATCH
36aa 36aa d 1cda
36aa 36aa s 	dw 	0xDA1B+1
36ac 36ac d aedc11e9
36ac 36ac s 	dw 	0xDCAE,_CPM1_res_seldsk
36b0 36b0 s 	endm
36b0 36b0 s 	dwstore	_CPM1_old_seld_dsk+1	,0xDCAE
36b0 36b0 d 54
36b0 36b0 s 	db 	pW_STORE
36b1 36b1 d aedc
36b1 36b1 s 	dw 	0xDCAE
36b3 36b3 d 15e9
36b3 36b3 s 	dw 	_CPM1_old_seld_dsk+1
36b5 36b5 s 	endm
36b5 36b5 s 	dbpatch	0xE69F	,0x77	,0x00
36b5 36b5 d 52
36b5 36b5 s 	db 	pB_CHK_PATCH
36b6 36b6 d 9fe6
36b6 36b6 s 	dw 	0xE69F
36b8 36b8 d 7700
36b8 36b8 s 	db 	0x77,0x00
36ba 36ba s 	endm
36ba 36ba s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFED
36ba 36ba d 54
36ba 36ba s 	db 	pW_STORE
36bb 36bb d eddf
36bb 36bb s 	dw 	0xDFED
36bd 36bd d 2ee9
36bd 36bd s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
36bf 36bf s 	endm
36bf 36bf s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFED
36bf 36bf d 54
36bf 36bf s 	db 	pW_STORE
36c0 36c0 d eddf
36c0 36c0 s 	dw 	0xDFED
36c2 36c2 d 6be9
36c2 36c2 s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
36c4 36c4 s 	endm
36c4 36c4 s 	dwpatch	0xDA27+1	,0xDD11	,_CPM1_res_READ
36c4 36c4 d 51
36c4 36c4 s 	db 	pW_CHK_PATCH
36c5 36c5 d 28da
36c5 36c5 s 	dw 	0xDA27+1
36c7 36c7 d 11dd1be9
36c7 36c7 s 	dw 	0xDD11,_CPM1_res_READ
36cb 36cb s 	endm
36cb 36cb s 	dwpatch	0xDA2A+1	,0xDE47	,_CPM1_res_WRITE
36cb 36cb d 51
36cb 36cb s 	db 	pW_CHK_PATCH
36cc 36cc d 2bda
36cc 36cc s 	dw 	0xDA2A+1
36ce 36ce d 47de58e9
36ce 36ce s 	dw 	0xDE47,_CPM1_res_WRITE
36d2 36d2 s 	endm
36d2 36d2 s 	dwpatch	0xDB5F+1	,0xDD11	,_CPM1_res_READ
36d2 36d2 d 51
36d2 36d2 s 	db 	pW_CHK_PATCH
36d3 36d3 d 60db
36d3 36d3 s 	dw 	0xDB5F+1
36d5 36d5 d 11dd1be9
36d5 36d5 s 	dw 	0xDD11,_CPM1_res_READ
36d9 36d9 s 	endm
36d9 36d9 s 	dwpatch	0xdce0+1	,0xE5D5	,_CPM1_res_GETINFO
36d9 36d9 d 51
36d9 36d9 s 	db 	pW_CHK_PATCH
36da 36da d e1dc
36da 36da s 	dw 	0xdce0+1
36dc 36dc d d5e595e9
36dc 36dc s 	dw 	0xE5D5,_CPM1_res_GETINFO
36e0 36e0 s 	endm
36e0 36e0 s 	dwstore	_CPM1__old_read+1	,0xDD11
36e0 36e0 d 54
36e0 36e0 s 	db 	pW_STORE
36e1 36e1 d 11dd
36e1 36e1 s 	dw 	0xDD11
36e3 36e3 d 56e9
36e3 36e3 s 	dw 	_CPM1__old_read+1
36e5 36e5 s 	endm
36e5 36e5 s 	dwstore	_CPM1__old_write+1	,0xDE47
36e5 36e5 d 54
36e5 36e5 s 	db 	pW_STORE
36e6 36e6 d 47de
36e6 36e6 s 	dw 	0xDE47
36e8 36e8 d 93e9
36e8 36e8 s 	dw 	_CPM1__old_write+1
36ea 36ea s 	endm
36ea 36ea s 	dwstore	_CPM1__old_getinfo+1	,0xE5D5
36ea 36ea d 54
36ea 36ea s 	db 	pW_STORE
36eb 36eb d d5e5
36eb 36eb s 	dw 	0xE5D5
36ed 36ed d a3e9
36ed 36ed s 	dw 	_CPM1__old_getinfo+1
36ef 36ef s 	endm
36ef 36ef s 	dbpatch	0xE615		,0x21	,0x21
36ef 36ef d 52
36ef 36ef s 	db 	pB_CHK_PATCH
36f0 36f0 d 15e6
36f0 36f0 s 	dw 	0xE615
36f2 36f2 d 2121
36f2 36f2 s 	db 	0x21,0x21
36f4 36f4 s 	endm
36f4 36f4 s 	dwpatch	0xE615+1 	,0xE645	,0xE645
36f4 36f4 d 51
36f4 36f4 s 	db 	pW_CHK_PATCH
36f5 36f5 d 16e6
36f5 36f5 s 	dw 	0xE615+1
36f7 36f7 d 45e645e6
36f7 36f7 s 	dw 	0xE645,0xE645
36fb 36fb s 	endm
36fb 36fb s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE615
36fb 36fb d 54
36fb 36fb s 	db 	pW_STORE
36fc 36fc d 15e6
36fc 36fc s 	dw 	0xE615
36fe 36fe d a0e9
36fe 36fe s 	dw 	_CPM1__old_getinfo_chkdo+1
3700 3700 s 	endm
3700 3700 s 	dwstore	_CPM1_r_p_DSK1+1	,0xDFE3 	;read
3700 3700 d 54
3700 3700 s 	db 	pW_STORE
3701 3701 d e3df
3701 3701 s 	dw 	0xDFE3
3703 3703 d 1ce9
3703 3703 s 	dw 	_CPM1_r_p_DSK1+1
3705 3705 s 	endm
3705 3705 s 	dwstore	_CPM1_r_p_TRK1+1	,0xDFE7 	
3705 3705 d 54
3705 3705 s 	db 	pW_STORE
3706 3706 d e7df
3706 3706 s 	dw 	0xDFE7
3708 3708 d 37e9
3708 3708 s 	dw 	_CPM1_r_p_TRK1+1
370a 370a s 	endm
370a 370a s 	dwstore	_CPM1_r_p_SEC1+1	,0xDFE8 	
370a 370a d 54
370a 370a s 	db 	pW_STORE
370b 370b d e8df
370b 370b s 	dw 	0xDFE8
370d 370d d 3de9
370d 370d s 	dw 	_CPM1_r_p_SEC1+1
370f 370f s 	endm
370f 370f s 	dwstore	_CPM1_r_p_DMA1+1	,0xDFE9 	
370f 370f d 54
370f 370f s 	db 	pW_STORE
3710 3710 d e9df
3710 3710 s 	dw 	0xDFE9
3712 3712 d 4ee9
3712 3712 s 	dw 	_CPM1_r_p_DMA1+1
3714 3714 s 	endm
3714 3714 s 	dwstore	_CPM1_r_p_DSK2+1	,0xDFE3 	;write
3714 3714 d 54
3714 3714 s 	db 	pW_STORE
3715 3715 d e3df
3715 3715 s 	dw 	0xDFE3
3717 3717 d 59e9
3717 3717 s 	dw 	_CPM1_r_p_DSK2+1
3719 3719 s 	endm
3719 3719 s 	dwstore	_CPM1_r_p_TRK2+1	,0xDFE7 	
3719 3719 d 54
3719 3719 s 	db 	pW_STORE
371a 371a d e7df
371a 371a s 	dw 	0xDFE7
371c 371c d 74e9
371c 371c s 	dw 	_CPM1_r_p_TRK2+1
371e 371e s 	endm
371e 371e s 	dwstore	_CPM1_r_p_SEC2+1	,0xDFE8 	
371e 371e d 54
371e 371e s 	db 	pW_STORE
371f 371f d e8df
371f 371f s 	dw 	0xDFE8
3721 3721 d 7ae9
3721 3721 s 	dw 	_CPM1_r_p_SEC2+1
3723 3723 s 	endm
3723 3723 s 	dwstore	_CPM1_r_p_DMA2+1	,0xDFE9 	
3723 3723 d 54
3723 3723 s 	db 	pW_STORE
3724 3724 d e9df
3724 3724 s 	dw 	0xDFE9
3726 3726 d 8be9
3726 3726 s 	dw 	_CPM1_r_p_DMA2+1
3728 3728 s 	endm
3728 3728 s 	dwstore	_CPM1_r_p_DSK3+1	,0xDFE3 	;readinfo
3728 3728 d 54
3728 3728 s 	db 	pW_STORE
3729 3729 d e3df
3729 3729 s 	dw 	0xDFE3
372b 372b d 28ea
372b 372b s 	dw 	_CPM1_r_p_DSK3+1
372d 372d s 	endm
372d 372d s 
372d 372d s 	stop 'CPM_21_91___LAP'
372d 372d d 50
372d 372d s 	db 	p_STOP
372e 372e d 43504d5f32315f39315f5f5f4c4150
372e 372e s 	db 	'CPM_21_91___LAP'
373d 373d d 00
373d 373d s 	db 	0
373e 373e s 	endm
373e 373e f out/include-patcher.asm
373e 373e s 	include "generator/V0/out/patcher-cpm1-CPM_20_88___miks.asm"	;  4 images in collection
373e 373e f generator/V0/out/patcher-cpm1-CPM_20_88___miks.asm
373e 373e s _BIOS_CPM_20_88___miks:
373e 373e s 	setSUBBIOS 1
373e 373e d 5a
373e 373e s 	db	pSubBios
373f 373f d 01
373f 373f s 	db 	1
3740 3740 s 	endm
3740 3740 s 	RQ_OPTS_ANY
3740 3740 s 	endm
3740 3740 s 	setCPM
3740 3740 s 	endm
3740 3740 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
3740 3740 d 59
3740 3740 s 	db 	pB_MAYBE_PATCH
3741 3741 d eeda
3741 3741 s 	dw 	0xDAEE
3743 3743 d 1f0d
3743 3743 s 	db 	0x1F,0x0d
3745 3745 s 	endm
3745 3745 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
3745 3745 d 59
3745 3745 s 	db 	pB_MAYBE_PATCH
3746 3746 d f0da
3746 3746 s 	dw 	0xDAEE+2
3748 3748 d 0a0d
3748 3748 s 	db 	0x0a,0x0d
374a 374a s 	endm
374a 374a s 	dbpatch	0xE3DC+1	,0x49	,0xc9
374a 374a d 52
374a 374a s 	db 	pB_CHK_PATCH
374b 374b d dde3
374b 374b s 	dw 	0xE3DC+1
374d 374d d 49c9
374d 374d s 	db 	0x49,0xc9
374f 374f s 	endm
374f 374f s 	dbpatch	0xDA88 	,0x01	,0x00
374f 374f d 52
374f 374f s 	db 	pB_CHK_PATCH
3750 3750 d 88da
3750 3750 s 	dw 	0xDA88
3752 3752 d 0100
3752 3752 s 	db 	0x01,0x00
3754 3754 s 	endm
3754 3754 s 	dbpatch	0xDA9F 	,0x02	,0x00
3754 3754 d 52
3754 3754 s 	db 	pB_CHK_PATCH
3755 3755 d 9fda
3755 3755 s 	dw 	0xDA9F
3757 3757 d 0200
3757 3757 s 	db 	0x02,0x00
3759 3759 s 	endm
3759 3759 s 	dbpatch	0xDAB6 	,0x04	,0x01
3759 3759 d 52
3759 3759 s 	db 	pB_CHK_PATCH
375a 375a d b6da
375a 375a s 	dw 	0xDAB6
375c 375c d 0401
375c 375c s 	db 	0x04,0x01
375e 375e s 	endm
375e 375e s 	dbpatch	0xDACD 	,0x08	,0x02
375e 375e d 52
375e 375e s 	db 	pB_CHK_PATCH
375f 375f d cdda
375f 375f s 	dw 	0xDACD
3761 3761 d 0802
3761 3761 s 	db 	0x08,0x02
3763 3763 s 	endm
3763 3763 s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
3763 3763 d 54
3763 3763 s 	db 	pW_STORE
3764 3764 d 88da
3764 3764 s 	dw 	0xDA88
3766 3766 d ace8
3766 3766 s 	dw 	_CPM1_res_DRIVE_TAB+0*2
3768 3768 s 	endm
3768 3768 s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
3768 3768 d 54
3768 3768 s 	db 	pW_STORE
3769 3769 d 9fda
3769 3769 s 	dw 	0xDA9F
376b 376b d aee8
376b 376b s 	dw 	_CPM1_res_DRIVE_TAB+1*2
376d 376d s 	endm
376d 376d s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
376d 376d d 54
376d 376d s 	db 	pW_STORE
376e 376e d b6da
376e 376e s 	dw 	0xDAB6
3770 3770 d b0e8
3770 3770 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
3772 3772 s 	endm
3772 3772 s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
3772 3772 d 54
3772 3772 s 	db 	pW_STORE
3773 3773 d cdda
3773 3773 s 	dw 	0xDACD
3775 3775 d b2e8
3775 3775 s 	dw 	_CPM1_res_DRIVE_TAB+3*2
3777 3777 s 	endm
3777 3777 s 	dwpatch 0xDCD0+5*2 	,0x0000 ,_CPM1_dph_F
3777 3777 d 51
3777 3777 s 	db 	pW_CHK_PATCH
3778 3778 d dadc
3778 3778 s 	dw 	0xDCD0+5*2
377a 377a d 0000b8e8
377a 377a s 	dw 	0x0000,_CPM1_dph_F
377e 377e s 	endm
377e 377e s 	dwstore _CPM1_dph_F+8	,0xEBA6
377e 377e d 54
377e 377e s 	db 	pW_STORE
377f 377f d a6eb
377f 377f s 	dw 	0xEBA6
3781 3781 d c0e8
3781 3781 s 	dw 	_CPM1_dph_F+8
3783 3783 s 	endm
3783 3783 s 	dwpatch 0xDA1B+1 	,0xDC8C	,_CPM1_res_seldsk
3783 3783 d 51
3783 3783 s 	db 	pW_CHK_PATCH
3784 3784 d 1cda
3784 3784 s 	dw 	0xDA1B+1
3786 3786 d 8cdc11e9
3786 3786 s 	dw 	0xDC8C,_CPM1_res_seldsk
378a 378a s 	endm
378a 378a s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC8C
378a 378a d 54
378a 378a s 	db 	pW_STORE
378b 378b d 8cdc
378b 378b s 	dw 	0xDC8C
378d 378d d 15e9
378d 378d s 	dw 	_CPM1_old_seld_dsk+1
378f 378f s 	endm
378f 378f s 	dbpatch	0xE64F	,0x77	,0x00
378f 378f d 52
378f 378f s 	db 	pB_CHK_PATCH
3790 3790 d 4fe6
3790 3790 s 	dw 	0xE64F
3792 3792 d 7700
3792 3792 s 	db 	0x77,0x00
3794 3794 s 	endm
3794 3794 s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFA3
3794 3794 d 54
3794 3794 s 	db 	pW_STORE
3795 3795 d a3df
3795 3795 s 	dw 	0xDFA3
3797 3797 d 2ee9
3797 3797 s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
3799 3799 s 	endm
3799 3799 s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFA3
3799 3799 d 54
3799 3799 s 	db 	pW_STORE
379a 379a d a3df
379a 379a s 	dw 	0xDFA3
379c 379c d 6be9
379c 379c s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
379e 379e s 	endm
379e 379e s 	dwpatch	0xDA27+1	,0xDCEF	,_CPM1_res_READ
379e 379e d 51
379e 379e s 	db 	pW_CHK_PATCH
379f 379f d 28da
379f 379f s 	dw 	0xDA27+1
37a1 37a1 d efdc1be9
37a1 37a1 s 	dw 	0xDCEF,_CPM1_res_READ
37a5 37a5 s 	endm
37a5 37a5 s 	dwpatch	0xDA2A+1	,0xDE25	,_CPM1_res_WRITE
37a5 37a5 d 51
37a5 37a5 s 	db 	pW_CHK_PATCH
37a6 37a6 d 2bda
37a6 37a6 s 	dw 	0xDA2A+1
37a8 37a8 d 25de58e9
37a8 37a8 s 	dw 	0xDE25,_CPM1_res_WRITE
37ac 37ac s 	endm
37ac 37ac s 	dwpatch	0xDB85+1	,0xDCEF	,_CPM1_res_READ
37ac 37ac d 51
37ac 37ac s 	db 	pW_CHK_PATCH
37ad 37ad d 86db
37ad 37ad s 	dw 	0xDB85+1
37af 37af d efdc1be9
37af 37af s 	dw 	0xDCEF,_CPM1_res_READ
37b3 37b3 s 	endm
37b3 37b3 s 	dwpatch	0xdcbe+1	,0xE585	,_CPM1_res_GETINFO
37b3 37b3 d 51
37b3 37b3 s 	db 	pW_CHK_PATCH
37b4 37b4 d bfdc
37b4 37b4 s 	dw 	0xdcbe+1
37b6 37b6 d 85e595e9
37b6 37b6 s 	dw 	0xE585,_CPM1_res_GETINFO
37ba 37ba s 	endm
37ba 37ba s 	dwstore	_CPM1__old_read+1	,0xDCEF
37ba 37ba d 54
37ba 37ba s 	db 	pW_STORE
37bb 37bb d efdc
37bb 37bb s 	dw 	0xDCEF
37bd 37bd d 56e9
37bd 37bd s 	dw 	_CPM1__old_read+1
37bf 37bf s 	endm
37bf 37bf s 	dwstore	_CPM1__old_write+1	,0xDE25
37bf 37bf d 54
37bf 37bf s 	db 	pW_STORE
37c0 37c0 d 25de
37c0 37c0 s 	dw 	0xDE25
37c2 37c2 d 93e9
37c2 37c2 s 	dw 	_CPM1__old_write+1
37c4 37c4 s 	endm
37c4 37c4 s 	dwstore	_CPM1__old_getinfo+1	,0xE585
37c4 37c4 d 54
37c4 37c4 s 	db 	pW_STORE
37c5 37c5 d 85e5
37c5 37c5 s 	dw 	0xE585
37c7 37c7 d a3e9
37c7 37c7 s 	dw 	_CPM1__old_getinfo+1
37c9 37c9 s 	endm
37c9 37c9 s 	dbpatch	0xE5C5		,0x21	,0x21
37c9 37c9 d 52
37c9 37c9 s 	db 	pB_CHK_PATCH
37ca 37ca d c5e5
37ca 37ca s 	dw 	0xE5C5
37cc 37cc d 2121
37cc 37cc s 	db 	0x21,0x21
37ce 37ce s 	endm
37ce 37ce s 	dwpatch	0xE5C5+1 	,0xE5F5	,0xE5F5
37ce 37ce d 51
37ce 37ce s 	db 	pW_CHK_PATCH
37cf 37cf d c6e5
37cf 37cf s 	dw 	0xE5C5+1
37d1 37d1 d f5e5f5e5
37d1 37d1 s 	dw 	0xE5F5,0xE5F5
37d5 37d5 s 	endm
37d5 37d5 s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE5C5
37d5 37d5 d 54
37d5 37d5 s 	db 	pW_STORE
37d6 37d6 d c5e5
37d6 37d6 s 	dw 	0xE5C5
37d8 37d8 d a0e9
37d8 37d8 s 	dw 	_CPM1__old_getinfo_chkdo+1
37da 37da s 	endm
37da 37da s 	dwstore	_CPM1_r_p_DSK1+1	,0xDF99 	;read
37da 37da d 54
37da 37da s 	db 	pW_STORE
37db 37db d 99df
37db 37db s 	dw 	0xDF99
37dd 37dd d 1ce9
37dd 37dd s 	dw 	_CPM1_r_p_DSK1+1
37df 37df s 	endm
37df 37df s 	dwstore	_CPM1_r_p_TRK1+1	,0xDF9D 	
37df 37df d 54
37df 37df s 	db 	pW_STORE
37e0 37e0 d 9ddf
37e0 37e0 s 	dw 	0xDF9D
37e2 37e2 d 37e9
37e2 37e2 s 	dw 	_CPM1_r_p_TRK1+1
37e4 37e4 s 	endm
37e4 37e4 s 	dwstore	_CPM1_r_p_SEC1+1	,0xDF9E 	
37e4 37e4 d 54
37e4 37e4 s 	db 	pW_STORE
37e5 37e5 d 9edf
37e5 37e5 s 	dw 	0xDF9E
37e7 37e7 d 3de9
37e7 37e7 s 	dw 	_CPM1_r_p_SEC1+1
37e9 37e9 s 	endm
37e9 37e9 s 	dwstore	_CPM1_r_p_DMA1+1	,0xDF9F 	
37e9 37e9 d 54
37e9 37e9 s 	db 	pW_STORE
37ea 37ea d 9fdf
37ea 37ea s 	dw 	0xDF9F
37ec 37ec d 4ee9
37ec 37ec s 	dw 	_CPM1_r_p_DMA1+1
37ee 37ee s 	endm
37ee 37ee s 	dwstore	_CPM1_r_p_DSK2+1	,0xDF99 	;write
37ee 37ee d 54
37ee 37ee s 	db 	pW_STORE
37ef 37ef d 99df
37ef 37ef s 	dw 	0xDF99
37f1 37f1 d 59e9
37f1 37f1 s 	dw 	_CPM1_r_p_DSK2+1
37f3 37f3 s 	endm
37f3 37f3 s 	dwstore	_CPM1_r_p_TRK2+1	,0xDF9D 	
37f3 37f3 d 54
37f3 37f3 s 	db 	pW_STORE
37f4 37f4 d 9ddf
37f4 37f4 s 	dw 	0xDF9D
37f6 37f6 d 74e9
37f6 37f6 s 	dw 	_CPM1_r_p_TRK2+1
37f8 37f8 s 	endm
37f8 37f8 s 	dwstore	_CPM1_r_p_SEC2+1	,0xDF9E 	
37f8 37f8 d 54
37f8 37f8 s 	db 	pW_STORE
37f9 37f9 d 9edf
37f9 37f9 s 	dw 	0xDF9E
37fb 37fb d 7ae9
37fb 37fb s 	dw 	_CPM1_r_p_SEC2+1
37fd 37fd s 	endm
37fd 37fd s 	dwstore	_CPM1_r_p_DMA2+1	,0xDF9F 	
37fd 37fd d 54
37fd 37fd s 	db 	pW_STORE
37fe 37fe d 9fdf
37fe 37fe s 	dw 	0xDF9F
3800 3800 d 8be9
3800 3800 s 	dw 	_CPM1_r_p_DMA2+1
3802 3802 s 	endm
3802 3802 s 	dwstore	_CPM1_r_p_DSK3+1	,0xDF99 	;readinfo
3802 3802 d 54
3802 3802 s 	db 	pW_STORE
3803 3803 d 99df
3803 3803 s 	dw 	0xDF99
3805 3805 d 28ea
3805 3805 s 	dw 	_CPM1_r_p_DSK3+1
3807 3807 s 	endm
3807 3807 s 
3807 3807 s 	stop 'CPM_20_88___miks'
3807 3807 d 50
3807 3807 s 	db 	p_STOP
3808 3808 d 43504d5f32305f38385f5f5f6d696b73
3808 3808 s 	db 	'CPM_20_88___miks'
3818 3818 d 00
3818 3818 s 	db 	0
3819 3819 s 	endm
3819 3819 f out/include-patcher.asm
3819 3819 s 	include "generator/V0/out/patcher-cpm1-CPM_12_90_5_kontur.asm"	;  4 images in collection
3819 3819 f generator/V0/out/patcher-cpm1-CPM_12_90_5_kontur.asm
3819 3819 s _BIOS_CPM_12_90_5_kontur:
3819 3819 s 	setSUBBIOS 1
3819 3819 d 5a
3819 3819 s 	db	pSubBios
381a 381a d 01
381a 381a s 	db 	1
381b 381b s 	endm
381b 381b s 	RQ_OPTS_ANY
381b 381b s 	endm
381b 381b s 	setCPM
381b 381b s 	endm
381b 381b s 	dbpatchmaybe	0xDAEF	,0x1F	,0x0d
381b 381b d 59
381b 381b s 	db 	pB_MAYBE_PATCH
381c 381c d efda
381c 381c s 	dw 	0xDAEF
381e 381e d 1f0d
381e 381e s 	db 	0x1F,0x0d
3820 3820 s 	endm
3820 3820 s 	dbpatchmaybe	0xDAEF+2	,0x0a	,0x0d
3820 3820 d 59
3820 3820 s 	db 	pB_MAYBE_PATCH
3821 3821 d f1da
3821 3821 s 	dw 	0xDAEF+2
3823 3823 d 0a0d
3823 3823 s 	db 	0x0a,0x0d
3825 3825 s 	endm
3825 3825 s 	dbpatch	0xE09B+1	,0x49	,0xc9
3825 3825 d 52
3825 3825 s 	db 	pB_CHK_PATCH
3826 3826 d 9ce0
3826 3826 s 	dw 	0xE09B+1
3828 3828 d 49c9
3828 3828 s 	db 	0x49,0xc9
382a 382a s 	endm
382a 382a s 	dbpatch	0xDA88 	,0x01	,0x00
382a 382a d 52
382a 382a s 	db 	pB_CHK_PATCH
382b 382b d 88da
382b 382b s 	dw 	0xDA88
382d 382d d 0100
382d 382d s 	db 	0x01,0x00
382f 382f s 	endm
382f 382f s 	dbpatch	0xDA9F 	,0x02	,0x00
382f 382f d 52
382f 382f s 	db 	pB_CHK_PATCH
3830 3830 d 9fda
3830 3830 s 	dw 	0xDA9F
3832 3832 d 0200
3832 3832 s 	db 	0x02,0x00
3834 3834 s 	endm
3834 3834 s 	dbpatch	0xDAB6 	,0x04	,0x01
3834 3834 d 52
3834 3834 s 	db 	pB_CHK_PATCH
3835 3835 d b6da
3835 3835 s 	dw 	0xDAB6
3837 3837 d 0401
3837 3837 s 	db 	0x04,0x01
3839 3839 s 	endm
3839 3839 s 	dbpatch	0xDACD 	,0x08	,0x02
3839 3839 d 52
3839 3839 s 	db 	pB_CHK_PATCH
383a 383a d cdda
383a 383a s 	dw 	0xDACD
383c 383c d 0802
383c 383c s 	db 	0x08,0x02
383e 383e s 	endm
383e 383e s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
383e 383e d 54
383e 383e s 	db 	pW_STORE
383f 383f d 88da
383f 383f s 	dw 	0xDA88
3841 3841 d ace8
3841 3841 s 	dw 	_CPM1_res_DRIVE_TAB+0*2
3843 3843 s 	endm
3843 3843 s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
3843 3843 d 54
3843 3843 s 	db 	pW_STORE
3844 3844 d 9fda
3844 3844 s 	dw 	0xDA9F
3846 3846 d aee8
3846 3846 s 	dw 	_CPM1_res_DRIVE_TAB+1*2
3848 3848 s 	endm
3848 3848 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
3848 3848 d 54
3848 3848 s 	db 	pW_STORE
3849 3849 d b6da
3849 3849 s 	dw 	0xDAB6
384b 384b d b0e8
384b 384b s 	dw 	_CPM1_res_DRIVE_TAB+2*2
384d 384d s 	endm
384d 384d s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
384d 384d d 54
384d 384d s 	db 	pW_STORE
384e 384e d cdda
384e 384e s 	dw 	0xDACD
3850 3850 d b2e8
3850 3850 s 	dw 	_CPM1_res_DRIVE_TAB+3*2
3852 3852 s 	endm
3852 3852 s 	dwpatch 0xDCB6+5*2 	,0x0000 ,_CPM1_dph_F
3852 3852 d 51
3852 3852 s 	db 	pW_CHK_PATCH
3853 3853 d c0dc
3853 3853 s 	dw 	0xDCB6+5*2
3855 3855 d 0000b8e8
3855 3855 s 	dw 	0x0000,_CPM1_dph_F
3859 3859 s 	endm
3859 3859 s 	dwstore _CPM1_dph_F+8	,0xEBA6
3859 3859 d 54
3859 3859 s 	db 	pW_STORE
385a 385a d a6eb
385a 385a s 	dw 	0xEBA6
385c 385c d c0e8
385c 385c s 	dw 	_CPM1_dph_F+8
385e 385e s 	endm
385e 385e s 	dwpatch 0xDA1B+1 	,0xDC72	,_CPM1_res_seldsk
385e 385e d 51
385e 385e s 	db 	pW_CHK_PATCH
385f 385f d 1cda
385f 385f s 	dw 	0xDA1B+1
3861 3861 d 72dc11e9
3861 3861 s 	dw 	0xDC72,_CPM1_res_seldsk
3865 3865 s 	endm
3865 3865 s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC72
3865 3865 d 54
3865 3865 s 	db 	pW_STORE
3866 3866 d 72dc
3866 3866 s 	dw 	0xDC72
3868 3868 d 15e9
3868 3868 s 	dw 	_CPM1_old_seld_dsk+1
386a 386a s 	endm
386a 386a s 	dbpatch	0xE6C0	,0x77	,0x00
386a 386a d 52
386a 386a s 	db 	pB_CHK_PATCH
386b 386b d c0e6
386b 386b s 	dw 	0xE6C0
386d 386d d 7700
386d 386d s 	db 	0x77,0x00
386f 386f s 	endm
386f 386f s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFB6
386f 386f d 54
386f 386f s 	db 	pW_STORE
3870 3870 d b6df
3870 3870 s 	dw 	0xDFB6
3872 3872 d 2ee9
3872 3872 s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
3874 3874 s 	endm
3874 3874 s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFB6
3874 3874 d 54
3874 3874 s 	db 	pW_STORE
3875 3875 d b6df
3875 3875 s 	dw 	0xDFB6
3877 3877 d 6be9
3877 3877 s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
3879 3879 s 	endm
3879 3879 s 	dwpatch	0xDA27+1	,0xDCD5	,_CPM1_res_READ
3879 3879 d 51
3879 3879 s 	db 	pW_CHK_PATCH
387a 387a d 28da
387a 387a s 	dw 	0xDA27+1
387c 387c d d5dc1be9
387c 387c s 	dw 	0xDCD5,_CPM1_res_READ
3880 3880 s 	endm
3880 3880 s 	dwpatch	0xDA2A+1	,0xDE22	,_CPM1_res_WRITE
3880 3880 d 51
3880 3880 s 	db 	pW_CHK_PATCH
3881 3881 d 2bda
3881 3881 s 	dw 	0xDA2A+1
3883 3883 d 22de58e9
3883 3883 s 	dw 	0xDE22,_CPM1_res_WRITE
3887 3887 s 	endm
3887 3887 s 	dwpatch	0xDB6B+1	,0xDCD5	,_CPM1_res_READ
3887 3887 d 51
3887 3887 s 	db 	pW_CHK_PATCH
3888 3888 d 6cdb
3888 3888 s 	dw 	0xDB6B+1
388a 388a d d5dc1be9
388a 388a s 	dw 	0xDCD5,_CPM1_res_READ
388e 388e s 	endm
388e 388e s 	dwpatch	0xdca4+1	,0xE5F6	,_CPM1_res_GETINFO
388e 388e d 51
388e 388e s 	db 	pW_CHK_PATCH
388f 388f d a5dc
388f 388f s 	dw 	0xdca4+1
3891 3891 d f6e595e9
3891 3891 s 	dw 	0xE5F6,_CPM1_res_GETINFO
3895 3895 s 	endm
3895 3895 s 	dwstore	_CPM1__old_read+1	,0xDCD5
3895 3895 d 54
3895 3895 s 	db 	pW_STORE
3896 3896 d d5dc
3896 3896 s 	dw 	0xDCD5
3898 3898 d 56e9
3898 3898 s 	dw 	_CPM1__old_read+1
389a 389a s 	endm
389a 389a s 	dwstore	_CPM1__old_write+1	,0xDE22
389a 389a d 54
389a 389a s 	db 	pW_STORE
389b 389b d 22de
389b 389b s 	dw 	0xDE22
389d 389d d 93e9
389d 389d s 	dw 	_CPM1__old_write+1
389f 389f s 	endm
389f 389f s 	dwstore	_CPM1__old_getinfo+1	,0xE5F6
389f 389f d 54
389f 389f s 	db 	pW_STORE
38a0 38a0 d f6e5
38a0 38a0 s 	dw 	0xE5F6
38a2 38a2 d a3e9
38a2 38a2 s 	dw 	_CPM1__old_getinfo+1
38a4 38a4 s 	endm
38a4 38a4 s 	dbpatch	0xE636		,0x21	,0x21
38a4 38a4 d 52
38a4 38a4 s 	db 	pB_CHK_PATCH
38a5 38a5 d 36e6
38a5 38a5 s 	dw 	0xE636
38a7 38a7 d 2121
38a7 38a7 s 	db 	0x21,0x21
38a9 38a9 s 	endm
38a9 38a9 s 	dwpatch	0xE636+1 	,0xE666	,0xE666
38a9 38a9 d 51
38a9 38a9 s 	db 	pW_CHK_PATCH
38aa 38aa d 37e6
38aa 38aa s 	dw 	0xE636+1
38ac 38ac d 66e666e6
38ac 38ac s 	dw 	0xE666,0xE666
38b0 38b0 s 	endm
38b0 38b0 s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE636
38b0 38b0 d 54
38b0 38b0 s 	db 	pW_STORE
38b1 38b1 d 36e6
38b1 38b1 s 	dw 	0xE636
38b3 38b3 d a0e9
38b3 38b3 s 	dw 	_CPM1__old_getinfo_chkdo+1
38b5 38b5 s 	endm
38b5 38b5 s 	dwstore	_CPM1_r_p_DSK1+1	,0xDFAC 	;read
38b5 38b5 d 54
38b5 38b5 s 	db 	pW_STORE
38b6 38b6 d acdf
38b6 38b6 s 	dw 	0xDFAC
38b8 38b8 d 1ce9
38b8 38b8 s 	dw 	_CPM1_r_p_DSK1+1
38ba 38ba s 	endm
38ba 38ba s 	dwstore	_CPM1_r_p_TRK1+1	,0xDFB0 	
38ba 38ba d 54
38ba 38ba s 	db 	pW_STORE
38bb 38bb d b0df
38bb 38bb s 	dw 	0xDFB0
38bd 38bd d 37e9
38bd 38bd s 	dw 	_CPM1_r_p_TRK1+1
38bf 38bf s 	endm
38bf 38bf s 	dwstore	_CPM1_r_p_SEC1+1	,0xDFB1 	
38bf 38bf d 54
38bf 38bf s 	db 	pW_STORE
38c0 38c0 d b1df
38c0 38c0 s 	dw 	0xDFB1
38c2 38c2 d 3de9
38c2 38c2 s 	dw 	_CPM1_r_p_SEC1+1
38c4 38c4 s 	endm
38c4 38c4 s 	dwstore	_CPM1_r_p_DMA1+1	,0xDFB2 	
38c4 38c4 d 54
38c4 38c4 s 	db 	pW_STORE
38c5 38c5 d b2df
38c5 38c5 s 	dw 	0xDFB2
38c7 38c7 d 4ee9
38c7 38c7 s 	dw 	_CPM1_r_p_DMA1+1
38c9 38c9 s 	endm
38c9 38c9 s 	dwstore	_CPM1_r_p_DSK2+1	,0xDFAC 	;write
38c9 38c9 d 54
38c9 38c9 s 	db 	pW_STORE
38ca 38ca d acdf
38ca 38ca s 	dw 	0xDFAC
38cc 38cc d 59e9
38cc 38cc s 	dw 	_CPM1_r_p_DSK2+1
38ce 38ce s 	endm
38ce 38ce s 	dwstore	_CPM1_r_p_TRK2+1	,0xDFB0 	
38ce 38ce d 54
38ce 38ce s 	db 	pW_STORE
38cf 38cf d b0df
38cf 38cf s 	dw 	0xDFB0
38d1 38d1 d 74e9
38d1 38d1 s 	dw 	_CPM1_r_p_TRK2+1
38d3 38d3 s 	endm
38d3 38d3 s 	dwstore	_CPM1_r_p_SEC2+1	,0xDFB1 	
38d3 38d3 d 54
38d3 38d3 s 	db 	pW_STORE
38d4 38d4 d b1df
38d4 38d4 s 	dw 	0xDFB1
38d6 38d6 d 7ae9
38d6 38d6 s 	dw 	_CPM1_r_p_SEC2+1
38d8 38d8 s 	endm
38d8 38d8 s 	dwstore	_CPM1_r_p_DMA2+1	,0xDFB2 	
38d8 38d8 d 54
38d8 38d8 s 	db 	pW_STORE
38d9 38d9 d b2df
38d9 38d9 s 	dw 	0xDFB2
38db 38db d 8be9
38db 38db s 	dw 	_CPM1_r_p_DMA2+1
38dd 38dd s 	endm
38dd 38dd s 	dwstore	_CPM1_r_p_DSK3+1	,0xDFAC 	;readinfo
38dd 38dd d 54
38dd 38dd s 	db 	pW_STORE
38de 38de d acdf
38de 38de s 	dw 	0xDFAC
38e0 38e0 d 28ea
38e0 38e0 s 	dw 	_CPM1_r_p_DSK3+1
38e2 38e2 s 	endm
38e2 38e2 s 
38e2 38e2 s 	stop 'CPM_12_90_5_kontur'
38e2 38e2 d 50
38e2 38e2 s 	db 	p_STOP
38e3 38e3 d 43504d5f31325f39305f355f6b6f6e747572
38e3 38e3 s 	db 	'CPM_12_90_5_kontur'
38f5 38f5 d 00
38f5 38f5 s 	db 	0
38f6 38f6 s 	endm
38f6 38f6 f out/include-patcher.asm
38f6 38f6 s 	include "generator/V0/out/patcher-microdos-MICRODOS_OPTS2_900105.asm"	;  4 images in collection
38f6 38f6 f generator/V0/out/patcher-microdos-MICRODOS_OPTS2_900105.asm
38f6 38f6 s _BIOS_MICRODOS_OPTS2_900105:
38f6 38f6 s 	
38f6 38f6 s 	setMICRODOS
38f6 38f6 d 56
38f6 38f6 s 	db 	pSETFLAG_MICRODOS
38f7 38f7 s 	endm
38f7 38f7 s 	RQ_OPTS_ANY
38f7 38f7 s 	endm
38f7 38f7 s 
38f7 38f7 s 	;BIOS_LOAD_ADDR-------------------------------------------------------------------
38f7 38f7 s 	;BIOS_START_ADDR
38f7 38f7 s 	;правилнее проверять прямо в 8000 ????
38f7 38f7 s 	;копия бутсектора из 8000, 
38f7 38f7 s 	;
38f7 38f7 s 	;адресс загрузки, куда биос загружает сектора с диска
38f7 38f7 s 	;	dwpatch	0xBD80,	0xBD80, 0xBD80
38f7 38f7 s 	;адресс старта, куда биос передаёт управление
38f7 38f7 s 	;	dwpatch	0xBD82,	0xBE00,	0xBE00
38f7 38f7 s 
38f7 38f7 s 	
38f7 38f7 s 	;BDOS_ENTRY_POINT---------------------------------------------------------
38f7 38f7 s 	;BDOS_ENTRY_POINT2
38f7 38f7 s 	;значение перехода, проверяим их для надёжности
38f7 38f7 s 	;0005 jp c000
38f7 38f7 s 	;RAM:C000          _BDOS:                                  
38f7 38f7 s 	;RAM:C000                                                  
38f7 38f7 s 	;RAM:C000 C3 87 C4                 jp      loc_C487
38f7 38f7 s 	;RAM:C003 C3 C0 DB                 jp      loc_DBC0
38f7 38f7 s 	; 	dwpatch	0xc000+1,0xC487,0xC487
38f7 38f7 s 	; 	dwpatch	0xc003+1,0xDBC0,0xDBC0
38f7 38f7 s 
38f7 38f7 s 	;BIOS_LOGO_ADDR--------------------------------------------------------------
38f7 38f7 s 	;косметика,  
38f7 38f7 s 	;Биос при старте очищает экран, мы патчим его чтобы он это не делал
38f7 38f7 s 	;иначе он затрёт все сообщения патчера, а там много полезной информации
38f7 38f7 s 	;выгядит это в коде так
38f7 38f7 s 	;это значение там только во время старта, дальше там буфер .....
38f7 38f7 s 
38f7 38f7 s 	; RAM:F04E 1B 45 EB+BOOT_LOGO:      text "koi8-r", '\\x1BКОРВЕТ ПК8020\\r\\n'
38f7 38f7 s 	; RAM:F04E E5 F4 20+                text "koi8-r", 'НИИСЧЁТМАШ 01.05.90\\r\\n'
38f7 38f7 s 	; RAM:F04E F0 EB 38+                text "koi8-r", '$'
38f7 38f7 s 	dbpatchmaybe	0xF04E	,0x1B	,0x0d
38f7 38f7 d 59
38f7 38f7 s 	db 	pB_MAYBE_PATCH
38f8 38f8 d 4ef0
38f8 38f8 s 	dw 	0xF04E
38fa 38fa d 1b0d
38fa 38fa s 	db 	0x1B,0x0d
38fc 38fc s 	endm
38fc 38fc s 	dbpatchmaybe	0xF04E+1	,0x45	,0x0d
38fc 38fc d 59
38fc 38fc s 	db 	pB_MAYBE_PATCH
38fd 38fd d 4ff0
38fd 38fd s 	dw 	0xF04E+1
38ff 38ff d 450d
38ff 38ff s 	db 	0x45,0x0d
3901 3901 s 	endm
3901 3901 s 
3901 3901 s 	;JP_READ-----------------------------------------------------------------------
3901 3901 s 	;JP_WRITE
3901 3901 s 	; перехватываем обращение к чтению/записи в биос
3901 3901 s 	; подменяем адресса для чтения/записи
3901 3901 s 	; собственно во всех это куче кода нас интересует адресса EAFF и EB04
3901 3901 s 	
3901 3901 s 	; точки входа обычного биоса
3901 3901 s 	; RAM:C027 C3 7B DD                 jp      do_READ
3901 3901 s 	; RAM:C02A C3 78 DD                 jp      do_WRITE
3901 3901 s 	;.....
3901 3901 s 	; RAM:DD78          do_WRITE:                               
3901 3901 s 	; RAM:DD78 3E 06                    ld      a, 6
3901 3901 s 	; RAM:DD7A 21                       db 21h
3901 3901 s 	; RAM:DD7B          do_READ:                                
3901 3901 s 	; RAM:DD7B                                                  
3901 3901 s 	; RAM:DD7B 3E 04                    ld      a, 4
3901 3901 s 	; RAM:DD7D 32 1D DF                 ld      (dsk_description.Fucntion), a
3901 3901 s 	; RAM:DD80 21 1B DF                 ld      hl, dsk_description
3901 3901 s 	; RAM:DD83 C3 12 E4                 jp      RW_DISK
3901 3901 s 	; ...
3901 3901 s 	; RAM:E412          RW_DISK:                                
3901 3901 s 	; RAM:E412                                                  
3901 3901 s 	; RAM:E412 C3 A5 EA                 jp      j_DSKIO
3901 3901 s 
3901 3901 s 	; RAM:EAA5          j_DSKIO:                                
3901 3901 s 	; RAM:EAA5 3A 03 F7                 ld      a, (SysCOPY)
3901 3901 s 	; RAM:EAA8 F5                       push    af
3901 3901 s 	; RAM:EAA9 EB                       ex      de, hl
3901 3901 s 	; RAM:EAAA 06 5C                    ld      b, 5Ch ; '\'
3901 3901 s 	; RAM:EAAC CD 9F E4                 call    setSYSREG
3901 3901 s 	; RAM:EAAF EB                       ex      de, hl
3901 3901 s 	; RAM:EAB0 CD BF EA                 call    do_DSKIO
3901 3901 s 	; RAM:EAB3 47                       ld      b, a
3901 3901 s 	; RAM:EAB4 F1                       pop     af
3901 3901 s 	; RAM:EAB5 F3                       di
3901 3901 s 	; RAM:EAB6 32 7F FF                 ld      (_5C_SysReg1C), a
3901 3901 s 	; RAM:EAB9 32 03 F7                 ld      (SysCOPY), a
3901 3901 s 	; RAM:EABC FB                       ei
3901 3901 s 	; RAM:EABD 78                       ld      a, b
3901 3901 s 	; RAM:EABE C9                       ret
3901 3901 s 	; ....
3901 3901 s 	; RAM:EABF          do_DSKIO:                               
3901 3901 s 	; RAM:EABF 79                       ld      a, c
3901 3901 s 	; RAM:EAC0 32 F7 EE                 ld      (DSK_IO_WriteType), a ; 0       (normal sector write)
3901 3901 s 	; RAM:EAC0                                                  ; 1       (write to directory sector)
3901 3901 s 	; RAM:EAC0                                                  ; 2       (write to the first sector of a new data block)
3901 3901 s 	; RAM:EAC3 22 F8 EE                 ld      (DSC_IO_HL), hl ; DSCDESCR
3901 3901 s 	; RAM:EAC6          ;
3901 3901 s 	; RAM:EAC6 3A F6 EE                 ld      a, (E_DRIVE_FLAG)
3901 3901 s 	; RAM:EAC9 A6                       and     (hl)            ; DRIVE?
3901 3901 s 	; RAM:EACA FE 04                    cp      4
3901 3901 s 	; RAM:EACC CA 80 FC                 jp      z, E_DRIVE
3901 3901 s 	; RAM:EACF          ;
3901 3901 s 	; RAM:EACF 7E                       ld      a, (hl)
3901 3901 s 	; RAM:EAD0 FE 02                    cp      2
3901 3901 s 	; RAM:EAD2 D2 07 EB                 jp      nc, invalidDrive
3901 3901 s 	; RAM:EAD5          ;
3901 3901 s 	; ....
3901 3901 s 	; RAM:EAFA 22 FA EE                 ld      (_DMA??), hl
3901 3901 s 	; RAM:EAFD FE 04                    cp      4
3901 3901 s 	; RAM:EAFF CA 36 EB                 jp      z, jREAD
3901 3901 s 	; RAM:EB02 FE 06                    cp      6
3901 3901 s 	; RAM:EB04 CA A0 EB                 jp      z, jWRITE
3901 3901 s 	; RAM:EB07
3901 3901 s 	; RAM:EB07          invalidDrive:                           
3901 3901 s 	; RAM:EB07                                                  
3901 3901 s 	; RAM:EB07 3E FF                    ld      a, 0FFh
3901 3901 s 	; RAM:EB09 C9                       ret
3901 3901 s 
3901 3901 s 	; а так как пока в резиденте нет поддержки работы с реальными дисками то 
3901 3901 s 	; адресса оригинальных пока не сохраняем к себе ....
3901 3901 s 	; TODO: microdos real disk support
3901 3901 s 
3901 3901 s 	dwpatch	0xEAFF+1	,0xEB36	,MD_READ			
3901 3901 d 51
3901 3901 s 	db 	pW_CHK_PATCH
3902 3902 d 00eb
3902 3902 s 	dw 	0xEAFF+1
3904 3904 d 36eb3efa
3904 3904 s 	dw 	0xEB36,MD_READ
3908 3908 s 	endm
3908 3908 s 	dwpatch	0xEB04+1	,0xEBA0	,MD_WRITE
3908 3908 d 51
3908 3908 s 	db 	pW_CHK_PATCH
3909 3909 d 05eb
3909 3909 s 	dw 	0xEB04+1
390b 390b d a0eb53fa
390b 390b s 	dw 	0xEBA0,MD_WRITE
390f 390f s 	endm
390f 390f s 
390f 390f s 	;GET_INFO_FDC_SEEK -------------------------------------------------------------
390f 390f s 	;GET_INFO_CALL_READ
390f 390f s 	;кусок GET_INFO_C, подменяем чтение инфосектора
390f 390f s 	; RAM:EC56          GET_INFO_C:                             ; CODE XREF: jGetDPH_Addr+29p
390f 390f s 	; RAM:EC56 79                       ld      a, c            ; drive
390f 390f s 	; RAM:EC57 B7                       or      a
390f 390f s 	; RAM:EC58 3A 93 E6                 ld      a, (dsk_info_a.intiFlag)
390f 390f s 	; RAM:EC5B CA 61 EC                 jp      z, loc_EC61
390f 390f s 	; RAM:EC61
390f 390f s 	;....
390f 390f s 	; RAM:EC86 2B                       dec     hl
390f 390f s 	; RAM:EC87 CD 14 EE                 call    SEL_DSK_SEEK0
390f 390f s 	; RAM:EC8A CD 1E EE                 call    ReadToRDBUF
390f 390f s 	; RAM:EC8D          ;
390f 390f s 	; RAM:EC8D 3E 04                    ld      a, 4
390f 390f s 	; RAM:EC8F 32 FF EE                 ld      (DSK_TRY_Count), a
390f 390f s 
390f 390f s 	; для начала удаляем комманду которая готовит чтение с физичесского дисковода
390f 390f s 	dbpatch	0xEC87	,0xcd	,0x00
390f 390f d 52
390f 390f s 	db 	pB_CHK_PATCH
3910 3910 d 87ec
3910 3910 s 	dw 	0xEC87
3912 3912 d cd00
3912 3912 s 	db 	0xcd,0x00
3914 3914 s 	endm
3914 3914 s 	dwpatch	0xEC87+1	,0xEE14	,0x0000
3914 3914 d 51
3914 3914 s 	db 	pW_CHK_PATCH
3915 3915 d 88ec
3915 3915 s 	dw 	0xEC87+1
3917 3917 d 14ee0000
3917 3917 s 	dw 	0xEE14,0x0000
391b 391b s 	endm
391b 391b s 
391b 391b s 	;GET_INFO_CALL_READ------------------------------------------------------
391b 391b s 	;подменяем чтение сектора с диска на нашу функцию
391b 391b s 	dwpatch	0xEC8A+1	,0xEE1E	,MD_READ_INFOSECTOR
391b 391b d 51
391b 391b s 	db 	pW_CHK_PATCH
391c 391c d 8bec
391c 391c s 	dw 	0xEC8A+1
391e 391e d 1eee68fa
391e 391e s 	dw 	0xEE1E,MD_READ_INFOSECTOR
3922 3922 s 	endm
3922 3922 s 
3922 3922 s 	;DISKINFO_DRIVE--------------------------------------------------------------------------------
3922 3922 s 	;эти два адресса нужны для DISKINFO
3922 3922 s 	;rdBufDiskInfo - это очередной блок параметров, по нужному адрессу там текущий диск для операции DISKINFO
3922 3922 s 	; в примере ниже чтение нашего байта по адрессу 0xED82
3922 3922 s 	; а собственно адресс по адрессу 0xEB7E (значение 0xEF06)
3922 3922 s 	; RAM:EB36          jREAD:                                  
3922 3922 s 	; RAM:EB36 2A F8 EE                 ld      hl, (DSC_IO_HL) 
3922 3922 s 	; ...
3922 3922 s 	; RAM:EB7E          ;
3922 3922 s 	; RAM:EB7E 21 06 EF                 ld      hl, rdBufDiskInfo
3922 3922 s 	; RAM:EB81 CD 7D ED                 call    FDD_Setup
3922 3922 s 	; ...
3922 3922 s 	; RAM:ED7D          FDD_Setup:                              
3922 3922 s 	; RAM:ED7D                                                  
3922 3922 s 	; RAM:ED7D 3E D0                    ld      a, FDC_3_FORCE_STOP
3922 3922 s 	; RAM:ED7F 32 18 FE                 ld      (_5C_FDC_Cmd), a
3922 3922 s 	; RAM:ED82          ;
3922 3922 s 	; RAM:ED82 7E                       ld      a, (hl)         ; drive
3922 3922 s 	; RAM:ED83 B7                       or      a
3922 3922 s 	; RAM:ED84 06 01                    ld      b, 1
3922 3922 s 	; RAM:ED86 CA 8B ED                 jp      z, loc_ED8B
3922 3922 s 
3922 3922 s 	dwstore	MD_DRV2+1,	0xEF06
3922 3922 d 54
3922 3922 s 	db 	pW_STORE
3923 3923 d 06ef
3923 3923 s 	dw 	0xEF06
3925 3925 d f3fa
3925 3925 s 	dw 	MD_DRV2+1
3927 3927 s 	endm
3927 3927 s 
3927 3927 s 	;DISKINFO_READ_BUFFER--------------------------------------------------------------------------
3927 3927 s 	;BUF_RD_1k
3927 3927 s 	;адресс буфера кудв мы читаем 0й сектор а дальше уже старый код в биосе
3927 3927 s 	;делает всё остальное
3927 3927 s 	; тут он присутсвует по адрессу 0xEC97 (значение 0xF04E)
3927 3927 s 	; собственно это подсчёт Контрольной суммы
3927 3927 s 	; RAM:EC56          GET_INFO_C:                             
3927 3927 s 	; RAM:EC56 79                       ld      a, c            
3927 3927 s 	; RAM:EC57 B7                       or      a
3927 3927 s 	; RAM:EC58 3A 93 E6                 ld      a, (dsk_info_a.intiFlag)
3927 3927 s 	; RAM:EC5B CA 61 EC                 jp      z, loc_EC61
3927 3927 s 	; RAM:EC5E 3A 97 E6                 ld      a, (dsk_info_b.intiFlag)
3927 3927 s 	; RAM:EC61
3927 3927 s 	; RAM:EC61          loc_EC61:                               
3927 3927 s 	; RAM:EC61 B7                       or      a
3927 3927 s 	; RAM:EC62 C2 EC EC                 jp      nz, diskAlreadyInit
3927 3927 s 	; RAM:EC65          ;
3927 3927 s 	; ...
3927 3927 s 	; RAM:EC97          ;
3927 3927 s 	; RAM:EC97 21 4E F0                 ld      hl, BUF_RD_1k
3927 3927 s 	; RAM:EC9A 0E 1F                    ld      c, 1Fh
3927 3927 s 	; RAM:EC9C 3E 66                    ld      a, 66h ; 'f'
3927 3927 s 	; RAM:EC9E
3927 3927 s 	; RAM:EC9E          CalcCRC_Loop:                           
3927 3927 s 	; RAM:EC9E 86                       add     a, (hl)
3927 3927 s 	; RAM:EC9F 23                       inc     hl
3927 3927 s 	; RAM:ECA0 0D                       dec     c
3927 3927 s 	; RAM:ECA1 C2 9E EC                 jp      nz, CalcCRC_Loop
3927 3927 s 	; RAM:ECA4 BE                       cp      (hl)
3927 3927 s 	; RAM:ECA5          ;
3927 3927 s 	; RAM:ECA5 3E 02                    ld      a, 2            ; CRC Error
3927 3927 s 	; RAM:ECA7 C0                       ret     nz
3927 3927 s 
3927 3927 s 	dwstore	MD_RDBUF2+1,	0xF04E
3927 3927 d 54
3927 3927 s 	db 	pW_STORE
3928 3928 d 4ef0
3928 3928 s 	dw 	0xF04E
392a 392a d 02fb
392a 392a s 	dw 	MD_RDBUF2+1
392c 392c s 	endm
392c 392c s 	
392c 392c s 	;DISK_IO_PARAM_BLOCK_ADDR------------------------------------------------------------------------
392c 392c s 	;адресс таблички с параметрами дисководой операции
392c 392c s 	;dsk,trk,sec,dma берутся тут
392c 392c s 	;DSC_IO_HL
392c 392c s 	dwstore	MD_PARAM2+1,	0xEEF8
392c 392c d 54
392c 392c s 	db 	pW_STORE
392d 392d d f8ee
392d 392d s 	dw 	0xEEF8
392f 392f d 1dfa
392f 392f s 	dw 	MD_PARAM2+1
3931 3931 s 	endm
3931 3931 s 
3931 3931 s 	;DISABLE_DISK_CHECK------------------------------------------------------------------------------
3931 3931 s 	;убираем проверку в биосе на наличие дисководов
3931 3931 s 	; RAM:BE00          _BOOT:                                  
3931 3931 s 	; RAM:BE00                                                  
3931 3931 s 	; RAM:BE00 F3                       di
3931 3931 s 	; RAM:BE01 31 00 BE                 ld      sp, 0BE00h
3931 3931 s 	; RAM:BE04 3A 01 F7                 ld      a, (FDDFLAG)
3931 3931 s 	; RAM:BE07 E6 02                    and     2
3931 3931 s 	; RAM:BE09 C2 40 00                 jp      nz, R_RunBasic??	
3931 3931 s 	;dbpatch 0xbe07+1	,0x02	,0x00
3931 3931 s 	
3931 3931 s 	;FLUSH_WRITE_ADDR-------------------------------------------------------------------------------
3931 3931 s 	; FLUSH нам не нужен, т.к. наша запись идёт без буферезации.
3931 3931 s 	; TODO: JP invalidateWRBUF ???
3931 3931 s 	; RAM:EC3A          Flush?:                                 
3931 3931 s 	; RAM:EC3A                                                  
3931 3931 s 	; RAM:EC3A 21 FD EE                 ld      hl, flagWriteReuired?
3931 3931 s 	; RAM:EC3D 7E                       ld      a, (hl)
3931 3931 s 	; RAM:EC3E B7                       or      a
3931 3931 s 	; RAM:EC3F C8                       ret     z
3931 3931 s 	; RAM:EC40          ;
3931 3931 s 	; RAM:EC40 36 00                    ld      (hl), 0
3931 3931 s 	; RAM:EC42          ;
3931 3931 s 	; RAM:EC42 21 0A EF                 ld      hl, WrBufDiskInfo
3931 3931 s 	; RAM:EC45 CD 7D ED                 call    FDD_Setup
3931 3931 s 	; RAM:EC48          ;
3931 3931 s 	; RAM:EC48 CD 66 EE                 call    FDD_Write
3931 3931 s 	; RAM:EC4B C8                       ret     z
3931 3931 s 	; RAM:EC4C          invalidateWRBUF:                        
3931 3931 s 	; RAM:EC4C                                                  
3931 3931 s 	; RAM:EC4C 21 0A EF                 ld      hl, WrBufDiskInfo
3931 3931 s 	; RAM:EC4F 36 FF                    ld      (hl), 0FFh
3931 3931 s 	; RAM:EC51 C9                       ret	
3931 3931 s 	;dbpatch 0xEC42		,0x21	,0xC9
3931 3931 s 
3931 3931 s 	;SELDSK_ADDR------------------------------------------------------------
3931 3931 s 	;и модифицируем вызов SELDSK чтобы он поддерживал дополнительную проверку
3931 3931 s 	;модифицируем оригинальный перехо в SELDSK чтобы он переходил на наш код	
3931 3931 s 	;и сохраняем старый адресс (в данном коде нужный нам адресс 0xDCB6)
3931 3931 s 	;RAM:DA1B          _SELDSK:                         ; IN: C
3931 3931 s 	;RAM:DA1B C3 B6 DC          jp      __SELDSK        ; OUT: HL-DPB/0, HL=xVTRAP0 if c=0xff
3931 3931 s 
3931 3931 s 	dwpatch 0xc01b+1	 ,0xdd4c	,md_res_seldsk
3931 3931 d 51
3931 3931 s 	db 	pW_CHK_PATCH
3932 3932 d 1cc0
3932 3932 s 	dw 	0xc01b+1
3934 3934 d 4cdd0efa
3934 3934 s 	dw 	0xdd4c,md_res_seldsk
3938 3938 s 	endm
3938 3938 s 	dwstore md_old_seld_dsk+1,0xdd4c	,0xdd4c
3938 3938 d 54
3938 3938 s 	db 	pW_STORE
3939 3939 d 4cdd
3939 3939 s 	dw 	0xdd4c
393b 393b d 12fa
393b 393b s 	dw 	md_old_seld_dsk+1
393d 393d s 	endm
393d 393d s 
393d 393d s 	;custom checkers
393d 393d s 	dwpatch	0xBD80	,0xBD80 ,0xBD80
393d 393d d 51
393d 393d s 	db 	pW_CHK_PATCH
393e 393e d 80bd
393e 393e s 	dw 	0xBD80
3940 3940 d 80bd80bd
3940 3940 s 	dw 	0xBD80,0xBD80
3944 3944 s 	endm
3944 3944 s 	dwpatch	0xBD82	,0xBE00 ,0xBE00
3944 3944 d 51
3944 3944 s 	db 	pW_CHK_PATCH
3945 3945 d 82bd
3945 3945 s 	dw 	0xBD82
3947 3947 d 00be00be
3947 3947 s 	dw 	0xBE00,0xBE00
394b 394b s 	endm
394b 394b s 	dwpatch	0xc000+1	,0xC487 ,0xC487
394b 394b d 51
394b 394b s 	db 	pW_CHK_PATCH
394c 394c d 01c0
394c 394c s 	dw 	0xc000+1
394e 394e d 87c487c4
394e 394e s 	dw 	0xC487,0xC487
3952 3952 s 	endm
3952 3952 s 	dwpatch	0xc003+1	,0xDBC0 ,0xDBC0
3952 3952 d 51
3952 3952 s 	db 	pW_CHK_PATCH
3953 3953 d 04c0
3953 3953 s 	dw 	0xc003+1
3955 3955 d c0dbc0db
3955 3955 s 	dw 	0xDBC0,0xDBC0
3959 3959 s 	endm
3959 3959 s 	dbpatch	0xbe07+1	,0x02 ,0x02
3959 3959 d 52
3959 3959 s 	db 	pB_CHK_PATCH
395a 395a d 08be
395a 395a s 	dw 	0xbe07+1
395c 395c d 0202
395c 395c s 	db 	0x02,0x02
395e 395e s 	endm
395e 395e s 	dbpatch	0xEC42	,0x21 ,0x21
395e 395e d 52
395e 395e s 	db 	pB_CHK_PATCH
395f 395f d 42ec
395f 395f s 	dw 	0xEC42
3961 3961 d 2121
3961 3961 s 	db 	0x21,0x21
3963 3963 s 	endm
3963 3963 s 
3963 3963 s 	;STOP-------------------------------------------------------------------------------
3963 3963 s 	stop 'MICRODOS_OPTS2_900105'
3963 3963 d 50
3963 3963 s 	db 	p_STOP
3964 3964 d 4d4943524f444f535f4f505453325f393030313035
3964 3964 s 	db 	'MICRODOS_OPTS2_900105'
3979 3979 d 00
3979 3979 s 	db 	0
397a 397a s 	endm
397a 397a s 	;'MICRODOS_2_900105'
397a 397a f out/include-patcher.asm
397a 397a s 	include "generator/V0/out/patcher-cpm2-CPM_12_87_11_niijaf.asm"	;  3 images in collection
397a 397a f generator/V0/out/patcher-cpm2-CPM_12_87_11_niijaf.asm
397a 397a s _BIOS_CPM_12_87_11_niijaf:
397a 397a s 	setSUBBIOS 2
397a 397a d 5a
397a 397a s 	db	pSubBios
397b 397b d 02
397b 397b s 	db 	2
397c 397c s 	endm
397c 397c s 	RQ_OPTS_ANY
397c 397c s 	endm
397c 397c s 	setCPM
397c 397c s 	endm
397c 397c s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
397c 397c d 59
397c 397c s 	db 	pB_MAYBE_PATCH
397d 397d d eeda
397d 397d s 	dw 	0xDAEE
397f 397f d 1f0d
397f 397f s 	db 	0x1F,0x0d
3981 3981 s 	endm
3981 3981 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
3981 3981 d 59
3981 3981 s 	db 	pB_MAYBE_PATCH
3982 3982 d f0da
3982 3982 s 	dw 	0xDAEE+2
3984 3984 d 0a0d
3984 3984 s 	db 	0x0a,0x0d
3986 3986 s 	endm
3986 3986 s 	dbpatch	0xE30E+1	,0x49	,0xc9
3986 3986 d 52
3986 3986 s 	db 	pB_CHK_PATCH
3987 3987 d 0fe3
3987 3987 s 	dw 	0xE30E+1
3989 3989 d 49c9
3989 3989 s 	db 	0x49,0xc9
398b 398b s 	endm
398b 398b s 	dbpatch	0xDA88 	,0x01	,0x00
398b 398b d 52
398b 398b s 	db 	pB_CHK_PATCH
398c 398c d 88da
398c 398c s 	dw 	0xDA88
398e 398e d 0100
398e 398e s 	db 	0x01,0x00
3990 3990 s 	endm
3990 3990 s 	dbpatch	0xDA9F 	,0x02	,0x00
3990 3990 d 52
3990 3990 s 	db 	pB_CHK_PATCH
3991 3991 d 9fda
3991 3991 s 	dw 	0xDA9F
3993 3993 d 0200
3993 3993 s 	db 	0x02,0x00
3995 3995 s 	endm
3995 3995 s 	dbpatch	0xDAB6 	,0x04	,0x01
3995 3995 d 52
3995 3995 s 	db 	pB_CHK_PATCH
3996 3996 d b6da
3996 3996 s 	dw 	0xDAB6
3998 3998 d 0401
3998 3998 s 	db 	0x04,0x01
399a 399a s 	endm
399a 399a s 	dbpatch	0xDACD 	,0x08	,0x02
399a 399a d 52
399a 399a s 	db 	pB_CHK_PATCH
399b 399b d cdda
399b 399b s 	dw 	0xDACD
399d 399d d 0802
399d 399d s 	db 	0x08,0x02
399f 399f s 	endm
399f 399f s 	dwstore	_CPM2_res_DRIVE_TAB+0*2	,0xDA88
399f 399f d 54
399f 399f s 	db 	pW_STORE
39a0 39a0 d 88da
39a0 39a0 s 	dw 	0xDA88
39a2 39a2 d 06ea
39a2 39a2 s 	dw 	_CPM2_res_DRIVE_TAB+0*2
39a4 39a4 s 	endm
39a4 39a4 s 	dwstore	_CPM2_res_DRIVE_TAB+1*2	,0xDA9F
39a4 39a4 d 54
39a4 39a4 s 	db 	pW_STORE
39a5 39a5 d 9fda
39a5 39a5 s 	dw 	0xDA9F
39a7 39a7 d 08ea
39a7 39a7 s 	dw 	_CPM2_res_DRIVE_TAB+1*2
39a9 39a9 s 	endm
39a9 39a9 s 	dwstore	_CPM2_res_DRIVE_TAB+2*2	,0xDAB6
39a9 39a9 d 54
39a9 39a9 s 	db 	pW_STORE
39aa 39aa d b6da
39aa 39aa s 	dw 	0xDAB6
39ac 39ac d 0aea
39ac 39ac s 	dw 	_CPM2_res_DRIVE_TAB+2*2
39ae 39ae s 	endm
39ae 39ae s 	dwstore	_CPM2_res_DRIVE_TAB+3*2	,0xDACD
39ae 39ae d 54
39ae 39ae s 	db 	pW_STORE
39af 39af d cdda
39af 39af s 	dw 	0xDACD
39b1 39b1 d 0cea
39b1 39b1 s 	dw 	_CPM2_res_DRIVE_TAB+3*2
39b3 39b3 s 	endm
39b3 39b3 s 	dwpatch 0xDCF6+5*2 	,0x0000 ,_CPM2_dph_F
39b3 39b3 d 51
39b3 39b3 s 	db 	pW_CHK_PATCH
39b4 39b4 d 00dd
39b4 39b4 s 	dw 	0xDCF6+5*2
39b6 39b6 d 000012ea
39b6 39b6 s 	dw 	0x0000,_CPM2_dph_F
39ba 39ba s 	endm
39ba 39ba s 	dwstore _CPM2_dph_F+8	,0xDFDB
39ba 39ba d 54
39ba 39ba s 	db 	pW_STORE
39bb 39bb d dbdf
39bb 39bb s 	dw 	0xDFDB
39bd 39bd d 1aea
39bd 39bd s 	dw 	_CPM2_dph_F+8
39bf 39bf s 	endm
39bf 39bf s 	dwpatch 0xDA1B+1 	,0xDCB2	,_CPM2_res_seldsk
39bf 39bf d 51
39bf 39bf s 	db 	pW_CHK_PATCH
39c0 39c0 d 1cda
39c0 39c0 s 	dw 	0xDA1B+1
39c2 39c2 d b2dc6bea
39c2 39c2 s 	dw 	0xDCB2,_CPM2_res_seldsk
39c6 39c6 s 	endm
39c6 39c6 s 	dwstore	_CPM2_old_seld_dsk+1	,0xDCB2
39c6 39c6 d 54
39c6 39c6 s 	db 	pW_STORE
39c7 39c7 d b2dc
39c7 39c7 s 	dw 	0xDCB2
39c9 39c9 d 6fea
39c9 39c9 s 	dw 	_CPM2_old_seld_dsk+1
39cb 39cb s 	endm
39cb 39cb s 	dbpatch	0xE789	,0x77	,0x00
39cb 39cb d 52
39cb 39cb s 	db 	pB_CHK_PATCH
39cc 39cc d 89e7
39cc 39cc s 	dw 	0xE789
39ce 39ce d 7700
39ce 39ce s 	db 	0x77,0x00
39d0 39d0 s 	endm
39d0 39d0 s 	dwstore	_CPM2_r_p_SELDSKDRIVER+1	,0xDFC9
39d0 39d0 d 54
39d0 39d0 s 	db 	pW_STORE
39d1 39d1 d c9df
39d1 39d1 s 	dw 	0xDFC9
39d3 39d3 d 88ea
39d3 39d3 s 	dw 	_CPM2_r_p_SELDSKDRIVER+1
39d5 39d5 s 	endm
39d5 39d5 s 	dwstore	_CPM2_r_p_SELDSKDRIVEW+1	,0xDFC9
39d5 39d5 d 54
39d5 39d5 s 	db 	pW_STORE
39d6 39d6 d c9df
39d6 39d6 s 	dw 	0xDFC9
39d8 39d8 d c5ea
39d8 39d8 s 	dw 	_CPM2_r_p_SELDSKDRIVEW+1
39da 39da s 	endm
39da 39da s 	dwpatch	0xDA27+1	,0xDD15	,_CPM2_res_READ
39da 39da d 51
39da 39da s 	db 	pW_CHK_PATCH
39db 39db d 28da
39db 39db s 	dw 	0xDA27+1
39dd 39dd d 15dd75ea
39dd 39dd s 	dw 	0xDD15,_CPM2_res_READ
39e1 39e1 s 	endm
39e1 39e1 s 	dwpatch	0xDA2A+1	,0xDE4B	,_CPM2_res_WRITE
39e1 39e1 d 51
39e1 39e1 s 	db 	pW_CHK_PATCH
39e2 39e2 d 2bda
39e2 39e2 s 	dw 	0xDA2A+1
39e4 39e4 d 4bdeb2ea
39e4 39e4 s 	dw 	0xDE4B,_CPM2_res_WRITE
39e8 39e8 s 	endm
39e8 39e8 s 	dwpatch	0xDB70+1	,0xDD15	,_CPM2_res_READ
39e8 39e8 d 51
39e8 39e8 s 	db 	pW_CHK_PATCH
39e9 39e9 d 71db
39e9 39e9 s 	dw 	0xDB70+1
39eb 39eb d 15dd75ea
39eb 39eb s 	dw 	0xDD15,_CPM2_res_READ
39ef 39ef s 	endm
39ef 39ef s 	dwpatch	0xDCE4+1	,0xE6BF	,_CPM2_res_GETINFO
39ef 39ef d 51
39ef 39ef s 	db 	pW_CHK_PATCH
39f0 39f0 d e5dc
39f0 39f0 s 	dw 	0xDCE4+1
39f2 39f2 d bfe6efea
39f2 39f2 s 	dw 	0xE6BF,_CPM2_res_GETINFO
39f6 39f6 s 	endm
39f6 39f6 s 	dwstore	_CPM2__old_read+1	,0xDD15
39f6 39f6 d 54
39f6 39f6 s 	db 	pW_STORE
39f7 39f7 d 15dd
39f7 39f7 s 	dw 	0xDD15
39f9 39f9 d b0ea
39f9 39f9 s 	dw 	_CPM2__old_read+1
39fb 39fb s 	endm
39fb 39fb s 	dwstore	_CPM2__old_write+1	,0xDE4B
39fb 39fb d 54
39fb 39fb s 	db 	pW_STORE
39fc 39fc d 4bde
39fc 39fc s 	dw 	0xDE4B
39fe 39fe d edea
39fe 39fe s 	dw 	_CPM2__old_write+1
3a00 3a00 s 	endm
3a00 3a00 s 	dwstore	_CPM2__old_getinfo+1	,0xE6BF
3a00 3a00 d 54
3a00 3a00 s 	db 	pW_STORE
3a01 3a01 d bfe6
3a01 3a01 s 	dw 	0xE6BF
3a03 3a03 d fdea
3a03 3a03 s 	dw 	_CPM2__old_getinfo+1
3a05 3a05 s 	endm
3a05 3a05 s 	dbpatch	0xE6FF		,0x21	,0x21
3a05 3a05 d 52
3a05 3a05 s 	db 	pB_CHK_PATCH
3a06 3a06 d ffe6
3a06 3a06 s 	dw 	0xE6FF
3a08 3a08 d 2121
3a08 3a08 s 	db 	0x21,0x21
3a0a 3a0a s 	endm
3a0a 3a0a s 	dwpatch	0xE6FF+1 	,0xe72F	,0xe72F
3a0a 3a0a d 51
3a0a 3a0a s 	db 	pW_CHK_PATCH
3a0b 3a0b d 00e7
3a0b 3a0b s 	dw 	0xE6FF+1
3a0d 3a0d d 2fe72fe7
3a0d 3a0d s 	dw 	0xe72F,0xe72F
3a11 3a11 s 	endm
3a11 3a11 s 	dwstore	_CPM2__old_getinfo_chkdo+1	,0xE6FF
3a11 3a11 d 54
3a11 3a11 s 	db 	pW_STORE
3a12 3a12 d ffe6
3a12 3a12 s 	dw 	0xE6FF
3a14 3a14 d faea
3a14 3a14 s 	dw 	_CPM2__old_getinfo_chkdo+1
3a16 3a16 s 	endm
3a16 3a16 s 	dwstore	_CPM2_r_p_DSK1+1	,0xDFBF 	;read
3a16 3a16 d 54
3a16 3a16 s 	db 	pW_STORE
3a17 3a17 d bfdf
3a17 3a17 s 	dw 	0xDFBF
3a19 3a19 d 76ea
3a19 3a19 s 	dw 	_CPM2_r_p_DSK1+1
3a1b 3a1b s 	endm
3a1b 3a1b s 	dwstore	_CPM2_r_p_TRK1+1	,0xDFC3 	
3a1b 3a1b d 54
3a1b 3a1b s 	db 	pW_STORE
3a1c 3a1c d c3df
3a1c 3a1c s 	dw 	0xDFC3
3a1e 3a1e d 91ea
3a1e 3a1e s 	dw 	_CPM2_r_p_TRK1+1
3a20 3a20 s 	endm
3a20 3a20 s 	dwstore	_CPM2_r_p_SEC1+1	,0xDFC4 	
3a20 3a20 d 54
3a20 3a20 s 	db 	pW_STORE
3a21 3a21 d c4df
3a21 3a21 s 	dw 	0xDFC4
3a23 3a23 d 97ea
3a23 3a23 s 	dw 	_CPM2_r_p_SEC1+1
3a25 3a25 s 	endm
3a25 3a25 s 	dwstore	_CPM2_r_p_DMA1+1	,0xDFC5 	
3a25 3a25 d 54
3a25 3a25 s 	db 	pW_STORE
3a26 3a26 d c5df
3a26 3a26 s 	dw 	0xDFC5
3a28 3a28 d a8ea
3a28 3a28 s 	dw 	_CPM2_r_p_DMA1+1
3a2a 3a2a s 	endm
3a2a 3a2a s 	dwstore	_CPM2_r_p_DSK2+1	,0xDFBF 	;write
3a2a 3a2a d 54
3a2a 3a2a s 	db 	pW_STORE
3a2b 3a2b d bfdf
3a2b 3a2b s 	dw 	0xDFBF
3a2d 3a2d d b3ea
3a2d 3a2d s 	dw 	_CPM2_r_p_DSK2+1
3a2f 3a2f s 	endm
3a2f 3a2f s 	dwstore	_CPM2_r_p_TRK2+1	,0xDFC3 	
3a2f 3a2f d 54
3a2f 3a2f s 	db 	pW_STORE
3a30 3a30 d c3df
3a30 3a30 s 	dw 	0xDFC3
3a32 3a32 d ceea
3a32 3a32 s 	dw 	_CPM2_r_p_TRK2+1
3a34 3a34 s 	endm
3a34 3a34 s 	dwstore	_CPM2_r_p_SEC2+1	,0xDFC4 	
3a34 3a34 d 54
3a34 3a34 s 	db 	pW_STORE
3a35 3a35 d c4df
3a35 3a35 s 	dw 	0xDFC4
3a37 3a37 d d4ea
3a37 3a37 s 	dw 	_CPM2_r_p_SEC2+1
3a39 3a39 s 	endm
3a39 3a39 s 	dwstore	_CPM2_r_p_DMA2+1	,0xDFC5 	
3a39 3a39 d 54
3a39 3a39 s 	db 	pW_STORE
3a3a 3a3a d c5df
3a3a 3a3a s 	dw 	0xDFC5
3a3c 3a3c d e5ea
3a3c 3a3c s 	dw 	_CPM2_r_p_DMA2+1
3a3e 3a3e s 	endm
3a3e 3a3e s 	dwstore	_CPM2_r_p_DSK3+1	,0xDFBF 	;readinfo
3a3e 3a3e d 54
3a3e 3a3e s 	db 	pW_STORE
3a3f 3a3f d bfdf
3a3f 3a3f s 	dw 	0xDFBF
3a41 3a41 d 82eb
3a41 3a41 s 	dw 	_CPM2_r_p_DSK3+1
3a43 3a43 s 	endm
3a43 3a43 s 
3a43 3a43 s 	stop 'CPM_12_87_11_niijaf'
3a43 3a43 d 50
3a43 3a43 s 	db 	p_STOP
3a44 3a44 d 43504d5f31325f38375f31315f6e69696a6166
3a44 3a44 s 	db 	'CPM_12_87_11_niijaf'
3a57 3a57 d 00
3a57 3a57 s 	db 	0
3a58 3a58 s 	endm
3a58 3a58 f out/include-patcher.asm
3a58 3a58 s 	include "generator/V0/out/patcher-cpm1-CPM_21m_____Shkanov.asm"	;  2 images in collection
3a58 3a58 f generator/V0/out/patcher-cpm1-CPM_21m_____Shkanov.asm
3a58 3a58 s _BIOS_CPM_21m_____Shkanov:
3a58 3a58 s 	setSUBBIOS 1
3a58 3a58 d 5a
3a58 3a58 s 	db	pSubBios
3a59 3a59 d 01
3a59 3a59 s 	db 	1
3a5a 3a5a s 	endm
3a5a 3a5a s 	RQ_OPTS_ANY
3a5a 3a5a s 	endm
3a5a 3a5a s 	setCPM
3a5a 3a5a s 	endm
3a5a 3a5a s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
3a5a 3a5a d 59
3a5a 3a5a s 	db 	pB_MAYBE_PATCH
3a5b 3a5b d eeda
3a5b 3a5b s 	dw 	0xDAEE
3a5d 3a5d d 1f0d
3a5d 3a5d s 	db 	0x1F,0x0d
3a5f 3a5f s 	endm
3a5f 3a5f s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
3a5f 3a5f d 59
3a5f 3a5f s 	db 	pB_MAYBE_PATCH
3a60 3a60 d f0da
3a60 3a60 s 	dw 	0xDAEE+2
3a62 3a62 d 0a0d
3a62 3a62 s 	db 	0x0a,0x0d
3a64 3a64 s 	endm
3a64 3a64 s 	dbpatch	0xE135+1	,0x49	,0xc9
3a64 3a64 d 52
3a64 3a64 s 	db 	pB_CHK_PATCH
3a65 3a65 d 36e1
3a65 3a65 s 	dw 	0xE135+1
3a67 3a67 d 49c9
3a67 3a67 s 	db 	0x49,0xc9
3a69 3a69 s 	endm
3a69 3a69 s 	dbpatch	0xDA89 	,0x01	,0x00
3a69 3a69 d 52
3a69 3a69 s 	db 	pB_CHK_PATCH
3a6a 3a6a d 89da
3a6a 3a6a s 	dw 	0xDA89
3a6c 3a6c d 0100
3a6c 3a6c s 	db 	0x01,0x00
3a6e 3a6e s 	endm
3a6e 3a6e s 	dbpatch	0xDAA0 	,0x02	,0x00
3a6e 3a6e d 52
3a6e 3a6e s 	db 	pB_CHK_PATCH
3a6f 3a6f d a0da
3a6f 3a6f s 	dw 	0xDAA0
3a71 3a71 d 0200
3a71 3a71 s 	db 	0x02,0x00
3a73 3a73 s 	endm
3a73 3a73 s 	dbpatch	0xDAB7 	,0x04	,0x01
3a73 3a73 d 52
3a73 3a73 s 	db 	pB_CHK_PATCH
3a74 3a74 d b7da
3a74 3a74 s 	dw 	0xDAB7
3a76 3a76 d 0401
3a76 3a76 s 	db 	0x04,0x01
3a78 3a78 s 	endm
3a78 3a78 s 	dbpatch	0xDACE 	,0x08	,0x02
3a78 3a78 d 52
3a78 3a78 s 	db 	pB_CHK_PATCH
3a79 3a79 d ceda
3a79 3a79 s 	dw 	0xDACE
3a7b 3a7b d 0802
3a7b 3a7b s 	db 	0x08,0x02
3a7d 3a7d s 	endm
3a7d 3a7d s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA89
3a7d 3a7d d 54
3a7d 3a7d s 	db 	pW_STORE
3a7e 3a7e d 89da
3a7e 3a7e s 	dw 	0xDA89
3a80 3a80 d ace8
3a80 3a80 s 	dw 	_CPM1_res_DRIVE_TAB+0*2
3a82 3a82 s 	endm
3a82 3a82 s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDAA0
3a82 3a82 d 54
3a82 3a82 s 	db 	pW_STORE
3a83 3a83 d a0da
3a83 3a83 s 	dw 	0xDAA0
3a85 3a85 d aee8
3a85 3a85 s 	dw 	_CPM1_res_DRIVE_TAB+1*2
3a87 3a87 s 	endm
3a87 3a87 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB7
3a87 3a87 d 54
3a87 3a87 s 	db 	pW_STORE
3a88 3a88 d b7da
3a88 3a88 s 	dw 	0xDAB7
3a8a 3a8a d b0e8
3a8a 3a8a s 	dw 	_CPM1_res_DRIVE_TAB+2*2
3a8c 3a8c s 	endm
3a8c 3a8c s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACE
3a8c 3a8c d 54
3a8c 3a8c s 	db 	pW_STORE
3a8d 3a8d d ceda
3a8d 3a8d s 	dw 	0xDACE
3a8f 3a8f d b2e8
3a8f 3a8f s 	dw 	_CPM1_res_DRIVE_TAB+3*2
3a91 3a91 s 	endm
3a91 3a91 s 	dwpatch 0xDCB5+5*2 	,0x0000 ,_CPM1_dph_F
3a91 3a91 d 51
3a91 3a91 s 	db 	pW_CHK_PATCH
3a92 3a92 d bfdc
3a92 3a92 s 	dw 	0xDCB5+5*2
3a94 3a94 d 0000b8e8
3a94 3a94 s 	dw 	0x0000,_CPM1_dph_F
3a98 3a98 s 	endm
3a98 3a98 s 	dwstore _CPM1_dph_F+8	,0xEBA6
3a98 3a98 d 54
3a98 3a98 s 	db 	pW_STORE
3a99 3a99 d a6eb
3a99 3a99 s 	dw 	0xEBA6
3a9b 3a9b d c0e8
3a9b 3a9b s 	dw 	_CPM1_dph_F+8
3a9d 3a9d s 	endm
3a9d 3a9d s 	dwpatch 0xDA1B+1 	,0xDC73	,_CPM1_res_seldsk
3a9d 3a9d d 51
3a9d 3a9d s 	db 	pW_CHK_PATCH
3a9e 3a9e d 1cda
3a9e 3a9e s 	dw 	0xDA1B+1
3aa0 3aa0 d 73dc11e9
3aa0 3aa0 s 	dw 	0xDC73,_CPM1_res_seldsk
3aa4 3aa4 s 	endm
3aa4 3aa4 s 	dwstore	_CPM1_old_seld_dsk+1	,0xDC73
3aa4 3aa4 d 54
3aa4 3aa4 s 	db 	pW_STORE
3aa5 3aa5 d 73dc
3aa5 3aa5 s 	dw 	0xDC73
3aa7 3aa7 d 15e9
3aa7 3aa7 s 	dw 	_CPM1_old_seld_dsk+1
3aa9 3aa9 s 	endm
3aa9 3aa9 s 	dbpatch	0xE6FE	,0x77	,0x00
3aa9 3aa9 d 52
3aa9 3aa9 s 	db 	pB_CHK_PATCH
3aaa 3aaa d fee6
3aaa 3aaa s 	dw 	0xE6FE
3aac 3aac d 7700
3aac 3aac s 	db 	0x77,0x00
3aae 3aae s 	endm
3aae 3aae s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xE058
3aae 3aae d 54
3aae 3aae s 	db 	pW_STORE
3aaf 3aaf d 58e0
3aaf 3aaf s 	dw 	0xE058
3ab1 3ab1 d 2ee9
3ab1 3ab1 s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
3ab3 3ab3 s 	endm
3ab3 3ab3 s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xE058
3ab3 3ab3 d 54
3ab3 3ab3 s 	db 	pW_STORE
3ab4 3ab4 d 58e0
3ab4 3ab4 s 	dw 	0xE058
3ab6 3ab6 d 6be9
3ab6 3ab6 s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
3ab8 3ab8 s 	endm
3ab8 3ab8 s 	dwpatch	0xDA27+1	,0xDCD5	,_CPM1_res_READ
3ab8 3ab8 d 51
3ab8 3ab8 s 	db 	pW_CHK_PATCH
3ab9 3ab9 d 28da
3ab9 3ab9 s 	dw 	0xDA27+1
3abb 3abb d d5dc1be9
3abb 3abb s 	dw 	0xDCD5,_CPM1_res_READ
3abf 3abf s 	endm
3abf 3abf s 	dwpatch	0xDA2A+1	,0xDE99	,_CPM1_res_WRITE
3abf 3abf d 51
3abf 3abf s 	db 	pW_CHK_PATCH
3ac0 3ac0 d 2bda
3ac0 3ac0 s 	dw 	0xDA2A+1
3ac2 3ac2 d 99de58e9
3ac2 3ac2 s 	dw 	0xDE99,_CPM1_res_WRITE
3ac6 3ac6 s 	endm
3ac6 3ac6 s 	dwpatch	0xDB6A+1	,0xDCD5	,_CPM1_res_READ
3ac6 3ac6 d 51
3ac6 3ac6 s 	db 	pW_CHK_PATCH
3ac7 3ac7 d 6bdb
3ac7 3ac7 s 	dw 	0xDB6A+1
3ac9 3ac9 d d5dc1be9
3ac9 3ac9 s 	dw 	0xDCD5,_CPM1_res_READ
3acd 3acd s 	endm
3acd 3acd s 	dwpatch	0xdca8+1	,0xE632	,_CPM1_res_GETINFO
3acd 3acd d 51
3acd 3acd s 	db 	pW_CHK_PATCH
3ace 3ace d a9dc
3ace 3ace s 	dw 	0xdca8+1
3ad0 3ad0 d 32e695e9
3ad0 3ad0 s 	dw 	0xE632,_CPM1_res_GETINFO
3ad4 3ad4 s 	endm
3ad4 3ad4 s 	dwstore	_CPM1__old_read+1	,0xDCD5
3ad4 3ad4 d 54
3ad4 3ad4 s 	db 	pW_STORE
3ad5 3ad5 d d5dc
3ad5 3ad5 s 	dw 	0xDCD5
3ad7 3ad7 d 56e9
3ad7 3ad7 s 	dw 	_CPM1__old_read+1
3ad9 3ad9 s 	endm
3ad9 3ad9 s 	dwstore	_CPM1__old_write+1	,0xDE99
3ad9 3ad9 d 54
3ad9 3ad9 s 	db 	pW_STORE
3ada 3ada d 99de
3ada 3ada s 	dw 	0xDE99
3adc 3adc d 93e9
3adc 3adc s 	dw 	_CPM1__old_write+1
3ade 3ade s 	endm
3ade 3ade s 	dwstore	_CPM1__old_getinfo+1	,0xE632
3ade 3ade d 54
3ade 3ade s 	db 	pW_STORE
3adf 3adf d 32e6
3adf 3adf s 	dw 	0xE632
3ae1 3ae1 d a3e9
3ae1 3ae1 s 	dw 	_CPM1__old_getinfo+1
3ae3 3ae3 s 	endm
3ae3 3ae3 s 	dbpatch	0xE669		,0x21	,0x21
3ae3 3ae3 d 52
3ae3 3ae3 s 	db 	pB_CHK_PATCH
3ae4 3ae4 d 69e6
3ae4 3ae4 s 	dw 	0xE669
3ae6 3ae6 d 2121
3ae6 3ae6 s 	db 	0x21,0x21
3ae8 3ae8 s 	endm
3ae8 3ae8 s 	dwpatch	0xE669+1 	,0xE6A3	,0xE6A3
3ae8 3ae8 d 51
3ae8 3ae8 s 	db 	pW_CHK_PATCH
3ae9 3ae9 d 6ae6
3ae9 3ae9 s 	dw 	0xE669+1
3aeb 3aeb d a3e6a3e6
3aeb 3aeb s 	dw 	0xE6A3,0xE6A3
3aef 3aef s 	endm
3aef 3aef s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE669
3aef 3aef d 54
3aef 3aef s 	db 	pW_STORE
3af0 3af0 d 69e6
3af0 3af0 s 	dw 	0xE669
3af2 3af2 d a0e9
3af2 3af2 s 	dw 	_CPM1__old_getinfo_chkdo+1
3af4 3af4 s 	endm
3af4 3af4 s 	dwstore	_CPM1_r_p_DSK1+1	,0xE04E 	;read
3af4 3af4 d 54
3af4 3af4 s 	db 	pW_STORE
3af5 3af5 d 4ee0
3af5 3af5 s 	dw 	0xE04E
3af7 3af7 d 1ce9
3af7 3af7 s 	dw 	_CPM1_r_p_DSK1+1
3af9 3af9 s 	endm
3af9 3af9 s 	dwstore	_CPM1_r_p_TRK1+1	,0xE052 	
3af9 3af9 d 54
3af9 3af9 s 	db 	pW_STORE
3afa 3afa d 52e0
3afa 3afa s 	dw 	0xE052
3afc 3afc d 37e9
3afc 3afc s 	dw 	_CPM1_r_p_TRK1+1
3afe 3afe s 	endm
3afe 3afe s 	dwstore	_CPM1_r_p_SEC1+1	,0xE053 	
3afe 3afe d 54
3afe 3afe s 	db 	pW_STORE
3aff 3aff d 53e0
3aff 3aff s 	dw 	0xE053
3b01 3b01 d 3de9
3b01 3b01 s 	dw 	_CPM1_r_p_SEC1+1
3b03 3b03 s 	endm
3b03 3b03 s 	dwstore	_CPM1_r_p_DMA1+1	,0xE054 	
3b03 3b03 d 54
3b03 3b03 s 	db 	pW_STORE
3b04 3b04 d 54e0
3b04 3b04 s 	dw 	0xE054
3b06 3b06 d 4ee9
3b06 3b06 s 	dw 	_CPM1_r_p_DMA1+1
3b08 3b08 s 	endm
3b08 3b08 s 	dwstore	_CPM1_r_p_DSK2+1	,0xE04E 	;write
3b08 3b08 d 54
3b08 3b08 s 	db 	pW_STORE
3b09 3b09 d 4ee0
3b09 3b09 s 	dw 	0xE04E
3b0b 3b0b d 59e9
3b0b 3b0b s 	dw 	_CPM1_r_p_DSK2+1
3b0d 3b0d s 	endm
3b0d 3b0d s 	dwstore	_CPM1_r_p_TRK2+1	,0xE052 	
3b0d 3b0d d 54
3b0d 3b0d s 	db 	pW_STORE
3b0e 3b0e d 52e0
3b0e 3b0e s 	dw 	0xE052
3b10 3b10 d 74e9
3b10 3b10 s 	dw 	_CPM1_r_p_TRK2+1
3b12 3b12 s 	endm
3b12 3b12 s 	dwstore	_CPM1_r_p_SEC2+1	,0xE053 	
3b12 3b12 d 54
3b12 3b12 s 	db 	pW_STORE
3b13 3b13 d 53e0
3b13 3b13 s 	dw 	0xE053
3b15 3b15 d 7ae9
3b15 3b15 s 	dw 	_CPM1_r_p_SEC2+1
3b17 3b17 s 	endm
3b17 3b17 s 	dwstore	_CPM1_r_p_DMA2+1	,0xE054 	
3b17 3b17 d 54
3b17 3b17 s 	db 	pW_STORE
3b18 3b18 d 54e0
3b18 3b18 s 	dw 	0xE054
3b1a 3b1a d 8be9
3b1a 3b1a s 	dw 	_CPM1_r_p_DMA2+1
3b1c 3b1c s 	endm
3b1c 3b1c s 	dwstore	_CPM1_r_p_DSK3+1	,0xE04E 	;readinfo
3b1c 3b1c d 54
3b1c 3b1c s 	db 	pW_STORE
3b1d 3b1d d 4ee0
3b1d 3b1d s 	dw 	0xE04E
3b1f 3b1f d 28ea
3b1f 3b1f s 	dw 	_CPM1_r_p_DSK3+1
3b21 3b21 s 	endm
3b21 3b21 s 
3b21 3b21 s 	stop 'CPM_21m_____Shkanov'
3b21 3b21 d 50
3b21 3b21 s 	db 	p_STOP
3b22 3b22 d 43504d5f32316d5f5f5f5f5f53686b616e6f76
3b22 3b22 s 	db 	'CPM_21m_____Shkanov'
3b35 3b35 d 00
3b35 3b35 s 	db 	0
3b36 3b36 s 	endm
3b36 3b36 f out/include-patcher.asm
3b36 3b36 s 	include "generator/V0/out/patcher-cpm1-CPM_12_87_09_NIIJAF.asm"	;  2 images in collection
3b36 3b36 f generator/V0/out/patcher-cpm1-CPM_12_87_09_NIIJAF.asm
3b36 3b36 s _BIOS_CPM_12_87_09_NIIJAF:
3b36 3b36 s 	setSUBBIOS 1
3b36 3b36 d 5a
3b36 3b36 s 	db	pSubBios
3b37 3b37 d 01
3b37 3b37 s 	db 	1
3b38 3b38 s 	endm
3b38 3b38 s 	RQ_OPTS_ANY
3b38 3b38 s 	endm
3b38 3b38 s 	setCPM
3b38 3b38 s 	endm
3b38 3b38 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
3b38 3b38 d 59
3b38 3b38 s 	db 	pB_MAYBE_PATCH
3b39 3b39 d eeda
3b39 3b39 s 	dw 	0xDAEE
3b3b 3b3b d 1f0d
3b3b 3b3b s 	db 	0x1F,0x0d
3b3d 3b3d s 	endm
3b3d 3b3d s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
3b3d 3b3d d 59
3b3d 3b3d s 	db 	pB_MAYBE_PATCH
3b3e 3b3e d f0da
3b3e 3b3e s 	dw 	0xDAEE+2
3b40 3b40 d 0a0d
3b40 3b40 s 	db 	0x0a,0x0d
3b42 3b42 s 	endm
3b42 3b42 s 	dbpatch	0xE738+1	,0x49	,0xc9
3b42 3b42 d 52
3b42 3b42 s 	db 	pB_CHK_PATCH
3b43 3b43 d 39e7
3b43 3b43 s 	dw 	0xE738+1
3b45 3b45 d 49c9
3b45 3b45 s 	db 	0x49,0xc9
3b47 3b47 s 	endm
3b47 3b47 s 	dbpatch	0xDA88 	,0x01	,0x00
3b47 3b47 d 52
3b47 3b47 s 	db 	pB_CHK_PATCH
3b48 3b48 d 88da
3b48 3b48 s 	dw 	0xDA88
3b4a 3b4a d 0100
3b4a 3b4a s 	db 	0x01,0x00
3b4c 3b4c s 	endm
3b4c 3b4c s 	dbpatch	0xDA9F 	,0x02	,0x00
3b4c 3b4c d 52
3b4c 3b4c s 	db 	pB_CHK_PATCH
3b4d 3b4d d 9fda
3b4d 3b4d s 	dw 	0xDA9F
3b4f 3b4f d 0200
3b4f 3b4f s 	db 	0x02,0x00
3b51 3b51 s 	endm
3b51 3b51 s 	dbpatch	0xDAB6 	,0x04	,0x01
3b51 3b51 d 52
3b51 3b51 s 	db 	pB_CHK_PATCH
3b52 3b52 d b6da
3b52 3b52 s 	dw 	0xDAB6
3b54 3b54 d 0401
3b54 3b54 s 	db 	0x04,0x01
3b56 3b56 s 	endm
3b56 3b56 s 	dbpatch	0xDACD 	,0x08	,0x02
3b56 3b56 d 52
3b56 3b56 s 	db 	pB_CHK_PATCH
3b57 3b57 d cdda
3b57 3b57 s 	dw 	0xDACD
3b59 3b59 d 0802
3b59 3b59 s 	db 	0x08,0x02
3b5b 3b5b s 	endm
3b5b 3b5b s 	dwstore	_CPM1_res_DRIVE_TAB+0*2	,0xDA88
3b5b 3b5b d 54
3b5b 3b5b s 	db 	pW_STORE
3b5c 3b5c d 88da
3b5c 3b5c s 	dw 	0xDA88
3b5e 3b5e d ace8
3b5e 3b5e s 	dw 	_CPM1_res_DRIVE_TAB+0*2
3b60 3b60 s 	endm
3b60 3b60 s 	dwstore	_CPM1_res_DRIVE_TAB+1*2	,0xDA9F
3b60 3b60 d 54
3b60 3b60 s 	db 	pW_STORE
3b61 3b61 d 9fda
3b61 3b61 s 	dw 	0xDA9F
3b63 3b63 d aee8
3b63 3b63 s 	dw 	_CPM1_res_DRIVE_TAB+1*2
3b65 3b65 s 	endm
3b65 3b65 s 	dwstore	_CPM1_res_DRIVE_TAB+2*2	,0xDAB6
3b65 3b65 d 54
3b65 3b65 s 	db 	pW_STORE
3b66 3b66 d b6da
3b66 3b66 s 	dw 	0xDAB6
3b68 3b68 d b0e8
3b68 3b68 s 	dw 	_CPM1_res_DRIVE_TAB+2*2
3b6a 3b6a s 	endm
3b6a 3b6a s 	dwstore	_CPM1_res_DRIVE_TAB+3*2	,0xDACD
3b6a 3b6a d 54
3b6a 3b6a s 	db 	pW_STORE
3b6b 3b6b d cdda
3b6b 3b6b s 	dw 	0xDACD
3b6d 3b6d d b2e8
3b6d 3b6d s 	dw 	_CPM1_res_DRIVE_TAB+3*2
3b6f 3b6f s 	endm
3b6f 3b6f s 	dwpatch 0xDCFA+5*2 	,0x0000 ,_CPM1_dph_F
3b6f 3b6f d 51
3b6f 3b6f s 	db 	pW_CHK_PATCH
3b70 3b70 d 04dd
3b70 3b70 s 	dw 	0xDCFA+5*2
3b72 3b72 d 0000b8e8
3b72 3b72 s 	dw 	0x0000,_CPM1_dph_F
3b76 3b76 s 	endm
3b76 3b76 s 	dwstore _CPM1_dph_F+8	,0xDFDF
3b76 3b76 d 54
3b76 3b76 s 	db 	pW_STORE
3b77 3b77 d dfdf
3b77 3b77 s 	dw 	0xDFDF
3b79 3b79 d c0e8
3b79 3b79 s 	dw 	_CPM1_dph_F+8
3b7b 3b7b s 	endm
3b7b 3b7b s 	dwpatch 0xDA1B+1 	,0xDCB6	,_CPM1_res_seldsk
3b7b 3b7b d 51
3b7b 3b7b s 	db 	pW_CHK_PATCH
3b7c 3b7c d 1cda
3b7c 3b7c s 	dw 	0xDA1B+1
3b7e 3b7e d b6dc11e9
3b7e 3b7e s 	dw 	0xDCB6,_CPM1_res_seldsk
3b82 3b82 s 	endm
3b82 3b82 s 	dwstore	_CPM1_old_seld_dsk+1	,0xDCB6
3b82 3b82 d 54
3b82 3b82 s 	db 	pW_STORE
3b83 3b83 d b6dc
3b83 3b83 s 	dw 	0xDCB6
3b85 3b85 d 15e9
3b85 3b85 s 	dw 	_CPM1_old_seld_dsk+1
3b87 3b87 s 	endm
3b87 3b87 s 	dbpatch	0xE531	,0x77	,0x00
3b87 3b87 d 52
3b87 3b87 s 	db 	pB_CHK_PATCH
3b88 3b88 d 31e5
3b88 3b88 s 	dw 	0xE531
3b8a 3b8a d 7700
3b8a 3b8a s 	db 	0x77,0x00
3b8c 3b8c s 	endm
3b8c 3b8c s 	dwstore	_CPM1_r_p_SELDSKDRIVER+1	,0xDFCD
3b8c 3b8c d 54
3b8c 3b8c s 	db 	pW_STORE
3b8d 3b8d d cddf
3b8d 3b8d s 	dw 	0xDFCD
3b8f 3b8f d 2ee9
3b8f 3b8f s 	dw 	_CPM1_r_p_SELDSKDRIVER+1
3b91 3b91 s 	endm
3b91 3b91 s 	dwstore	_CPM1_r_p_SELDSKDRIVEW+1	,0xDFCD
3b91 3b91 d 54
3b91 3b91 s 	db 	pW_STORE
3b92 3b92 d cddf
3b92 3b92 s 	dw 	0xDFCD
3b94 3b94 d 6be9
3b94 3b94 s 	dw 	_CPM1_r_p_SELDSKDRIVEW+1
3b96 3b96 s 	endm
3b96 3b96 s 	dwpatch	0xDA27+1	,0xDD19	,_CPM1_res_READ
3b96 3b96 d 51
3b96 3b96 s 	db 	pW_CHK_PATCH
3b97 3b97 d 28da
3b97 3b97 s 	dw 	0xDA27+1
3b99 3b99 d 19dd1be9
3b99 3b99 s 	dw 	0xDD19,_CPM1_res_READ
3b9d 3b9d s 	endm
3b9d 3b9d s 	dwpatch	0xDA2A+1	,0xDE4F	,_CPM1_res_WRITE
3b9d 3b9d d 51
3b9d 3b9d s 	db 	pW_CHK_PATCH
3b9e 3b9e d 2bda
3b9e 3b9e s 	dw 	0xDA2A+1
3ba0 3ba0 d 4fde58e9
3ba0 3ba0 s 	dw 	0xDE4F,_CPM1_res_WRITE
3ba4 3ba4 s 	endm
3ba4 3ba4 s 	dwpatch	0xDB6D+1	,0xDD19	,_CPM1_res_READ
3ba4 3ba4 d 51
3ba4 3ba4 s 	db 	pW_CHK_PATCH
3ba5 3ba5 d 6edb
3ba5 3ba5 s 	dw 	0xDB6D+1
3ba7 3ba7 d 19dd1be9
3ba7 3ba7 s 	dw 	0xDD19,_CPM1_res_READ
3bab 3bab s 	endm
3bab 3bab s 	dwpatch	0xDCE8+1	,0xE467	,_CPM1_res_GETINFO
3bab 3bab d 51
3bab 3bab s 	db 	pW_CHK_PATCH
3bac 3bac d e9dc
3bac 3bac s 	dw 	0xDCE8+1
3bae 3bae d 67e495e9
3bae 3bae s 	dw 	0xE467,_CPM1_res_GETINFO
3bb2 3bb2 s 	endm
3bb2 3bb2 s 	dwstore	_CPM1__old_read+1	,0xDD19
3bb2 3bb2 d 54
3bb2 3bb2 s 	db 	pW_STORE
3bb3 3bb3 d 19dd
3bb3 3bb3 s 	dw 	0xDD19
3bb5 3bb5 d 56e9
3bb5 3bb5 s 	dw 	_CPM1__old_read+1
3bb7 3bb7 s 	endm
3bb7 3bb7 s 	dwstore	_CPM1__old_write+1	,0xDE4F
3bb7 3bb7 d 54
3bb7 3bb7 s 	db 	pW_STORE
3bb8 3bb8 d 4fde
3bb8 3bb8 s 	dw 	0xDE4F
3bba 3bba d 93e9
3bba 3bba s 	dw 	_CPM1__old_write+1
3bbc 3bbc s 	endm
3bbc 3bbc s 	dwstore	_CPM1__old_getinfo+1	,0xE467
3bbc 3bbc d 54
3bbc 3bbc s 	db 	pW_STORE
3bbd 3bbd d 67e4
3bbd 3bbd s 	dw 	0xE467
3bbf 3bbf d a3e9
3bbf 3bbf s 	dw 	_CPM1__old_getinfo+1
3bc1 3bc1 s 	endm
3bc1 3bc1 s 	dbpatch	0xE4A7		,0x21	,0x21
3bc1 3bc1 d 52
3bc1 3bc1 s 	db 	pB_CHK_PATCH
3bc2 3bc2 d a7e4
3bc2 3bc2 s 	dw 	0xE4A7
3bc4 3bc4 d 2121
3bc4 3bc4 s 	db 	0x21,0x21
3bc6 3bc6 s 	endm
3bc6 3bc6 s 	dwpatch	0xE4A7+1 	,0xE4D7	,0xE4D7
3bc6 3bc6 d 51
3bc6 3bc6 s 	db 	pW_CHK_PATCH
3bc7 3bc7 d a8e4
3bc7 3bc7 s 	dw 	0xE4A7+1
3bc9 3bc9 d d7e4d7e4
3bc9 3bc9 s 	dw 	0xE4D7,0xE4D7
3bcd 3bcd s 	endm
3bcd 3bcd s 	dwstore	_CPM1__old_getinfo_chkdo+1	,0xE4A7
3bcd 3bcd d 54
3bcd 3bcd s 	db 	pW_STORE
3bce 3bce d a7e4
3bce 3bce s 	dw 	0xE4A7
3bd0 3bd0 d a0e9
3bd0 3bd0 s 	dw 	_CPM1__old_getinfo_chkdo+1
3bd2 3bd2 s 	endm
3bd2 3bd2 s 	dwstore	_CPM1_r_p_DSK1+1	,0xDFC3 	;read
3bd2 3bd2 d 54
3bd2 3bd2 s 	db 	pW_STORE
3bd3 3bd3 d c3df
3bd3 3bd3 s 	dw 	0xDFC3
3bd5 3bd5 d 1ce9
3bd5 3bd5 s 	dw 	_CPM1_r_p_DSK1+1
3bd7 3bd7 s 	endm
3bd7 3bd7 s 	dwstore	_CPM1_r_p_TRK1+1	,0xDFC7 	
3bd7 3bd7 d 54
3bd7 3bd7 s 	db 	pW_STORE
3bd8 3bd8 d c7df
3bd8 3bd8 s 	dw 	0xDFC7
3bda 3bda d 37e9
3bda 3bda s 	dw 	_CPM1_r_p_TRK1+1
3bdc 3bdc s 	endm
3bdc 3bdc s 	dwstore	_CPM1_r_p_SEC1+1	,0xDFC8 	
3bdc 3bdc d 54
3bdc 3bdc s 	db 	pW_STORE
3bdd 3bdd d c8df
3bdd 3bdd s 	dw 	0xDFC8
3bdf 3bdf d 3de9
3bdf 3bdf s 	dw 	_CPM1_r_p_SEC1+1
3be1 3be1 s 	endm
3be1 3be1 s 	dwstore	_CPM1_r_p_DMA1+1	,0xDFC9 	
3be1 3be1 d 54
3be1 3be1 s 	db 	pW_STORE
3be2 3be2 d c9df
3be2 3be2 s 	dw 	0xDFC9
3be4 3be4 d 4ee9
3be4 3be4 s 	dw 	_CPM1_r_p_DMA1+1
3be6 3be6 s 	endm
3be6 3be6 s 	dwstore	_CPM1_r_p_DSK2+1	,0xDFC3 	;write
3be6 3be6 d 54
3be6 3be6 s 	db 	pW_STORE
3be7 3be7 d c3df
3be7 3be7 s 	dw 	0xDFC3
3be9 3be9 d 59e9
3be9 3be9 s 	dw 	_CPM1_r_p_DSK2+1
3beb 3beb s 	endm
3beb 3beb s 	dwstore	_CPM1_r_p_TRK2+1	,0xDFC7 	
3beb 3beb d 54
3beb 3beb s 	db 	pW_STORE
3bec 3bec d c7df
3bec 3bec s 	dw 	0xDFC7
3bee 3bee d 74e9
3bee 3bee s 	dw 	_CPM1_r_p_TRK2+1
3bf0 3bf0 s 	endm
3bf0 3bf0 s 	dwstore	_CPM1_r_p_SEC2+1	,0xDFC8 	
3bf0 3bf0 d 54
3bf0 3bf0 s 	db 	pW_STORE
3bf1 3bf1 d c8df
3bf1 3bf1 s 	dw 	0xDFC8
3bf3 3bf3 d 7ae9
3bf3 3bf3 s 	dw 	_CPM1_r_p_SEC2+1
3bf5 3bf5 s 	endm
3bf5 3bf5 s 	dwstore	_CPM1_r_p_DMA2+1	,0xDFC9 	
3bf5 3bf5 d 54
3bf5 3bf5 s 	db 	pW_STORE
3bf6 3bf6 d c9df
3bf6 3bf6 s 	dw 	0xDFC9
3bf8 3bf8 d 8be9
3bf8 3bf8 s 	dw 	_CPM1_r_p_DMA2+1
3bfa 3bfa s 	endm
3bfa 3bfa s 	dwstore	_CPM1_r_p_DSK3+1	,0xDFC3 	;readinfo
3bfa 3bfa d 54
3bfa 3bfa s 	db 	pW_STORE
3bfb 3bfb d c3df
3bfb 3bfb s 	dw 	0xDFC3
3bfd 3bfd d 28ea
3bfd 3bfd s 	dw 	_CPM1_r_p_DSK3+1
3bff 3bff s 	endm
3bff 3bff s 
3bff 3bff s 	stop 'CPM_12_87_09_NIIJAF'
3bff 3bff d 50
3bff 3bff s 	db 	p_STOP
3c00 3c00 d 43504d5f31325f38375f30395f4e49494a4146
3c00 3c00 s 	db 	'CPM_12_87_09_NIIJAF'
3c13 3c13 d 00
3c13 3c13 s 	db 	0
3c14 3c14 s 	endm
3c14 3c14 f out/include-patcher.asm
3c14 3c14 s 	include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_871220.asm"	;  2 images in collection
3c14 3c14 f generator/V0/out/patcher-microdos-MICRODOS_OPTS1_871220.asm
3c14 3c14 s _BIOS_MICRODOS_OPTS1_871220:
3c14 3c14 s 	setMICRODOS
3c14 3c14 d 56
3c14 3c14 s 	db 	pSETFLAG_MICRODOS
3c15 3c15 s 	endm
3c15 3c15 s 	RQ_OPTS1
3c15 3c15 d 57
3c15 3c15 s 	db 	pREQUIRED_OPTS1
3c16 3c16 s 	endm
3c16 3c16 s 	dbpatchmaybe	0xBE4C	,0x1B	,0x0d
3c16 3c16 d 59
3c16 3c16 s 	db 	pB_MAYBE_PATCH
3c17 3c17 d 4cbe
3c17 3c17 s 	dw 	0xBE4C
3c19 3c19 d 1b0d
3c19 3c19 s 	db 	0x1B,0x0d
3c1b 3c1b s 	endm
3c1b 3c1b s 	dbpatchmaybe	0xBE4C+1	,0x45	,0x0d
3c1b 3c1b d 59
3c1b 3c1b s 	db 	pB_MAYBE_PATCH
3c1c 3c1c d 4dbe
3c1c 3c1c s 	dw 	0xBE4C+1
3c1e 3c1e d 450d
3c1e 3c1e s 	db 	0x45,0x0d
3c20 3c20 s 	endm
3c20 3c20 s 	dwpatch	0xE97F+1	,0xE9B6	,MD_READ			
3c20 3c20 d 51
3c20 3c20 s 	db 	pW_CHK_PATCH
3c21 3c21 d 80e9
3c21 3c21 s 	dw 	0xE97F+1
3c23 3c23 d b6e93efa
3c23 3c23 s 	dw 	0xE9B6,MD_READ
3c27 3c27 s 	endm
3c27 3c27 s 	dwpatch	0xE984+1	,0xEA20	,MD_WRITE
3c27 3c27 d 51
3c27 3c27 s 	db 	pW_CHK_PATCH
3c28 3c28 d 85e9
3c28 3c28 s 	dw 	0xE984+1
3c2a 3c2a d 20ea53fa
3c2a 3c2a s 	dw 	0xEA20,MD_WRITE
3c2e 3c2e s 	endm
3c2e 3c2e s 	dbpatch	0xEB13	,0xcd	,0x00
3c2e 3c2e d 52
3c2e 3c2e s 	db 	pB_CHK_PATCH
3c2f 3c2f d 13eb
3c2f 3c2f s 	dw 	0xEB13
3c31 3c31 d cd00
3c31 3c31 s 	db 	0xcd,0x00
3c33 3c33 s 	endm
3c33 3c33 s 	dwpatch	0xEB13+1	,0xECA9	,0x0000
3c33 3c33 d 51
3c33 3c33 s 	db 	pW_CHK_PATCH
3c34 3c34 d 14eb
3c34 3c34 s 	dw 	0xEB13+1
3c36 3c36 d a9ec0000
3c36 3c36 s 	dw 	0xECA9,0x0000
3c3a 3c3a s 	endm
3c3a 3c3a s 	dwpatch	0xEB16+1	,0xECAE	,MD_READ_INFOSECTOR
3c3a 3c3a d 51
3c3a 3c3a s 	db 	pW_CHK_PATCH
3c3b 3c3b d 17eb
3c3b 3c3b s 	dw 	0xEB16+1
3c3d 3c3d d aeec68fa
3c3d 3c3d s 	dw 	0xECAE,MD_READ_INFOSECTOR
3c41 3c41 s 	endm
3c41 3c41 s 	dwstore	MD_DRV2+1,	0xEDA4
3c41 3c41 d 54
3c41 3c41 s 	db 	pW_STORE
3c42 3c42 d a4ed
3c42 3c42 s 	dw 	0xEDA4
3c44 3c44 d f3fa
3c44 3c44 s 	dw 	MD_DRV2+1
3c46 3c46 s 	endm
3c46 3c46 s 	dwstore	MD_RDBUF2+1,	0xEDAC
3c46 3c46 d 54
3c46 3c46 s 	db 	pW_STORE
3c47 3c47 d aced
3c47 3c47 s 	dw 	0xEDAC
3c49 3c49 d 02fb
3c49 3c49 s 	dw 	MD_RDBUF2+1
3c4b 3c4b s 	endm
3c4b 3c4b s 	dwstore	MD_PARAM2+1,	0xED97
3c4b 3c4b d 54
3c4b 3c4b s 	db 	pW_STORE
3c4c 3c4c d 97ed
3c4c 3c4c s 	dw 	0xED97
3c4e 3c4e d 1dfa
3c4e 3c4e s 	dw 	MD_PARAM2+1
3c50 3c50 s 	endm
3c50 3c50 s 	dwpatch 0xc01b+1	 ,0xDDB1	,md_res_seldsk
3c50 3c50 d 51
3c50 3c50 s 	db 	pW_CHK_PATCH
3c51 3c51 d 1cc0
3c51 3c51 s 	dw 	0xc01b+1
3c53 3c53 d b1dd0efa
3c53 3c53 s 	dw 	0xDDB1,md_res_seldsk
3c57 3c57 s 	endm
3c57 3c57 s 	dwstore md_old_seld_dsk+1,0xDDB1	,0xdd4c
3c57 3c57 d 54
3c57 3c57 s 	db 	pW_STORE
3c58 3c58 d b1dd
3c58 3c58 s 	dw 	0xDDB1
3c5a 3c5a d 12fa
3c5a 3c5a s 	dw 	md_old_seld_dsk+1
3c5c 3c5c s 	endm
3c5c 3c5c s 	;custom checkers
3c5c 3c5c s 	dwpatch	0xBD80	,0xBD80 ,0xBD80
3c5c 3c5c d 51
3c5c 3c5c s 	db 	pW_CHK_PATCH
3c5d 3c5d d 80bd
3c5d 3c5d s 	dw 	0xBD80
3c5f 3c5f d 80bd80bd
3c5f 3c5f s 	dw 	0xBD80,0xBD80
3c63 3c63 s 	endm
3c63 3c63 s 	dwpatch	0xBD82	,0xBE00 ,0xBE00
3c63 3c63 d 51
3c63 3c63 s 	db 	pW_CHK_PATCH
3c64 3c64 d 82bd
3c64 3c64 s 	dw 	0xBD82
3c66 3c66 d 00be00be
3c66 3c66 s 	dw 	0xBE00,0xBE00
3c6a 3c6a s 	endm
3c6a 3c6a s 	dwpatch	0xc000+1	,0xC495 ,0xC495
3c6a 3c6a d 51
3c6a 3c6a s 	db 	pW_CHK_PATCH
3c6b 3c6b d 01c0
3c6b 3c6b s 	dw 	0xc000+1
3c6d 3c6d d 95c495c4
3c6d 3c6d s 	dw 	0xC495,0xC495
3c71 3c71 s 	endm
3c71 3c71 s 	dwpatch	0xc003+1	,0xDC25 ,0xDC25
3c71 3c71 d 51
3c71 3c71 s 	db 	pW_CHK_PATCH
3c72 3c72 d 04c0
3c72 3c72 s 	dw 	0xc003+1
3c74 3c74 d 25dc25dc
3c74 3c74 s 	dw 	0xDC25,0xDC25
3c78 3c78 s 	endm
3c78 3c78 s 	dbpatch	0xEACE	,0x21 ,0x21
3c78 3c78 d 52
3c78 3c78 s 	db 	pB_CHK_PATCH
3c79 3c79 d ceea
3c79 3c79 s 	dw 	0xEACE
3c7b 3c7b d 2121
3c7b 3c7b s 	db 	0x21,0x21
3c7d 3c7d s 	endm
3c7d 3c7d s 	stop 'MICRODOS_OPTS1_871220'
3c7d 3c7d d 50
3c7d 3c7d s 	db 	p_STOP
3c7e 3c7e d 4d4943524f444f535f4f505453315f383731323230
3c7e 3c7e s 	db 	'MICRODOS_OPTS1_871220'
3c93 3c93 d 00
3c93 3c93 s 	db 	0
3c94 3c94 s 	endm
3c94 3c94 f out/include-patcher.asm
3c94 3c94 s 	include "generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861115.asm"	;  2 images in collection
3c94 3c94 f generator/V0/out/patcher-microdos-MICRODOS_OPTS1_861115.asm
3c94 3c94 s _BIOS_MICRODOS_OPTS1_861115:
3c94 3c94 s 	setMICRODOS
3c94 3c94 d 56
3c94 3c94 s 	db 	pSETFLAG_MICRODOS
3c95 3c95 s 	endm
3c95 3c95 s 	RQ_OPTS1
3c95 3c95 d 57
3c95 3c95 s 	db 	pREQUIRED_OPTS1
3c96 3c96 s 	endm
3c96 3c96 s 	dbpatchmaybe	0xE693	,0x1B	,0x0d
3c96 3c96 d 59
3c96 3c96 s 	db 	pB_MAYBE_PATCH
3c97 3c97 d 93e6
3c97 3c97 s 	dw 	0xE693
3c99 3c99 d 1b0d
3c99 3c99 s 	db 	0x1B,0x0d
3c9b 3c9b s 	endm
3c9b 3c9b s 	dbpatchmaybe	0xE693+1	,0x45	,0x0d
3c9b 3c9b d 59
3c9b 3c9b s 	db 	pB_MAYBE_PATCH
3c9c 3c9c d 94e6
3c9c 3c9c s 	dw 	0xE693+1
3c9e 3c9e d 450d
3c9e 3c9e s 	db 	0x45,0x0d
3ca0 3ca0 s 	endm
3ca0 3ca0 s 	dwpatch	0xE497+1	,0xE627	,MD_READ			
3ca0 3ca0 d 51
3ca0 3ca0 s 	db 	pW_CHK_PATCH
3ca1 3ca1 d 98e4
3ca1 3ca1 s 	dw 	0xE497+1
3ca3 3ca3 d 27e63efa
3ca3 3ca3 s 	dw 	0xE627,MD_READ
3ca7 3ca7 s 	endm
3ca7 3ca7 s 	dwpatch	0xE4A0+1	,0xE62A	,MD_WRITE
3ca7 3ca7 d 51
3ca7 3ca7 s 	db 	pW_CHK_PATCH
3ca8 3ca8 d a1e4
3ca8 3ca8 s 	dw 	0xE4A0+1
3caa 3caa d 2ae653fa
3caa 3caa s 	dw 	0xE62A,MD_WRITE
3cae 3cae s 	endm
3cae 3cae s 	dbpatch	0xEAAE	,0xcd	,0x00
3cae 3cae d 52
3cae 3cae s 	db 	pB_CHK_PATCH
3caf 3caf d aeea
3caf 3caf s 	dw 	0xEAAE
3cb1 3cb1 d cd00
3cb1 3cb1 s 	db 	0xcd,0x00
3cb3 3cb3 s 	endm
3cb3 3cb3 s 	dwpatch	0xEAAE+1	,0xE9E9	,0x0000
3cb3 3cb3 d 51
3cb3 3cb3 s 	db 	pW_CHK_PATCH
3cb4 3cb4 d afea
3cb4 3cb4 s 	dw 	0xEAAE+1
3cb6 3cb6 d e9e90000
3cb6 3cb6 s 	dw 	0xE9E9,0x0000
3cba 3cba s 	endm
3cba 3cba s 	dwpatch	0xEAB4+1	,0xEC5D	,MD_READ_INFOSECTOR
3cba 3cba d 51
3cba 3cba s 	db 	pW_CHK_PATCH
3cbb 3cbb d b5ea
3cbb 3cbb s 	dw 	0xEAB4+1
3cbd 3cbd d 5dec68fa
3cbd 3cbd s 	dw 	0xEC5D,MD_READ_INFOSECTOR
3cc1 3cc1 s 	endm
3cc1 3cc1 s 	dwstore	MD_DRV2+1,	0xDFC8
3cc1 3cc1 d 54
3cc1 3cc1 s 	db 	pW_STORE
3cc2 3cc2 d c8df
3cc2 3cc2 s 	dw 	0xDFC8
3cc4 3cc4 d f3fa
3cc4 3cc4 s 	dw 	MD_DRV2+1
3cc6 3cc6 s 	endm
3cc6 3cc6 s 	dwstore	MD_RDBUF2+1,	0xEEB0
3cc6 3cc6 d 54
3cc6 3cc6 s 	db 	pW_STORE
3cc7 3cc7 d b0ee
3cc7 3cc7 s 	dw 	0xEEB0
3cc9 3cc9 d 02fb
3cc9 3cc9 s 	dw 	MD_RDBUF2+1
3ccb 3ccb s 	endm
3ccb 3ccb s 	dwstore	MD_PARAM2+1,	0xDDBC
3ccb 3ccb d 54
3ccb 3ccb s 	db 	pW_STORE
3ccc 3ccc d bcdd
3ccc 3ccc s 	dw 	0xDDBC
3cce 3cce d 1dfa
3cce 3cce s 	dw 	MD_PARAM2+1
3cd0 3cd0 s 	endm
3cd0 3cd0 s 	dwpatch 0xc01b+1	 ,0xDD86	,md_res_seldsk
3cd0 3cd0 d 51
3cd0 3cd0 s 	db 	pW_CHK_PATCH
3cd1 3cd1 d 1cc0
3cd1 3cd1 s 	dw 	0xc01b+1
3cd3 3cd3 d 86dd0efa
3cd3 3cd3 s 	dw 	0xDD86,md_res_seldsk
3cd7 3cd7 s 	endm
3cd7 3cd7 s 	dwstore md_old_seld_dsk+1,0xDD86	,0xdd4c
3cd7 3cd7 d 54
3cd7 3cd7 s 	db 	pW_STORE
3cd8 3cd8 d 86dd
3cd8 3cd8 s 	dw 	0xDD86
3cda 3cda d 12fa
3cda 3cda s 	dw 	md_old_seld_dsk+1
3cdc 3cdc s 	endm
3cdc 3cdc s 	;custom checkers
3cdc 3cdc s 	dwpatch	0xBC80	,0xBC80 ,0xBC80
3cdc 3cdc d 51
3cdc 3cdc s 	db 	pW_CHK_PATCH
3cdd 3cdd d 80bc
3cdd 3cdd s 	dw 	0xBC80
3cdf 3cdf d 80bc80bc
3cdf 3cdf s 	dw 	0xBC80,0xBC80
3ce3 3ce3 s 	endm
3ce3 3ce3 s 	dwpatch	0xBC82	,0xBD00 ,0xBD00
3ce3 3ce3 d 51
3ce3 3ce3 s 	db 	pW_CHK_PATCH
3ce4 3ce4 d 82bc
3ce4 3ce4 s 	dw 	0xBC82
3ce6 3ce6 d 00bd00bd
3ce6 3ce6 s 	dw 	0xBD00,0xBD00
3cea 3cea s 	endm
3cea 3cea s 	dwpatch	0xc000+1	,0xC4BF ,0xC4BF
3cea 3cea d 51
3cea 3cea s 	db 	pW_CHK_PATCH
3ceb 3ceb d 01c0
3ceb 3ceb s 	dw 	0xc000+1
3ced 3ced d bfc4bfc4
3ced 3ced s 	dw 	0xC4BF,0xC4BF
3cf1 3cf1 s 	endm
3cf1 3cf1 s 	dwpatch	0xc003+1	,0xDBFB ,0xDBFB
3cf1 3cf1 d 51
3cf1 3cf1 s 	db 	pW_CHK_PATCH
3cf2 3cf2 d 04c0
3cf2 3cf2 s 	dw 	0xc003+1
3cf4 3cf4 d fbdbfbdb
3cf4 3cf4 s 	dw 	0xDBFB,0xDBFB
3cf8 3cf8 s 	endm
3cf8 3cf8 s 	dbpatch	0xDF95	,0x40 ,0x40
3cf8 3cf8 d 52
3cf8 3cf8 s 	db 	pB_CHK_PATCH
3cf9 3cf9 d 95df
3cf9 3cf9 s 	dw 	0xDF95
3cfb 3cfb d 4040
3cfb 3cfb s 	db 	0x40,0x40
3cfd 3cfd s 	endm
3cfd 3cfd s 	dbpatch	0xDF97	,0x10 ,0x10
3cfd 3cfd d 52
3cfd 3cfd s 	db 	pB_CHK_PATCH
3cfe 3cfe d 97df
3cfe 3cfe s 	dw 	0xDF97
3d00 3d00 d 1010
3d00 3d00 s 	db 	0x10,0x10
3d02 3d02 s 	endm
3d02 3d02 s 	stop 'MICRODOS_OPTS1_861115'
3d02 3d02 d 50
3d02 3d02 s 	db 	p_STOP
3d03 3d03 d 4d4943524f444f535f4f505453315f383631313135
3d03 3d03 s 	db 	'MICRODOS_OPTS1_861115'
3d18 3d18 d 00
3d18 3d18 s 	db 	0
3d19 3d19 s 	endm
3d19 3d19 f out/include-patcher.asm
3d19 3d19 s 	include "generator/V0/out/patcher-unsopported-CPM_NET_SFERA1.asm"	;  2 images in collection
3d19 3d19 f generator/V0/out/patcher-unsopported-CPM_NET_SFERA1.asm
3d19 3d19 s _BIOS_CPM_NET_SFERA1:
3d19 3d19 s 	setUNSUPPORTED
3d19 3d19 d 55
3d19 3d19 s 	db 	pNotSupported
3d1a 3d1a s 	endm
3d1a 3d1a s 	;custom checkers
3d1a 3d1a s 	dwpatch	0xC380  	,0xC380  ,0xC380 
3d1a 3d1a d 51
3d1a 3d1a s 	db 	pW_CHK_PATCH
3d1b 3d1b d 80c3
3d1b 3d1b s 	dw 	0xC380
3d1d 3d1d d 80c380c3
3d1d 3d1d s 	dw 	0xC380,0xC380
3d21 3d21 s 	endm
3d21 3d21 s 	dwpatch	0xC382  	,0xDa00 ,0xDa00
3d21 3d21 d 51
3d21 3d21 s 	db 	pW_CHK_PATCH
3d22 3d22 d 82c3
3d22 3d22 s 	dw 	0xC382
3d24 3d24 d 00da00da
3d24 3d24 s 	dw 	0xDa00,0xDa00
3d28 3d28 s 	endm
3d28 3d28 s 	dwpatch	0xC384  	,0x000A ,0x000A
3d28 3d28 d 51
3d28 3d28 s 	db 	pW_CHK_PATCH
3d29 3d29 d 84c3
3d29 3d29 s 	dw 	0xC384
3d2b 3d2b d 0a000a00
3d2b 3d2b s 	dw 	0x000A,0x000A
3d2f 3d2f s 	endm
3d2f 3d2f s 	dwpatch	0xDB5C+1	,0xDAC3 ,0xDAC3
3d2f 3d2f d 51
3d2f 3d2f s 	db 	pW_CHK_PATCH
3d30 3d30 d 5ddb
3d30 3d30 s 	dw 	0xDB5C+1
3d32 3d32 d c3dac3da
3d32 3d32 s 	dw 	0xDAC3,0xDAC3
3d36 3d36 s 	endm
3d36 3d36 s 	dwpatch	0xDA03+1	,0xDB6E ,0xDB6E
3d36 3d36 d 51
3d36 3d36 s 	db 	pW_CHK_PATCH
3d37 3d37 d 04da
3d37 3d37 s 	dw 	0xDA03+1
3d39 3d39 d 6edb6edb
3d39 3d39 s 	dw 	0xDB6E,0xDB6E
3d3d 3d3d s 	endm
3d3d 3d3d s 	dwpatch	0xDA27+1	,0xDED4 ,0xDED4
3d3d 3d3d d 51
3d3d 3d3d s 	db 	pW_CHK_PATCH
3d3e 3d3e d 28da
3d3e 3d3e s 	dw 	0xDA27+1
3d40 3d40 d d4ded4de
3d40 3d40 s 	dw 	0xDED4,0xDED4
3d44 3d44 s 	endm
3d44 3d44 s 	dwpatch	0xDA2A+1	,0xE193 ,0xE193
3d44 3d44 d 51
3d44 3d44 s 	db 	pW_CHK_PATCH
3d45 3d45 d 2bda
3d45 3d45 s 	dw 	0xDA2A+1
3d47 3d47 d 93e193e1
3d47 3d47 s 	dw 	0xE193,0xE193
3d4b 3d4b s 	endm
3d4b 3d4b s 	dwpatch	0xDA3C+1	,0xDD06 ,0xDD06
3d4b 3d4b d 51
3d4b 3d4b s 	db 	pW_CHK_PATCH
3d4c 3d4c d 3dda
3d4c 3d4c s 	dw 	0xDA3C+1
3d4e 3d4e d 06dd06dd
3d4e 3d4e s 	dw 	0xDD06,0xDD06
3d52 3d52 s 	endm
3d52 3d52 s 	stop 'CPM_NET_SFERA1'
3d52 3d52 d 50
3d52 3d52 s 	db 	p_STOP
3d53 3d53 d 43504d5f4e45545f534645524131
3d53 3d53 s 	db 	'CPM_NET_SFERA1'
3d61 3d61 d 00
3d61 3d61 s 	db 	0
3d62 3d62 s 	endm
3d62 3d62 f out/include-patcher.asm
3d62 3d62 s 	include "generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_b.asm"	;  2 images in collection
3d62 3d62 f generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_b.asm
3d62 3d62 s _BIOS_CPM_NET_KORNET_drive_b:
3d62 3d62 s 	setUNSUPPORTED
3d62 3d62 d 55
3d62 3d62 s 	db 	pNotSupported
3d63 3d63 s 	endm
3d63 3d63 s 	;custom checkers
3d63 3d63 s 	dwpatch	0x8000  	,0x00EE  ,0x00EE 
3d63 3d63 d 51
3d63 3d63 s 	db 	pW_CHK_PATCH
3d64 3d64 d 0080
3d64 3d64 s 	dw 	0x8000
3d66 3d66 d ee00ee00
3d66 3d66 s 	dw 	0x00EE,0x00EE
3d6a 3d6a s 	endm
3d6a 3d6a s 	dwpatch	0x8000+2	,0x0000 ,0x0000
3d6a 3d6a d 51
3d6a 3d6a s 	db 	pW_CHK_PATCH
3d6b 3d6b d 0280
3d6b 3d6b s 	dw 	0x8000+2
3d6d 3d6d d 00000000
3d6d 3d6d s 	dw 	0x0000,0x0000
3d71 3d71 s 	endm
3d71 3d71 s 	dwpatch	0x8000+4	,0x000E ,0x000E
3d71 3d71 d 51
3d71 3d71 s 	db 	pW_CHK_PATCH
3d72 3d72 d 0480
3d72 3d72 s 	dw 	0x8000+4
3d74 3d74 d 0e000e00
3d74 3d74 s 	dw 	0x000E,0x000E
3d78 3d78 s 	endm
3d78 3d78 s 	stop 'CPM_NET_KORNET_drive_b'
3d78 3d78 d 50
3d78 3d78 s 	db 	p_STOP
3d79 3d79 d 43504d5f4e45545f4b4f524e45545f64726976655f62
3d79 3d79 s 	db 	'CPM_NET_KORNET_drive_b'
3d8f 3d8f d 00
3d8f 3d8f s 	db 	0
3d90 3d90 s 	endm
3d90 3d90 f out/include-patcher.asm
3d90 3d90 s 	include "generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_a.asm"	;  2 images in collection
3d90 3d90 f generator/V0/out/patcher-unsopported-CPM_NET_KORNET_drive_a.asm
3d90 3d90 s _BIOS_CPM_NET_KORNET_drive_a:
3d90 3d90 s 	setUNSUPPORTED
3d90 3d90 d 55
3d90 3d90 s 	db 	pNotSupported
3d91 3d91 s 	endm
3d91 3d91 s 	;custom checkers
3d91 3d91 s 	dwpatch	0xDB59+1	,0xDAAA ,0xDAAA
3d91 3d91 d 51
3d91 3d91 s 	db 	pW_CHK_PATCH
3d92 3d92 d 5adb
3d92 3d92 s 	dw 	0xDB59+1
3d94 3d94 d aadaaada
3d94 3d94 s 	dw 	0xDAAA,0xDAAA
3d98 3d98 s 	endm
3d98 3d98 s 	dwpatch	0xD980	,0xD980 ,0xD980
3d98 3d98 d 51
3d98 3d98 s 	db 	pW_CHK_PATCH
3d99 3d99 d 80d9
3d99 3d99 s 	dw 	0xD980
3d9b 3d9b d 80d980d9
3d9b 3d9b s 	dw 	0xD980,0xD980
3d9f 3d9f s 	endm
3d9f 3d9f s 	dwpatch	0xD982	,0xDa00 ,0xDa00
3d9f 3d9f d 51
3d9f 3d9f s 	db 	pW_CHK_PATCH
3da0 3da0 d 82d9
3da0 3da0 s 	dw 	0xD982
3da2 3da2 d 00da00da
3da2 3da2 s 	dw 	0xDa00,0xDa00
3da6 3da6 s 	endm
3da6 3da6 s 	dwpatch	0xD984	,0x0006 ,0x0006
3da6 3da6 d 51
3da6 3da6 s 	db 	pW_CHK_PATCH
3da7 3da7 d 84d9
3da7 3da7 s 	dw 	0xD984
3da9 3da9 d 06000600
3da9 3da9 s 	dw 	0x0006,0x0006
3dad 3dad s 	endm
3dad 3dad s 	dwpatch	0xDA03+1	,0xDBA1 ,0xDBA1
3dad 3dad d 51
3dad 3dad s 	db 	pW_CHK_PATCH
3dae 3dae d 04da
3dae 3dae s 	dw 	0xDA03+1
3db0 3db0 d a1dba1db
3db0 3db0 s 	dw 	0xDBA1,0xDBA1
3db4 3db4 s 	endm
3db4 3db4 s 	dwpatch	0xDA27+1	,0xDEB0 ,0xDEB0
3db4 3db4 d 51
3db4 3db4 s 	db 	pW_CHK_PATCH
3db5 3db5 d 28da
3db5 3db5 s 	dw 	0xDA27+1
3db7 3db7 d b0deb0de
3db7 3db7 s 	dw 	0xDEB0,0xDEB0
3dbb 3dbb s 	endm
3dbb 3dbb s 	dwpatch	0xDA2A+1	,0xE19A ,0xE19A
3dbb 3dbb d 51
3dbb 3dbb s 	db 	pW_CHK_PATCH
3dbc 3dbc d 2bda
3dbc 3dbc s 	dw 	0xDA2A+1
3dbe 3dbe d 9ae19ae1
3dbe 3dbe s 	dw 	0xE19A,0xE19A
3dc2 3dc2 s 	endm
3dc2 3dc2 s 	dwpatch	0xDA33+1	,0xDFC8 ,0xDFC8
3dc2 3dc2 d 51
3dc2 3dc2 s 	db 	pW_CHK_PATCH
3dc3 3dc3 d 34da
3dc3 3dc3 s 	dw 	0xDA33+1
3dc5 3dc5 d c8dfc8df
3dc5 3dc5 s 	dw 	0xDFC8,0xDFC8
3dc9 3dc9 s 	endm
3dc9 3dc9 s 	stop 'CPM_NET_KORNET_drive_a'
3dc9 3dc9 d 50
3dc9 3dc9 s 	db 	p_STOP
3dca 3dca d 43504d5f4e45545f4b4f524e45545f64726976655f61
3dca 3dca s 	db 	'CPM_NET_KORNET_drive_a'
3de0 3de0 d 00
3de0 3de0 s 	db 	0
3de1 3de1 s 	endm
3de1 3de1 f out/include-patcher.asm
3de1 3de1 s 	include "generator/V0/out/patcher-cpm2-CPM_1x_88_EPSON_V104.asm"	;  1 images in collection
3de1 3de1 f generator/V0/out/patcher-cpm2-CPM_1x_88_EPSON_V104.asm
3de1 3de1 s _BIOS_CPM_1x_88_EPSON_V104:
3de1 3de1 s 	setSUBBIOS 2
3de1 3de1 d 5a
3de1 3de1 s 	db	pSubBios
3de2 3de2 d 02
3de2 3de2 s 	db 	2
3de3 3de3 s 	endm
3de3 3de3 s 	RQ_OPTS1
3de3 3de3 d 57
3de3 3de3 s 	db 	pREQUIRED_OPTS1
3de4 3de4 s 	endm
3de4 3de4 s 	setCPM
3de4 3de4 s 	endm
3de4 3de4 s 	dbpatchmaybe	0xDAEE	,0x1F	,0x0d
3de4 3de4 d 59
3de4 3de4 s 	db 	pB_MAYBE_PATCH
3de5 3de5 d eeda
3de5 3de5 s 	dw 	0xDAEE
3de7 3de7 d 1f0d
3de7 3de7 s 	db 	0x1F,0x0d
3de9 3de9 s 	endm
3de9 3de9 s 	dbpatchmaybe	0xDAEE+2	,0x0a	,0x0d
3de9 3de9 d 59
3de9 3de9 s 	db 	pB_MAYBE_PATCH
3dea 3dea d f0da
3dea 3dea s 	dw 	0xDAEE+2
3dec 3dec d 0a0d
3dec 3dec s 	db 	0x0a,0x0d
3dee 3dee s 	endm
3dee 3dee s 	dbpatch	0xE8B7+1	,0x49	,0xc9
3dee 3dee d 52
3dee 3dee s 	db 	pB_CHK_PATCH
3def 3def d b8e8
3def 3def s 	dw 	0xE8B7+1
3df1 3df1 d 49c9
3df1 3df1 s 	db 	0x49,0xc9
3df3 3df3 s 	endm
3df3 3df3 s 	dbpatch	0xDA88 	,0x01	,0x00
3df3 3df3 d 52
3df3 3df3 s 	db 	pB_CHK_PATCH
3df4 3df4 d 88da
3df4 3df4 s 	dw 	0xDA88
3df6 3df6 d 0100
3df6 3df6 s 	db 	0x01,0x00
3df8 3df8 s 	endm
3df8 3df8 s 	dbpatch	0xDA9F 	,0x02	,0x00
3df8 3df8 d 52
3df8 3df8 s 	db 	pB_CHK_PATCH
3df9 3df9 d 9fda
3df9 3df9 s 	dw 	0xDA9F
3dfb 3dfb d 0200
3dfb 3dfb s 	db 	0x02,0x00
3dfd 3dfd s 	endm
3dfd 3dfd s 	dbpatch	0xDAB6 	,0x04	,0x01
3dfd 3dfd d 52
3dfd 3dfd s 	db 	pB_CHK_PATCH
3dfe 3dfe d b6da
3dfe 3dfe s 	dw 	0xDAB6
3e00 3e00 d 0401
3e00 3e00 s 	db 	0x04,0x01
3e02 3e02 s 	endm
3e02 3e02 s 	dbpatch	0xDACD 	,0x08	,0x02
3e02 3e02 d 52
3e02 3e02 s 	db 	pB_CHK_PATCH
3e03 3e03 d cdda
3e03 3e03 s 	dw 	0xDACD
3e05 3e05 d 0802
3e05 3e05 s 	db 	0x08,0x02
3e07 3e07 s 	endm
3e07 3e07 s 	dwstore	_CPM2_res_DRIVE_TAB+0*2	,0xDA88
3e07 3e07 d 54
3e07 3e07 s 	db 	pW_STORE
3e08 3e08 d 88da
3e08 3e08 s 	dw 	0xDA88
3e0a 3e0a d 06ea
3e0a 3e0a s 	dw 	_CPM2_res_DRIVE_TAB+0*2
3e0c 3e0c s 	endm
3e0c 3e0c s 	dwstore	_CPM2_res_DRIVE_TAB+1*2	,0xDA9F
3e0c 3e0c d 54
3e0c 3e0c s 	db 	pW_STORE
3e0d 3e0d d 9fda
3e0d 3e0d s 	dw 	0xDA9F
3e0f 3e0f d 08ea
3e0f 3e0f s 	dw 	_CPM2_res_DRIVE_TAB+1*2
3e11 3e11 s 	endm
3e11 3e11 s 	dwstore	_CPM2_res_DRIVE_TAB+2*2	,0xDAB6
3e11 3e11 d 54
3e11 3e11 s 	db 	pW_STORE
3e12 3e12 d b6da
3e12 3e12 s 	dw 	0xDAB6
3e14 3e14 d 0aea
3e14 3e14 s 	dw 	_CPM2_res_DRIVE_TAB+2*2
3e16 3e16 s 	endm
3e16 3e16 s 	dwstore	_CPM2_res_DRIVE_TAB+3*2	,0xDACD
3e16 3e16 d 54
3e16 3e16 s 	db 	pW_STORE
3e17 3e17 d cdda
3e17 3e17 s 	dw 	0xDACD
3e19 3e19 d 0cea
3e19 3e19 s 	dw 	_CPM2_res_DRIVE_TAB+3*2
3e1b 3e1b s 	endm
3e1b 3e1b s 	dwpatch 0xDEC6+5*2 	,0x0000 ,_CPM2_dph_F
3e1b 3e1b d 51
3e1b 3e1b s 	db 	pW_CHK_PATCH
3e1c 3e1c d d0de
3e1c 3e1c s 	dw 	0xDEC6+5*2
3e1e 3e1e d 000012ea
3e1e 3e1e s 	dw 	0x0000,_CPM2_dph_F
3e22 3e22 s 	endm
3e22 3e22 s 	dwstore _CPM2_dph_F+8	,0xE1AB
3e22 3e22 d 54
3e22 3e22 s 	db 	pW_STORE
3e23 3e23 d abe1
3e23 3e23 s 	dw 	0xE1AB
3e25 3e25 d 1aea
3e25 3e25 s 	dw 	_CPM2_dph_F+8
3e27 3e27 s 	endm
3e27 3e27 s 	dwpatch 0xDA1B+1 	,0xDE82	,_CPM2_res_seldsk
3e27 3e27 d 51
3e27 3e27 s 	db 	pW_CHK_PATCH
3e28 3e28 d 1cda
3e28 3e28 s 	dw 	0xDA1B+1
3e2a 3e2a d 82de6bea
3e2a 3e2a s 	dw 	0xDE82,_CPM2_res_seldsk
3e2e 3e2e s 	endm
3e2e 3e2e s 	dwstore	_CPM2_old_seld_dsk+1	,0xDE82
3e2e 3e2e d 54
3e2e 3e2e s 	db 	pW_STORE
3e2f 3e2f d 82de
3e2f 3e2f s 	dw 	0xDE82
3e31 3e31 d 6fea
3e31 3e31 s 	dw 	_CPM2_old_seld_dsk+1
3e33 3e33 s 	endm
3e33 3e33 s 	dbpatch	0xE6DE	,0x77	,0x00
3e33 3e33 d 52
3e33 3e33 s 	db 	pB_CHK_PATCH
3e34 3e34 d dee6
3e34 3e34 s 	dw 	0xE6DE
3e36 3e36 d 7700
3e36 3e36 s 	db 	0x77,0x00
3e38 3e38 s 	endm
3e38 3e38 s 	dwstore	_CPM2_r_p_SELDSKDRIVER+1	,0xE199
3e38 3e38 d 54
3e38 3e38 s 	db 	pW_STORE
3e39 3e39 d 99e1
3e39 3e39 s 	dw 	0xE199
3e3b 3e3b d 88ea
3e3b 3e3b s 	dw 	_CPM2_r_p_SELDSKDRIVER+1
3e3d 3e3d s 	endm
3e3d 3e3d s 	dwstore	_CPM2_r_p_SELDSKDRIVEW+1	,0xE199
3e3d 3e3d d 54
3e3d 3e3d s 	db 	pW_STORE
3e3e 3e3e d 99e1
3e3e 3e3e s 	dw 	0xE199
3e40 3e40 d c5ea
3e40 3e40 s 	dw 	_CPM2_r_p_SELDSKDRIVEW+1
3e42 3e42 s 	endm
3e42 3e42 s 	dwpatch	0xDA27+1	,0xDEE5	,_CPM2_res_READ
3e42 3e42 d 51
3e42 3e42 s 	db 	pW_CHK_PATCH
3e43 3e43 d 28da
3e43 3e43 s 	dw 	0xDA27+1
3e45 3e45 d e5de75ea
3e45 3e45 s 	dw 	0xDEE5,_CPM2_res_READ
3e49 3e49 s 	endm
3e49 3e49 s 	dwpatch	0xDA2A+1	,0xE01B	,_CPM2_res_WRITE
3e49 3e49 d 51
3e49 3e49 s 	db 	pW_CHK_PATCH
3e4a 3e4a d 2bda
3e4a 3e4a s 	dw 	0xDA2A+1
3e4c 3e4c d 1be0b2ea
3e4c 3e4c s 	dw 	0xE01B,_CPM2_res_WRITE
3e50 3e50 s 	endm
3e50 3e50 s 	dwpatch	0xDBC2+1	,0xDEE5	,_CPM2_res_READ
3e50 3e50 d 51
3e50 3e50 s 	db 	pW_CHK_PATCH
3e51 3e51 d c3db
3e51 3e51 s 	dw 	0xDBC2+1
3e53 3e53 d e5de75ea
3e53 3e53 s 	dw 	0xDEE5,_CPM2_res_READ
3e57 3e57 s 	endm
3e57 3e57 s 	dwpatch	0xdeb4+1	,0xE614	,_CPM2_res_GETINFO
3e57 3e57 d 51
3e57 3e57 s 	db 	pW_CHK_PATCH
3e58 3e58 d b5de
3e58 3e58 s 	dw 	0xdeb4+1
3e5a 3e5a d 14e6efea
3e5a 3e5a s 	dw 	0xE614,_CPM2_res_GETINFO
3e5e 3e5e s 	endm
3e5e 3e5e s 	dwstore	_CPM2__old_read+1	,0xDEE5
3e5e 3e5e d 54
3e5e 3e5e s 	db 	pW_STORE
3e5f 3e5f d e5de
3e5f 3e5f s 	dw 	0xDEE5
3e61 3e61 d b0ea
3e61 3e61 s 	dw 	_CPM2__old_read+1
3e63 3e63 s 	endm
3e63 3e63 s 	dwstore	_CPM2__old_write+1	,0xE01B
3e63 3e63 d 54
3e63 3e63 s 	db 	pW_STORE
3e64 3e64 d 1be0
3e64 3e64 s 	dw 	0xE01B
3e66 3e66 d edea
3e66 3e66 s 	dw 	_CPM2__old_write+1
3e68 3e68 s 	endm
3e68 3e68 s 	dwstore	_CPM2__old_getinfo+1	,0xE614
3e68 3e68 d 54
3e68 3e68 s 	db 	pW_STORE
3e69 3e69 d 14e6
3e69 3e69 s 	dw 	0xE614
3e6b 3e6b d fdea
3e6b 3e6b s 	dw 	_CPM2__old_getinfo+1
3e6d 3e6d s 	endm
3e6d 3e6d s 	dbpatch	0xE654		,0x21	,0x21
3e6d 3e6d d 52
3e6d 3e6d s 	db 	pB_CHK_PATCH
3e6e 3e6e d 54e6
3e6e 3e6e s 	dw 	0xE654
3e70 3e70 d 2121
3e70 3e70 s 	db 	0x21,0x21
3e72 3e72 s 	endm
3e72 3e72 s 	dwpatch	0xE654+1 	,0xE684	,0xE684
3e72 3e72 d 51
3e72 3e72 s 	db 	pW_CHK_PATCH
3e73 3e73 d 55e6
3e73 3e73 s 	dw 	0xE654+1
3e75 3e75 d 84e684e6
3e75 3e75 s 	dw 	0xE684,0xE684
3e79 3e79 s 	endm
3e79 3e79 s 	dwstore	_CPM2__old_getinfo_chkdo+1	,0xE654
3e79 3e79 d 54
3e79 3e79 s 	db 	pW_STORE
3e7a 3e7a d 54e6
3e7a 3e7a s 	dw 	0xE654
3e7c 3e7c d faea
3e7c 3e7c s 	dw 	_CPM2__old_getinfo_chkdo+1
3e7e 3e7e s 	endm
3e7e 3e7e s 	dwstore	_CPM2_r_p_DSK1+1	,0xE18F 	;read
3e7e 3e7e d 54
3e7e 3e7e s 	db 	pW_STORE
3e7f 3e7f d 8fe1
3e7f 3e7f s 	dw 	0xE18F
3e81 3e81 d 76ea
3e81 3e81 s 	dw 	_CPM2_r_p_DSK1+1
3e83 3e83 s 	endm
3e83 3e83 s 	dwstore	_CPM2_r_p_TRK1+1	,0xE193 	
3e83 3e83 d 54
3e83 3e83 s 	db 	pW_STORE
3e84 3e84 d 93e1
3e84 3e84 s 	dw 	0xE193
3e86 3e86 d 91ea
3e86 3e86 s 	dw 	_CPM2_r_p_TRK1+1
3e88 3e88 s 	endm
3e88 3e88 s 	dwstore	_CPM2_r_p_SEC1+1	,0xE194 	
3e88 3e88 d 54
3e88 3e88 s 	db 	pW_STORE
3e89 3e89 d 94e1
3e89 3e89 s 	dw 	0xE194
3e8b 3e8b d 97ea
3e8b 3e8b s 	dw 	_CPM2_r_p_SEC1+1
3e8d 3e8d s 	endm
3e8d 3e8d s 	dwstore	_CPM2_r_p_DMA1+1	,0xE195 	
3e8d 3e8d d 54
3e8d 3e8d s 	db 	pW_STORE
3e8e 3e8e d 95e1
3e8e 3e8e s 	dw 	0xE195
3e90 3e90 d a8ea
3e90 3e90 s 	dw 	_CPM2_r_p_DMA1+1
3e92 3e92 s 	endm
3e92 3e92 s 	dwstore	_CPM2_r_p_DSK2+1	,0xE18F 	;write
3e92 3e92 d 54
3e92 3e92 s 	db 	pW_STORE
3e93 3e93 d 8fe1
3e93 3e93 s 	dw 	0xE18F
3e95 3e95 d b3ea
3e95 3e95 s 	dw 	_CPM2_r_p_DSK2+1
3e97 3e97 s 	endm
3e97 3e97 s 	dwstore	_CPM2_r_p_TRK2+1	,0xE193 	
3e97 3e97 d 54
3e97 3e97 s 	db 	pW_STORE
3e98 3e98 d 93e1
3e98 3e98 s 	dw 	0xE193
3e9a 3e9a d ceea
3e9a 3e9a s 	dw 	_CPM2_r_p_TRK2+1
3e9c 3e9c s 	endm
3e9c 3e9c s 	dwstore	_CPM2_r_p_SEC2+1	,0xE194 	
3e9c 3e9c d 54
3e9c 3e9c s 	db 	pW_STORE
3e9d 3e9d d 94e1
3e9d 3e9d s 	dw 	0xE194
3e9f 3e9f d d4ea
3e9f 3e9f s 	dw 	_CPM2_r_p_SEC2+1
3ea1 3ea1 s 	endm
3ea1 3ea1 s 	dwstore	_CPM2_r_p_DMA2+1	,0xE195 	
3ea1 3ea1 d 54
3ea1 3ea1 s 	db 	pW_STORE
3ea2 3ea2 d 95e1
3ea2 3ea2 s 	dw 	0xE195
3ea4 3ea4 d e5ea
3ea4 3ea4 s 	dw 	_CPM2_r_p_DMA2+1
3ea6 3ea6 s 	endm
3ea6 3ea6 s 	dwstore	_CPM2_r_p_DSK3+1	,0xE18F 	;readinfo
3ea6 3ea6 d 54
3ea6 3ea6 s 	db 	pW_STORE
3ea7 3ea7 d 8fe1
3ea7 3ea7 s 	dw 	0xE18F
3ea9 3ea9 d 82eb
3ea9 3ea9 s 	dw 	_CPM2_r_p_DSK3+1
3eab 3eab s 	endm
3eab 3eab s 
3eab 3eab s 	stop 'CPM_1x_88_EPSON_V104'
3eab 3eab d 50
3eab 3eab s 	db 	p_STOP
3eac 3eac d 43504d5f31785f38385f4550534f4e5f56313034
3eac 3eac s 	db 	'CPM_1x_88_EPSON_V104'
3ec0 3ec0 d 00
3ec0 3ec0 s 	db 	0
3ec1 3ec1 s 	endm
3ec1 3ec1 f out/include-patcher.asm
3ec1 3ec1 s 	include "generator/V0/out/patcher-unsopported-CPM_NET_SFERA2.asm"	;  1 images in collection
3ec1 3ec1 f generator/V0/out/patcher-unsopported-CPM_NET_SFERA2.asm
3ec1 3ec1 s _BIOS_CPM_NET_SFERA2:
3ec1 3ec1 s 	setUNSUPPORTED
3ec1 3ec1 d 55
3ec1 3ec1 s 	db 	pNotSupported
3ec2 3ec2 s 	endm
3ec2 3ec2 s 	;custom checkers
3ec2 3ec2 s 	dwpatch	0xC380  	,0xC380  ,0xC380 
3ec2 3ec2 d 51
3ec2 3ec2 s 	db 	pW_CHK_PATCH
3ec3 3ec3 d 80c3
3ec3 3ec3 s 	dw 	0xC380
3ec5 3ec5 d 80c380c3
3ec5 3ec5 s 	dw 	0xC380,0xC380
3ec9 3ec9 s 	endm
3ec9 3ec9 s 	dwpatch	0xC382  	,0xDa00 ,0xDa00
3ec9 3ec9 d 51
3ec9 3ec9 s 	db 	pW_CHK_PATCH
3eca 3eca d 82c3
3eca 3eca s 	dw 	0xC382
3ecc 3ecc d 00da00da
3ecc 3ecc s 	dw 	0xDa00,0xDa00
3ed0 3ed0 s 	endm
3ed0 3ed0 s 	dwpatch	0xC384  	,0x000A ,0x000A
3ed0 3ed0 d 51
3ed0 3ed0 s 	db 	pW_CHK_PATCH
3ed1 3ed1 d 84c3
3ed1 3ed1 s 	dw 	0xC384
3ed3 3ed3 d 0a000a00
3ed3 3ed3 s 	dw 	0x000A,0x000A
3ed7 3ed7 s 	endm
3ed7 3ed7 s 	dwpatch	0xDB5C+1	,0xDAC3 ,0xDAC3
3ed7 3ed7 d 51
3ed7 3ed7 s 	db 	pW_CHK_PATCH
3ed8 3ed8 d 5ddb
3ed8 3ed8 s 	dw 	0xDB5C+1
3eda 3eda d c3dac3da
3eda 3eda s 	dw 	0xDAC3,0xDAC3
3ede 3ede s 	endm
3ede 3ede s 	dwpatch	0xDA03+1	,0xDB6E ,0xDB6E
3ede 3ede d 51
3ede 3ede s 	db 	pW_CHK_PATCH
3edf 3edf d 04da
3edf 3edf s 	dw 	0xDA03+1
3ee1 3ee1 d 6edb6edb
3ee1 3ee1 s 	dw 	0xDB6E,0xDB6E
3ee5 3ee5 s 	endm
3ee5 3ee5 s 	dwpatch	0xDA27+1	,0xDED0 ,0xDED0
3ee5 3ee5 d 51
3ee5 3ee5 s 	db 	pW_CHK_PATCH
3ee6 3ee6 d 28da
3ee6 3ee6 s 	dw 	0xDA27+1
3ee8 3ee8 d d0ded0de
3ee8 3ee8 s 	dw 	0xDED0,0xDED0
3eec 3eec s 	endm
3eec 3eec s 	dwpatch	0xDA2A+1	,0xE18F ,0xE18F
3eec 3eec d 51
3eec 3eec s 	db 	pW_CHK_PATCH
3eed 3eed d 2bda
3eed 3eed s 	dw 	0xDA2A+1
3eef 3eef d 8fe18fe1
3eef 3eef s 	dw 	0xE18F,0xE18F
3ef3 3ef3 s 	endm
3ef3 3ef3 s 	dwpatch	0xDA3C+1	,0xDD02 ,0xDD02
3ef3 3ef3 d 51
3ef3 3ef3 s 	db 	pW_CHK_PATCH
3ef4 3ef4 d 3dda
3ef4 3ef4 s 	dw 	0xDA3C+1
3ef6 3ef6 d 02dd02dd
3ef6 3ef6 s 	dw 	0xDD02,0xDD02
3efa 3efa s 	endm
3efa 3efa s 	stop 'CPM_NET_SFERA2'
3efa 3efa d 50
3efa 3efa s 	db 	p_STOP
3efb 3efb d 43504d5f4e45545f534645524132
3efb 3efb s 	db 	'CPM_NET_SFERA2'
3f09 3f09 d 00
3f09 3f09 s 	db 	0
3f0a 3f0a s 	endm
3f0a 3f0a f out/include-patcher.asm
3f0a 3f0a d ff
3f0a 3f0a s 	db 0xff
3f0b 3f0b f generator/V0/extrom-patcher.asm
3f0b 3f0b s 
3f0b 3f0b f stage2.asm
3f0b 3f0b s 	
3f0b 3f0b s 
3f0b 3f0b s 
3f0b 3f0b s ; Округляем размер всей секции до ближайших 256 байт вверх	
3f0b 3f0b s         DS      ((($>>8)+1)<<8)-$,0
3f0b 3f0b d 00000000000000000000000000000000
3f1b 3f1b d 00000000000000000000000000000000
3f2b 3f2b d 00000000000000000000000000000000
3f3b 3f3b d 00000000000000000000000000000000
3f4b 3f4b d 00000000000000000000000000000000
3f5b 3f5b d 00000000000000000000000000000000
3f6b 3f6b d 00000000000000000000000000000000
3f7b 3f7b d 00000000000000000000000000000000
3f8b 3f8b d 00000000000000000000000000000000
3f9b 3f9b d 00000000000000000000000000000000
3fab 3fab d 00000000000000000000000000000000
3fbb 3fbb d 00000000000000000000000000000000
3fcb 3fcb d 00000000000000000000000000000000
3fdb 3fdb d 00000000000000000000000000000000
3feb 3feb d 00000000000000000000000000000000
3ffb 3ffb d 0000000000
4000 4000 s FTOP	EQU	$			; верхний адрес памяти, занимаемый загружаемым блоком
4000 4000 s ;--------------------------------------------------------------------------
4000 4000 s ; Конец загружаемой области
4000 4000 s ; Далее идет область рабочих данных, не входящая в тело файла загрузчика
4000 4000 s ;--------------------------------------------------------------------------
4000 4000 s 
4000 4000 s ; Буфер сектора
4000 4000 s SECBUF	EQU	$
4080 4080 s 	ORG	$+128	; буфер 128 байт, DS использовать нельзя, чтобы не порождать объектный код
4080 4080 s 
4080 4080 s loader	END 	
20d4 a il
2232 a wg
2242 a wp
2259 a h1d
2977 a .rw
22e3 a cmd
22e6 a sec
2290 a scl
22af a gsl
22e4 a drv
22e5 a trk
28a9 a tmp
224e a hex1
225d a hex2
226c a hex4
2105 a ssl1
210d a ssl2
ffff v _dma
ffff v _sec
2000 v base
ffff v _dsk
22ee a hmsg
ffff v _trk
fc00 v tram
2351 a hmls
2337 a hmps
4000 v ftop
234a a hmsp
2342 a hmss
2277 a hexw
22ed a lspt
22c2 a pstr
2078 a .chkm
2466 a putx8
22d7 a getch
235c a hcrlf
fe3a v ncreg
22e7 a loadr
ffff v _oper
0049 v conin
ffbf v vireg
22cc a putch
fb08 v porta
fb0a v portc
232f a hmrun
2008 a start
22ec a ssize
fb0b v rpcwr
2827 a .phalt
2044 a .print
fb0e a md_dma
2329 a hmbase
4080 a loader
4000 v secbuf
22a7 a getsec
2a2c a get_lp
fa71 a md_pwg
004c v pchdrv
2361 a msgcpm
fa81 a md_pwp
2500 a .zgu192k
22e9 a runadr
29f3 a copy_z
0050 v p_stop
fb08 v rporta
2360 a tmpkey
fb0a v rportc
22eb a scount
faf2 a md_drv2
2525 a .romcrc
2a09 a .skiplp
221f a .inilut
fa3e a md_read
2450 a msg_fdc
2a6b a msg_fdd
28cb a _p_ldir
2287 a sendcmd
fad4 a md_pscl
ee00 v _rrbuff
fa96 a md_pgsl
2136 a ld_loop
2461 a putstr8
2625 a msgcrlf
fab2 a md_ppsl
222e a getbyte
24ac a hw_test
204d a waitkey
fa7f v sysreg14
221a a initlut
2a1d a .endfill
223d a putbyte
246a a putstr_
2458 a putstr16
28a3 a cp_de_bc
ff7f v sysreg3c
ff7f v sysreg5c
2729 a do_patch
277a a l_pw_chk
29e0 a append_z
fa53 a md_write
fe0b v md_rpcwr
25e1 a msgfound
005a v psubbios
2670 a try_bios
0054 v pw_store
fa1c a md_param2
fb01 a md_rdbuf2
236f a msgsubst
266d a work_ptr
e9a9 a _cpm1_pwg
eb03 a _cpm2_pwg
e9b9 a _cpm1_pwp
eb13 a _cpm2_pwp
2a15 a .fillloop
27d8 a .psubbios
205e a .printkey
2164 a load_done
2942 a fdd_found
2471 a .putnospc
235f a mute_flag
0000 v md_rrbuff
295e a skip_disk
2a04 a fix_width
fe08 v md_rporta
fe0a v md_rportc
2949 a .cpfddname
2a45 a mount_msg
2082 a set_subst
ea0a a _cpm1_pscl
eb64 a _cpm2_pscl
e9ce a _cpm1_pgsl
eb28 a _cpm2_pgsl
20fb a skip_msg_1
2129 a skip_msg_2
e9e9 a _cpm1_ppsl
eb43 a _cpm2_ppsl
254a a .rom_found
266f a patch_flag
2227 a .inilutgrp
fb0a a md_exr_cmd
2722 a patch_done
fb0d a md_exr_sec
2a9f a msgdrive_f
2585 a bios_found
2734 a patch_loop
e8d0 a _cpm1_dpb_f
ea2a a _cpm2_dpb_f
fb0b a md_exr_drv
25bd a msgpatcher
fb0c a md_exr_trk
e8b8 a _cpm1_dph_f
2a4a a out_buffer
ea12 a _cpm2_dph_f
e8df a _cpm1_alw_f
2a9c a mount_crlf
ea39 a _cpm2_alw_f
279f a l_pw_store
26e6 a .cpmremapcd
2594 a .found_cont
29e6 a .skipappend
275c a b_chk_maybe
2739 a b_chk_patch
2a74 a msg_fdd_err
2567 a chk_bios_lp
2a72 a msg_fdd_drv
20a5 a .noprintkey
2502 a .setgzusize
2e0c a resident_md
269a a .cpmsubbios1
26ac a .cpmsubbios2
25bb a msg_warning
2030 a force_subst
2366 a msgmicrodos
23e7 a hw_gzu_size
2132 a ld_loop_sec0
25ec a msgnotfound
2628 a msgreq_opts
281f a unsupported
2425 a msg_tab16_fdc
26bb a .subbiosldir
0052 v pb_chk_patch
251f a hw_check_rom
0051 v pw_chk_patch
25ba a flag_subbios
23e6 a hw_rom_model
ea3f a _cpm1_exr_cmd
eb99 a _cpm2_exr_cmd
237d a msgask_subst
2447 a msg_gzu_size
ea42 a _cpm1_exr_sec
eb9c a _cpm2_exr_sec
2192 a .badbootparam
2a47 a mount_msg_rw
ea40 a _cpm1_exr_drv
eb9a a _cpm2_exr_drv
2ade v resident_cpm1
2c75 v resident_cpm2
ea41 a _cpm1_exr_trk
eb9b a _cpm2_exr_trk
28c8 a fetch_db_to_b
e94d a _cpm1_r_p_dma1
e98a a _cpm1_r_p_dma2
eaa7 a _cpm2_r_p_dma1
eae4 a _cpm2_r_p_dma2
e93c a _cpm1_r_p_sec1
e979 a _cpm1_r_p_sec2
ea96 a _cpm2_r_p_sec1
ead3 a _cpm2_r_p_sec2
0001 v _hw_rom_opts1
0002 v _hw_rom_opts2
e91b a _cpm1_r_p_dsk1
e958 a _cpm1_r_p_dsk2
ea27 a _cpm1_r_p_dsk3
ea75 a _cpm2_r_p_dsk1
eab2 a _cpm2_r_p_dsk2
eb81 a _cpm2_r_p_dsk3
e936 a _cpm1_r_p_trk1
e973 a _cpm1_r_p_trk2
ea90 a _cpm2_r_p_trk1
eacd a _cpm2_r_p_trk2
fa00 a md_res_drivea
fa01 a md_res_driveb
25b9 a flag_microdos
fa8d a md_exr_getsec
2282 a fetchdefromhl
fa0e a md_res_seldsk
2441 a msg_rom_model
faa9 a md_exr_putsec
2f1c a bios_variants
e91b a _cpm1_res_read
2148 a skip_msg_star
ea75 a _cpm2_res_read
2a45 a mount_msg_drv
23e9 a hw_fdd_drive_a
23ea a hw_fdd_drive_b
23eb a hw_fdd_drive_c
23ec a hw_fdd_drive_d
0055 v pnotsupported
26be a .cpmnoresident
28c6 a fetch_dw_to_bc
28bd a read_de_at_tmp
0059 v pb_maybe_patch
29bd a build_emu_name
fac5 a md_exr_sendcmd
e955 a _cpm1__old_read
eaaf a _cpm2__old_read
23e8 a hw_fdc_present
fa6d a md_exr_getbyte
27bc a .pnotsupported
2953 a show_disk_info
257c a bios_not_found
2a1f a get_mount_info
fa7c a md_exr_putbyte
21da a showbootparams
e958 a _cpm1_res_write
291b a .physical_drive
eab2 a _cpm2_res_write
fa11 a md_old_seld_dsk
295f a build_disk_name
fa18 a md_fetch_params
faec a md_exr_readinfo
0057 v prequired_opts1
0058 v prequired_opts2
0110 v resident_md_len
219e a msgbadbootparam
24b9 a hw_check_floppy
216b a checkbootparams
28b4 a store_bc_at_tmp
2086 a restart_disable
0001 v _hw_gzu_size_48k
28ab a store_bc_to_tmp
2988 a get_drvinfo_ptr
27e5 a .prequired_opts1
27fe a .prequired_opts2
e992 a _cpm1__old_write
e9c5 a _cpm1_exr_getsec
eb1f a _cpm2_exr_getsec
eaec a _cpm2__old_write
28d6 a show_mount_info
e911 a _cpm1_res_seldsk
ea6b a _cpm2_res_seldsk
2a7e a drive_rw_status
e9e0 a _cpm1_exr_putsec
eb3a a _cpm2_exr_putsec
0002 v _hw_gzu_size_192k
fa00 v resident_md_addr
fa02 a md_res_drive_tab
2553 a cpm_bios_patcher
e9fb a _cpm1_exr_sendcmd
eb55 a _cpm2_exr_sendcmd
25b8 a flag_unsupported
e995 a _cpm1_res_getinfo
eaef a _cpm2_res_getinfo
2814 a set_opts_warning
0197 v resident_cpm1_len
0197 v resident_cpm2_len
28fc a show_mount_drive
e9a5 a _cpm1_exr_getbyte
eaff a _cpm2_exr_getbyte
240d a msg_tab8_gzu_size
e9b4 a _cpm1_exr_putbyte
eb0e a _cpm2_exr_putbyte
24cc a hw_check_gzu_size
0056 v psetflag_microdos
e914 a _cpm1_old_seld_dsk
ea6e a _cpm2_old_seld_dsk
e9a2 a _cpm1__old_getinfo
eafc a _cpm2__old_getinfo
2a38 a msg_default_mount
2640 a msgreq_opts_digit
ea21 a _cpm1_exr_readinfo
23e5 a hw_rom_opts_class
eb7b a _cpm2_exr_readinfo
e8ac v resident_cpm1_addr
ea06 v resident_cpm2_addr
23ed a msg_tab8_rom_model
29a7 a msgzerodrvinfotab
29a0 a errzerodrvinfotab
e929 a _cpm1_.r_no_drv_dec
ea83 a _cpm2_.r_no_drv_dec
27cb a .psetflag_microdos
e966 a _cpm1_.w_no_drv_dec
eac0 a _cpm2_.w_no_drv_dec
202a a force_default_bios
fa68 a md_read_infosector
0080 v api_get_mount_name
2f5c a _bios_cpm_21_extrom
2478 a show_hardware_info
e8ac a _cpm1_res_drive_tab
ea06 a _cpm2_res_drive_tab
3664 a _bios_cpm_21_91___lap
0000 v debug_trace_patcher
0001 v _hw_rom_model_opts11
0002 v _hw_rom_model_opts20
2a36 a drivetab_mount_info
3d19 a _bios_cpm_net_sfera1
3ec1 a _bios_cpm_net_sfera2
2a7e a mount_info_from_emu
373e a _bios_cpm_20_88___miks
3167 a _bios_cpm_21_89___wiza
0003 v _hw_rom_model_kvant8
282f a msg_invalidpatchcode
23a3 a msgforceddefaultbios
2854 a msgundefindedsubbios
0082 v api_get_mount_status
02fa v max_resident_cpm1_len
03f7 v max_resident_cpm2_len
308a a _bios_cpm_12_88_3_niijaf
33a7 a _bios_cpm_21_89_2_niijaf
2a29 a receive_c_bytes_to_hl
3819 a _bios_cpm_12_90_5_kontur
397a a _bios_cpm_12_87_11_niijaf
32c9 a _bios_cpm_21_89_2_niijaf2
3b36 a _bios_cpm_12_87_09_niijaf
e92d a _cpm1_r_p_seldskdriver
ea87 a _cpm2_r_p_seldskdriver
e96a a _cpm1_r_p_seldskdrivew
eac4 a _cpm2_r_p_seldskdrivew
34ff a _bios_cpm_1x_89_03_30_ravi
26fb a move_microdos_resident
2727 a hl_after_do_patch_patch
3de1 a _bios_cpm_1x_88_epson_v104
e99f a _cpm1__old_getinfo_chkdo
eaf9 a _cpm2__old_getinfo_chkdo
2877 a msg_strangehlafterpatch
3a58 a _bios_cpm_21m_____shkanov
38f6 a _bios_microdos_opts2_900105
35df a _bios_microdos_opts1_861011
3c14 a _bios_microdos_opts1_871220
3484 a _bios_microdos_opts1_870430
3c94 a _bios_microdos_opts1_861115
3249 a _bios_microdos_opts2_880630
2f9c a _bios_cpm_12_88_3_alternativa
0163 v available_resident_cpm1_len
0260 v available_resident_cpm2_len
3d90 a _bios_cpm_net_kornet_drive_a
3d62 a _bios_cpm_net_kornet_drive_b
